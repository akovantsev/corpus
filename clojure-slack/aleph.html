<!DOCTYPE html>
<head><title>aleph</title><meta charset="UTF-8" /><style type="text/css">body {
    font-family: Monaco, Menlo, Consolas, "Courier New", sans-serif;
    font-size: 12px;
    margin: 15px;
}
h2 {text-align: center}
pre,
code {
    font-family: Monaco, Menlo, Consolas, "Courier New", monospace;
    color: #333;
    line-break: anywhere;
}
a {
    line-break: anywhere;
}
code {
    /*line-height: 1.2;*/
    white-space: normal;
    color: #c25;
    background-color: #f7f7f9;
    border: 1px solid #e1e1e8;
}
pre {
    margin: .5rem 0 .2rem;
    font-size: .75rem;
    /*line-height: 1.15rem;*/
    background: #fbfaf8;
    padding: .5rem;
    word-break: normal;
    display: block;
    border: 1px solid rgba(0, 0, 0, .15);
    white-space: pre-wrap;
    word-wrap: break-word;
    border-radius: 4px;
}
/*span {*/
z {
    white-space: pre-wrap;
}

d {padding-right: 8px;}
h {padding-right: 16px;}

w, r {
    margin-right: 10px;
    padding-right: 8px;
    text-align: right;
}

d,h,w,r {
    background-color: lavender;
    margin-top: 1px;
    display: inline-table; /* prevents doubleclick selection spillover into neighbour elements */
}

h:hover,
d:hover {
    text-decoration: underline;
    color: blue;
    cursor: row-resize;
}
d {padding-right: 8px;}
h {padding-right: 16px;}

z {display: block;}

z:target > r,
z:target > w,
z:target > d,
z:target > h {
    background-color: aquamarine
}

#filters-container {
    position: fixed;
    left: 50px;
    z-index: 1;
}
#filters-container > input {
    /*column:*/
    display: block;
    outline-color: aquamarine;
}

y {
    cursor: pointer;
    text-decoration: none;
    color: blue;
    position: absolute;
    left: 3px;
}

y:hover {
    text-decoration: underline;
    color: aquamarine;
}


</style></head><body><style id="css-username">w {min-width: 208px;} r {min-width: 240px;}</style><style id="css-text-filter"></style><style id="css-date-filter"></style><style id="css-filter-override"></style><p id="filters-container"><input id="text-filter" onkeyup="debtextfilter(this.value)" placeholder="filter text" type="string" /><button hidden="hidden" id="date-filter" onclick="cleardatefilter()"></button></p><h2>#aleph</h2><pre><i>generated UTC: 2024-06-18 10:55</i><i>
latest data: <a href="https://clojurians-log.clojureverse.org/aleph/2024-06-05">https://clojurians-log.clojureverse.org/aleph/2024-06-05</a></i><i>
messages: 3444</i>
pro tips:
* Double click on text to filter by it. (doubleclick + cmd-f for extra points).
* Click on date to keep day visible regardless of filter.
* Click on time to keep hour visible regardless of filter.</pre><script>const textFilterInput = document.getElementById("text-filter");
const dateFilterInput = document.getElementById("date-filter");
const filterTextStyle = document.getElementById("css-text-filter");
const filterDateStyle = document.getElementById("css-date-filter");
const filterStyleOverride = document.getElementById("css-filter-override");



function textFilter2(text) {
    var style = '';
    if (text.trim() !== '') {
        text.split(' ').forEach(function (t) {
            if (t !== '') {
                style = style + "z:not([t*='" + t + "' i]) {display: none; opacity: 0.6}";
            }
        });
    }
    filterTextStyle.innerHTML = style;
}
function textFilter(text) {
    filterTextStyle.innerHTML = "";
    if (text.trim() !== '') {
        var sections = document.getElementsByTagName("g");
        var sectionsArr = Array.prototype.slice.call(sections);
        sectionsArr.forEach(function (s){
            var sid = s.getAttribute("id");
            text.split(' ').forEach(function (t) {
                if (t !== '') {
                    filterTextStyle.innerHTML += "\ng#" + sid + " > z:not([t*='" + t + "' i]) {display: none; opacity: 0.6}";
                }
            });
        })
    }
}
function textFilter3(text) {
    console.time("text search");
    filterTextStyle.innerHTML = "";
    if (text.trim() !== '') {
        const re = new RegExp( text, "i");
        var sections = document.getElementsByTagName("g");
        var sectionsArr = Array.prototype.slice.call(sections);
        sectionsArr.forEach(function (w){
            var zs = w.getElementsByTagName ("z");
            var zsArr = Array.prototype.slice.call(zs);
            var ids = zsArr
                .filter(function (el) {
                    return !re.test(el.innerText);
                })
                .map(function (el){
                    return el.getAttribute("id");
                });
            if (ids) {
                filterTextStyle.innerHTML += "\n#" + ids.join(",#") + " {display: none; opacity: 0.6}";
            }
        })
    }
    console.timeEnd("text search");
}


function filterSelection (e) {
    let sel = document.getSelection();
    let txt = sel.toString();
    textFilterInput.value = (txt || "");
    textFilter(txt);
}
function debounce1(callback, delay) {
    let timeout;
    return function(arg) {
        clearTimeout(timeout);
        timeout = setTimeout(callback, delay, arg);
    }
}

function keyUp (e) {
    if (e.code === "KeyF" && e.ctrlKey) {
        let txt = document.getSelection().toString();
        if (txt.length > 0) {
            textFilterInput.value = (txt || "");
            textFilter(txt);
        }
    }
}


function showDateTimes (el, datestr, hourstr) {
    dateFilterInput.innerText = "clear: " + datestr + " " + hourstr;
    dateFilterInput.hidden = false;
    let ids = [];
    const clicked = el.parentElement;  // el = z#id/t
    ids.push(clicked.id);
    // var idbefore, idafter;
    let cursor = clicked;
    function nextCursor (cursor) {
        const id = (cursor && cursor.id);
        const d = (cursor && cursor.children[1]);
        const h = (cursor && cursor.children[2])
        if (id) {
            ids.push(id); //includes 1st next-id not matching date.
        } else {
            cursor = null;
        }
        if (d && (d.textContent === datestr) && (!hourstr || (h && h.textContent.startsWith(hourstr)))) {
        } else {
            cursor = null;
        }
        return cursor;
    }
    while (cursor) {
        cursor = nextCursor(cursor.previousElementSibling);
    }

    cursor = clicked;

    while (cursor) {
        cursor = nextCursor(cursor.nextElementSibling);
    }


    var style1 = '';
    var style2 = '';
    var content;
    if (datestr.includes(" ")) { //hour
        content = " *";
    } else {
        content = "**";
    }
    ids.forEach(function (id) {
        if (id) {
            style1 = style1 + ", #" + id;
            style2 = style2 + ", #" + id + " h:after";
        }
    })
    if (style1) {
        style1 = style1.substring(1) + " {display: block !important}";
    }
    if (style2) {
        style2 = style2.substring(1) + " {content: \"" + content + "\"; position: absolute}"
    }
    filterDateStyle.innerHTML = style1 + "\n" + style2;
}

// https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView
function filterDay (el) {
    showDateTimes(el, el.textContent);
    el.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
}

function filterHours (el) {
    showDateTimes(el, el.previousElementSibling.textContent, el.textContent.substring(0, 2));
    el.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
}

function forceShowSelected (el) {
    var id = el.parentElement.id
    if (id) {
        window.location.hash = "#" + id;
        filterStyleOverride.innerHTML = ""
            + "#" + id
            + " {display: block !important;}"
            + "#" + id + " h:after"
            + " {content: \"  #\"; position: absolute}";

    } else {
        window.location.hash = "";
        filterStyleOverride.innerHTML = "";
    }
}


function cleardatefilter () {
    dateFilterInput.hidden = true;
    dateFilterInput.innerText = "";
    filterDateStyle.innerHTML = "";
}

const debtextfilter = debounce1(textFilter, 200);

function doubleClick (e) {
    if (e.target.tagName !== "INPUT"
        && e.target.tagName !== "D"
        && e.target.tagName !== "H") {

        filterSelection();
        e.target.scrollIntoView({behavior: "auto", block: "center", inline: "start"});
    }
}

function onclick(e) {
    if (e.target.tagName === "Y") {
        e.preventDefault();
        forceShowSelected(e.target);
    } else if (e.target.tagName === "D") {
        e.preventDefault();
        filterDay(e.target);
    } else if (e.target.tagName === "H") {
        e.preventDefault();
        filterHours(e.target);
    }
}

document.onclick = onclick;
document.ondblclick = doubleClick;
document.onkeyup = keyUp;
textFilterInput.focus();
</script><div><g id="s0"><z id="t1453177261" t="jethroksy hi, I&apos;m using aleph as a websocket client, and i&apos;m trying to periodically take from the channel"><y>#</y><d>2016-01-19</d><h>04:21</h><w>jethroksy</w>hi, I&apos;m using aleph as a websocket client, and i&apos;m trying to periodically take from the channel</z><z id="t1453177267" t="jethroksy what&apos;s the best way to do so?"><y>#</y><d>2016-01-19</d><h>04:21</h><w>jethroksy</w>what&apos;s the best way to do so?</z><z id="t1456325549" t="artemyarulin hi there, does anyone know how to get full url from http request representation? like {:url ‚Äú‚Äù :query-params {:a 2}} -&gt; ‚Äú‚Äù . I need to sign the request and need exactly the request that aleph then‚Äôll send"><y>#</y><d>2016-02-24</d><h>14:52</h><w>artemyarulin</w>hi there, does anyone know how to get full url from http request representation?
like <code>{:url ‚Äú‚Äù :query-params {:a 2}} -&gt; ‚Äú‚Äù</code>. I need to sign the request and need exactly the request that aleph then‚Äôll send</z><z id="t1456325797" t="artemyarulin I‚Äôve found (.getUri (aleph.http.core/ring-request-&gt;netty-request req)) , but it works with ring like requests and I didn‚Äôt find any function that can convert my http request to ring one"><y>#</y><d>2016-02-24</d><h>14:56</h><w>artemyarulin</w>I‚Äôve found <code>(.getUri (aleph.http.core/ring-request-&gt;netty-request req))</code>, but it works with ring like requests and I didn‚Äôt find any function that can convert my http request to ring one</z><z id="t1456327197" t="artemyarulin ended up with simple {:url (str ‚Äú&amp;‚Äù (aleph.http.client-middleware/generate-query-string {:a 2}))}"><y>#</y><d>2016-02-24</d><h>15:19</h><w>artemyarulin</w>ended up with simple <code>{:url (str ‚Äú&amp;‚Äù (aleph.http.client-middleware/generate-query-string {:a 2}))}</code></z><z id="t1458293140" t="moizsj [:attrs {:href &quot;/_/_/users/U066UJ2KE&quot;}] : Hey Zach. I am trying to port one of our services to Aleph. Its a web socket server that currently runs on http-kit. One of the things I require is the ability to add some custom http headers in the response during the websocket Upgrade process. Do you see a way I could do that?"><y>#</y><d>2016-03-18</d><h>09:25</h><w>moizsj</w><a>@ztellman</a>: Hey Zach. I am trying to port one of our services to Aleph. Its a web socket server that currently runs on http-kit. One of the things I require is the ability to add some custom http headers in the response during the websocket Upgrade process.  Do you see a way I could do that?</z><z id="t1458294243" t="moizsj To elaborate, I need to inspect the Sec-WebSocket-Extensions header value from the client req, and based on that add a response header during the upgrade process."><y>#</y><d>2016-03-18</d><h>09:44</h><w>moizsj</w>To elaborate, I need to inspect the <code>Sec-WebSocket-Extensions</code> header value from the client req, and based on that add a response header during the upgrade process.</z><z id="t1458294518" t="moizsj And similarly need to check the Sec-WebSocket-Protocol header in the request, and add the same back to the response if the protocol is what I expect"><y>#</y><d>2016-03-18</d><h>09:48</h><w>moizsj</w>And similarly need to check the <code>Sec-WebSocket-Protocol</code> header in the request, and add the same back to the response if the protocol is what I expect</z><z id="t1458558316" t="moizsj For the benefit of others in the channel, I found the answer to the questions above. The :headers key in the options while calling the websocket-connection fn does the job."><y>#</y><d>2016-03-21</d><h>11:05</h><w>moizsj</w>For the benefit of others in the channel, I found the answer to the questions above. The <code>:headers</code> key in the options while calling the <code>websocket-connection</code> fn does the job.</z><z id="t1458703293" t="decoursin What&apos;s the best way to get hot reloading with Aleph? When my code changes and I save, I&apos;d like to get automatic server reload. Right now I&apos;m just using lein run."><y>#</y><d>2016-03-23</d><h>03:21</h><w>decoursin</w>What&apos;s the best way to get hot reloading with Aleph? When my code changes and I save, I&apos;d like to get automatic server reload. Right now I&apos;m just using lein run.</z><z id="t1458759484" t="bplatz [:attrs {:href &quot;/_/_/users/U0ASM8LSK&quot;}] : Stuart Sierra&apos;s Component or mount are the two tools I&apos;ve used."><y>#</y><d>2016-03-23</d><h>18:58</h><w>bplatz</w><a>@decoursin</a>: Stuart Sierra&apos;s Component or mount are the two tools I&apos;ve used.</z><z id="t1458767699" t="decoursin [:attrs {:href &quot;/_/_/users/U0AJRJ37W&quot;}] : Ok thank you!"><y>#</y><d>2016-03-23</d><h>21:14</h><w>decoursin</w><a>@bplatz</a>: Ok thank you!</z><z id="t1459059648" t="rmuslimov Hi, I‚Äôm just playing with manifold, and newbie in clojure, may I ask you a question:"><y>#</y><d>2016-03-27</d><h>06:20</h><w>rmuslimov</w>Hi, I‚Äôm just playing with manifold, and newbie in clojure, may I ask you a question:</z><z id="t1459059687" t="rmuslimov =&gt; &quot;Elapsed time: 5018.863609 msecs&quot; Why it takes 5 sec, and not 1 sec?"><y>#</y><d>2016-03-27</d><h>06:21</h><w>rmuslimov</w>=&gt; &quot;Elapsed time: 5018.863609 msecs&quot;
Why it takes 5 sec, and not 1 sec?</z><z id="t1459059771" t="rmuslimov I thought this thread-pool executor guarantees parallel execution in 42 threads, no?"><y>#</y><d>2016-03-27</d><h>06:22</h><w>rmuslimov</w>I thought this thread-pool executor guarantees parallel execution in 42 threads, no?</z><z id="t1461771340" t="martinklepsch why is there no aleph.http/patch ?!"><y>#</y><d>2016-04-27</d><h>15:35</h><w>martinklepsch</w>why is there no <code>aleph.http/patch</code>?!</z><z id="t1462208797" t="keeth interesting behavior of manifold.stream/consume - it ignores buffers, so if your consumer function is slower than the producer the producer will block as if the stream was unbuffered, e.g. (def stream (s/stream 5)) (future (s/consume (fn [x] (println x) (Thread/sleep 1000)) stream)) (future (doseq [n (range 10)] @(s/put! stream n) (println &quot;put&quot; n))) "><y>#</y><d>2016-05-02</d><h>17:06</h><w>keeth</w>interesting behavior of manifold.stream/consume - it ignores buffers, so if your consumer function is slower than the producer the producer will block as if the stream was unbuffered, e.g.
<pre>(def stream (s/stream 5))

(future 
  (s/consume 
    (fn [x] 
      (println x) 
      (Thread/sleep 1000)) 
    stream))

(future
  (doseq [n (range 10)] 
    @(s/put! stream n)
    (println &quot;put&quot; n)))
</pre></z><z id="t1462209090" t="keeth gives 1 put 1 2 put 2 etc "><y>#</y><d>2016-05-02</d><h>17:11</h><w>keeth</w>gives
<pre>1
put 1
2
put 2
etc
</pre></z><z id="t1462209169" t="keeth if you swap the consume call with a loop that takes from the stream, the first 5 put! s succeed immediately, filling the buffer, as you would expect."><y>#</y><d>2016-05-02</d><h>17:12</h><w>keeth</w>if you swap the consume call with a loop that takes from the stream, the first 5 <code>put!</code>s succeed immediately, filling the buffer, as you would expect.</z><z id="t1462225160" t="shaunxcode has anyone managed to get aleph websocket server to aggregate fragmented frames?"><y>#</y><d>2016-05-02</d><h>21:39</h><w>shaunxcode</w>has anyone managed to get aleph websocket server to aggregate fragmented frames?</z><z id="t1462227937" t="shaunxcode so my fix is one line but would probably be something you want to pass in as a config param"><y>#</y><d>2016-05-02</d><h>22:25</h><w>shaunxcode</w>so my fix is one line but would probably be something you want to pass in as a config param</z><z id="t1462227981" t="shaunxcode in the initialize-websocket-handler when you setup the pipeline right before adding the &quot;websocket-handler&quot; we need to add the &quot;websocket-frame-aggregator&quot;"><y>#</y><d>2016-05-02</d><h>22:26</h><w>shaunxcode</w>in the initialize-websocket-handler when you setup the pipeline right before adding the &quot;websocket-handler&quot; we need to add the &quot;websocket-frame-aggregator&quot;</z><z id="t1462227986" t="shaunxcode (.addLast pipeline &quot;websocket-frame-aggregator&quot; (WebSocketFrameAggregator. (* 16 1024 1024)))"><y>#</y><d>2016-05-02</d><h>22:26</h><w>shaunxcode</w>(.addLast pipeline &quot;websocket-frame-aggregator&quot; (WebSocketFrameAggregator. (* 16 1024 1024)))</z><z id="t1462228008" t="shaunxcode (that large number is what would be passed in as a config param I assume)"><y>#</y><d>2016-05-02</d><h>22:26</h><w>shaunxcode</w>(that large number is what would be passed in as a config param I assume)</z><z id="t1462228021" t="shaunxcode anyway this totally worked and I can now paste giant images over aleph sockets"><y>#</y><d>2016-05-02</d><h>22:27</h><w>shaunxcode</w>anyway this totally worked and I can now paste giant images over aleph sockets</z><z id="t1462228051" t="shaunxcode [:attrs {:href &quot;/_/_/users/U066UJ2KE&quot;}] : forgot to tag you in the above"><y>#</y><d>2016-05-02</d><h>22:27</h><w>shaunxcode</w><a>@ztellman</a>: forgot to tag you in the above</z><z id="t1462860150" t="jdevuyst hi. what&apos;s the normal way to do form encoding with Aleph? I&apos;ve been using generate-query-string for the body, but this involves manually encoding arrays as field[0], field[1], etcetera. There has to be a better way. simple_smile"><y>#</y><d>2016-05-10</d><h>06:02</h><w>jdevuyst</w>hi. what&apos;s the normal way to do form encoding with Aleph? I&apos;ve been using generate-query-string for the body, but this involves manually encoding arrays as field[0], field[1], etcetera. There has to be a better way. <b>simple_smile</b></z><z id="t1463070995" t="keeth [:attrs {:href &quot;/_/_/users/U051U6NRT&quot;}] : have you tried passing your form structure via the :form-params key? Take a look at the form-params middleware and see if it does what you want‚Ä¶ https://github.com/ztellman/aleph/blob/master/src/aleph/http/client_middleware.clj#L383"><y>#</y><d>2016-05-12</d><h>16:36</h><w>keeth</w><a>@jdevuyst</a>: have you tried passing your form structure via the :form-params key?  Take a look at the form-params middleware and see if it does what you want‚Ä¶ <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/http/client_middleware.clj#L383" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/http/client_middleware.clj#L383</a></z><z id="t1463107764" t="jdevuyst oh. that looks like it&apos;s exactly what I need. not sure how I missed it. thank you!"><y>#</y><d>2016-05-13</d><h>02:49</h><w>jdevuyst</w>oh. that looks like it&apos;s exactly what I need. not sure how I missed it. thank you!</z><z id="t1465486989" t="sorenmacbeth anybody home?"><y>#</y><d>2016-06-09</d><h>15:43</h><w>sorenmacbeth</w>anybody home?</z><z id="t1465487094" t="sorenmacbeth has anyone run into an IllegalAccessError trying to find the doit macro from potemkin in aleph/netty before?"><y>#</y><d>2016-06-09</d><h>15:44</h><w>sorenmacbeth</w>has anyone run into an IllegalAccessError trying to find the <code>doit</code> macro from potemkin in aleph/netty before?</z><z id="t1465487112" t="sorenmacbeth this is aleph 0.4.2-alpha4, but I get the same thing with 0.4.1"><y>#</y><d>2016-06-09</d><h>15:45</h><w>sorenmacbeth</w>this is aleph 0.4.2-alpha4, but I get the same thing with 0.4.1</z><z id="t1465487149" t="sorenmacbeth it feels like perhaps an older version of potemkin is sneaking onto my classpath from somewhere, but lein deps :tree yields nothing"><y>#</y><d>2016-06-09</d><h>15:45</h><w>sorenmacbeth</w>it feels like perhaps an older version of potemkin is sneaking onto my classpath from somewhere, but <code>lein deps :tree</code> yields nothing</z><z id="t1467383261" t="akiel hi, is there a way to mock client http responses? I like to test code which makes http requests."><y>#</y><d>2016-07-01</d><h>14:27</h><w>akiel</w>hi, is there a way to mock client http responses? I like to test code which makes http requests.</z><z id="t1467656691" t="rmuslimov [:attrs {:href &quot;/_/_/users/U07MC8H4Z&quot;}] : I guess you can use with-redefs for function you want to mock."><y>#</y><d>2016-07-04</d><h>18:24</h><w>rmuslimov</w><a>@akiel</a>:  I guess you can use <code>with-redefs</code> for function you want to mock.</z><z id="t1467656713" t="rmuslimov or there is something that I‚Äôm missing in your question"><y>#</y><d>2016-07-04</d><h>18:25</h><w>rmuslimov</w>or there is something that I‚Äôm missing in your question</z><z id="t1467657184" t="akiel [:attrs {:href &quot;/_/_/users/U0AR40HJ6&quot;}] : I never used with-redefs but I‚Äôll try it. It could work. Thanks."><y>#</y><d>2016-07-04</d><h>18:33</h><w>akiel</w><a>@rmuslimov</a>: I never used <code>with-redefs</code> but I‚Äôll try it. It could work. Thanks.</z><z id="t1468344263" t="lmergen aside from yada , are there any other good web libraries that use aleph by default ?"><y>#</y><d>2016-07-12</d><h>17:24</h><w>lmergen</w>aside from <code>yada</code>, are there any other good web libraries that use aleph by default ?</z><z id="t1468351701" t="andreas-thoelke @Imergen aleph/manifold is used in catacumba https://funcool.github.io/catacumba/latest/#difference-with-aleph"><y>#</y><d>2016-07-12</d><h>19:28</h><w>andreas-thoelke</w>@Imergen aleph/manifold is used in catacumba <a href="https://funcool.github.io/catacumba/latest/#difference-with-aleph" target="_blank">https://funcool.github.io/catacumba/latest/#difference-with-aleph</a></z><z id="t1469024398" t="jetmind Hi all! Is it possible to make aleph http to not set Server: Aleph/0.4.1 header?"><y>#</y><d>2016-07-20</d><h>14:19</h><w>jetmind</w>Hi all! Is it possible to make aleph http to not set Server: Aleph/0.4.1 header?</z><z id="t1469024963" t="lmergen also, what would be the best way to do multipart file uploads from the http client ? hack it into the body yourself ? (i understand this is not yet supported)"><y>#</y><d>2016-07-20</d><h>14:29</h><w>lmergen</w>also, what would be the best way to do multipart file uploads from the http client ? hack it into the body yourself ? (i understand this is not yet supported)</z><z id="t1471426707" t="dm3 kinda related - maybe someone will find this useful: https://github.com/tulos/manifail"><y>#</y><d>2016-08-17</d><h>09:38</h><w>dm3</w>kinda related - maybe someone will find this useful: <a href="https://github.com/tulos/manifail" target="_blank">https://github.com/tulos/manifail</a></z><z id="t1474139899" t="kingoftheknoll I was taking some time today to try clojure.spec in a project that uses Aleph and spec caught something here. https://github.com/ztellman/aleph/blob/master/src/aleph/http/multipart.clj#L30 Now for the life of me I can‚Äôt figure out what‚Äôs wrong with the fn because I‚Äôm not super versed in spec lol. But here‚Äôs the trace when using [org.clojure/clojure ‚Äú1.9.0-alpha12&quot;]"><y>#</y><d>2016-09-17</d><h>19:18</h><w>kingoftheknoll</w>I was taking some time today to try clojure.spec in a project that uses Aleph and spec caught something here. <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/http/multipart.clj#L30" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/http/multipart.clj#L30</a> Now for the life of me I can‚Äôt figure out what‚Äôs wrong with the fn because I‚Äôm not super versed in spec lol. But here‚Äôs the trace when using <code>[org.clojure/clojure ‚Äú1.9.0-alpha12&quot;]</code></z><z id="t1474143626" t="kingoftheknoll This looks like the closest error similar to the issue. It seems that it doesn‚Äôt like the :or value in the destructuring. https://groups.google.com/d/msg/clojure/mIlKaOiujlo/vbn1sofTCgAJ"><y>#</y><d>2016-09-17</d><h>20:20</h><w>kingoftheknoll</w>This looks like the closest error similar to the issue. It seems that it doesn‚Äôt like the <code>:or</code> value in the destructuring. <a href="https://groups.google.com/d/msg/clojure/mIlKaOiujlo/vbn1sofTCgAJ" target="_blank">https://groups.google.com/d/msg/clojure/mIlKaOiujlo/vbn1sofTCgAJ</a></z><z id="t1474146672" t="kingoftheknoll Nevermind! I‚Äôm just on ‚Äú0.4.1‚Äù so I haven‚Äôt received this change. https://github.com/ztellman/aleph/commit/7d6f2f5bf743301c5a4ab0705725bf9b50b91896"><y>#</y><d>2016-09-17</d><h>21:11</h><w>kingoftheknoll</w>Nevermind! I‚Äôm just on ‚Äú0.4.1‚Äù so I haven‚Äôt received this change. <a href="https://github.com/ztellman/aleph/commit/7d6f2f5bf743301c5a4ab0705725bf9b50b91896" target="_blank">https://github.com/ztellman/aleph/commit/7d6f2f5bf743301c5a4ab0705725bf9b50b91896</a></z><z id="t1475600587" t="jeroenvandijk hi, question about manifold. Does anyone know how a stream can have a bigger :buffer-size (actual items) than the :buffer-capacity ?"><y>#</y><d>2016-10-04</d><h>17:03</h><w>jeroenvandijk</w>hi, question about manifold. Does anyone know how a stream can have a bigger <code>:buffer-size</code> (actual items) than the <code>:buffer-capacity</code>?</z><z id="t1475600613" t="jeroenvandijk an example from production: &lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 86055, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? false, :pending-takes 0, :buffer-capacity 1000, :source? true} &gt;&gt;"><y>#</y><d>2016-10-04</d><h>17:03</h><w>jeroenvandijk</w>an example from production: <code>&lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 86055, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? false, :pending-takes 0, :buffer-capacity 1000, :source? true} &gt;&gt;</code></z><z id="t1475603268" t="dm3 what&apos;s the version?"><y>#</y><d>2016-10-04</d><h>17:47</h><w>dm3</w>what&apos;s the version?</z><z id="t1475655188" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] [aleph &quot;0.4.2-alpha8‚Äù] with [manifold &quot;0.1.6-alpha1‚Äù]"><y>#</y><d>2016-10-05</d><h>08:13</h><w>jeroenvandijk</w><a>@dm3</a> <code>[aleph &quot;0.4.2-alpha8‚Äù]</code> with <code>[manifold &quot;0.1.6-alpha1‚Äù]</code></z><z id="t1475655228" t="jeroenvandijk btw, I haven‚Äôt fully deployed it, but I‚Äôm running it on one node"><y>#</y><d>2016-10-05</d><h>08:13</h><w>jeroenvandijk</w>btw, I haven‚Äôt fully deployed it, but I‚Äôm running it on one node</z><z id="t1475655240" t="dm3 I looked at the code and can&apos;t see how this can happen"><y>#</y><d>2016-10-05</d><h>08:14</h><w>dm3</w>I looked at the code and can&apos;t see how this can happen</z><z id="t1475655243" t="jeroenvandijk Also trying to write local tests to proof that this can happen"><y>#</y><d>2016-10-05</d><h>08:14</h><w>jeroenvandijk</w>Also trying to write local tests to proof that this can happen</z><z id="t1475655247" t="dm3 is this a basic (s/stream)"><y>#</y><d>2016-10-05</d><h>08:14</h><w>dm3</w>is this a basic <code>(s/stream)</code></z><z id="t1475655248" t="dm3 ?"><y>#</y><d>2016-10-05</d><h>08:14</h><w>dm3</w>?</z><z id="t1475655252" t="jeroenvandijk but no success so far"><y>#</y><d>2016-10-05</d><h>08:14</h><w>jeroenvandijk</w>but no success so far</z><z id="t1475655266" t="jeroenvandijk no it‚Äôs a subscription on an event bus with a complex transform"><y>#</y><d>2016-10-05</d><h>08:14</h><w>jeroenvandijk</w>no it‚Äôs a subscription on an event bus with a complex transform</z><z id="t1475655274" t="jeroenvandijk but it should be a stream in the end"><y>#</y><d>2016-10-05</d><h>08:14</h><w>jeroenvandijk</w>but it should be a stream in the end</z><z id="t1475655282" t="dm3 yeah, there are different internal impls"><y>#</y><d>2016-10-05</d><h>08:14</h><w>dm3</w>yeah, there are different internal impls</z><z id="t1475655307" t="dm3 how is the stream constructed? Do you specify an xform? How do you provide buffer size?"><y>#</y><d>2016-10-05</d><h>08:15</h><w>dm3</w>how is the stream constructed? Do you specify an xform? How do you provide buffer size?</z><z id="t1475655322" t="jeroenvandijk I did already find that the closing of streams works slightly different that i had expected"><y>#</y><d>2016-10-05</d><h>08:15</h><w>jeroenvandijk</w>I did already find that the closing of streams works slightly different that i had expected</z><z id="t1475655350" t="jeroenvandijk yeah I‚Äôm trying to extract those things now. It‚Äôs all over the place now"><y>#</y><d>2016-10-05</d><h>08:15</h><w>jeroenvandijk</w>yeah I‚Äôm trying to extract those things now. It‚Äôs all over the place now</z><z id="t1475655389" t="jeroenvandijk I‚Äôll try to make an equivalent of what I have in production without all the clutter"><y>#</y><d>2016-10-05</d><h>08:16</h><w>jeroenvandijk</w>I‚Äôll try to make an equivalent of what I have in production without all the clutter</z><z id="t1475655517" t="dm3 I feel for you üôÇ"><y>#</y><d>2016-10-05</d><h>08:18</h><w>dm3</w>I feel for you <b>üôÇ</b></z><z id="t1475655525" t="jeroenvandijk haha thanks"><y>#</y><d>2016-10-05</d><h>08:18</h><w>jeroenvandijk</w>haha thanks</z><z id="t1475656474" t="jeroenvandijk The manifold.stream/transform doesn‚Äôt have a timeout one it"><y>#</y><d>2016-10-05</d><h>08:34</h><w>jeroenvandijk</w>The <code>manifold.stream/transform</code> doesn‚Äôt have a timeout one it</z><z id="t1475656545" t="jeroenvandijk This is not the real issue i‚Äôm seeing in production, but this also doesn‚Äôt match my mental model of manifold"><y>#</y><d>2016-10-05</d><h>08:35</h><w>jeroenvandijk</w>This is not the real issue i‚Äôm seeing in production, but this also doesn‚Äôt match my mental model of manifold</z><z id="t1475657190" t="dm3 I think how this works"><y>#</y><d>2016-10-05</d><h>08:46</h><w>dm3</w>I think how this works</z><z id="t1475657207" t="dm3 the first value always gets &quot;taken&quot; from the source stream at the point you connect"><y>#</y><d>2016-10-05</d><h>08:46</h><w>dm3</w>the first value always gets &quot;taken&quot; from the source stream at the point you <code>connect</code></z><z id="t1475657236" t="dm3 so, once connected, there will always be a pending-take on the source stream"><y>#</y><d>2016-10-05</d><h>08:47</h><w>dm3</w>so, once connected, there will always be a <code>pending-take</code> on the source stream</z><z id="t1475657310" t="dm3 after you did put-all! on the source stream before that, it created a pending-put"><y>#</y><d>2016-10-05</d><h>08:48</h><w>dm3</w>after you did <code>put-all!</code> on the source stream before that, it created a <code>pending-put</code></z><z id="t1475657328" t="dm3 so the value 1 is propagated to the sink stream once you connect"><y>#</y><d>2016-10-05</d><h>08:48</h><w>dm3</w>so the value <code>1</code> is propagated to the sink stream once you <code>connect</code></z><z id="t1475657365" t="dm3 which also creates a pending-put for the value 2 on the source stream (so you can think of the value as already in the stream)"><y>#</y><d>2016-10-05</d><h>08:49</h><w>dm3</w>which also creates a <code>pending-put</code> for the value <code>2</code> on the source stream (so you can think of the value as already in the stream)</z><z id="t1475657418" t="dm3 I guess the timeout should have happened for the value 2"><y>#</y><d>2016-10-05</d><h>08:50</h><w>dm3</w>I guess the timeout should have happened for the value <code>2</code></z><z id="t1475657818" t="jeroenvandijk Yes that‚Äôs what i think should happen. It seems the :timeout option via connect does some skipping too"><y>#</y><d>2016-10-05</d><h>08:56</h><w>jeroenvandijk</w>Yes that‚Äôs what i think should happen. It seems the <code>:timeout</code> option via connect does some skipping too</z><z id="t1475657850" t="jeroenvandijk Btw I think I‚Äôve replicated the production issue. Maybe it‚Äôs because I‚Äôm using a s/buffered-stream and not s/stream"><y>#</y><d>2016-10-05</d><h>08:57</h><w>jeroenvandijk</w>Btw I think I‚Äôve replicated the production issue. Maybe it‚Äôs because I‚Äôm using a <code>s/buffered-stream</code> and not <code>s/stream</code></z><z id="t1475658067" t="jeroenvandijk maybe i‚Äôm misusing the s/buffered-stream"><y>#</y><d>2016-10-05</d><h>09:01</h><w>jeroenvandijk</w>maybe i‚Äôm misusing the <code>s/buffered-stream</code></z><z id="t1475658145" t="jeroenvandijk What I really want to achieve is what zach describes in his presentation here [1], a way to prevent one slow consumer to block the rest, but I haven‚Äôt found how yet [1] https://www.youtube.com/watch?v=1bNOO3xxMc0&amp;amp;feature=youtu.be&amp;amp;t=1887"><y>#</y><d>2016-10-05</d><h>09:02</h><w>jeroenvandijk</w>What I really want to achieve is what zach describes in his presentation here [1], a way to prevent one slow consumer to block the rest, but I haven‚Äôt found how yet  [1] <a href="https://www.youtube.com/watch?v=1bNOO3xxMc0&amp;amp;feature=youtu.be&amp;amp;t=1887" target="_blank">https://www.youtube.com/watch?v=1bNOO3xxMc0&amp;amp;feature=youtu.be&amp;amp;t=1887</a></z><z id="t1475658174" t="dm3 event bus should achieve that"><y>#</y><d>2016-10-05</d><h>09:02</h><w>dm3</w>event bus should achieve that</z><z id="t1475658185" t="dm3 the subscription should drop due to a timeout"><y>#</y><d>2016-10-05</d><h>09:03</h><w>dm3</w>the subscription should drop due to a timeout</z><z id="t1475658230" t="jeroenvandijk Yes I would have hoped that, but this never happened in production"><y>#</y><d>2016-10-05</d><h>09:03</h><w>jeroenvandijk</w>Yes I would have hoped that, but this never happened in production</z><z id="t1475658292" t="jeroenvandijk And consequently new connections wouldn‚Äôt receive any messages, because, i think, the other subscribers were blocking the producer"><y>#</y><d>2016-10-05</d><h>09:04</h><w>jeroenvandijk</w>And consequently new connections wouldn‚Äôt receive any messages, because, i think, the other subscribers were blocking the producer</z><z id="t1475658365" t="jeroenvandijk The documentation on buffered-streams implies that the buffer-size shouldn&apos;t get this big i think: (buffered-stream buffer-size) (buffered-stream metric limit) (buffered-stream metric limit description) A stream which will buffer at most limit data, where the size of each message is defined by (metric message)."><y>#</y><d>2016-10-05</d><h>09:06</h><w>jeroenvandijk</w>The documentation on <code>buffered-streams</code> implies that the <code>buffer-size</code> shouldn&apos;t get this big i think: <pre>(buffered-stream buffer-size)
(buffered-stream metric limit)
(buffered-stream metric limit description)
A stream which will buffer at most limit data, where the size of each message is defined by (metric message).</pre></z><z id="t1475658463" t="dm3 yep"><y>#</y><d>2016-10-05</d><h>09:07</h><w>dm3</w>yep</z><z id="t1475658606" t="dm3 seems like a bug with buffered-stream.. if you use (s/stream buffer-size) , the buffer-size doesn&apos;t go over the capacity"><y>#</y><d>2016-10-05</d><h>09:10</h><w>dm3</w>seems like a bug with buffered-stream.. if you use <code>(s/stream buffer-size)</code>, the buffer-size doesn&apos;t go over the capacity</z><z id="t1475658836" t="jeroenvandijk yeah this one is interesting too. It seems to be a very specific issue with buffered-stream as it doesn‚Äôt happen here in the same way: (fact &quot;Buffered stream does have a limit +1&quot; (let [s (s/buffered-stream 10)] @(d/timeout! (s/put-all! s (range 100)) 100 :timed-out-like-expected) =&gt; :timed-out-like-expected (s/description s) =&gt; {:buffer-capacity 10, :buffer-size 11, :closed? false, :drained? false, :pending-puts 0, :pending-takes 0, :permanent? false, :sink? true, :source? true, :type &quot;manifold&quot;}))"><y>#</y><d>2016-10-05</d><h>09:13</h><w>jeroenvandijk</w>yeah this one is interesting too. It seems to be a very specific issue with buffered-stream as it doesn‚Äôt happen here in the same way: <pre>(fact &quot;Buffered stream does have a limit +1&quot;
      (let [s (s/buffered-stream 10)]

        @(d/timeout! (s/put-all! s (range 100)) 100 :timed-out-like-expected) =&gt; :timed-out-like-expected

        (s/description s) =&gt; {:buffer-capacity 10, :buffer-size 11, :closed? false, :drained? false, :pending-puts 0, :pending-takes 0, :permanent? false, :sink? true, :source? true, :type &quot;manifold&quot;}))</pre></z><z id="t1475659013" t="dm3 ah"><y>#</y><d>2016-10-05</d><h>09:16</h><w>dm3</w>ah</z><z id="t1475659021" t="dm3 ok, one issue is with publishing to the bus"><y>#</y><d>2016-10-05</d><h>09:17</h><w>dm3</w>ok, one issue is with publishing to the bus</z><z id="t1475659035" t="dm3 you are not respecting the backpressure"><y>#</y><d>2016-10-05</d><h>09:17</h><w>dm3</w>you are not respecting the backpressure</z><z id="t1475659039" t="dm3 on bus/publish!"><y>#</y><d>2016-10-05</d><h>09:17</h><w>dm3</w>on <code>bus/publish!</code></z><z id="t1475659087" t="jeroenvandijk What about this one? (fact &quot;Buffered stream goes wild in combination with another thread&quot; (let [s (s/buffered-stream 10)] (future (dotimes [i 100] (s/put! s i))) (Thread/sleep 100) (s/description s) =&gt; {:buffer-capacity 10, :buffer-size 100, :closed? false, :drained? false, :pending-puts 0, :pending-takes 0, :permanent? false, :sink? true, :source? true, :type &quot;manifold&quot;}))"><y>#</y><d>2016-10-05</d><h>09:18</h><w>jeroenvandijk</w>What about this one? <pre>(fact &quot;Buffered stream goes wild in combination with another thread&quot;
      (let [s (s/buffered-stream 10)]

        (future
          (dotimes [i 100]
            (s/put! s i)))

        (Thread/sleep 100)

        (s/description s) =&gt; {:buffer-capacity 10, :buffer-size 100, :closed? false, :drained? false, :pending-puts 0, :pending-takes 0, :permanent? false, :sink? true, :source? true, :type &quot;manifold&quot;}))</pre></z><z id="t1475659118" t="dm3 when calling put! , you have to respect the backpressure"><y>#</y><d>2016-10-05</d><h>09:18</h><w>dm3</w>when calling <code>put!</code>, you have to respect the backpressure</z><z id="t1475659123" t="jeroenvandijk ah ok"><y>#</y><d>2016-10-05</d><h>09:18</h><w>jeroenvandijk</w>ah ok</z><z id="t1475659135" t="dm3 I&apos;m not sure what it should be doing here though, if you don&apos;t respect it"><y>#</y><d>2016-10-05</d><h>09:18</h><w>dm3</w>I&apos;m not sure what it should be doing here though, if you don&apos;t respect it</z><z id="t1475659149" t="dm3 it&apos;s probably undefined"><y>#</y><d>2016-10-05</d><h>09:19</h><w>dm3</w>it&apos;s probably undefined</z><z id="t1475659162" t="dm3 accumulating values in the buffer doesn&apos;t seem like the best idea"><y>#</y><d>2016-10-05</d><h>09:19</h><w>dm3</w>accumulating values in the buffer doesn&apos;t seem like the best idea</z><z id="t1475659184" t="jeroenvandijk yes I guess it has to queue somewhere. I thought too that buffered-stream would work like a sliding-buffer and drop values"><y>#</y><d>2016-10-05</d><h>09:19</h><w>jeroenvandijk</w>yes I guess it has to queue somewhere. I thought too that buffered-stream would work like a sliding-buffer and drop values</z><z id="t1475659209" t="jeroenvandijk Do you know how to achieve this with manifold? I had something like this with core.async"><y>#</y><d>2016-10-05</d><h>09:20</h><w>jeroenvandijk</w>Do you know how to achieve this with manifold? I had something like this with core.async</z><z id="t1475659241" t="jeroenvandijk maybe i should use try-put! instead"><y>#</y><d>2016-10-05</d><h>09:20</h><w>jeroenvandijk</w>maybe i should use try-put! instead</z><z id="t1475659242" t="dm3 stream/throttle ?"><y>#</y><d>2016-10-05</d><h>09:20</h><w>dm3</w><code>stream/throttle</code>?</z><z id="t1475659293" t="dm3 you can also whip up something based on d/loop which I usually do"><y>#</y><d>2016-10-05</d><h>09:21</h><w>dm3</w>you can also whip up something based on <code>d/loop</code> which I usually do</z><z id="t1475659303" t="dm3 look at the throttle impl for example"><y>#</y><d>2016-10-05</d><h>09:21</h><w>dm3</w>look at the <code>throttle</code> impl for example</z><z id="t1475659303" t="jeroenvandijk if i don‚Äôt want to throttle on the rate I need to have a high rate and set a max-backlog I suppose"><y>#</y><d>2016-10-05</d><h>09:21</h><w>jeroenvandijk</w>if i don‚Äôt want to throttle on the rate I need to have a high rate and set a max-backlog I suppose</z><z id="t1475659325" t="jeroenvandijk thanks, I‚Äôll have a look"><y>#</y><d>2016-10-05</d><h>09:22</h><w>jeroenvandijk</w>thanks, I‚Äôll have a look</z><z id="t1475659364" t="dm3 would be also great if you could create an issue with the test cases"><y>#</y><d>2016-10-05</d><h>09:22</h><w>dm3</w>would be also great if you could create an issue with the test cases</z><z id="t1475659383" t="dm3 to question the behaviour that we&apos;ve seen"><y>#</y><d>2016-10-05</d><h>09:23</h><w>dm3</w>to question the behaviour that we&apos;ve seen</z><z id="t1475659391" t="jeroenvandijk Would you mark them all as issues? Or should I just go ahead and let Zach decide?"><y>#</y><d>2016-10-05</d><h>09:23</h><w>jeroenvandijk</w>Would you mark them all as issues? Or should I just go ahead and let Zach decide?</z><z id="t1475659416" t="dm3 I&apos;d just have one issue"><y>#</y><d>2016-10-05</d><h>09:23</h><w>dm3</w>I&apos;d just have one issue</z><z id="t1475659435" t="dm3 with the behaviour of buffered streams when puts don&apos;t respect the backpressure"><y>#</y><d>2016-10-05</d><h>09:23</h><w>dm3</w>with the behaviour of buffered streams when <code>puts</code> don&apos;t respect the backpressure</z><z id="t1475659447" t="jeroenvandijk ah yeah, ok I‚Äôll do that"><y>#</y><d>2016-10-05</d><h>09:24</h><w>jeroenvandijk</w>ah yeah, ok I‚Äôll do that</z><z id="t1475659466" t="jeroenvandijk thanks for your support üôÇ"><y>#</y><d>2016-10-05</d><h>09:24</h><w>jeroenvandijk</w>thanks for your support <b>üôÇ</b></z><z id="t1475659502" t="dm3 np"><y>#</y><d>2016-10-05</d><h>09:25</h><w>dm3</w>np</z><z id="t1475661505" t="jeroenvandijk here it is https://github.com/ztellman/manifold/issues/110"><y>#</y><d>2016-10-05</d><h>09:58</h><w>jeroenvandijk</w>here it is <a href="https://github.com/ztellman/manifold/issues/110" target="_blank">https://github.com/ztellman/manifold/issues/110</a></z><z id="t1475661598" t="dm3 thanks üôÇ"><y>#</y><d>2016-10-05</d><h>09:59</h><w>dm3</w>thanks <b>üôÇ</b></z><z id="t1475663848" t="jeroenvandijk I think I‚Äôll stay away from buffered-stream for now üôÇ"><y>#</y><d>2016-10-05</d><h>10:37</h><w>jeroenvandijk</w>I think I‚Äôll stay away from buffered-stream for now <b>üôÇ</b></z><z id="t1475664068" t="dm3 it&apos;s the same issue"><y>#</y><d>2016-10-05</d><h>10:41</h><w>dm3</w>it&apos;s the same issue</z><z id="t1475664085" t="dm3 zip runs put! on every item"><y>#</y><d>2016-10-05</d><h>10:41</h><w>dm3</w>zip runs <code>put!</code> on every item</z><z id="t1475664845" t="jeroenvandijk yes you are right so I guess i could listen to the backpressure via a deref of manifold.bus/publish!"><y>#</y><d>2016-10-05</d><h>10:54</h><w>jeroenvandijk</w>yes you are right so I guess i could listen to the backpressure via a deref of <code>manifold.bus/publish!</code></z><z id="t1475664933" t="jeroenvandijk I have replaced buffered-stream with a normal stream with a buffer and redeployed to see how it changes things"><y>#</y><d>2016-10-05</d><h>10:55</h><w>jeroenvandijk</w>I have replaced buffered-stream with a normal stream with a buffer and redeployed to see how it changes things</z><z id="t1475664959" t="dm3 if the bus is configured with a timeout, the connection to the slow stream should be severed"><y>#</y><d>2016-10-05</d><h>10:55</h><w>dm3</w>if the bus is configured with a timeout, the connection to the slow stream should be severed</z><z id="t1475664966" t="dm3 but you have to manage the backpressure"><y>#</y><d>2016-10-05</d><h>10:56</h><w>dm3</w>but you have to manage the backpressure</z><z id="t1475669661" t="jeroenvandijk Yeah I‚Äôll have to think it through one more time"><y>#</y><d>2016-10-05</d><h>12:14</h><w>jeroenvandijk</w>Yeah I‚Äôll have to think it through one more time</z><z id="t1475669675" t="jeroenvandijk I have at least one other issue with manifold in combination with aleph. It might be just be my misunderstanding. I‚Äôm sending a stream of server side events to a http client (in this case curl). I would suspect that aleph would close this stream on disconnect, right? Yet this is not something I have observed"><y>#</y><d>2016-10-05</d><h>12:14</h><w>jeroenvandijk</w>I have at least one other issue with manifold in combination with aleph. It might be just be my misunderstanding. I‚Äôm sending a stream of server side events to a http client (in this case curl). I would suspect that aleph would close this stream on disconnect, right? Yet this is not something I have observed</z><z id="t1475669813" t="dm3 I don&apos;t have much experience with aleph"><y>#</y><d>2016-10-05</d><h>12:16</h><w>dm3</w>I don&apos;t have much experience with aleph</z><z id="t1475669832" t="dm3 but I&apos;d look for on-close in the sources"><y>#</y><d>2016-10-05</d><h>12:17</h><w>dm3</w>but I&apos;d look for <code>on-close</code> in the sources</z><z id="t1475669843" t="dm3 or something like that"><y>#</y><d>2016-10-05</d><h>12:17</h><w>dm3</w>or something like that</z><z id="t1475669872" t="dm3 in manifold you can only close a sink that you are writing to"><y>#</y><d>2016-10-05</d><h>12:17</h><w>dm3</w>in manifold you can only close a sink that you are writing to</z><z id="t1475670031" t="jeroenvandijk ah thanks i‚Äôll have a look"><y>#</y><d>2016-10-05</d><h>12:20</h><w>jeroenvandijk</w>ah thanks i‚Äôll have a look</z><z id="t1475670487" t="lmergen manifold streams will automatically close once all downstream sinks are closed"><y>#</y><d>2016-10-05</d><h>12:28</h><w>lmergen</w>manifold streams will automatically close once all downstream sinks are closed</z><z id="t1475670502" t="lmergen it could be that you created your streams in the wrong way, though"><y>#</y><d>2016-10-05</d><h>12:28</h><w>lmergen</w>it could be that you created your streams in the wrong way, though</z><z id="t1475670520" t="lmergen take a look at the upstream? or downstream? properties of your stream"><y>#</y><d>2016-10-05</d><h>12:28</h><w>lmergen</w>take a look at the <code>upstream?</code> or <code>downstream?</code> properties of your stream</z><z id="t1475670725" t="jeroenvandijk ah [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] you are right. I think the problem is with an intermedia transform: user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream) ([{:op &quot;transducer&quot;} &lt;&lt; stream: {:pending-puts 2, :drained? false, :buffer-size 0, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? false, :pending-takes 0, :buffer-capacity 0, :source? true} &gt;&gt;]) user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream first second s/downstream) ([{:op &quot;map&quot;} &lt;&lt; sink: {:type &quot;callback&quot;} &gt;&gt;]) user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream first second s/downstream first second s/downstream) [&lt;&lt; stream: {:pending-puts 0, :drained? true, :buffer-size 0, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? true, :pending-takes 0, :buffer-capacity 0, :source? true} &gt;&gt;] user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream first second s/downstream first second s/downstream first s/downstream) nil"><y>#</y><d>2016-10-05</d><h>12:32</h><w>jeroenvandijk</w>ah <a>@lmergen</a> you are right. I think the problem is with an intermedia transform: <pre>user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream)
([{:op &quot;transducer&quot;} &lt;&lt; stream: {:pending-puts 2, :drained? false, :buffer-size 0, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? false, :pending-takes 0, :buffer-capacity 0, :source? true} &gt;&gt;])
user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream first second s/downstream)
([{:op &quot;map&quot;} &lt;&lt; sink: {:type &quot;callback&quot;} &gt;&gt;])
user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream first second s/downstream first second s/downstream)
[&lt;&lt; stream: {:pending-puts 0, :drained? true, :buffer-size 0, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? true, :pending-takes 0, :buffer-capacity 0, :source? true} &gt;&gt;]
user=&gt; (-&gt; (bus/topic-&gt;subscribers event-bus) :aggregates first s/downstream first second s/downstream first second s/downstream first s/downstream)
nil</pre></z><z id="t1475670747" t="jeroenvandijk i think i have to create a transform that has a :timeout"><y>#</y><d>2016-10-05</d><h>12:32</h><w>jeroenvandijk</w>i think i have to create a transform that has a <code>:timeout</code></z><z id="t1475670779" t="jeroenvandijk btw, the above says the final stream is closed, but the intermediate ones not"><y>#</y><d>2016-10-05</d><h>12:32</h><w>jeroenvandijk</w>btw, the above says the final stream is closed, but the intermediate ones not</z><z id="t1475670888" t="jeroenvandijk that said it might be are a weird mix, as there are also pending puts on the first one"><y>#</y><d>2016-10-05</d><h>12:34</h><w>jeroenvandijk</w>that said it might be are a weird mix, as there are also pending puts on the first one</z><z id="t1475670915" t="dm3 ah right, always forget about that"><y>#</y><d>2016-10-05</d><h>12:35</h><w>dm3</w>ah right, always forget about that</z><z id="t1475670922" t="dm3 sneaky auto close"><y>#</y><d>2016-10-05</d><h>12:35</h><w>dm3</w>sneaky auto close</z><z id="t1475670953" t="dm3 also close signal doesn&apos;t propagate unless you put another value"><y>#</y><d>2016-10-05</d><h>12:35</h><w>dm3</w>also close signal doesn&apos;t propagate unless you put another value</z><z id="t1475670960" t="dm3 IIRC"><y>#</y><d>2016-10-05</d><h>12:36</h><w>dm3</w>IIRC</z><z id="t1475671032" t="jeroenvandijk yeah that was my first suprise indeed: (fact &quot;Transform doesn&apos;t close right away, but after a new put&quot; (let [source (s/stream) sink (s/transform (map identity) source)] (s/close! sink) (s/closed? source) =&gt; false (s/put! source :foo) (s/closed? source) =&gt; true))"><y>#</y><d>2016-10-05</d><h>12:37</h><w>jeroenvandijk</w>yeah that was my first suprise indeed: <pre>(fact &quot;Transform doesn&apos;t close right away, but after a new put&quot;
             (let [source (s/stream)
                   sink (s/transform (map identity) source)]
               (s/close! sink)
               (s/closed? source) =&gt; false

               (s/put! source :foo)
               (s/closed? source) =&gt; true))</pre></z><z id="t1475671056" t="lmergen yes"><y>#</y><d>2016-10-05</d><h>12:37</h><w>lmergen</w>yes</z><z id="t1475671066" t="lmergen i don‚Äôt think this is the best behavior, tbh"><y>#</y><d>2016-10-05</d><h>12:37</h><w>lmergen</w>i don‚Äôt think this is the best behavior, tbh</z><z id="t1475671089" t="dm3 it&apos;s an implementation issue - not very easy to solve"><y>#</y><d>2016-10-05</d><h>12:38</h><w>dm3</w>it&apos;s an implementation issue - not very easy to solve</z><z id="t1475671240" t="jeroenvandijk i guess it is also an optimization as you don‚Äôt have to go up the chain, but you do it lazily down the chain? Close whatever you can close along the way"><y>#</y><d>2016-10-05</d><h>12:40</h><w>jeroenvandijk</w>i guess it is also an optimization as you don‚Äôt have to go up the chain, but you do it lazily down the chain? Close whatever you can close along the way</z><z id="t1475671256" t="jeroenvandijk but it is a gotcha though"><y>#</y><d>2016-10-05</d><h>12:40</h><w>jeroenvandijk</w>but it is a gotcha though</z><z id="t1475671985" t="jeroenvandijk btw, [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] i see you are in Amsterdam too üôÇ Haven‚Äôt been to the meetup lately. Do you do a lot with Aleph?"><y>#</y><d>2016-10-05</d><h>12:53</h><w>jeroenvandijk</w>btw, <a>@lmergen</a> i see you are in Amsterdam too <b>üôÇ</b> Haven‚Äôt been to the meetup lately. Do you do a lot with Aleph?</z><z id="t1475672021" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] we‚Äôre actually hosting the meetup nowadays üôÇ"><y>#</y><d>2016-10-05</d><h>12:53</h><w>lmergen</w><a>@jeroenvandijk</a> we‚Äôre actually hosting the meetup nowadays <b>üôÇ</b></z><z id="t1475672030" t="lmergen we do quiet a lot with aleph"><y>#</y><d>2016-10-05</d><h>12:53</h><w>lmergen</w>we do quiet a lot with aleph</z><z id="t1475672050" t="lmergen we‚Äôre heavy into the juxt ecosystem (most notably yada), which does everything with aleph"><y>#</y><d>2016-10-05</d><h>12:54</h><w>lmergen</w>we‚Äôre heavy into the juxt ecosystem (most notably yada), which does everything with aleph</z><z id="t1475672066" t="lmergen on top of that, all our microservices use it for http clients as well"><y>#</y><d>2016-10-05</d><h>12:54</h><w>lmergen</w>on top of that, all our microservices use it for http clients as well</z><z id="t1475672077" t="lmergen and‚Ä¶ it has its rough edges, like these"><y>#</y><d>2016-10-05</d><h>12:54</h><w>lmergen</w>and‚Ä¶ it has its rough edges, like these</z><z id="t1475672087" t="jeroenvandijk ah nice"><y>#</y><d>2016-10-05</d><h>12:54</h><w>jeroenvandijk</w>ah nice</z><z id="t1475672108" t="jeroenvandijk i saw the meetup page indeed. I have to go to the meetups again üôÇ"><y>#</y><d>2016-10-05</d><h>12:55</h><w>jeroenvandijk</w>i saw the meetup page indeed. I have to go to the meetups again <b>üôÇ</b></z><z id="t1475672139" t="jeroenvandijk I‚Äôm trying to build an Hystrix clone. It works locally, but not so much under high load it seems"><y>#</y><d>2016-10-05</d><h>12:55</h><w>jeroenvandijk</w>I‚Äôm trying to build an Hystrix clone. It works locally, but not so much under high load it seems</z><z id="t1475672179" t="jeroenvandijk I‚Äôm positive Aleph/Manifold can do it though if i use it right"><y>#</y><d>2016-10-05</d><h>12:56</h><w>jeroenvandijk</w>I‚Äôm positive Aleph/Manifold can do it though if i use it right</z><z id="t1475672468" t="jeroenvandijk hmm locally the transform really doesn‚Äôt need a timeout to close. I think the high load really does something different somewhere. Maybe i should simplify the transform and see what happens"><y>#</y><d>2016-10-05</d><h>13:01</h><w>jeroenvandijk</w>hmm locally the transform really doesn‚Äôt need a timeout to close. I think the high load really does something different somewhere. Maybe i should simplify the transform and see what happens</z><z id="t1475672936" t="dm3 you might be interested in looking at https://github.com/tulos/manifail - tangentially related"><y>#</y><d>2016-10-05</d><h>13:08</h><w>dm3</w>you might be interested in looking at <a href="https://github.com/tulos/manifail" target="_blank">https://github.com/tulos/manifail</a> - tangentially related</z><z id="t1475674360" t="jeroenvandijk ah thanks, definitely interesting!"><y>#</y><d>2016-10-05</d><h>13:32</h><w>jeroenvandijk</w>ah thanks, definitely interesting!</z><z id="t1475674459" t="jeroenvandijk The main thing I‚Äôm after in the beginning is convenient monitoring and latency control. short-circuiting would also be interesting. I‚Äôm not planning to build a one to one hystrix clone, but I would like to make something that is compatible with their dashboard"><y>#</y><d>2016-10-05</d><h>13:34</h><w>jeroenvandijk</w>The main thing I‚Äôm after in the beginning is convenient monitoring and latency control. short-circuiting would also be interesting. I‚Äôm not planning to build a one to one hystrix clone, but I would like to make something that is compatible with their dashboard</z><z id="t1475674573" t="jeroenvandijk In what kind of application do you use this?"><y>#</y><d>2016-10-05</d><h>13:36</h><w>jeroenvandijk</w>In what kind of application do you use this?</z><z id="t1475674611" t="dm3 retrying remote requests mostly"><y>#</y><d>2016-10-05</d><h>13:36</h><w>dm3</w>retrying remote requests mostly</z><z id="t1475674624" t="dm3 in various places"><y>#</y><d>2016-10-05</d><h>13:37</h><w>dm3</w>in various places</z><z id="t1475674693" t="jeroenvandijk it has a nice and compact code base"><y>#</y><d>2016-10-05</d><h>13:38</h><w>jeroenvandijk</w>it has a nice and compact code base</z><z id="t1475674725" t="dm3 only handles retries though"><y>#</y><d>2016-10-05</d><h>13:38</h><w>dm3</w>only handles retries though</z><z id="t1475674908" t="jeroenvandijk yeah I‚Äôm working on a realtime bidding system. The remote services we use are normally reliable, but getting latency perfectly under control is harder. We have something that works, but could be better. I would like to apply semaphores and timeouts to get this better. A hystrix kind of abstraction in idiomatic clojure would be nice i think"><y>#</y><d>2016-10-05</d><h>13:41</h><w>jeroenvandijk</w>yeah I‚Äôm working on a realtime bidding system. The remote services we use are normally reliable, but getting latency perfectly under control is harder. We have something that works, but could be better. I would like to apply semaphores and timeouts to get this better. A hystrix kind of abstraction in idiomatic clojure would be nice i think</z><z id="t1475674938" t="dm3 hehe, aren&apos;t you scared of GC pauses all over the place?"><y>#</y><d>2016-10-05</d><h>13:42</h><w>dm3</w>hehe, aren&apos;t you scared of GC pauses all over the place?</z><z id="t1475674973" t="jeroenvandijk you mean because of the Hystrix approach or just in general?"><y>#</y><d>2016-10-05</d><h>13:42</h><w>jeroenvandijk</w>you mean because of the Hystrix approach or just in general?</z><z id="t1475675000" t="jeroenvandijk it is realtime bidding in the advertising domain so you still have 100ms or more per request, not too bad"><y>#</y><d>2016-10-05</d><h>13:43</h><w>jeroenvandijk</w>it is realtime bidding in the advertising domain so you still have 100ms or more per request, not too bad</z><z id="t1475675033" t="jeroenvandijk it‚Äôs not bidding on a money exchange where it is submillisecond"><y>#</y><d>2016-10-05</d><h>13:43</h><w>jeroenvandijk</w>it‚Äôs not bidding on a money exchange where it is submillisecond</z><z id="t1475675196" t="dm3 yeah, you should be able to keep under that limit. However you are destined to have a fun time reducing allocations in Clojure code at some point üôÇ"><y>#</y><d>2016-10-05</d><h>13:46</h><w>dm3</w>yeah, you should be able to keep under that limit. However you are destined to have a fun time reducing allocations in Clojure code at some point <b>üôÇ</b></z><z id="t1475675285" t="jeroenvandijk it has been live for a few years so nothing too bad üòé"><y>#</y><d>2016-10-05</d><h>13:48</h><w>jeroenvandijk</w>it has been live for a few years so nothing too bad <b>üòé</b></z><z id="t1475675324" t="jeroenvandijk i‚Äôm profiling my newly deployed code now, and i see clojure.lang.LockingTransaction$RetryEx coming up. Never seen that before. Does it ring a bell?"><y>#</y><d>2016-10-05</d><h>13:48</h><w>jeroenvandijk</w>i‚Äôm profiling my newly deployed code now, and i see clojure.lang.LockingTransaction$RetryEx coming up. Never seen that before. Does it ring a bell?</z><z id="t1475675327" t="dm3 ah, ok then üôÇ"><y>#</y><d>2016-10-05</d><h>13:48</h><w>dm3</w>ah, ok then <b>üôÇ</b></z><z id="t1475675348" t="dm3 STM?"><y>#</y><d>2016-10-05</d><h>13:49</h><w>dm3</w>STM?</z><z id="t1475675364" t="dm3 conflicts in swap! ?"><y>#</y><d>2016-10-05</d><h>13:49</h><w>dm3</w>conflicts in <code>swap!</code>?</z><z id="t1475675403" t="jeroenvandijk yeah must something like that, but never seen it before so must have something to do with the new code. So i guess nothing manifold specific"><y>#</y><d>2016-10-05</d><h>13:50</h><w>jeroenvandijk</w>yeah must something like that, but never seen it before so must have something to do with the new code. So i guess nothing manifold specific</z><z id="t1475675450" t="jeroenvandijk I also noted that there are some reflection issues with Manifold. I get quite some warnings"><y>#</y><d>2016-10-05</d><h>13:50</h><w>jeroenvandijk</w>I also noted that there are some reflection issues with Manifold. I get quite some warnings</z><z id="t1475675466" t="jeroenvandijk The reflector is also scoring high in the profiling list"><y>#</y><d>2016-10-05</d><h>13:51</h><w>jeroenvandijk</w>The reflector is also scoring high in the profiling list</z><z id="t1475675640" t="jeroenvandijk Ah the downside of debugging/profiling in a live system‚Ä¶ something else is causing the hiccup"><y>#</y><d>2016-10-05</d><h>13:54</h><w>jeroenvandijk</w>Ah the downside of debugging/profiling in a live system‚Ä¶ something else is causing the hiccup</z><z id="t1475675641" t="dm3 I&apos;d be surprised"><y>#</y><d>2016-10-05</d><h>13:54</h><w>dm3</w>I&apos;d be surprised</z><z id="t1475675678" t="jeroenvandijk I think it is clojure.pprint/pprint printing a lot of errors at the moment..."><y>#</y><d>2016-10-05</d><h>13:54</h><w>jeroenvandijk</w>I think it is <code>clojure.pprint/pprint</code> printing a lot of errors at the moment...</z><z id="t1475675894" t="jeroenvandijk or better the agent that is calling pprint, agents have a lockingtransaction apparently"><y>#</y><d>2016-10-05</d><h>13:58</h><w>jeroenvandijk</w>or better the agent that is calling pprint, agents have a lockingtransaction apparently</z><z id="t1475678382" t="jeroenvandijk I have something working. There was one other issue where I didn‚Äôt add the newlines and so the SSE endpoint wouldn‚Äôt flush the events"><y>#</y><d>2016-10-05</d><h>14:39</h><w>jeroenvandijk</w>I have something working. There was one other issue where I didn‚Äôt add the newlines and so the SSE endpoint wouldn‚Äôt flush the events</z><z id="t1475678388" t="jeroenvandijk thanks for the help!"><y>#</y><d>2016-10-05</d><h>14:39</h><w>jeroenvandijk</w>thanks for the help!</z><z id="t1475681183" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] interesting you‚Äôre working on a hystrix clone! i was actually thinking about doing some work in this area as well, but am more looking for a higher-level ‚Äúmicroservice client‚Äù, like what you could imagine the client-side counterpart of Yada to be"><y>#</y><d>2016-10-05</d><h>15:26</h><w>lmergen</w><a>@jeroenvandijk</a> interesting you‚Äôre working on a hystrix clone! i was actually thinking about doing some work in this area as well, but am more looking for a higher-level ‚Äúmicroservice client‚Äù, like what you could imagine the client-side counterpart of Yada to be</z><z id="t1475681456" t="jeroenvandijk Cool üôÇ I can imagine it doesn‚Äôt matter much if it is on the server or on a client. My first approach was with core.async and I actually thought of creating a browser demo. But core.async is harder to wrap than manifold due the dependency of macros. I‚Äôm not sure what needs to happen to make something work on a browser client if that‚Äôs what you mean"><y>#</y><d>2016-10-05</d><h>15:30</h><w>jeroenvandijk</w>Cool <b>üôÇ</b> I can imagine it doesn‚Äôt matter much if it is on the server or on a client. My first approach was with core.async and I actually thought of creating a browser demo. But core.async is harder to wrap than manifold due the dependency of macros. I‚Äôm not sure what needs to happen to make something work on a browser client if that‚Äôs what you mean</z><z id="t1475681546" t="lmergen true, but if you want to implement hystrix features like bulkheads, things start to become a bit more difficult with manifold i think"><y>#</y><d>2016-10-05</d><h>15:32</h><w>lmergen</w>true, but if you want to implement hystrix features like bulkheads, things start to become a bit more difficult with manifold i think</z><z id="t1475681731" t="jeroenvandijk you mean bulk head requests? or is it that a term i don‚Äôt know?"><y>#</y><d>2016-10-05</d><h>15:35</h><w>jeroenvandijk</w>you mean bulk head requests? or is it that a term i don‚Äôt know?</z><z id="t1475681764" t="jeroenvandijk never mind i see it is in hystrix"><y>#</y><d>2016-10-05</d><h>15:36</h><w>jeroenvandijk</w>never mind i see it is in hystrix</z><z id="t1475681817" t="jeroenvandijk Yeah I‚Äôm not after complete thread isolation i guess"><y>#</y><d>2016-10-05</d><h>15:36</h><w>jeroenvandijk</w>Yeah I‚Äôm not after complete thread isolation i guess</z><z id="t1475681834" t="jeroenvandijk I would like to use semaphores to control the concurrency"><y>#</y><d>2016-10-05</d><h>15:37</h><w>jeroenvandijk</w>I would like to use semaphores to control the concurrency</z><z id="t1475681857" t="jeroenvandijk that is actually pretty easy to implement with manifold"><y>#</y><d>2016-10-05</d><h>15:37</h><w>jeroenvandijk</w>that is actually pretty easy to implement with manifold</z><z id="t1475681901" t="jeroenvandijk Maybe thread isolation would be possible with setting specific executors"><y>#</y><d>2016-10-05</d><h>15:38</h><w>jeroenvandijk</w>Maybe thread isolation would be possible with setting specific executors</z><z id="t1475681931" t="jeroenvandijk I‚Äôm not a manifold expert either, nor hystrix for that matter. So maybe I‚Äôm underestimating the full problem"><y>#</y><d>2016-10-05</d><h>15:38</h><w>jeroenvandijk</w>I‚Äôm not a manifold expert either, nor hystrix for that matter. So maybe I‚Äôm underestimating the full problem</z><z id="t1475681948" t="jeroenvandijk The first version i have in mind is simple enough i think"><y>#</y><d>2016-10-05</d><h>15:39</h><w>jeroenvandijk</w>The first version i have in mind is simple enough i think</z><z id="t1475681960" t="jeroenvandijk If i get this reporting to work properly that is üôÇ"><y>#</y><d>2016-10-05</d><h>15:39</h><w>jeroenvandijk</w>If i get this reporting to work properly that is <b>üôÇ</b></z><z id="t1475682093" t="jeroenvandijk I can give you a preview if you are interested in the semaphore implementation"><y>#</y><d>2016-10-05</d><h>15:41</h><w>jeroenvandijk</w>I can give you a preview if you are interested in the semaphore implementation</z><z id="t1475682211" t="jeroenvandijk Maybe I‚Äôm missing something. Why do you think bulkheads would be hard to implement with manifold?"><y>#</y><d>2016-10-05</d><h>15:43</h><w>jeroenvandijk</w>Maybe I‚Äôm missing something. Why do you think bulkheads would be hard to implement with manifold?</z><z id="t1475682523" t="jeroenvandijk When I read this http://stackoverflow.com/questions/30391809/what-is-bulkhead-pattern-used-by-hystrix I‚Äôm guessing that a semaphore (control the number of concurrent requests) and an executor with a maximum of threads would be equivalent"><y>#</y><d>2016-10-05</d><h>15:48</h><w>jeroenvandijk</w>When I read this <a href="http://stackoverflow.com/questions/30391809/what-is-bulkhead-pattern-used-by-hystrix" target="_blank">http://stackoverflow.com/questions/30391809/what-is-bulkhead-pattern-used-by-hystrix</a> I‚Äôm guessing that a semaphore (control the number of concurrent requests) and an executor with a maximum of threads would be equivalent</z><z id="t1475682538" t="lmergen it‚Äôs important to realise that the problem that‚Äôs being solved is that of thread starvation in one place"><y>#</y><d>2016-10-05</d><h>15:48</h><w>lmergen</w>it‚Äôs important to realise that the problem that‚Äôs being solved is that of thread starvation in one place</z><z id="t1475682576" t="lmergen if you do not allocate at least one thread to each ‚Äúcomponent‚Äù, you still face the problem that all your threads might be hanging in another place"><y>#</y><d>2016-10-05</d><h>15:49</h><w>lmergen</w>if you do not allocate at least one thread to each ‚Äúcomponent‚Äù, you still face the problem that all your threads might be hanging in another place</z><z id="t1475682651" t="lmergen so this would not solve the deadlocking issue that is solved with bulkheads"><y>#</y><d>2016-10-05</d><h>15:50</h><w>lmergen</w>so this would not solve the deadlocking issue that is solved with bulkheads</z><z id="t1475682984" t="jeroenvandijk Ok I think i‚Äôm just unfamiliar with the particular use case or I haven‚Äôt faced the issue yet. Do you have an example somewhere of an event like this?"><y>#</y><d>2016-10-05</d><h>15:56</h><w>jeroenvandijk</w>Ok I think i‚Äôm just unfamiliar with the particular use case or I haven‚Äôt faced the issue yet. Do you have an example somewhere of an event like this?</z><z id="t1475683189" t="jeroenvandijk For example, the stackoverflow says that a semaphore approach cannot timeout requests and a thread approach can. I don‚Äôt think i understand why the semaphore approach wouldn‚Äôt allow that"><y>#</y><d>2016-10-05</d><h>15:59</h><w>jeroenvandijk</w>For example, the stackoverflow says that a semaphore approach cannot timeout requests and a thread approach can. I don‚Äôt think i understand why the semaphore approach wouldn‚Äôt allow that</z><z id="t1475683306" t="jeroenvandijk In previous efforts I found that a thread can also not be cleaned up cleanly in all cases. Which means that if your underlying code is faulty it doesn‚Äôt really matter how you wrap it. I hope to be proven wrong though"><y>#</y><d>2016-10-05</d><h>16:01</h><w>jeroenvandijk</w>In previous efforts I found that a thread can also not be cleaned up cleanly in all cases. Which means that if your underlying code is faulty it doesn‚Äôt really matter how you wrap it. I hope to be proven wrong though</z><z id="t1475684971" t="lmergen Consider the case where all your threads are blocked in some HTTP request. Indirectly, however, that request is issueing another request on your server, and is actually blocked on that"><y>#</y><d>2016-10-05</d><h>16:29</h><w>lmergen</w>Consider the case where all your threads are blocked in some HTTP request. Indirectly, however, that request is issueing another request on your server, and is actually blocked on that</z><z id="t1475684999" t="lmergen Then you have a deadlock purely because there is no thread available to handle that other request"><y>#</y><d>2016-10-05</d><h>16:29</h><w>lmergen</w>Then you have a deadlock purely because there is no thread available to handle that other request</z><z id="t1475686996" t="jeroenvandijk hmm i think i see what you mean. So that extra thread would keep an eye on timeouts I guess? I mean without timeouts this situation would be unsolvable, right? I&apos;ll think about it a bit more. I guess my application is a lot more simple and doesn‚Äôt have these deadlock situation AFAIK"><y>#</y><d>2016-10-05</d><h>17:03</h><w>jeroenvandijk</w>hmm i think i see what you mean. So that extra thread would keep an eye on timeouts I guess? I mean without timeouts this situation would be unsolvable, right? I&apos;ll think about it a bit more. I guess my application is a lot more simple and doesn‚Äôt have these deadlock situation AFAIK</z><z id="t1475687662" t="lmergen Well it&apos;s meant to solve a specific type of failure scenario. It is comparable to a deadlock"><y>#</y><d>2016-10-05</d><h>17:14</h><w>lmergen</w>Well it&apos;s meant to solve a specific type of failure scenario. It is comparable to a deadlock</z><z id="t1475687672" t="lmergen However, it is distributed "><y>#</y><d>2016-10-05</d><h>17:14</h><w>lmergen</w>However, it is distributed </z><z id="t1475687767" t="lmergen I do want to say that using a semaphore does not solve the issue we&apos;re describing here, unless your total number of threads is more than your all your semaphore limits together"><y>#</y><d>2016-10-05</d><h>17:16</h><w>lmergen</w>I do want to say that using a semaphore does not solve the issue we&apos;re describing here, unless your total number of threads is more than your all your  semaphore limits together</z><z id="t1475687953" t="jeroenvandijk Hmm yeah i think that‚Äôs true. The thing i‚Äôm missing is how this would be 100% prevented with a thread based approach. If you have a threadpool you have the same issue, right? Only being able to create a new thread would circumvent this I guess"><y>#</y><d>2016-10-05</d><h>17:19</h><w>jeroenvandijk</w>Hmm yeah i think that‚Äôs true. The thing i‚Äôm missing is how this would be 100% prevented with a thread based approach. If you have a threadpool you have the same issue, right? Only being able to create a new thread would circumvent this I guess</z><z id="t1475688079" t="jeroenvandijk But I don‚Äôt think I have this deadlock scenario in my application. Maybe i‚Äôm ignorant or maybe I just work on a less complex system"><y>#</y><d>2016-10-05</d><h>17:21</h><w>jeroenvandijk</w>But I don‚Äôt think I have this deadlock scenario in my application. Maybe i‚Äôm ignorant or maybe I just work on a less complex system</z><z id="t1475688162" t="jeroenvandijk I would love the chat about some more later as you do seem to have this problem. Maybe can also help validating the hystrix clone üôÇ"><y>#</y><d>2016-10-05</d><h>17:22</h><w>jeroenvandijk</w>I would love the chat about some more later as you do seem to have this problem. Maybe can also help validating the hystrix clone <b>üôÇ</b></z><z id="t1475688514" t="lmergen Well you can always come by if you&apos;re in Amsterdam. These things are fascinating and difficult to get right. "><y>#</y><d>2016-10-05</d><h>17:28</h><w>lmergen</w>Well you can always come by if you&apos;re in Amsterdam. These things are fascinating and difficult to get right. </z><z id="t1475688570" t="lmergen https://johnragan.wordpress.com/2009/12/08/release-it-stability-patterns-and-best-practices/"><y>#</y><d>2016-10-05</d><h>17:29</h><w>lmergen</w><a href="https://johnragan.wordpress.com/2009/12/08/release-it-stability-patterns-and-best-practices/" target="_blank">https://johnragan.wordpress.com/2009/12/08/release-it-stability-patterns-and-best-practices/</a></z><z id="t1475688598" t="lmergen that book, Release It! is where bulkheads, circuit breakers etc are first described, btw"><y>#</y><d>2016-10-05</d><h>17:29</h><w>lmergen</w>that book, Release It! is where bulkheads, circuit breakers etc are first described, btw</z><z id="t1475688700" t="jeroenvandijk Yeah I guess it‚Äôs time to start reading it and stop being ignorant üò¨"><y>#</y><d>2016-10-05</d><h>17:31</h><w>jeroenvandijk</w>Yeah I guess it‚Äôs time to start reading it and stop being ignorant <b>üò¨</b></z><z id="t1475688859" t="jeroenvandijk I‚Äôll visit the next Clojure meetup, I see it‚Äôs next wednesday. Maybe we can meet there too"><y>#</y><d>2016-10-05</d><h>17:34</h><w>jeroenvandijk</w>I‚Äôll visit the next Clojure meetup, I see it‚Äôs next wednesday. Maybe we can meet there too</z><z id="t1475688879" t="jeroenvandijk Have to run. Will post new results/questions here later üôÇ"><y>#</y><d>2016-10-05</d><h>17:34</h><w>jeroenvandijk</w>Have to run. Will post new results/questions here later <b>üôÇ</b></z><z id="t1475688890" t="jeroenvandijk Thanks for all the help"><y>#</y><d>2016-10-05</d><h>17:34</h><w>jeroenvandijk</w>Thanks for all the help</z><z id="t1475688988" t="dm3 it seems in general bulkheads are hard to achieve on the JVM"><y>#</y><d>2016-10-05</d><h>17:36</h><w>dm3</w>it seems in general bulkheads are hard to achieve on the JVM</z><z id="t1475689031" t="dm3 if you have a runtime like Erlang&apos;s, your process just dies and restarts fresh"><y>#</y><d>2016-10-05</d><h>17:37</h><w>dm3</w>if you have a runtime like Erlang&apos;s, your process just dies and restarts fresh</z><z id="t1475689040" t="dm3 independent of others"><y>#</y><d>2016-10-05</d><h>17:37</h><w>dm3</w>independent of others</z><z id="t1475689138" t="lmergen [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] : so you could pretty much say that bulkheads are necessary because of the JVM"><y>#</y><d>2016-10-05</d><h>17:38</h><w>lmergen</w><a>@dm3</a>: so you could pretty much say that bulkheads are necessary because of the JVM</z><z id="t1475689182" t="lmergen basically, bulkheads are indirectly part of erlang&apos;s actor architecture, which in turn is stolen from CSP"><y>#</y><d>2016-10-05</d><h>17:39</h><w>lmergen</w>basically, bulkheads are indirectly part of erlang&apos;s actor architecture, which in turn is stolen from CSP</z><z id="t1475689203" t="lmergen in other words, people have once again already figured all this out in the 60s :)"><y>#</y><d>2016-10-05</d><h>17:40</h><w>lmergen</w>in other words, people have once again already figured all this out in the 60s :)</z><z id="t1475689222" t="dm3 I think it&apos;s a property of runtime, no?"><y>#</y><d>2016-10-05</d><h>17:40</h><w>dm3</w>I think it&apos;s a property of runtime, no?</z><z id="t1475689236" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] : would be awesome, I&apos;ll probably be there!"><y>#</y><d>2016-10-05</d><h>17:40</h><w>lmergen</w><a>@jeroenvandijk</a>: would be awesome, I&apos;ll probably be there!</z><z id="t1475689256" t="lmergen [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] : it&apos;s a property of the concurrency model "><y>#</y><d>2016-10-05</d><h>17:40</h><w>lmergen</w><a>@dm3</a>: it&apos;s a property of the concurrency model </z><z id="t1475689596" t="dm3 hm, so you are saying core.async enables easy bulkheads? I uess I don&apos;t really understand what you mean by those"><y>#</y><d>2016-10-05</d><h>17:46</h><w>dm3</w>hm, so you are saying core.async enables easy bulkheads? I uess I don&apos;t really understand what you mean by those</z><z id="t1475689799" t="lmergen maybe, i&apos;m not very familiar with core.async, but as far as I&apos;m aware it shares a thread pool between actors, right ?"><y>#</y><d>2016-10-05</d><h>17:49</h><w>lmergen</w>maybe, i&apos;m not very familiar with core.async, but as far as I&apos;m aware it shares a thread pool between actors, right ?</z><z id="t1475689827" t="lmergen anyway, you pretty much just want one threadpool (or thread) per actor"><y>#</y><d>2016-10-05</d><h>17:50</h><w>lmergen</w>anyway, you pretty much just want one threadpool (or thread) per actor</z><z id="t1475689939" t="dm3 well, core.async is an implementation of CSP ideas"><y>#</y><d>2016-10-05</d><h>17:52</h><w>dm3</w>well, core.async is an implementation of CSP ideas</z><z id="t1475689981" t="dm3 I guess a programming model + a proper runtime makes a robust system"><y>#</y><d>2016-10-05</d><h>17:53</h><w>dm3</w>I guess a programming model + a proper runtime makes a robust system</z><z id="t1475689999" t="dm3 you have natural bulkheads and the ability to fail fast"><y>#</y><d>2016-10-05</d><h>17:53</h><w>dm3</w>you have natural bulkheads and the ability to fail fast</z><z id="t1475690017" t="dm3 in erlang"><y>#</y><d>2016-10-05</d><h>17:53</h><w>dm3</w>in erlang</z><z id="t1475690149" t="lmergen yes, but if focuses mostly on abstractions of CSP"><y>#</y><d>2016-10-05</d><h>17:55</h><w>lmergen</w>yes, but if focuses mostly on abstractions of CSP</z><z id="t1475690188" t="lmergen it&apos;s not pure CSP, probably because of the ease of use"><y>#</y><d>2016-10-05</d><h>17:56</h><w>lmergen</w>it&apos;s not pure CSP, probably because of the ease of use</z><z id="t1475740728" t="jeroenvandijk I‚Äôve done some catching up with reading. I think i understand the idea behind bulkheads now üôÇ"><y>#</y><d>2016-10-06</d><h>07:58</h><w>jeroenvandijk</w>I‚Äôve done some catching up with reading. I think i understand the idea behind bulkheads now <b>üôÇ</b></z><z id="t1475740749" t="jeroenvandijk i think both core.async and manifold are suitable as they both allow you to run things on dedicated threadpools"><y>#</y><d>2016-10-06</d><h>07:59</h><w>jeroenvandijk</w>i think both core.async and manifold are suitable as they both allow you to run things on dedicated threadpools</z><z id="t1475740809" t="jeroenvandijk I don‚Äôt think erlang is supporting the bulkheads out of the box. As the actors itself might restart, but with erlang you can also have actors in a distributed deadlock if you are not careful"><y>#</y><d>2016-10-06</d><h>08:00</h><w>jeroenvandijk</w>I don‚Äôt think erlang is supporting the bulkheads out of the box. As the actors itself might restart, but with erlang you can also have actors in a distributed deadlock if you are not careful</z><z id="t1475741063" t="dm3 I guess I don&apos;t see how you can implement the &quot;generic&quot; bulkheads - don&apos;t find the definition that useful"><y>#</y><d>2016-10-06</d><h>08:04</h><w>dm3</w>I guess I don&apos;t see how you can implement the &quot;generic&quot; bulkheads - don&apos;t find the definition that useful</z><z id="t1475741146" t="jeroenvandijk if by generic you mean can never fail, I agree I don‚Äôt see how you can implement that either"><y>#</y><d>2016-10-06</d><h>08:05</h><w>jeroenvandijk</w>if by generic you  mean can never fail, I agree I don‚Äôt see how you can implement that either</z><z id="t1475741162" t="dm3 in Hystrix a bulkhead just limits the amount of concurrent calls to the component"><y>#</y><d>2016-10-06</d><h>08:06</h><w>dm3</w>in Hystrix a bulkhead just limits the amount of concurrent calls to the component</z><z id="t1475741238" t="lmergen i thought in Hystrix you had a thread (pool) per component ?"><y>#</y><d>2016-10-06</d><h>08:07</h><w>lmergen</w>i thought in Hystrix you had a thread (pool) per component ?</z><z id="t1475741272" t="dm3 that&apos;s one way to limit the amount of calls"><y>#</y><d>2016-10-06</d><h>08:07</h><w>dm3</w>that&apos;s one way to limit the amount of calls</z><z id="t1475741277" t="dm3 the other is using semaphores"><y>#</y><d>2016-10-06</d><h>08:07</h><w>dm3</w>the other is using semaphores</z><z id="t1475741327" t="dm3 anyway, I don&apos;t see it as an implementable pattern, but rather an implementation approach in a more general sense"><y>#</y><d>2016-10-06</d><h>08:08</h><w>dm3</w>anyway, I don&apos;t see it as an implementable pattern, but rather an implementation approach in a more general sense</z><z id="t1475741343" t="dm3 but this obviously depends on what you take as the definition"><y>#</y><d>2016-10-06</d><h>08:09</h><w>dm3</w>but this obviously depends on what you take as the definition</z><z id="t1475741372" t="jeroenvandijk this book, preview, original probably better, has some useful context too https://www.nginx.com/wp-content/uploads/2015/01/Building_Microservices_Nginx.pdf"><y>#</y><d>2016-10-06</d><h>08:09</h><w>jeroenvandijk</w>this book, preview, original probably better, has some useful context too <a href="https://www.nginx.com/wp-content/uploads/2015/01/Building_Microservices_Nginx.pdf" target="_blank">https://www.nginx.com/wp-content/uploads/2015/01/Building_Microservices_Nginx.pdf</a></z><z id="t1475741435" t="jeroenvandijk But we don‚Äôt really do microservice or SOA so most of the things do not apply to my application. Though general principles, especially in the Nygard book are useful as a rule of thumb to prevent cascading failures"><y>#</y><d>2016-10-06</d><h>08:10</h><w>jeroenvandijk</w>But we don‚Äôt really do microservice or SOA so most of the things do not apply to my application. Though general principles, especially in the Nygard book are useful as a rule of thumb to prevent cascading failures</z><z id="t1475741510" t="jeroenvandijk What I find appealing at Hystrix at the moment is it‚Äôs out of the box monitoring and latency control. And because I don‚Äôt want to be trapped in a Java like architecture and I want some custom controls I‚Äôm trying to build my own version"><y>#</y><d>2016-10-06</d><h>08:11</h><w>jeroenvandijk</w>What I find appealing at Hystrix at the moment is it‚Äôs out of the box monitoring and latency control. And because I don‚Äôt want to be trapped in a Java like architecture and I want some custom controls I‚Äôm trying to build my own version</z><z id="t1475741621" t="jeroenvandijk I‚Äôm planning to use this for latency control too (if I get a patch in): https://github.com/ztellman/aleph/issues/273"><y>#</y><d>2016-10-06</d><h>08:13</h><w>jeroenvandijk</w>I‚Äôm planning to use this for latency control too (if I get a patch in): <a href="https://github.com/ztellman/aleph/issues/273" target="_blank">https://github.com/ztellman/aleph/issues/273</a></z><z id="t1475741635" t="jeroenvandijk We had some queueing issues üôÇ"><y>#</y><d>2016-10-06</d><h>08:13</h><w>jeroenvandijk</w>We had some queueing issues <b>üôÇ</b></z><z id="t1475741743" t="dm3 did you try using executor stats?"><y>#</y><d>2016-10-06</d><h>08:15</h><w>dm3</w>did you try using executor stats?</z><z id="t1475741776" t="jeroenvandijk no I didn‚Äôt know about those before. However, i think those are aggregates? I need to know on a per request level"><y>#</y><d>2016-10-06</d><h>08:16</h><w>jeroenvandijk</w>no I didn‚Äôt know about those before. However, i think those are aggregates? I need to know on a per request level</z><z id="t1475741809" t="dm3 yeah, those will be aggregate"><y>#</y><d>2016-10-06</d><h>08:16</h><w>dm3</w>yeah, those will be aggregate</z><z id="t1475741832" t="dm3 hm"><y>#</y><d>2016-10-06</d><h>08:17</h><w>dm3</w>hm</z><z id="t1475741834" t="jeroenvandijk Since we have only 100ms or so, if you are already waiting for 75ms it might not be worth it to continue to take the offering into account"><y>#</y><d>2016-10-06</d><h>08:17</h><w>jeroenvandijk</w>Since we have only 100ms or so, if you are already waiting for 75ms it might not be worth it to continue to take the offering into account</z><z id="t1475741871" t="dm3 https://github.com/ztellman/dirigiste/blob/master/src/io/aleph/dirigiste/Stats.java"><y>#</y><d>2016-10-06</d><h>08:17</h><w>dm3</w><a href="https://github.com/ztellman/dirigiste/blob/master/src/io/aleph/dirigiste/Stats.java" target="_blank">https://github.com/ztellman/dirigiste/blob/master/src/io/aleph/dirigiste/Stats.java</a></z><z id="t1475741903" t="dm3 public enum Metric { QUEUE_LENGTH, QUEUE_LATENCY, TASK_LATENCY, TASK_ARRIVAL_RATE, TASK_COMPLETION_RATE, TASK_REJECTION_RATE, UTILIZATION } what executor gives you"><y>#</y><d>2016-10-06</d><h>08:18</h><w>dm3</w><pre>public enum Metric {
        QUEUE_LENGTH,
        QUEUE_LATENCY,
        TASK_LATENCY,
        TASK_ARRIVAL_RATE,
        TASK_COMPLETION_RATE,
        TASK_REJECTION_RATE,
        UTILIZATION
    }
</pre>
what executor gives you</z><z id="t1475741937" t="jeroenvandijk Thanks, looks useful to add to our monitoring as well"><y>#</y><d>2016-10-06</d><h>08:18</h><w>jeroenvandijk</w>Thanks, looks useful to add to our monitoring as well</z><z id="t1475748945" t="jeroenvandijk How do you handle errors in a websocket/sse stream? I have an error somewhere and cannot find it easily. I would like to wrap the stream with some error logging. manifold.deferred/catch doesn‚Äôt seem to work in this case"><y>#</y><d>2016-10-06</d><h>10:15</h><w>jeroenvandijk</w>How do you handle errors in a websocket/sse stream? I have an error somewhere and cannot find it easily. I would like to wrap the stream with some error logging. <code>manifold.deferred/catch</code> doesn‚Äôt seem to work in this case</z><z id="t1475748996" t="dm3 hehe"><y>#</y><d>2016-10-06</d><h>10:16</h><w>dm3</w>hehe</z><z id="t1475749015" t="dm3 https://github.com/ztellman/manifold/issues/95"><y>#</y><d>2016-10-06</d><h>10:16</h><w>dm3</w><a href="https://github.com/ztellman/manifold/issues/95" target="_blank">https://github.com/ztellman/manifold/issues/95</a></z><z id="t1475749170" t="jeroenvandijk ah thanks"><y>#</y><d>2016-10-06</d><h>10:19</h><w>jeroenvandijk</w>ah thanks</z><z id="t1475749180" t="jeroenvandijk thought already i misunderstood the examples"><y>#</y><d>2016-10-06</d><h>10:19</h><w>jeroenvandijk</w>thought already i misunderstood the examples</z><z id="t1475749452" t="jeroenvandijk from some manually testing it seams you have to wrap the put! call with error handling. Hmm will test a bit more"><y>#</y><d>2016-10-06</d><h>10:24</h><w>jeroenvandijk</w>from some manually testing it seams you have to wrap the <code>put!</code> call with error handling. Hmm will test a bit more</z><z id="t1475749733" t="dm3 there&apos;s a bunch of cases where an error can happen inside some callback and the stream gets closed + the error gets logged"><y>#</y><d>2016-10-06</d><h>10:28</h><w>dm3</w>there&apos;s a bunch of cases where an error can happen inside some callback and the stream gets closed + the error gets logged</z><z id="t1475749743" t="dm3 you can&apos;t get the error in any way"><y>#</y><d>2016-10-06</d><h>10:29</h><w>dm3</w>you can&apos;t get the error in any way</z><z id="t1475749772" t="dm3 like the consume example"><y>#</y><d>2016-10-06</d><h>10:29</h><w>dm3</w>like the <code>consume</code> example</z><z id="t1475749781" t="dm3 or zip"><y>#</y><d>2016-10-06</d><h>10:29</h><w>dm3</w>or <code>zip</code></z><z id="t1475749800" t="dm3 hm, maybe not zip exactly, as it can&apos;t really fail"><y>#</y><d>2016-10-06</d><h>10:30</h><w>dm3</w>hm, maybe not <code>zip</code> exactly, as it can&apos;t really fail</z><z id="t1475749815" t="dm3 if your xform throws"><y>#</y><d>2016-10-06</d><h>10:30</h><w>dm3</w>if your <code>xform</code> throws</z><z id="t1475751897" t="jeroenvandijk in this case I would be happy with a log, but haven&apos;t seen that either"><y>#</y><d>2016-10-06</d><h>11:04</h><w>jeroenvandijk</w>in this case I would be happy with a log, but haven&apos;t seen that either</z><z id="t1475751920" t="jeroenvandijk i‚Äôm actually not sure what happens"><y>#</y><d>2016-10-06</d><h>11:05</h><w>jeroenvandijk</w>i‚Äôm actually not sure what happens</z><z id="t1475752322" t="jeroenvandijk ah yes configuring logging correctly helps üôÇ"><y>#</y><d>2016-10-06</d><h>11:12</h><w>jeroenvandijk</w>ah yes configuring logging correctly helps <b>üôÇ</b></z><z id="t1475752832" t="jeroenvandijk Would be nice though to have some way to control where the exception goes when the unexpected happens"><y>#</y><d>2016-10-06</d><h>11:20</h><w>jeroenvandijk</w>Would be nice though to have some way to control where the exception goes when the unexpected happens</z><z id="t1475752955" t="dm3 you can upvote the issue üôÇ"><y>#</y><d>2016-10-06</d><h>11:22</h><w>dm3</w>you can upvote the issue <b>üôÇ</b></z><z id="t1475752978" t="dm3 even better, write your experiences"><y>#</y><d>2016-10-06</d><h>11:22</h><w>dm3</w>even better, write your experiences</z><z id="t1475756675" t="jeroenvandijk done https://github.com/ztellman/manifold/issues/95#issuecomment-251946186 üôÇ"><y>#</y><d>2016-10-06</d><h>12:24</h><w>jeroenvandijk</w>done <a href="https://github.com/ztellman/manifold/issues/95#issuecomment-251946186" target="_blank">https://github.com/ztellman/manifold/issues/95#issuecomment-251946186</a> <b>üôÇ</b></z><z id="t1475757754" t="lmergen exception management and async is always a gnarly issue. i think in manifold‚Äôs case, simply modularizing an error handler would be good enough indeed"><y>#</y><d>2016-10-06</d><h>12:42</h><w>lmergen</w>exception management and async is always a gnarly issue. i think in manifold‚Äôs case, simply modularizing an error handler would be good enough indeed</z><z id="t1475757986" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] i found out yesterday that next week‚Äôs meetup is going to be about onyx, so that‚Äôs gonna be interesting!"><y>#</y><d>2016-10-06</d><h>12:46</h><w>lmergen</w><a>@jeroenvandijk</a> i found out yesterday that next week‚Äôs meetup is going to be about onyx, so that‚Äôs gonna be interesting!</z><z id="t1475758059" t="jeroenvandijk Yes indeed üôÇ"><y>#</y><d>2016-10-06</d><h>12:47</h><w>jeroenvandijk</w>Yes indeed <b>üôÇ</b></z><z id="t1475758073" t="jeroenvandijk We are using it pre-production. What about you?"><y>#</y><d>2016-10-06</d><h>12:47</h><w>jeroenvandijk</w>We are using it pre-production. What about you?</z><z id="t1475758711" t="lmergen i haven‚Äôt been able to find a good enough reason to use it üòï"><y>#</y><d>2016-10-06</d><h>12:58</h><w>lmergen</w>i haven‚Äôt been able to find a good enough reason to use it <b>üòï</b></z><z id="t1475758742" t="lmergen we‚Äôre mostly focused on AWS, and as such use Redshift for our data warehouse, and for the more complex processing we use Spark"><y>#</y><d>2016-10-06</d><h>12:59</h><w>lmergen</w>we‚Äôre mostly focused on AWS, and as such use Redshift for our data warehouse, and for the more complex processing we use Spark</z><z id="t1475758746" t="lmergen both hosted by AWS"><y>#</y><d>2016-10-06</d><h>12:59</h><w>lmergen</w>both hosted by AWS</z><z id="t1475759017" t="jeroenvandijk How do you get the data to S3/Redshift?"><y>#</y><d>2016-10-06</d><h>13:03</h><w>jeroenvandijk</w>How do you get the data to S3/Redshift?</z><z id="t1475759066" t="jeroenvandijk We use it to move data from our bidder cluster via kafka to s3 and other services"><y>#</y><d>2016-10-06</d><h>13:04</h><w>jeroenvandijk</w>We use it to move data from our bidder cluster via kafka to s3 and other services</z><z id="t1475759101" t="jeroenvandijk But it‚Äôs quite complicated and i wouldn‚Äôt recommend it if you have something simple working"><y>#</y><d>2016-10-06</d><h>13:05</h><w>jeroenvandijk</w>But it‚Äôs quite complicated and i wouldn‚Äôt recommend it if you have something simple working</z><z id="t1475759111" t="lmergen we use Kinesis Firehose"><y>#</y><d>2016-10-06</d><h>13:05</h><w>lmergen</w>we use Kinesis Firehose</z><z id="t1475759114" t="lmergen which is like kafka"><y>#</y><d>2016-10-06</d><h>13:05</h><w>lmergen</w>which is like kafka</z><z id="t1475759132" t="jeroenvandijk ah i see, so they manage the connection to Redshift i guess"><y>#</y><d>2016-10-06</d><h>13:05</h><w>jeroenvandijk</w>ah i see, so they manage the connection to Redshift i guess</z><z id="t1475759135" t="jeroenvandijk sounds good"><y>#</y><d>2016-10-06</d><h>13:05</h><w>jeroenvandijk</w>sounds good</z><z id="t1475759144" t="jeroenvandijk we need to send data to other services too"><y>#</y><d>2016-10-06</d><h>13:05</h><w>jeroenvandijk</w>we need to send data to other services too</z><z id="t1475759175" t="lmergen yes, basically it caches on S3 until it reaches a certain threshold (every 900 seconds or 64MB is what we use) and then imports it into redshift"><y>#</y><d>2016-10-06</d><h>13:06</h><w>lmergen</w>yes, basically it caches on S3 until it reaches a certain threshold (every 900 seconds or 64MB is what we use) and then imports it into redshift</z><z id="t1475759244" t="jeroenvandijk I would like to try Redshift too on our data"><y>#</y><d>2016-10-06</d><h>13:07</h><w>jeroenvandijk</w>I would like to try Redshift too on our data</z><z id="t1475759251" t="lmergen we then use AWS DataPipeline to query redshift"><y>#</y><d>2016-10-06</d><h>13:07</h><w>lmergen</w>we then use AWS DataPipeline to query redshift</z><z id="t1475759260" t="lmergen in fact, i don‚Äôt think anyone ever directly connects to redshift üôÇ"><y>#</y><d>2016-10-06</d><h>13:07</h><w>lmergen</w>in fact, i don‚Äôt think anyone ever directly connects to redshift <b>üôÇ</b></z></g><g id="s1"><z id="t1475759265" t="lmergen (over here in our org)"><y>#</y><d>2016-10-06</d><h>13:07</h><w>lmergen</w>(over here in our org)</z><z id="t1475759275" t="jeroenvandijk no? not through a jdbc connection?"><y>#</y><d>2016-10-06</d><h>13:07</h><w>jeroenvandijk</w>no? not through a jdbc connection?</z><z id="t1475759289" t="lmergen nop"><y>#</y><d>2016-10-06</d><h>13:08</h><w>lmergen</w>nop</z><z id="t1475759313" t="jeroenvandijk i hope to be able to have a SQL interface on our data via either redshift, drill or bigquery sometime"><y>#</y><d>2016-10-06</d><h>13:08</h><w>jeroenvandijk</w>i hope to be able to have a SQL interface on our data via either redshift, drill or bigquery sometime</z><z id="t1475759347" t="lmergen https://aws.amazon.com/blogs/aws/autheos-at-the-nexus-of-marketing-and-e-commerce/"><y>#</y><d>2016-10-06</d><h>13:09</h><w>lmergen</w><a href="https://aws.amazon.com/blogs/aws/autheos-at-the-nexus-of-marketing-and-e-commerce/" target="_blank">https://aws.amazon.com/blogs/aws/autheos-at-the-nexus-of-marketing-and-e-commerce/</a></z><z id="t1475759359" t="lmergen that was an article i wrote 6 months ago about our architecture"><y>#</y><d>2016-10-06</d><h>13:09</h><w>lmergen</w>that was an article i wrote 6 months ago about our architecture</z><z id="t1475759380" t="lmergen it‚Äôs pretty interesting how much you can do with the cloud nowadays"><y>#</y><d>2016-10-06</d><h>13:09</h><w>lmergen</w>it‚Äôs pretty interesting how much you can do with the cloud nowadays</z><z id="t1475759565" t="jeroenvandijk nice featured post üòé"><y>#</y><d>2016-10-06</d><h>13:12</h><w>jeroenvandijk</w>nice featured post <b>üòé</b></z><z id="t1475759623" t="dm3 that&apos;s interesting"><y>#</y><d>2016-10-06</d><h>13:13</h><w>dm3</w>that&apos;s interesting</z><z id="t1475759751" t="jeroenvandijk i wouldn‚Äôt mind getting rid of kafka if something with similar performance would be offered on AWS, but i think kinesis is still a bit different. But it is amazing how well it all scales"><y>#</y><d>2016-10-06</d><h>13:15</h><w>jeroenvandijk</w>i wouldn‚Äôt mind getting rid of kafka if something with similar performance would be offered on AWS, but i think kinesis is still a bit different. But it is amazing how well it all scales</z><z id="t1475759787" t="lmergen it‚Äôs fascinating indeed"><y>#</y><d>2016-10-06</d><h>13:16</h><w>lmergen</w>it‚Äôs fascinating indeed</z><z id="t1475759821" t="lmergen AWS is good for the start when your do not (yet) need very complex configurations, and you‚Äôre not into high volume yet"><y>#</y><d>2016-10-06</d><h>13:17</h><w>lmergen</w>AWS is good for the start when your do not (yet) need very complex configurations, and you‚Äôre not into high volume yet</z><z id="t1475759849" t="lmergen you do have to take into account that ‚Äúeventual consistency‚Äù is very real"><y>#</y><d>2016-10-06</d><h>13:17</h><w>lmergen</w>you do have to take into account that ‚Äúeventual consistency‚Äù is very real</z><z id="t1475759864" t="lmergen especially with things like S3"><y>#</y><d>2016-10-06</d><h>13:17</h><w>lmergen</w>especially with things like S3</z><z id="t1475760181" t="jeroenvandijk yeah and different in some regions too üôÇ"><y>#</y><d>2016-10-06</d><h>13:23</h><w>jeroenvandijk</w>yeah and different in some regions too <b>üôÇ</b></z><z id="t1475760187" t="jeroenvandijk but i think now they have fixed that"><y>#</y><d>2016-10-06</d><h>13:23</h><w>jeroenvandijk</w>but i think now they have fixed that</z><z id="t1475771029" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] : looks very sweet! "><y>#</y><d>2016-10-06</d><h>16:23</h><w>lmergen</w><a>@jeroenvandijk</a>: looks very sweet! </z><z id="t1475839830" t="lmergen would love to have something like that that integrates with existing dashboard tools (like Kibana)"><y>#</y><d>2016-10-07</d><h>11:30</h><w>lmergen</w>would love to have something like that that integrates with existing dashboard tools (like Kibana)</z><z id="t1475855242" t="jeroenvandijk My plan is to make something that is extensible (via subscribing to streams), so i think that should be possible. I already found that the hystrix metrics granularity is not good enough for us so I‚Äôm thinking of other visualizations too. But the hystrix dashboard is a start üôÇ"><y>#</y><d>2016-10-07</d><h>15:47</h><w>jeroenvandijk</w>My plan is to make something that is extensible (via subscribing to streams), so i think that should be possible. I already found that the hystrix metrics granularity is not good enough for us so I‚Äôm thinking of other visualizations too. But the hystrix dashboard is a start <b>üôÇ</b></z><z id="t1475855365" t="jeroenvandijk One thing I would really like is to have a visualisation of latent requests. This visualisation should be able to tell what caused a timeout for instance. This visualisation could be a timeline of calls to nested services"><y>#</y><d>2016-10-07</d><h>15:49</h><w>jeroenvandijk</w>One thing I would really like is to have a visualisation of latent requests. This visualisation should be able to tell what caused a timeout for instance. This visualisation could be a timeline of calls to nested services</z><z id="t1475855419" t="dm3 have you seen the latest Zach talk at strange loop?"><y>#</y><d>2016-10-07</d><h>15:50</h><w>dm3</w>have you seen the latest Zach talk at strange loop?</z><z id="t1475855430" t="jeroenvandijk not sure"><y>#</y><d>2016-10-07</d><h>15:50</h><w>jeroenvandijk</w>not sure</z><z id="t1475855433" t="jeroenvandijk i don‚Äôt think so"><y>#</y><d>2016-10-07</d><h>15:50</h><w>jeroenvandijk</w>i don‚Äôt think so</z><z id="t1475855461" t="dm3 I think they did the same at Fitbit by having an explicit state machine (passport) passed through the code"><y>#</y><d>2016-10-07</d><h>15:51</h><w>dm3</w>I think they did the same at Fitbit by having an explicit state machine (passport) passed through the code</z><z id="t1475855481" t="jeroenvandijk sounds interesting"><y>#</y><d>2016-10-07</d><h>15:51</h><w>jeroenvandijk</w>sounds interesting</z><z id="t1475855487" t="jeroenvandijk is it on youtube already?"><y>#</y><d>2016-10-07</d><h>15:51</h><w>jeroenvandijk</w>is it on youtube already?</z><z id="t1475855490" t="dm3 yeah"><y>#</y><d>2016-10-07</d><h>15:51</h><w>dm3</w>yeah</z><z id="t1475855500" t="jeroenvandijk cool, i‚Äôll have a look"><y>#</y><d>2016-10-07</d><h>15:51</h><w>jeroenvandijk</w>cool, i‚Äôll have a look</z><z id="t1475855664" t="jeroenvandijk found it https://www.youtube.com/watch?v=_1rh_s1WmRA"><y>#</y><d>2016-10-07</d><h>15:54</h><w>jeroenvandijk</w>found it <a href="https://www.youtube.com/watch?v=_1rh_s1WmRA" target="_blank">https://www.youtube.com/watch?v=_1rh_s1WmRA</a></z><z id="t1475855866" t="jeroenvandijk Had a quick glance through it. It has definitely overlap üôÇ"><y>#</y><d>2016-10-07</d><h>15:57</h><w>jeroenvandijk</w>Had a quick glance through it. It has definitely overlap <b>üôÇ</b></z><z id="t1475860133" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] : I think we&apos;re doing something similar. basically all http requests are tagged, recursively, which we can then use for debugging"><y>#</y><d>2016-10-07</d><h>17:08</h><w>lmergen</w><a>@jeroenvandijk</a>: I think we&apos;re doing something similar. basically all http requests are tagged, recursively, which we can then use for debugging</z><z id="t1475860174" t="lmergen so when we know, say, a video upload failed, we can immediately get all the logs related to that initial upload request"><y>#</y><d>2016-10-07</d><h>17:09</h><w>lmergen</w>so when we know, say, a video upload failed, we can immediately get all the logs related to that initial upload request</z><z id="t1475914996" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] sounds cool. How do you tie them all together? Do you have some mutable context object?"><y>#</y><d>2016-10-08</d><h>08:23</h><w>jeroenvandijk</w><a>@lmergen</a> sounds cool. How do you tie them all together? Do you have some mutable context object?</z><z id="t1475924737" t="malcolmsparks I&apos;m looking to do a similar thing with #yada in the medium-term. and Zach&apos;s talk has been very interesting (although I&apos;ve only got half-way, with Zach&apos;s talks I often have to pause and rewind to have time to ponder on his wisdom!)"><y>#</y><d>2016-10-08</d><h>11:05</h><w>malcolmsparks</w>I&apos;m looking to do a similar thing with #yada in the medium-term. and Zach&apos;s talk has been very interesting (although I&apos;ve only got half-way, with Zach&apos;s talks I often have to pause and rewind to have time to ponder on his wisdom!)</z><z id="t1475924885" t="malcolmsparks yada does the same kind of FSM as Zach is talking about, but without the nice per-step error handling (yada uses manifold&apos;s d/chain and a single d/error , although with capturing a passport it would be possible to demultiplex the error handling into something more akin to his design. I guess it would also be possible to build a custom d/chain where each link would have a custom error handler."><y>#</y><d>2016-10-08</d><h>11:08</h><w>malcolmsparks</w>yada does the same kind of FSM as Zach is talking about, but without the nice per-step error handling (yada uses manifold&apos;s <code>d/chain</code> and a single <code>d/error</code>, although with capturing a passport it would be possible to demultiplex the error handling into something more akin to his design. I guess it would also be possible to build a custom <code>d/chain</code> where each link would have a custom error handler.</z><z id="t1475925029" t="malcolmsparks I&apos;ve been planning a &apos;API Gateway&apos; or &apos;API Console&apos; front-end for a year now, which would integrate with metrics-capturing that could. be built into yada - we&apos;ve had some false starts there, but I think the passport idea is the next thing to try, thanks Zach for a nice talk"><y>#</y><d>2016-10-08</d><h>11:10</h><w>malcolmsparks</w>I&apos;ve been planning a &apos;API Gateway&apos; or &apos;API Console&apos; front-end for a year now, which would integrate with metrics-capturing that could. be built into yada - we&apos;ve had some false starts there, but I think the passport idea is the next thing to try, thanks Zach for a nice talk</z><z id="t1476020753" t="andreas-thoelke I everyone! I have a manifold questions: Is there something like core.async/alt! in manifold where I can wait for the next message on either one of several streams, or wait for the first of several deferreds to become resolved?"><y>#</y><d>2016-10-09</d><h>13:45</h><w>andreas-thoelke</w>I everyone! I have a manifold questions: Is there something like <code>core.async/alt!</code> in manifold where I can wait for the next message on either one of several streams, or wait for the first of several deferreds to become resolved?</z><z id="t1476021026" t="dm3 [:attrs {:href &quot;/_/_/users/U07PHRFKR&quot;}] : you can copy it from https://github.com/ztellman/manifold/pull/102/files for now - hasn&apos;t been merged into Manifold yet."><y>#</y><d>2016-10-09</d><h>13:50</h><w>dm3</w><a>@andreas-thoelke</a>: you can copy it from <a href="https://github.com/ztellman/manifold/pull/102/files" target="_blank">https://github.com/ztellman/manifold/pull/102/files</a> for now - hasn&apos;t been merged into Manifold yet.</z><z id="t1476021108" t="andreas-thoelke oh, how convenient, thanks!!"><y>#</y><d>2016-10-09</d><h>13:51</h><w>andreas-thoelke</w>oh, how convenient, thanks!!</z><z id="t1476036898" t="andreas-thoelke [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] thanks for this patch, it works as described. I was hoping though alt would allow me to get similar behavior to core.async/alt! or alts! , however it seems it would have had to somehow cancel the leftover deferred/take! in order to not swallow values like in this example:"><y>#</y><d>2016-10-09</d><h>18:14</h><w>andreas-thoelke</w><a>@dm3</a> thanks for this patch, it works as described. I was hoping though <code>alt</code> would allow me to get similar behavior to <code>core.async/alt!</code> or <code>alts!</code>, however it seems it would have had to somehow cancel the leftover deferred/take! in order to not swallow values like in this example:</z><z id="t1476037631" t="andreas-thoelke It seems the only way to do this in manifold is to merge/connect the two streams into one and then take from this combined stream."><y>#</y><d>2016-10-09</d><h>18:27</h><w>andreas-thoelke</w>It seems the only way to do this in manifold is to merge/connect the two streams into one and then take from this combined stream.</z><z id="t1476038757" t="dm3 that&apos;s the proper way to do that if you need to process all results"><y>#</y><d>2016-10-09</d><h>18:45</h><w>dm3</w>that&apos;s the proper way to do that if you need to process all results</z><z id="t1476038849" t="dm3 alt is more useful if what you have are just the deferreds"><y>#</y><d>2016-10-09</d><h>18:47</h><w>dm3</w><code>alt</code> is more useful if what you have are just the deferreds</z><z id="t1476038911" t="dm3 due to concurrency issues you would never be able to guarantee that only one of the deferreds got processed"><y>#</y><d>2016-10-09</d><h>18:48</h><w>dm3</w>due to concurrency issues you would never be able to guarantee that only one of the deferreds got processed</z><z id="t1476039118" t="dm3 or, in your case, if you do take! , you can&apos;t untake!"><y>#</y><d>2016-10-09</d><h>18:51</h><w>dm3</w>or, in your case, if you do <code>take!</code>, you can&apos;t <code>untake!</code></z><z id="t1476086029" t="andreas-thoelke Thanks [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] this is helpful!"><y>#</y><d>2016-10-10</d><h>07:53</h><w>andreas-thoelke</w>Thanks <a>@dm3</a> this is helpful!</z><z id="t1476089927" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U050CTFRT&quot;}] As far as I can seen what the passport functionality offers, I think I have something simple with manifold that gives the same (and more) options to plot and measure requests. Hope to share soon"><y>#</y><d>2016-10-10</d><h>08:58</h><w>jeroenvandijk</w><a>@malcolmsparks</a> As far as I can seen what the passport functionality offers, I think I have something simple with manifold that gives the same (and more) options to plot and measure requests. Hope to share soon</z><z id="t1476209605" t="bcbradley I&apos;m trying to wrap my head around aleph"><y>#</y><d>2016-10-11</d><h>18:13</h><w>bcbradley</w>I&apos;m trying to wrap my head around aleph</z><z id="t1476209645" t="bcbradley What I&apos;ve surmised so far is that aleph decomplects the order in which you get things from the time in which you get things"><y>#</y><d>2016-10-11</d><h>18:14</h><w>bcbradley</w>What I&apos;ve surmised so far is that aleph decomplects the order in which you get things from the time in which you get things</z><z id="t1476209667" t="bcbradley for instance in a core.async channel you can&apos;t get something until you receive the things that come before it"><y>#</y><d>2016-10-11</d><h>18:14</h><w>bcbradley</w>for instance in a core.async channel you can&apos;t get something until you receive the things that come before it</z><z id="t1476209711" t="bcbradley in Aleph, you can receive references to stuff in the order that you ought to receive them, but the references might be realized in a different order"><y>#</y><d>2016-10-11</d><h>18:15</h><w>bcbradley</w>in Aleph, you can receive references to stuff in the order that you ought to receive them, but the references might be realized in a different order</z><z id="t1476209724" t="bcbradley the third one you got might be available sooner than the first one"><y>#</y><d>2016-10-11</d><h>18:15</h><w>bcbradley</w>the third one you got might be available sooner than the first one</z><z id="t1476209729" t="bcbradley is that about right?"><y>#</y><d>2016-10-11</d><h>18:15</h><w>bcbradley</w>is that about right?</z><z id="t1476221784" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U1ACUMJKX&quot;}] Aleph, actually manifold, to me feels like a mix between core.async and the future and promise primitives of clojure itself. For async operations, you have more flexibility with Manifold than with core.async as that is more macro based and less composable. But the basic principles are more similar than you might think at first. I would recommend reading all the docs in the github repo/website and playing around with the code. At the same time also try to achieve similar things with core.async to get a feel how they are different/the same"><y>#</y><d>2016-10-11</d><h>21:36</h><w>jeroenvandijk</w><a>@bcbradley</a> Aleph, actually manifold,  to me feels like a mix between core.async and the future and promise primitives of clojure itself. For async operations, you have more flexibility with Manifold than with core.async as that is more macro based and less composable. But the basic principles are more similar than you might think at first. I would recommend reading all the docs in the github repo/website and playing around with the code. At the same time also try to achieve similar things with core.async to get a feel how they are different/the same</z><z id="t1476435617" t="elahti I&apos;m using aleph.udp/socket for sendin messages. When receiving messages that have the payload over 2048 characters (json encoded strings), then the payload is chomped to be 2048 characters. Rest of the payload is just dropped."><y>#</y><d>2016-10-14</d><h>09:00</h><w>elahti</w>I&apos;m using aleph.udp/socket for sendin messages. When receiving messages that have the payload over 2048 characters (json encoded strings), then the payload is chomped to be 2048 characters. Rest of the payload is just dropped.</z><z id="t1476435989" t="elahti Is there a way of telling aleph/udp directly that i&apos;d like to have larger payloads/mtu/whatever is limiting the size of the payload?"><y>#</y><d>2016-10-14</d><h>09:06</h><w>elahti</w>Is there a way of telling aleph/udp directly that i&apos;d like to have larger payloads/mtu/whatever is limiting the size of the payload?</z><z id="t1476437116" t="lmergen i‚Äôm pretty sure that aleph allows you to directly pass options to netty when you create servers/sockets"><y>#</y><d>2016-10-14</d><h>09:25</h><w>lmergen</w>i‚Äôm pretty sure that aleph allows you to directly pass options to netty when you create servers/sockets</z><z id="t1476437118" t="lmergen let me see"><y>#</y><d>2016-10-14</d><h>09:25</h><w>lmergen</w>let me see</z><z id="t1476437353" t="elahti yea me too but i wasn&apos;t able to decrypt what and where to"><y>#</y><d>2016-10-14</d><h>09:29</h><w>elahti</w>yea me too but i wasn&apos;t able to decrypt what and where to</z><z id="t1476437524" t="lmergen looks like this is not the case. interesting. you probably are going to have to call netty functions directly"><y>#</y><d>2016-10-14</d><h>09:32</h><w>lmergen</w>looks like this is not the case. interesting. you probably are going to have to call netty functions directly</z><z id="t1476438007" t="dm3 [:attrs {:href &quot;/_/_/users/U0FFEQW2E&quot;}] can this be relevant? http://stackoverflow.com/questions/11525712/why-is-netty-giving-me-only-768-bytes-from-udp-messages"><y>#</y><d>2016-10-14</d><h>09:40</h><w>dm3</w><a>@elahti</a> can this be relevant? <a href="http://stackoverflow.com/questions/11525712/why-is-netty-giving-me-only-768-bytes-from-udp-messages" target="_blank">http://stackoverflow.com/questions/11525712/why-is-netty-giving-me-only-768-bytes-from-udp-messages</a></z><z id="t1476438066" t="elahti what would this do? @(udp/socket {:port port :bootstrap-transform (fn [^Bootstrap bootstrap] (.option bootstrap ChannelOption/SO_RCVBUF 4096) (.option bootstrap ChannelOption/RCVBUF_ALLOCATOR (FixedRecvByteBufAllocator. 4096)))"><y>#</y><d>2016-10-14</d><h>09:41</h><w>elahti</w>what would this do? <pre>@(udp/socket {:port port
              :bootstrap-transform
                    (fn [^Bootstrap bootstrap]
                      (.option bootstrap ChannelOption/SO_RCVBUF 4096)
                      (.option bootstrap ChannelOption/RCVBUF_ALLOCATOR
                               (FixedRecvByteBufAllocator. 4096)))</pre></z><z id="t1476438073" t="elahti oh, crappy formatting, will fix"><y>#</y><d>2016-10-14</d><h>09:41</h><w>elahti</w>oh, crappy formatting, will fix</z><z id="t1476438624" t="dm3 no idea üôÇ"><y>#</y><d>2016-10-14</d><h>09:50</h><w>dm3</w>no idea <b>üôÇ</b></z><z id="t1476438803" t="elahti yea, thanks for help! i&apos;ll tell if it works."><y>#</y><d>2016-10-14</d><h>09:53</h><w>elahti</w>yea, thanks for help! i&apos;ll tell if it works.</z><z id="t1476439787" t="elahti yea it works."><y>#</y><d>2016-10-14</d><h>10:09</h><w>elahti</w>yea it works.</z><z id="t1476439789" t="elahti awesome."><y>#</y><d>2016-10-14</d><h>10:09</h><w>elahti</w>awesome.</z><z id="t1476439830" t="elahti we&apos;re in middle of a game hackathon where we&apos;re developing a game AI with clojure. the messages got over 2048 chars."><y>#</y><d>2016-10-14</d><h>10:10</h><w>elahti</w>we&apos;re in middle of a game hackathon where we&apos;re developing a game AI with clojure. the messages got over 2048 chars.</z><z id="t1476787766" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] I have something to show you regarding the Hystrix clone in Clojure. Would you be interested to review it? It‚Äôs an extraction of something that has been running partially in production without obvious flaws"><y>#</y><d>2016-10-18</d><h>10:49</h><w>jeroenvandijk</w><a>@dm3</a> <a>@lmergen</a> I have something to show you regarding the Hystrix clone in Clojure. Would you be interested to review it? It‚Äôs an extraction of something that has been running partially in production without obvious flaws</z><z id="t1476787784" t="lmergen yes, i would love to take a look!"><y>#</y><d>2016-10-18</d><h>10:49</h><w>lmergen</w>yes, i would love to take a look!</z><z id="t1476787788" t="dm3 sure üôÇ"><y>#</y><d>2016-10-18</d><h>10:49</h><w>dm3</w>sure <b>üôÇ</b></z><z id="t1476789303" t="dm3 btw, would anyone here find a Clojurescript Manifold port useful?"><y>#</y><d>2016-10-18</d><h>11:15</h><w>dm3</w>btw, would anyone here find a Clojurescript Manifold port useful?</z><z id="t1476789434" t="andreas-thoelke Sure, I think this would be great! Cljs support is core.async&apos;s main advantage over Manifold"><y>#</y><d>2016-10-18</d><h>11:17</h><w>andreas-thoelke</w>Sure, I think this would be great! Cljs support is core.async&apos;s main advantage over Manifold</z><z id="t1476789546" t="andreas-thoelke I definitely have async code/patterns that I would like to reuse in the browser or potentially on Node"><y>#</y><d>2016-10-18</d><h>11:19</h><w>andreas-thoelke</w>I definitely have async code/patterns that I would like to reuse in the browser or potentially on Node</z><z id="t1476789550" t="dm3 I&apos;m trying to port the let-flow macro - the hardest part"><y>#</y><d>2016-10-18</d><h>11:19</h><w>dm3</w>I&apos;m trying to port the <code>let-flow</code> macro - the hardest part</z><z id="t1476789565" t="dm3 have everything else pretty much working"><y>#</y><d>2016-10-18</d><h>11:19</h><w>dm3</w>have everything else pretty much working</z><z id="t1476789575" t="andreas-thoelke awesome!"><y>#</y><d>2016-10-18</d><h>11:19</h><w>andreas-thoelke</w>awesome!</z><z id="t1476789771" t="andreas-thoelke I have been trying to avoid let-low and stick to chain and that works up to some point. So I think even a Manifold cljs without let-flow may be very useful."><y>#</y><d>2016-10-18</d><h>11:22</h><w>andreas-thoelke</w>I have been trying to avoid <code>let-low</code> and stick to <code>chain</code> and that works up to some point. So I think even a Manifold cljs without <code>let-flow</code> may be very useful.</z><z id="t1476789838" t="dm3 yeah, I think let-flow is more important in Clojurescript as the concurrency patterns are more limited"><y>#</y><d>2016-10-18</d><h>11:23</h><w>dm3</w>yeah, I think <code>let-flow</code> is more important in Clojurescript as the concurrency patterns are more limited</z><z id="t1476789849" t="dm3 and you compete with go"><y>#</y><d>2016-10-18</d><h>11:24</h><w>dm3</w>and you compete with <code>go</code></z><z id="t1476789870" t="dm3 I don&apos;t use it in Clojure either"><y>#</y><d>2016-10-18</d><h>11:24</h><w>dm3</w>I don&apos;t use it in Clojure either</z><z id="t1476789952" t="andreas-thoelke hmm, you think users will need d/loop a lot in cljs, replacing go-loop ?"><y>#</y><d>2016-10-18</d><h>11:25</h><w>andreas-thoelke</w>hmm, you think users will need <code>d/loop</code> a lot in cljs, replacing <code>go-loop</code>?</z><z id="t1476790012" t="dm3 I have d/loop working"><y>#</y><d>2016-10-18</d><h>11:26</h><w>dm3</w>I have <code>d/loop</code> working</z><z id="t1476790039" t="dm3 yeah, that should replace go-loop"><y>#</y><d>2016-10-18</d><h>11:27</h><w>dm3</w>yeah, that should replace <code>go-loop</code></z><z id="t1476790445" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] I‚Äôve invited you via Github. It is missing some documentation. I think it‚Äôs best to start in examples"><y>#</y><d>2016-10-18</d><h>11:34</h><w>jeroenvandijk</w><a>@dm3</a> <a>@lmergen</a> I‚Äôve invited you via Github. It is missing some documentation. I think it‚Äôs best to start in examples</z><z id="t1476790538" t="dm3 I don&apos;t see anything"><y>#</y><d>2016-10-18</d><h>11:35</h><w>dm3</w>I don&apos;t see anything</z><z id="t1476790725" t="andreas-thoelke [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] .. it will be interesting to see how core.async and Manifold patterns compare in cljs/the browser - and if Manifold could win by having more functional syntax. Also I think it would compete with RxJS ( https://github.com/funcool/beicon ) and https://github.com/funcool/promesa"><y>#</y><d>2016-10-18</d><h>11:38</h><w>andreas-thoelke</w><a>@dm3</a> .. it will be interesting to see how core.async and Manifold patterns compare in cljs/the browser - and if Manifold could win by having more functional syntax. Also I think it would compete with RxJS (<a href="https://github.com/funcool/beicon" target="_blank">https://github.com/funcool/beicon</a>) and <a href="https://github.com/funcool/promesa" target="_blank">https://github.com/funcool/promesa</a></z><z id="t1476790747" t="dm3 yes, it&apos;s much simpler than RxJS"><y>#</y><d>2016-10-18</d><h>11:39</h><w>dm3</w>yes, it&apos;s much simpler than RxJS</z><z id="t1476790753" t="dm3 in terms of concepts at least"><y>#</y><d>2016-10-18</d><h>11:39</h><w>dm3</w>in terms of concepts at least</z><z id="t1476790769" t="andreas-thoelke true"><y>#</y><d>2016-10-18</d><h>11:39</h><w>andreas-thoelke</w>true</z><z id="t1476790930" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] you should have an invitation via email (assuming you are dm3 on github) or you can accept the invitation here https://github.com/millmobile"><y>#</y><d>2016-10-18</d><h>11:42</h><w>jeroenvandijk</w><a>@dm3</a> you should have an invitation via email (assuming you are dm3 on github) or you can accept the invitation here <a href="https://github.com/millmobile" target="_blank">https://github.com/millmobile</a></z><z id="t1476790990" t="andreas-thoelke [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] what type of apps are you planning to use Manifold for in the browser? For general UIs it seems everyone uses Re-frame nowadays - Om also droped core.async .."><y>#</y><d>2016-10-18</d><h>11:43</h><w>andreas-thoelke</w><a>@dm3</a> what type of apps are you planning to use Manifold for in the browser? For general UIs it seems everyone uses Re-frame nowadays - Om also droped core.async ..</z><z id="t1476791073" t="dm3 I use Hoplon üôÇ"><y>#</y><d>2016-10-18</d><h>11:44</h><w>dm3</w>I use Hoplon <b>üôÇ</b></z><z id="t1476791099" t="dm3 I don&apos;t really know where I&apos;d use it. Probably everywhere I used core.async before"><y>#</y><d>2016-10-18</d><h>11:44</h><w>dm3</w>I don&apos;t really know where I&apos;d use it. Probably everywhere I used core.async before</z><z id="t1476791139" t="dm3 which is mostly event buses, web sockets, etc."><y>#</y><d>2016-10-18</d><h>11:45</h><w>dm3</w>which is mostly event buses, web sockets, etc.</z><z id="t1476791160" t="dm3 it&apos;s much less useful in the browser than it is on the backend"><y>#</y><d>2016-10-18</d><h>11:46</h><w>dm3</w>it&apos;s much less useful in the browser than it is on the backend</z><z id="t1476791188" t="andreas-thoelke If you are into reactive programming/Hoplon, have you considered Pulsars Rx namespace?"><y>#</y><d>2016-10-18</d><h>11:46</h><w>andreas-thoelke</w>If you are into reactive programming/Hoplon, have you considered Pulsars Rx namespace?</z><z id="t1476791204" t="jeroenvandijk If you would create manifold.cljs it would allow my Hystrix clone to run in the browser üôÇ"><y>#</y><d>2016-10-18</d><h>11:46</h><w>jeroenvandijk</w>If you would create manifold.cljs it would allow my Hystrix clone to run in the browser <b>üôÇ</b></z><z id="t1476791246" t="jeroenvandijk At least nice for a demo üòâ"><y>#</y><d>2016-10-18</d><h>11:47</h><w>jeroenvandijk</w>At least nice for a demo <b>üòâ</b></z><z id="t1476792963" t="dm3 interesting how you avoided using any java.util.concurrent constructs üôÇ was this on purpose?"><y>#</y><d>2016-10-18</d><h>12:16</h><w>dm3</w>interesting how you avoided using any <code>java.util.concurrent</code> constructs <b>üôÇ</b> was this on purpose?</z><z id="t1476793443" t="jeroenvandijk yes partially I guess. Maybe there are better ways for some parts, please let me know üôÇ But e.g. for the semaphores it was convenient to use a Manifold stream ,because you can increase the semaphore limit dynamically. E.g. with blocking queues this would not be possible (also a limitation of Hystrix itself)"><y>#</y><d>2016-10-18</d><h>12:24</h><w>jeroenvandijk</w>yes partially I guess. Maybe there are better ways for some parts, please let me know <b>üôÇ</b> But e.g. for the semaphores it was convenient to use a Manifold stream ,because you can increase the semaphore limit dynamically. E.g. with blocking queues this would not be possible (also a limitation of Hystrix itself)</z><z id="t1476793493" t="jeroenvandijk I‚Äôve updated the README btw, maybe it gives some extra information"><y>#</y><d>2016-10-18</d><h>12:24</h><w>jeroenvandijk</w>I‚Äôve updated the README btw, maybe it gives some extra information</z><z id="t1476794516" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] sounds great! didn‚Äôt know you were behind AdGoji btw, everything starts to make sense üôÇ"><y>#</y><d>2016-10-18</d><h>12:41</h><w>lmergen</w><a>@jeroenvandijk</a> sounds great! didn‚Äôt know you were behind AdGoji btw, everything starts to make sense <b>üôÇ</b></z><z id="t1476794794" t="jeroenvandijk Cool üôÇ"><y>#</y><d>2016-10-18</d><h>12:46</h><w>jeroenvandijk</w>Cool <b>üôÇ</b></z><z id="t1476794923" t="lmergen looks quite solid actually"><y>#</y><d>2016-10-18</d><h>12:48</h><w>lmergen</w>looks quite solid actually</z><z id="t1476794934" t="lmergen you said it‚Äôs already running in production ?"><y>#</y><d>2016-10-18</d><h>12:48</h><w>lmergen</w>you said it‚Äôs already running in production ?</z><z id="t1476794954" t="lmergen you‚Äôre using it for your RTB i see ?"><y>#</y><d>2016-10-18</d><h>12:49</h><w>lmergen</w>you‚Äôre using it for your RTB i see ?</z><z id="t1476795142" t="jeroenvandijk Yes I have been running it on a single node from time to time. Unfortunately the node is always gone the next day (it could also be some unlucky autoscaling), so I‚Äôm afraid the reporting part leaks somewhere. I haven‚Äôt dug into that yet. I wanted to get the (hystrix) reporting running and basic features first. That alls seems to work fine and also the performance seems to be comparable to what we have running on the other nodes. So needs a bit more testing before I dare to declare it to be stable"><y>#</y><d>2016-10-18</d><h>12:52</h><w>jeroenvandijk</w>Yes I have been running it on a single node from time to time. Unfortunately the node is always gone the next day (it could also be some unlucky autoscaling), so I‚Äôm afraid the reporting part leaks somewhere. I haven‚Äôt dug into that yet. I wanted to get the (hystrix) reporting running and basic features first. That alls seems to work fine and also the performance seems to be comparable to what we have running on the other nodes. So needs a bit more testing before I dare to declare it to be stable</z><z id="t1476795183" t="jeroenvandijk and yes this is running in our bidder code"><y>#</y><d>2016-10-18</d><h>12:53</h><w>jeroenvandijk</w>and yes this is running in our bidder code</z><z id="t1476795191" t="lmergen yeah, i see"><y>#</y><d>2016-10-18</d><h>12:53</h><w>lmergen</w>yeah, i see</z><z id="t1476795197" t="jeroenvandijk the example is slightly different than what is running in production though üôÇ"><y>#</y><d>2016-10-18</d><h>12:53</h><w>jeroenvandijk</w>the example is slightly different than what is running in production though <b>üôÇ</b></z><z id="t1476795199" t="lmergen interesting design choice behind the global registry"><y>#</y><d>2016-10-18</d><h>12:53</h><w>lmergen</w>interesting design choice behind the global registry</z><z id="t1476795219" t="lmergen i‚Äôm not sure whether that‚Äôs the best approach"><y>#</y><d>2016-10-18</d><h>12:53</h><w>lmergen</w>i‚Äôm not sure whether that‚Äôs the best approach</z><z id="t1476795242" t="lmergen oh wait, it‚Äôs on a per-component basis"><y>#</y><d>2016-10-18</d><h>12:54</h><w>lmergen</w>oh wait, it‚Äôs on a per-component basis</z><z id="t1476795361" t="jeroenvandijk yes i guess it is a bit confusing if you look at the code. The idea is that each component is responsible for what is readable and writable. This makes train wrecks less likely and moves the complexity to the components. Maybe it is an overkill for a small library like this"><y>#</y><d>2016-10-18</d><h>12:56</h><w>jeroenvandijk</w>yes i guess it is a bit confusing if you look at the code. The idea is that each component is responsible for what is readable and writable. This makes train wrecks less likely and moves the complexity to the components. Maybe it is an overkill for a small library like this</z><z id="t1476795378" t="lmergen yeah, it‚Äôs good enough i think"><y>#</y><d>2016-10-18</d><h>12:56</h><w>lmergen</w>yeah, it‚Äôs good enough i think</z><z id="t1476795461" t="jeroenvandijk I do think it has more use cases though. Configuration often becomes a hassle to manage"><y>#</y><d>2016-10-18</d><h>12:57</h><w>jeroenvandijk</w>I do think it has more use cases though. Configuration often becomes a hassle to manage</z><z id="t1476795544" t="lmergen yes that‚Äôs true, and this way it integrates well into component"><y>#</y><d>2016-10-18</d><h>12:59</h><w>lmergen</w>yes that‚Äôs true, and this way it integrates well into component</z><z id="t1476795595" t="lmergen for me the biggest concern is that i can easily map such a context to a single endpoint ‚Äî this works in this case"><y>#</y><d>2016-10-18</d><h>12:59</h><w>lmergen</w>for me the biggest concern is that i can easily map such a context to a single endpoint ‚Äî this works in this case</z><z id="t1476795620" t="lmergen the approach i‚Äôve personally been taking was implement this as an aleph.http.client middleware"><y>#</y><d>2016-10-18</d><h>13:00</h><w>lmergen</w>the approach i‚Äôve personally been taking was implement this as an aleph.http.client middleware</z><z id="t1476795715" t="jeroenvandijk Yes I think the rest of the code doesn‚Äôt need to know the configuration is decentralised e.g. if you call registry-snapshot you will get a normal map. Maybe it easier to break code that is depending on it because it so easy to change the location of components this way"><y>#</y><d>2016-10-18</d><h>13:01</h><w>jeroenvandijk</w>Yes I think the rest of the code doesn‚Äôt need to know the configuration is decentralised e.g. if you call registry-snapshot you will get a normal map. Maybe it easier to break code that is depending on it because it so easy to change the location of components this way</z><z id="t1476796293" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] If you want we can discuss more options (e.g. the Kibana idea) also in person and see if there is an option to work on it together"><y>#</y><d>2016-10-18</d><h>13:11</h><w>jeroenvandijk</w><a>@lmergen</a> If you want we can discuss more options (e.g. the Kibana idea) also in person and see if there is an option to work on it together</z><z id="t1476797431" t="lmergen [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] sounds like a great idea! i have quiet a lot of these ‚Äúitches‚Äù i want to scratch and plenty of ideas üôÇ"><y>#</y><d>2016-10-18</d><h>13:30</h><w>lmergen</w><a>@jeroenvandijk</a> sounds like a great idea! i have quiet a lot of these ‚Äúitches‚Äù i want to scratch and plenty of ideas <b>üôÇ</b></z><z id="t1476821636" t="aengelberg Is there a way to do streaming (bulk) uploads with aleph.http ?"><y>#</y><d>2016-10-18</d><h>20:13</h><w>aengelberg</w>Is there a way to do streaming (bulk) uploads with <code>aleph.http</code>?</z><z id="t1476821658" t="aengelberg I know you can pass in :raw-stream? true but that looks like it only works on the response, not the request."><y>#</y><d>2016-10-18</d><h>20:14</h><w>aengelberg</w>I know you can pass in <code>:raw-stream? true</code> but that looks like it only works on the response, not the request.</z><z id="t1476822349" t="aengelberg ah, looks like I can pass in an arbitrary stream coercable via byte-streams"><y>#</y><d>2016-10-18</d><h>20:25</h><w>aengelberg</w>ah, looks like I can pass in an arbitrary stream coercable via <code>byte-streams</code></z><z id="t1476829294" t="dm3 [:attrs {:href &quot;/_/_/users/U07PHRFKR&quot;}] getting back on the Pulsar Rx - no I haven&apos;t used it. I&apos;ve played with Plasar actors though. I&apos;ve never used a proper dataflow impl on the backend yet, although some use cases I had seemed very suitable."><y>#</y><d>2016-10-18</d><h>22:21</h><w>dm3</w><a>@andreas-thoelke</a> getting back on the Pulsar Rx - no I haven&apos;t used it. I&apos;ve played with Plasar actors though. I&apos;ve never used a proper dataflow impl on the backend yet, although some use cases I had seemed very suitable.</z><z id="t1477023746" t="kingoftheknoll Question I hope someone can help with. I‚Äôm new to manifold and I‚Äôm trying to understand how I can attach a filter/transducer to an event bus subscription. I‚Äôm going to try to filter events based on permissions/authorization for each websocket connection. Looking at the manifold.stream/connect function or the subscribe function I‚Äôm not seeing anything there about either transducers or it returning a manifold stream . Thanks!"><y>#</y><d>2016-10-21</d><h>04:22</h><w>kingoftheknoll</w>Question I hope someone can help with. I‚Äôm new to manifold and I‚Äôm trying to understand how I can attach a filter/transducer to an event bus subscription. I‚Äôm going to try to filter events based on permissions/authorization for each websocket connection. Looking at the <code>manifold.stream/connect</code> function or the subscribe function I‚Äôm not seeing anything there about either transducers or it returning a manifold <code>stream</code>. Thanks!</z><z id="t1477025148" t="kingoftheknoll Digging a bit deeper s/connect-via might be what I want"><y>#</y><d>2016-10-21</d><h>04:45</h><w>kingoftheknoll</w>Digging a bit deeper <code>s/connect-via</code> might be what I want</z><z id="t1477029551" t="dm3 s/filter ?"><y>#</y><d>2016-10-21</d><h>05:59</h><w>dm3</w><code>s/filter</code>?</z><z id="t1477034509" t="stijn [:attrs {:href &quot;/_/_/users/U0GNX8ZLL&quot;}] subscribe returns a stream which you can s/transform with a transducer"><y>#</y><d>2016-10-21</d><h>07:21</h><w>stijn</w><a>@kingoftheknoll</a> subscribe returns a stream which you can <code>s/transform</code> with a transducer</z><z id="t1477054834" t="kingoftheknoll [:attrs {:href &quot;/_/_/users/U0539NJF7&quot;}] thanks so much"><y>#</y><d>2016-10-21</d><h>13:00</h><w>kingoftheknoll</w><a>@stijn</a> thanks so much</z><z id="t1477604536" t="jfntn I‚Äôm trying to use aleph in a project that uses datomic but I‚Äôm running into a strange dependency conflict"><y>#</y><d>2016-10-27</d><h>21:42</h><w>jfntn</w>I‚Äôm trying to use aleph in a project that uses datomic but I‚Äôm running into a strange dependency conflict</z><z id="t1477604576" t="jfntn It does not appear in lein deps :tree but there seems to be an issue with datomic -&gt; amq -&gt; netty and alpeh‚Äôs epoll"><y>#</y><d>2016-10-27</d><h>21:42</h><w>jfntn</w>It does not appear in <code>lein deps :tree</code> but there seems to be an issue with datomic -&gt; amq -&gt; netty and alpeh‚Äôs epoll</z><z id="t1477640511" t="dm3 latest datomic conflicts with latest aleph AFAIK"><y>#</y><d>2016-10-28</d><h>07:41</h><w>dm3</w>latest datomic conflicts with latest aleph AFAIK</z><z id="t1477640519" t="dm3 may be outdated info though [:attrs {:href &quot;/_/_/users/U0CJ8PTE1&quot;}] ^"><y>#</y><d>2016-10-28</d><h>07:41</h><w>dm3</w>may be outdated info though <a>@jfntn</a> ^</z><z id="t1477640530" t="dm3 conflict is through the netty dependency"><y>#</y><d>2016-10-28</d><h>07:42</h><w>dm3</w>conflict is through the netty dependency</z><z id="t1478043558" t="kingoftheknoll I‚Äôm working adding permissions to a websocket endpoint and I have a few questions. My goal is to filter messages based on permissions for each connection. Got that part figured out. However, so permissions don‚Äôt become stale I want to use an atom to cache permissions and on some interval refresh the cache for all current connections. So two questions, 1) is there anyway to inspect the subscribers to an event-bus? 2) if not, how can I detect a connection being closed so I don‚Äôt fetch permissions for said user when I do the cache refresh."><y>#</y><d>2016-11-01</d><h>23:39</h><w>kingoftheknoll</w>I‚Äôm working adding permissions to a websocket endpoint and I have a few questions. My goal is to filter messages based on permissions for each connection. Got that part figured out. However, so permissions don‚Äôt become stale I want to use an <code>atom</code> to cache permissions and on some interval refresh the cache for all current connections. So two questions, 1) is there anyway to inspect the subscribers to an event-bus? 2) if not, how can I detect a connection being closed so I don‚Äôt fetch permissions for said user when I do the cache refresh.</z><z id="t1478049389" t="kingoftheknoll Another question, you can s/close! a stream but how can you shut down an event-bus ? Mostly in the context of using Mount/Component in my dev workflom üòÉ"><y>#</y><d>2016-11-02</d><h>01:16</h><w>kingoftheknoll</w>Another question, you can <code>s/close!</code> a stream but how can you shut down an <code>event-bus</code>? Mostly in the context of using Mount/Component in my dev workflom <b>üòÉ</b></z><z id="t1478067337" t="dm3 you can&apos;t shutdown the bus currently. It probably makes sense to raise that as an issue"><y>#</y><d>2016-11-02</d><h>06:15</h><w>dm3</w>you can&apos;t shutdown the bus currently. It probably makes sense to raise that as an issue</z><z id="t1478067363" t="dm3 there&apos;s a bus/snapshot fn to get the current subscribers"><y>#</y><d>2016-11-02</d><h>06:16</h><w>dm3</w>there&apos;s a <code>bus/snapshot</code> fn to get the current subscribers</z><z id="t1478067392" t="dm3 you can also add functions via s/on-closed (sinks) and s/on-drained (sources)"><y>#</y><d>2016-11-02</d><h>06:16</h><w>dm3</w>you can also add functions via <code>s/on-closed</code> (sinks) and <code>s/on-drained</code> (sources)</z><z id="t1478067397" t="dm3 [:attrs {:href &quot;/_/_/users/U0GNX8ZLL&quot;}] ^"><y>#</y><d>2016-11-02</d><h>06:16</h><w>dm3</w><a>@kingoftheknoll</a> ^</z><z id="t1478116721" t="dm3 not sure what you&apos;re trying to do in this snippet... is conn a bidirectional stream?"><y>#</y><d>2016-11-02</d><h>19:58</h><w>dm3</w>not sure what you&apos;re trying to do in this snippet... is <code>conn</code> a bidirectional stream?</z><z id="t1478330848" t="jetmind Is there a way to create a manifold stream with sliding buffer?"><y>#</y><d>2016-11-05</d><h>07:27</h><w>jetmind</w>Is there a way to create a manifold stream with sliding buffer?</z><z id="t1478348854" t="dm3 I don&apos;t think there&apos;s a built-in solution"><y>#</y><d>2016-11-05</d><h>12:27</h><w>dm3</w>I don&apos;t think there&apos;s a built-in solution</z><z id="t1478508700" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U04V197KE&quot;}] there is not a built in one, but with tranducers it is quite simple. I have an example for you, one sec"><y>#</y><d>2016-11-07</d><h>08:51</h><w>jeroenvandijk</w><a>@jetmind</a> there is not a built in one, but with tranducers it is quite simple. I have an example for you, one sec</z><z id="t1478508725" t="jeroenvandijk o wait you mean something else, i thought about windowing"><y>#</y><d>2016-11-07</d><h>08:52</h><w>jeroenvandijk</w>o wait you mean something else, i thought about windowing</z><z id="t1478509986" t="dm3 sliding buffers are trickier to implement currently"><y>#</y><d>2016-11-07</d><h>09:13</h><w>dm3</w>sliding buffers are trickier to implement currently</z><z id="t1478509997" t="dm3 one way would be to make the buffer in the default stream pluggable"><y>#</y><d>2016-11-07</d><h>09:13</h><w>dm3</w>one way would be to make the buffer in the default stream pluggable</z><z id="t1478510039" t="dm3 also one could make that change to stream/buffered-stream"><y>#</y><d>2016-11-07</d><h>09:13</h><w>dm3</w>also one could make that change to <code>stream/buffered-stream</code></z><z id="t1478514080" t="jetmind I&apos;ve implemented this as a library for now https://github.com/jetmind/waterfall It&apos;s a bit hacky, but works for me. Open to any feedback. I would love to see something like this in the manifold itself"><y>#</y><d>2016-11-07</d><h>10:21</h><w>jetmind</w>I&apos;ve implemented this as a library for now <a href="https://github.com/jetmind/waterfall" target="_blank">https://github.com/jetmind/waterfall</a>

It&apos;s a bit hacky, but works for me. Open to any feedback. I would love to see something like this in the manifold itself</z><z id="t1478514198" t="dm3 yep, that&apos;s what I was talking about"><y>#</y><d>2016-11-07</d><h>10:23</h><w>dm3</w>yep, that&apos;s what I was talking about</z><z id="t1478514222" t="dm3 if we expose buffer implementation to the user, you can do that kind of thing"><y>#</y><d>2016-11-07</d><h>10:23</h><w>dm3</w>if we expose buffer implementation to the user, you can do that kind of thing</z><z id="t1478514250" t="dm3 [:attrs {:href &quot;/_/_/users/U04V197KE&quot;}] do you mind creating an issue on Manifold with a suggestion?"><y>#</y><d>2016-11-07</d><h>10:24</h><w>dm3</w><a>@jetmind</a> do you mind creating an issue on Manifold with a suggestion?</z><z id="t1478514366" t="jetmind [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] sure! I was planning on doing that later this week"><y>#</y><d>2016-11-07</d><h>10:26</h><w>jetmind</w><a>@dm3</a> sure! I was planning on doing that later this week</z><z id="t1478514372" t="dm3 ok, great üôÇ"><y>#</y><d>2016-11-07</d><h>10:26</h><w>dm3</w>ok, great <b>üôÇ</b></z><z id="t1480291422" t="aengelberg If I (d/chain (http/get ...) f) , on what thread or thread pool is f executed?"><y>#</y><d>2016-11-28</d><h>00:03</h><w>aengelberg</w>If I <code>(d/chain (http/get ...) f)</code>, on what thread or thread pool is <code>f</code> executed?</z><z id="t1480316726" t="dm3 [:attrs {:href &quot;/_/_/users/U0516PHE3&quot;}] with https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L77 , if you don&apos;t provide any :response-executor parameter or have a manifold.executor/with-executor around the call."><y>#</y><d>2016-11-28</d><h>07:05</h><w>dm3</w><a>@aengelberg</a> with <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L77" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L77</a>, if you don&apos;t provide any <code>:response-executor</code> parameter or have a <code>manifold.executor/with-executor</code> around the call.</z><z id="t1480317794" t="aengelberg Thanks [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] , I came to a similar conclusion when I did some research right after I asked."><y>#</y><d>2016-11-28</d><h>07:23</h><w>aengelberg</w>Thanks <a>@dm3</a>, I came to a similar conclusion when I did some research right after I asked.</z><z id="t1481067884" t="dm3 finally: https://github.com/dm3/manifold-cljs üôÇ"><y>#</y><d>2016-12-06</d><h>23:44</h><w>dm3</w>finally: <a href="https://github.com/dm3/manifold-cljs" target="_blank">https://github.com/dm3/manifold-cljs</a> <b>üôÇ</b></z><z id="t1481099319" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] nice!"><y>#</y><d>2016-12-07</d><h>08:28</h><w>jeroenvandijk</w><a>@dm3</a> nice!</z><z id="t1485921566" t="eslachance Alright. Thankfully someone can help me out before I pull my hair out. I have this very odd issue. I&apos;m using aleph/manifold to connect to a websocket, and s/consume doesn&apos;t seem to be triggering at all and I really don&apos;t know why. Evaluating each relevant line one at a time works from the repl, just not within a function. Here&apos;s the exact line that doesn&apos;t trigger: https://github.com/eslachance/dithcord/blob/master/src/dithcord/core.clj#L121"><y>#</y><d>2017-02-01</d><h>03:59</h><w>eslachance</w>Alright. Thankfully someone can help me out before I pull my hair out. I have this very odd issue. I&apos;m using aleph/manifold to connect to a websocket, and <code>s/consume</code> doesn&apos;t seem to be triggering at all and I really don&apos;t know why. Evaluating each relevant line one at a time works from the repl, just not within a function. Here&apos;s the exact line that doesn&apos;t trigger: <a href="https://github.com/eslachance/dithcord/blob/master/src/dithcord/core.clj#L121" target="_blank">https://github.com/eslachance/dithcord/blob/master/src/dithcord/core.clj#L121</a></z><z id="t1485930821" t="dm3 what&apos;s the manifold version?"><y>#</y><d>2017-02-01</d><h>06:33</h><w>dm3</w>what&apos;s the manifold version?</z><z id="t1485938327" t="eslachance [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] I just have [aleph &quot;0.4.1&quot;]"><y>#</y><d>2017-02-01</d><h>08:38</h><w>eslachance</w><a>@dm3</a> I just have <code> [aleph &quot;0.4.1&quot;]</code></z><z id="t1485949706" t="dm3 [:attrs {:href &quot;/_/_/users/U1XCWUK2P&quot;}] what does printing the stream that you consume show?"><y>#</y><d>2017-02-01</d><h>11:48</h><w>dm3</w><a>@eslachance</a> what does printing the stream that you consume show?</z><z id="t1485949725" t="dm3 e.g. boot.user=&gt; (manifold.stream/stream) &lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 0, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? false, :pending-takes 0, :buffer-capacity 0, :source? true} &gt;&gt; "><y>#</y><d>2017-02-01</d><h>11:48</h><w>dm3</w>e.g. 
<pre>boot.user=&gt; (manifold.stream/stream)
&lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 0, :permanent? false, :type &quot;manifold&quot;, :sink? true, :closed? false, :pending-takes 0, :buffer-capacity 0, :source? true} &gt;&gt;
</pre></z><z id="t1485949776" t="dm3 after you start consuming the stream, it should have a :pending-takes 1 and :closed? should be false"><y>#</y><d>2017-02-01</d><h>11:49</h><w>dm3</w>after you start consuming the stream, it should have a <code>:pending-takes 1</code> and <code>:closed?</code> should be false</z><z id="t1485949784" t="dm3 and :drained? should also be false"><y>#</y><d>2017-02-01</d><h>11:49</h><w>dm3</w>and <code>:drained?</code> should also be false</z><z id="t1485949992" t="eslachance When I call that function (ws-connect) it returns the session, which has the stream as a socket"><y>#</y><d>2017-02-01</d><h>11:53</h><w>eslachance</w>When I call that function (ws-connect) it returns the session, which has the stream as a socket</z><z id="t1485950009" t="eslachance and printing out (:socket @session) does show that stream"><y>#</y><d>2017-02-01</d><h>11:53</h><w>eslachance</w>and printing out <code>(:socket @session)</code> does show that stream</z><z id="t1485950017" t="dm3 ws is the stream you&apos;re consuming"><y>#</y><d>2017-02-01</d><h>11:53</h><w>dm3</w><code>ws</code> is the stream you&apos;re consuming</z><z id="t1485950034" t="eslachance yes which I have as (swap! session assoc :socket ws)"><y>#</y><d>2017-02-01</d><h>11:53</h><w>eslachance</w>yes which I have as <code>(swap! session assoc :socket ws)</code></z><z id="t1485950038" t="eslachance let me see about drained"><y>#</y><d>2017-02-01</d><h>11:53</h><w>eslachance</w>let me see about drained</z><z id="t1485950123" t="dm3 what happens if you just do (let [x @(http/websocket-client &quot;&quot;)] (s/consume #(println &quot;DEBUG&quot; %) x)) ?"><y>#</y><d>2017-02-01</d><h>11:55</h><w>dm3</w>what happens if you just do
<pre>(let [x @(http/websocket-client &quot;&quot;)]
  (s/consume #(println &quot;DEBUG&quot; %) x))
</pre>
?</z><z id="t1485950157" t="eslachance .... nothing"><y>#</y><d>2017-02-01</d><h>11:55</h><w>eslachance</w>.... nothing</z><z id="t1485950164" t="eslachance well sorry it returns nil to be precise"><y>#</y><d>2017-02-01</d><h>11:56</h><w>eslachance</w>well sorry it returns <code>nil</code> to be precise</z><z id="t1485950179" t="dm3 yes"><y>#</y><d>2017-02-01</d><h>11:56</h><w>dm3</w>yes</z><z id="t1485950192" t="dm3 which means you are not receiving anything on that URL?"><y>#</y><d>2017-02-01</d><h>11:56</h><w>dm3</w>which means you are not receiving anything on that URL?</z><z id="t1485950194" t="eslachance nothing else, no message, not output."><y>#</y><d>2017-02-01</d><h>11:56</h><w>eslachance</w>nothing else, no message, not output.</z><z id="t1485950202" t="dm3 what if you try another WS client?"><y>#</y><d>2017-02-01</d><h>11:56</h><w>dm3</w>what if you try another WS client?</z><z id="t1485950216" t="dm3 like https://chrome.google.com/webstore/detail/simple-websocket-client/pfdhoblngboilpfeibdedpjgfnlcodoo?hl=en"><y>#</y><d>2017-02-01</d><h>11:56</h><w>dm3</w>like <a href="https://chrome.google.com/webstore/detail/simple-websocket-client/pfdhoblngboilpfeibdedpjgfnlcodoo?hl=en" target="_blank">https://chrome.google.com/webstore/detail/simple-websocket-client/pfdhoblngboilpfeibdedpjgfnlcodoo?hl=en</a></z><z id="t1485950218" t="eslachance But I am though if I do (def conn @(http/websocket-client &quot;&quot;)) (s/on-closed conn (fn [] (prn &quot;closed&quot;))) (s/consume (fn [msg] (prn msg)) conn) then I do get a message"><y>#</y><d>2017-02-01</d><h>11:56</h><w>eslachance</w>But I am though if I do <pre>(def conn @(http/websocket-client &quot;&quot;))
(s/on-closed conn (fn [] (prn &quot;closed&quot;)))
(s/consume (fn [msg] (prn msg)) conn) </pre> then I do get a message</z><z id="t1485950246" t="eslachance I get a first packet, and then I get a closed message after a second or so because the websocket is expecting an identity packet"><y>#</y><d>2017-02-01</d><h>11:57</h><w>eslachance</w>I get a first packet, and then I get a closed message after a second or so because the websocket is expecting an identity packet</z><z id="t1485950253" t="eslachance which, if I provide it, does work"><y>#</y><d>2017-02-01</d><h>11:57</h><w>eslachance</w>which, if I provide it, does work</z><z id="t1485950263" t="eslachance So I&apos;m receiving packets fine when I def the connection. But when I use let it doesn&apos;t work"><y>#</y><d>2017-02-01</d><h>11:57</h><w>eslachance</w>So I&apos;m receiving packets fine when I def the connection. But when I use <code>let</code> it doesn&apos;t work</z><z id="t1485950289" t="dm3 that doesn&apos;t affect anything"><y>#</y><d>2017-02-01</d><h>11:58</h><w>dm3</w>that doesn&apos;t affect anything</z><z id="t1485950307" t="eslachance I was previously using http.async.client , which worked fine except for the fact that it crashes the websocket on large packets (a bug in the java lib it uses)"><y>#</y><d>2017-02-01</d><h>11:58</h><w>eslachance</w>I was previously using <code>http.async.client</code> , which worked fine except for the fact that it crashes the websocket on large packets (a bug in the java lib it uses)</z><z id="t1485950329" t="dm3 so you have some code using aleph that works?"><y>#</y><d>2017-02-01</d><h>11:58</h><w>dm3</w>so you have some code using <code>aleph</code> that works?</z><z id="t1485950341" t="eslachance I do. those 3 lines work"><y>#</y><d>2017-02-01</d><h>11:59</h><w>eslachance</w>I do. those 3 lines work</z><z id="t1485950363" t="eslachance That&apos;s the packet"><y>#</y><d>2017-02-01</d><h>11:59</h><w>eslachance</w>That&apos;s the packet</z><z id="t1485950373" t="dm3 and you are saying that (let [conn @(http/websocket-client &quot;&quot;))] (s/on-closed conn (fn [] (prn &quot;closed&quot;))) (s/consume (fn [msg] (prn msg)) conn)) doesn&apos;t?"><y>#</y><d>2017-02-01</d><h>11:59</h><w>dm3</w>and you are saying that 
<pre>(let [conn @(http/websocket-client &quot;&quot;))]
  (s/on-closed conn (fn [] (prn &quot;closed&quot;)))
  (s/consume (fn [msg] (prn msg)) conn))
</pre>
doesn&apos;t?</z><z id="t1485950413" t="eslachance hmm"><y>#</y><d>2017-02-01</d><h>12:00</h><w>eslachance</w>hmm</z><z id="t1485950422" t="eslachance wait a sec. no it does."><y>#</y><d>2017-02-01</d><h>12:00</h><w>eslachance</w>wait a sec. no it does.</z><z id="t1485950425" t="eslachance ..."><y>#</y><d>2017-02-01</d><h>12:00</h><w>eslachance</w>...</z><z id="t1485950453" t="eslachance but... (let [x @(http/websocket-client &quot;&quot;)] (s/consume #(println &quot;DEBUG&quot; %) x)) didn&apos;t work. IT didn&apos;t print out that packet"><y>#</y><d>2017-02-01</d><h>12:00</h><w>eslachance</w>but... <pre>(let [x @(http/websocket-client &quot;&quot;)]
  (s/consume #(println &quot;DEBUG&quot; %) x)) </pre> didn&apos;t work. IT didn&apos;t print out that packet</z><z id="t1485950467" t="eslachance the heck?"><y>#</y><d>2017-02-01</d><h>12:01</h><w>eslachance</w>the heck?</z><z id="t1485950475" t="dm3 maybe there was no packet?"><y>#</y><d>2017-02-01</d><h>12:01</h><w>dm3</w>maybe there was no packet?</z><z id="t1485950482" t="dm3 try looking with wireshark or something?"><y>#</y><d>2017-02-01</d><h>12:01</h><w>dm3</w>try looking with wireshark or something?</z><z id="t1485950492" t="eslachance I don&apos;t even know what that is &gt;.&lt;"><y>#</y><d>2017-02-01</d><h>12:01</h><w>eslachance</w>I don&apos;t even know what that is &gt;.&lt;</z><z id="t1485950498" t="eslachance but really I know this API"><y>#</y><d>2017-02-01</d><h>12:01</h><w>eslachance</w>but really I know this API</z><z id="t1485950505" t="eslachance we&apos;re talkinga bout Discord here it always sends a packet"><y>#</y><d>2017-02-01</d><h>12:01</h><w>eslachance</w>we&apos;re talkinga bout Discord here it always sends a packet</z><z id="t1485950513" t="eslachance consistently"><y>#</y><d>2017-02-01</d><h>12:01</h><w>eslachance</w>consistently</z><z id="t1485950518" t="dm3 the URL is wrong"><y>#</y><d>2017-02-01</d><h>12:01</h><w>dm3</w>the URL is wrong</z><z id="t1485950533" t="eslachance OH MY GOD"><y>#</y><d>2017-02-01</d><h>12:02</h><w>eslachance</w>OH MY GOD</z><z id="t1485950544" t="eslachance ..."><y>#</y><d>2017-02-01</d><h>12:02</h><w>eslachance</w>...</z><z id="t1485950546" t="eslachance Thank you."><y>#</y><d>2017-02-01</d><h>12:02</h><w>eslachance</w>Thank you.</z><z id="t1485950554" t="eslachance I shall take my shame and go fix the error"><y>#</y><d>2017-02-01</d><h>12:02</h><w>eslachance</w>I shall take my shame and go fix the error</z><z id="t1485950564" t="dm3 happens üôÇ"><y>#</y><d>2017-02-01</d><h>12:02</h><w>dm3</w>happens <b>üôÇ</b></z><z id="t1485950659" t="eslachance Obviously, this does bring to light that aleph doesn&apos;t have an &quot;on-error&quot; event cough"><y>#</y><d>2017-02-01</d><h>12:04</h><w>eslachance</w>Obviously, this does bring to light that aleph doesn&apos;t have an &quot;on-error&quot; event cough</z><z id="t1485950667" t="eslachance (well manifold doesn&apos;t?)"><y>#</y><d>2017-02-01</d><h>12:04</h><w>eslachance</w>(well manifold doesn&apos;t?)</z><z id="t1485951075" t="dm3 it&apos;s probably closing the stream, no?"><y>#</y><d>2017-02-01</d><h>12:11</h><w>dm3</w>it&apos;s probably closing the stream, no?</z><z id="t1485951101" t="dm3 and there&apos;s https://github.com/ztellman/manifold/issues/95"><y>#</y><d>2017-02-01</d><h>12:11</h><w>dm3</w>and there&apos;s <a href="https://github.com/ztellman/manifold/issues/95" target="_blank">https://github.com/ztellman/manifold/issues/95</a></z><z id="t1485951108" t="dm3 which has no definite answer"><y>#</y><d>2017-02-01</d><h>12:11</h><w>dm3</w>which has no definite answer</z><z id="t1485951234" t="eslachance True, but when a websocket closes, it has a reason to close. Getting that reason would be... useful."><y>#</y><d>2017-02-01</d><h>12:13</h><w>eslachance</w>True, but when a websocket closes, it has a reason to close. Getting that reason would be... useful.</z><z id="t1485951303" t="dm3 agree"><y>#</y><d>2017-02-01</d><h>12:15</h><w>dm3</w>agree</z><z id="t1485951371" t="eslachance I mean we have s/on-close why not s/on-error . I feel that&apos;s expected, and consistent."><y>#</y><d>2017-02-01</d><h>12:16</h><w>eslachance</w>I mean we have <code>s/on-close</code> why not <code>s/on-error</code>. I feel that&apos;s expected, and consistent.</z><z id="t1485951381" t="eslachance And also consistent with other libraries"><y>#</y><d>2017-02-01</d><h>12:16</h><w>eslachance</w>And also consistent with other libraries</z><z id="t1485951408" t="dm3 you can contribute to the issue above"><y>#</y><d>2017-02-01</d><h>12:16</h><w>dm3</w>you can contribute to the issue above</z><z id="t1485951418" t="dm3 all thoughts welcome üôÇ"><y>#</y><d>2017-02-01</d><h>12:16</h><w>dm3</w>all thoughts welcome <b>üôÇ</b></z><z id="t1485951893" t="eslachance Obviously!"><y>#</y><d>2017-02-01</d><h>12:24</h><w>eslachance</w>Obviously!</z><z id="t1485951917" t="eslachance Once I get this all working I&apos;m planning a series of video tutorials on various things clojure-related in the shape of a development story for my library"><y>#</y><d>2017-02-01</d><h>12:25</h><w>eslachance</w>Once I get this all working I&apos;m planning a series of video tutorials on various things clojure-related in the shape of a development story for my library</z><z id="t1485951955" t="eslachance But that&apos;s once I get it working ^_^"><y>#</y><d>2017-02-01</d><h>12:25</h><w>eslachance</w>But that&apos;s once I get it working ^_^</z><z id="t1485953170" t="eslachance Any way to handle a zlib compressed packet? It shows up as #object[&quot;[B&quot; 0x7282913c &quot;[B@7282913c&quot;] if I just print it to console, not exactly sure how to handle that"><y>#</y><d>2017-02-01</d><h>12:46</h><w>eslachance</w>Any way to handle a zlib compressed packet? It shows up as <code>#object[&quot;[B&quot; 0x7282913c &quot;[B@7282913c&quot;]</code> if I just print it to console, not exactly sure how to handle that</z><z id="t1485953310" t="dm3 I guess you need to decompress it yourself"><y>#</y><d>2017-02-01</d><h>12:48</h><w>dm3</w>I guess you need to decompress it yourself</z><z id="t1485953394" t="dm3 using e.g. http://docs.oracle.com/javase/7/docs/api/java/util/zip/Inflater.html"><y>#</y><d>2017-02-01</d><h>12:49</h><w>dm3</w>using e.g. <a href="http://docs.oracle.com/javase/7/docs/api/java/util/zip/Inflater.html" target="_blank">http://docs.oracle.com/javase/7/docs/api/java/util/zip/Inflater.html</a></z><z id="t1485953462" t="eslachance And the java interop adventure beings...."><y>#</y><d>2017-02-01</d><h>12:51</h><w>eslachance</w>And the java interop adventure beings....</z><z id="t1485953578" t="dm3 this seems like an approach - https://github.com/amatus/GNUnet-in-Clojure/blob/master/src/main/clojure/org/gnu/clojure/gnunet/zip.clj"><y>#</y><d>2017-02-01</d><h>12:52</h><w>dm3</w>this seems like an approach - <a href="https://github.com/amatus/GNUnet-in-Clojure/blob/master/src/main/clojure/org/gnu/clojure/gnunet/zip.clj" target="_blank">https://github.com/amatus/GNUnet-in-Clojure/blob/master/src/main/clojure/org/gnu/clojure/gnunet/zip.clj</a></z><z id="t1485954613" t="eslachance Wait what about byte-streams?"><y>#</y><d>2017-02-01</d><h>13:10</h><w>eslachance</w>Wait what about byte-streams?</z><z id="t1485954631" t="eslachance ooooh"><y>#</y><d>2017-02-01</d><h>13:10</h><w>eslachance</w>ooooh</z><z id="t1485954775" t="eslachance I feel like I&apos;m so close though &quot;x?????0\fE??k???]?????A?t\&quot;??K??\b??e2???vG?G???\n\rz??????B/;X/?&amp;??\n??`??\r?Z???????z ??9?m??_?L??;?S??*8.??(?c4!8%????0?1/?}Y?B?i??\\???BY????E??\r?f??)i\f¬∫?Z??$??u??+??2&lt;?\r?B&amp;\&quot;5?1LIz?!*?Iz??,?l?`???/?????Y??t?Rh??R????y??2??+????????NGa???\r??R8?u??\b+c????*\n???k????ab??q?u?G??.\\?4?}??U?f?r???l?r&quot; "><y>#</y><d>2017-02-01</d><h>13:12</h><w>eslachance</w>I feel like I&apos;m so close though <pre>&quot;x?????0\fE??k???]?????A?t\&quot;??K??\b??e2???vG?G???\n\rz??????B/;X/?&amp;??\n??`??\r?Z???????z ??9?m??_?L??;?S??*8.??(?c4!8%????0?1/?}Y?B?i??\\???BY????E??\r?f??)i\f¬∫?Z??$??u??+??2&lt;?\r?B&amp;\&quot;5?1LIz?!*?Iz??,?l?`???/?????Y??t?Rh??R????y??2??+????????NGa???\r??R8?u??\b+c????*\n???k????ab??q?u?G??.\\?4?}??U?f?r???l?r&quot;
 </pre></z><z id="t1485990842" t="eslachance Oh btw, [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] that approach did work, I included it in my project, and used the following line on the incoming packet: (String. (byte-array (z/inflate msg))) (z/ being that zip.clj file)"><y>#</y><d>2017-02-01</d><h>23:14</h><w>eslachance</w>Oh btw, <a>@dm3</a> that approach did work, I included it in my project, and used the following line on the incoming packet: <pre>(String. (byte-array (z/inflate msg))) </pre> (z/ being that zip.clj file)</z><z id="t1485990948" t="eslachance Took a lot of mucking around and some help from other people but it works!"><y>#</y><d>2017-02-01</d><h>23:15</h><w>eslachance</w>Took a lot of mucking around and some help from other people but it works!</z><z id="t1486423537" t="csm curious if anyone has ever looked at using haproxy with aleph (or netty)"><y>#</y><d>2017-02-06</d><h>23:25</h><w>csm</w>curious if anyone has ever looked at using haproxy with aleph (or netty)</z><z id="t1486423589" t="csm I seem to be able to get netty‚Äôs HAProxyMessageDecoder to work correctly in the pipeline, but I don‚Äôt know how to get the proxied connection info"><y>#</y><d>2017-02-06</d><h>23:26</h><w>csm</w>I seem to be able to get netty‚Äôs HAProxyMessageDecoder to work correctly in the pipeline, but I don‚Äôt know how to get the proxied connection info</z><z id="t1486454465" t="dm3 [:attrs {:href &quot;/_/_/users/U1WMPA45U&quot;}] have never used HAProxy, but what do you mean by the proxied connection info?"><y>#</y><d>2017-02-07</d><h>08:01</h><w>dm3</w><a>@csm</a> have never used HAProxy, but what do you mean by the proxied connection info?</z><z id="t1486495665" t="csm HAProxy‚Äôs protocol starts with a single message at the start of the connection, giving info like the remote IP and port"><y>#</y><d>2017-02-07</d><h>19:27</h><w>csm</w>HAProxy‚Äôs protocol starts with a single message at the start of the connection, giving info like the remote IP and port</z><z id="t1486495692" t="csm netty‚Äôs decoder captures that info, but I can‚Äôt figure out how to get that out of the pipeline"><y>#</y><d>2017-02-07</d><h>19:28</h><w>csm</w>netty‚Äôs decoder captures that info, but I can‚Äôt figure out how to get that out of the pipeline</z><z id="t1486532328" t="eslachance Oh boy. io.netty.handler.codec.CorruptedFrameException: Max frame length of 65536 has been exceeded. &lt;--- is this something I can... uhm... &quot;fix&quot; by allowing bigger packets?"><y>#</y><d>2017-02-08</d><h>05:38</h><w>eslachance</w>Oh boy. <code>io.netty.handler.codec.CorruptedFrameException: Max frame length of 65536 has been exceeded.</code> &lt;--- is this something I can... uhm... &quot;fix&quot; by allowing bigger packets?</z><z id="t1486585569" t="eslachance So I tried to boost the signal, rotate the phase matrix and even reverse the polarity but... I can&apos;t get this to not break on large packets. This is what I have: (defn connect &quot;Creates a websocket Connection to Discord API&quot; [state] (let [full-state (merge state {:internal-handlers internal-handlers}) session (atom full-state) ws @(http/websocket-client &quot;&quot; {:max-frame-payload 67108864 :max-frame-size 67108864 :max-queue-size 67108864})] (swap! session assoc :ping-counter (atom 0)) (swap! session assoc :socket ws) (s/consume #(on-message %1 session) ws) (s/on-closed ws #(on-ws-close session)) session )) "><y>#</y><d>2017-02-08</d><h>20:26</h><w>eslachance</w>So I tried to boost the signal, rotate the phase matrix and even reverse the polarity but... I can&apos;t get this to not break on large packets. This is what I have: 
<pre>(defn connect
  &quot;Creates a websocket Connection to Discord API&quot;
  [state]
  (let [full-state (merge state {:internal-handlers internal-handlers})
        session (atom full-state)
        ws @(http/websocket-client &quot;&quot;
                                   {:max-frame-payload 67108864
                                    :max-frame-size 67108864
                                    :max-queue-size 67108864})]
    (swap! session assoc :ping-counter (atom 0))
    (swap! session assoc :socket ws)
    (s/consume #(on-message %1 session) ws)
    (s/on-closed ws #(on-ws-close session))
    session
    )) </pre></z><z id="t1486585579" t="eslachance I still get io.netty.handler.codec.CorruptedFrameException: Max frame length of 65536 has been exceeded"><y>#</y><d>2017-02-08</d><h>20:26</h><w>eslachance</w>I still get <code>io.netty.handler.codec.CorruptedFrameException: Max frame length of 65536 has been exceeded</code></z><z id="t1486586262" t="dm3 [:attrs {:href &quot;/_/_/users/U1XCWUK2P&quot;}] have you tried this one? https://groups.google.com/forum/#!topic/aleph-lib/gO_EJMOXCoo"><y>#</y><d>2017-02-08</d><h>20:37</h><w>dm3</w><a>@eslachance</a> have you tried this one? <a href="https://groups.google.com/forum/#!topic/aleph-lib/gO_EJMOXCoo" target="_blank">https://groups.google.com/forum/#!topic/aleph-lib/gO_EJMOXCoo</a></z><z id="t1486586290" t="eslachance I have max-frame-payload in there"><y>#</y><d>2017-02-08</d><h>20:38</h><w>eslachance</w>I have max-frame-payload in there</z><z id="t1486586322" t="eslachance Actually that post talks about websocket-connection and not websocket-client so I wonder if there are different options for those 2?"><y>#</y><d>2017-02-08</d><h>20:38</h><w>eslachance</w>Actually that post talks about <code>websocket-connection</code> and not <code>websocket-client</code> so I wonder if there are different options for those 2?</z><z id="t1486586339" t="dm3 you&apos;ll need to read the source I think"><y>#</y><d>2017-02-08</d><h>20:38</h><w>dm3</w>you&apos;ll need to read the source I think</z><z id="t1486586342" t="dm3 it&apos;s not huge"><y>#</y><d>2017-02-08</d><h>20:39</h><w>dm3</w>it&apos;s not huge</z><z id="t1486586447" t="eslachance as far as I can tell, actually, it&apos;s the same. https://github.com/ztellman/aleph/blob/b81f79b1f7911637af90391d9761fd45e584cd67/src/aleph/http.clj#L144"><y>#</y><d>2017-02-08</d><h>20:40</h><w>eslachance</w>as far as I can tell, actually, it&apos;s the same. <a href="https://github.com/ztellman/aleph/blob/b81f79b1f7911637af90391d9761fd45e584cd67/src/aleph/http.clj#L144" target="_blank">https://github.com/ztellman/aleph/blob/b81f79b1f7911637af90391d9761fd45e584cd67/src/aleph/http.clj#L144</a></z><z id="t1486586460" t="eslachance no max-queue size though"><y>#</y><d>2017-02-08</d><h>20:41</h><w>eslachance</w>no max-queue size though</z><z id="t1486596196" t="csm so I dug through netty and haproxy, and came up with this: https://github.com/csm/aleph-haproxy-tcp"><y>#</y><d>2017-02-08</d><h>23:23</h><w>csm</w>so I dug through netty and haproxy, and came up with this: <a href="https://github.com/csm/aleph-haproxy-tcp" target="_blank">https://github.com/csm/aleph-haproxy-tcp</a></z><z id="t1487580062" t="stijn does anyone know what might be the reason for:"><y>#</y><d>2017-02-20</d><h>08:41</h><w>stijn</w>does anyone know what might be the reason for:</z><z id="t1487580064" t="stijn 2017-02-20T08:40:28.953+0000 cantona-api-383746225-whp97 ERROR [aleph.http.server:0] - error in HTTP handler java.lang.Thread.run Thread.java: 745 ... manifold.executor/thread-factory/reify/f executor.clj: 44 io.aleph.dirigiste.Executor$Worker$1.run Executor.java: 62 ... aleph.http.server/handle-request/fn/f--auto-- server.clj: 156 bidi.vhosts/make-handler/fn vhosts.clj: 199 bidi.ring/fn/G ring.clj: 12 yada.bidi/fn bidi.clj: 75 yada.handler/handle-request handler.clj: 169 yada.handler/handle-request-with-maybe-subresources handler.clj: 120 clojure.core/apply core.clj: 648 ... manifold.deferred/chain deferred.clj: 909 manifold.deferred/chain deferred.clj: 933 ... clojure.core/apply core.clj: 641 clojure.core/apply core.clj: 654 ... manifold.deferred/fn/chain- deferred.clj: 888 manifold.deferred.Deferred/onRealized deferred.clj: 417 manifold.deferred/add-listener! deferred.clj: 262 manifold.deferred.Deferred/addListener deferred.clj: 384 io.aleph.dirigiste.Executor.execute Executor.java: 332 java.util.concurrent.RejectedExecutionException:"><y>#</y><d>2017-02-20</d><h>08:41</h><w>stijn</w><pre>2017-02-20T08:40:28.953+0000 cantona-api-383746225-whp97 ERROR [aleph.http.server:0] - error in HTTP handler
                               java.lang.Thread.run    Thread.java: 745
                                                ...
           manifold.executor/thread-factory/reify/f   executor.clj:  44
           io.aleph.dirigiste.Executor$Worker$1.run  Executor.java:  62
                                                ...
      aleph.http.server/handle-request/fn/f--auto--     server.clj: 156
                        bidi.vhosts/make-handler/fn     vhosts.clj: 199
                                     bidi.ring/fn/G       ring.clj:  12
                                       yada.bidi/fn       bidi.clj:  75
                        yada.handler/handle-request    handler.clj: 169
yada.handler/handle-request-with-maybe-subresources    handler.clj: 120
                                 clojure.core/apply       core.clj: 648
                                                ...
                            manifold.deferred/chain   deferred.clj: 909
                            manifold.deferred/chain   deferred.clj: 933
                                                ...
                                 clojure.core/apply       core.clj: 641
                                 clojure.core/apply       core.clj: 654
                                                ...
                        manifold.deferred/fn/chain-   deferred.clj: 888
              manifold.deferred.Deferred/onRealized   deferred.clj: 417
                    manifold.deferred/add-listener!   deferred.clj: 262
             manifold.deferred.Deferred/addListener   deferred.clj: 384
                io.aleph.dirigiste.Executor.execute  Executor.java: 332
java.util.concurrent.RejectedExecutionException:</pre></z><z id="t1487580112" t="dm3 your thread pool doesn‚Äôt accept new tasks"><y>#</y><d>2017-02-20</d><h>08:41</h><w>dm3</w>your thread pool doesn‚Äôt accept new tasks</z><z id="t1487580126" t="dm3 it‚Äôs full"><y>#</y><d>2017-02-20</d><h>08:42</h><w>dm3</w>it‚Äôs full</z><z id="t1487580383" t="stijn ok, I should probably setup a stats logger"><y>#</y><d>2017-02-20</d><h>08:46</h><w>stijn</w>ok, I should probably setup a stats logger</z><z id="t1487580411" t="stijn it started happening when the server was under heavy load, but it doesn&apos;t &apos;repair&apos; itself when the load lowers"><y>#</y><d>2017-02-20</d><h>08:46</h><w>stijn</w>it started happening when the server was under heavy load, but it doesn&apos;t &apos;repair&apos; itself when the load lowers</z><z id="t1487580427" t="stijn I&apos;m using the default executor"><y>#</y><d>2017-02-20</d><h>08:47</h><w>stijn</w>I&apos;m using the default executor</z><z id="t1487580497" t="dm3 hm"><y>#</y><d>2017-02-20</d><h>08:48</h><w>dm3</w>hm</z><z id="t1487580598" t="dm3 I‚Äôm not sure what‚Äôs the default in your stack but the default Manifold execute-pool allows an Integer/MAX_VALUE number of threads"><y>#</y><d>2017-02-20</d><h>08:49</h><w>dm3</w>I‚Äôm not sure what‚Äôs the default in your stack but the default Manifold execute-pool allows an Integer/MAX_VALUE number of threads</z><z id="t1487580637" t="dm3 so either the pool you‚Äôre using has lower limits, or something was hogging resources for a long time"><y>#</y><d>2017-02-20</d><h>08:50</h><w>dm3</w>so either the pool you‚Äôre using has lower limits, or something was hogging resources for a long time</z><z id="t1487580682" t="dm3 also I‚Äôm not sure what‚Äôs the behaviour in case the pool can‚Äôt create a new Thread - can this only happen due to OOM - then an OOM would‚Äôve been thrown I think"><y>#</y><d>2017-02-20</d><h>08:51</h><w>dm3</w>also I‚Äôm not sure what‚Äôs the behaviour in case the pool can‚Äôt create a new Thread - can this only happen due to OOM - then an OOM would‚Äôve been thrown I think</z><z id="t1487580927" t="dm3 also might have happened if the executor was in process of being shut down"><y>#</y><d>2017-02-20</d><h>08:55</h><w>dm3</w>also might have happened if the executor was in process of being shut down</z><z id="t1487580938" t="dm3 [:attrs {:href &quot;/_/_/users/U0539NJF7&quot;}] could that be the case?"><y>#</y><d>2017-02-20</d><h>08:55</h><w>dm3</w><a>@stijn</a> could that be the case?</z><z id="t1487581051" t="dm3 I‚Äôd bet you got this exception during the shutdown process"><y>#</y><d>2017-02-20</d><h>08:57</h><w>dm3</w>I‚Äôd bet you got this exception during the shutdown process</z><z id="t1487581090" t="stijn I will scan the logs to try and find the root cause"><y>#</y><d>2017-02-20</d><h>08:58</h><w>stijn</w>I will scan the logs to try and find the root cause</z><z id="t1487581111" t="stijn it might be that resources were exhausted"><y>#</y><d>2017-02-20</d><h>08:58</h><w>stijn</w>it might be that resources were exhausted</z><z id="t1487582330" t="residentsummer well, I‚Äôve seen this too. Do you, by chance, make requests to other services with aleph.http ?"><y>#</y><d>2017-02-20</d><h>09:18</h><w>residentsummer</w>well, I‚Äôve seen this too. Do you, by chance, make requests to other services with <code>aleph.http</code>?</z><z id="t1487583190" t="stijn no, we&apos;ve deliberately swapped this out for http-kit because of https://github.com/ztellman/aleph/issues/217"><y>#</y><d>2017-02-20</d><h>09:33</h><w>stijn</w>no, we&apos;ve deliberately swapped this out for http-kit because of <a href="https://github.com/ztellman/aleph/issues/217" target="_blank">https://github.com/ztellman/aleph/issues/217</a></z><z id="t1487583421" t="residentsummer Yes, that what I had in mind"><y>#</y><d>2017-02-20</d><h>09:37</h><w>residentsummer</w>Yes, that what I had in mind</z><z id="t1489180953" t="miikka woot woot https://twitter.com/ztellman/status/840304624217149440"><y>#</y><d>2017-03-10</d><h>21:22</h><w>miikka</w>woot woot <a href="https://twitter.com/ztellman/status/840304624217149440" target="_blank">https://twitter.com/ztellman/status/840304624217149440</a></z><z id="t1490383747" t="mbcev I&apos;m trying to write a networking app with Aleph and Manifold but am a confused newb so any help would be appreciated. I&apos;m going over the aleph.examples.tcp code and I think I understand how that works but it&apos;s all self contained in a single project/app."><y>#</y><d>2017-03-24</d><h>19:29</h><w>mbcev</w>I&apos;m trying to write a networking app with Aleph and Manifold but am a confused newb so any help would be appreciated. I&apos;m going over the aleph.examples.tcp code and I think I understand how that works but it&apos;s all self contained in a single project/app.</z><z id="t1490383878" t="mbcev What I tried to do is with my server app use the tcp example and with my client app I used (def s (s/stream)) thinking that when I used @(s/put! c 1) and @(s/take! c) my client app would connect to my server app but I get a connection refused in my app and my server app just stops running without any output."><y>#</y><d>2017-03-24</d><h>19:31</h><w>mbcev</w>What I tried to do is with my server app use the tcp example and with my client app I used <code>(def s (s/stream))</code> thinking that when I used <code>@(s/put! c 1)</code> and   <code>@(s/take! c)</code> my client app would connect to my server app but I get a connection refused in my app and my server app just stops running without any output.</z><z id="t1490383995" t="mbcev on the server side of things I changed the handler from inc to (fn [x] (do (println (str &quot;server: &quot; x)) x)) and then wrapped @(s/put! c 1) on the client in a print statement so I could see that each app was getting/sending data but other than that I am using line for line the aleph.examples.tcp code"><y>#</y><d>2017-03-24</d><h>19:33</h><w>mbcev</w>on the server side of things I changed the handler from <code>inc</code> to <code>(fn [x] (do (println (str &quot;server: &quot; x))  x))</code> and then wrapped <code>@(s/put! c 1)</code> on the client in a print statement so I could see  that each app was getting/sending data but other than that I am using line for line the aleph.examples.tcp code</z><z id="t1490385066" t="mbcev Oh; I figured it out. I needed (.wait-for-close s)"><y>#</y><d>2017-03-24</d><h>19:51</h><w>mbcev</w>Oh; I figured it out. I needed <code>(.wait-for-close s)</code></z><z id="t1491931685" t="csm anyone successfully sending io.netty.buffer.ByteBuf to an aleph output stream? Any clue if it releases the buffer after it sends, or do I need to do that after the send completes?"><y>#</y><d>2017-04-11</d><h>17:28</h><w>csm</w>anyone successfully sending <code>io.netty.buffer.ByteBuf</code> to an aleph output stream? Any clue if it releases the buffer after it sends, or do I need to do that after the send completes?</z><z id="t1493123836" t="miikka I&apos;m getting this kind of errors when trying to use Aleph HTTP client for HTTPS. Anyone know what&apos;s going on? Caused by: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target at sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:387) at sun.security.validator.PKIXValidator.engineValidate(PKIXValidator.java:292) at sun.security.validator.Validator.validate(Validator.java:260) at sun.security.ssl.X509TrustManagerImpl.validate(X509TrustManagerImpl.java:324) at sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:281) at sun.security.ssl.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:136) at sun.security.ssl.ClientHandshaker.serverCertificate(ClientHandshaker.java:1496) ... 26 more Caused by: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target at sun.security.provider.certpath.SunCertPathBuilder.build(SunCertPathBuilder.java:146) at sun.security.provider.certpath.SunCertPathBuilder.engineBuild(SunCertPathBuilder.java:131) at java.security.cert.CertPathBuilder.build(CertPathBuilder.java:280) at sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:382) ... 32 more "><y>#</y><d>2017-04-25</d><h>12:37</h><w>miikka</w>I&apos;m getting this kind of errors when trying to use Aleph HTTP client for HTTPS. Anyone know what&apos;s going on?
<pre>Caused by: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
        at sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:387)
        at sun.security.validator.PKIXValidator.engineValidate(PKIXValidator.java:292)
        at sun.security.validator.Validator.validate(Validator.java:260)
        at sun.security.ssl.X509TrustManagerImpl.validate(X509TrustManagerImpl.java:324)
        at sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:281)
        at sun.security.ssl.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:136)
        at sun.security.ssl.ClientHandshaker.serverCertificate(ClientHandshaker.java:1496)
        ... 26 more
Caused by: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
        at sun.security.provider.certpath.SunCertPathBuilder.build(SunCertPathBuilder.java:146)
        at sun.security.provider.certpath.SunCertPathBuilder.engineBuild(SunCertPathBuilder.java:131)
        at java.security.cert.CertPathBuilder.build(CertPathBuilder.java:280)
        at sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:382)
        ... 32 more
</pre></z><z id="t1493124047" t="miikka Okay, I guess my JVM cacerts is outdated and I should update Java. Or something."><y>#</y><d>2017-04-25</d><h>12:40</h><w>miikka</w>Okay, I guess my JVM <code>cacerts</code> is outdated and I should update Java. Or something.</z><z id="t1493128655" t="lvh that‚Äôs one way"><y>#</y><d>2017-04-25</d><h>13:57</h><w>lvh</w>that‚Äôs one way</z><z id="t1493128667" t="lvh I‚Äôm pretty sure you can pass it a custom netty object if you really want to"><y>#</y><d>2017-04-25</d><h>13:57</h><w>lvh</w>I‚Äôm pretty sure you can pass it a custom netty object if you really want to</z><z id="t1493132783" t="miikka Well, upgrading Java made Let&apos;s Encrypt certs work, but actually I need to connect to a site with a StartSSL cert, so I passed in a SSL context that uses the StartSSL CA cert"><y>#</y><d>2017-04-25</d><h>15:06</h><w>miikka</w>Well, upgrading Java made Let&apos;s Encrypt certs work, but actually I need to connect to a site with a StartSSL cert, so I passed in a SSL context that uses the StartSSL CA cert</z><z id="t1493132825" t="miikka (I was first testing with https://httpbin.org/ which uses Let&apos;s Encrypt)"><y>#</y><d>2017-04-25</d><h>15:07</h><w>miikka</w>(I was first testing with <a href="https://httpbin.org/" target="_blank">https://httpbin.org/</a> which uses Let&apos;s Encrypt)</z><z id="t1493232399" t="miikka Is it expected behavior that calling (.close) twice on a Aleph HTTP server throws an exception?"><y>#</y><d>2017-04-26</d><h>18:46</h><w>miikka</w>Is it expected behavior that calling <code>(.close)</code> twice on a Aleph HTTP server throws an exception?</z><z id="t1493233541" t="miikka I opened an issue: https://github.com/ztellman/aleph/issues/315"><y>#</y><d>2017-04-26</d><h>19:05</h><w>miikka</w>I opened an issue: <a href="https://github.com/ztellman/aleph/issues/315" target="_blank">https://github.com/ztellman/aleph/issues/315</a></z><z id="t1494116226" t="bradford Hi! I need to manually turn a Netty request into a Ring request. I&apos;m trying to use aleph.http.core/netty-request-&gt;ring-request (I know this is frowned upon). What type is body supposed to be, and where does it come from? Isn&apos;t that already contained in the HttpRequest from Netty?"><y>#</y><d>2017-05-07</d><h>00:17</h><w>bradford</w>Hi! I need to manually turn a Netty request into a Ring request. I&apos;m trying to use <code>aleph.http.core/netty-request-&gt;ring-request</code> (I know this is frowned upon). What type is <code>body</code> supposed to be, and where does it come from? Isn&apos;t that already contained in the <code>HttpRequest</code> from Netty?</z><z id="t1494188950" t="danielcompton Body for a ring request can kinda be whatever you want"><y>#</y><d>2017-05-07</d><h>20:29</h><w>danielcompton</w>Body for a ring request can kinda be whatever you want</z><z id="t1494188956" t="danielcompton sometimes it&apos;s an input stream"><y>#</y><d>2017-05-07</d><h>20:29</h><w>danielcompton</w>sometimes it&apos;s an input stream</z><z id="t1494188960" t="danielcompton sometimes it&apos;s a string"><y>#</y><d>2017-05-07</d><h>20:29</h><w>danielcompton</w>sometimes it&apos;s a string</z><z id="t1494188972" t="danielcompton sometimes it&apos;s a hydrated JSON object"><y>#</y><d>2017-05-07</d><h>20:29</h><w>danielcompton</w>sometimes it&apos;s a hydrated JSON object</z><z id="t1494188990" t="danielcompton depends what kind of middleware you&apos;re using"><y>#</y><d>2017-05-07</d><h>20:29</h><w>danielcompton</w>depends what kind of middleware you&apos;re using</z><z id="t1494189276" t="danielcompton In aleph, I think it&apos;s coerced to an input-stream mostly: https://github.com/ztellman/aleph/blob/cc0f2a5319fef6c0cde4372c7435316aef27a960/src/aleph/http/server.clj#L253-L275 (see the args to handle-request )"><y>#</y><d>2017-05-07</d><h>20:34</h><w>danielcompton</w>In aleph, I think it&apos;s coerced to an input-stream mostly: <a href="https://github.com/ztellman/aleph/blob/cc0f2a5319fef6c0cde4372c7435316aef27a960/src/aleph/http/server.clj#L253-L275" target="_blank">https://github.com/ztellman/aleph/blob/cc0f2a5319fef6c0cde4372c7435316aef27a960/src/aleph/http/server.clj#L253-L275</a> (see the args to <code>handle-request</code>)</z><z id="t1494189446" t="danielcompton I think a Netty HttpRequest is much more bare, just method, URI, and protocol version"><y>#</y><d>2017-05-07</d><h>20:37</h><w>danielcompton</w>I think a Netty <code>HttpRequest</code> is much more bare, just method, URI, and protocol version</z><z id="t1495541120" t="gmercer [:attrs {:href &quot;/_/_/users/U066UJ2KE&quot;}] would it be straightforward to start a tcp socket that hands of to the http stack based on sniffing &lt;something&gt; ?"><y>#</y><d>2017-05-23</d><h>12:05</h><w>gmercer</w><a>@ztellman</a> would it be straightforward to start a tcp socket that hands of to the http stack based on sniffing &lt;something&gt; ?</z><z id="t1495541406" t="gmercer back-story is I have limited firewall holes and I need to support log4j events for now but would like to upgrade to http"><y>#</y><d>2017-05-23</d><h>12:10</h><w>gmercer</w>back-story is I have limited firewall holes and I need to support log4j events for now but would like to upgrade to http</z><z id="t1495541730" t="gmercer left-field question - would aeron be possible with gloss mapping to sbe ?"><y>#</y><d>2017-05-23</d><h>12:15</h><w>gmercer</w>left-field question - would aeron be possible with gloss mapping to  sbe ?</z><z id="t1495542306" t="dm3 it probably would - however the resulting model would partly defeat the purpose of SBE as a toolkit - allocation free and zero copy"><y>#</y><d>2017-05-23</d><h>12:25</h><w>dm3</w>it probably would - however the resulting model would partly defeat the purpose of SBE as a toolkit - allocation free and zero copy</z><z id="t1495542340" t="dm3 I assume you mean aeron transport for aleph?"><y>#</y><d>2017-05-23</d><h>12:25</h><w>dm3</w>I assume you mean aeron transport for aleph?</z><z id="t1495542512" t="gmercer yes - aeron vs netty, I thought the smarts of manifold would allow the zero copy to work"><y>#</y><d>2017-05-23</d><h>12:28</h><w>gmercer</w>yes - aeron vs netty, I thought the smarts of manifold would allow the zero copy to work</z><z id="t1495543059" t="dm3 I guess I don‚Äôt see where gloss comes in"><y>#</y><d>2017-05-23</d><h>12:37</h><w>dm3</w>I guess I don‚Äôt see where gloss comes in</z><z id="t1495543085" t="dm3 given SBE we should be using the SBE toolkit"><y>#</y><d>2017-05-23</d><h>12:38</h><w>dm3</w>given SBE we should be using the SBE toolkit</z><z id="t1495543152" t="dm3 although I have zero practical experience with SBE/Aeron üôÇ"><y>#</y><d>2017-05-23</d><h>12:39</h><w>dm3</w>although I have zero practical experience with SBE/Aeron <b>üôÇ</b></z><z id="t1496191201" t="csm hmm, any idea on how to essentially force fragmentation of messages over TCP? I‚Äôm sending to a resource-constrained client, and messages in the TLS handshake are exceeding their packet buffer size"><y>#</y><d>2017-05-31</d><h>00:40</h><w>csm</w>hmm, any idea on how to essentially force fragmentation of messages over TCP? I‚Äôm sending to a resource-constrained client, and messages in the TLS handshake are exceeding their packet buffer size</z></g><g id="s2"><z id="t1496244830" t="ehashman [:attrs {:href &quot;/_/_/users/U1WMPA45U&quot;}] you want to set TCP max seg"><y>#</y><d>2017-05-31</d><h>15:33</h><w>ehashman</w><a>@csm</a> you want to set TCP max seg</z><z id="t1496244846" t="ehashman I dunno what the support looks like in aleph/netty"><y>#</y><d>2017-05-31</d><h>15:34</h><w>ehashman</w>I dunno what the support looks like in aleph/netty</z><z id="t1496424891" t="mping Hia, I‚Äôm having trouble converting the following code to d/loop : (loop [messages (fetch-messages auth-token query nil) result []] (let [next-token (:nextPageToken messages)] (if (nil? next-token) (d/future (concat result (:messages @messages))) (recur (fetch-messages auth-token query next-token) result)) )) "><y>#</y><d>2017-06-02</d><h>17:34</h><w>mping</w>Hia, I‚Äôm having trouble converting the following code to <code>d/loop</code>:
<pre>(loop [messages (fetch-messages auth-token query nil)
            result []]
       (let [next-token (:nextPageToken messages)]
         (if (nil? next-token)
           (d/future (concat result (:messages @messages)))
           (recur (fetch-messages auth-token query next-token)
                  result))
         ))
</pre></z><z id="t1496424919" t="mping I must have misunderstood something, this is my attempt: (d/loop [messages (fetch-messages auth-token query nil) result []] (-&gt; messages (d/chain (fn [msgs] (let [next-token (:nextPageToken msgs)] (println &quot;NEXT:&quot; next-token) (if (nil? next-token) (concat result (:messages msgs)) (d/recur (fetch-messages auth-token query next-token)) ) ))) (d/catch (fn [ex] (println &quot;ERROR&quot; ex) ex)) )) "><y>#</y><d>2017-06-02</d><h>17:35</h><w>mping</w>I must have misunderstood something, this is my attempt:
<pre>(d/loop [messages (fetch-messages auth-token query nil)
              result   []]
       (-&gt; messages
           (d/chain 
            (fn [msgs]
              (let [next-token (:nextPageToken msgs)]
                (println &quot;NEXT:&quot; next-token)
                (if (nil? next-token)
                  (concat result (:messages msgs))
                  (d/recur (fetch-messages auth-token query next-token))
                  )
                )))
           (d/catch 
               (fn [ex]
                 (println &quot;ERROR&quot; ex)
                 ex))
))
</pre></z><z id="t1496425217" t="gsnewmark mping: it looks like you&apos;re d/recur is missing one argument, it should probably be something like this (didn&apos;t check with compiler): (d/loop [token nil result []] (-&gt; (fetch-messages auth-token query token) (d/chain (fn [msgs] (let [next-token (:nextPageToken msgs)] (println &quot;NEXT:&quot; next-token) (if (nil? next-token) (concat result (:messages msgs)) (d/recur next-token (concat result (:messages msgs))))))) (d/catch (fn [ex] (println &quot;ERROR&quot; ex) ex)))) "><y>#</y><d>2017-06-02</d><h>17:40</h><r>gsnewmark</r>mping: it looks like you&apos;re <code>d/recur</code> is missing one argument, it should probably be something like this (didn&apos;t check with compiler):
<pre>(d/loop [token nil
         result []]
  (-&gt; (fetch-messages auth-token query token)
      (d/chain 
       (fn [msgs]
         (let [next-token (:nextPageToken msgs)]
           (println &quot;NEXT:&quot; next-token)
           (if (nil? next-token)
             (concat result (:messages msgs))
             (d/recur next-token (concat result (:messages msgs)))))))
      (d/catch 
          (fn [ex]
            (println &quot;ERROR&quot; ex)
            ex))))
</pre></z><z id="t1496430717" t="mping nvmind, found a bug"><y>#</y><d>2017-06-02</d><h>19:11</h><w>mping</w>nvmind, found a bug</z><z id="t1496430732" t="mping was missing an argument to d/recur troll"><y>#</y><d>2017-06-02</d><h>19:12</h><w>mping</w>was missing an argument to <code>d/recur</code> <b>troll</b></z><z id="t1496765505" t="dm3 hmm, interesting"><y>#</y><d>2017-06-06</d><h>16:11</h><w>dm3</w>hmm, interesting</z><z id="t1496765525" t="dm3 somehow fixed-thread-executor is not working as expected"><y>#</y><d>2017-06-06</d><h>16:12</h><w>dm3</w>somehow <code>fixed-thread-executor</code> is not working as expected</z><z id="t1496765539" t="dm3 i.e. as java.util.concurrent.Executors/newFixedThreadPool"><y>#</y><d>2017-06-06</d><h>16:12</h><w>dm3</w>i.e. as <code>java.util.concurrent.Executors/newFixedThreadPool</code></z><z id="t1496765613" t="dm3 [:attrs {:href &quot;/_/_/users/U591R8WBZ&quot;}] try (e/fixed-thread-executor num {:control-period 100})"><y>#</y><d>2017-06-06</d><h>16:13</h><w>dm3</w><a>@hansen-pansen</a> try <code>(e/fixed-thread-executor num {:control-period 100})</code></z><z id="t1496765637" t="dm3 your test duration coincided with the default control period of the executor"><y>#</y><d>2017-06-06</d><h>16:13</h><w>dm3</w>your test duration coincided with the default control period of the executor</z><z id="t1496765655" t="dm3 that‚Äôs how often the instrumented executor will adjust the number of workers in the pool"><y>#</y><d>2017-06-06</d><h>16:14</h><w>dm3</w>that‚Äôs how often the instrumented executor will adjust the number of workers in the pool</z><z id="t1496765694" t="dm3 there‚Äôs also :initial-thread-count parameter"><y>#</y><d>2017-06-06</d><h>16:14</h><w>dm3</w>there‚Äôs also <code>:initial-thread-count</code> parameter</z><z id="t1496766150" t="hansen-pansen Thank you very much! I&apos;ll give it a try and will also check with a snapshot build of manifold , in case this has been fixed."><y>#</y><d>2017-06-06</d><h>16:22</h><w>hansen-pansen</w>Thank you very much! I&apos;ll give it a try and will also check with a snapshot build of <code>manifold</code>, in case this has been fixed.</z><z id="t1496770296" t="hansen-pansen [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] Again, thank you very much! Both :control-period and :initial-thread-count showed the expected behavior. I settled for :initial-thread-count , as this is more consistent of what I would expect from a fixed thread pool. As a side note, [manifold &quot;0.1.7-alpha5&quot;] behaves like 0.1.6."><y>#</y><d>2017-06-06</d><h>17:31</h><w>hansen-pansen</w><a>@dm3</a> Again, thank you very much! Both <code>:control-period</code> and <code>:initial-thread-count</code> showed the expected behavior. I settled for <code>:initial-thread-count</code>, as this is more consistent of what I would expect from a fixed thread pool.
As a side note, <code>[manifold &quot;0.1.7-alpha5&quot;]</code> behaves like 0.1.6.</z><z id="t1496770966" t="dm3 I don‚Äôt think it should be fixed"><y>#</y><d>2017-06-06</d><h>17:42</h><w>dm3</w>I don‚Äôt think it should be fixed</z><z id="t1496770981" t="dm3 you might create a PR with enhanced docs though"><y>#</y><d>2017-06-06</d><h>17:43</h><w>dm3</w>you might create a PR with enhanced docs though</z><z id="t1496771001" t="dm3 although"><y>#</y><d>2017-06-06</d><h>17:43</h><w>dm3</w>although</z><z id="t1496771025" t="dm3 maybe fixed executor should have initial thread = num-threads from the start"><y>#</y><d>2017-06-06</d><h>17:43</h><w>dm3</w>maybe <code>fixed</code> executor should have initial thread = num-threads from the start</z><z id="t1496780715" t="mping hia"><y>#</y><d>2017-06-06</d><h>20:25</h><w>mping</w>hia</z><z id="t1496780759" t="mping Im having trouble using d/zip with `d/chain"><y>#</y><d>2017-06-06</d><h>20:25</h><w>mping</w>Im having trouble using <code>d/zip</code> with `d/chain</z><z id="t1496855129" t="hansen-pansen Ugh. Bumped into another thing in #aleph I do not understand. While ‚Äî thanks to [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] ‚Äî I could run manifold.deferred/future s in a custom thread pool, I now struggle to do the same via manifold.stream . I am using stream.onto to ‚Äúassign‚Äù the same thread pool to the stream. But the execution is serial."><y>#</y><d>2017-06-07</d><h>17:05</h><w>hansen-pansen</w>Ugh. Bumped into another thing in #aleph I do not understand. While ‚Äî thanks to <a>@dm3</a> ‚Äî I could run <code>manifold.deferred/future</code>s in a custom thread pool, I now struggle to do the same via <code>manifold.stream</code>. I am using <code>stream.onto</code> to ‚Äúassign‚Äù the same thread pool to the stream. But the execution is serial.</z><z id="t1496855384" t="hansen-pansen What I was expecting: the put! s finish immediately, and after one second I get 10 ‚ÄúReceived:‚Äù lines at once. What I get instead: The put! s finish immediately, and every second I get a ‚ÄúReceived:‚Äù line, taking 10 seconds in total. From https://github.com/ztellman/manifold/blob/master/docs/execution.md I understand that I do not need to put the sleep function into a future (as in my previous try with manifold.deferred )."><y>#</y><d>2017-06-07</d><h>17:09</h><w>hansen-pansen</w>What I was expecting: the <code>put!</code>s finish immediately, and after one second I get 10 ‚ÄúReceived:‚Äù lines at once. What I get instead: The <code>put!</code>s finish immediately, and every second I get a ‚ÄúReceived:‚Äù line, taking 10 seconds in total.
From <a href="https://github.com/ztellman/manifold/blob/master/docs/execution.md" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/execution.md</a> I understand that I do not need to put the <code>sleep</code> function into a future (as in my previous try with <code>manifold.deferred</code>).</z><z id="t1496857665" t="dm3 [:attrs {:href &quot;/_/_/users/U591R8WBZ&quot;}] you are supposed to respect backpressure when put! ting into a stream, i.e. (dotimes [_ num] @(s/put! x delay)) . Due to the stream x having a default buffer of size 1, the items will be put! and processed by the sleep function one at a time."><y>#</y><d>2017-06-07</d><h>17:47</h><w>dm3</w><a>@hansen-pansen</a> you are supposed to respect backpressure when <code>put!</code>ting into a stream, i.e.
<code>(dotimes [_ num] @(s/put! x delay))</code>. Due to the stream <code>x</code> having a default buffer of size 1, the items will be <code>put!</code> and processed by the <code>sleep</code> function one at a time.</z><z id="t1496857679" t="dm3 there‚Äôs also put-all! for putting multiple items"><y>#</y><d>2017-06-07</d><h>17:47</h><w>dm3</w>there‚Äôs also <code>put-all!</code> for putting multiple items</z><z id="t1496857724" t="dm3 the stream callbacks will run on the supplied pool executor, but the operations on the stream will not be parallelized automatically"><y>#</y><d>2017-06-07</d><h>17:48</h><w>dm3</w>the stream callbacks will run on the supplied <code>pool</code> executor, but the operations on the stream will not be parallelized automatically</z><z id="t1496858064" t="hansen-pansen [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] Well, I tried to use a buffered-stream , too, but same result. If I would have all the inputs from the beginning, I would use -&gt;source or put-all! instead. But I am trying to use manifold for a queue/worker model, were inputs are generated from web requests."><y>#</y><d>2017-06-07</d><h>17:54</h><w>hansen-pansen</w><a>@dm3</a> Well, I tried to use a <code>buffered-stream</code>, too, but same result.
If I would have all the inputs from the beginning, I would use <code>-&gt;source</code> or <code>put-all!</code> instead. But I am trying to use <code>manifold</code> for a queue/worker model, were inputs are generated from web requests.</z><z id="t1496858226" t="dm3 that‚Äôs great"><y>#</y><d>2017-06-07</d><h>17:57</h><w>dm3</w>that‚Äôs great</z><z id="t1496858239" t="dm3 producer puts"><y>#</y><d>2017-06-07</d><h>17:57</h><w>dm3</w>producer puts</z><z id="t1496858241" t="dm3 consumer takes"><y>#</y><d>2017-06-07</d><h>17:57</h><w>dm3</w>consumer takes</z><z id="t1496858267" t="dm3 buffer size is the amount of requests depending on the max allowed latency"><y>#</y><d>2017-06-07</d><h>17:57</h><w>dm3</w>buffer size is the amount of requests depending on the max allowed latency</z><z id="t1496858474" t="ehashman [:attrs {:href &quot;/_/_/users/U591R8WBZ&quot;}] I believe what [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] is saying is that you will need to initialize x with a buffer, i.e. bind it to (s/stream 10) as opposed to (s/stream) (which only has a buffer for one item)"><y>#</y><d>2017-06-07</d><h>18:01</h><w>ehashman</w><a>@hansen-pansen</a> I believe what <a>@dm3</a> is saying is that you will need to initialize <code>x</code> with a buffer, i.e. bind it to <code>(s/stream 10)</code> as opposed to <code>(s/stream)</code> (which only has a buffer for one item)</z><z id="t1496858492" t="ehashman streams automatically deal with backpressure"><y>#</y><d>2017-06-07</d><h>18:01</h><w>ehashman</w>streams automatically deal with backpressure</z><z id="t1496858518" t="ehashman so they will not attempt to process additional items when they are blocking on the number of deferreds in the buffer"><y>#</y><d>2017-06-07</d><h>18:01</h><w>ehashman</w>so they will not attempt to process additional items when they are blocking on the number of deferreds in the buffer</z><z id="t1496858528" t="ehashman if the buffer is size 1, it will block on that one item"><y>#</y><d>2017-06-07</d><h>18:02</h><w>ehashman</w>if the buffer is size 1, it will block on that one item</z><z id="t1496858607" t="ehashman see also https://github.com/ztellman/manifold/blob/master/docs/stream.md#buffers-and-backpressure"><y>#</y><d>2017-06-07</d><h>18:03</h><w>ehashman</w>see also <a href="https://github.com/ztellman/manifold/blob/master/docs/stream.md#buffers-and-backpressure" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/stream.md#buffers-and-backpressure</a></z><z id="t1496858624" t="hansen-pansen [:attrs {:href &quot;/_/_/users/U0MPXFNLE&quot;}] This is what I also tried, but it&apos;s not depicted in above example. I used x (stream/buffered-stream num) , so all put! s should should ‚Äúget through‚Äù."><y>#</y><d>2017-06-07</d><h>18:03</h><w>hansen-pansen</w><a>@ehashman</a> This is what I also tried, but it&apos;s not depicted in above example. I used <code>x (stream/buffered-stream num)</code>, so all <code>put!</code>s should should ‚Äúget through‚Äù.</z><z id="t1496858738" t="hansen-pansen Also: my put! s did not block."><y>#</y><d>2017-06-07</d><h>18:05</h><w>hansen-pansen</w>Also: my <code>put!</code>s did not block.</z><z id="t1496858757" t="dm3 you have to deref the put!"><y>#</y><d>2017-06-07</d><h>18:05</h><w>dm3</w>you have to deref the put!</z><z id="t1496858799" t="hansen-pansen BAAM This could be the thing!"><y>#</y><d>2017-06-07</d><h>18:06</h><w>hansen-pansen</w>BAAM This could be the thing!</z><z id="t1496911924" t="hansen-pansen [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] [:attrs {:href &quot;/_/_/users/U0MPXFNLE&quot;}] Thank you very much for the hints and your continuous help! I again read the mentioned link (which, together with the codox documentation and the repository doc folder), is basically the only documentation I know of), and adapted my example with the (s/stream 10) . But it doesn‚Äôt change the result, and I believe I do not understand the concept, when and where callbacks are performed. I suspect that my sleep function does not get assigned to the pool thread pool via stream/map , or stream/consume plays a role."><y>#</y><d>2017-06-08</d><h>08:52</h><w>hansen-pansen</w><a>@dm3</a> <a>@ehashman</a> Thank you very much for the hints and your continuous help!
I again read the mentioned link (which, together with the codox documentation and the repository doc folder), is basically the only documentation I know of), and adapted my example with the <code>(s/stream 10)</code>. But it doesn‚Äôt change the result, and I believe I do not understand the concept, when and where callbacks are performed. I suspect that my <code>sleep</code> function does not get assigned to the <code>pool</code> thread pool via <code>stream/map</code>, or <code>stream/consume</code> plays a role.</z><z id="t1496912624" t="dm3 can you paste your whole program now?"><y>#</y><d>2017-06-08</d><h>09:03</h><w>dm3</w>can you paste your whole program now?</z><z id="t1496914118" t="hansen-pansen Sure, thank you."><y>#</y><d>2017-06-08</d><h>09:28</h><w>hansen-pansen</w>Sure, thank you.</z><z id="t1496914278" t="dm3 and what do you expect should happen in the above?"><y>#</y><d>2017-06-08</d><h>09:31</h><w>dm3</w>and what do you expect should happen in the above?</z><z id="t1496914366" t="hansen-pansen 1. Sending ‚Ä¶ and ‚Ä¶ finished. appear immediately (i.e., a batch of put! s do not block) 2. After one second, I see 10 Slept 1000 ms"><y>#</y><d>2017-06-08</d><h>09:32</h><w>hansen-pansen</w>1. Sending ‚Ä¶ and ‚Ä¶ finished. appear immediately (i.e., a batch of <code>put!</code>s do not block)
2. After one second, I see 10 Slept 1000 ms</z><z id="t1496914502" t="hansen-pansen I suspect the stream/consume blocks the pool."><y>#</y><d>2017-06-08</d><h>09:35</h><w>hansen-pansen</w>I suspect the <code>stream/consume</code> blocks the pool.</z><z id="t1496914646" t="dm3 hm, it works as I‚Äôd expect locally (with 0.1.7-alpha)"><y>#</y><d>2017-06-08</d><h>09:37</h><w>dm3</w>hm, it works as I‚Äôd expect locally (with 0.1.7-alpha)</z><z id="t1496914690" t="dm3 puts return immediately when x is buffered - (s/stream 10)"><y>#</y><d>2017-06-08</d><h>09:38</h><w>dm3</w>puts return immediately when <code>x</code> is buffered - <code>(s/stream 10)</code></z><z id="t1496914703" t="dm3 then sleep gets called every second 10 times"><y>#</y><d>2017-06-08</d><h>09:38</h><w>dm3</w>then <code>sleep</code> gets called every second 10 times</z><z id="t1496914722" t="hansen-pansen Well, expectation 1 was met üôÇ"><y>#</y><d>2017-06-08</d><h>09:38</h><w>hansen-pansen</w>Well, expectation 1 was met <b>üôÇ</b></z><z id="t1496914729" t="hansen-pansen I‚Äôll try with the alpha right now‚Ä¶"><y>#</y><d>2017-06-08</d><h>09:38</h><w>hansen-pansen</w>I‚Äôll try with the alpha right now‚Ä¶</z><z id="t1496914796" t="hansen-pansen Nope, not for me. Clojure 1.8 or 1.9 alpha?"><y>#</y><d>2017-06-08</d><h>09:39</h><w>hansen-pansen</w>Nope, not for me. Clojure 1.8 or 1.9 alpha?</z><z id="t1496914809" t="dm3 boot.user=&gt; (def a (s/stream 10)) #&apos;boot.user/a boot.user=&gt; (def pool (manifold.executor/fixed-thread-executor 10 {:initial-thread-count 10})) #&apos;boot.user/pool boot.user=&gt; (s/consume #(println &quot;Got&quot; %) (s/map sleep (s/onto pool a))) &lt;&lt; ‚Ä¶ &gt;&gt; boot.user=&gt; (do (println &quot;Started&quot; (java.util.Date.)) (dotimes [_ 10] @(s/put! a 1000)) (println &quot;Done&quot; (java.util.Date.))) "><y>#</y><d>2017-06-08</d><h>09:40</h><w>dm3</w><pre>boot.user=&gt; (def a (s/stream 10))
#&apos;boot.user/a
boot.user=&gt; (def pool (manifold.executor/fixed-thread-executor 10 {:initial-thread-count 10}))
#&apos;boot.user/pool
boot.user=&gt; (s/consume #(println &quot;Got&quot; %) (s/map sleep (s/onto pool a)))
&lt;&lt; ‚Ä¶ &gt;&gt;
boot.user=&gt; (do (println &quot;Started&quot; (java.util.Date.)) (dotimes [_ 10] @(s/put! a 1000)) (println &quot;Done&quot; (java.util.Date.)))
</pre></z><z id="t1496914824" t="dm3 I mean manifold 0.1.7-alpha5"><y>#</y><d>2017-06-08</d><h>09:40</h><w>dm3</w>I mean manifold 0.1.7-alpha5</z><z id="t1496914892" t="hansen-pansen I know. I tried manifold 0.1.7 alpha, but see ‚Äúmy‚Äù behaviour. That‚Äôs why I also asked for the Clojure version. I will try with your version. Right now, I am a leiningen, no boot, user. Just a sec."><y>#</y><d>2017-06-08</d><h>09:41</h><w>hansen-pansen</w>I know. I tried manifold 0.1.7 alpha, but see ‚Äúmy‚Äù behaviour. That‚Äôs why I also asked for the Clojure version. I will try with your version. Right now, I am a leiningen, no boot, user. Just a sec.</z><z id="t1496914906" t="dm3 clojure/lein/boot don‚Äôt matter"><y>#</y><d>2017-06-08</d><h>09:41</h><w>dm3</w>clojure/lein/boot don‚Äôt matter</z><z id="t1496914931" t="hansen-pansen I know / hope. But I want to try your exact snippet."><y>#</y><d>2017-06-08</d><h>09:42</h><w>hansen-pansen</w>I know / hope. But I want to try your exact snippet.</z><z id="t1496914931" t="dm3 also the behaviour should be consistent between Manifold 0.1.5-0.1.7"><y>#</y><d>2017-06-08</d><h>09:42</h><w>dm3</w>also the behaviour should be consistent between Manifold 0.1.5-0.1.7</z><z id="t1496915912" t="hansen-pansen I try it out, I need to head out for lunch. Sorry, this is not very respectful from me."><y>#</y><d>2017-06-08</d><h>09:58</h><w>hansen-pansen</w>I try it out, I need to head out for lunch. Sorry, this is not very respectful from me.</z><z id="t1496916045" t="dm3 no problem üôÇ it‚Äôs asynchronous"><y>#</y><d>2017-06-08</d><h>10:00</h><w>dm3</w>no problem <b>üôÇ</b> it‚Äôs asynchronous</z><z id="t1496924249" t="hansen-pansen üòÇ Yes, that‚Äôs truly asynchronous."><y>#</y><d>2017-06-08</d><h>12:17</h><w>hansen-pansen</w><b>üòÇ</b> Yes, that‚Äôs truly asynchronous.</z><z id="t1496924350" t="hansen-pansen I think I should re-phrase expectation 2: I expect that after 1 second I see all 10 Got or Slept ‚Ä¶ at once, as those 10 sleeps get executed in parallel."><y>#</y><d>2017-06-08</d><h>12:19</h><w>hansen-pansen</w>I think I should re-phrase expectation 2: I expect that after 1 second I see all 10 Got or Slept ‚Ä¶ at once, as those 10 sleeps get executed in parallel.</z><z id="t1496924423" t="hansen-pansen Instead, I see every second a Got and Slept ‚Ä¶, which in total takes 10 seconds, as they run sequentially."><y>#</y><d>2017-06-08</d><h>12:20</h><w>hansen-pansen</w>Instead, I see every second a Got and Slept ‚Ä¶, which in total takes 10 seconds, as they run sequentially.</z><z id="t1496924439" t="dm3 yes, that‚Äôs how the stream is consumed - sequentially"><y>#</y><d>2017-06-08</d><h>12:20</h><w>dm3</w>yes, that‚Äôs how the stream is consumed - sequentially</z><z id="t1496924467" t="dm3 there‚Äôs no parallel-consume in manifold"><y>#</y><d>2017-06-08</d><h>12:21</h><w>dm3</w>there‚Äôs no <code>parallel-consume</code> in manifold</z><z id="t1496924505" t="hansen-pansen My assumption was that when the stream is consumed, the sleep get‚Äôs pushed to the worker pool, immediately fetching the next, putting in the pool etc."><y>#</y><d>2017-06-08</d><h>12:21</h><w>hansen-pansen</w>My assumption was that when the stream is consumed, the sleep get‚Äôs pushed to the worker pool, immediately fetching the next, putting in the pool etc.</z><z id="t1496924536" t="dm3 no, although I can see how that would be a valid assumption"><y>#</y><d>2017-06-08</d><h>12:22</h><w>dm3</w>no, although I can see how that would be a valid assumption</z><z id="t1496924628" t="hansen-pansen Okay, then I should build a loop that take! s from the stream, create a manifold.deferred pool (which I tried a while ago, where you helped me, too.)"><y>#</y><d>2017-06-08</d><h>12:23</h><w>hansen-pansen</w>Okay, then I should build a loop that <code>take!</code>s from the stream, create a <code>manifold.deferred</code> pool (which I tried a while ago, where you helped me, too.)</z><z id="t1496924699" t="dm3 I‚Äôm not sure how you want to signal backpressure to the source"><y>#</y><d>2017-06-08</d><h>12:24</h><w>dm3</w>I‚Äôm not sure how you want to signal backpressure to the source</z><z id="t1496924725" t="dm3 you can have a token system where you take! as many times as you have free workers"><y>#</y><d>2017-06-08</d><h>12:25</h><w>dm3</w>you can have a token system where you <code>take!</code> as many times as you have free workers</z><z id="t1496924763" t="hansen-pansen Yes, this is why I initially went to manifold . I assumed the stream would block, when the thread-pool is full, and therefore couldn‚Äôt consume immediately."><y>#</y><d>2017-06-08</d><h>12:26</h><w>hansen-pansen</w>Yes, this is why I initially went to <code>manifold</code>. I assumed the stream would block, when the thread-pool is full, and therefore couldn‚Äôt <code>consume</code> immediately.</z><z id="t1496924829" t="hansen-pansen So I completely misunderstood the idea of the executor on the stream. I must admit, I don‚Äôt see a reason at all right now for it."><y>#</y><d>2017-06-08</d><h>12:27</h><w>hansen-pansen</w>So I completely misunderstood the idea of the executor on the stream. I must admit, I don‚Äôt see a reason at all right now for it.</z><z id="t1496924869" t="dm3 it‚Äôs there to control where the execution happens"><y>#</y><d>2017-06-08</d><h>12:27</h><w>dm3</w>it‚Äôs there to control where the execution happens</z><z id="t1496924888" t="hansen-pansen Should I put a deferred (like (future sleep) ) onto the stream?"><y>#</y><d>2017-06-08</d><h>12:28</h><w>hansen-pansen</w>Should I put a deferred (like <code>(future sleep)</code>) onto the stream?</z><z id="t1496925430" t="dm3 one sec"><y>#</y><d>2017-06-08</d><h>12:37</h><w>dm3</w>one sec</z><z id="t1496926383" t="hansen-pansen Sure."><y>#</y><d>2017-06-08</d><h>12:53</h><w>hansen-pansen</w>Sure.</z><z id="t1496927790" t="dm3 consume-parallel is trickier than I thought üôÇ"><y>#</y><d>2017-06-08</d><h>13:16</h><w>dm3</w>consume-parallel is trickier than I thought <b>üôÇ</b></z><z id="t1496928163" t="hansen-pansen I think I will just move back to core.async/pipeline-blocking ."><y>#</y><d>2017-06-08</d><h>13:22</h><w>hansen-pansen</w>I think I will just move back to <code>core.async/pipeline-blocking</code>.</z><z id="t1496928208" t="dm3 what‚Äôs your end goal? process items from the stream in parallel?"><y>#</y><d>2017-06-08</d><h>13:23</h><w>dm3</w>what‚Äôs your end goal? process items from the stream in parallel?</z><z id="t1496928224" t="dm3 or partition the stream into N streams?"><y>#</y><d>2017-06-08</d><h>13:23</h><w>dm3</w>or partition the stream into N streams?</z><z id="t1496928490" t="hansen-pansen Exactly. I have a function a that gets called via a web service irregularly, which returns a value. This value has to be processed with another function b that triggers an HTTP request and some computation. I want to decouple a from b. My idea is that a feeds that value into a stream, and at the sink a worker pool performs b in parallel, and putting the result onto another stream."><y>#</y><d>2017-06-08</d><h>13:28</h><w>hansen-pansen</w>Exactly. I have a function a that gets called via a web service irregularly, which returns a value. This value has to be processed with another function b that triggers an HTTP request and some computation. I want to decouple a from b. My idea is that a feeds that value into a stream, and at the sink a worker pool performs b in parallel, and putting the result onto another stream.</z><z id="t1496928510" t="hansen-pansen So your first suggestion."><y>#</y><d>2017-06-08</d><h>13:28</h><w>hansen-pansen</w>So your first suggestion.</z><z id="t1496930820" t="hansen-pansen Interesting. (s/consume) is definitely the ‚Äúblocker‚Äù here. Even if I map a future on the stream, deref ing the future blocks the rest. If I consume, but do not deref , everything runs in parallel."><y>#</y><d>2017-06-08</d><h>14:07</h><w>hansen-pansen</w>Interesting. <code>(s/consume)</code> is definitely the ‚Äúblocker‚Äù here. Even if I map a future on the stream, <code>deref</code>ing the future blocks the rest. If I consume, but do not <code>deref</code>, everything runs in parallel.</z><z id="t1496931536" t="dm3 I couldn‚Äôt figure out how to make the parallelization work on the onto thread pool"><y>#</y><d>2017-06-08</d><h>14:18</h><w>dm3</w>I couldn‚Äôt figure out how to make the parallelization work on the <code>onto</code> thread pool</z><z id="t1496931865" t="dm3 actually I have something üôÇ"><y>#</y><d>2017-06-08</d><h>14:24</h><w>dm3</w>actually I have something <b>üôÇ</b></z><z id="t1496932094" t="dm3 (require &apos;[manifold.stream :as s]) (require &apos;[manifold.deferred :as d]) (require &apos;[manifold.executor :as ex]) (defn round-robin-fork [src n] (let [dsts (take n (repeatedly s/stream)) ^java.util.concurrent.BlockingQueue ready (doto (java.util.concurrent.ArrayBlockingQueue. n) (.addAll dsts)) free-up! #(.offer ready %) next! #(.take ready) send! #(-&gt; (s/put! %1 %2) (d/chain (fn [result] (if result (free-up! %1) (s/close! %1)))))] (d/loop [dst (.take ready)] (-&gt; (s/take! src ::none) (d/chain (fn [result] (if (= result ::none) (doseq [d dsts] (s/close! d)) (do (future (send! dst result)) (d/chain (next!) #(d/recur %)))))))) dsts)) ;; Test (def s (s/stream)) (def ss (round-robin-fork s 10)) (doseq [[idx s] (map-indexed vector ss)] (s/consume #(let [sleep (rand-int 1000)] (Thread/sleep sleep) (println (Thread/currentThread) &quot;DST [&quot; idx &quot;] slept for &quot; sleep &quot; ms, got: &quot; %)) s)) (dotimes [i 20] (println &quot;putting &quot; i) @(s/put! s i)) "><y>#</y><d>2017-06-08</d><h>14:28</h><w>dm3</w><pre>(require &apos;[manifold.stream :as s])
(require &apos;[manifold.deferred :as d])
(require &apos;[manifold.executor :as ex])

(defn round-robin-fork
  [src n]
  (let [dsts (take n (repeatedly s/stream))
        ^java.util.concurrent.BlockingQueue ready
        (doto (java.util.concurrent.ArrayBlockingQueue. n)
          (.addAll dsts))

        free-up! #(.offer ready %)
        next! #(.take ready)
        send! #(-&gt; (s/put! %1 %2)
                   (d/chain
                     (fn [result]
                       (if result
                         (free-up! %1)
                         (s/close! %1)))))]
    (d/loop [dst (.take ready)]
      (-&gt; (s/take! src ::none)
          (d/chain
            (fn [result]
              (if (= result ::none)
                (doseq [d dsts]
                  (s/close! d))
                (do (future (send! dst result))
                    (d/chain (next!)
                      #(d/recur %))))))))
    dsts))

;; Test
(def s (s/stream))
(def ss (round-robin-fork s 10))

(doseq [[idx s] (map-indexed vector ss)]
  (s/consume
    #(let [sleep (rand-int 1000)]
       (Thread/sleep sleep)
       (println (Thread/currentThread) &quot;DST [&quot; idx &quot;] slept for &quot; sleep &quot; ms, got: &quot; %))
    s))

(dotimes [i 20]
  (println  &quot;putting &quot; i)
  @(s/put! s i))
</pre></z><z id="t1496932104" t="dm3 However the work here is performed on the default future executor"><y>#</y><d>2017-06-08</d><h>14:28</h><w>dm3</w>However the work here is performed on the default <code>future</code> executor</z><z id="t1496932132" t="dm3 however you could pass a pool as a third argument"><y>#</y><d>2017-06-08</d><h>14:28</h><w>dm3</w>however you could pass a <code>pool</code> as a third argument</z><z id="t1496932137" t="hansen-pansen You rock!"><y>#</y><d>2017-06-08</d><h>14:28</h><w>hansen-pansen</w>You rock!</z><z id="t1496932138" t="dm3 and use it in future-with"><y>#</y><d>2017-06-08</d><h>14:28</h><w>dm3</w>and use it in <code>future-with</code></z><z id="t1496932259" t="dm3 the name is from the previous iteration, should probably be just fork"><y>#</y><d>2017-06-08</d><h>14:30</h><w>dm3</w>the name is from the previous iteration, should probably be just <code>fork</code></z><z id="t1496932335" t="dm3 also if you do onto and use the same executor to run the tasks inside fork - the thing will deadlock somewhere - not sure where"><y>#</y><d>2017-06-08</d><h>14:32</h><w>dm3</w>also if you do <code>onto</code> and use the same executor to run the tasks inside <code>fork</code> - the thing will deadlock somewhere - not sure where</z><z id="t1497128875" t="weavejester Is there any documentation on which response body types are accepted by Aleph?"><y>#</y><d>2017-06-10</d><h>21:07</h><w>weavejester</w>Is there any documentation on which response body types are accepted by Aleph?</z><z id="t1497218063" t="danielcompton [:attrs {:href &quot;/_/_/users/U0BKWMG5B&quot;}] not sure exactly, but Yada leans heavily on Aleph, it has https://github.com/juxt/yada/blob/master/src/yada/body.clj which might give an indication"><y>#</y><d>2017-06-11</d><h>21:54</h><w>danielcompton</w><a>@weavejester</a> not sure exactly, but Yada leans heavily on Aleph, it has <a href="https://github.com/juxt/yada/blob/master/src/yada/body.clj" target="_blank">https://github.com/juxt/yada/blob/master/src/yada/body.clj</a> which might give an indication</z><z id="t1497218835" t="weavejester [:attrs {:href &quot;/_/_/users/U051KLSJF&quot;}] Thanks! Since asking I‚Äôve found another solution, though."><y>#</y><d>2017-06-11</d><h>22:07</h><w>weavejester</w><a>@danielcompton</a> Thanks! Since asking I‚Äôve found another solution, though.</z><z id="t1497219018" t="danielcompton What did you find? I&apos;ve wondered the same"><y>#</y><d>2017-06-11</d><h>22:10</h><w>danielcompton</w>What did you find? I&apos;ve wondered the same</z><z id="t1497219081" t="weavejester [:attrs {:href &quot;/_/_/users/U051KLSJF&quot;}] I was trying to patch in support for Ring 1.6.0&apos;s StreamableResponseBody protocol."><y>#</y><d>2017-06-11</d><h>22:11</h><w>weavejester</w><a>@danielcompton</a> I was trying to patch in support for Ring 1.6.0&apos;s StreamableResponseBody protocol.</z><z id="t1497219120" t="weavejester But I‚Äôve found a custom protocol works better anyway, and works for Ring 1.5 as well."><y>#</y><d>2017-06-11</d><h>22:12</h><w>weavejester</w>But I‚Äôve found a custom protocol works better anyway, and works for Ring 1.5 as well.</z><z id="t1498997686" t="dottedmag Is there a way to apply backpressure to the WebSocket handler in Aleph? I have a network server, and one kind of network messages it serves is bottlenecked on a shared resource. I&apos;d like to make sure the producers of WebSocket messages are paused somehow when the server is not keeping up with the demand."><y>#</y><d>2017-07-02</d><h>12:14</h><w>dottedmag</w>Is there a way to apply backpressure to the WebSocket handler in Aleph? I have a network server, and one kind of network messages it serves is bottlenecked on a shared resource. I&apos;d like to make sure the producers of WebSocket messages are paused somehow when the server is not keeping up with the demand.</z><z id="t1498997749" t="dottedmag The protocol is &quot;fire-and-forget&quot;, and I can&apos;t change it, so there is not much possibility to do a backpressure on protocol level, so it has to be something lower-level, e.g. TCP backpressure."><y>#</y><d>2017-07-02</d><h>12:15</h><w>dottedmag</w>The protocol is &quot;fire-and-forget&quot;, and I can&apos;t change it, so there is not much possibility to do a backpressure on protocol level, so it has to be something lower-level, e.g. TCP backpressure.</z><z id="t1498997905" t="dottedmag I don&apos;t care about proxies, as it&apos;s a server-to-server communication with no proxies in between."><y>#</y><d>2017-07-02</d><h>12:18</h><w>dottedmag</w>I don&apos;t care about proxies, as it&apos;s a server-to-server communication with no proxies in between.</z><z id="t1499002781" t="dm3 [:attrs {:href &quot;/_/_/users/U07HVGQJ3&quot;}] , taking Aleph out of the equation, what is your expected outcome in the client-server interaction when the server can‚Äôt handle the load? What does fire-and-forget mean - does the client not wait for any response?"><y>#</y><d>2017-07-02</d><h>13:39</h><w>dm3</w><a>@dottedmag</a>, taking Aleph out of the equation, what is your expected outcome in the client-server interaction when the server can‚Äôt handle the load? What does fire-and-forget mean - does the client not wait for any response?</z><z id="t1499006071" t="dottedmag [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] The expected outcome is that clients slow down until the server can handle the load. Clients do not wait for a WebSocket-level response, but every client uses only one WebSocket connection for communication."><y>#</y><d>2017-07-02</d><h>14:34</h><w>dottedmag</w><a>@dm3</a> The expected outcome is that clients slow down until the server can handle the load. Clients do not wait for a WebSocket-level response, but every client uses only one WebSocket connection for communication.</z><z id="t1499006579" t="dottedmag If I were starting from scratch, I&apos;d do something like this: a bounded small queue, one thread reading from it and working on a shared resource, request handlers in a pool submitting jobs to this queue synchronously. If a queue is full, request handlers block, and no data is read from the network sockets."><y>#</y><d>2017-07-02</d><h>14:42</h><w>dottedmag</w>If I were starting from scratch, I&apos;d do something like this: a bounded small queue, one thread reading from it and working on a shared resource, request handlers in a pool submitting jobs to this queue synchronously. If a queue is full, request handlers block, and no data is read from the network sockets.</z><z id="t1499006621" t="dottedmag However I&apos;d like to have other kinds of requests, not bottlenecked on this shared resource, to proceed."><y>#</y><d>2017-07-02</d><h>14:43</h><w>dottedmag</w>However I&apos;d like to have other kinds of requests, not bottlenecked on this shared resource, to proceed.</z><z id="t1499008703" t="dm3 I‚Äôm afraid I don‚Äôt know enough about Aleph to help here. I‚Äôd try to separate the handlers serving the two types of clients (bottlenecked/non-bottlenecked) though so that you don‚Äôt have to solve this problem generically."><y>#</y><d>2017-07-02</d><h>15:18</h><w>dm3</w>I‚Äôm afraid I don‚Äôt know enough about Aleph to help here. I‚Äôd try to separate the handlers serving the two types of clients (bottlenecked/non-bottlenecked) though so that you don‚Äôt have to solve this problem generically.</z><z id="t1499009585" t="dottedmag I can do that once the connection is established ‚Äì the first message carries the kind of connection. But I don&apos;t think I have an option to say to Aleph &quot;from now on use this pool to handle the WebSocket messages from this connection&quot;"><y>#</y><d>2017-07-02</d><h>15:33</h><w>dottedmag</w>I can do that once the connection is established ‚Äì the first message carries the kind of connection. But I don&apos;t think I have an option to say to Aleph &quot;from now on use this pool to handle the WebSocket messages from this connection&quot;</z><z id="t1499009592" t="dottedmag All right, I&apos;ll go dig into source code a little."><y>#</y><d>2017-07-02</d><h>15:33</h><w>dottedmag</w>All right, I&apos;ll go dig into source code a little.</z><z id="t1499010158" t="dm3 on the Manifold side you have stream/onto which will put all of the callbacks onto the specified pool"><y>#</y><d>2017-07-02</d><h>15:42</h><w>dm3</w>on the Manifold side you have <code>stream/onto</code> which will put all of the callbacks onto the specified pool</z><z id="t1499010184" t="dm3 however that‚Äôs probably not what you are looking for"><y>#</y><d>2017-07-02</d><h>15:43</h><w>dm3</w>however that‚Äôs probably not what you are looking for</z><z id="t1499018005" t="dottedmag Actually it might be the thing I&apos;m looking for."><y>#</y><d>2017-07-02</d><h>17:53</h><w>dottedmag</w>Actually it might be the thing I&apos;m looking for.</z><z id="t1499018011" t="dottedmag [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] Thanks, I&apos;ll give it a try."><y>#</y><d>2017-07-02</d><h>17:53</h><w>dottedmag</w><a>@dm3</a> Thanks, I&apos;ll give it a try.</z><z id="t1499558593" t="lvh How does cookie support for aleph work? It looks like the answer might be ‚Äúnot at all‚Äù ‚Äî there used to be support, sorta, but it apparently got removed? https://github.com/muhuk/aleph-middleware/blob/master/src/aleph/middleware/cookies.clj looks like it‚Äôs for servers"><y>#</y><d>2017-07-09</d><h>00:03</h><w>lvh</w>How does cookie support for aleph work? It looks like the answer might be ‚Äúnot at all‚Äù ‚Äî there used to be support, sorta, but it apparently got removed? <a href="https://github.com/muhuk/aleph-middleware/blob/master/src/aleph/middleware/cookies.clj" target="_blank">https://github.com/muhuk/aleph-middleware/blob/master/src/aleph/middleware/cookies.clj</a> looks like it‚Äôs for servers</z><z id="t1499639177" t="danielcompton [:attrs {:href &quot;/_/_/users/U07QKGF9P&quot;}] are you looking for cookie support for clients or servers?"><y>#</y><d>2017-07-09</d><h>22:26</h><w>danielcompton</w><a>@lvh</a> are you looking for cookie support for clients or servers?</z><z id="t1499639201" t="lvh clients"><y>#</y><d>2017-07-09</d><h>22:26</h><w>lvh</w>clients</z><z id="t1499641173" t="danielcompton It looks like the client also supports middleware, https://github.com/ztellman/aleph/blob/master/src/aleph/http/client_middleware.clj , so you can probably add something yourself. From https://github.com/ztellman/aleph/blob/8dd2e7a7a6ac07b8a79809c6ef4ffb5f960be02d/README.md#http &gt; While Aleph attempts to mimic the clj-http API and capabilities fully, it does not currently support multipart requests, cookie stores, or proxy servers."><y>#</y><d>2017-07-09</d><h>22:59</h><w>danielcompton</w>It looks like the client also supports middleware, <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/http/client_middleware.clj" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/http/client_middleware.clj</a>, so you can probably add something yourself. From <a href="https://github.com/ztellman/aleph/blob/8dd2e7a7a6ac07b8a79809c6ef4ffb5f960be02d/README.md#http" target="_blank">https://github.com/ztellman/aleph/blob/8dd2e7a7a6ac07b8a79809c6ef4ffb5f960be02d/README.md#http</a>

&gt; While Aleph attempts to mimic the clj-http API and capabilities fully, it does not currently support multipart requests, cookie stores, or proxy servers.</z><z id="t1499875533" t="mhjort If I have a Deferred what is the recommended way to &quot;convert&quot; it to core.async channel?"><y>#</y><d>2017-07-12</d><h>16:05</h><w>mhjort</w>If I have a Deferred what is the recommended way to &quot;convert&quot; it to core.async channel?</z><z id="t1499876208" t="dm3 (go @deferred) ? But be aware if the deferred is blocked on IO"><y>#</y><d>2017-07-12</d><h>16:16</h><w>dm3</w><code>(go @deferred)</code>? But be aware if the deferred is blocked on IO</z><z id="t1499876552" t="mhjort Aah, of course. How would that work in case of Manifold stream?"><y>#</y><d>2017-07-12</d><h>16:22</h><w>mhjort</w>Aah, of course. How would that work in case of Manifold stream?</z><z id="t1499876827" t="dm3 (let [chan (async/chan)] (m.s/consume #(async/put! chan %) stream)) "><y>#</y><d>2017-07-12</d><h>16:27</h><w>dm3</w><pre>(let [chan (async/chan)]
  (m.s/consume #(async/put! chan %) stream))
</pre></z><z id="t1499878338" t="mhjort That solves the incoming part. What about outgoing? I have a duplex stream"><y>#</y><d>2017-07-12</d><h>16:52</h><w>mhjort</w>That solves the incoming part. What about outgoing? I have a duplex stream</z><z id="t1499878460" t="dm3 You can simply convert via (m.s/-&gt;source chan)"><y>#</y><d>2017-07-12</d><h>16:54</h><w>dm3</w>You can simply convert via <code>(m.s/-&gt;source chan)</code></z><z id="t1499878516" t="dm3 be aware that with async/put! method above there‚Äôs no backpressure so the chan might be overwhelmed (depending on the buffer used)"><y>#</y><d>2017-07-12</d><h>16:55</h><w>dm3</w>be aware that with <code>async/put!</code> method above there‚Äôs no backpressure so the <code>chan</code> might be overwhelmed (depending on the buffer used)</z><z id="t1499878592" t="dm3 you‚Äôd probably want to use stream/consume-async and put! with more options to respect backpressure/closing of chan"><y>#</y><d>2017-07-12</d><h>16:56</h><w>dm3</w>you‚Äôd probably want to use <code>stream/consume-async</code> and <code>put!</code> with more options to respect backpressure/closing of chan</z><z id="t1499878596" t="dm3 https://clojure.github.io/core.async/#clojure.core.async/put !"><y>#</y><d>2017-07-12</d><h>16:56</h><w>dm3</w><a href="https://clojure.github.io/core.async/#clojure.core.async/put" target="_blank">https://clojure.github.io/core.async/#clojure.core.async/put</a>!</z><z id="t1499879519" t="mhjort Thanks. My case is following. I am going to use Aleph for tcp server and client. However, I would like to work with core.async channels instead of Manifold streams. "><y>#</y><d>2017-07-12</d><h>17:11</h><w>mhjort</w>Thanks. My case is following. I am going to use Aleph for tcp server and client. However, I would like to work with core.async channels instead of Manifold streams. 
</z><z id="t1500070341" t="spangler I have been wrestling with some kind of memory/reference leak using Aleph and JanusGraph in tandem"><y>#</y><d>2017-07-14</d><h>22:12</h><w>spangler</w>I have been wrestling with some kind of memory/reference leak using Aleph and JanusGraph in tandem</z><z id="t1500070353" t="spangler It looks like Aleph works fine on its own, and Janus works fine on its own"><y>#</y><d>2017-07-14</d><h>22:12</h><w>spangler</w>It looks like Aleph works fine on its own, and Janus works fine on its own</z><z id="t1500070375" t="spangler but when combined, memory increases without bounds"><y>#</y><d>2017-07-14</d><h>22:12</h><w>spangler</w>but when combined, memory increases without bounds</z><z id="t1500070391" t="spangler I have done some research and it looks like part of the problem is that Janus transactions are thread specific"><y>#</y><d>2017-07-14</d><h>22:13</h><w>spangler</w>I have done some research and it looks like part of the problem is that Janus transactions are thread specific</z><z id="t1500070408" t="spangler So, if a transaction is opened on a thread, it must be closed on that same thread"><y>#</y><d>2017-07-14</d><h>22:13</h><w>spangler</w>So, if a transaction is opened on a thread, it must be closed on that same thread</z><z id="t1500070503" t="spangler I&apos;m wondering how do I even debug this problem?"><y>#</y><d>2017-07-14</d><h>22:15</h><w>spangler</w>I&apos;m wondering how do I even debug this problem?</z><z id="t1500070564" t="spangler For instance, I am doing this (stream/on-drained source (fn [] (log/debug &quot;query complete&quot;) (db/commit graph) (db/rollback graph))) "><y>#</y><d>2017-07-14</d><h>22:16</h><w>spangler</w>For instance, I am doing this <pre>(stream/on-drained
     source
     (fn []
       (log/debug &quot;query complete&quot;)
       (db/commit graph)
       (db/rollback graph)))
</pre></z><z id="t1500070593" t="spangler But how do I guarantee this function is being called on the same thread that the transaction was opened on?"><y>#</y><d>2017-07-14</d><h>22:16</h><w>spangler</w>But how do I guarantee this function is being called on the same thread that the transaction was opened on?</z><z id="t1500070625" t="spangler Do the on-drained callbacks always get called from the same thread that the handler is using?"><y>#</y><d>2017-07-14</d><h>22:17</h><w>spangler</w>Do the <code>on-drained</code> callbacks always get called from the same thread that the handler is using?</z><z id="t1500070645" t="spangler If not, how do I ensure they do?"><y>#</y><d>2017-07-14</d><h>22:17</h><w>spangler</w>If not, how do I ensure they do?</z><z id="t1500073832" t="danielcompton [:attrs {:href &quot;/_/_/users/U0CHY4VNW&quot;}] I&apos;m not exactly sure, but http://aleph.io/manifold/execution.html might be helpful"><y>#</y><d>2017-07-14</d><h>23:10</h><w>danielcompton</w><a>@spangler</a> I&apos;m not exactly sure, but <a href="http://aleph.io/manifold/execution.html" target="_blank">http://aleph.io/manifold/execution.html</a> might be helpful</z><z id="t1500073877" t="danielcompton http://docs.janusgraph.org/latest/tx.html"><y>#</y><d>2017-07-14</d><h>23:11</h><w>danielcompton</w><a href="http://docs.janusgraph.org/latest/tx.html" target="_blank">http://docs.janusgraph.org/latest/tx.html</a></z><z id="t1500073897" t="danielcompton &gt; Almost all interaction with JanusGraph is associated with a transaction. JanusGraph transactions are safe for concurrent use by multiple threads. Methods on a JanusGraph instance like graph.v(...) and graph.commit() perform a ThreadLocal lookup to retrieve or create a transaction associated with the calling thread. Callers can alternatively forego ThreadLocal transaction management in favor of calling graph.newTransaction(), which returns a reference to a transaction object with methods to read/write graph data and commit or rollback. I think that might be what you need to do?"><y>#</y><d>2017-07-14</d><h>23:11</h><w>danielcompton</w>&gt; Almost all interaction with JanusGraph is associated with a transaction. JanusGraph transactions are safe for concurrent use by multiple threads. Methods on a JanusGraph instance like graph.v(...) and graph.commit() perform a ThreadLocal lookup to retrieve or create a transaction associated with the calling thread. Callers can alternatively forego ThreadLocal transaction management in favor of calling graph.newTransaction(), which returns a reference to a transaction object with methods to read/write graph data and commit or rollback.

I think that might be what you need to do?</z><z id="t1500074321" t="spangler [:attrs {:href &quot;/_/_/users/U051KLSJF&quot;}] Thank you! I now have some leads to follow. I will report back work how it turns out."><y>#</y><d>2017-07-14</d><h>23:18</h><w>spangler</w><a>@danielcompton</a> Thank you! I now have some leads to follow. I will report back work how it turns out.</z><z id="t1500074956" t="spangler So do you know if in general the ondrained callback is called in the same thread as the handler?"><y>#</y><d>2017-07-14</d><h>23:29</h><w>spangler</w>So do you know if in general the <code>ondrained</code> callback is called in the same thread as the handler?</z><z id="t1500074976" t="spangler I sort of assume not"><y>#</y><d>2017-07-14</d><h>23:29</h><w>spangler</w>I sort of assume not</z><z id="t1500097436" t="dm3 the thread executing callbacks is the same one doing stream/put!"><y>#</y><d>2017-07-15</d><h>05:43</h><w>dm3</w>the thread executing callbacks is the same one doing <code>stream/put!</code></z><z id="t1500097494" t="dm3 if the consumer is already waiting with a corresponding stream/take!"><y>#</y><d>2017-07-15</d><h>05:44</h><w>dm3</w>if the consumer is already waiting with a corresponding <code>stream/take!</code></z><z id="t1500097581" t="dm3 unless there‚Äôs a separate executor specified with stream/onto"><y>#</y><d>2017-07-15</d><h>05:46</h><w>dm3</w>unless there‚Äôs a separate executor specified with <code>stream/onto</code></z><z id="t1500097625" t="dm3 stream is marked as drained by the thread doing stream/take! or the one doing stream/close!"><y>#</y><d>2017-07-15</d><h>05:47</h><w>dm3</w>stream is marked as drained by the thread doing <code>stream/take!</code> or the one doing <code>stream/close!</code></z><z id="t1500097923" t="dm3 so that‚Äôs the thread that‚Äôs going to invoke the on-drained callback"><y>#</y><d>2017-07-15</d><h>05:52</h><w>dm3</w>so that‚Äôs the thread that‚Äôs going to invoke the <code>on-drained</code> callback</z><z id="t1500167318" t="lvh Any standards emerging for how to do spec + deferred-returning fns? Obv I can do deferred? but that doesn‚Äôt help much"><y>#</y><d>2017-07-16</d><h>01:08</h><w>lvh</w>Any standards emerging for how to do spec + deferred-returning fns? Obv I can do <code>deferred?</code> but that doesn‚Äôt help much</z><z id="t1500188238" t="dm3 I don‚Äôt think spec will help much with deferreds."><y>#</y><d>2017-07-16</d><h>06:57</h><w>dm3</w>I don‚Äôt think spec will help much with deferreds.</z><z id="t1500244298" t="danielcompton Heh, I was just looking at spec+deferred on Friday"><y>#</y><d>2017-07-16</d><h>22:31</h><w>danielcompton</w>Heh, I was just looking at spec+deferred on Friday</z><z id="t1500244316" t="danielcompton and didn&apos;t get very far"><y>#</y><d>2017-07-16</d><h>22:31</h><w>danielcompton</w>and didn&apos;t get very far</z><z id="t1500373481" t="jcf [:attrs {:href &quot;/_/_/users/U07QKGF9P&quot;}] I&apos;ve heard from Cognitect team members that they use spec for the pure side of things, and not IO-bits and bobs. I suppose in this case that would mean specifying what happens inside the deferred operation and not the delayed (maybe IO?) side of things. I think https://clojure.org/guides/spec#_combining_code_check_code_and_code_instrument_code may be a good example of how to split the specification and deferred/side of things?"><y>#</y><d>2017-07-18</d><h>10:24</h><w>jcf</w><a>@lvh</a> I&apos;ve heard from Cognitect team members that they use spec for the pure side of things, and not IO-bits and bobs. I suppose in this case that would mean specifying what happens inside the deferred operation and not the delayed (maybe IO?) side of things.

I think <a href="https://clojure.org/guides/spec#_combining_code_check_code_and_code_instrument_code" target="_blank">https://clojure.org/guides/spec#_combining_code_check_code_and_code_instrument_code</a> may be a good example of how to split the specification and deferred/side of things?</z><z id="t1500373491" t="jcf HTH."><y>#</y><d>2017-07-18</d><h>10:24</h><w>jcf</w>HTH.</z><z id="t1500385871" t="lvh [:attrs {:href &quot;/_/_/users/U06FTAZV3&quot;}] Yep; thanks üôÇ I guess I can just write my assertions on the first pure fn üôÇ"><y>#</y><d>2017-07-18</d><h>13:51</h><w>lvh</w><a>@jcf</a> Yep; thanks <b>üôÇ</b> I guess I can just write my assertions on the first pure fn <b>üôÇ</b></z><z id="t1500385891" t="lvh I find spec to still be quite useful for the deferred side because stubbing"><y>#</y><d>2017-07-18</d><h>13:51</h><w>lvh</w>I find spec to still be quite useful for the deferred side because stubbing</z><z id="t1500385972" t="jcf [:attrs {:href &quot;/_/_/users/U07QKGF9P&quot;}] that makes sense. I&apos;ve struggled with specifying Datomic in the past and ended up only annotating the pure transaction building bits etc."><y>#</y><d>2017-07-18</d><h>13:52</h><w>jcf</w><a>@lvh</a> that makes sense. I&apos;ve struggled with specifying Datomic in the past and ended up only annotating the pure transaction building bits etc.</z><z id="t1500386109" t="lvh wait; are they hard because they‚Äôre impure, or hard because some things are wrapped in a deferred"><y>#</y><d>2017-07-18</d><h>13:55</h><w>lvh</w>wait; are they hard because they‚Äôre impure, or hard because some things are wrapped in a deferred</z><z id="t1500386138" t="lvh I thought it was strictly the latter; it may be wrapped in a deferred but I still have Strong Opinions(TM) about what the value inside that deferred will get to look like"><y>#</y><d>2017-07-18</d><h>13:55</h><w>lvh</w>I thought it was strictly the latter; it may be wrapped in a deferred but I still have Strong Opinions(TM) about what the value inside that deferred will get to look like</z><z id="t1500417305" t="jcf [:attrs {:href &quot;/_/_/users/U07QKGF9P&quot;}] I don&apos;t know about things being hard, but if you&apos;re dealing with executors and thread pools specs may not be appropriate?"><y>#</y><d>2017-07-18</d><h>22:35</h><w>jcf</w><a>@lvh</a> I don&apos;t know about things being hard, but if you&apos;re dealing with executors and thread pools specs may not be appropriate?</z><z id="t1500417346" t="lvh the stubbing affects the var itself so executors and thread pools get sidestepped entirely"><y>#</y><d>2017-07-18</d><h>22:35</h><w>lvh</w>the stubbing affects the var itself so executors and thread pools get sidestepped entirely</z><z id="t1500417359" t="lvh of course, that enables plenty of cases where e.g. you‚Äôd have a livelock in prod that doesnt‚Äô show up in testing"><y>#</y><d>2017-07-18</d><h>22:35</h><w>lvh</w>of course, that enables plenty of cases where e.g. you‚Äôd have a livelock in prod that doesnt‚Äô show up in testing</z><z id="t1500419438" t="jcf If you&apos;re cutting out the threads you can cut out the deferreds too I suppose. You&apos;re right though. Effectively ignoring what is a big part of the production code path isn&apos;t going to necessarily end well."><y>#</y><d>2017-07-18</d><h>23:10</h><w>jcf</w>If you&apos;re cutting out the threads you can cut out the deferreds too I suppose. You&apos;re right though. Effectively ignoring what is a big part of the production code path isn&apos;t going to necessarily end well.</z><z id="t1500419481" t="jcf Maybe happy-path integration tests and/or some simulation testing would fill that gap if budgets/constraints allow."><y>#</y><d>2017-07-18</d><h>23:11</h><w>jcf</w>Maybe happy-path integration tests and/or some simulation testing would fill that gap if budgets/constraints allow.</z><z id="t1500481610" t="nha Can someone tell me why I need to call realize-each here? I suppose it means that my requests are all realized and kept into memory until further processing, which is something I am trying to avoid. (s/stream-&gt;seq (s/map (fn [res] (println (type res)) ;; manifold.deferred.Deferred if not realize-each (select-keys res [:request-time :connection-time :status])) (s/realize-each ;; why do I need this? (s/map (fn [u] (println &quot;HTTP REQ TO &quot; u) (aleph.http/get u {:throw-exceptions? false})) (s/buffer 50 (s/-&gt;source [&quot;&quot; &quot;&quot; &quot;&quot;])))))) Also, I note that the following works: @(d/chain (aleph.http/get &quot;&quot;) #(select-keys % [:request-time :status])) "><y>#</y><d>2017-07-19</d><h>16:26</h><w>nha</w>Can someone tell me why I need to call <code>realize-each</code> here?
I suppose it means that my requests are all realized and kept into memory until further processing,
which is something I am trying to avoid.


<pre>(s/stream-&gt;seq
  (s/map (fn [res]
           (println (type res)) ;;  manifold.deferred.Deferred if not realize-each
           (select-keys res [:request-time :connection-time :status]))
         (s/realize-each ;; why do I need this?
           (s/map (fn [u]
                    (println &quot;HTTP REQ TO &quot; u)
                    (aleph.http/get u {:throw-exceptions? false}))
                  (s/buffer 50
                            (s/-&gt;source
                              [&quot;&quot;
                               &quot;&quot;
                               &quot;&quot;]))))))
</pre>

Also, I note that the following works:

<pre>@(d/chain (aleph.http/get &quot;&quot;)
          #(select-keys % [:request-time :status]))
</pre></z><z id="t1500481917" t="dm3 you have a stream of deferreds"><y>#</y><d>2017-07-19</d><h>16:31</h><w>dm3</w>you have a stream of deferreds</z><z id="t1500481964" t="dm3 so you need to block/attach a callback in order to get to its contents"><y>#</y><d>2017-07-19</d><h>16:32</h><w>dm3</w>so you need to block/attach a callback in order to get to its contents</z><z id="t1500482009" t="nha so realize-each is the blocking approach right? How do I use a callback?"><y>#</y><d>2017-07-19</d><h>16:33</h><w>nha</w>so <code>realize-each</code> is the blocking approach right? How do I use a callback?</z><z id="t1500482064" t="dm3 you need to decide whether to parallelize a batch"><y>#</y><d>2017-07-19</d><h>16:34</h><w>dm3</w>you need to decide whether to parallelize a batch</z><z id="t1500482076" t="nha It looks like https://github.com/ztellman/manifold/blob/master/docs/stream.md has a hint: The value returned by the callback for connect-via provides backpressure - if a deferred value is returned, further messages will not be passed in until the deferred value is realized. but I don‚Äôt understand it"><y>#</y><d>2017-07-19</d><h>16:34</h><w>nha</w>It looks like <a href="https://github.com/ztellman/manifold/blob/master/docs/stream.md" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/stream.md</a> has a hint:
<pre>The value returned by the callback for connect-via provides backpressure - if a deferred value is returned, further messages will not be passed in until the deferred value is realized.
</pre>
but I don‚Äôt understand it</z><z id="t1500482101" t="nha I actually want to throttle it"><y>#</y><d>2017-07-19</d><h>16:35</h><w>nha</w>I actually want to throttle it</z><z id="t1500482532" t="nha That looks closer to what I want: (time (doall (s/stream-&gt;seq (s/map (fn [res] (select-keys res [:request-time :connection-time :status])) (s/realize-each (s/map (fn [u] (println &quot;HTTP REQ TO &quot; u) (aleph.http/get u {:throw-exceptions? false})) (s/throttle 1 (s/buffer 50 (s/-&gt;source (map #(str &quot;&quot; %) (range 1 10)) ))))))))) "><y>#</y><d>2017-07-19</d><h>16:42</h><w>nha</w>That looks closer to what I want:
<pre>(time (doall (s/stream-&gt;seq
               (s/map (fn [res]
                        (select-keys res [:request-time :connection-time :status]))
                      (s/realize-each
                        (s/map (fn [u]
                                 (println &quot;HTTP REQ TO &quot; u)
                                 (aleph.http/get u {:throw-exceptions? false}))
                               (s/throttle 1
                                           (s/buffer 50
                                                     (s/-&gt;source
                                                       (map #(str &quot;&quot; %) (range 1 10))
                                                       )))))))))
</pre></z><z id="t1500482910" t="nha Actually you are right, I want a mix of parallelize and throttle. How do I parallelize it?"><y>#</y><d>2017-07-19</d><h>16:48</h><w>nha</w>Actually you are right, I want a mix of parallelize and throttle. How do I parallelize it?</z><z id="t1500487208" t="dm3 [:attrs {:href &quot;/_/_/users/U0ALP2929&quot;}] you can use deferred/loop to do it kinda manually"><y>#</y><d>2017-07-19</d><h>18:00</h><w>dm3</w><a>@nha</a> you can use <code>deferred/loop</code> to do it kinda manually</z><z id="t1500487247" t="dm3 or pipe the batched stream into a (deferred/future-with my-single-thread-loop ..)"><y>#</y><d>2017-07-19</d><h>18:00</h><w>dm3</w>or pipe the batched stream into a <code>(deferred/future-with my-single-thread-loop ..)</code></z><z id="t1500567613" t="nha Alright I saw the recent issues on manifold (in which you apparently had a hand dm3 üôÇ ) but I did not come up with something yet"><y>#</y><d>2017-07-20</d><h>16:20</h><w>nha</w>Alright I saw the recent issues on manifold (in which you apparently had a hand dm3 <b>üôÇ</b> ) but I did not come up with something yet</z><z id="t1500567640" t="nha I tried using d/loop but it seems it waits for the previous deferred before starting the next loop"><y>#</y><d>2017-07-20</d><h>16:20</h><w>nha</w>I tried using <code>d/loop</code> but it seems it waits for the previous deferred before starting the next loop</z><z id="t1500567660" t="nha and I don‚Äôt see how to use (deferred/future-with my-single-thread-loop ..) with a stream"><y>#</y><d>2017-07-20</d><h>16:21</h><w>nha</w>and I don‚Äôt see how to use <code>(deferred/future-with my-single-thread-loop ..)</code> with a stream</z><z id="t1500577971" t="bradford Hi! How do I write an HTTP response directly? no ring middleware. I&apos;m building a proxy and need to send the exact string &quot;HTTP/1.1 200 Connection established\r\n\r\n&quot; -- not as a body, as the entire response (and then leave the socket open)"><y>#</y><d>2017-07-20</d><h>19:12</h><w>bradford</w>Hi! How do I write an HTTP response directly? no ring middleware. I&apos;m building a proxy and need to send the exact string &quot;HTTP/1.1 200 Connection established\r\n\r\n&quot; -- not as a body, as the entire response (and then leave the socket open)</z><z id="t1500944405" t="cjhowe if i use stream/consume do messages that i stream/take! inside the consume show up in the consume?"><y>#</y><d>2017-07-25</d><h>01:00</h><w>cjhowe</w>if i use <code>stream/consume</code> do messages that i <code>stream/take!</code> inside the consume show up in the consume?</z><z id="t1500961836" t="dm3 are you consuming and taking from the same stream?"><y>#</y><d>2017-07-25</d><h>05:50</h><w>dm3</w>are you consuming and taking from the same stream?</z><z id="t1501120025" t="cjhowe [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] yes"><y>#</y><d>2017-07-27</d><h>01:47</h><w>cjhowe</w><a>@dm3</a> yes</z><z id="t1501191117" t="danielcompton [:attrs {:href &quot;/_/_/users/U085HE1PB&quot;}] a little late and you may already know this, but this is what you want to do in Netty land https://github.com/netty/netty/issues/1326#issuecomment-17321027"><y>#</y><d>2017-07-27</d><h>21:31</h><w>danielcompton</w><a>@bradford</a> a little late and you may already know this, but this is what you want to do in Netty land <a href="https://github.com/netty/netty/issues/1326#issuecomment-17321027" target="_blank">https://github.com/netty/netty/issues/1326#issuecomment-17321027</a></z><z id="t1501191124" t="danielcompton Not sure how to translate that to Aleph though"><y>#</y><d>2017-07-27</d><h>21:32</h><w>danielcompton</w>Not sure how to translate that to Aleph though</z><z id="t1501279396" t="bradford [:attrs {:href &quot;/_/_/users/U051KLSJF&quot;}] Oh, wow. Good find! Yes, this is helpful"><y>#</y><d>2017-07-28</d><h>22:03</h><w>bradford</w><a>@danielcompton</a> Oh, wow. Good find! Yes, this is helpful</z><z id="t1501370668" t="kurt-o-sys I&apos;m trying to connect to a WAMP/ws server, but can&apos;t seem to manage: @(http/websocket-client ws-address) io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid handshake response getStatus: 400 This server only speaks WebSocket subprotocols wamp.2.cbor.batched, wamp.2.cbor, wamp.2.msgpack.batched, wamp.2.msgpack, wamp.2.json.batched, wamp.2.json Jul 30, 2017 1:19:51 AM clojure.tools.logging$eval1133$fn__1137 invoke WARNING: error in websocket client io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid subprotocol. Actual: wamp.2.json. Expected one of: null at io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker.finishHandshake(WebSocketClientHandshaker.java:237) at aleph.http.client$websocket_client_handler$reify__19769.channelRead(client.clj:416) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) &lt;...&gt; So, it seems I have to set the subprotocol ( https://groups.google.com/forum/#!topic/aleph-lib/ulBaEd2YukY ?) @(http/websocket-client ws-address {:headers {&quot;Sec-WebSocket-Protocol&quot; &quot;wamp.2.json&quot;}}) io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid subprotocol. Actual: wamp.2.json. Expected one of: null Jul 30, 2017 1:23:18 AM clojure.tools.logging$eval1133$fn__1137 invoke WARNING: error in websocket client io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid subprotocol. Actual: wamp.2.json. Expected one of: null at io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker.finishHandshake(WebSocketClientHandshaker.java:237) at aleph.http.client$websocket_client_handler$reify__19769.channelRead(client.clj:416) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) &lt;...&gt; "><y>#</y><d>2017-07-29</d><h>23:24</h><w>kurt-o-sys</w>I&apos;m trying to connect to a WAMP/ws server, but can&apos;t seem to manage:
<pre>@(http/websocket-client ws-address)
io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid handshake response getStatus: 400 This server only speaks WebSocket subprotocols wamp.2.cbor.batched, wamp.2.cbor, wamp.2.msgpack.batched, wamp.2.msgpack, wamp.2.json.batched, wamp.2.json
Jul 30, 2017 1:19:51 AM clojure.tools.logging$eval1133$fn__1137 invoke
WARNING: error in websocket client
io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid subprotocol. Actual: wamp.2.json. Expected one of: null
	at io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker.finishHandshake(WebSocketClientHandshaker.java:237)
	at aleph.http.client$websocket_client_handler$reify__19769.channelRead(client.clj:416)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)
	&lt;...&gt;
</pre>
So, it seems I have to set the subprotocol (<a href="https://groups.google.com/forum/#!topic/aleph-lib/ulBaEd2YukY" target="_blank">https://groups.google.com/forum/#!topic/aleph-lib/ulBaEd2YukY</a> ?)
<pre>@(http/websocket-client ws-address {:headers {&quot;Sec-WebSocket-Protocol&quot; &quot;wamp.2.json&quot;}})
io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid subprotocol. Actual: wamp.2.json. Expected one of: null
Jul 30, 2017 1:23:18 AM clojure.tools.logging$eval1133$fn__1137 invoke
WARNING: error in websocket client
io.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid subprotocol. Actual: wamp.2.json. Expected one of: null
	at io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker.finishHandshake(WebSocketClientHandshaker.java:237)
	at aleph.http.client$websocket_client_handler$reify__19769.channelRead(client.clj:416)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)
	at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
	&lt;...&gt;
</pre></z><z id="t1501370728" t="kurt-o-sys Can I set the ws subprotocol using Aleph? (and how?)"><y>#</y><d>2017-07-29</d><h>23:25</h><w>kurt-o-sys</w>Can I set the ws subprotocol using Aleph? (and how?)</z><z id="t1501394880" t="dm3 according to https://github.com/netty/netty/blob/0514b0c61be19119b420fa661123990acbdd8305/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketClientHandshaker.java#L228 , a receivedProtocol needs to be supplied to the WebSocketClientHandshaker upon construction. It has to match one of the values set in the header. I‚Äôm not sure how the WSCHandshaker is getting created though, but the exception indicates that the receivedProtocol is set to null ."><y>#</y><d>2017-07-30</d><h>06:08</h><w>dm3</w>according to <a href="https://github.com/netty/netty/blob/0514b0c61be19119b420fa661123990acbdd8305/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketClientHandshaker.java#L228" target="_blank">https://github.com/netty/netty/blob/0514b0c61be19119b420fa661123990acbdd8305/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketClientHandshaker.java#L228</a>, a <code>receivedProtocol</code> needs to be supplied to the WebSocketClientHandshaker upon construction. It has to match one of the values set in the header. I‚Äôm not sure how the WSCHandshaker is getting created though, but the exception indicates that the <code>receivedProtocol</code> is set to <code>null</code>.</z><z id="t1501395274" t="dm3 seems you need to pass a sub-protocols comma-delimited protocol string to the websocket-client in Aleph - https://github.com/ztellman/aleph/blob/2ba3484ead3a8443667d3a3caddf9739c6841d9c/src/aleph/http/client.clj#L379"><y>#</y><d>2017-07-30</d><h>06:14</h><w>dm3</w>seems you need to pass a <code>sub-protocols</code> comma-delimited protocol string to the <code>websocket-client</code> in Aleph - <a href="https://github.com/ztellman/aleph/blob/2ba3484ead3a8443667d3a3caddf9739c6841d9c/src/aleph/http/client.clj#L379" target="_blank">https://github.com/ztellman/aleph/blob/2ba3484ead3a8443667d3a3caddf9739c6841d9c/src/aleph/http/client.clj#L379</a></z><z id="t1501395283" t="dm3 [:attrs {:href &quot;/_/_/users/U0E0XL064&quot;}] ^"><y>#</y><d>2017-07-30</d><h>06:14</h><w>dm3</w><a>@kurt-o-sys</a> ^</z><z id="t1501434955" t="kurt-o-sys [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] Thx... I may check it some day. For now, I&apos;m just using a java lib (`jawampa`)... it implements already the protocol pretty well, so no need to use something else right now (it&apos;s only to use in a client, and that ws is about the only thing to setup to fetch data)"><y>#</y><d>2017-07-30</d><h>17:15</h><w>kurt-o-sys</w><a>@dm3</a> Thx... I may check it some day. For now, I&apos;m just using a java lib (`jawampa`)... it implements already the protocol pretty well, so no need to use something else right now (it&apos;s only to use in a client, and that ws is about the only thing to setup to fetch data)</z><z id="t1501869317" t="aengelberg I just encountered an intermittent bug in production where my code has been hanging for several hours on @(http/get ...) ."><y>#</y><d>2017-08-04</d><h>17:55</h><w>aengelberg</w>I just encountered an intermittent bug in production where my code has been hanging for several hours on <code>@(http/get ...)</code>.</z><z id="t1501869365" t="aengelberg Is it normal for Aleph to hang indefinitely on connections not responding? I assumed there would be some sort of default timeout. If not, what option do I have to set to make it time out after 30 seconds or so?"><y>#</y><d>2017-08-04</d><h>17:56</h><w>aengelberg</w>Is it normal for Aleph to hang indefinitely on connections not responding? I assumed there would be some sort of default timeout. If not, what option do I have to set to make it time out after 30 seconds or so?</z><z id="t1501874204" t="ehashman I have seen this happen too"><y>#</y><d>2017-08-04</d><h>19:16</h><w>ehashman</w>I have seen this happen too</z><z id="t1501874224" t="ehashman it seemed to be a weird livelock thing involving netty"><y>#</y><d>2017-08-04</d><h>19:17</h><w>ehashman</w>it seemed to be a weird livelock thing involving netty</z><z id="t1502179934" t="miikka There are some timeout options in http://aleph.io/codox/aleph/aleph.http.html#var-request"><y>#</y><d>2017-08-08</d><h>08:12</h><w>miikka</w>There are some timeout options in <a href="http://aleph.io/codox/aleph/aleph.http.html#var-request" target="_blank">http://aleph.io/codox/aleph/aleph.http.html#var-request</a></z><z id="t1502179957" t="miikka There&apos;s a default :connection-timeout of 60 seconds, though."><y>#</y><d>2017-08-08</d><h>08:12</h><w>miikka</w>There&apos;s a default <code>:connection-timeout</code> of 60 seconds, though.</z><z id="t1502180088" t="miikka Also you can do set a timeout with (d/timeout! ...)"><y>#</y><d>2017-08-08</d><h>08:14</h><w>miikka</w>Also you can do set a timeout with <code>(d/timeout! ...)</code></z><z id="t1502180128" t="miikka Or I guess you can even use clojure.core/deref timeout. (deref (http/get ...) 30000 :timeout)"><y>#</y><d>2017-08-08</d><h>08:15</h><w>miikka</w>Or I guess you can even use clojure.core/deref timeout. <code>(deref (http/get ...) 30000 :timeout)</code></z><z id="t1502303626" t="ztellman [:attrs {:href &quot;/_/_/users/U0516PHE3&quot;}] this is kind of a late reply, but there should be a default timeout, and it should never hang indefinitely"><y>#</y><d>2017-08-09</d><h>18:33</h><w>ztellman</w><a>@aengelberg</a> this is kind of a late reply, but there should be a default timeout, and it should never hang indefinitely</z><z id="t1502303720" t="aengelberg I see there‚Äôs a default connection-timeout of 60000.0, but I don‚Äôt see a default request-timeout ."><y>#</y><d>2017-08-09</d><h>18:35</h><w>aengelberg</w>I see there‚Äôs a default <code>connection-timeout</code> of 60000.0, but I don‚Äôt see a default <code>request-timeout</code>.</z><z id="t1502303729" t="aengelberg I‚Äôm not sure what phase of my request hung."><y>#</y><d>2017-08-09</d><h>18:35</h><w>aengelberg</w>I‚Äôm not sure what phase of my request hung.</z><z id="t1502303741" t="ztellman I see"><y>#</y><d>2017-08-09</d><h>18:35</h><w>ztellman</w>I see</z><z id="t1502303768" t="ztellman it would be weird for a connection to be open for hours, usually something in between has an idle timeout"><y>#</y><d>2017-08-09</d><h>18:36</h><w>ztellman</w>it would be weird for a connection to be open for hours, usually something in between has an idle timeout</z><z id="t1502303795" t="ztellman I will note that I&apos;ve seen issues in Netty where connections close, and the notification isn&apos;t fired"><y>#</y><d>2017-08-09</d><h>18:36</h><w>ztellman</w>I will note that I&apos;ve seen issues in Netty where connections close, and the notification isn&apos;t fired</z><z id="t1502303830" t="aengelberg I don‚Äôt know if this issue will ever happen again. I already changed my code to (deref (http/get ...) 30000 ::timeout) as miikka suggested, just in case."><y>#</y><d>2017-08-09</d><h>18:37</h><w>aengelberg</w>I don‚Äôt know if this issue will ever happen again. I already changed my code to <code>(deref (http/get ...) 30000 ::timeout)</code> as miikka suggested, just in case.</z><z id="t1502303832" t="ztellman I&apos;ve never been able to figure out how to reliably make it happen"><y>#</y><d>2017-08-09</d><h>18:37</h><w>ztellman</w>I&apos;ve never been able to figure out how to reliably make it happen</z><z id="t1502303840" t="ztellman sure, that will definitely work"><y>#</y><d>2017-08-09</d><h>18:37</h><w>ztellman</w>sure, that will definitely work</z><z id="t1502303862" t="ztellman in other Netty codebases I&apos;ve added periodic checks to see if a connection is closed even though the event didn&apos;t fire"><y>#</y><d>2017-08-09</d><h>18:37</h><w>ztellman</w>in other Netty codebases I&apos;ve added periodic checks to see if a connection is closed even though the event didn&apos;t fire</z><z id="t1502303883" t="ztellman I should probably do the same in Aleph, even though I&apos;ve tried to avoid any sort of background tasks so far"><y>#</y><d>2017-08-09</d><h>18:38</h><w>ztellman</w>I should probably do the same in Aleph, even though I&apos;ve tried to avoid any sort of background tasks so far</z><z id="t1502303907" t="aengelberg My code is issuing thousands of paginated HTTP requests to load a bunch of data from a Campaign Monitor API, and pretty regularly, at least one request fails for a variety of reasons."><y>#</y><d>2017-08-09</d><h>18:38</h><w>aengelberg</w>My code is issuing thousands of paginated HTTP requests to load a bunch of data from a Campaign Monitor API, and pretty regularly, at least one request fails for a variety of reasons.</z><z id="t1502303916" t="ztellman gotcha"><y>#</y><d>2017-08-09</d><h>18:38</h><w>ztellman</w>gotcha</z><z id="t1502303930" t="ztellman well, your workaround is sound, so this probably isn&apos;t a concern to you anymore"><y>#</y><d>2017-08-09</d><h>18:38</h><w>ztellman</w>well, your workaround is sound, so this probably isn&apos;t a concern to you anymore</z><z id="t1502303949" t="aengelberg I wrapped it with retry/backoff logic, but when the deref hung forever, my wrapper couldn‚Äôt do anything."><y>#</y><d>2017-08-09</d><h>18:39</h><w>aengelberg</w>I wrapped it with retry/backoff logic, but when the deref hung forever, my wrapper couldn‚Äôt do anything.</z><z id="t1502303954" t="ztellman though as always, targeting the latest Netty is always a decent idea, there are lots of fixes each release"><y>#</y><d>2017-08-09</d><h>18:39</h><w>ztellman</w>though as always, targeting the latest Netty is always a decent idea, there are lots of fixes each release</z><z id="t1502303987" t="aengelberg thanks."><y>#</y><d>2017-08-09</d><h>18:39</h><w>aengelberg</w>thanks.</z><z id="t1502304001" t="aengelberg glad you endorse my duct tape solution."><y>#</y><d>2017-08-09</d><h>18:40</h><w>aengelberg</w>glad you endorse my duct tape solution.</z><z id="t1502304023" t="ztellman I might use manifold.deferred/timeout! , but same difference"><y>#</y><d>2017-08-09</d><h>18:40</h><w>ztellman</w>I might use <code>manifold.deferred/timeout!</code>, but same difference</z><z id="t1502304051" t="aengelberg The only real potential concern is that maybe I‚Äôll leak a connection object if I don‚Äôt wait for it to complete."><y>#</y><d>2017-08-09</d><h>18:40</h><w>aengelberg</w>The only real potential concern is that maybe I‚Äôll leak a connection object if I don‚Äôt wait for it to complete.</z><z id="t1502304063" t="aengelberg But I doubt that issue will happen enough times (if at all) to make any impact."><y>#</y><d>2017-08-09</d><h>18:41</h><w>aengelberg</w>But I doubt that issue will happen enough times (if at all) to make any impact.</z><z id="t1502346767" t="miikka [:attrs {:href &quot;/_/_/users/U066UJ2KE&quot;}] , what&apos;s the difference between using manifold.deferred/timeout! and clojure.core/deref timeout?"><y>#</y><d>2017-08-10</d><h>06:32</h><w>miikka</w><a>@ztellman</a>, what&apos;s the difference between using <code>manifold.deferred/timeout!</code> and <code>clojure.core/deref</code> timeout?</z><z id="t1502351815" t="dm3 [:attrs {:href &quot;/_/_/users/U1NDXLDUG&quot;}] deferred/timeout! will make the deferred return the supplied ‚Äútimeout‚Äù value when deref ed. In other words it transfers the deferred into ready state. clojure.core/deref only tries to look inside a derefable and doesn‚Äôt change its value or state."><y>#</y><d>2017-08-10</d><h>07:56</h><w>dm3</w><a>@miikka</a> <code>deferred/timeout!</code> will make the deferred return the supplied ‚Äútimeout‚Äù value when <code>deref</code>ed. In other words it transfers the deferred into ready state. <code>clojure.core/deref</code> only tries to look inside a derefable and doesn‚Äôt change its value or state.</z><z id="t1502355661" t="miikka right"><y>#</y><d>2017-08-10</d><h>09:01</h><w>miikka</w>right</z><z id="t1502900889" t="malcolmsparks [:attrs {:href &quot;/_/_/users/U050DD55V&quot;}] has a manifold question, think this is the best place to ask"><y>#</y><d>2017-08-16</d><h>16:28</h><w>malcolmsparks</w><a>@jonpither</a> has a manifold question, think this is the best place to ask</z><z id="t1503307185" t="lxsameer hey guys, How does aleph error handling works for http handlers? Apparently i have bug in my handler but i just get a log message saying &lt;aleph.http.server:288&gt; - error in HTTP handler"><y>#</y><d>2017-08-21</d><h>09:19</h><w>lxsameer</w>hey guys, How does aleph error handling works for http handlers? Apparently i have bug in my handler but i just get a log message saying  <code> &lt;aleph.http.server:288&gt; - error in HTTP handler</code></z><z id="t1503307198" t="lxsameer how can i get the traceback ?"><y>#</y><d>2017-08-21</d><h>09:19</h><w>lxsameer</w>how can i get the traceback ?</z><z id="t1504188738" t="genRaiy dumb question ‚Ä¶ how to use post with http client?"><y>#</y><d>2017-08-31</d><h>14:12</h><w>genRaiy</w>dumb question ‚Ä¶ how to use post with http client?</z><z id="t1504188859" t="genRaiy I get a 401 when calling but it works when using curl / postman"><y>#</y><d>2017-08-31</d><h>14:14</h><w>genRaiy</w>I get a 401 when calling but it works when using curl / postman</z><z id="t1504188873" t="genRaiy so I guess the body encoding is wrong in some way"><y>#</y><d>2017-08-31</d><h>14:14</h><w>genRaiy</w>so I guess the body encoding is wrong in some way</z><z id="t1504188887" t="genRaiy but help / tips welcome üôÇ"><y>#</y><d>2017-08-31</d><h>14:14</h><w>genRaiy</w>but help / tips welcome <b>üôÇ</b></z><z id="t1504188916" t="genRaiy [ reading the http client code hasn‚Äôt helped ]"><y>#</y><d>2017-08-31</d><h>14:15</h><w>genRaiy</w>[ reading the http client code hasn‚Äôt helped ]</z><z id="t1504199806" t="ehashman For one thing, your client id and client secret are not the same case"><y>#</y><d>2017-08-31</d><h>17:16</h><w>ehashman</w>For one thing, your client id and client secret are not the same case</z><z id="t1504199833" t="ehashman Does auth0 require basic auth? You haven&apos;t included any creds for that in the HTTP call"><y>#</y><d>2017-08-31</d><h>17:17</h><w>ehashman</w>Does auth0 require basic auth? You haven&apos;t included any creds for that in the HTTP call</z><z id="t1504199931" t="ehashman For basic auth, include {:basic-auth [username password]} in your options map to http/get"><y>#</y><d>2017-08-31</d><h>17:18</h><w>ehashman</w>For basic auth, include <code>{:basic-auth [username password]}</code> in your options map to http/get</z><z id="t1504199948" t="ehashman Or post in this case, I guess"><y>#</y><d>2017-08-31</d><h>17:19</h><w>ehashman</w>Or post in this case, I guess</z><z id="t1504203984" t="genRaiy don‚Äôt worry about the parameters"><y>#</y><d>2017-08-31</d><h>18:26</h><w>genRaiy</w>don‚Äôt worry about the parameters</z><z id="t1504204000" t="genRaiy I just don‚Äôt know how to call POST with aleph"><y>#</y><d>2017-08-31</d><h>18:26</h><w>genRaiy</w>I just don‚Äôt know how to call POST with aleph</z><z id="t1504204052" t="genRaiy this call (endpoint / body) works with the postman REST client"><y>#</y><d>2017-08-31</d><h>18:27</h><w>genRaiy</w>this call (endpoint / body) works with the postman REST client</z><z id="t1504204067" t="genRaiy so there is nothing wrong with the approach"><y>#</y><d>2017-08-31</d><h>18:27</h><w>genRaiy</w>so there is nothing wrong with the approach</z><z id="t1504208096" t="ehashman What&apos;s the error you are getting? I&apos;m not familiar with postman."><y>#</y><d>2017-08-31</d><h>19:34</h><w>ehashman</w>What&apos;s the error you are getting? I&apos;m not familiar with postman.</z><z id="t1504208125" t="ehashman If it&apos;s just a 401, you have an authentication issue, which is why I asked if basic auth is requires"><y>#</y><d>2017-08-31</d><h>19:35</h><w>ehashman</w>If it&apos;s just a 401, you have an authentication issue, which is why I asked if basic auth is requires</z><z id="t1504208637" t="genRaiy ok, sorry to have been prickly ‚Ä¶ no basic auth needed"><y>#</y><d>2017-08-31</d><h>19:43</h><w>genRaiy</w>ok, sorry to have been prickly ‚Ä¶ no basic auth needed</z><z id="t1504208660" t="genRaiy it does use x-www-form-urlencoded"><y>#</y><d>2017-08-31</d><h>19:44</h><w>genRaiy</w>it does use x-www-form-urlencoded</z><z id="t1504208727" t="stijn [:attrs {:href &quot;/_/_/users/U04V5V0V4&quot;}] is it correct (like [:attrs {:href &quot;/_/_/users/U0MPXFNLE&quot;}] pointed out) that your client-secret has a hyphen instead of underscore?"><y>#</y><d>2017-08-31</d><h>19:45</h><w>stijn</w><a>@raymcdermott</a> is it correct (like <a>@ehashman</a> pointed out) that your <code>client-secret</code> has a hyphen instead of underscore?</z><z id="t1504208773" t="genRaiy maybe I‚Äôm being a dick"><y>#</y><d>2017-08-31</d><h>19:46</h><w>genRaiy</w>maybe I‚Äôm being a dick</z><z id="t1504208822" t="stijn okay üôÇ"><y>#</y><d>2017-08-31</d><h>19:47</h><w>stijn</w>okay <b>üôÇ</b></z><z id="t1504208843" t="genRaiy nope, still 401"><y>#</y><d>2017-08-31</d><h>19:47</h><w>genRaiy</w>nope, still 401</z><z id="t1504208866" t="stijn I always use aleph.http/request with :method set to :post"><y>#</y><d>2017-08-31</d><h>19:47</h><w>stijn</w>I always use aleph.http/request with <code>:method</code> set to <code>:post</code></z><z id="t1504208895" t="genRaiy hmm why?"><y>#</y><d>2017-08-31</d><h>19:48</h><w>genRaiy</w>hmm why?</z><z id="t1504208920" t="stijn (aleph.http/request {:method :post :url &quot;uuuuurrrlll&quot;})"><y>#</y><d>2017-08-31</d><h>19:48</h><w>stijn</w><code>(aleph.http/request {:method :post :url &quot;uuuuurrrlll&quot;})</code></z><z id="t1504209015" t="stijn can you paste the curl request?"><y>#</y><d>2017-08-31</d><h>19:50</h><w>stijn</w>can you paste the curl request?</z><z id="t1504209071" t="genRaiy one sec"><y>#</y><d>2017-08-31</d><h>19:51</h><w>genRaiy</w>one sec</z><z id="t1504209298" t="genRaiy holy shit ‚Ä¶ case sensitive content-type"><y>#</y><d>2017-08-31</d><h>19:54</h><w>genRaiy</w>holy shit ‚Ä¶ case sensitive content-type</z><z id="t1504209303" t="genRaiy it‚Äôs working now"><y>#</y><d>2017-08-31</d><h>19:55</h><w>genRaiy</w>it‚Äôs working now</z><z id="t1504209304" t="genRaiy LOL"><y>#</y><d>2017-08-31</d><h>19:55</h><w>genRaiy</w>LOL</z><z id="t1504209328" t="genRaiy so do it the right way from now on [:attrs {:href &quot;/_/_/users/U0539NJF7&quot;}] üôÇ"><y>#</y><d>2017-08-31</d><h>19:55</h><w>genRaiy</w>so do it the right way from now on <a>@stijn</a> <b>üôÇ</b></z><z id="t1504209329" t="stijn that&apos;s a pretty awesome http response code in that case"><y>#</y><d>2017-08-31</d><h>19:55</h><w>stijn</w>that&apos;s a pretty awesome http response code in that case</z><z id="t1504209347" t="genRaiy auth0 - yeah, the best"><y>#</y><d>2017-08-31</d><h>19:55</h><w>genRaiy</w>auth0 - yeah, the best</z><z id="t1504209388" t="genRaiy so this is OK now"><y>#</y><d>2017-08-31</d><h>19:56</h><w>genRaiy</w>so this is OK now</z><z id="t1504209442" t="genRaiy [:attrs {:href &quot;/_/_/users/U0MPXFNLE&quot;}] thanks for your support too"><y>#</y><d>2017-08-31</d><h>19:57</h><w>genRaiy</w><a>@ehashman</a> thanks for your support too</z><z id="t1504215036" t="genRaiy hmmm ‚Ä¶ maybe not the content-type ‚Ä¶. I tried it with Content-Type and it still worked"><y>#</y><d>2017-08-31</d><h>21:30</h><w>genRaiy</w>hmmm ‚Ä¶ maybe not the content-type ‚Ä¶. I tried it with Content-Type and it still worked</z><z id="t1504215054" t="genRaiy so it‚Äôs working and thanks for your support"><y>#</y><d>2017-08-31</d><h>21:30</h><w>genRaiy</w>so it‚Äôs working and thanks for your support</z><z id="t1504215072" t="genRaiy probably was the - not being a _"><y>#</y><d>2017-08-31</d><h>21:31</h><w>genRaiy</w>probably was the - not being a _</z><z id="t1504215724" t="ehashman I would agree :)"><y>#</y><d>2017-08-31</d><h>21:42</h><w>ehashman</w>I would agree :)</z><z id="t1504228573" t="danielcompton Is there a way to make an aleph HTTP server suspendable? https://github.com/weavejester/suspendable . To do so I&apos;d need to be able to update the routes that get passed in"><y>#</y><d>2017-09-01</d><h>01:16</h><w>danielcompton</w>Is there a way to make an aleph HTTP server suspendable? <a href="https://github.com/weavejester/suspendable" target="_blank">https://github.com/weavejester/suspendable</a>. To do so I&apos;d need to be able to update the routes that get passed in</z><z id="t1504231386" t="shader I imagine this question has been asked a lot, but what work has been done re: clustering on top of aleph? a l√° Akka"><y>#</y><d>2017-09-01</d><h>02:03</h><w>shader</w>I imagine this question has been asked a lot, but what work has been done re: clustering on top of aleph? a l√° Akka</z><z id="t1504248151" t="miikka [:attrs {:href &quot;/_/_/users/U051KLSJF&quot;}] , I&apos;m suspending Aleph the same way as weavejester is suspending Jetty in duct: https://github.com/duct-framework/server.http.jetty/blob/master/src/duct/server/http/jetty.clj"><y>#</y><d>2017-09-01</d><h>06:42</h><w>miikka</w><a>@danielcompton</a>, I&apos;m suspending Aleph the same way as weavejester is suspending Jetty in duct: <a href="https://github.com/duct-framework/server.http.jetty/blob/master/src/duct/server/http/jetty.clj" target="_blank">https://github.com/duct-framework/server.http.jetty/blob/master/src/duct/server/http/jetty.clj</a></z><z id="t1504248167" t="miikka i.e. have the handler in an atom"><y>#</y><d>2017-09-01</d><h>06:42</h><w>miikka</w>i.e. have the handler in an atom</z><z id="t1504254095" t="danielcompton [:attrs {:href &quot;/_/_/users/U1NDXLDUG&quot;}] so the handler that you pass to Aleph does a deref of the atom to get the actual handler?"><y>#</y><d>2017-09-01</d><h>08:21</h><w>danielcompton</w><a>@miikka</a> so the handler that you pass to Aleph does a deref of the atom to get the actual handler?</z><z id="t1504256746" t="miikka yeah"><y>#</y><d>2017-09-01</d><h>09:05</h><w>miikka</w>yeah</z><z id="t1504257350" t="danielcompton nice, thanks üôÇ"><y>#</y><d>2017-09-01</d><h>09:15</h><w>danielcompton</w>nice, thanks <b>üôÇ</b></z><z id="t1505113844" t="odinodin How can I monitor the state of an aleph TCP-server? i.e show number of connected clients, throughput, etc"><y>#</y><d>2017-09-11</d><h>07:10</h><w>odinodin</w>How can I monitor the state of an aleph TCP-server? i.e show number of connected clients, throughput, etc</z><z id="t1505158334" t="ztellman [:attrs {:href &quot;/_/_/users/U0PS4MS80&quot;}] you can either update some sort of central state in your handler function, or create a Netty ChannelHandler that you insert using :bootstrap-transform"><y>#</y><d>2017-09-11</d><h>19:32</h><w>ztellman</w><a>@odinodin</a> you can either update some sort of central state in your handler function, or create a Netty ChannelHandler that you insert using :bootstrap-transform</z><z id="t1505158344" t="ztellman there is no built-in monitoring"><y>#</y><d>2017-09-11</d><h>19:32</h><w>ztellman</w>there is no built-in monitoring</z><z id="t1505164805" t="odinodin Ok, thanks :)"><y>#</y><d>2017-09-11</d><h>21:20</h><w>odinodin</w>Ok, thanks :)</z><z id="t1505238802" t="shader anyone looked into libp2p? How hard do you think it would be to make a clojure implementation that&apos;s aleph / manifold compatible?"><y>#</y><d>2017-09-12</d><h>17:53</h><w>shader</w>anyone looked into libp2p? How hard do you think it would be to make a clojure implementation that&apos;s aleph / manifold compatible?</z><z id="t1505238826" t="shader https://libp2p.io/"><y>#</y><d>2017-09-12</d><h>17:53</h><w>shader</w><a href="https://libp2p.io/" target="_blank">https://libp2p.io/</a></z><z id="t1505240882" t="dm3 they say java impl is on the roadmap"><y>#</y><d>2017-09-12</d><h>18:28</h><w>dm3</w>they say java impl is on the roadmap</z><z id="t1505240909" t="dm3 once it‚Äôs done - pretty easy to wrap in manifold"><y>#</y><d>2017-09-12</d><h>18:28</h><w>dm3</w>once it‚Äôs done - pretty easy to wrap in manifold</z><z id="t1505241135" t="shader I&apos;d be interested in working on a native clojure version; any reason to prefer a java implementation? Also, I haven&apos;t seen any evidence of a java version"><y>#</y><d>2017-09-12</d><h>18:32</h><w>shader</w>I&apos;d be interested in working on a native clojure version; any reason to prefer a java implementation? Also, I haven&apos;t seen any evidence of a java version</z><z id="t1505241170" t="shader they have tons of repos in their organization for js and golang, and a few for c# I think, but none for java. Unless its being done by external contributors"><y>#</y><d>2017-09-12</d><h>18:32</h><w>shader</w>they have tons of repos in their organization for js and golang, and a few for c# I think, but none for java. Unless its being done by external contributors</z><z id="t1505241490" t="dm3 doing it in clojure shouldn‚Äôt be harder than in Java"><y>#</y><d>2017-09-12</d><h>18:38</h><w>dm3</w>doing it in clojure shouldn‚Äôt be harder than in Java</z><z id="t1505241602" t="dm3 you could do a Clojurescript interface for the JS libraries"><y>#</y><d>2017-09-12</d><h>18:40</h><w>dm3</w>you could do a Clojurescript interface for the JS libraries</z><z id="t1505241636" t="dm3 there‚Äôs manifold-cljs (which is only used by me)"><y>#</y><d>2017-09-12</d><h>18:40</h><w>dm3</w>there‚Äôs <code>manifold-cljs</code> (which is only used by me)</z><z id="t1505246556" t="shader having both versions would probably be nice"><y>#</y><d>2017-09-12</d><h>20:02</h><w>shader</w>having both versions would probably be nice</z><z id="t1505246594" t="shader so maybe I should start with wrapping the js version, then fill in the implementation to match the api and port it to clj"><y>#</y><d>2017-09-12</d><h>20:03</h><w>shader</w>so maybe I should start with wrapping the js version, then fill in the implementation to match the api and port it to clj</z><z id="t1505293666" t="nha Did not know about lib2p, looks interesting üôÇ - so you can use it from the browser to replace http://socket.io/sente ? It seems better in that it handles backpressure etc. and even webRTC. But does it has the concept of upgrade / fallback between protocols?"><y>#</y><d>2017-09-13</d><h>09:07</h><w>nha</w>Did not know about lib2p, looks interesting <b>üôÇ</b> - so you can use it from the browser to replace <a href="http://socket.io/sente" target="_blank">http://socket.io/sente</a>?
It seems better in that it handles backpressure etc. and even webRTC. But does it has the concept of upgrade / fallback between protocols?</z><z id="t1505315097" t="shader I&apos;m not sure. At least the description seems to indicate that it can route data between peers using whatever connections are available, so it should handle protocol upgrade and fallback. I don&apos;t know how much has actually been implemented yet though. These are all things I&apos;ll have to figure out if I really want a clojure port though..."><y>#</y><d>2017-09-13</d><h>15:04</h><w>shader</w>I&apos;m not sure. At least the description seems to indicate that it can route data between peers using whatever connections are available, so it should handle protocol upgrade and fallback. I don&apos;t know how much has actually been implemented yet though. These are all things I&apos;ll have to figure out if I really want a clojure port though...</z><z id="t1505330515" t="shader I was asking in a more general channel earlier, but do you think it makes more sense to create one repo for all of the libp2p stuff, or split it into modules the way the libp2p team did for go and js?"><y>#</y><d>2017-09-13</d><h>19:21</h><w>shader</w>I was asking in a more general channel earlier, but do you think it makes more sense to create one repo for all of the libp2p stuff, or split it into modules the way the libp2p team did for go and js?</z><z id="t1505380535" t="miikka I would put it into one repo; that tends to make everything simpler."><y>#</y><d>2017-09-14</d><h>09:15</h><w>miikka</w>I would put it into one repo; that tends to make everything simpler.</z><z id="t1505496528" t="aengelberg The lack of error propagation in manifold streams makes me less confident in writing servers that use stream conversion to handle incoming data. For example, I would like to write a handler that takes an InputStream , converts it into a stream of chunks (easy enough with byte-streams ), then upload each of those chunks to S3 in a multipart upload. But what if the S3 API throws an error when uploading one of the chunks? The stream consumer will silently fail, but won&apos;t stop the upload. Any way to reconcile this lack of error propagation?"><y>#</y><d>2017-09-15</d><h>17:28</h><w>aengelberg</w>The lack of error propagation in manifold streams makes me less confident in writing servers that use stream conversion to handle incoming data. For example, I would like to write a handler that takes an <code>InputStream</code>, converts it into a stream of chunks (easy enough with <code>byte-streams</code>), then upload each of those chunks to S3 in a multipart upload. But what if the S3 API throws an error when uploading one of the chunks? The stream consumer will silently fail, but won&apos;t stop the upload. Any way to reconcile this lack of error propagation?</z><z id="t1505497828" t="dm3 Yeah, I‚Äôve registered an issue https://github.com/ztellman/manifold/issues/95 a while ago"><y>#</y><d>2017-09-15</d><h>17:50</h><w>dm3</w>Yeah, I‚Äôve registered an issue <a href="https://github.com/ztellman/manifold/issues/95" target="_blank">https://github.com/ztellman/manifold/issues/95</a> a while ago</z><z id="t1505497914" t="dm3 it even references a commit with an error-propagation implementation"><y>#</y><d>2017-09-15</d><h>17:51</h><w>dm3</w>it even references a commit with an error-propagation implementation</z><z id="t1505497941" t="dm3 [:attrs {:href &quot;/_/_/users/U066UJ2KE&quot;}] said that his experience with Lamina proved that attaching error handling to streams is more trouble than it‚Äôs worth."><y>#</y><d>2017-09-15</d><h>17:52</h><w>dm3</w><a>@ztellman</a> said that his experience with Lamina proved that attaching error handling to streams is more trouble than it‚Äôs worth.</z><z id="t1505497958" t="dm3 I disagree - for the same reasons you have, [:attrs {:href &quot;/_/_/users/U0516PHE3&quot;}]"><y>#</y><d>2017-09-15</d><h>17:52</h><w>dm3</w>I disagree - for the same reasons you have, <a>@aengelberg</a></z><z id="t1505497959" t="dm3 üôÇ"><y>#</y><d>2017-09-15</d><h>17:52</h><w>dm3</w><b>üôÇ</b></z><z id="t1505498077" t="aengelberg I&apos;m not convinced it&apos;s an easy problem to solve, either üôÇ In general, you&apos;d ideally like to be able to both propagate errors forward and backward. e.g. If something hands you a stream, you&apos;d like to know when the upstream processor stops due to failure. And if you hand something a stream, you&apos;d like to know when the downstream processor fails."><y>#</y><d>2017-09-15</d><h>17:54</h><w>aengelberg</w>I&apos;m not convinced it&apos;s an easy problem to solve, either <b>üôÇ</b> In general, you&apos;d ideally like to be able to both propagate errors forward and backward. e.g. If something hands you a stream, you&apos;d like to know when the upstream processor stops due to failure. And if you hand something a stream, you&apos;d like to know when the downstream processor fails.</z><z id="t1505500807" t="dm3 well, I‚Äôve implemented propagation downstream"><y>#</y><d>2017-09-15</d><h>18:40</h><w>dm3</w>well, I‚Äôve implemented propagation downstream</z><z id="t1505500827" t="dm3 upstream is a harder problem as sources don‚Äôt usually care about consumers"><y>#</y><d>2017-09-15</d><h>18:40</h><w>dm3</w>upstream is a harder problem as sources don‚Äôt usually care about consumers</z><z id="t1505500904" t="dm3 I don‚Äôt think you can really get by without the feature - in many parts of my code I‚Äôve resorted to passing tuples of (Stream, Deferred[Error]) through combinators"><y>#</y><d>2017-09-15</d><h>18:41</h><w>dm3</w>I don‚Äôt think you can really get by without the feature - in many parts of my code I‚Äôve resorted to passing tuples of <code>(Stream, Deferred[Error])</code> through combinators</z></g><g id="s3"><z id="t1505500915" t="dm3 Rx* libs have this too"><y>#</y><d>2017-09-15</d><h>18:41</h><w>dm3</w>Rx* libs have this too</z><z id="t1505512569" t="shader another stream library I like a lot, most.js, provides a recoverWith method: https://github.com/cujojs/most/blob/master/docs/api.md#recoverwith"><y>#</y><d>2017-09-15</d><h>21:56</h><w>shader</w>another stream library I like a lot, most.js, provides a recoverWith method: <a href="https://github.com/cujojs/most/blob/master/docs/api.md#recoverwith" target="_blank">https://github.com/cujojs/most/blob/master/docs/api.md#recoverwith</a></z><z id="t1505512603" t="shader it&apos;s an interesting solution, in that the error handler function is expected to provide a replacement stream"><y>#</y><d>2017-09-15</d><h>21:56</h><w>shader</w>it&apos;s an interesting solution, in that the error handler function is expected to provide a replacement stream</z><z id="t1505512660" t="shader in their example, you fall back to default data if you can&apos;t fetch data from a server"><y>#</y><d>2017-09-15</d><h>21:57</h><w>shader</w>in their example, you fall back to default data if you can&apos;t fetch data from a server</z><z id="t1505589746" t="Aleh Atsman hi, can someone explain how to use client_middleware, so that i can do not parse the response body manually?"><y>#</y><d>2017-09-16</d><h>19:22</h><w>Aleh Atsman</w>hi, can someone explain how to use client_middleware, so that i can do not parse the response body manually?</z><z id="t1505699875" t="ztellman [:attrs {:href &quot;/_/_/users/U0516PHE3&quot;}] [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] as a general rule, if there&apos;s an error somewhere in a stream transform or operation, the error will be logged and the stream will be closed"><y>#</y><d>2017-09-18</d><h>01:57</h><w>ztellman</w><a>@aengelberg</a> <a>@dm3</a> as a general rule, if there&apos;s an error somewhere in a stream transform or operation, the error will be logged and the stream will be closed</z><z id="t1505699896" t="ztellman which should lead to things being cleaned up"><y>#</y><d>2017-09-18</d><h>01:58</h><w>ztellman</w>which should lead to things being cleaned up</z><z id="t1505699908" t="ztellman if that&apos;s not true in some situations, I&apos;d consider that a bug in my implementation"><y>#</y><d>2017-09-18</d><h>01:58</h><w>ztellman</w>if that&apos;s not true in some situations, I&apos;d consider that a bug in my implementation</z><z id="t1505699955" t="aengelberg I get that it usually cleans up resources properly, but it does not propagate the fact that something went wrong. A stream closing could either mean success or failure."><y>#</y><d>2017-09-18</d><h>01:59</h><w>aengelberg</w>I get that it usually cleans up resources properly, but it does not propagate the fact that something went wrong. A stream closing could either mean success or failure.</z><z id="t1505699988" t="ztellman ah, I see"><y>#</y><d>2017-09-18</d><h>01:59</h><w>ztellman</w>ah, I see</z><z id="t1505700045" t="aengelberg core.async chans have a similar problem."><y>#</y><d>2017-09-18</d><h>02:00</h><w>aengelberg</w>core.async chans have a similar problem.</z><z id="t1505700068" t="ztellman error propagation is a bit tricky in general, imagine if src is being split across two different sinks, a and b"><y>#</y><d>2017-09-18</d><h>02:01</h><w>ztellman</w>error propagation is a bit tricky in general, imagine if <code>src</code> is being split across two different sinks, <code>a</code> and <code>b</code></z><z id="t1505700082" t="ztellman if a fails, should that cause src to yield an error too?"><y>#</y><d>2017-09-18</d><h>02:01</h><w>ztellman</w>if <code>a</code> fails, should that cause <code>src</code> to yield an error too?</z><z id="t1505700098" t="ztellman or should it just continue to feed into b ?"><y>#</y><d>2017-09-18</d><h>02:01</h><w>ztellman</w>or should it just continue to feed into <code>b</code>?</z><z id="t1505700172" t="ztellman more to the point, if you&apos;re feeding into a network socket and it closes, is that correct behavior or an error?"><y>#</y><d>2017-09-18</d><h>02:02</h><w>ztellman</w>more to the point, if you&apos;re feeding into a network socket and it closes, is that correct behavior or an error?</z><z id="t1505700220" t="ztellman I don&apos;t try to give anything richer than TCP offers, basically"><y>#</y><d>2017-09-18</d><h>02:03</h><w>ztellman</w>I don&apos;t try to give anything richer than TCP offers, basically</z><z id="t1505700263" t="ztellman in order to talk about something succeeding at the application level, you need to define your success criteria using logic layered atop the transport layer, not in the transport layer"><y>#</y><d>2017-09-18</d><h>02:04</h><w>ztellman</w>in order to talk about something succeeding at the application level, you need to define your success criteria using logic layered atop the transport layer, not in the transport layer</z><z id="t1505700303" t="ztellman in fairness, I absolutely could have put! fail with an error rather than return false if, say, map fails"><y>#</y><d>2017-09-18</d><h>02:05</h><w>ztellman</w>in fairness, I absolutely could have <code>put!</code> fail with an error rather than return false if, say, <code>map</code> fails</z><z id="t1505700337" t="ztellman but I suspect that people aren&apos;t checking for that, and in practice it would just cause the same error to be logged all the way up the topology"><y>#</y><d>2017-09-18</d><h>02:05</h><w>ztellman</w>but I suspect that people aren&apos;t checking for that, and in practice it would just cause the same error to be logged all the way up the topology</z><z id="t1505700427" t="aengelberg Great points"><y>#</y><d>2017-09-18</d><h>02:07</h><w>aengelberg</w>Great points</z><z id="t1505700445" t="ztellman this isn&apos;t to say that you couldn&apos;t create a richer error model, I&apos;m sure other stream libraries do"><y>#</y><d>2017-09-18</d><h>02:07</h><w>ztellman</w>this isn&apos;t to say that you couldn&apos;t create a richer error model, I&apos;m sure other stream libraries do</z><z id="t1505700491" t="ztellman but being the lowest common denominator across all stream abstractions makes that difficult"><y>#</y><d>2017-09-18</d><h>02:08</h><w>ztellman</w>but being the lowest common denominator across all stream abstractions makes that difficult</z><z id="t1505700579" t="aengelberg My original complaint stemmed from the fact that I wanted to convert InputStream into (seq-of bytes) , and byte-streams was (unnecessarily?) using a manifold stream in the conversion path, and that conversion silenced errors such as amazon.s3.SocketTimeoutException that I wanted the consumer of the lazy seq to see."><y>#</y><d>2017-09-18</d><h>02:09</h><w>aengelberg</w>My original complaint stemmed from the fact that I wanted to convert <code>InputStream</code> into <code>(seq-of bytes)</code>, and <code>byte-streams</code> was (unnecessarily?) using a manifold stream in the conversion path, and that conversion silenced errors such as <code>amazon.s3.SocketTimeoutException</code> that I wanted the consumer of the lazy seq to see.</z><z id="t1505700604" t="ztellman hmm"><y>#</y><d>2017-09-18</d><h>02:10</h><w>ztellman</w>hmm</z><z id="t1505700623" t="ztellman it wasn&apos;t even logging the error?"><y>#</y><d>2017-09-18</d><h>02:10</h><w>ztellman</w>it wasn&apos;t even logging the error?</z><z id="t1505700627" t="aengelberg It was logging the error"><y>#</y><d>2017-09-18</d><h>02:10</h><w>aengelberg</w>It was logging the error</z><z id="t1505700629" t="aengelberg which is great"><y>#</y><d>2017-09-18</d><h>02:10</h><w>aengelberg</w>which is great</z><z id="t1505700635" t="ztellman but it wasn&apos;t propagating it upwards"><y>#</y><d>2017-09-18</d><h>02:10</h><w>ztellman</w>but it wasn&apos;t propagating it upwards</z><z id="t1505700637" t="aengelberg yes"><y>#</y><d>2017-09-18</d><h>02:10</h><w>aengelberg</w>yes</z><z id="t1505700646" t="ztellman that is an unnecessary conversion to a stream, I think"><y>#</y><d>2017-09-18</d><h>02:10</h><w>ztellman</w>that is an unnecessary conversion to a stream, I think</z><z id="t1505700650" t="aengelberg which I need to happen for my job to die and mark itself as failure"><y>#</y><d>2017-09-18</d><h>02:10</h><w>aengelberg</w>which I need to happen for my job to die and mark itself as failure</z><z id="t1505700661" t="ztellman I just need to define a new edge in the conversion graph"><y>#</y><d>2017-09-18</d><h>02:11</h><w>ztellman</w>I just need to define a new edge in the conversion graph</z><z id="t1505700729" t="ztellman but I think the same issue would happen if the connection just closed, right?"><y>#</y><d>2017-09-18</d><h>02:12</h><w>ztellman</w>but I think the same issue would happen if the connection just closed, right?</z><z id="t1505700741" t="aengelberg it depends on the implementation"><y>#</y><d>2017-09-18</d><h>02:12</h><w>aengelberg</w>it depends on the implementation</z><z id="t1505700742" t="ztellman is the S3 client validating the length of the value?"><y>#</y><d>2017-09-18</d><h>02:12</h><w>ztellman</w>is the S3 client validating the length of the value?</z><z id="t1505700757" t="aengelberg in this case I was reading from S3, not writing to it"><y>#</y><d>2017-09-18</d><h>02:12</h><w>aengelberg</w>in this case I was reading from S3, not writing to it</z><z id="t1505700772" t="ztellman right, so what happens if the connection closes halfway through downloading the value"><y>#</y><d>2017-09-18</d><h>02:12</h><w>ztellman</w>right, so what happens if the connection closes halfway through downloading the value</z><z id="t1505700776" t="ztellman is an exception thrown?"><y>#</y><d>2017-09-18</d><h>02:12</h><w>ztellman</w>is an exception thrown?</z><z id="t1505700779" t="aengelberg but I have a different, separate use case that also suffered from this problem in which I was uploading each chunk as a batch to S3 which could potentially fail"><y>#</y><d>2017-09-18</d><h>02:12</h><w>aengelberg</w>but I have a different, separate use case that also suffered from this problem in which I was uploading each chunk as a batch to S3 which could potentially fail</z><z id="t1505700804" t="ztellman because if so, that strikes me as a little weird, you wouldn&apos;t expect the InputStream to be doing that for you"><y>#</y><d>2017-09-18</d><h>02:13</h><w>ztellman</w>because if so, that strikes me as a little weird, you wouldn&apos;t expect the InputStream to be doing that for you</z><z id="t1505700806" t="aengelberg good question, I&apos;d have to think back to the last time I saw this error happen in prod"><y>#</y><d>2017-09-18</d><h>02:13</h><w>aengelberg</w>good question, I&apos;d have to think back to the last time I saw this error happen in prod</z><z id="t1505700845" t="ztellman and this comes back to my original point of &quot;you get some data, it&apos;s up to you to decide if it&apos;s the correct, full data&quot;"><y>#</y><d>2017-09-18</d><h>02:14</h><w>ztellman</w>and this comes back to my original point of &quot;you get some data, it&apos;s up to you to decide if it&apos;s the correct, full data&quot;</z><z id="t1505700867" t="ztellman I know you don&apos;t control the S3 client api, so I&apos;m not really pointing the finger at you here"><y>#</y><d>2017-09-18</d><h>02:14</h><w>ztellman</w>I know you don&apos;t control the S3 client api, so I&apos;m not really pointing the finger at you here</z><z id="t1505700913" t="ztellman but with anything over the network, lack of an explicit error is not a guarantee that everything&apos;s correct, which is kind of why I haven&apos;t worried about this part of Manifold very much"><y>#</y><d>2017-09-18</d><h>02:15</h><w>ztellman</w>but with anything over the network, lack of an explicit error is not a guarantee that everything&apos;s correct, which is kind of why I haven&apos;t worried about this part of Manifold very much</z><z id="t1505700928" t="aengelberg I could easily reproduce this by just manually opening an inputstream, waiting out the timeout, and seeing what happens"><y>#</y><d>2017-09-18</d><h>02:15</h><w>aengelberg</w>I could easily reproduce this by just manually opening an inputstream, waiting out the timeout, and seeing what happens</z><z id="t1505700930" t="ztellman (which isn&apos;t a great defense, tbh, but that&apos;s my rationale)"><y>#</y><d>2017-09-18</d><h>02:15</h><w>ztellman</w>(which isn&apos;t a great defense, tbh, but that&apos;s my rationale)</z><z id="t1505701060" t="aengelberg so basically my takeaway here is that I need to figure out what exact error I want to be able to see before I complain about not seeing it"><y>#</y><d>2017-09-18</d><h>02:17</h><w>aengelberg</w>so basically my takeaway here is that I need to figure out what exact error I want to be able to see before I complain about not seeing it</z><z id="t1505701125" t="ztellman possibly, or at least consider that failing to process everything isn&apos;t always signaled by an exception"><y>#</y><d>2017-09-18</d><h>02:18</h><w>ztellman</w>possibly, or at least consider that failing to process everything isn&apos;t always signaled by an exception</z><z id="t1505701177" t="ztellman so having exception propagation doesn&apos;t actually mean all issues are surfaced, and may lead to thinking that things are correct when they aren&apos;t"><y>#</y><d>2017-09-18</d><h>02:19</h><w>ztellman</w>so having exception propagation doesn&apos;t actually mean all issues are surfaced, and may lead to thinking that things are correct when they aren&apos;t</z><z id="t1505701229" t="aengelberg I&apos;m fairly confident that my S3 read sockettimeout issue was somehow surfacing through one of the InputStream methods. But I&apos;ll need to confirm since you make an interesting point that it might just close it instead"><y>#</y><d>2017-09-18</d><h>02:20</h><w>aengelberg</w>I&apos;m fairly confident that my S3 read sockettimeout issue was somehow surfacing through one of the InputStream methods. But I&apos;ll need to confirm since you make an interesting point that it might just close it instead</z><z id="t1506311101" t="bbss I&apos;m using aleph and manifold for communicating with the StarCraft II AI API. Yesterday I tried my hand at a run-loop and I completed one of the challenges using Clojure (yay!). I&apos;m using alephs websocket to connect to the api which uses protobuf to communicate. And I utilize streams for the run-loop, but after around 100 steps into the game I get a memory leak notification which later makes the websockets requests fail. Sep 25, 2017 12:26:19 PM io.netty.util.ResourceLeakDetector reportTracedLeak SEVERE: LEAK: ByteBuf.release() was not called before it&apos;s garbage-collected. See for more information. "><y>#</y><d>2017-09-25</d><h>03:45</h><w>bbss</w>I&apos;m using aleph and manifold for communicating with the StarCraft II AI API. Yesterday I tried my hand at a run-loop and I completed one of the challenges using Clojure (yay!). I&apos;m using alephs websocket to connect to the api which uses protobuf to communicate. And I utilize streams for the run-loop, but after around 100 steps into the game I get a memory leak notification which later makes the websockets requests fail.

<pre>Sep 25, 2017 12:26:19 PM io.netty.util.ResourceLeakDetector reportTracedLeak
SEVERE: LEAK: ByteBuf.release() was not called before it&apos;s garbage-collected. See  for more information.
</pre></z><z id="t1506311215" t="bbss I&apos;m not sure what could be causing it. I found https://groups.google.com/forum/#!msg/aleph-lib/-41TvS0uKVM/KF7PE_iOErwJ but that should now not happen with the defaults anymore."><y>#</y><d>2017-09-25</d><h>03:46</h><w>bbss</w>I&apos;m not sure what could be causing it. I found 
<a href="https://groups.google.com/forum/#!msg/aleph-lib/-41TvS0uKVM/KF7PE_iOErwJ" target="_blank">https://groups.google.com/forum/#!msg/aleph-lib/-41TvS0uKVM/KF7PE_iOErwJ</a>
but that should now not happen with the defaults anymore.</z><z id="t1506321785" t="bbss Not sure if the stacktrace is visible on slack, I don&apos;t have any storage space in my slack workspace suspect"><y>#</y><d>2017-09-25</d><h>06:43</h><w>bbss</w>Not sure if the stacktrace is visible on slack, I don&apos;t have any storage space in my slack workspace <b>suspect</b></z><z id="t1506322813" t="miikka Hmmh. This is 0.4.2, right?"><y>#</y><d>2017-09-25</d><h>07:00</h><w>miikka</w>Hmmh. This is 0.4.2, right?</z><z id="t1506323057" t="miikka Quickly browsing the code, I&apos;m not sure what is supposed to release the bytebufs allocated by client.clj:420"><y>#</y><d>2017-09-25</d><h>07:04</h><w>miikka</w>Quickly browsing the code, I&apos;m not sure what is supposed to release the bytebufs allocated by client.clj:420</z><z id="t1506323364" t="bbss it might help to see what I am doing, might be doing stupid stuff: https://github.com/bbss/cljsc2/blob/master/src/cljsc2/clj/core.clj#L56 create a websocket connection to the starcraft 2 client https://github.com/bbss/cljsc2/blob/master/src/cljsc2/clj/core.clj#L33 put requests on the websocket connection"><y>#</y><d>2017-09-25</d><h>07:09</h><w>bbss</w>it might help to see what I am doing, might be doing stupid stuff:
<a href="https://github.com/bbss/cljsc2/blob/master/src/cljsc2/clj/core.clj#L56" target="_blank">https://github.com/bbss/cljsc2/blob/master/src/cljsc2/clj/core.clj#L56</a>
create a websocket connection to the starcraft 2 client

<a href="https://github.com/bbss/cljsc2/blob/master/src/cljsc2/clj/core.clj#L33" target="_blank">https://github.com/bbss/cljsc2/blob/master/src/cljsc2/clj/core.clj#L33</a>
put requests on the websocket connection</z><z id="t1506323384" t="bbss [:attrs {:href &quot;/_/_/users/U1NDXLDUG&quot;}] uhm, not 0.4.2. it is 0.4.3."><y>#</y><d>2017-09-25</d><h>07:09</h><w>bbss</w><a>@miikka</a> uhm, not 0.4.2. it is 0.4.3.</z><z id="t1506323511" t="miikka Uh, right. Could you try with 0.4.4-alpha4?"><y>#</y><d>2017-09-25</d><h>07:11</h><w>miikka</w>Uh, right. Could you try with 0.4.4-alpha4?</z><z id="t1506323521" t="bbss okay, let me try"><y>#</y><d>2017-09-25</d><h>07:12</h><w>bbss</w>okay, let me try</z><z id="t1506323527" t="miikka 0.4.4&apos;s changelog inculdes &quot;fix memory lead in handling of binary websocket frames&quot;"><y>#</y><d>2017-09-25</d><h>07:12</h><w>miikka</w>0.4.4&apos;s changelog inculdes &quot;fix memory lead in handling of binary websocket frames&quot;</z><z id="t1506323546" t="miikka which sounds promising"><y>#</y><d>2017-09-25</d><h>07:12</h><w>miikka</w>which sounds promising</z><z id="t1506323651" t="bbss that does sound very promising, I should have checked that out myself. Fingers crossed haha."><y>#</y><d>2017-09-25</d><h>07:14</h><w>bbss</w>that does sound very promising, I should have checked that out myself. Fingers crossed haha.</z><z id="t1506323850" t="bbss kiitos [:attrs {:href &quot;/_/_/users/U1NDXLDUG&quot;}] the error seems to be gone!"><y>#</y><d>2017-09-25</d><h>07:17</h><w>bbss</w>kiitos <a>@miikka</a> the error seems to be gone!</z><z id="t1506353415" t="ianbishop Has anyone had any experience with using status as a deferred? I&apos;m looking to use aleph for a proxy-like service where the status will also be decided based off an asynchronous request"><y>#</y><d>2017-09-25</d><h>15:30</h><w>ianbishop</w>Has anyone had any experience with using status as a deferred? I&apos;m looking to use aleph for a proxy-like service where the status will also be decided based off an asynchronous request</z><z id="t1506354462" t="ianbishop I guess I can probably let-flow on the status in middleware"><y>#</y><d>2017-09-25</d><h>15:47</h><w>ianbishop</w>I guess I can probably let-flow on the status in middleware</z><z id="t1506451036" t="lxsameer hey folks, is there any way to connect several sources to a sink ?"><y>#</y><d>2017-09-26</d><h>18:37</h><w>lxsameer</w>hey folks, is there any way to connect several sources to a sink ?</z><z id="t1506453540" t="dm3 (stream/connect source-1 sink)"><y>#</y><d>2017-09-26</d><h>19:19</h><w>dm3</w><code>(stream/connect source-1 sink)</code></z><z id="t1506453552" t="dm3 etc"><y>#</y><d>2017-09-26</d><h>19:19</h><w>dm3</w>etc</z><z id="t1507060266" t="manderson Anyone know of any &quot;best practices&quot; for tuning an Aleph server? I&apos;m troubleshooting some &quot;connection refused&quot; errors clients are seeing when my server is under heavy load. Guess I&apos;m just looking for a starting point to understand all the &quot;knobs&quot; available on &quot;start-server&quot; as I troubleshoot. Thanks."><y>#</y><d>2017-10-03</d><h>19:51</h><w>manderson</w>Anyone know of any &quot;best practices&quot; for tuning an Aleph server? I&apos;m troubleshooting some &quot;connection refused&quot; errors clients are seeing when my server is under heavy load. Guess I&apos;m just looking for a starting point to understand all the &quot;knobs&quot; available on &quot;start-server&quot; as I troubleshoot. Thanks.</z><z id="t1507122812" t="chrisblom [:attrs {:href &quot;/_/_/users/U0DEB9H5W&quot;}] i found it useful to monitor aleph&apos;s theadpool"><y>#</y><d>2017-10-04</d><h>13:13</h><w>chrisblom</w><a>@manderson</a> i found it useful to monitor aleph&apos;s theadpool</z><z id="t1507123336" t="manderson ah cool, thanks [:attrs {:href &quot;/_/_/users/U0P1MGUSX&quot;}] I&apos;ll give it a try"><y>#</y><d>2017-10-04</d><h>13:22</h><w>manderson</w>ah cool, thanks <a>@chrisblom</a> I&apos;ll give it a try</z><z id="t1507584706" t="lxsameer I set up a pipeline of streams connecting to each other like A -&gt; B -&gt; C"><y>#</y><d>2017-10-09</d><h>21:31</h><w>lxsameer</w>I set up a pipeline of streams connecting to each other like A -&gt; B -&gt; C</z><z id="t1507584785" t="lxsameer put! a value to A derefs to true, but can&apos;t take the value from B uisng try-take! . It timeouts."><y>#</y><d>2017-10-09</d><h>21:33</h><w>lxsameer</w><code>put!</code> a value to A derefs to true, but can&apos;t take the value from B uisng <code>try-take!</code>. It timeouts.</z><z id="t1507584816" t="lxsameer It confirmed that B is downstream of A. and a quick REPL version works"><y>#</y><d>2017-10-09</d><h>21:33</h><w>lxsameer</w>It confirmed that B is downstream of A. and a quick REPL version works</z><z id="t1507584828" t="lxsameer but not in the app. Anyidea how to debug it ?"><y>#</y><d>2017-10-09</d><h>21:33</h><w>lxsameer</w>but not in the app. Anyidea how to debug it ?</z><z id="t1507585329" t="lxsameer i can&apos;t even put! and then take! from A itself ?"><y>#</y><d>2017-10-09</d><h>21:42</h><w>lxsameer</w>i can&apos;t even put! and then take! from A itself ?</z><z id="t1507586989" t="ehashman Sounds like you have a type mismatch"><y>#</y><d>2017-10-09</d><h>22:09</h><w>ehashman</w>Sounds like you have a type mismatch</z><z id="t1507587020" t="ehashman Put! Itself needs to return a boolean but also stick an object into the next stream"><y>#</y><d>2017-10-09</d><h>22:10</h><w>ehashman</w>Put! Itself needs to return a boolean but also stick an object into the next stream</z><z id="t1507587037" t="ehashman Well, a deferred boolean, that is"><y>#</y><d>2017-10-09</d><h>22:10</h><w>ehashman</w>Well, a deferred boolean, that is</z><z id="t1507587063" t="lxsameer yeah the weird part is the it derefs to true"><y>#</y><d>2017-10-09</d><h>22:11</h><w>lxsameer</w>yeah the weird part is the it derefs to true</z><z id="t1507587113" t="ehashman That&apos;s so you can determine whether the connecting function succeeded in the put or not"><y>#</y><d>2017-10-09</d><h>22:11</h><w>ehashman</w>That&apos;s so you can determine whether the connecting function succeeded in the put or not</z><z id="t1507587119" t="lxsameer it&apos;s now 13 days which I&apos;m trying to figure this out"><y>#</y><d>2017-10-09</d><h>22:11</h><w>lxsameer</w>it&apos;s now 13 days which I&apos;m trying to figure this out</z><z id="t1507587124" t="ehashman The return value of the put! Is not the object itself"><y>#</y><d>2017-10-09</d><h>22:12</h><w>ehashman</w>The return value of the put! Is not the object itself</z><z id="t1507587154" t="lxsameer I see, I mean by derefing to true it means that it successfully put the value into stream. right ?"><y>#</y><d>2017-10-09</d><h>22:12</h><w>lxsameer</w>I see, I mean by derefing to true it means that it successfully put the value into stream. right ?</z><z id="t1507587269" t="ehashman Yes"><y>#</y><d>2017-10-09</d><h>22:14</h><w>ehashman</w>Yes</z><z id="t1507587276" t="ehashman It&apos;s a little weird"><y>#</y><d>2017-10-09</d><h>22:14</h><w>ehashman</w>It&apos;s a little weird</z><z id="t1507587323" t="lxsameer I even tried to walk the pipeline using downstream function to confirm the connections,"><y>#</y><d>2017-10-09</d><h>22:15</h><w>lxsameer</w>I even tried to walk the pipeline using <code>downstream</code> function to confirm the connections,</z><z id="t1507618902" t="dm3 [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] once you connect the streams together, e.g. A -&gt; B -&gt; C, and you put! into A , you‚Äôll only be able to take from C ."><y>#</y><d>2017-10-10</d><h>07:01</h><w>dm3</w><a>@lxsameer</a> once you connect the streams together, e.g. A -&gt; B -&gt; C, and you <code>put!</code> into <code>A</code>, you‚Äôll only be able to take from <code>C</code>.</z><z id="t1507619937" t="lxsameer [:attrs {:href &quot;/_/_/users/U0D33A4JF&quot;}] good point. Thanks a lot"><y>#</y><d>2017-10-10</d><h>07:18</h><w>lxsameer</w><a>@dm3</a> good point. Thanks a lot</z><z id="t1507620000" t="dm3 think of it as water running through pipes üôÇ"><y>#</y><d>2017-10-10</d><h>07:20</h><w>dm3</w>think of it as water running through pipes <b>üôÇ</b></z><z id="t1507620092" t="lxsameer Yeah. It&apos;s a good point which is missing from the docs"><y>#</y><d>2017-10-10</d><h>07:21</h><w>lxsameer</w>Yeah. It&apos;s a good point which is missing from the docs</z><z id="t1510323993" t="karlis Hi all! This is more of a manifold question, but I&apos;ll ask this here: are there easy ways to transform a deferred to a core.async promise channel? after quick read through docs all interfacing with core.async happens through streams."><y>#</y><d>2017-11-10</d><h>14:26</h><w>karlis</w>Hi all! This is more of a <code>manifold</code> question, but I&apos;ll ask this here: are there easy ways to transform a deferred to a core.async promise channel? after quick read through docs all interfacing with core.async happens through streams.</z><z id="t1510331737" t="dm3 I think you have to go through streams or create something yourself, like: (defn deferred-&gt;chan [d] (let [c (async/chan)] (d/on-realized d #(async/put! c [:value %]) #(async/put! c [:error %])) c)) "><y>#</y><d>2017-11-10</d><h>16:35</h><w>dm3</w>I think you have to go through streams or create something yourself, like:
<pre>(defn deferred-&gt;chan [d] (let [c (async/chan)] (d/on-realized d #(async/put! c [:value %]) #(async/put! c [:error %])) c))
</pre></z><z id="t1510332047" t="mpenet you can use an async/promise-chan for extra points"><y>#</y><d>2017-11-10</d><h>16:40</h><w>mpenet</w>you can use an async/promise-chan for extra points</z><z id="t1510332055" t="mpenet saves some resources too"><y>#</y><d>2017-11-10</d><h>16:40</h><w>mpenet</w>saves some resources too</z><z id="t1510821385" t="karlis thanks! on-realized did the trick. finally had time to test it out üôÇ"><y>#</y><d>2017-11-16</d><h>08:36</h><w>karlis</w>thanks! <code>on-realized</code> did the trick. finally had time to test it out <b>üôÇ</b></z><z id="t1512448655" t="jfntn aleph.http.encoding&gt; (encode-base64 &quot;val&quot;) ClassCastException java.nio.HeapByteBuffer cannot be cast to io.netty.buffer.ByteBuf aleph.http.encoding/encode-base64 (form-init3445602468191842931.clj:34) "><y>#</y><d>2017-12-05</d><h>04:37</h><w>jfntn</w><pre>aleph.http.encoding&gt; (encode-base64 &quot;val&quot;)
ClassCastException java.nio.HeapByteBuffer cannot be cast to io.netty.buffer.ByteBuf  aleph.http.encoding/encode-base64 (form-init3445602468191842931.clj:34)
</pre></z><z id="t1512448661" t="jfntn Am I missing something here?"><y>#</y><d>2017-12-05</d><h>04:37</h><w>jfntn</w>Am I missing something here?</z><z id="t1512452117" t="jfntn I‚Äôm unable to reproduce a working curl multipart upload: curl -X POST -F &quot; With aleph‚Äôs http client I have: (http.client/request {:url &quot;http://...&quot; :request-method :post :multipart [{:part-name &quot;file&quot; :name &quot;foo.jpg&quot; :mime-type &quot;image/jpeg&quot; :content (io/file (io/resource &quot;foo.jpg&quot;))}]}) The request goes through but the server is not reading the data correctly, I inspected the requests with Postman and realized the Content-Length header is completely different, as well as the encoding. That‚Äôs when I ran into the ClassCastException trying to set the :transfer-encoding to :base64 on the part."><y>#</y><d>2017-12-05</d><h>05:35</h><w>jfntn</w>I‚Äôm unable to reproduce a working curl multipart upload:

<pre>curl -X POST  -F &quot;</pre>

With aleph‚Äôs http client I have:

<pre>(http.client/request
 {:url            &quot;http://...&quot;
  :request-method :post
  :multipart      [{:part-name &quot;file&quot;
                    :name      &quot;foo.jpg&quot;
                    :mime-type &quot;image/jpeg&quot;
                    :content   (io/file (io/resource &quot;foo.jpg&quot;))}]})
</pre>
The request goes through but the server is not reading the data correctly, I inspected the requests with Postman and realized the Content-Length header is completely different, as well as the encoding. 

That‚Äôs when I ran into the ClassCastException trying to set the <code>:transfer-encoding</code> to <code>:base64</code> on the part.</z><z id="t1512484744" t="jfntn ^cc [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] ‚Äî sorry for the ping but I noticed you contributed that feature"><y>#</y><d>2017-12-05</d><h>14:39</h><w>jfntn</w>^cc <a>@kachayev</a> ‚Äî sorry for the ping but I noticed you contributed that feature</z><z id="t1512486012" t="kachayev [:attrs {:href &quot;/_/_/users/U0CJ8PTE1&quot;}] I‚Äôm not sure it‚Äôs enough information for me to troubleshoot this"><y>#</y><d>2017-12-05</d><h>15:00</h><w>kachayev</w><a>@jfntn</a> I‚Äôm not sure it‚Äôs enough information for me to troubleshoot this</z><z id="t1512486032" t="kachayev Would you please DM me entire request/response?"><y>#</y><d>2017-12-05</d><h>15:00</h><w>kachayev</w>Would you please DM me entire request/response?</z><z id="t1512486282" t="jfntn [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] can do in 30 min, commuting now"><y>#</y><d>2017-12-05</d><h>15:04</h><w>jfntn</w><a>@kachayev</a> can do in 30 min, commuting now</z><z id="t1512486310" t="jfntn FYI tried clj-http and it works with the same params "><y>#</y><d>2017-12-05</d><h>15:05</h><w>jfntn</w>FYI tried clj-http and it works with the same params </z><z id="t1514998113" t="Yuanting I am using aleph with websocket. I can receive a few messages then the connection close. How can I keep the connection open?"><y>#</y><d>2018-01-03</d><h>16:48</h><w>Yuanting</w>I am using aleph with websocket. I can receive a few messages then the connection close. How can I keep the connection open?</z><z id="t1515286028" t="gmercer [:attrs {:href &quot;/_/_/users/U87Q8PRRN&quot;}] It&apos;s not that the connection has closed, it is the daemon threads exiting - does the close message arrive after one minute ?"><y>#</y><d>2018-01-07</d><h>00:47</h><w>gmercer</w><a>@yuantingliu</a> It&apos;s not that the connection has closed, it is the daemon threads exiting - does the close message arrive after one minute ?</z><z id="t1515423846" t="Yuanting [:attrs {:href &quot;/_/_/users/U2MPUENUC&quot;}] Thanks. I found the problem. aleph did not handle the heartbeat message correctly."><y>#</y><d>2018-01-08</d><h>15:04</h><w>Yuanting</w><a>@gmercer</a> Thanks. I found the problem. aleph did not handle the heartbeat message correctly.</z><z id="t1515530174" t="gmercer [:attrs {:href &quot;/_/_/users/U87Q8PRRN&quot;}] Can you explain what you did to get your example working? TIA"><y>#</y><d>2018-01-09</d><h>20:36</h><w>gmercer</w><a>@yuantingliu</a> Can you explain what you did to get your example working? TIA</z><z id="t1515534656" t="Yuanting [:attrs {:href &quot;/_/_/users/U2MPUENUC&quot;}] aleph ignored ping message. I add the logic when receive ping message, send pong message back"><y>#</y><d>2018-01-09</d><h>21:50</h><w>Yuanting</w><a>@gmercer</a> aleph ignored ping message. I add the logic when receive ping message, send pong message back</z><z id="t1517373272" t="sooheon Hi, anyone know of more fleshed out examples of manifold / aleph usage besides the docs?"><y>#</y><d>2018-01-31</d><h>04:34</h><w>sooheon</w>Hi, anyone know of more fleshed out examples of manifold / aleph usage besides the docs?</z><z id="t1517373537" t="sooheon Or barring that, maybe a good general resource to learn the asynchronous processing mindset/paradigm?"><y>#</y><d>2018-01-31</d><h>04:38</h><w>sooheon</w>Or barring that, maybe a good general resource to learn the asynchronous processing mindset/paradigm?</z><z id="t1517386755" t="danielcompton Yada source code is pretty good"><y>#</y><d>2018-01-31</d><h>08:19</h><w>danielcompton</w>Yada source code is pretty good</z><z id="t1517411102" t="ehashman I have found that writing code is the best recipe for that"><y>#</y><d>2018-01-31</d><h>15:05</h><w>ehashman</w>I have found that writing code is the best recipe for that</z><z id="t1517411134" t="ehashman Unfortunately most of the interesting stuff I&apos;ve done at work is paywalled, but here&apos;s a small library with some very simple examples if that helps: https://github.com/RackSec/alertlogic-lib/blob/master/src/alertlogic_lib/core.clj"><y>#</y><d>2018-01-31</d><h>15:05</h><w>ehashman</w>Unfortunately most of the interesting stuff I&apos;ve done at work is paywalled, but here&apos;s a small library with some very simple examples if that helps: <a href="https://github.com/RackSec/alertlogic-lib/blob/master/src/alertlogic_lib/core.clj" target="_blank">https://github.com/RackSec/alertlogic-lib/blob/master/src/alertlogic_lib/core.clj</a></z><z id="t1517416494" t="mccraigmccraig a couple more examples:"><y>#</y><d>2018-01-31</d><h>16:34</h><w>mccraigmccraig</w>a couple more examples:</z><z id="t1517416518" t="mccraigmccraig on the more general manifold / async processing tip, here&apos;s our stream-join implementation which has quickly become a central part of our platform - https://github.com/employeerepublic/promisespromises/blob/master/src/prpr/stream/cross.clj#L491"><y>#</y><d>2018-01-31</d><h>16:35</h><w>mccraigmccraig</w>on the more general manifold / async processing tip, here&apos;s our stream-join implementation which has quickly become a central part of our platform - <a href="https://github.com/employeerepublic/promisespromises/blob/master/src/prpr/stream/cross.clj#L491" target="_blank">https://github.com/employeerepublic/promisespromises/blob/master/src/prpr/stream/cross.clj#L491</a></z><z id="t1517416655" t="mccraigmccraig and our async cassandra connector (with a sadly out of date README) - https://github.com/employeerepublic/er-cassandra"><y>#</y><d>2018-01-31</d><h>16:37</h><w>mccraigmccraig</w>and our async cassandra connector (with a sadly out of date README) - <a href="https://github.com/employeerepublic/er-cassandra" target="_blank">https://github.com/employeerepublic/er-cassandra</a></z><z id="t1517416711" t="mccraigmccraig both are based around manifold deferreds and streams, with a heavy sprinkling of funcool/cats promise monad"><y>#</y><d>2018-01-31</d><h>16:38</h><w>mccraigmccraig</w>both are based around manifold deferreds and streams, with a heavy sprinkling of funcool/cats promise monad</z><z id="t1518007552" t="sooheon Wow this slack moves quick--I think [:attrs {:href &quot;/_/_/users/U0MPXFNLE&quot;}] and [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] are replying to my question but the question‚Äôs gone already. Thanks for the links, I‚Äôll be sure to check them out!"><y>#</y><d>2018-02-07</d><h>12:45</h><w>sooheon</w>Wow this slack moves quick--I think <a>@ehashman</a> and <a>@mccraigmccraig</a> are replying to my question but the question‚Äôs gone already. Thanks for the links, I‚Äôll be sure to check them out!</z><z id="t1518108757" t="borkdude Did anyone have this exception before? https://sentry.io/share/issue/3bedab73bf5f45c49910040916148d6e/"><y>#</y><d>2018-02-08</d><h>16:52</h><w>borkdude</w>Did anyone have this exception before?
<a href="https://sentry.io/share/issue/3bedab73bf5f45c49910040916148d6e/" target="_blank">https://sentry.io/share/issue/3bedab73bf5f45c49910040916148d6e/</a></z><z id="t1518108773" t="borkdude we don‚Äôt know what‚Äôs triggering it, but we see it now and then"><y>#</y><d>2018-02-08</d><h>16:52</h><w>borkdude</w>we don‚Äôt know what‚Äôs triggering it, but we see it now and then</z><z id="t1518780736" t="logistark Hi, i am trying to instrumentalize my app and i am trying to use manifold.executor/register-execute-pool-stats-callback and publish this information on an endpoint"><y>#</y><d>2018-02-16</d><h>11:32</h><w>logistark</w>Hi, i am trying to instrumentalize my app and i am trying to use manifold.executor/register-execute-pool-stats-callback and publish this information on an endpoint</z><z id="t1518780757" t="logistark Has anyone did something similar?"><y>#</y><d>2018-02-16</d><h>11:32</h><w>logistark</w>Has anyone did something similar?</z><z id="t1519404553" t="akiel I like to drain a stream into a vector without blocking. core.async has into which returns a channel. I look for a stream into which returns a deferred. stream-&gt;seq will block if I need the whole seq."><y>#</y><d>2018-02-23</d><h>16:49</h><w>akiel</w>I like to drain a stream into a vector without blocking. core.async has <code>into</code> which returns a channel. I look for a stream <code>into</code> which returns a deferred. <code>stream-&gt;seq</code> will block if I need the whole seq.</z><z id="t1519404917" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U07MC8H4Z&quot;}] (stream/reduce conj [] &lt;stream&gt;) should do it"><y>#</y><d>2018-02-23</d><h>16:55</h><w>mccraigmccraig</w><a>@akiel</a> <code>(stream/reduce conj [] &lt;stream&gt;)</code> should do it</z><z id="t1519404960" t="akiel oh there is a reduce - thanks!"><y>#</y><d>2018-02-23</d><h>16:56</h><w>akiel</w>oh there is a <code>reduce</code> - thanks!</z><z id="t1519405169" t="mccraigmccraig there is transducer support too [:attrs {:href &quot;/_/_/users/U07MC8H4Z&quot;}] with stream/transform ... make sure you use a recent version though - there was a bug which bit me before 0.1.7-alpha6"><y>#</y><d>2018-02-23</d><h>16:59</h><w>mccraigmccraig</w>there is transducer support too <a>@akiel</a> with <code>stream/transform</code> ... make sure you use a recent version though - there was a bug which bit me before 0.1.7-alpha6</z><z id="t1519405326" t="akiel I use still 0.1.6 what was the problem?"><y>#</y><d>2018-02-23</d><h>17:02</h><w>akiel</w>I use still <code>0.1.6</code> what was the problem?</z><z id="t1519405385" t="mccraigmccraig this - https://github.com/ztellman/manifold/issues/146"><y>#</y><d>2018-02-23</d><h>17:03</h><w>mccraigmccraig</w>this - <a href="https://github.com/ztellman/manifold/issues/146" target="_blank">https://github.com/ztellman/manifold/issues/146</a></z><z id="t1519405475" t="mccraigmccraig it doesn&apos;t affect reduce ... just transform with transducers with state"><y>#</y><d>2018-02-23</d><h>17:04</h><w>mccraigmccraig</w>it doesn&apos;t affect <code>reduce</code> ... just <code>transform</code> with transducers with state</z><z id="t1519405494" t="akiel ok thanks"><y>#</y><d>2018-02-23</d><h>17:04</h><w>akiel</w>ok thanks</z><z id="t1519588071" t="lxsameer hey folks, is it possible to control how manifold thread pool get created and how many thread they should use ?"><y>#</y><d>2018-02-25</d><h>19:47</h><w>lxsameer</w>hey folks, is it possible to control how manifold thread pool get created and how many thread they should use ?</z><z id="t1519640184" t="mccraigmccraig ru looking for more than is documented here [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] https://github.com/ztellman/manifold/blob/master/docs/execution.md ?"><y>#</y><d>2018-02-26</d><h>10:16</h><w>mccraigmccraig</w>ru looking for more than is documented here <a>@lxsameer</a> <a href="https://github.com/ztellman/manifold/blob/master/docs/execution.md" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/execution.md</a> ?</z><z id="t1519640221" t="lxsameer thanks"><y>#</y><d>2018-02-26</d><h>10:17</h><w>lxsameer</w>thanks</z><z id="t1519730834" t="lxsameer So basically in a stream pipeline from the beginning to the end I&apos;ll be in the same thread unless i use a feature which move the execution flow to another thread, or i have to manually use onto to move the execution flow"><y>#</y><d>2018-02-27</d><h>11:27</h><w>lxsameer</w>So basically in a stream pipeline  from the beginning to the end I&apos;ll be in the same thread unless i use a feature which move the execution flow to another thread, or i have to manually use <code>onto</code> to move the execution flow</z><z id="t1519730836" t="lxsameer right ?"><y>#</y><d>2018-02-27</d><h>11:27</h><w>lxsameer</w>right ?</z><z id="t1519731545" t="mccraigmccraig i&apos;m not sure [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] - most of my processing involves some async i/o and so moves to other threads anyway, so i&apos;ve never bothered to investigate"><y>#</y><d>2018-02-27</d><h>11:39</h><w>mccraigmccraig</w>i&apos;m not sure <a>@lxsameer</a> - most of my processing involves some async i/o and so moves to other threads anyway, so i&apos;ve never bothered to investigate</z><z id="t1519731592" t="lxsameer how do you force it to move to the blocking thread ? do you use blocking queues ?"><y>#</y><d>2018-02-27</d><h>11:39</h><w>lxsameer</w>how do you force it to move to the blocking thread ? do you use blocking queues ?</z><z id="t1519731949" t="mccraigmccraig uh, some misunderstanding i think - i don&apos;t do any blocking - i have async i/o ops which return Deferred values"><y>#</y><d>2018-02-27</d><h>11:45</h><w>mccraigmccraig</w>uh, some misunderstanding i think - i don&apos;t do any blocking - i have async i/o ops which return Deferred values</z><z id="t1519731985" t="lxsameer ow shoot, my bad"><y>#</y><d>2018-02-27</d><h>11:46</h><w>lxsameer</w>ow shoot, my bad</z><z id="t1519731987" t="lxsameer thanks man"><y>#</y><d>2018-02-27</d><h>11:46</h><w>lxsameer</w>thanks man</z><z id="t1519901420" t="mpenet seems like a dependency conflict"><y>#</y><d>2018-03-01</d><h>10:50</h><w>mpenet</w>seems like a dependency conflict</z><z id="t1519901446" t="mpenet netty artifact overwriting another within your app (or one of it&apos;s deps)"><y>#</y><d>2018-03-01</d><h>10:50</h><w>mpenet</w>netty artifact overwriting another within your app (or one of it&apos;s deps)</z><z id="t1519901472" t="mpenet lein pedantic could help you figure it out, or even lein deps üéÑ"><y>#</y><d>2018-03-01</d><h>10:51</h><w>mpenet</w>lein pedantic could help you figure it out, or even lein deps <b>üéÑ</b></z><z id="t1519901477" t="mpenet lein deps :tree"><y>#</y><d>2018-03-01</d><h>10:51</h><w>mpenet</w><code>lein deps :tree</code></z><z id="t1519962456" t="danielcompton [:attrs {:href &quot;/_/_/users/U98NWG10T&quot;}] yeah we need to see the tree"><y>#</y><d>2018-03-02</d><h>03:47</h><w>danielcompton</w><a>@jimenezsaezjoseantoni</a> yeah we need to see the tree</z><z id="t1519962470" t="danielcompton Also see https://github.com/ztellman/aleph/issues/335"><y>#</y><d>2018-03-02</d><h>03:47</h><w>danielcompton</w>Also see <a href="https://github.com/ztellman/aleph/issues/335" target="_blank">https://github.com/ztellman/aleph/issues/335</a></z><z id="t1519977806" t="logistark Yep, the issue was more related to the Aleph version that Luminus included üò•"><y>#</y><d>2018-03-02</d><h>08:03</h><w>logistark</w>Yep, the issue was more related to the Aleph version that Luminus included <b>üò•</b></z><z id="t1519977834" t="logistark I was using Aleph 4.2-Alpha8, upgrading to Aleph 4.2 solved the issue"><y>#</y><d>2018-03-02</d><h>08:03</h><w>logistark</w>I was using Aleph 4.2-Alpha8, upgrading to Aleph 4.2 solved the issue</z><z id="t1519977845" t="logistark ‚ò∫Ô∏è"><y>#</y><d>2018-03-02</d><h>08:04</h><w>logistark</w><b>‚ò∫Ô∏è</b></z><z id="t1520023030" t="lxsameer is there any autoreload feature for aleph webserver ? or i have to do it manually ?"><y>#</y><d>2018-03-02</d><h>20:37</h><w>lxsameer</w>is there any autoreload feature for aleph webserver ? or i have to do it manually ?</z><z id="t1520365917" t="daviddsison I‚Äôm running a websocket server via aleph and when the client sends a message that exceeds the max-frame-payload there is a warning and the websocket connection is closed. What would be the best way to send that message back to the client before closing? It‚Äôs making it hard to provide a decent message since the actual exception is captured and logged as a warning."><y>#</y><d>2018-03-06</d><h>19:51</h><w>daviddsison</w>I‚Äôm running a websocket server via aleph and when the client sends a message that exceeds the max-frame-payload there is a warning and the websocket connection is closed. What would be the best way to send that message back to the client before closing? It‚Äôs making it hard to provide a decent message since the actual exception is captured and logged as a warning.</z><z id="t1520369794" t="daviddsison Essentially io.netty.handler.codec.CorruptedFrameException: Max frame length of 65536 has been exceeded. is being swallowed without being able to tell the user that‚Äôs the reason the connection is being closed."><y>#</y><d>2018-03-06</d><h>20:56</h><w>daviddsison</w>Essentially <code>io.netty.handler.codec.CorruptedFrameException: Max frame length of 65536 has been exceeded.</code> is being swallowed without being able to tell the user that‚Äôs the reason the connection is being closed.</z><z id="t1520420262" t="logistark I mean, that the deferred is completed when all the deferreds inside the list are completed"><y>#</y><d>2018-03-07</d><h>10:57</h><w>logistark</w>I mean, that the deferred is completed when all the deferreds inside the list are completed</z><z id="t1520441420" t="gsnewmark (apply manifold.deferred/zip (map (fn [arg] function-that-create-deferred arg) list)) http://aleph.io/codox/manifold/manifold.deferred.html#var-zip d/zip&apos; is probably an even better option if you‚Äôre sure function-that-create-deferred always returns deferreds and not clojure.core futures or similar"><y>#</y><d>2018-03-07</d><h>16:50</h><w>gsnewmark</w><code>(apply manifold.deferred/zip (map (fn [arg] function-that-create-deferred arg) list))</code> <a href="http://aleph.io/codox/manifold/manifold.deferred.html#var-zip" target="_blank">http://aleph.io/codox/manifold/manifold.deferred.html#var-zip</a>
<code>d/zip&apos;</code> is probably an even better option if you‚Äôre sure <code>function-that-create-deferred</code> always returns deferreds and not clojure.core futures or similar</z><z id="t1520441636" t="gsnewmark [:attrs {:href &quot;/_/_/users/U98NWG10T&quot;}]"><y>#</y><d>2018-03-07</d><h>16:53</h><r>gsnewmark</r><a>@U98NWG10T</a></z><z id="t1520441721" t="logistark Thank you!"><y>#</y><d>2018-03-07</d><h>16:55</h><r>logistark</r>Thank you!</z><z id="t1520591101" t="borkdude I‚Äôm trying a multipart request. With clj-http it works fine, but with aleph I get back a 400 with a long stacktrace I don‚Äôt understand‚Ä¶ any clues?"><y>#</y><d>2018-03-09</d><h>10:25</h><w>borkdude</w>I‚Äôm trying a multipart request. With clj-http it works fine, but with aleph I get back a 400 with a long stacktrace I don‚Äôt understand‚Ä¶ any clues?</z><z id="t1520597472" t="jetmind [:attrs {:href &quot;/_/_/users/U04V15CAJ&quot;}] which version of aleph do you use? I believe multipart requests were entirely broken in aleph until 0.4.5-alpha4"><y>#</y><d>2018-03-09</d><h>12:11</h><w>jetmind</w><a>@borkdude</a> which version of aleph do you use? I believe multipart requests were entirely broken in aleph until 0.4.5-alpha4</z><z id="t1520597540" t="borkdude [aleph ‚Äú0.4.4‚Äù]"><y>#</y><d>2018-03-09</d><h>12:12</h><w>borkdude</w>[aleph ‚Äú0.4.4‚Äù]</z><z id="t1520599644" t="borkdude I‚Äôll try the newest‚Ä¶"><y>#</y><d>2018-03-09</d><h>12:47</h><w>borkdude</w>I‚Äôll try the newest‚Ä¶</z><z id="t1520600453" t="borkdude seems to work!"><y>#</y><d>2018-03-09</d><h>13:00</h><w>borkdude</w>seems to work!</z><z id="t1520601687" t="logistark Question, regarding manifold/stream, how to apply a side effect for every msg inside an stream?"><y>#</y><d>2018-03-09</d><h>13:21</h><w>logistark</w>Question, regarding manifold/stream, how to apply a side effect for every msg inside an  stream?</z><z id="t1520601806" t="logistark I was trying to do something like: (s/map (fn [value] (do (println value) value)) stream)"><y>#</y><d>2018-03-09</d><h>13:23</h><w>logistark</w>I was trying to do something like: <pre>(s/map (fn [value] (do (println value) value)) stream)</pre></z><z id="t1520602264" t="mccraigmccraig that should work [:attrs {:href &quot;/_/_/users/U98NWG10T&quot;}]"><y>#</y><d>2018-03-09</d><h>13:31</h><w>mccraigmccraig</w>that should work <a>@jimenezsaezjoseantoni</a></z><z id="t1520602341" t="mccraigmccraig though you might need to consume your stream with (s/consume &lt;stream&gt;) or (s/reduce (fn [c _] (inc c)) 0 &lt;stream&gt;) or something"><y>#</y><d>2018-03-09</d><h>13:32</h><w>mccraigmccraig</w>though you might need to consume your stream with <code>(s/consume &lt;stream&gt;)</code> or <code>(s/reduce (fn [c _] (inc c)) 0 &lt;stream&gt;)</code> or something</z><z id="t1520602482" t="logistark Yep, i was testing taking manually with (s/take! stream)"><y>#</y><d>2018-03-09</d><h>13:34</h><w>logistark</w>Yep, i was testing taking manually with (s/take! stream)</z><z id="t1520774319" t="lxsameer how can I add the support for a new stream type to manifold.streams ? is there any protocol or something ?"><y>#</y><d>2018-03-11</d><h>13:18</h><w>lxsameer</w>how can I add the support for a new stream type to <code>manifold.streams</code> ? is there any protocol or something ?</z><z id="t1520859728" t="logistark [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] there are protocols for that, called Sourceable and Sinkable. And also various macros to help with that"><y>#</y><d>2018-03-12</d><h>13:02</h><w>logistark</w><a>@lxsameer</a> there are protocols for that, called Sourceable and Sinkable. And also various macros to help with that</z><z id="t1520859762" t="logistark Still, a guide of how to implement it would be helpful"><y>#</y><d>2018-03-12</d><h>13:02</h><w>logistark</w>Still, a guide of how to implement it would be helpful</z><z id="t1520859856" t="lxsameer cool, I&apos;ll write it if I end up doing it"><y>#</y><d>2018-03-12</d><h>13:04</h><w>lxsameer</w>cool, I&apos;ll write it if I end up doing it</z><z id="t1520869671" t="logistark Anyway, i have a concern about stream, and is the exception handling"><y>#</y><d>2018-03-12</d><h>15:47</h><w>logistark</w>Anyway, i have a concern about stream, and is the exception handling</z><z id="t1520869686" t="logistark With deferred, you can add (d/catch)"><y>#</y><d>2018-03-12</d><h>15:48</h><w>logistark</w>With deferred, you can add (d/catch)</z><z id="t1520870871" t="mccraigmccraig there isn&apos;t any exception handling on streams [:attrs {:href &quot;/_/_/users/U98NWG10T&quot;}] - see https://github.com/ztellman/manifold/issues/95"><y>#</y><d>2018-03-12</d><h>16:07</h><w>mccraigmccraig</w>there isn&apos;t any exception handling on streams <a>@jimenezsaezjoseantoni</a> - see <a href="https://github.com/ztellman/manifold/issues/95" target="_blank">https://github.com/ztellman/manifold/issues/95</a></z><z id="t1520870962" t="mccraigmccraig in places where i really need it i implement it ad-hoc by e.g. catching exceptions in mapped fns and turning them in to values on the stream i can pattern match on"><y>#</y><d>2018-03-12</d><h>16:09</h><w>mccraigmccraig</w>in places where i really need it i implement it ad-hoc by e.g. catching exceptions in mapped fns and turning them in to values on the stream i can pattern match on</z><z id="t1520871252" t="logistark yep, i was thinking in that"><y>#</y><d>2018-03-12</d><h>16:14</h><w>logistark</w>yep, i was thinking in that</z><z id="t1520871270" t="logistark in transforming the message down the stream"><y>#</y><d>2018-03-12</d><h>16:14</h><w>logistark</w>in transforming the message down the stream</z><z id="t1520871282" t="logistark into {:message :error {} }"><y>#</y><d>2018-03-12</d><h>16:14</h><w>logistark</w>into {:message :error {} }</z><z id="t1521043609" t="logistark Hi, again, anyone know which function should i use to stop a (s/consume) to stop consuming an stream?"><y>#</y><d>2018-03-14</d><h>16:06</h><w>logistark</w>Hi, again, anyone know which function should i use to stop a (s/consume) to stop consuming an stream?</z><z id="t1521044743" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U98NWG10T&quot;}] you can close the stream"><y>#</y><d>2018-03-14</d><h>16:25</h><w>mccraigmccraig</w><a>@jimenezsaezjoseantoni</a> you can close the stream</z><z id="t1523365426" t="chrisblom does anyone know some good resources about designing and managing asynchronous system, especially about backpressure and monitoring?"><y>#</y><d>2018-04-10</d><h>13:03</h><w>chrisblom</w>does anyone know some good resources about designing and managing asynchronous system, especially about backpressure and monitoring?</z><z id="t1523367723" t="mccraigmccraig i would have liked some resources like that a couple of years ago [:attrs {:href &quot;/_/_/users/U0P1MGUSX&quot;}] ... actually, i could probably still use them for training up new-hires"><y>#</y><d>2018-04-10</d><h>13:42</h><w>mccraigmccraig</w>i would have liked some resources like that a couple of years ago <a>@chrisblom</a>... actually, i could probably still use them for training up new-hires</z><z id="t1523378070" t="mpenet Not clj per say but it s a good post about backpressure &amp; co https://ferd.ca/handling-overload.html"><y>#</y><d>2018-04-10</d><h>16:34</h><w>mpenet</w>Not clj per say but it s a good post about backpressure &amp; co <a href="https://ferd.ca/handling-overload.html" target="_blank">https://ferd.ca/handling-overload.html</a></z><z id="t1523380230" t="manderson [:attrs {:href &quot;/_/_/users/U0P1MGUSX&quot;}] This is a helpful talk by the author of Aleph, if you haven&apos;t seen it yet: https://www.youtube.com/watch?v=1bNOO3xxMc0"><y>#</y><d>2018-04-10</d><h>17:10</h><w>manderson</w><a>@chrisblom</a> This is a helpful talk by the author of Aleph, if you haven&apos;t seen it yet: <a href="https://www.youtube.com/watch?v=1bNOO3xxMc0" target="_blank">https://www.youtube.com/watch?v=1bNOO3xxMc0</a></z><z id="t1523613969" t="lxsameer hey folks, If i move a stream onto an executor, does it mean than anything consuming from that stream will run on that executor ?"><y>#</y><d>2018-04-13</d><h>10:06</h><w>lxsameer</w>hey folks, If i move a stream <code>onto</code> an executor, does it mean than anything consuming from that stream will run on that executor ?</z><z id="t1525068267" t="beders hello there! Is there an aleph starter template out there somewhere you guys are using. I&apos;m starting from scratch and decided to give aleph a try."><y>#</y><d>2018-04-30</d><h>06:04</h><w>beders</w>hello there!
Is there an aleph starter template out there somewhere you guys are using. I&apos;m starting from scratch and decided to give aleph a try.</z><z id="t1525106181" t="mike706574 what are you looking for a template to provide?"><y>#</y><d>2018-04-30</d><h>16:36</h><w>mike706574</w>what are you looking for a template to provide?</z><z id="t1525106245" t="mike706574 http://aleph.io/aleph/literate.html"><y>#</y><d>2018-04-30</d><h>16:37</h><w>mike706574</w><a href="http://aleph.io/aleph/literate.html" target="_blank">http://aleph.io/aleph/literate.html</a></z><z id="t1525106344" t="mike706574 i found those examples to be enough when i first started using it"><y>#</y><d>2018-04-30</d><h>16:39</h><w>mike706574</w>i found those examples to be enough when i first started using it</z><z id="t1525106488" t="mike706574 but it probably depends what other libraries you want to integrate with and which parts of aleph you&apos;re looking to use"><y>#</y><d>2018-04-30</d><h>16:41</h><w>mike706574</w>but it probably depends what other libraries you want to integrate with and which parts of aleph you&apos;re looking to use</z><z id="t1525106653" t="beders ideally I&apos;d like one with aleph providing the server side and reagent providing the client side all neatly packaged in one repository. I guess I&apos;m too lazy to read the leiningen docs üôÇ"><y>#</y><d>2018-04-30</d><h>16:44</h><w>beders</w>ideally I&apos;d like one with aleph providing the server side and reagent providing the client side all neatly packaged in one repository. I guess I&apos;m too lazy to read the leiningen docs <b>üôÇ</b></z><z id="t1525107047" t="mike706574 aleph is very much like ring, so i don&apos;t think it would too hard to take a ring-based template, rip out the ring part, and put in aleph"><y>#</y><d>2018-04-30</d><h>16:50</h><w>mike706574</w>aleph is very much like ring, so i don&apos;t think it would too hard to take a ring-based template, rip out the ring part, and put in aleph</z><z id="t1525107066" t="mike706574 like this https://github.com/reagent-project/reagent-template or https://github.com/Day8/re-frame-template"><y>#</y><d>2018-04-30</d><h>16:51</h><w>mike706574</w>like this <a href="https://github.com/reagent-project/reagent-template" target="_blank">https://github.com/reagent-project/reagent-template</a> or <a href="https://github.com/Day8/re-frame-template" target="_blank">https://github.com/Day8/re-frame-template</a></z><z id="t1525107259" t="mike706574 if you used that reagent one, i think you could just take the resulting src/clj/reagent/server.clj and change the ring-adapter-jetty/run-jetty call to aleph.http/start-server"><y>#</y><d>2018-04-30</d><h>16:54</h><w>mike706574</w>if you used that reagent one, i think you could just take the resulting <code>src/clj/reagent/server.clj</code> and change the <code>ring-adapter-jetty/run-jetty</code> call to <code>aleph.http/start-server</code></z><z id="t1525107458" t="mike706574 then just change the handler functions for the compojure routes to return manifold deferred &apos;s or aleph&apos;s websocket-connection , like in the examples"><y>#</y><d>2018-04-30</d><h>16:57</h><w>mike706574</w>then just change the handler functions for the compojure routes to return manifold <code>deferred</code>&apos;s or aleph&apos;s <code>websocket-connection</code>, like in the examples</z><z id="t1525107600" t="mike706574 but i&apos;m not aware of an aleph/reagent lein template"><y>#</y><d>2018-04-30</d><h>17:00</h><w>mike706574</w>but i&apos;m not aware of an aleph/reagent lein template</z><z id="t1525107619" t="mike706574 and i&apos;m no expert"><y>#</y><d>2018-04-30</d><h>17:00</h><w>mike706574</w>and i&apos;m no expert</z><z id="t1525147914" t="beders thank you!"><y>#</y><d>2018-05-01</d><h>04:11</h><w>beders</w>thank you!</z><z id="t1527225828" t="tianshu Hi, according to the example, I can use (s/take! (s/-&gt;source a-core-async-channel)) in request-handler. will s/take! block the current thread until async channel have a item?"><y>#</y><d>2018-05-25</d><h>05:23</h><w>tianshu</w>Hi, according to the example, I can use <code>(s/take! (s/-&gt;source a-core-async-channel))</code> in request-handler. will <code>s/take!</code> block the current thread until async channel have a item?</z><z id="t1527231433" t="jetmind s/take! returns deferred, so it will block only if you deref the value s/take! returns"><y>#</y><d>2018-05-25</d><h>06:57</h><w>jetmind</w><code>s/take!</code> returns deferred, so it will block only if you deref the value <code>s/take!</code> returns</z><z id="t1527233627" t="tianshu will deref happen in the same thread which handle the request? if it is, it&apos;s likely if request handler took 10s, there will be two thread each took 10s ?"><y>#</y><d>2018-05-25</d><h>07:33</h><w>tianshu</w>will <code>deref</code> happen in the same thread which handle the request? if it is, it&apos;s likely if request handler took 10s, there will be two thread each took 10s ?</z><z id="t1527235547" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U0NBGRGD6&quot;}] deref blocks the thread doing the deref - Deferred is all callbacks underneath the hood, so provided your request handling is itself non-blocking there will be no other blocking"><y>#</y><d>2018-05-25</d><h>08:05</h><w>mccraigmccraig</w><a>@doglooksgood</a> <code>deref</code> blocks the thread doing the <code>deref</code> - <code>Deferred</code> is all callbacks underneath the hood, so provided your request handling is itself non-blocking there will be no other blocking</z><z id="t1527235618" t="mccraigmccraig we don&apos;t ever use deref apart from in tests and the repl - there&apos;s no need for blocking"><y>#</y><d>2018-05-25</d><h>08:06</h><w>mccraigmccraig</w>we don&apos;t ever use <code>deref</code> apart from in tests and the repl - there&apos;s no need for blocking</z><z id="t1527235684" t="tianshu is that if my handler took 10s to response, the thread call deref will block 10s?"><y>#</y><d>2018-05-25</d><h>08:08</h><w>tianshu</w>is that if my handler took 10s to response, the thread call <code>deref</code> will block 10s?</z><z id="t1527235703" t="mccraigmccraig correct"><y>#</y><d>2018-05-25</d><h>08:08</h><w>mccraigmccraig</w>correct</z><z id="t1527235945" t="tianshu there&apos;s a single thread do nothing except blocking for this defref ? this is strange, for this case, in the old sync way, we only need one thread, cost 10s to handle the request. in the async way, we need two threads, and cost them each 10s?"><y>#</y><d>2018-05-25</d><h>08:12</h><w>tianshu</w>there&apos;s a single thread do nothing except blocking for this <code>defref</code>? this is strange, for this case, in the old sync way, we only need one thread, cost 10s to handle the request. in the async way, we need two threads, and cost them each 10s?</z><z id="t1527235970" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U0NBGRGD6&quot;}] deref is not the async way!"><y>#</y><d>2018-05-25</d><h>08:12</h><w>mccraigmccraig</w><a>@doglooksgood</a> <code>deref</code> is not the async way!</z><z id="t1527235989" t="mccraigmccraig have a read of https://github.com/ztellman/manifold/blob/master/docs/deferred.md"><y>#</y><d>2018-05-25</d><h>08:13</h><w>mccraigmccraig</w>have a read of <a href="https://github.com/ztellman/manifold/blob/master/docs/deferred.md" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/deferred.md</a></z><z id="t1527236033" t="mccraigmccraig you compose chains of operations on Deferred s with deferred/chain , and they don&apos;t block anything"><y>#</y><d>2018-05-25</d><h>08:13</h><w>mccraigmccraig</w>you compose chains of operations on <code>Deferred</code>s with <code>deferred/chain</code>, and they don&apos;t block anything</z><z id="t1527236152" t="mccraigmccraig summary: if you deref a promise then you are doing async wrong. the only time to use deref is in a test or to inspect a value at the repl"><y>#</y><d>2018-05-25</d><h>08:15</h><w>mccraigmccraig</w>summary: if you <code>deref</code> a promise then you are doing async wrong. the only time to use <code>deref</code> is in a test or to inspect a value at the repl</z><z id="t1527236161" t="mccraigmccraig use chain instead"><y>#</y><d>2018-05-25</d><h>08:16</h><w>mccraigmccraig</w>use <code>chain</code> instead</z><z id="t1527236254" t="mccraigmccraig or alternatively, use the cats manifold monad https://github.com/funcool/cats/blob/master/src/cats/labs/manifold.clj with the mlet macro sugar http://funcool.github.io/cats/latest/#mlet"><y>#</y><d>2018-05-25</d><h>08:17</h><w>mccraigmccraig</w>or alternatively, use the cats manifold monad <a href="https://github.com/funcool/cats/blob/master/src/cats/labs/manifold.clj" target="_blank">https://github.com/funcool/cats/blob/master/src/cats/labs/manifold.clj</a> with the <code>mlet</code> macro sugar <a href="http://funcool.github.io/cats/latest/#mlet" target="_blank">http://funcool.github.io/cats/latest/#mlet</a></z><z id="t1527236283" t="mccraigmccraig http://funcool.github.io/cats/latest/#manifold-deferred"><y>#</y><d>2018-05-25</d><h>08:18</h><w>mccraigmccraig</w><a href="http://funcool.github.io/cats/latest/#manifold-deferred" target="_blank">http://funcool.github.io/cats/latest/#manifold-deferred</a></z><z id="t1527236435" t="tianshu I&apos;m just reading the example of aleph and found this: https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/http.clj#L58"><y>#</y><d>2018-05-25</d><h>08:20</h><w>tianshu</w>I&apos;m just reading the example of aleph and found this: <a href="https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/http.clj#L58" target="_blank">https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/http.clj#L58</a></z><z id="t1527236473" t="tianshu I want to understand what what aleph will do when request handler return a d/deferred ?"><y>#</y><d>2018-05-25</d><h>08:21</h><w>tianshu</w>I want to understand what what aleph will do when request handler return a <code>d/deferred</code>?</z><z id="t1527236581" t="tianshu with your words, I think I understand a little"><y>#</y><d>2018-05-25</d><h>08:23</h><w>tianshu</w>with your words, I think I understand a little</z><z id="t1527236909" t="mccraigmccraig the Deferred is really just a placeholder for callbacks which will be called with the value gotten from the go block... you take the Deferred returned from your (delayed-hello-world-handler req) call, and d/chain some functions to it, which do something with the returned value"><y>#</y><d>2018-05-25</d><h>08:28</h><w>mccraigmccraig</w>the <code>Deferred</code> is really just a placeholder for callbacks which will be called with the value gotten from the <code>go</code> block... you take the <code>Deferred</code> returned from your <code>(delayed-hello-world-handler req)</code> call, and <code>d/chain</code> some functions to it, which do something with the returned value</z><z id="t1527237046" t="mccraigmccraig if you&apos;ve worked with js promises, a Deferred is very similar to a js promise (at least the client api is very similar) - a convenient way of arranging chains of callbacks"><y>#</y><d>2018-05-25</d><h>08:30</h><w>mccraigmccraig</w>if you&apos;ve worked with js promises, a <code>Deferred</code> is very similar to a js promise (at least the client api is very similar) - a convenient way of arranging chains of callbacks</z><z id="t1527237159" t="tianshu is it good or not to use core.async in a web server?"><y>#</y><d>2018-05-25</d><h>08:32</h><w>tianshu</w>is it good or not to use core.async in a web server?</z><z id="t1527237322" t="mccraigmccraig if your webserver is implemented with core.async then maybe go with it... if your webserver is (like aleph) implemented with manifold then go with that"><y>#</y><d>2018-05-25</d><h>08:35</h><w>mccraigmccraig</w>if your webserver is implemented with core.async then maybe go with it... if your webserver is (like aleph) implemented with manifold then go with that</z><z id="t1527237433" t="mccraigmccraig i tend to prefer manifold/aleph because i find the promise abstraction more natural for most of what a web/app server does"><y>#</y><d>2018-05-25</d><h>08:37</h><w>mccraigmccraig</w>i tend to prefer manifold/aleph because i find the promise abstraction more natural for most of what a web/app server does</z><z id="t1527237496" t="mccraigmccraig but if you ask in #core-async you&apos;ll probably get a different answer!"><y>#</y><d>2018-05-25</d><h>08:38</h><w>mccraigmccraig</w>but if you ask in #core-async you&apos;ll probably get a different answer!</z><z id="t1527451051" t="lxsameer hey folks, how manifold handles the execution model of core async ? I mean how does manifold.stream works with go blocks and their service executor ?"><y>#</y><d>2018-05-27</d><h>19:57</h><w>lxsameer</w>hey folks, how manifold handles the execution model of core async ? I mean how does manifold.stream works with go blocks  and their service executor ?</z><z id="t1527579561" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] manifold doesn‚Äôt touch go blocks - it just adapts channels to streams - https://github.com/ztellman/manifold/blob/master/src/manifold/stream/async.clj"><y>#</y><d>2018-05-29</d><h>07:39</h><w>mccraigmccraig</w><a>@lxsameer</a> manifold doesn‚Äôt touch go blocks - it just adapts channels to streams - <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/stream/async.clj" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/stream/async.clj</a></z><z id="t1527619600" t="lxsameer [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] so the basically if I connect a channel to a stream or the other way around, my application will be executed on core async thread pools. right ?"><y>#</y><d>2018-05-29</d><h>18:46</h><w>lxsameer</w><a>@mccraigmccraig</a> so the basically if I connect a channel to a stream or the other way around, my application will be executed on core async thread pools. right ?</z><z id="t1527622279" t="mccraigmccraig if you connect a channel to a stream that seems to be so... i imagine not if you connect a stream to a channel tho"><y>#</y><d>2018-05-29</d><h>19:31</h><w>mccraigmccraig</w>if you connect a channel to a stream that seems to be so... i imagine not if you connect a stream to a channel tho</z><z id="t1527622743" t="lxsameer why ?"><y>#</y><d>2018-05-29</d><h>19:39</h><w>lxsameer</w>why ?</z><z id="t1527698497" t="mccraigmccraig just that the parts of the app prior to the channel will execute on a manifold pool"><y>#</y><d>2018-05-30</d><h>16:41</h><w>mccraigmccraig</w>just that the parts of the app prior to the channel will execute on a manifold pool</z><z id="t1527850294" t="rborer Hey folks, I&apos;m trying to understand how to add a custom client middleware for a request (as documented under https://github.com/ztellman/aleph/blob/98e878946a97fd020a63cc43ee6e740c712ad188/src/aleph/http.clj#L234 ) and I don&apos;t see how I&apos;m supposed to use it? Obviously, :middleware should be a single-arity function, but what does it receive?"><y>#</y><d>2018-06-01</d><h>10:51</h><w>rborer</w>Hey folks, I&apos;m trying to understand how to add a custom client middleware for a request (as documented under <a href="https://github.com/ztellman/aleph/blob/98e878946a97fd020a63cc43ee6e740c712ad188/src/aleph/http.clj#L234" target="_blank">https://github.com/ztellman/aleph/blob/98e878946a97fd020a63cc43ee6e740c712ad188/src/aleph/http.clj#L234</a>) and I don&apos;t see how I&apos;m supposed to use it? Obviously, :middleware should be a single-arity function, but what does it receive?</z><z id="t1527850718" t="rborer Nevermind, I figured it out by looking at unit tests üôÇ"><y>#</y><d>2018-06-01</d><h>10:58</h><r>rborer</r>Nevermind, I figured it out by looking at unit tests <b>üôÇ</b></z><z id="t1527850718" t="rborer Nevermind, I figured it out by looking at unit tests üôÇ"><y>#</y><d>2018-06-01</d><h>10:58</h><w>rborer</w>Nevermind, I figured it out by looking at unit tests <b>üôÇ</b></z><z id="t1528116525" t="lxsameer How should I suppose to put a value on a manifold stream without blocking ?"><y>#</y><d>2018-06-04</d><h>12:48</h><w>lxsameer</w>How should I suppose to put a value on a manifold stream without blocking ?</z><z id="t1528118054" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] stream/put! doesn&apos;t block - it returns a Deferred"><y>#</y><d>2018-06-04</d><h>13:14</h><w>mccraigmccraig</w><a>@lxsameer</a> <code>stream/put!</code> doesn&apos;t block - it returns a <code>Deferred</code></z><z id="t1528118208" t="lxsameer So let me rephrase my question, How can I put a value in an stream in a parallel fashion. Right now even if I consume from the stream and block in the consumer function it still runs my code in a thread"><y>#</y><d>2018-06-04</d><h>13:16</h><w>lxsameer</w>So let me rephrase my question, How can I put a value in an stream in a parallel fashion. Right now even if I consume from the stream and block in the consumer function it still runs my code in a thread</z><z id="t1528118221" t="lxsameer so it blocks"><y>#</y><d>2018-06-04</d><h>13:17</h><w>lxsameer</w>so it blocks</z><z id="t1528118231" t="lxsameer that thread"><y>#</y><d>2018-06-04</d><h>13:17</h><w>lxsameer</w>that thread</z><z id="t1528118329" t="mccraigmccraig don&apos;t block in the consumer function - use deferred/zip to collate responses once you have put all values on to the stream"><y>#</y><d>2018-06-04</d><h>13:18</h><w>mccraigmccraig</w>don&apos;t block in the consumer function - use <code>deferred/zip</code> to collate responses once you have put all values on to the stream</z><z id="t1528118357" t="mccraigmccraig oops, i think i may have misunderstood what you wrote"><y>#</y><d>2018-06-04</d><h>13:19</h><w>mccraigmccraig</w>oops, i think i may have misunderstood what you wrote</z><z id="t1528118377" t="mccraigmccraig what&apos;s blocking ?"><y>#</y><d>2018-06-04</d><h>13:19</h><w>mccraigmccraig</w>what&apos;s blocking ?</z><z id="t1528121207" t="lxsameer [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] let me show some code"><y>#</y><d>2018-06-04</d><h>14:06</h><w>lxsameer</w><a>@mccraigmccraig</a> let me show some code</z><z id="t1528121339" t="lxsameer [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] check this out http://dpaste.com/19CC303"><y>#</y><d>2018-06-04</d><h>14:08</h><w>lxsameer</w><a>@mccraigmccraig</a> check this out <a href="http://dpaste.com/19CC303" target="_blank">http://dpaste.com/19CC303</a></z><z id="t1528121374" t="lxsameer the output of this code would be number 1-199 in order and all of them executed on the same thread."><y>#</y><d>2018-06-04</d><h>14:09</h><w>lxsameer</w>the output of this code would be number 1-199 in order and all of them executed on the same thread.</z><z id="t1528121394" t="lxsameer In my understanding, the consume-async function should get a value from stream and apply the given fn to that value asynchronously"><y>#</y><d>2018-06-04</d><h>14:09</h><w>lxsameer</w>In my understanding, the consume-async function should get a value from stream and apply the given fn to that value asynchronously</z><z id="t1528121488" t="lxsameer so if something is blocking the current thread (call to sleep) it should run fn in another thread in the threadpool"><y>#</y><d>2018-06-04</d><h>14:11</h><w>lxsameer</w>so if something is blocking the current thread (call to sleep) it should run  fn in another thread in the threadpool</z><z id="t1528121552" t="lxsameer and if that&apos;s the case i should be able to see that some of those function runs in a different thread and the i should be able to see number printing on the out out of order ( with random sleep ofcourse )"><y>#</y><d>2018-06-04</d><h>14:12</h><w>lxsameer</w>and if that&apos;s the case i should be able to see that some of those function runs in a different thread and the i should be able to see number printing on the out out of order  ( with random sleep ofcourse )</z><z id="t1528121562" t="lxsameer but it&apos;s not happening"><y>#</y><d>2018-06-04</d><h>14:12</h><w>lxsameer</w>but it&apos;s not happening</z><z id="t1528121579" t="lxsameer if you want I can provide the output as well"><y>#</y><d>2018-06-04</d><h>14:12</h><w>lxsameer</w>if you want I can provide the output as well</z><z id="t1528121798" t="mccraigmccraig hmm. i dunno - i would have expected that as well... things to look at - what happens if you use put-all! with a range instead of put! ... what happens if you don&apos;t used a fixed-thread-executor ?"><y>#</y><d>2018-06-04</d><h>14:16</h><w>mccraigmccraig</w>hmm. i dunno - i would have expected that as well... things to look at - what happens if you use <code>put-all!</code> with a range instead of <code>put!</code>... what happens if you don&apos;t used a <code>fixed-thread-executor</code> ?</z><z id="t1528121852" t="lxsameer I have to test the put-all! but without the executor the result would be the same"><y>#</y><d>2018-06-04</d><h>14:17</h><w>lxsameer</w>I have to test the <code>put-all!</code> but without the executor the result would be the same</z><z id="t1528121998" t="mccraigmccraig can you paste the output as well..."><y>#</y><d>2018-06-04</d><h>14:19</h><w>mccraigmccraig</w>can you paste the output as well...</z><z id="t1528121999" t="lxsameer [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] result is the same with put-all! as well"><y>#</y><d>2018-06-04</d><h>14:19</h><w>lxsameer</w><a>@mccraigmccraig</a> result is the same with <code>put-all!</code> as well</z><z id="t1528122036" t="lxsameer http://dpaste.com/0A3NC0X"><y>#</y><d>2018-06-04</d><h>14:20</h><w>lxsameer</w><a href="http://dpaste.com/0A3NC0X" target="_blank">http://dpaste.com/0A3NC0X</a></z><z id="t1528122042" t="lxsameer reduced the number to 100"><y>#</y><d>2018-06-04</d><h>14:20</h><w>lxsameer</w>reduced the number to 100</z><z id="t1528123233" t="mccraigmccraig looking at the docs for consume-async https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L483 this result seems in line with expectations... i don&apos;t think i&apos;ve ever used consume-async"><y>#</y><d>2018-06-04</d><h>14:40</h><w>mccraigmccraig</w>looking at the docs for <code>consume-async</code> <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L483" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L483</a> this result seems in line with expectations... i don&apos;t think i&apos;ve ever used <code>consume-async</code></z><z id="t1528123399" t="lxsameer hmmmm , very weird. It would be a good candidate for zack to include it in the naming chapter of elements of clojure"><y>#</y><d>2018-06-04</d><h>14:43</h><w>lxsameer</w>hmmmm , very weird. It would be a good candidate for zack to include it in the naming chapter of elements of clojure</z><z id="t1528724433" t="rborer I&apos;m trying to use HttpObjectAggregator with latest aleph (0.4.6) but as soon as I add it to the pipeline (through :pipeline-transform handler), it gets stuck and I receive a &quot;connection was closed after 5.140 seconds&quot; ( https://github.com/ztellman/aleph/blob/f6b88aa0ccc280c36cb857e17b270bb67aaeb527/src/aleph/http/client.clj#L495 ). Here is how I add it to the pipeline: (.addAfter pipeline &quot;http-client&quot; &quot;aggregator&quot; (HttpObjectAggregator. (* 5 1024 1024)) "><y>#</y><d>2018-06-11</d><h>13:40</h><w>rborer</w>I&apos;m trying to use <code>HttpObjectAggregator</code> with latest aleph (0.4.6) but as soon as I add it to the pipeline (through <code>:pipeline-transform</code> handler), it gets stuck and I receive a &quot;connection was closed after 5.140 seconds&quot; (<a href="https://github.com/ztellman/aleph/blob/f6b88aa0ccc280c36cb857e17b270bb67aaeb527/src/aleph/http/client.clj#L495" target="_blank">https://github.com/ztellman/aleph/blob/f6b88aa0ccc280c36cb857e17b270bb67aaeb527/src/aleph/http/client.clj#L495</a>). Here is how I add it to the pipeline:
<pre>(.addAfter pipeline &quot;http-client&quot; &quot;aggregator&quot; (HttpObjectAggregator. (* 5 1024 1024))
</pre></z><z id="t1530116466" t="oyakushev Sorry if this was asked times before. What is the correct way to emulate core.async&apos;s alt! on Manifold streams? I&apos;m looking for &quot;takes exactly from one stream&quot; behavior."><y>#</y><d>2018-06-27</d><h>16:21</h><w>oyakushev</w>Sorry if this was asked times before. What is the correct way to emulate core.async&apos;s <code>alt!</code> on Manifold streams? I&apos;m looking for &quot;takes exactly from one stream&quot; behavior.</z><z id="t1530116728" t="hiredman https://github.com/ztellman/manifold/blob/master/src/manifold/deferred.clj#L1125"><y>#</y><d>2018-06-27</d><h>16:25</h><w>hiredman</w><a href="https://github.com/ztellman/manifold/blob/master/src/manifold/deferred.clj#L1125" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/deferred.clj#L1125</a></z><z id="t1530116833" t="oyakushev That works only on deferreds, unfortunately"><y>#</y><d>2018-06-27</d><h>16:27</h><w>oyakushev</w>That works only on deferreds, unfortunately</z><z id="t1530116942" t="oyakushev Not on streams"><y>#</y><d>2018-06-27</d><h>16:29</h><w>oyakushev</w>Not on streams</z><z id="t1530117865" t="hiredman right, and it doesn&apos;t appear to have any way to cancel deferreds that are the result of a take on a stream"><y>#</y><d>2018-06-27</d><h>16:44</h><w>hiredman</w>right, and it doesn&apos;t appear to have any way to cancel deferreds that are the result of a take on a stream</z><z id="t1530118125" t="oyakushev Exactly"><y>#</y><d>2018-06-27</d><h>16:48</h><w>oyakushev</w>Exactly</z><z id="t1530118155" t="oyakushev AFAIK, the implementation of alt! is half of core.async&apos;s complexity"><y>#</y><d>2018-06-27</d><h>16:49</h><w>oyakushev</w>AFAIK, the implementation of <code>alt!</code> is half of core.async&apos;s complexity</z><z id="t1530118168" t="oyakushev But I wonder what can be used instead"><y>#</y><d>2018-06-27</d><h>16:49</h><w>oyakushev</w>But I wonder what can be used instead</z><z id="t1530118359" t="hiredman it is too bad neither core.async nor manifold is built on the ideas from concurrent ml"><y>#</y><d>2018-06-27</d><h>16:52</h><w>hiredman</w>it is too bad neither core.async nor manifold is built on the ideas from concurrent ml</z><z id="t1530118468" t="hiredman manifold&apos;s notion of deferreds seems to be almost there"><y>#</y><d>2018-06-27</d><h>16:54</h><w>hiredman</w>manifold&apos;s notion of deferreds seems to be almost there</z><z id="t1530204132" t="kachayev [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] What about creating another stream s and connecting 2 of yours to the s ? Does this work? I mean it depends on the task you‚Äôre solving"><y>#</y><d>2018-06-28</d><h>16:42</h><w>kachayev</w><a>@alexyakushev</a> What about creating another stream <code>s</code> and connecting 2 of yours to the <code>s</code>? Does this work? I mean it depends on the task you‚Äôre solving</z><z id="t1530216964" t="oyakushev [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] That works indeed, but it renders the original two streams &quot;unusable&quot; for others. Even though Manifold allows tapping into a stream multiple times, it destroys the backpressure you might rely on. However, that&apos;s the approach I ended up using, basically."><y>#</y><d>2018-06-28</d><h>20:16</h><w>oyakushev</w><a>@kachayev</a> That works indeed, but it renders the original two streams &quot;unusable&quot; for others. Even though Manifold allows tapping into a stream multiple times, it destroys the backpressure you might rely on.
However, that&apos;s the approach I ended up using, basically.</z><z id="t1530298664" t="oyakushev Is it expected that io.aleph.dirigiste.Pool.acquire can block for a long time (experienced ~1 second blocks on a cold connection pool), basically making aleph.http/request not really asynchronous sometimes?"><y>#</y><d>2018-06-29</d><h>18:57</h><w>oyakushev</w>Is it expected that <code>io.aleph.dirigiste.Pool.acquire</code> can block for a long time (experienced ~1 second blocks on a cold connection pool), basically making <code>aleph.http/request</code> not really asynchronous sometimes?</z><z id="t1530299835" t="oyakushev Looking at the code, I see that it&apos;s intended that the caller will create the object if it can&apos;t be obtained from the queue. Then I don&apos;t quite follow what is the purpose of the callback API here if the object acquisition is synchronous anyway."><y>#</y><d>2018-06-29</d><h>19:17</h><w>oyakushev</w>Looking at the code, I see that it&apos;s intended that the caller will create the object if it can&apos;t be obtained from the queue. Then I don&apos;t quite follow what is the purpose of the callback API here if the object acquisition is synchronous anyway.</z><z id="t1530572708" t="oyakushev Also, the README says: &quot;To support non-blocking code, we may also acquire an object via a callback mechanism.&quot;"><y>#</y><d>2018-07-02</d><h>23:05</h><w>oyakushev</w>Also, the README says: &quot;To support non-blocking code, we may also acquire an object via a callback mechanism.&quot;</z><z id="t1530619435" t="mccraigmccraig aleph appears to acquire from a pool here : https://github.com/ztellman/aleph/blob/master/src/aleph/flow.clj#L78 , which is using the callback mechanism to fulfil a Deferred ... presumably the callback mechanism is to allow for the case where a pool has already reached its maximum size and .acquire requests are then queued"><y>#</y><d>2018-07-03</d><h>12:03</h><w>mccraigmccraig</w>aleph appears to acquire from a pool here : <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/flow.clj#L78" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/flow.clj#L78</a> , which is using the callback mechanism to fulfil a <code>Deferred</code> ... presumably the callback mechanism is to allow for the case where a pool has already reached its maximum size and <code>.acquire</code> requests are then queued</z><z id="t1530619460" t="mccraigmccraig without having traced the code all the way, that&apos;s what appears to be happening here : https://github.com/ztellman/dirigiste/blob/master/src/io/aleph/dirigiste/Pool.java#L409"><y>#</y><d>2018-07-03</d><h>12:04</h><w>mccraigmccraig</w>without having traced the code all the way, that&apos;s what appears to be happening here : <a href="https://github.com/ztellman/dirigiste/blob/master/src/io/aleph/dirigiste/Pool.java#L409" target="_blank">https://github.com/ztellman/dirigiste/blob/master/src/io/aleph/dirigiste/Pool.java#L409</a></z><z id="t1530619734" t="mccraigmccraig i need to look at the aleph client some more... i&apos;ve had a bug recently where the aleph client appears to stop working, although everything else carries on working fine... my guess was that aleph was leaking connections causing a terminal pause here: https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L261 , but i&apos;ve not managed to duplicate the bug in a test environment yet"><y>#</y><d>2018-07-03</d><h>12:08</h><w>mccraigmccraig</w>i need to look at the aleph client some more... i&apos;ve had a bug recently where the aleph client appears to stop working, although everything else carries on working fine... my guess was that aleph was leaking connections causing a terminal pause here: <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L261" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L261</a> , but i&apos;ve not managed to duplicate the bug in a test environment yet</z><z id="t1530699541" t="oyakushev Sorry, me again. What would be Manifold&apos;s alternative to core.async/offer! ? I thought @(manifold.stream/try-put! s x 0) is the one, but it doesn&apos;t exert backpressure if the stream buffer is full, as it just fills up the pending puts queue until it blows up. Is there a way to put into the stream&apos;s buffer avoiding the pending queue?"><y>#</y><d>2018-07-04</d><h>10:19</h><w>oyakushev</w>Sorry, me again.
What would be Manifold&apos;s alternative to <code>core.async/offer!</code>? I thought <code>@(manifold.stream/try-put! s x 0)</code> is the one, but it doesn&apos;t exert backpressure if the stream buffer is full, as it just fills up the pending puts queue until it blows up. Is there a way to put into the stream&apos;s buffer avoiding the pending queue?</z><z id="t1531336200" t="kenny What is the use case for a permanent stream?"><y>#</y><d>2018-07-11</d><h>19:10</h><w>kenny</w>What is the use case for a permanent stream?</z><z id="t1531345781" t="mccraigmccraig not sure what you mean by permanent ? streams are not persisted, but something like a stream of events from say a kafka topic can be long-lived"><y>#</y><d>2018-07-11</d><h>21:49</h><w>mccraigmccraig</w>not sure what you mean by permanent ? streams are not persisted, but something like a stream of events from say a kafka topic can be long-lived</z><z id="t1531347825" t="kenny [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] A stream with :permanent? set to true."><y>#</y><d>2018-07-11</d><h>22:23</h><w>kenny</w><a>@mccraigmccraig</a> A stream with <code>:permanent?</code> set to true.</z><z id="t1531380829" t="mccraigmccraig ah, right üò¨ i&apos;ve not used one yet - looks like it is to allow consumers to come/connect and go/disconnect without closing upstream producer streams... it feels slightly at odds with the :upstream? and :downstream? flags on connect"><y>#</y><d>2018-07-12</d><h>07:33</h><w>mccraigmccraig</w>ah, right <b>üò¨</b> i&apos;ve not used one yet - looks like it is to allow consumers to come/connect and go/disconnect without closing upstream producer streams... it feels slightly at odds with the <code>:upstream?</code> and <code>:downstream?</code> flags on <code>connect</code></z><z id="t1531499461" t="baritonehands I&apos;m seeing duplicate messages in aleph, and was trying to figure out why that might be"><y>#</y><d>2018-07-13</d><h>16:31</h><w>baritonehands</w>I&apos;m seeing duplicate messages in aleph, and was trying to figure out why that might be</z><z id="t1531499475" t="baritonehands It only seems to happen under load, I can&apos;t reproduce it consistently"><y>#</y><d>2018-07-13</d><h>16:31</h><w>baritonehands</w>It only seems to happen under load, I can&apos;t reproduce it consistently</z><z id="t1531499586" t="baritonehands Setup: /publish -&gt; consume-async -&gt; event bus /subscribe &lt;- consume-async &lt;- 10K buffered stream &lt;- event bus"><y>#</y><d>2018-07-13</d><h>16:33</h><w>baritonehands</w>Setup:
/publish -&gt; consume-async -&gt; event bus
/subscribe &lt;- consume-async &lt;- 10K buffered stream &lt;- event bus</z><z id="t1531499837" t="baritonehands Also: /subscribe -&gt; consume-async -&gt; singleton Stomp protocol handler"><y>#</y><d>2018-07-13</d><h>16:37</h><w>baritonehands</w>Also:
/subscribe -&gt; consume-async -&gt; singleton Stomp protocol handler</z><z id="t1531499972" t="baritonehands Problem I&apos;m seeing is on that last stream, the client is sending duplicate Stomp ACK messages, but AFAIK my code is not sending duplicate messages"><y>#</y><d>2018-07-13</d><h>16:39</h><w>baritonehands</w>Problem I&apos;m seeing is on that last stream, the client is sending duplicate Stomp ACK messages, but AFAIK my code is not sending duplicate messages</z><z id="t1531562623" t="rborer A very nice presentation around Aleph &amp; its ecosystem (Netty, Manifold, ...): https://speakerdeck.com/kachayev/deep-http-dive-through-aleph-and-netty"><y>#</y><d>2018-07-14</d><h>10:03</h><w>rborer</w>A very nice presentation around Aleph &amp; its ecosystem (Netty, Manifold, ...): <a href="https://speakerdeck.com/kachayev/deep-http-dive-through-aleph-and-netty" target="_blank">https://speakerdeck.com/kachayev/deep-http-dive-through-aleph-and-netty</a></z><z id="t1531575451" t="euccastro I don&apos;t suppose the talk itself has been recorded?"><y>#</y><d>2018-07-14</d><h>13:37</h><r>euccastro</r>I don&apos;t suppose the talk itself has been recorded?</z><z id="t1531736029" t="rborer Sadly I don&apos;t think it was"><y>#</y><d>2018-07-16</d><h>10:13</h><r>rborer</r>Sadly I don&apos;t think it was</z><z id="t1531915892" t="Empperi has anyone else seen java.io.IOException: Pipe broken exceptions occuring with websockets and aleph when using Firefox Quantum?"><y>#</y><d>2018-07-18</d><h>12:11</h><w>Empperi</w>has anyone else seen <code>java.io.IOException: Pipe broken</code> exceptions occuring with websockets and aleph when using Firefox Quantum?</z><z id="t1531915910" t="Empperi doesn&apos;t happen with Chrome, Opera or Edge"><y>#</y><d>2018-07-18</d><h>12:11</h><w>Empperi</w>doesn&apos;t happen with Chrome, Opera or Edge</z><z id="t1531915923" t="Empperi on Firefox side everything seems fine"><y>#</y><d>2018-07-18</d><h>12:12</h><w>Empperi</w>on Firefox side everything seems fine</z><z id="t1531915948" t="Empperi ...as much as I can see due to lacking websocket traffic debugging capability on Firefox Quantum"><y>#</y><d>2018-07-18</d><h>12:12</h><w>Empperi</w>...as much as I can see due to lacking websocket traffic debugging capability on Firefox Quantum</z><z id="t1532004460" t="borkdude What is a sensible amount of parallel requests to be making with aleph?"><y>#</y><d>2018-07-19</d><h>12:47</h><w>borkdude</w>What is a sensible amount of parallel requests to be making with aleph?</z><z id="t1532006170" t="chrisblom 8.5"><y>#</y><d>2018-07-19</d><h>13:16</h><w>chrisblom</w>8.5</z><z id="t1532007442" t="borkdude üôÇ"><y>#</y><d>2018-07-19</d><h>13:37</h><w>borkdude</w><b>üôÇ</b></z><z id="t1532049941" t="callum Is there any way to improve the quality of stacktraces for exceptions returned by a series of d/chain or d/catch s? I seem to lose all context of any functions run as part of the d/chain or d/catch s"><y>#</y><d>2018-07-20</d><h>01:25</h><w>callum</w>Is there any way to improve the quality of stacktraces for exceptions returned by a series of <code>d/chain</code> or <code>d/catch</code>s? I seem to lose all context of any functions run as part of the <code>d/chain</code> or <code>d/catch</code>s</z><z id="t1532049969" t="callum I don&apos;t see the same issue if operating on a realized error-deferred"><y>#</y><d>2018-07-20</d><h>01:26</h><w>callum</w>I don&apos;t see the same issue if operating on a realized <code>error-deferred</code></z><z id="t1532088757" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U06BMSRBL&quot;}] it&apos;s in the nature of composed chains of async operations - each time an op is parked any stack context is effectively erased... i have an idea for using a Deferred&lt;Writer&gt; monad-transformer and a defn-wrapping macro for achieving async call-tracing, but i haven&apos;t done anything with it yet"><y>#</y><d>2018-07-20</d><h>12:12</h><w>mccraigmccraig</w><a>@callum</a> it&apos;s in the nature of composed chains of async operations - each time an op is parked any stack context is effectively erased... i have an idea for using a Deferred&lt;Writer&gt; monad-transformer and a defn-wrapping macro for achieving async call-tracing, but i haven&apos;t done anything with it yet</z><z id="t1532411092" t="callum Thanks [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] . Not sure I understand the issue completely, but it sounds difficult to solve."><y>#</y><d>2018-07-24</d><h>05:44</h><w>callum</w>Thanks <a>@mccraigmccraig</a>. Not sure I understand the issue completely, but it sounds difficult to solve.</z><z id="t1532420734" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U06BMSRBL&quot;}] chains of Deferred s are all callbacks under the hood... the callbacks are executed when the Deferred has success! or error! called on it - but who knows when or which Thread that will happen on. this is also worth a read for some more info - https://github.com/ztellman/manifold/blob/master/docs/execution.md"><y>#</y><d>2018-07-24</d><h>08:25</h><w>mccraigmccraig</w><a>@callum</a> chains of <code>Deferred</code>s are all callbacks under the hood... the callbacks are executed when the <code>Deferred</code> has <code>success!</code> or <code>error!</code> called on it - but who knows when or which <code>Thread</code> that will happen on. this is also worth a read for some more info - <a href="https://github.com/ztellman/manifold/blob/master/docs/execution.md" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/execution.md</a></z><z id="t1532651246" t="callum [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] so this problem would also exist in standard Java asynchronous programming?"><y>#</y><d>2018-07-27</d><h>00:27</h><r>callum</r><a>@mccraigmccraig</a> so this problem would also exist in standard Java asynchronous programming?</z></g><g id="s4"><z id="t1532602251" t="borkdude Can you use persistent connections with Aleph when you‚Äôre scraping a site?"><y>#</y><d>2018-07-26</d><h>10:50</h><w>borkdude</w>Can you use persistent connections with Aleph when you‚Äôre scraping a site?</z><z id="t1534174455" t="fantomofdoom Hi, smb use manifold ( https://github.com/ztellman/manifold ), i can&apos;t find how create something like core.async go-loop only for manifold stream? (and smb known if use manifold.deffered/loop &amp; recur, thread are parked or it alway take message from source)"><y>#</y><d>2018-08-13</d><h>15:34</h><w>fantomofdoom</w>Hi, smb use manifold (<a href="https://github.com/ztellman/manifold" target="_blank">https://github.com/ztellman/manifold</a>), i can&apos;t find how create something like core.async go-loop only for manifold stream?
(and smb known if use manifold.deffered/loop &amp; recur, thread are parked or it alway take message from source)</z><z id="t1534184369" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U4WBSRWG4&quot;}] what exactly do you want to do ? lots of stream ops can be done with stream/map and stream/reduce . occasionally you need some finer control and then deferred/loop and deferred/recur may be useful e.g. https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L232"><y>#</y><d>2018-08-13</d><h>18:19</h><w>mccraigmccraig</w><a>@fantomofdoom</a> what exactly do you want to do ? lots of stream ops can be done with <code>stream/map</code> and <code>stream/reduce</code>. occasionally you need some finer control and then <code>deferred/loop</code> and <code>deferred/recur</code> may be useful e.g. <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L232" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L232</a></z><z id="t1534184413" t="mccraigmccraig i haven&apos;t yet come across any stream solution i couldn&apos;t express with some combination of those ops"><y>#</y><d>2018-08-13</d><h>18:20</h><w>mccraigmccraig</w>i haven&apos;t yet come across any stream solution i couldn&apos;t express with some combination of those ops</z><z id="t1534184574" t="fantomofdoom [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] Hi, i need smth like this &gt;in core.async (go-loop [] SOME WORK (&gt;! out-ch processed-msg) (recur)) i need infinity loop that get msg from channel process and push forward"><y>#</y><d>2018-08-13</d><h>18:22</h><w>fantomofdoom</w><a>@mccraigmccraig</a> Hi, i need smth like this
&gt;in core.async
<pre>(go-loop []
    SOME WORK
      (&gt;! out-ch processed-msg)
    (recur))</pre>

i need infinity loop that get msg from channel process and push forward</z><z id="t1534184698" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U4WBSRWG4&quot;}] that&apos;s a stream/map ... if you look at the impl you can see it uses the lower-level connect primitives to do pretty much what you are doing in your go loop - https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L614"><y>#</y><d>2018-08-13</d><h>18:24</h><w>mccraigmccraig</w><a>@fantomofdoom</a> that&apos;s a <code>stream/map</code> ... if you look at the impl you can see it uses the lower-level <code>connect</code> primitives to do pretty much what you are doing in your <code>go</code> loop - <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L614" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L614</a></z><z id="t1534185020" t="fantomofdoom thx)"><y>#</y><d>2018-08-13</d><h>18:30</h><w>fantomofdoom</w>thx)</z><z id="t1535974301" t="karlis Hi! Is it possible to close connections early in http client? I&apos;m fetching first rows from large files on S3 and don&apos;t need to transfer the whole files."><y>#</y><d>2018-09-03</d><h>11:31</h><w>karlis</w>Hi! Is it possible to close connections early in http client? I&apos;m fetching first rows from large files on S3 and don&apos;t need to transfer the whole files.</z><z id="t1535982309" t="bortexz Not sure about closing the connection early in http, but if you know the size of your rows, you can use Range header ( https://stackoverflow.com/questions/36436057/s3-how-to-do-a-partial-read-seek-without-downloading-the-complete-file )"><y>#</y><d>2018-09-03</d><h>13:45</h><w>bortexz</w>Not sure about closing the connection early in http, but if you know the size of your rows, you can use Range header (<a href="https://stackoverflow.com/questions/36436057/s3-how-to-do-a-partial-read-seek-without-downloading-the-complete-file" target="_blank">https://stackoverflow.com/questions/36436057/s3-how-to-do-a-partial-read-seek-without-downloading-the-complete-file</a>)</z><z id="t1536135973" t="karlis :thumbsup: thanks! this does exactly what I want."><y>#</y><d>2018-09-05</d><h>08:26</h><r>karlis</r><b>:thumbsup:</b>  thanks! this does exactly what I want.</z><z id="t1537444975" t="pyr Hi!"><y>#</y><d>2018-09-20</d><h>12:02</h><w>pyr</w>Hi!</z><z id="t1537445070" t="pyr We ran into a surprising corner-case where if a deferred chain has a manifold from alia (from alia.manifold/execute) in the chain, the subsequent fns in the chain will be executed on the cassandra java-driver pool, not the manifold pool"><y>#</y><d>2018-09-20</d><h>12:04</h><w>pyr</w>We ran into a surprising corner-case where if a deferred chain has a manifold from alia (from alia.manifold/execute) in the chain, the subsequent fns in the chain will be executed on the cassandra java-driver pool, not the manifold pool</z><z id="t1537445078" t="pyr d/chain&apos; avoids this behavior"><y>#</y><d>2018-09-20</d><h>12:04</h><w>pyr</w>d/chain&apos; avoids this behavior</z><z id="t1537445144" t="pyr but it&apos;s a bit unclear right now how we could keep the benefits of d/chain while avoiding this behavior (which can quickly exhaust the small I/O callback pools used by cassandra-driver)"><y>#</y><d>2018-09-20</d><h>12:05</h><w>pyr</w>but it&apos;s a bit unclear right now how we could keep the benefits of d/chain while avoiding this behavior (which can quickly exhaust the small I/O callback pools used by cassandra-driver)</z><z id="t1537445552" t="mpenet if I recall you can pass an :executor option to alia.manifold/execute to have the callback run in another pool"><y>#</y><d>2018-09-20</d><h>12:12</h><w>mpenet</w>if I recall you can pass an :executor option to alia.manifold/execute to have the callback run in another pool</z><z id="t1537445564" t="mpenet that could be a way to temporarly mitigate the issue"><y>#</y><d>2018-09-20</d><h>12:12</h><w>mpenet</w>that could be a way to temporarly mitigate the issue</z><z id="t1537445881" t="pyr I&apos;ll try that"><y>#</y><d>2018-09-20</d><h>12:18</h><w>pyr</w>I&apos;ll try that</z><z id="t1537445885" t="pyr it still boggles me"><y>#</y><d>2018-09-20</d><h>12:18</h><w>pyr</w>it still boggles me</z><z id="t1537445924" t="pyr I can track that down to (d/on-realized (alia.manifold/execute ...) #(warn %) #(warn %)) as showing the callback running on the cassandra-driver netty threadpool"><y>#</y><d>2018-09-20</d><h>12:18</h><w>pyr</w>I can track that down to (d/on-realized (alia.manifold/execute ...) #(warn %) #(warn %)) as showing the callback running on the cassandra-driver netty threadpool</z><z id="t1537445953" t="pyr I don&apos;t get how on-realized manages to schedule the callbacks on netty&apos;s threadpool"><y>#</y><d>2018-09-20</d><h>12:19</h><w>pyr</w>I don&apos;t get how on-realized manages to schedule the callbacks on netty&apos;s threadpool</z><z id="t1537445991" t="pyr (the result is a ListenableFuture which extends Future which manifold considers as a valid deferred)"><y>#</y><d>2018-09-20</d><h>12:19</h><w>pyr</w>(the result is a ListenableFuture which extends Future which manifold considers as a valid deferred)</z><z id="t1537446046" t="mpenet I&apos;d have to check how things work internally in manifold, I am not too familiar with it."><y>#</y><d>2018-09-20</d><h>12:20</h><w>mpenet</w>I&apos;d have to check how things work internally in manifold, I am not too familiar with it.</z><z id="t1537446046" t="pyr but I&apos;m not seeing where the execution is directed to the threadpool"><y>#</y><d>2018-09-20</d><h>12:20</h><w>pyr</w>but I&apos;m not seeing where the execution is directed to the threadpool</z><z id="t1537446089" t="mccraigmccraig huh, i&apos;m surprised i&apos;ve never run in to that problem"><y>#</y><d>2018-09-20</d><h>12:21</h><w>mccraigmccraig</w>huh, i&apos;m surprised i&apos;ve never run in to that problem</z><z id="t1537446115" t="mccraigmccraig what made you notice it [:attrs {:href &quot;/_/_/users/U06V097TP&quot;}] ?"><y>#</y><d>2018-09-20</d><h>12:21</h><w>mccraigmccraig</w>what made you notice it <a>@pyr</a>?</z><z id="t1537446152" t="mpenet in alia we have the callback (guava future) run in execute currentThread, unless specified otherwise."><y>#</y><d>2018-09-20</d><h>12:22</h><w>mpenet</w>in alia we have the callback (guava future) run in execute currentThread, unless specified otherwise.</z><z id="t1537446176" t="mpenet that&apos;s how I remember it at least (so from where execute was called from in short)"><y>#</y><d>2018-09-20</d><h>12:22</h><w>mpenet</w>that&apos;s how I remember it at least (so from where execute was called from in short)</z><z id="t1537446188" t="pyr [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] exhausting cassandra-driver&apos;s pool"><y>#</y><d>2018-09-20</d><h>12:23</h><w>pyr</w><a>@mccraigmccraig</a> exhausting cassandra-driver&apos;s pool</z><z id="t1537446207" t="pyr specifiying the executor in query opts obviously fixes the issue"><y>#</y><d>2018-09-20</d><h>12:23</h><w>pyr</w>specifiying the executor in query opts obviously fixes the issue</z><z id="t1537446212" t="pyr I&apos;m still surprised"><y>#</y><d>2018-09-20</d><h>12:23</h><w>pyr</w>I&apos;m still surprised</z><z id="t1537446233" t="pyr since d/chain&apos; doesn&apos;t expose the behavior"><y>#</y><d>2018-09-20</d><h>12:23</h><w>pyr</w>since d/chain&apos; doesn&apos;t expose the behavior</z><z id="t1537446244" t="mpenet weird"><y>#</y><d>2018-09-20</d><h>12:24</h><w>mpenet</w>weird</z><z id="t1537446245" t="mccraigmccraig does the cassandra-driver pool throw when it&apos;s exhausted ?"><y>#</y><d>2018-09-20</d><h>12:24</h><w>mccraigmccraig</w>does the cassandra-driver pool throw when it&apos;s exhausted ?</z><z id="t1537446301" t="mpenet Do you think alia should by default expose/use a callback threadpool to avoid these kind of odd cases?"><y>#</y><d>2018-09-20</d><h>12:25</h><w>mpenet</w>Do you think alia should by default expose/use a callback threadpool to avoid these kind of odd cases?</z><z id="t1537446330" t="pyr not necessarily"><y>#</y><d>2018-09-20</d><h>12:25</h><w>pyr</w>not necessarily</z><z id="t1537446343" t="pyr the standard cassandra-driver threadpool is quite valid for I/O callbacks"><y>#</y><d>2018-09-20</d><h>12:25</h><w>pyr</w>the standard cassandra-driver threadpool is quite valid for I/O callbacks</z><z id="t1537446346" t="mpenet If I recall I followed what java-driver does, not creating an additional pool for this and leaving it to the user"><y>#</y><d>2018-09-20</d><h>12:25</h><w>mpenet</w>If I recall I followed what java-driver does, not creating an additional pool for this and leaving it to the user</z><z id="t1537446355" t="pyr and no cpu should happen there"><y>#</y><d>2018-09-20</d><h>12:25</h><w>pyr</w>and no cpu should happen there</z><z id="t1537446356" t="mpenet but I ll revisit that"><y>#</y><d>2018-09-20</d><h>12:25</h><w>mpenet</w>but I ll revisit that</z><z id="t1537446358" t="mpenet yeah"><y>#</y><d>2018-09-20</d><h>12:25</h><w>mpenet</w>yeah</z><z id="t1537446360" t="mpenet exactly"><y>#</y><d>2018-09-20</d><h>12:26</h><w>mpenet</w>exactly</z><z id="t1537446363" t="pyr so I think this is valid"><y>#</y><d>2018-09-20</d><h>12:26</h><w>pyr</w>so I think this is valid</z><z id="t1537446404" t="pyr at some point the result is picked up as homomorphic to a deferred (makes sense) but the listenablefuture&apos;s callback pool is then used as the executor (doesn&apos;t yet make sense to me :-))"><y>#</y><d>2018-09-20</d><h>12:26</h><w>pyr</w>at some point the result is picked up as homomorphic to a deferred (makes sense) but the listenablefuture&apos;s callback pool is then used as the executor (doesn&apos;t yet make sense to me :-))</z><z id="t1537446415" t="pyr I&apos;ll dig further and use :executor in the meantime"><y>#</y><d>2018-09-20</d><h>12:26</h><w>pyr</w>I&apos;ll dig further and use :executor in the meantime</z><z id="t1537446470" t="mpenet I get highlights/notifications on &quot;alia&quot; mentions, looking fwd to understanding what&apos;s up"><y>#</y><d>2018-09-20</d><h>12:27</h><w>mpenet</w>I get highlights/notifications on &quot;alia&quot; mentions, looking fwd to understanding what&apos;s up</z><z id="t1537447912" t="pyr Ok, it seems to come down to this:"><y>#</y><d>2018-09-20</d><h>12:51</h><w>pyr</w>Ok, it seems to come down to this:</z><z id="t1537447935" t="pyr alia creates a deferred w/o specifying an executor in alia.manifold/execute"><y>#</y><d>2018-09-20</d><h>12:52</h><w>pyr</w>alia creates a deferred w/o specifying an executor in alia.manifold/execute</z><z id="t1537447958" t="pyr When d/success! or d/error! are called"><y>#</y><d>2018-09-20</d><h>12:52</h><w>pyr</w>When d/success! or d/error! are called</z><z id="t1537447999" t="pyr The corresponding deferred thus has no executor, which means that the callbacks will be executed on the calling thread, hence in this case on cassandra-driver&apos;s threadpool"><y>#</y><d>2018-09-20</d><h>12:53</h><w>pyr</w>The corresponding deferred thus has no executor, which means that the callbacks will be executed on the calling thread, hence in this case on cassandra-driver&apos;s threadpool</z><z id="t1537448094" t="mpenet oh right, so in theory just passing the :executor option value to deferred should do it, then the alia/execute calling thread would be the default and the user can overwrite that with that :executor option if needed"><y>#</y><d>2018-09-20</d><h>12:54</h><w>mpenet</w>oh right, so in theory just passing the :executor option value to deferred should do it, then the alia/execute calling thread would be the default and the user can overwrite that with that :executor option if needed</z><z id="t1537448103" t="pyr ah wait no"><y>#</y><d>2018-09-20</d><h>12:55</h><w>pyr</w>ah wait no</z><z id="t1537448113" t="pyr deferred with no args gets (ex/executor)"><y>#</y><d>2018-09-20</d><h>12:55</h><w>pyr</w>deferred with no args gets (ex/executor)</z><z id="t1537448116" t="pyr my theory is wrong"><y>#</y><d>2018-09-20</d><h>12:55</h><w>pyr</w>my theory is wrong</z><z id="t1537448126" t="mpenet hmm"><y>#</y><d>2018-09-20</d><h>12:55</h><w>mpenet</w>hmm</z><z id="t1537448131" t="pyr sorry"><y>#</y><d>2018-09-20</d><h>12:55</h><w>pyr</w>sorry</z><z id="t1537448179" t="mpenet right: https://github.com/ztellman/manifold/blob/master/src/manifold/deferred.clj#L562"><y>#</y><d>2018-09-20</d><h>12:56</h><w>mpenet</w>right: <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/deferred.clj#L562" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/deferred.clj#L562</a></z><z id="t1537448319" t="pyr this is it though"><y>#</y><d>2018-09-20</d><h>12:58</h><w>pyr</w>this is it though</z><z id="t1537448331" t="pyr ex/executor yields nil in my case"><y>#</y><d>2018-09-20</d><h>12:58</h><w>pyr</w>ex/executor yields nil in my case</z><z id="t1537448346" t="pyr https://github.com/ztellman/manifold/blob/master/src/manifold/executor.clj#L24-L25"><y>#</y><d>2018-09-20</d><h>12:59</h><w>pyr</w><a href="https://github.com/ztellman/manifold/blob/master/src/manifold/executor.clj#L24-L25" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/executor.clj#L24-L25</a></z><z id="t1537448632" t="pyr OK, so I can wrap alia.manifold/execute in a manifold.executor/with-executor and all is well"><y>#</y><d>2018-09-20</d><h>13:03</h><w>pyr</w>OK, so I can wrap alia.manifold/execute in a manifold.executor/with-executor and all is well</z><z id="t1537448637" t="pyr sorry about the noise"><y>#</y><d>2018-09-20</d><h>13:03</h><w>pyr</w>sorry about the noise</z><z id="t1537448655" t="mpenet no worries, good to know."><y>#</y><d>2018-09-20</d><h>13:04</h><w>mpenet</w>no worries, good to know.</z><z id="t1537448665" t="pyr (this keeps compute-bound in the manifold pool, and I/O in the cassandra-driver pool)"><y>#</y><d>2018-09-20</d><h>13:04</h><w>pyr</w>(this keeps compute-bound in the manifold pool, and I/O in the cassandra-driver pool)</z><z id="t1537498932" t="pablore Hi there! Is it possible to integrate aleph with some other netty based server? Specifically [netty-socketio]( https://github.com/mrniko/netty-socketio )"><y>#</y><d>2018-09-21</d><h>03:02</h><w>pablore</w>Hi there! Is it possible to integrate aleph with some other netty based server? Specifically [netty-socketio](<a href="https://github.com/mrniko/netty-socketio" target="_blank">https://github.com/mrniko/netty-socketio</a>)</z><z id="t1537528758" t="pyr Hey again!"><y>#</y><d>2018-09-21</d><h>11:19</h><w>pyr</w>Hey again!</z><z id="t1537528765" t="pyr Some news on the alia + aleph case"><y>#</y><d>2018-09-21</d><h>11:19</h><w>pyr</w>Some news on the alia + aleph case</z><z id="t1537528789" t="pyr The behavior exhibits since: https://github.com/ztellman/manifold/commit/193f5f48972c8e20dd0a9fc41a1311566a9f7bdd?w=1"><y>#</y><d>2018-09-21</d><h>11:19</h><w>pyr</w>The behavior exhibits since: <a href="https://github.com/ztellman/manifold/commit/193f5f48972c8e20dd0a9fc41a1311566a9f7bdd?w=1" target="_blank">https://github.com/ztellman/manifold/commit/193f5f48972c8e20dd0a9fc41a1311566a9f7bdd?w=1</a></z><z id="t1537528803" t="pyr Switching back to manifold 0.1.6 fixes the behavior"><y>#</y><d>2018-09-21</d><h>11:20</h><w>pyr</w>Switching back to manifold 0.1.6 fixes the behavior</z><z id="t1537529064" t="mpenet ok, so that was intentional"><y>#</y><d>2018-09-21</d><h>11:24</h><w>mpenet</w>ok, so that was intentional</z><z id="t1537537631" t="pyr I&apos;ll follow up but I can reproduce without aleph or alia https://gist.github.com/718e9d0a85ec27a38c5de62fbb6f065b"><y>#</y><d>2018-09-21</d><h>13:47</h><w>pyr</w>I&apos;ll follow up but I can reproduce without aleph or alia <a href="https://gist.github.com/718e9d0a85ec27a38c5de62fbb6f065b" target="_blank">https://gist.github.com/718e9d0a85ec27a38c5de62fbb6f065b</a></z><z id="t1537537648" t="mpenet I saw that üòâ"><y>#</y><d>2018-09-21</d><h>13:47</h><w>mpenet</w>I saw that <b>üòâ</b></z><z id="t1537537672" t="mpenet I saw the repro in the fork of greut&apos;s repo"><y>#</y><d>2018-09-21</d><h>13:47</h><w>mpenet</w>I saw the repro in the fork of greut&apos;s repo</z><z id="t1537537686" t="pyr https://gist.github.com/pyr/718e9d0a85ec27a38c5de62fbb6f065b#file-foo-clj-L48 is what bothers me"><y>#</y><d>2018-09-21</d><h>13:48</h><w>pyr</w><a href="https://gist.github.com/pyr/718e9d0a85ec27a38c5de62fbb6f065b#file-foo-clj-L48" target="_blank">https://gist.github.com/pyr/718e9d0a85ec27a38c5de62fbb6f065b#file-foo-clj-L48</a> is what bothers me</z><z id="t1537537692" t="pyr heh üôÇ"><y>#</y><d>2018-09-21</d><h>13:48</h><w>pyr</w>heh <b>üôÇ</b></z><z id="t1537537695" t="mpenet nice"><y>#</y><d>2018-09-21</d><h>13:48</h><w>mpenet</w>nice</z><z id="t1537537839" t="mccraigmccraig ah, that explains why i haven&apos;t seen the behaviour - i don&apos;t use let-flow"><y>#</y><d>2018-09-21</d><h>13:50</h><w>mccraigmccraig</w>ah, that explains why i haven&apos;t seen the behaviour - i don&apos;t use <code>let-flow</code></z><z id="t1537537871" t="mccraigmccraig (i&apos;m using https://github.com/funcool/cats/blob/master/src/cats/labs/manifold.clj instead)"><y>#</y><d>2018-09-21</d><h>13:51</h><w>mccraigmccraig</w>(i&apos;m using <a href="https://github.com/funcool/cats/blob/master/src/cats/labs/manifold.clj" target="_blank">https://github.com/funcool/cats/blob/master/src/cats/labs/manifold.clj</a> instead)</z><z id="t1537538195" t="mpenet vanillia core.async here"><y>#</y><d>2018-09-21</d><h>13:56</h><w>mpenet</w>vanillia core.async here</z><z id="t1537539853" t="pyr [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] I can more reliably reproduce on 1.0.8 than 1.0.6"><y>#</y><d>2018-09-21</d><h>14:24</h><w>pyr</w><a>@mccraigmccraig</a> I can more reliably reproduce on 1.0.8 than 1.0.6</z><z id="t1537539873" t="pyr [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] e.g: my initial alia + aleph case does not reproduce if I force manifold at 1.0.6"><y>#</y><d>2018-09-21</d><h>14:24</h><w>pyr</w><a>@mccraigmccraig</a> e.g: my initial alia + aleph case does not reproduce if I force manifold at 1.0.6</z><z id="t1537539893" t="pyr which I think is due to https://github.com/ztellman/manifold/commit/193f5f48972c8e20dd0a9fc41a1311566a9f7bdd?w=1"><y>#</y><d>2018-09-21</d><h>14:24</h><w>pyr</w>which I think is due to  <a href="https://github.com/ztellman/manifold/commit/193f5f48972c8e20dd0a9fc41a1311566a9f7bdd?w=1" target="_blank">https://github.com/ztellman/manifold/commit/193f5f48972c8e20dd0a9fc41a1311566a9f7bdd?w=1</a></z><z id="t1537539893" t="mccraigmccraig i&apos;m on 0.1.7-alpha6 atm... so could be either way"><y>#</y><d>2018-09-21</d><h>14:24</h><w>mccraigmccraig</w>i&apos;m on 0.1.7-alpha6 atm... so could be either way</z><z id="t1537539904" t="pyr ah"><y>#</y><d>2018-09-21</d><h>14:25</h><w>pyr</w>ah</z><z id="t1537539911" t="pyr but then you might not have the above commit"><y>#</y><d>2018-09-21</d><h>14:25</h><w>pyr</w>but then you might not have the above commit</z><z id="t1537539920" t="pyr it is for sure on 1.0.7 and 1.0.8"><y>#</y><d>2018-09-21</d><h>14:25</h><w>pyr</w>it is for sure on 1.0.7 and 1.0.8</z><z id="t1537539928" t="pyr I need to dig further"><y>#</y><d>2018-09-21</d><h>14:25</h><w>pyr</w>I need to dig further</z><z id="t1537539934" t="mccraigmccraig possibly - i&apos;ve not got time to dig into it atm - i&apos;ll have a look on monday"><y>#</y><d>2018-09-21</d><h>14:25</h><w>mccraigmccraig</w>possibly - i&apos;ve not got time to dig into it atm - i&apos;ll have a look on monday</z><z id="t1537539951" t="mccraigmccraig but if the problem is in the let-flow expansion, then i wouldn&apos;t experience it"><y>#</y><d>2018-09-21</d><h>14:25</h><w>mccraigmccraig</w>but if the problem is in the <code>let-flow</code> expansion, then i wouldn&apos;t experience it</z><z id="t1537539956" t="mccraigmccraig whatever version"><y>#</y><d>2018-09-21</d><h>14:25</h><w>mccraigmccraig</w>whatever version</z><z id="t1540548467" t="cmal Hi, I have a problem when using aleph as a http server: https://stackoverflow.com/questions/53004800/clojure-aleph-http-server-does-not-respond-body Can anyone here help me with this? Thanks!"><y>#</y><d>2018-10-26</d><h>10:07</h><w>cmal</w>Hi, I have a problem when using aleph as a http server: <a href="https://stackoverflow.com/questions/53004800/clojure-aleph-http-server-does-not-respond-body" target="_blank">https://stackoverflow.com/questions/53004800/clojure-aleph-http-server-does-not-respond-body</a>  Can anyone here help me with this? Thanks!</z><z id="t1540549053" t="lispyclouds [:attrs {:href &quot;/_/_/users/U3A8CQMGU&quot;}] Seems to work for me. curl -v &quot;&quot; * Trying ::1... * TCP_NODELAY set * Connected to localhost (::1) port 8080 (#0) &gt; GET / HTTP/1.1 &gt; Host: localhost:8080 &gt; User-Agent: curl/7.61.1 &gt; Accept: */* &gt; &lt; HTTP/1.1 200 OK &lt; Content-Type: text/plain &lt; Server: Aleph/0.4.4 &lt; Connection: Keep-Alive &lt; Date: Fri, 26 Oct 2018 10:16:02 GMT &lt; content-length: 14 &lt; * Connection #0 to host localhost left intact wallet backend "><y>#</y><d>2018-10-26</d><h>10:17</h><w>lispyclouds</w><a>@cmal</a> Seems to work for me.
<pre>curl -v &quot;&quot;
*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 8080 (#0)
&gt; GET / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/plain
&lt; Server: Aleph/0.4.4
&lt; Connection: Keep-Alive
&lt; Date: Fri, 26 Oct 2018 10:16:02 GMT
&lt; content-length: 14
&lt;
* Connection #0 to host localhost left intact
wallet backend
</pre></z><z id="t1540549069" t="lispyclouds how have you configured the main?"><y>#</y><d>2018-10-26</d><h>10:17</h><w>lispyclouds</w>how have you configured the main?</z><z id="t1540549121" t="lispyclouds i wrote this and it works (ns myapp.core (:require [aleph.http :as http] [compojure.core :as compojure :refer [GET POST]] [ring.middleware.params :as params])) (defn root-handler [req] {:status 200 :headers {&quot;content-type&quot; &quot;text/plain&quot;} :body &quot;wallet backend&quot;}) (def http-handler (params/wrap-params (compojure/routes (GET &quot;/&quot; [] root-handler)))) (defn -main [] (http/start-server http-handler {:port 8080})) "><y>#</y><d>2018-10-26</d><h>10:18</h><w>lispyclouds</w>i wrote this and it works
<pre>(ns myapp.core
  (:require
   [aleph.http :as http]
   [compojure.core :as compojure :refer [GET POST]]
   [ring.middleware.params :as params]))

(defn root-handler
  [req]
  {:status 200
   :headers {&quot;content-type&quot; &quot;text/plain&quot;}
   :body &quot;wallet backend&quot;})

(def http-handler
  (params/wrap-params
   (compojure/routes
    (GET &quot;/&quot; [] root-handler))))

(defn -main
  []
  (http/start-server http-handler {:port 8080}))
</pre></z><z id="t1540967359" t="cmal [:attrs {:href &quot;/_/_/users/U7ERLH6JX&quot;}] thank you. sorry for late. it seems that restart my app solves this problem."><y>#</y><d>2018-10-31</d><h>06:29</h><w>cmal</w><a>@rahul080327</a> thank you. sorry for late. it seems that restart my app solves this problem.</z><z id="t1541609719" t="ricardo.ekm Hi, we&apos;re trying to convert a ring-&gt;jetty app to ring-&gt;aleph app"><y>#</y><d>2018-11-07</d><h>16:55</h><w>ricardo.ekm</w>Hi, we&apos;re trying to convert a ring-&gt;jetty app to ring-&gt;aleph app</z><z id="t1541609732" t="ricardo.ekm we&apos;re using core.async and not so familiar with Manifold"><y>#</y><d>2018-11-07</d><h>16:55</h><w>ricardo.ekm</w>we&apos;re using core.async and not so familiar with Manifold</z><z id="t1541609745" t="ricardo.ekm we&apos;ve checked this snippet in the docs"><y>#</y><d>2018-11-07</d><h>16:55</h><w>ricardo.ekm</w>we&apos;ve checked this snippet in the docs</z><z id="t1541609747" t="ricardo.ekm (s/take! (s/-&gt;source"><y>#</y><d>2018-11-07</d><h>16:55</h><w>ricardo.ekm</w>(s/take!
    (s/-&gt;source</z><z id="t1541609775" t="ricardo.ekm could someone please clarify what this is doing? does it has the risk to block the thread or any performance impact?"><y>#</y><d>2018-11-07</d><h>16:56</h><w>ricardo.ekm</w>could someone please clarify what this is doing? does it has the risk to block the thread or any performance impact?</z><z id="t1541617436" t="ricardo.ekm We tested it doesn&apos;t block the java thread. The performance seems ok, we&apos;re doing further testing."><y>#</y><d>2018-11-07</d><h>19:03</h><r>ricardo.ekm</r>We tested it doesn&apos;t block the java thread. The performance seems ok, we&apos;re doing further testing.</z><z id="t1541609890" t="ricardo.ekm"><y>#</y><d>2018-11-07</d><h>16:58</h><w>ricardo.ekm</w></z><z id="t1541609898" t="ricardo.ekm https://aleph.io/aleph/literate.html#aleph.examples.http"><y>#</y><d>2018-11-07</d><h>16:58</h><w>ricardo.ekm</w><a href="https://aleph.io/aleph/literate.html#aleph.examples.http" target="_blank">https://aleph.io/aleph/literate.html#aleph.examples.http</a></z><z id="t1541616339" t="ricardo.ekm one more question what targetUtilization in the connection pool mean?"><y>#</y><d>2018-11-07</d><h>18:45</h><w>ricardo.ekm</w>one more question what targetUtilization in the connection pool mean?</z><z id="t1541616351" t="ricardo.ekm is it the initial open connections?"><y>#</y><d>2018-11-07</d><h>18:45</h><w>ricardo.ekm</w>is it the initial open connections?</z><z id="t1541616485" t="ricardo.ekm (in connection pool)"><y>#</y><d>2018-11-07</d><h>18:48</h><w>ricardo.ekm</w>(in connection pool)</z><z id="t1541616496" t="ricardo.ekm https://github.com/ztellman/dirigiste/blob/a71ee4dc3a97e79c7c5ac5c58d465ab8e6bf3519/src/io/aleph/dirigiste/Pools.java"><y>#</y><d>2018-11-07</d><h>18:48</h><w>ricardo.ekm</w><a href="https://github.com/ztellman/dirigiste/blob/a71ee4dc3a97e79c7c5ac5c58d465ab8e6bf3519/src/io/aleph/dirigiste/Pools.java" target="_blank">https://github.com/ztellman/dirigiste/blob/a71ee4dc3a97e79c7c5ac5c58d465ab8e6bf3519/src/io/aleph/dirigiste/Pools.java</a></z><z id="t1541617365" t="ricardo.ekm Sorry for the questions flood, what&apos;s the best way to deal with Aleph HTTP client + core.async. We&apos;d like when the HTTP request is completed, put the response in a core.async channel. Does manifold deref (@) block the thread? is there a way to implement a callback function when the request is completed?"><y>#</y><d>2018-11-07</d><h>19:02</h><w>ricardo.ekm</w>Sorry for the questions flood, what&apos;s the best way to deal with Aleph HTTP client + core.async. We&apos;d like when the HTTP request is completed, put the response in a core.async channel. Does manifold deref (@) block the thread? is there a way to implement a callback function when the request is completed?</z><z id="t1541617934" t="ricardo.ekm Just found d/on-realized üôÇ"><y>#</y><d>2018-11-07</d><h>19:12</h><w>ricardo.ekm</w>Just found d/on-realized <b>üôÇ</b></z><z id="t1541617956" t="ricardo.ekm"><y>#</y><d>2018-11-07</d><h>19:12</h><w>ricardo.ekm</w></z><z id="t1541707293" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U2RRY365V&quot;}] on-realized is quite low-level - it will work fine, but chain or let-flow are generally more convenient for deferred composition"><y>#</y><d>2018-11-08</d><h>20:01</h><w>mccraigmccraig</w><a>@ricardo.ekm</a> <code>on-realized</code> is quite low-level - it will work fine, but <code>chain</code> or <code>let-flow</code> are generally more convenient for deferred composition</z><z id="t1541726494" t="ricardo.ekm thanks [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] I&apos;ll check those methods"><y>#</y><d>2018-11-09</d><h>01:21</h><w>ricardo.ekm</w>thanks <a>@mccraigmccraig</a> I&apos;ll check those methods</z><z id="t1541728998" t="ricardo.ekm does anyone know what the target utilization concept mean?"><y>#</y><d>2018-11-09</d><h>02:03</h><w>ricardo.ekm</w>does anyone know what the target utilization concept mean?</z><z id="t1541744546" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U2RRY365V&quot;}] i believe it&apos;s from dirigiste, and will be used to size a thread-pool : https://github.com/ztellman/dirigiste#executors"><y>#</y><d>2018-11-09</d><h>06:22</h><w>mccraigmccraig</w><a>@ricardo.ekm</a> i believe it&apos;s from dirigiste, and will be used to size a thread-pool : <a href="https://github.com/ztellman/dirigiste#executors" target="_blank">https://github.com/ztellman/dirigiste#executors</a></z><z id="t1542104538" t="lambdam Hello, I am building a full stack Clojure(Script) application from a re-natal template. I added Datomic and various libraries to also have a website, frontend and backend. I use integrant for the system and... aleph for the webserver. I stumbled on a weird behaviour : sometimes, after a cider refresh, all HTTP requests hang forever. The only solution I found is to stop everything and cider-jack-in again. Switching to http-kit seems to solve the problem. On other lightest projects (mainly without the re-natal stack) I have no problems. Did anyone experience that? Thanks"><y>#</y><d>2018-11-13</d><h>10:22</h><w>lambdam</w>Hello,
I am building a full stack Clojure(Script) application from a re-natal template. I added Datomic and various libraries to also have a website, frontend and backend.
I use integrant for the system and... aleph for the webserver.
I stumbled on a weird behaviour : sometimes, after a cider refresh, all HTTP requests hang forever. The only solution I found is to stop everything and cider-jack-in again.
Switching to http-kit seems to solve the problem.
On other lightest projects (mainly without the re-natal stack) I have no problems.
Did anyone experience that?
Thanks</z><z id="t1542109555" t="mccraigmccraig are you correctly shutting down and restarting your aleph server [:attrs {:href &quot;/_/_/users/U94V75LDV&quot;}] ? we regularly do clojure.tools.namespace.repl/refresh with aleph, after shutting down the aleph server (via our component system manager), and haven&apos;t experienced any such problems"><y>#</y><d>2018-11-13</d><h>11:45</h><w>mccraigmccraig</w>are you correctly shutting down and restarting your aleph server <a>@dam</a> ? we regularly do <code>clojure.tools.namespace.repl/refresh</code> with aleph, after shutting down the aleph server (via our component system manager), and haven&apos;t experienced any such problems</z><z id="t1542189764" t="lambdam [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] yes I think that i&apos;m correctly shutting it down. Here is my server definition with integrant: (defn create-aleph-server [aleph-config] ;; handler ;; middlewares... ;; returns aleph server ) (defmethod ig/init-key ::aleph [_ aleph-config] (create-aleph-server aleph-config)) (defmethod ig/halt-key! ::aleph [_ server] (.close server)) (defmethod ig/suspend-key! ::aleph [_ server] (.close server)) (defmethod ig/resume-key ::aleph [_key aleph-config _old-opts _old-impl] (create-aleph-server aleph-config)) Every time I fire cider-refresh , the server is killed and rebuilt (there is an Emacs hook with a local .dir-locals.el file): ((nil . ((cider-ns-refresh-before-fn . &quot;integrant.repl/suspend&quot;) (cider-ns-refresh-after-fn . &quot;integrant.repl/resume&quot;)))) Also, if I&apos;m not mistaken, cider-refresh uses internally clojure.tools.namespace.repl/refresh . The weird thing is that on &quot;simple&quot; projects, this code works perfectly with aleph but with the heavier one (re-natal + web server + Datomic + integrant), aleph seems to get stuck randomly on dev with Spacemacs."><y>#</y><d>2018-11-14</d><h>10:02</h><w>lambdam</w><a>@mccraigmccraig</a> yes I think that i&apos;m correctly shutting it down. Here is my server definition with integrant:

<pre>(defn create-aleph-server [aleph-config]
  ;; handler
  ;; middlewares...
  ;; returns aleph server
  )

(defmethod ig/init-key ::aleph [_ aleph-config]
  (create-aleph-server aleph-config))

(defmethod ig/halt-key! ::aleph [_ server]
  (.close server))

(defmethod ig/suspend-key! ::aleph [_ server]
  (.close server))

(defmethod ig/resume-key ::aleph [_key aleph-config _old-opts _old-impl]
  (create-aleph-server aleph-config))
</pre>

Every time I fire <code>cider-refresh</code>, the server is killed and rebuilt (there is an Emacs hook with a local <code>.dir-locals.el</code> file):

<pre>((nil . ((cider-ns-refresh-before-fn . &quot;integrant.repl/suspend&quot;)
         (cider-ns-refresh-after-fn  . &quot;integrant.repl/resume&quot;))))
</pre>

Also, if I&apos;m not mistaken, <code>cider-refresh</code> uses internally <code>clojure.tools.namespace.repl/refresh</code>.
The weird thing is that on &quot;simple&quot; projects, this code works perfectly with aleph but with the heavier one (re-natal + web server + Datomic + integrant), aleph seems to get stuck randomly on dev with Spacemacs.</z><z id="t1542190020" t="mccraigmccraig i don&apos;t have any ideas [:attrs {:href &quot;/_/_/users/U94V75LDV&quot;}] - your setup is quite different from mine. perhaps worth checking the socket is being released correctly when your server is .close d"><y>#</y><d>2018-11-14</d><h>10:07</h><w>mccraigmccraig</w>i don&apos;t have any ideas <a>@dam</a> - your setup is quite different from mine. perhaps worth checking the socket is being released correctly when your server is <code>.close</code>d</z><z id="t1542190071" t="lambdam oh thanks"><y>#</y><d>2018-11-14</d><h>10:07</h><w>lambdam</w>oh thanks</z><z id="t1542190078" t="lambdam I never did that"><y>#</y><d>2018-11-14</d><h>10:07</h><w>lambdam</w>I never did that</z><z id="t1542190109" t="lambdam Do you have any piece of advice to do that on Linux. What tool?"><y>#</y><d>2018-11-14</d><h>10:08</h><w>lambdam</w>Do you have any piece of advice to do that on Linux. What tool?</z><z id="t1542203968" t="valerauko [:attrs {:href &quot;/_/_/users/U94V75LDV&quot;}] it&apos;s a known bug"><y>#</y><d>2018-11-14</d><h>13:59</h><w>valerauko</w><a>@dam</a> it&apos;s a known bug</z><z id="t1542203996" t="valerauko https://github.com/ztellman/aleph/issues/365"><y>#</y><d>2018-11-14</d><h>13:59</h><w>valerauko</w><a href="https://github.com/ztellman/aleph/issues/365" target="_blank">https://github.com/ztellman/aleph/issues/365</a></z><z id="t1542204028" t="valerauko apparently it SOMETIMES breaks"><y>#</y><d>2018-11-14</d><h>14:00</h><w>valerauko</w>apparently it SOMETIMES breaks</z><z id="t1542204109" t="valerauko i ran into this issue just today while debugging something else"><y>#</y><d>2018-11-14</d><h>14:01</h><w>valerauko</w>i ran into this issue just today while debugging something else</z><z id="t1542230828" t="lambdam oh thanks [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] , it seems to be exactly that"><y>#</y><d>2018-11-14</d><h>21:27</h><w>lambdam</w>oh thanks <a>@vale</a>, it seems to be exactly that</z><z id="t1543663376" t="valerauko is there a way to debug / dump requests sent by the aleph http client?"><y>#</y><d>2018-12-01</d><h>11:22</h><w>valerauko</w>is there a way to debug / dump requests sent by the aleph http client?</z><z id="t1543663409" t="valerauko i&apos;m having some requests mysteriously fail and i&apos;d love to see what headers aleph actually sent"><y>#</y><d>2018-12-01</d><h>11:23</h><w>valerauko</w>i&apos;m having some requests mysteriously fail and i&apos;d love to see what headers aleph actually sent</z><z id="t1543665135" t="gsnewmark There are couple of request debugging options since the 0.4.7-alpha2 (I&apos;m not actually sure about the version, but it&apos;s in the current master for sure). Here are the details https://github.com/ztellman/aleph/pull/401 (cc [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] )"><y>#</y><d>2018-12-01</d><h>11:52</h><w>gsnewmark</w>There are couple of request debugging options since the 0.4.7-alpha2 (I&apos;m not actually sure about the version, but it&apos;s in the current master for sure). Here are the details <a href="https://github.com/ztellman/aleph/pull/401" target="_blank">https://github.com/ztellman/aleph/pull/401</a> (cc <a>@kachayev</a>)</z><z id="t1543665702" t="valerauko oh so there&apos;s no way to do it in earlier versions? i&apos;m on 0.4.6"><y>#</y><d>2018-12-01</d><h>12:01</h><w>valerauko</w>oh so there&apos;s no way to do it in earlier versions? i&apos;m on 0.4.6</z><z id="t1543666343" t="gsnewmark I&apos;m afraid there is nothing ready to use out of the box, but you can still add Netty&apos;s LoggingHandler manually (just like it&apos;s done in the PR https://github.com/ztellman/aleph/pull/401/files#diff-e2d1dde5203e0962010d2fb176031b3cR418 ) using the :pipeline-transform option of the connection pool https://github.com/ztellman/aleph/blob/ef331d14fabb629f94bc46b96af92b0e7d9ec37f/src/aleph/http.clj#L108 . Basically you should pass a function which accepts a pipeline as :pipeline-transform , create a LoggingHandler in it, and call (.addFirst pipeline &quot;activity-logger&quot; logger) (just don&apos;t forget to return the pipeline itself from the passed function)"><y>#</y><d>2018-12-01</d><h>12:12</h><w>gsnewmark</w>I&apos;m afraid there is nothing ready to use out of the box, but you can still add Netty&apos;s <code>LoggingHandler</code> manually (just like it&apos;s done in the PR <a href="https://github.com/ztellman/aleph/pull/401/files#diff-e2d1dde5203e0962010d2fb176031b3cR418" target="_blank">https://github.com/ztellman/aleph/pull/401/files#diff-e2d1dde5203e0962010d2fb176031b3cR418</a>) using the <code>:pipeline-transform</code> option of the connection pool <a href="https://github.com/ztellman/aleph/blob/ef331d14fabb629f94bc46b96af92b0e7d9ec37f/src/aleph/http.clj#L108" target="_blank">https://github.com/ztellman/aleph/blob/ef331d14fabb629f94bc46b96af92b0e7d9ec37f/src/aleph/http.clj#L108</a>. Basically you should pass a function which accepts a <code>pipeline</code> as <code>:pipeline-transform</code>, create a <code>LoggingHandler</code> in it, and call <code>(.addFirst pipeline &quot;activity-logger&quot; logger)</code> (just don&apos;t forget to return the pipeline itself from the passed function)</z><z id="t1543667369" t="valerauko thanks for the suggestion"><y>#</y><d>2018-12-01</d><h>12:29</h><w>valerauko</w>thanks for the suggestion</z><z id="t1543667387" t="valerauko i managed to get the logging work based on the code you pointed out"><y>#</y><d>2018-12-01</d><h>12:29</h><w>valerauko</w>i managed to get the logging work based on the code you pointed out</z><z id="t1543667408" t="valerauko but since the request in question is over https it&apos;s all encrypted"><y>#</y><d>2018-12-01</d><h>12:30</h><w>valerauko</w>but since the request in question is over https it&apos;s all encrypted</z><z id="t1543667420" t="valerauko is logging possible on one layer higher?"><y>#</y><d>2018-12-01</d><h>12:30</h><w>valerauko</w>is logging possible on one layer higher?</z><z id="t1543668004" t="gsnewmark It should be possible using some combination of handlers added to the pipeline, but I don&apos;t have an example at hand :( Can you update the Aleph by any chance? "><y>#</y><d>2018-12-01</d><h>12:40</h><w>gsnewmark</w>It should be possible using some combination of handlers added to the pipeline, but I don&apos;t have an example at hand :( Can you update the Aleph by any chance? </z><z id="t1543668023" t="valerauko yeah i&apos;ll try that for now"><y>#</y><d>2018-12-01</d><h>12:40</h><w>valerauko</w>yeah i&apos;ll try that for now</z><z id="t1543668038" t="valerauko thanks for the help!"><y>#</y><d>2018-12-01</d><h>12:40</h><w>valerauko</w>thanks for the help!</z><z id="t1543668098" t="gsnewmark np"><y>#</y><d>2018-12-01</d><h>12:41</h><w>gsnewmark</w>np</z><z id="t1543849875" t="igrishaev Hi, just a small question. While reading aleph Websockets samples, I found this: ;; take all messages from the client, prepend the name, and publish it to the room (s/consume #(bus/publish! chatrooms room %) (-&gt;&gt; conn (s/map #(str name &quot;: &quot; %)) (s/buffer 100))) What‚Äôs the meaning here of wrapping the source stream with a buffer? As far as I understand, it‚Äôs important when sending messages into a stream. But what does buffering when reading messages?"><y>#</y><d>2018-12-03</d><h>15:11</h><w>igrishaev</w>Hi, just a small question. While reading aleph Websockets samples, I found this:

<pre>;; take all messages from the client, prepend the name, and publish it to the room
        (s/consume
          #(bus/publish! chatrooms room %)
          (-&gt;&gt; conn
            (s/map #(str name &quot;: &quot; %))
            (s/buffer 100)))
</pre>
What‚Äôs the meaning here of wrapping the source stream with a buffer? As far as I understand, it‚Äôs important when sending messages into a stream. But what does buffering when reading messages?</z><z id="t1543849911" t="igrishaev And what will happen if I drop the trailing (s/buffer 100) ?"><y>#</y><d>2018-12-03</d><h>15:11</h><w>igrishaev</w>And what will happen if I drop the trailing <code>(s/buffer 100)</code>?</z><z id="t1543851094" t="rborer I believe that without the buffer sending a message from a client would &quot;block&quot; until all participants have received it"><y>#</y><d>2018-12-03</d><h>15:31</h><w>rborer</w>I believe that without the buffer sending a message from a client would &quot;block&quot; until all participants have received it</z><z id="t1543851109" t="rborer Per https://github.com/ztellman/manifold/blob/master/docs/stream.md#buffers-and-backpressure &gt; We saw above that if we attempt to put a message into a stream, it won&apos;t succeed until the value is taken out. This is because the default stream has no buffer"><y>#</y><d>2018-12-03</d><h>15:31</h><w>rborer</w>Per <a href="https://github.com/ztellman/manifold/blob/master/docs/stream.md#buffers-and-backpressure" target="_blank">https://github.com/ztellman/manifold/blob/master/docs/stream.md#buffers-and-backpressure</a>
&gt; We saw above that if we attempt to put a message into a stream, it won&apos;t succeed until the value is taken out. This is because the default stream has no buffer</z><z id="t1543851343" t="rborer Well no, it depends on the implementation of event-bus"><y>#</y><d>2018-12-03</d><h>15:35</h><w>rborer</w>Well no, it depends on the implementation of event-bus</z><z id="t1543851390" t="igrishaev Well, I got it as pre-loading a certain amount of messages in advance"><y>#</y><d>2018-12-03</d><h>15:36</h><w>igrishaev</w>Well, I got it as pre-loading a certain amount of messages in advance</z><z id="t1543851417" t="igrishaev Like the do when reading a file from a disk."><y>#</y><d>2018-12-03</d><h>15:36</h><w>igrishaev</w>Like the do when reading a file from a disk.</z><z id="t1543851435" t="rborer yeah, but then the example wouldn&apos;t work, right? I mean, the example is sending a single message by each client üòï"><y>#</y><d>2018-12-03</d><h>15:37</h><w>rborer</w>yeah, but then the example wouldn&apos;t work, right? I mean, the example is sending a single message by each client <b>üòï</b></z><z id="t1543851514" t="igrishaev It would. There is a video when the author says, without a buffer a slow client may slow down everybody"><y>#</y><d>2018-12-03</d><h>15:38</h><w>igrishaev</w>It would. There is a video when the author says, without a buffer a slow client may slow down everybody</z><z id="t1543856553" t="pithyless [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] - this is where ztellman talks about buffering and throttling chats: https://www.youtube.com/watch?v=1bNOO3xxMc0&amp;amp;t=1887"><y>#</y><d>2018-12-03</d><h>17:02</h><w>pithyless</w><a>@igrishaev</a> - this is where ztellman talks about buffering and throttling chats: <a href="https://www.youtube.com/watch?v=1bNOO3xxMc0&amp;amp;t=1887" target="_blank">https://www.youtube.com/watch?v=1bNOO3xxMc0&amp;amp;t=1887</a></z><z id="t1544018372" t="valerauko could anyone recommend me a library for retrying (with exponential backoff) using deferred?"><y>#</y><d>2018-12-05</d><h>13:59</h><w>valerauko</w>could anyone recommend me a library for retrying (with exponential backoff) using deferred?</z><z id="t1544021148" t="hugo Zach addressed this sort of in this reddit post: https://www.reddit.com/r/Clojure/comments/48lf1a/managing_websocket_stability_issues_with_aleph/ Fairly easy to extend his example with exponential backoff: (defn reconnect-loop! [conn-generator] (let [loop! (fn this [timeout] (d/chain (conn-generator) (fn [conn] (if conn (s/on-closed conn this) (do @(d/future (Thread/sleep (t/seconds timeout))) (this (* timeout 2)))))))] (loop! 1))) "><y>#</y><d>2018-12-05</d><h>14:45</h><w>hugo</w>Zach addressed this sort of in this reddit post: <a href="https://www.reddit.com/r/Clojure/comments/48lf1a/managing_websocket_stability_issues_with_aleph/" target="_blank">https://www.reddit.com/r/Clojure/comments/48lf1a/managing_websocket_stability_issues_with_aleph/</a>
Fairly easy to extend his example with exponential backoff:
<pre>(defn reconnect-loop!
  [conn-generator]
  (let [loop! (fn this [timeout]
                (d/chain
                 (conn-generator)
                 (fn [conn]
                   (if conn
                     (s/on-closed conn this)
                     (do @(d/future (Thread/sleep (t/seconds timeout)))
                         (this (* timeout 2)))))))]
  (loop! 1)))
</pre></z><z id="t1544021336" t="valerauko awesome! just what i was looking for!"><y>#</y><d>2018-12-05</d><h>14:48</h><w>valerauko</w>awesome! just what i was looking for!</z><z id="t1544021338" t="valerauko thanks a lot!"><y>#</y><d>2018-12-05</d><h>14:48</h><w>valerauko</w>thanks a lot!</z><z id="t1544021351" t="hugo No worries üôÇ"><y>#</y><d>2018-12-05</d><h>14:49</h><w>hugo</w>No worries <b>üôÇ</b></z><z id="t1544192526" t="igrishaev What would be the best way to connect two streams in both directions? To implement a proxy for example."><y>#</y><d>2018-12-07</d><h>14:22</h><w>igrishaev</w>What would be the best way to connect two streams in both directions? To implement a proxy for example.</z><z id="t1544192614" t="igrishaev (s/connect s1 s2) works fine for one direction. But (s/connect s2 s1) leads to strange behavior."><y>#</y><d>2018-12-07</d><h>14:23</h><w>igrishaev</w><code>(s/connect s1 s2)</code> works fine for one direction. But <code>(s/connect s2 s1)</code> leads to strange behavior.</z><z id="t1544194023" t="igrishaev Also, can anybody explain this code: Why there is no circular loop? https://user-images.githubusercontent.com/1059232/49654111-fda6f700-fa47-11e8-9cac-ca6fbfb49b82.png"><y>#</y><d>2018-12-07</d><h>14:47</h><w>igrishaev</w>Also, can anybody explain this code: Why there is no circular loop? <a href="https://user-images.githubusercontent.com/1059232/49654111-fda6f700-fa47-11e8-9cac-ca6fbfb49b82.png" target="_blank">https://user-images.githubusercontent.com/1059232/49654111-fda6f700-fa47-11e8-9cac-ca6fbfb49b82.png</a></z><z id="t1544450147" t="kachayev Not sure I got your question correctly, but s/consume is essentially a loop"><y>#</y><d>2018-12-10</d><h>13:55</h><r>kachayev</r>Not sure I got your question correctly, but <code>s/consume</code> is essentially a loop</z><z id="t1544199534" t="valerauko does aleph retry (and if so how many times / how long) if it can&apos;t bind the designated port on server start?"><y>#</y><d>2018-12-07</d><h>16:18</h><w>valerauko</w>does aleph retry (and if so how many times / how long) if it can&apos;t bind the designated port on server start?</z><z id="t1544450758" t="kachayev AFAIK, it does not. aleph relies on netty ‚Äôs implementation of .bind , and netty calls java.net.Socket bind which throws IOException if the socket is already bound."><y>#</y><d>2018-12-10</d><h>14:05</h><r>kachayev</r>AFAIK, it does not. <code>aleph</code> relies on <code>netty</code>‚Äôs implementation of <code>.bind</code>, and <code>netty</code> calls <code>java.net.Socket</code> bind which throws <code>IOException</code> if the socket is already bound.</z><z id="t1544450793" t="kachayev https://github.com/ztellman/aleph/blob/ef331d14fabb629f94bc46b96af92b0e7d9ec37f/src/aleph/netty.clj#L964"><y>#</y><d>2018-12-10</d><h>14:06</h><r>kachayev</r><a href="https://github.com/ztellman/aleph/blob/ef331d14fabb629f94bc46b96af92b0e7d9ec37f/src/aleph/netty.clj#L964" target="_blank">https://github.com/ztellman/aleph/blob/ef331d14fabb629f94bc46b96af92b0e7d9ec37f/src/aleph/netty.clj#L964</a></z><z id="t1544200019" t="valerauko another: what&apos;s the simplest way to enable TLS1.3 in aleph http client?"><y>#</y><d>2018-12-07</d><h>16:26</h><w>valerauko</w>another: what&apos;s the simplest way to enable TLS1.3 in aleph http client?</z><z id="t1544264239" t="valerauko hmm maybe it&apos;s not tls1.3 but the 4096 bit cert"><y>#</y><d>2018-12-08</d><h>10:17</h><w>valerauko</w>hmm maybe it&apos;s not tls1.3 but the 4096 bit cert</z><z id="t1544266020" t="valerauko =&gt; @(http/get &quot;&quot;) Exception ExceptionInfo connection was closed after 0.336 seconds ... io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure meanwhile =&gt; (let [url (java.net.URL. &quot;&quot;) conn (.openConnection url)] (if (= (.getResponseCode conn) 200) (byte-streams/to-string (.getInputStream conn)))) &quot;&lt;!DOCTYPE html&gt;\n&lt;html lang=&apos;en&apos;&gt;\n&lt;he ...&quot; "><y>#</y><d>2018-12-08</d><h>10:47</h><w>valerauko</w><pre>=&gt; @(http/get &quot;&quot;)
Exception ExceptionInfo connection was closed after 0.336 seconds
...
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure
</pre>
meanwhile
<pre>=&gt; (let [url (java.net.URL. &quot;&quot;)
      conn (.openConnection url)]
  (if (= (.getResponseCode conn) 200)
    (byte-streams/to-string (.getInputStream conn))))
&quot;&lt;!DOCTYPE html&gt;\n&lt;html lang=&apos;en&apos;&gt;\n&lt;he ...&quot;
</pre></z><z id="t1544452254" t="rborer Does anyone know if Zach has any sort of release schedule / plan for his libraries? There seems to be quite a few improvements pending in dirigiste, manifold &amp; aleph that are probably worth cutting out new releases üôÇ"><y>#</y><d>2018-12-10</d><h>14:30</h><w>rborer</w>Does anyone know if Zach has any sort of release schedule / plan for his libraries? There seems to be quite a few improvements pending in dirigiste, manifold &amp; aleph that are probably worth cutting out new releases <b>üôÇ</b></z><z id="t1544462219" t="kachayev I think that only [:attrs {:href &quot;/_/_/users/U066UJ2KE&quot;}] has answer on this question. And as far as he‚Äôs not an active user of this Slack‚Ä¶ it‚Äôs better to ask on Twitter."><y>#</y><d>2018-12-10</d><h>17:16</h><w>kachayev</w>I think that only <a>@ztellman</a> has answer on this question. And as far as he‚Äôs not an active user of this Slack‚Ä¶ it‚Äôs better to ask on Twitter.</z><z id="t1544463998" t="aengelberg he&apos;s pretty responsive to email if you have a pressing issue or need him to cut a release. I don&apos;t think he has any set schedule otherwise."><y>#</y><d>2018-12-10</d><h>17:46</h><w>aengelberg</w>he&apos;s pretty responsive to email if you have a pressing issue or need him to cut a release. I don&apos;t think he has any set schedule otherwise.</z><z id="t1544517930" t="rborer right, I&apos;ll send an email to aleph google groups so his answer is saved for posterity (on Slack the information will disappear after a few days, and on Twitter, well, it&apos;s not the most easily searchable üòâ )"><y>#</y><d>2018-12-11</d><h>08:45</h><w>rborer</w>right, I&apos;ll send an email to aleph google groups so his answer is saved for posterity (on Slack the information will disappear after a few days, and on Twitter, well, it&apos;s not the most easily searchable <b>üòâ</b> )</z><z id="t1544542349" t="valerauko is there a representation of aleph that implements CloseableHttpClient?"><y>#</y><d>2018-12-11</d><h>15:32</h><w>valerauko</w>is there a representation of aleph that implements CloseableHttpClient?</z><z id="t1544542365" t="valerauko i&apos;d need to pass an object like that to another java lib"><y>#</y><d>2018-12-11</d><h>15:32</h><w>valerauko</w>i&apos;d need to pass an object like that to another java lib</z><z id="t1544560694" t="kachayev [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Do you mean aleph http client? server object implements Closeable , but for the client it‚Äôs a bit different‚Ä¶ there‚Äôs actually no such thing as ‚Äúclient‚Äù. you have a connection pool (created by you or default one) which is represented as flow/instrumented-pool . you can probably try to extract a list of open connections to close them when necessary"><y>#</y><d>2018-12-11</d><h>20:38</h><w>kachayev</w><a>@vale</a> Do you mean aleph http client? server object implements <code>Closeable</code>, but for the client it‚Äôs a bit different‚Ä¶ there‚Äôs actually no such thing as ‚Äúclient‚Äù. you have a connection pool (created by you or default one) which is represented as <code>flow/instrumented-pool</code>. you can probably try to extract a list of open connections to close them when necessary</z><z id="t1544849890" t="valerauko i&apos;m not sure if i actually need to close them either... there&apos;s a library that uses the apache commons http client internally, but if possible i&apos;d prefer not to have another http dependency if i can just use aleph already."><y>#</y><d>2018-12-15</d><h>04:58</h><r>valerauko</r>i&apos;m not sure if i actually need to close them either... there&apos;s a library that uses the apache commons http client internally, but if possible i&apos;d prefer not to have another http dependency if i can just use aleph already.</z><z id="t1544849924" t="valerauko https://github.com/jsonld-java/jsonld-java#customizing-the-apache-httpclient"><y>#</y><d>2018-12-15</d><h>04:58</h><r>valerauko</r><a href="https://github.com/jsonld-java/jsonld-java#customizing-the-apache-httpclient" target="_blank">https://github.com/jsonld-java/jsonld-java#customizing-the-apache-httpclient</a></z><z id="t1544878635" t="kachayev Oh‚Ä¶"><y>#</y><d>2018-12-15</d><h>12:57</h><r>kachayev</r>Oh‚Ä¶</z><z id="t1544878768" t="kachayev In that case you need not simply Closable , you need an instance of https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/impl/client/CloseableHttpClient.html (or an instance of subclass). You can use reify to define execute methods, but as far as I understand‚Ä¶ all of those methods are supposed to be blocking, right?"><y>#</y><d>2018-12-15</d><h>12:59</h><r>kachayev</r>In that case you need not simply <code>Closable</code>, you need an instance of <a href="https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/impl/client/CloseableHttpClient.html" target="_blank">https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/impl/client/CloseableHttpClient.html</a> (or an instance of subclass). You can use <code>reify</code> to define <code>execute</code> methods, but as far as I understand‚Ä¶ all of those methods are supposed to be blocking, right?</z><z id="t1544948171" t="valerauko possibly so"><y>#</y><d>2018-12-16</d><h>08:16</h><r>valerauko</r>possibly so</z><z id="t1544991530" t="kachayev In that case you probably won‚Äôt see any advantages of using Aleph"><y>#</y><d>2018-12-16</d><h>20:18</h><r>kachayev</r>In that case you probably won‚Äôt see any advantages of using Aleph</z><z id="t1544664482" t="gsnewmark https://twitter.com/ztellman/status/1073009060323049473?s=19"><y>#</y><d>2018-12-13</d><h>01:28</h><w>gsnewmark</w><a href="https://twitter.com/ztellman/status/1073009060323049473?s=19" target="_blank">https://twitter.com/ztellman/status/1073009060323049473?s=19</a></z><z id="t1544809938" t="kardan In my new side project I experienced shutdown issues in Aleph and moved to Jetty even if I wanted to use Aleph. Updated to the latest Aleph 0.4.7-alpha4 and don‚Äôt see any issues. Thanks for all the work on Aleph and Manifold!"><y>#</y><d>2018-12-14</d><h>17:52</h><w>kardan</w>In my new side project I experienced shutdown issues in Aleph and moved to Jetty even if I wanted to use Aleph. Updated to the latest Aleph 0.4.7-alpha4 and don‚Äôt see any issues. Thanks for all the work on Aleph and Manifold!</z><z id="t1544986168" t="ztellman if you&apos;re using Aleph in production, we&apos;d like to hear about it: https://github.com/ztellman/aleph/issues/450"><y>#</y><d>2018-12-16</d><h>18:49</h><w>ztellman</w>if you&apos;re using Aleph in production, we&apos;d like to hear about it: <a href="https://github.com/ztellman/aleph/issues/450" target="_blank">https://github.com/ztellman/aleph/issues/450</a></z><z id="t1545583944" t="lxsameer hey folks, How can I catch any exception in the sink callback of a stream when I put something in the stream ?"><y>#</y><d>2018-12-23</d><h>16:52</h><w>lxsameer</w>hey folks, How can I catch any exception in the sink callback of a stream when I put something in the stream ?</z><z id="t1545650835" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] where&apos;s the exception happening ? when you put! or elsewhere ?"><y>#</y><d>2018-12-24</d><h>11:27</h><w>mccraigmccraig</w><a>@lxsameer</a> where&apos;s the exception happening ? when you <code>put!</code> or elsewhere ?</z><z id="t1545650925" t="lxsameer it‚Äôs an exception in my code, but the thing is that code might be written by user ( I‚Äôm writing a lib ) and I don‚Äôt want an exception just blow away everything. I want to be able to catch it and log it"><y>#</y><d>2018-12-24</d><h>11:28</h><w>lxsameer</w>it‚Äôs an exception in my code, but the thing is that code might be written by user ( I‚Äôm writing a lib )  and I don‚Äôt want an exception just blow away everything. I want to be able to catch it and log it</z><z id="t1545662436" t="lxsameer [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] any idea ?"><y>#</y><d>2018-12-24</d><h>14:40</h><w>lxsameer</w><a>@mccraigmccraig</a> any idea ?</z><z id="t1545668964" t="mccraigmccraig we generally catch exceptions happening during map s on streams and keep them in a value implementing a marker protocol, then deal with them at reduce time - either log a couple of error exemplars or re-throw "><y>#</y><d>2018-12-24</d><h>16:29</h><w>mccraigmccraig</w>we generally catch exceptions happening during <code>map</code>s on streams and keep them in a value implementing a marker protocol, then deal with them at <code>reduce</code> time - either log a couple of error exemplars or re-throw </z><z id="t1545669555" t="lxsameer [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] hmmm seems like a good idea, do you have any code snippet to share please?"><y>#</y><d>2018-12-24</d><h>16:39</h><w>lxsameer</w><a>@mccraigmccraig</a> hmmm seems like a good idea, do you have any code snippet to share please?</z><z id="t1545669680" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] sure - give me a few days though, I&apos;m staying away from my computer til then"><y>#</y><d>2018-12-24</d><h>16:41</h><w>mccraigmccraig</w><a>@lxsameer</a> sure - give me a few days though,  I&apos;m staying away from my computer til then</z><z id="t1545669760" t="lxsameer sure, bad timing. Have a good Christmas"><y>#</y><d>2018-12-24</d><h>16:42</h><w>lxsameer</w>sure, bad timing. Have a good Christmas</z><z id="t1545670355" t="mccraigmccraig no worries - ping me in a few days - happy Xmas [:attrs {:href &quot;/_/_/users/U28TJ0DDZ&quot;}] "><y>#</y><d>2018-12-24</d><h>16:52</h><w>mccraigmccraig</w>no worries - ping me in a few days - happy Xmas <a>@lxsameer</a> </z><z id="t1545926725" t="lxsameer hey folks, is there any way to create an stream which doesn‚Äôt get closed when an unhandled exception happen ?"><y>#</y><d>2018-12-27</d><h>16:05</h><w>lxsameer</w>hey folks, is there any way to create an stream which doesn‚Äôt get closed when an unhandled exception happen ?</z><z id="t1545927107" t="kachayev do you mean in this case? https://clojurians.slack.com/archives/C0G922PCH/p1545583944000800 when something happens in user‚Äôs code that executes on s/take! ?"><y>#</y><d>2018-12-27</d><h>16:11</h><r>kachayev</r>do you mean in this case? <a href="https://clojurians.slack.com/archives/C0G922PCH/p1545583944000800" target="_blank">https://clojurians.slack.com/archives/C0G922PCH/p1545583944000800</a> when something happens in user‚Äôs code that executes on <code>s/take!</code>?</z><z id="t1545927309" t="lxsameer yeah it‚Äôs related"><y>#</y><d>2018-12-27</d><h>16:15</h><r>lxsameer</r>yeah it‚Äôs related</z><z id="t1545927785" t="lxsameer [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] any idea my friend ?"><y>#</y><d>2018-12-27</d><h>16:23</h><r>lxsameer</r><a>@U052BJL37</a> any idea my friend ?</z><z id="t1545929604" t="kachayev I assume we‚Äôre talking about non-blocking case, when s/take! returns deferred, right?"><y>#</y><d>2018-12-27</d><h>16:53</h><r>kachayev</r>I assume we‚Äôre talking about non-blocking case, when <code>s/take!</code> returns deferred, right?</z><z id="t1545929651" t="lxsameer yes"><y>#</y><d>2018-12-27</d><h>16:54</h><r>lxsameer</r>yes</z><z id="t1545947441" t="kachayev I‚Äôm not sure I do understand the question correctly‚Ä¶ when I have an exception raised somewhere in the chain of callbacks attached to the deferred returned by take! ‚Ä¶ nothing closes the stream"><y>#</y><d>2018-12-27</d><h>21:50</h><r>kachayev</r>I‚Äôm not sure I do understand the question correctly‚Ä¶ when I have an exception raised somewhere in the chain of callbacks attached to the deferred returned by <code>take!</code>‚Ä¶ nothing closes the stream</z><z id="t1545947458" t="kachayev"><y>#</y><d>2018-12-27</d><h>21:50</h><r>kachayev</r></z><z id="t1547209567" t="kwladyka ((:close foo)) Jan 11, 2019 1:16:20 PM io.netty.util.concurrent.DefaultPromise notifyListener0 WARNING: An exception was thrown by aleph.netty$wrap_future$reify__16507.operationComplete() java.lang.ExceptionInInitializerError at manifold.deferred.Deferred.success(deferred.clj:398) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243) at manifold.deferred$success_BANG_.invoke(deferred.clj:240) at aleph.netty$wrap_future$reify__16507.operationComplete(netty.clj:199) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424) at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94) at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33) at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435) at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Thread.java:834) Caused by: java.lang.ClassNotFoundException: clojure/lang/PersistentArrayMap at java.base/java.lang.Class.forName0(Native Method) at java.base/java.lang.Class.forName(Class.java:398) at clojure.lang.RT.classForName(RT.java:2207) at clojure.lang.RT.classForName(RT.java:2216) at clojure.lang.Reflector.invokeStaticMethod(Reflector.java:324) at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1322) at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.read(LispReader.java:220) at clojure.lang.LispReader.access$200(LispReader.java:41) at clojure.lang.LispReader$MetaReader.invoke(LispReader.java:954) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.readDelimitedList(LispReader.java:1398) at clojure.lang.LispReader$ListReader.invoke(LispReader.java:1243) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.read(LispReader.java:220) at clojure.lang.LispReader.access$200(LispReader.java:41) at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1301) at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.read(LispReader.java:216) at clojure.lang.LispReader.read(LispReader.java:205) at clojure.lang.RT.readString(RT.java:1874) at clojure.lang.RT.readString(RT.java:1869) at manifold.deferred.Deferred$fn__3629.&lt;clinit&gt;(deferred.clj:398) ... 16 more Any way to fix it?"><y>#</y><d>2019-01-11</d><h>12:26</h><w>kwladyka</w><code>((:close foo))</code>

<pre>Jan 11, 2019 1:16:20 PM io.netty.util.concurrent.DefaultPromise notifyListener0
WARNING: An exception was thrown by aleph.netty$wrap_future$reify__16507.operationComplete()
java.lang.ExceptionInInitializerError
	at manifold.deferred.Deferred.success(deferred.clj:398)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:240)
	at aleph.netty$wrap_future$reify__16507.operationComplete(netty.clj:199)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424)
	at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33)
	at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435)
	at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:834)
Caused by: java.lang.ClassNotFoundException: clojure/lang/PersistentArrayMap
	at java.base/java.lang.Class.forName0(Native Method)
	at java.base/java.lang.Class.forName(Class.java:398)
	at clojure.lang.RT.classForName(RT.java:2207)
	at clojure.lang.RT.classForName(RT.java:2216)
	at clojure.lang.Reflector.invokeStaticMethod(Reflector.java:324)
	at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1322)
	at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.read(LispReader.java:220)
	at clojure.lang.LispReader.access$200(LispReader.java:41)
	at clojure.lang.LispReader$MetaReader.invoke(LispReader.java:954)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.readDelimitedList(LispReader.java:1398)
	at clojure.lang.LispReader$ListReader.invoke(LispReader.java:1243)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.read(LispReader.java:220)
	at clojure.lang.LispReader.access$200(LispReader.java:41)
	at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1301)
	at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.read(LispReader.java:216)
	at clojure.lang.LispReader.read(LispReader.java:205)
	at clojure.lang.RT.readString(RT.java:1874)
	at clojure.lang.RT.readString(RT.java:1869)
	at manifold.deferred.Deferred$fn__3629.&lt;clinit&gt;(deferred.clj:398)
	... 16 more
</pre>

Any way to fix it?</z><z id="t1547209599" t="kwladyka {org.clojure/clojure {:mvn/version &quot;1.10.0&quot;} yada {:mvn/version &quot;1.2.16&quot;} aleph {:mvn/version &quot;0.4.6&quot;} bidi {:mvn/version &quot;2.1.5&quot;} integrant {:mvn/version &quot;0.7.0&quot;}} "><y>#</y><d>2019-01-11</d><h>12:26</h><w>kwladyka</w><pre>{org.clojure/clojure {:mvn/version &quot;1.10.0&quot;}
        yada {:mvn/version &quot;1.2.16&quot;}
        aleph {:mvn/version &quot;0.4.6&quot;}
        bidi {:mvn/version &quot;2.1.5&quot;}
        integrant {:mvn/version &quot;0.7.0&quot;}}
</pre></z><z id="t1547209646" t="kwladyka java --version 4.5m ÓÇ≥ Thu Dec 27 21:59:03 2018 java 11.0.1 2018-10-16 LTS "><y>#</y><d>2019-01-11</d><h>12:27</h><w>kwladyka</w><pre>java --version                                                                                  4.5m ÓÇ≥ Thu Dec 27 21:59:03 2018
java 11.0.1 2018-10-16 LTS
</pre></z><z id="t1547209662" t="jeroenvandijk I wanted to ask what is in foo , but i see there is a Caused by: java.lang.ClassNotFoundException: clojure/lang/PersistentArrayMap Not sure what to do about this"><y>#</y><d>2019-01-11</d><h>12:27</h><w>jeroenvandijk</w>I wanted to ask what is in <code>foo</code>, but i see there is a <code>Caused by: java.lang.ClassNotFoundException: clojure/lang/PersistentArrayMap</code> Not sure what to do about this</z><z id="t1547209692" t="kwladyka foo is (yada/listener handler aleph-options) which return fn to close server"><y>#</y><d>2019-01-11</d><h>12:28</h><w>kwladyka</w><code>foo</code> is <code>(yada/listener handler aleph-options)</code> which return <code>fn</code> to close server</z><z id="t1547209714" t="kwladyka https://juxt.pro/yada/manual/index.html#serving-resources"><y>#</y><d>2019-01-11</d><h>12:28</h><w>kwladyka</w><a href="https://juxt.pro/yada/manual/index.html#serving-resources" target="_blank">https://juxt.pro/yada/manual/index.html#serving-resources</a></z><z id="t1547209718" t="jeroenvandijk Ah I see. I don&apos;t know sorry"><y>#</y><d>2019-01-11</d><h>12:28</h><w>jeroenvandijk</w>Ah I see. I don&apos;t know sorry</z><z id="t1547209753" t="kwladyka But as I understand it is aleph bug and this fn is what aleph return to close the server"><y>#</y><d>2019-01-11</d><h>12:29</h><w>kwladyka</w>But as I understand it is aleph bug and this fn is what aleph return to close the server</z><z id="t1547209770" t="kwladyka no problem, thank you for trying"><y>#</y><d>2019-01-11</d><h>12:29</h><w>kwladyka</w>no problem, thank you for trying</z><z id="t1547209781" t="kwladyka it could be something about java version maybe"><y>#</y><d>2019-01-11</d><h>12:29</h><w>kwladyka</w>it could be something about java version maybe</z><z id="t1547209820" t="jeroenvandijk You could try to start a normal aleph server and close it to see if that works? For us this works (on different clojure and java) version. But if that does work it might be yada related?"><y>#</y><d>2019-01-11</d><h>12:30</h><w>jeroenvandijk</w>You could try to start a normal aleph server and close it to see if that works? For us this works (on different clojure and java) version. But if that does work it might be yada related?</z><z id="t1547209854" t="kwladyka hmm I have to figure out how to start / close aleph without yada üòâ"><y>#</y><d>2019-01-11</d><h>12:30</h><w>kwladyka</w>hmm I have to figure out how to start / close aleph without yada <b>üòâ</b></z><z id="t1547209884" t="kwladyka give me a sec"><y>#</y><d>2019-01-11</d><h>12:31</h><w>kwladyka</w>give me a sec</z><z id="t1547209887" t="jeroenvandijk From the readme (require &apos;[aleph.http :as http]) (defn handler [req] {:status 200 :headers {&quot;content-type&quot; &quot;text/plain&quot;} :body &quot;hello!&quot;}) (http/start-server handler {:port 8080})"><y>#</y><d>2019-01-11</d><h>12:31</h><w>jeroenvandijk</w>From the readme <pre>(require &apos;[aleph.http :as http])

(defn handler [req]
  {:status 200
   :headers {&quot;content-type&quot; &quot;text/plain&quot;}
   :body &quot;hello!&quot;})

(http/start-server handler {:port 8080})</pre></z><z id="t1547209898" t="jeroenvandijk I think the start-server returns that close fn"><y>#</y><d>2019-01-11</d><h>12:31</h><w>jeroenvandijk</w>I think the start-server returns that close fn</z><z id="t1547209950" t="jeroenvandijk Oh actually not true"><y>#</y><d>2019-01-11</d><h>12:32</h><w>jeroenvandijk</w>Oh actually not true</z><z id="t1547209963" t="jeroenvandijk We stop it like this :stop [server-instance (do (log/info &quot;stopping Server on port&quot; port) (.close server-instance) But older version maybe"><y>#</y><d>2019-01-11</d><h>12:32</h><w>jeroenvandijk</w>We stop it like this <pre>:stop [server-instance (do (log/info &quot;stopping Server on port&quot; port)
                                (.close server-instance)</pre> But older version maybe</z><z id="t1547210014" t="kwladyka (defn handler [req] {:status 200 :headers {&quot;content-type&quot; &quot;text/plain&quot;} :body &quot;hello!&quot;}) (def foo (http/start-server handler {:port 8080})) (.close foo) Jan 11, 2019 1:33:05 PM io.netty.util.concurrent.DefaultPromise notifyListener0 WARNING: An exception was thrown by aleph.netty$wrap_future$reify__16507.operationComplete() java.lang.NoClassDefFoundError: Could not initialize class manifold.deferred.Deferred$fn__3629 at manifold.deferred.Deferred.success(deferred.clj:398) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243) at manifold.deferred$success_BANG_.invoke(deferred.clj:240) at aleph.netty$wrap_future$reify__16507.operationComplete(netty.clj:199) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424) at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94) at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33) at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435) at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Thread.java:834) "><y>#</y><d>2019-01-11</d><h>12:33</h><w>kwladyka</w><pre>(defn handler [req]
  {:status 200
   :headers {&quot;content-type&quot; &quot;text/plain&quot;}
   :body &quot;hello!&quot;})

(def foo (http/start-server handler {:port 8080}))

(.close foo)
</pre>

<pre>Jan 11, 2019 1:33:05 PM io.netty.util.concurrent.DefaultPromise notifyListener0
WARNING: An exception was thrown by aleph.netty$wrap_future$reify__16507.operationComplete()
java.lang.NoClassDefFoundError: Could not initialize class manifold.deferred.Deferred$fn__3629
	at manifold.deferred.Deferred.success(deferred.clj:398)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:240)
	at aleph.netty$wrap_future$reify__16507.operationComplete(netty.clj:199)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424)
	at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33)
	at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435)
	at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:834)
</pre></z><z id="t1547210209" t="kwladyka https://github.com/ztellman/aleph/issues/365 it is probably this issue"><y>#</y><d>2019-01-11</d><h>12:36</h><w>kwladyka</w><a href="https://github.com/ztellman/aleph/issues/365" target="_blank">https://github.com/ztellman/aleph/issues/365</a> it is probably this issue</z><z id="t1547210233" t="kwladyka But not sure why I have this issue and you not üôÇ"><y>#</y><d>2019-01-11</d><h>12:37</h><w>kwladyka</w>But not sure why I have this issue and you not <b>üôÇ</b></z><z id="t1547210243" t="kwladyka Can you paste your versions?"><y>#</y><d>2019-01-11</d><h>12:37</h><w>kwladyka</w>Can you paste your versions?</z><z id="t1547210474" t="kwladyka Do you use Java 11?"><y>#</y><d>2019-01-11</d><h>12:41</h><w>kwladyka</w>Do you use Java 11?</z><z id="t1547211423" t="kwladyka [:attrs {:href &quot;/_/_/users/UAFT1B7Q8&quot;}] Did you have this issue ? ^"><y>#</y><d>2019-01-11</d><h>12:57</h><w>kwladyka</w><a>@whoneedszzz</a> Did you have this issue ? ^</z><z id="t1547212531" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U0WL6FA77&quot;}] No for the app it works we are using java 8"><y>#</y><d>2019-01-11</d><h>13:15</h><w>jeroenvandijk</w><a>@kwladyka</a> No for the app it works we are using java 8</z><z id="t1547212556" t="jeroenvandijk and an older clojure version 1.8"><y>#</y><d>2019-01-11</d><h>13:15</h><w>jeroenvandijk</w>and an older clojure version 1.8</z><z id="t1547212861" t="kachayev The root cause of the issue was described here: https://github.com/ztellman/aleph/pull/425 The fix is not merged yet, updates to manifold thread factories are (but that‚Äôs just a part of the puzzle) "><y>#</y><d>2019-01-11</d><h>13:21</h><w>kachayev</w>The root cause of the issue was described here: <a href="https://github.com/ztellman/aleph/pull/425" target="_blank">https://github.com/ztellman/aleph/pull/425</a> The fix is not merged yet, updates to manifold thread factories are (but that‚Äôs just a part of the puzzle) </z><z id="t1547212896" t="kwladyka But the point is how can I live with it today? üòâ"><y>#</y><d>2019-01-11</d><h>13:21</h><w>kwladyka</w>But the point is how can I live with it today? <b>üòâ</b></z><z id="t1547212904" t="kwladyka any workaround?"><y>#</y><d>2019-01-11</d><h>13:21</h><w>kwladyka</w>any workaround?</z><z id="t1547213036" t="kwladyka Just It will be great to be able to reload server when developing"><y>#</y><d>2019-01-11</d><h>13:23</h><w>kwladyka</w>Just It will be great to be able to reload server when developing</z><z id="t1547213048" t="kwladyka Instead kill REPL / start REPL"><y>#</y><d>2019-01-11</d><h>13:24</h><w>kwladyka</w>Instead kill REPL / start REPL</z><z id="t1547213195" t="kwladyka branch kachayev:ft-gracefull-shutdown has this bug fixed?"><y>#</y><d>2019-01-11</d><h>13:26</h><w>kwladyka</w>branch <code>kachayev:ft-gracefull-shutdown</code> has this bug fixed?</z><z id="t1547214619" t="kachayev Not sure about that, I moved the fix to a separate branch on purpose (to make it easier to merge to master). Need to check if it‚Äôs still included there. In fact, you can ignore those error messages :) That‚Äôs annoying, but it does no harm to the functionality itself: it just fails to deliver notification that the operation is already completed (which means that‚Äôs the server is closed) "><y>#</y><d>2019-01-11</d><h>13:50</h><w>kachayev</w>Not sure about that, I moved the fix to a separate branch on purpose (to make it easier to merge to master). Need to check if it‚Äôs still included there. In fact, you can ignore those error messages :) That‚Äôs annoying, but it does no harm to the functionality itself: it just fails to deliver notification that the operation is already completed (which means that‚Äôs the server is closed) </z><z id="t1547214806" t="kwladyka hmm super strange thing happen. I made a break to eat dinner and now I don‚Äôt have this error"><y>#</y><d>2019-01-11</d><h>13:53</h><w>kwladyka</w>hmm super strange thing happen. I made a break to eat dinner and now I don‚Äôt have this error</z><z id="t1547214896" t="kwladyka thanks for info it doesn‚Äôt affect closing the server. I didn‚Äôt realise that."><y>#</y><d>2019-01-11</d><h>13:54</h><w>kwladyka</w>thanks for info it doesn‚Äôt affect closing the server. I didn‚Äôt realise that.</z><z id="t1547214936" t="kwladyka now I have it again wow. I changed nothing"><y>#</y><d>2019-01-11</d><h>13:55</h><w>kwladyka</w>now I have it again wow. I changed nothing</z><z id="t1547215315" t="kwladyka ha I found something! I will describe it in issue in +1h"><y>#</y><d>2019-01-11</d><h>14:01</h><w>kwladyka</w>ha I found something! I will describe it in issue in +1h</z><z id="t1547237210" t="WhoNeedszZz [:attrs {:href &quot;/_/_/users/U0WL6FA77&quot;}] There&apos;s nothing wrong with the method that the yada manual describes. I&apos;m using it right now"><y>#</y><d>2019-01-11</d><h>20:06</h><w>WhoNeedszZz</w><a>@kwladyka</a> There&apos;s nothing wrong with the method that the yada manual describes. I&apos;m using it right now</z><z id="t1547243640" t="kwladyka [:attrs {:href &quot;/_/_/users/UAFT1B7Q8&quot;}] i have this issue https://github.com/ztellman/aleph/pull/425 also when use yada directly as in the doc. But this issue appear only when you didn‚Äôt open website even once."><y>#</y><d>2019-01-11</d><h>21:54</h><w>kwladyka</w><a>@whoneedszzz</a> i have this issue <a href="https://github.com/ztellman/aleph/pull/425" target="_blank">https://github.com/ztellman/aleph/pull/425</a> also when use yada directly as in the doc. But this issue appear only when you didn‚Äôt open website even once.</z><z id="t1547738660" t="oyakushev Could anyone who understands Netty answer this question? https://github.com/ztellman/aleph/issues/463"><y>#</y><d>2019-01-17</d><h>15:24</h><w>oyakushev</w>Could anyone who understands Netty answer this question? <a href="https://github.com/ztellman/aleph/issues/463" target="_blank">https://github.com/ztellman/aleph/issues/463</a></z><z id="t1547756709" t="jonas [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] what tool are you using for flamegraphs on the jvm?"><y>#</y><d>2019-01-17</d><h>20:25</h><w>jonas</w><a>@alexyakushev</a> what tool are you using for flamegraphs on the jvm?</z><z id="t1547758305" t="lmergen ^ asking the important questions! I‚Äôm also curious :)"><y>#</y><d>2019-01-17</d><h>20:51</h><w>lmergen</w>^ asking the important questions! I‚Äôm also curious :)</z><z id="t1547798440" t="oyakushev [:attrs {:href &quot;/_/_/users/U051BB909&quot;}] [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] https://github.com/clojure-goes-fast/clj-async-profiler üôÇ New coloring is still in the SNAPSHOT, but everything else works"><y>#</y><d>2019-01-18</d><h>08:00</h><w>oyakushev</w><a>@jonas</a> <a>@lmergen</a> <a href="https://github.com/clojure-goes-fast/clj-async-profiler" target="_blank">https://github.com/clojure-goes-fast/clj-async-profiler</a> <b>üôÇ</b> New coloring is still in the SNAPSHOT, but everything else works</z><z id="t1548263831" t="igrishaev Is that possible to interact with UNIX domain sockets in Aleph? For example, to query the docker daemon as follows: curl --unix-socket /var/run/docker.sock http:/v1.24/images/json It seems Netty has got the required functionality (channel.unix.DomainSocketAddress) but I‚Äôm not sure if Aleph implements it."><y>#</y><d>2019-01-23</d><h>17:17</h><w>igrishaev</w>Is that possible to interact with UNIX domain sockets in Aleph? For example, to query the docker daemon as follows:
<pre>curl --unix-socket /var/run/docker.sock http:/v1.24/images/json
</pre>
It seems Netty has got the required functionality (channel.unix.DomainSocketAddress) but I‚Äôm not sure if Aleph implements it.</z><z id="t1548445622" t="borkdude what‚Äôs the manifold.deferred equivalent of future-cancel?"><y>#</y><d>2019-01-25</d><h>19:47</h><w>borkdude</w>what‚Äôs the manifold.deferred equivalent of future-cancel?</z><z id="t1548445799" t="borkdude I‚Äôd really like to cancel the future that‚Äôs associated with the deferred"><y>#</y><d>2019-01-25</d><h>19:49</h><w>borkdude</w>I‚Äôd really like to cancel the future that‚Äôs associated with the deferred</z><z id="t1548604465" t="kachayev I think the idiomatic way to cancel something in Manifold is to resolve appropriate deferred with an error (this would short-circuit all chained callbacks). If you also want to cancel some long running computation: give it deferred to put the result into and make it check periodically if deferred is still in not-realized state (see latest update for d/loop for example)"><y>#</y><d>2019-01-27</d><h>15:54</h><r>kachayev</r>I think the idiomatic way to cancel something in Manifold is to resolve appropriate deferred with an error (this would short-circuit all chained callbacks). If you also want to cancel some long running computation: give it deferred to put the result into and make it check periodically if deferred is still in not-realized state (see latest update for <code>d/loop</code> for example)</z><z id="t1548605240" t="borkdude latest update where?"><y>#</y><d>2019-01-27</d><h>16:07</h><r>borkdude</r>latest update where?</z><z id="t1548605314" t="kachayev https://github.com/ztellman/manifold/issues/166 (I thought that was a PR, but that was an issue, sorry for confusion)"><y>#</y><d>2019-01-27</d><h>16:08</h><r>kachayev</r><a href="https://github.com/ztellman/manifold/issues/166" target="_blank">https://github.com/ztellman/manifold/issues/166</a> (I thought that was a PR, but that was an issue, sorry for confusion)</z><z id="t1548605537" t="borkdude so currently it‚Äôs not well supported? say I have a future: (def f (future (println &quot;1&quot;) (Thread/sleep 10000) (when-not (Thread/interrupted) (println &quot;2&quot;) (Thread/sleep 10000) (when-not (Thread/interrupted) ...)))) (do (Thread/sleep 5000) (future-cancel f)) ;; 2 is never printed How is this translated to manifold? I think it would be worth having this example in the README"><y>#</y><d>2019-01-27</d><h>16:12</h><r>borkdude</r>so currently it‚Äôs not well supported?
say I have a future:

<pre>(def f (future
         (println &quot;1&quot;)
         (Thread/sleep 10000)
         (when-not (Thread/interrupted)
           (println &quot;2&quot;)
           (Thread/sleep 10000)
           (when-not (Thread/interrupted)
             ...))))
             
(do (Thread/sleep 5000) (future-cancel f))
  ;; 2 is never printed
</pre>
How is this translated to manifold? I think it would be worth having this example in the README</z><z id="t1548611980" t="kachayev It‚Äôs not supported for deferred/loop right now, but the approach described in the issue I‚Äôve mention is what you‚Äôre looking for. Let me put a gist for you "><y>#</y><d>2019-01-27</d><h>17:59</h><r>kachayev</r>It‚Äôs not supported for deferred/loop right now, but the approach described in the issue I‚Äôve mention is what you‚Äôre looking for. Let me put a gist for you </z><z id="t1548614681" t="borkdude gist would be cool üôÇ"><y>#</y><d>2019-01-27</d><h>18:44</h><r>borkdude</r>gist would be cool <b>üôÇ</b></z><z id="t1548614801" t="kachayev https://gist.github.com/kachayev/a279a728a4a73f16aabbebaedb94ea95"><y>#</y><d>2019-01-27</d><h>18:46</h><r>kachayev</r><a href="https://gist.github.com/kachayev/a279a728a4a73f16aabbebaedb94ea95" target="_blank">https://gist.github.com/kachayev/a279a728a4a73f16aabbebaedb94ea95</a></z><z id="t1548614832" t="kachayev Does this work for you?"><y>#</y><d>2019-01-27</d><h>18:47</h><r>kachayev</r>Does this work for you?</z><z id="t1548614960" t="borkdude I think it‚Äôs clear now. So instead of checking for (Thread/interrupted) , I check for (d/realized? ‚Ä¶) , because when I ‚Äúcancel‚Äù it (putting an error value in it), it‚Äôs realized. Thanks."><y>#</y><d>2019-01-27</d><h>18:49</h><r>borkdude</r>I think it‚Äôs clear now. So instead of checking for <code>(Thread/interrupted)</code>, I check for <code>(d/realized? ‚Ä¶)</code>,  because when I ‚Äúcancel‚Äù it (putting an error value in it), it‚Äôs realized. Thanks.</z><z id="t1548616376" t="kachayev Yep. That‚Äôs correct! "><y>#</y><d>2019-01-27</d><h>19:12</h><r>kachayev</r>Yep. That‚Äôs correct! </z><z id="t1549030243" t="firstclassfunc morning. Does anyone have a pattern for how to test of a deferred UDP/socket is bound to a port?"><y>#</y><d>2019-02-01</d><h>14:10</h><w>firstclassfunc</w>morning. Does anyone have a pattern for how to test of a deferred UDP/socket is bound to a port?</z><z id="t1549368003" t="Empperi Has anyone ever implemented a ManyToManyChannel to ByteBuf conversion? Especially regarding to byte-streams/def-conversion ?"><y>#</y><d>2019-02-05</d><h>12:00</h><w>Empperi</w>Has anyone ever implemented a <code>ManyToManyChannel</code> to <code>ByteBuf</code> conversion? Especially regarding to <code>byte-streams/def-conversion</code>?</z><z id="t1549368023" t="Empperi I have never implemented these conversions and have already spent way too much time into this"><y>#</y><d>2019-02-05</d><h>12:00</h><w>Empperi</w>I have never implemented these conversions and have already spent way too much time into this</z><z id="t1549374887" t="kachayev [:attrs {:href &quot;/_/_/users/U7MRZK43B&quot;}] Do you mean ‚Äúto read until closed and convert to ByteBuf whatever was there‚Äù?"><y>#</y><d>2019-02-05</d><h>13:54</h><w>kachayev</w><a>@niklas.collin</a> Do you mean ‚Äúto read until closed and convert to ByteBuf whatever was there‚Äù?</z><z id="t1549374910" t="Empperi Yeah"><y>#</y><d>2019-02-05</d><h>13:55</h><w>Empperi</w>Yeah</z><z id="t1549374954" t="Empperi I have actually another problem too but even though that is related it is not strictly the same"><y>#</y><d>2019-02-05</d><h>13:55</h><w>Empperi</w>I have actually another problem too but even though that is related it is not strictly the same</z><z id="t1549375050" t="kachayev You can try implement this by extending ByteSource protocol, let me find you an example"><y>#</y><d>2019-02-05</d><h>13:57</h><w>kachayev</w>You can try implement this by extending <code>ByteSource</code> protocol, let me find you an example</z><z id="t1549375070" t="kachayev https://github.com/ztellman/byte-streams/blob/master/src/byte_streams.clj#L676"><y>#</y><d>2019-02-05</d><h>13:57</h><w>kachayev</w><a href="https://github.com/ztellman/byte-streams/blob/master/src/byte_streams.clj#L676" target="_blank">https://github.com/ztellman/byte-streams/blob/master/src/byte_streams.clj#L676</a></z><z id="t1549375145" t="kachayev I‚Äôm not sure if it‚Äôs a good thing to do in general‚Ä¶ such reader would be blocking"><y>#</y><d>2019-02-05</d><h>13:59</h><w>kachayev</w>I‚Äôm not sure if it‚Äôs a good thing to do in general‚Ä¶ such reader would be blocking</z><z id="t1549375189" t="kachayev Maybe there‚Äôs another approach for tackling the same problem? Or you‚Äôre okay with blocking version?"><y>#</y><d>2019-02-05</d><h>13:59</h><w>kachayev</w>Maybe there‚Äôs another approach for tackling the same problem? Or you‚Äôre okay with blocking version?</z><z id="t1549376193" t="Empperi Maybe. I&apos;ll think about this. Cheers for the example üëç"><y>#</y><d>2019-02-05</d><h>14:16</h><w>Empperi</w>Maybe. I&apos;ll think about this. Cheers for the example <b>üëç</b></z><z id="t1549376233" t="kachayev Sure!"><y>#</y><d>2019-02-05</d><h>14:17</h><w>kachayev</w>Sure!</z><z id="t1549377169" t="lmergen [:attrs {:href &quot;/_/_/users/U7MRZK43B&quot;}] as a matter of fact, i&apos;ve done exactly this, but it&apos;s much simpler"><y>#</y><d>2019-02-05</d><h>14:32</h><w>lmergen</w><a>@niklas.collin</a> as a matter of fact, i&apos;ve done exactly this, but it&apos;s much simpler</z><z id="t1549377187" t="Empperi Sounds promising"><y>#</y><d>2019-02-05</d><h>14:33</h><w>Empperi</w>Sounds promising</z><z id="t1549377217" t="lmergen it&apos;s pretty evil, though"><y>#</y><d>2019-02-05</d><h>14:33</h><w>lmergen</w>it&apos;s pretty evil, though</z><z id="t1549377217" t="lmergen but"><y>#</y><d>2019-02-05</d><h>14:33</h><w>lmergen</w>but</z><z id="t1549377243" t="lmergen i basically use manifold.stream/stream-&gt;seq , and then reduce the whole sequence into a single bytebuf üôÇ"><y>#</y><d>2019-02-05</d><h>14:34</h><w>lmergen</w>i basically use <code>manifold.stream/stream-&gt;seq</code>, and then reduce the whole sequence into a single bytebuf <b>üôÇ</b></z><z id="t1549377272" t="lmergen (defn ^ByteBuffer concat-bytebufs &quot;Takes a collection of bytebuffers and returns a single large concatenated bytebuffer.&quot; [xs] (let [size (-&gt;&gt; xs (map #(.remaining %)) (reduce +)) bb (ByteBuffer/allocate size) ;; Puts a bytebuffer on the large bytebuffer put-on-bb (fn [^ByteBuffer big ^ByteBuffer small] (assert (&gt;= (.remaining big) (.remaining small))) (.put big (.slice small)))] (run! (partial put-on-bb bb) xs) (.flip bb)))"><y>#</y><d>2019-02-05</d><h>14:34</h><w>lmergen</w><pre>(defn ^ByteBuffer concat-bytebufs
  &quot;Takes a collection of bytebuffers and returns a single large concatenated bytebuffer.&quot;

  [xs]

  (let [size (-&gt;&gt; xs
                  (map #(.remaining %))
                  (reduce +))
        bb (ByteBuffer/allocate size)

        ;; Puts a bytebuffer on the large bytebuffer
        put-on-bb (fn [^ByteBuffer big ^ByteBuffer small]
                    (assert (&gt;= (.remaining big) (.remaining small)))
                    (.put big (.slice small)))]

    (run! (partial put-on-bb bb) xs)
    (.flip bb)))</pre></z><z id="t1549377453" t="lmergen it&apos;s probably not the best performing way to do it"><y>#</y><d>2019-02-05</d><h>14:37</h><w>lmergen</w>it&apos;s probably not the best performing way to do it</z><z id="t1549377521" t="kachayev [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] bytes-streams actually has conversions defined for (seq-of ByteBuffer) . Meaning‚Ä¶ concat-bytebuf should work out of the box, no?"><y>#</y><d>2019-02-05</d><h>14:38</h><w>kachayev</w><a>@lmergen</a> <code>bytes-streams</code> actually has conversions defined for <code>(seq-of ByteBuffer)</code>. Meaning‚Ä¶ <code>concat-bytebuf</code> should work out of the box, no?</z><z id="t1549377544" t="kachayev [:attrs {:href &quot;/_/_/users/U7MRZK43B&quot;}] Are we talking about ByteBuf from Netty or ByteBuffer from NIO?"><y>#</y><d>2019-02-05</d><h>14:39</h><w>kachayev</w><a>@niklas.collin</a> Are we talking about <code>ByteBuf</code> from Netty or <code>ByteBuffer</code> from NIO?</z><z id="t1549377545" t="lmergen so that makes me an idiot for writing this code üôÇ"><y>#</y><d>2019-02-05</d><h>14:39</h><w>lmergen</w>so that makes me an idiot for writing this code <b>üôÇ</b></z><z id="t1549377553" t="Empperi Netty"><y>#</y><d>2019-02-05</d><h>14:39</h><w>Empperi</w>Netty</z><z id="t1549377569" t="Empperi So ByteBuf"><y>#</y><d>2019-02-05</d><h>14:39</h><w>Empperi</w>So <code>ByteBuf</code></z><z id="t1549377569" t="lmergen interesting, i did not know about that function"><y>#</y><d>2019-02-05</d><h>14:39</h><w>lmergen</w>interesting, i did not know about that function</z><z id="t1549377574" t="kachayev So, it‚Äôs a bit different and I‚Äôve got the question correct"><y>#</y><d>2019-02-05</d><h>14:39</h><w>kachayev</w>So, it‚Äôs a bit different and I‚Äôve got the question correct</z><z id="t1549377602" t="kachayev [:attrs {:href &quot;/_/_/users/U0M8Y3G6N&quot;}] https://github.com/ztellman/byte-streams/blob/3e0822b58172b8d351b366213eda6090892e32b3/src/byte_streams.clj#L352"><y>#</y><d>2019-02-05</d><h>14:40</h><w>kachayev</w><a>@lmergen</a> <a href="https://github.com/ztellman/byte-streams/blob/3e0822b58172b8d351b366213eda6090892e32b3/src/byte_streams.clj#L352" target="_blank">https://github.com/ztellman/byte-streams/blob/3e0822b58172b8d351b366213eda6090892e32b3/src/byte_streams.clj#L352</a></z><z id="t1549377620" t="lmergen that&apos;s awesome, thanks [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}]"><y>#</y><d>2019-02-05</d><h>14:40</h><w>lmergen</w>that&apos;s awesome, thanks <a>@kachayev</a></z><z id="t1549377633" t="kachayev stream-of ByteBuffer to InputStream means that everything else should go automatically"><y>#</y><d>2019-02-05</d><h>14:40</h><w>kachayev</w><code>stream-of ByteBuffer</code> to InputStream means that everything else should go automatically</z><z id="t1549377642" t="lmergen yes"><y>#</y><d>2019-02-05</d><h>14:40</h><w>lmergen</w>yes</z><z id="t1549377649" t="kachayev üòé"><y>#</y><d>2019-02-05</d><h>14:40</h><w>kachayev</w><b>üòé</b></z><z id="t1549377722" t="kachayev The only one conversion defined for netty‚Äôs ByteBuf is https://github.com/ztellman/aleph/blob/d35d5bbbb090c31f3f53997ee1e0d68fc7b03044/src/aleph/netty.clj#L138-L142"><y>#</y><d>2019-02-05</d><h>14:42</h><w>kachayev</w>The only one conversion defined for netty‚Äôs <code>ByteBuf</code> is <a href="https://github.com/ztellman/aleph/blob/d35d5bbbb090c31f3f53997ee1e0d68fc7b03044/src/aleph/netty.clj#L138-L142" target="_blank">https://github.com/ztellman/aleph/blob/d35d5bbbb090c31f3f53997ee1e0d68fc7b03044/src/aleph/netty.clj#L138-L142</a></z><z id="t1549377776" t="kachayev So, that requires some work, but [:attrs {:href &quot;/_/_/users/U7MRZK43B&quot;}] you can use the same conversion as an example: https://github.com/ztellman/byte-streams/blob/3e0822b58172b8d351b366213eda6090892e32b3/src/byte_streams.clj#L352"><y>#</y><d>2019-02-05</d><h>14:42</h><w>kachayev</w>So, that requires some work, but <a>@niklas.collin</a> you can use the same conversion as an example: <a href="https://github.com/ztellman/byte-streams/blob/3e0822b58172b8d351b366213eda6090892e32b3/src/byte_streams.clj#L352" target="_blank">https://github.com/ztellman/byte-streams/blob/3e0822b58172b8d351b366213eda6090892e32b3/src/byte_streams.clj#L352</a></z><z id="t1549377802" t="Empperi But anyway. Basically what I would like to do is return a core async channel, then let it be automatically serialized as data comes in an async manner"><y>#</y><d>2019-02-05</d><h>14:43</h><w>Empperi</w>But anyway. Basically what I would like to do is return a core async channel, then let it be automatically serialized as data comes in an async manner</z><z id="t1549377805" t="kachayev core.async channel -&gt; manifold.stream is simple"><y>#</y><d>2019-02-05</d><h>14:43</h><w>kachayev</w>core.async channel -&gt; manifold.stream is simple</z><z id="t1549377868" t="kachayev serialized and‚Ä¶ what should happen next?"><y>#</y><d>2019-02-05</d><h>14:44</h><w>kachayev</w>serialized and‚Ä¶ what should happen next?</z><z id="t1549377879" t="kachayev written to network?"><y>#</y><d>2019-02-05</d><h>14:44</h><w>kachayev</w>written to network?</z><z id="t1549377884" t="Empperi Naturally it should be written to the socket"><y>#</y><d>2019-02-05</d><h>14:44</h><w>Empperi</w>Naturally it should be written to the socket</z><z id="t1549377913" t="Empperi And yes, websockets"><y>#</y><d>2019-02-05</d><h>14:45</h><w>Empperi</w>And yes, websockets</z><z id="t1549378105" t="kachayev If you use aleph for handling websocket connection, everything you need to do is to ‚Äúconnect‚Äù your core.async channel to manifold.stream that represent the connection"><y>#</y><d>2019-02-05</d><h>14:48</h><w>kachayev</w>If you use <code>aleph</code> for handling websocket connection, everything you need to do is to ‚Äúconnect‚Äù your core.async channel to manifold.stream that represent the connection</z><z id="t1549378152" t="kachayev Aleph handles serialization to ByteBuf from pretty much anything byte-streams can understand"><y>#</y><d>2019-02-05</d><h>14:49</h><w>kachayev</w>Aleph handles serialization to <code>ByteBuf</code> from pretty much anything <code>byte-streams</code> can understand</z><z id="t1549378204" t="kachayev Here‚Äôs the connect function: https://github.com/ztellman/manifold/blob/5d986a5b8ceb46a69caf38192076230d03f6a280/src/manifold/stream.clj#L300"><y>#</y><d>2019-02-05</d><h>14:50</h><w>kachayev</w>Here‚Äôs the <code>connect</code> function: <a href="https://github.com/ztellman/manifold/blob/5d986a5b8ceb46a69caf38192076230d03f6a280/src/manifold/stream.clj#L300" target="_blank">https://github.com/ztellman/manifold/blob/5d986a5b8ceb46a69caf38192076230d03f6a280/src/manifold/stream.clj#L300</a></z><z id="t1549378304" t="kachayev Basically it means ‚Äútake everything that comes from here and put it there‚Äù. If you need to apply custom serialization, just use manifold.stream/map . You don‚Äôt need to worry about netty‚Äôs ByteBuf - something that‚Äôs a text or binary (like byte array) would work"><y>#</y><d>2019-02-05</d><h>14:51</h><w>kachayev</w>Basically it means ‚Äútake everything that comes from here and put it there‚Äù. If you need to apply custom serialization, just use <code>manifold.stream/map</code>. You don‚Äôt need to worry about netty‚Äôs <code>ByteBuf</code> - something that‚Äôs a text or binary (like byte array) would work</z><z id="t1549434467" t="Roman Tsopin I have a raw tcp protocol, which writes arbitrary length string to the client, and then closes the connection. What is the simplest way to write a client in aleph? Should I read messages from stream until it‚Äôs drained and then assemble the whole response? Or is there a better way"><y>#</y><d>2019-02-06</d><h>06:27</h><w>Roman Tsopin</w>I have a raw tcp protocol, which writes arbitrary length string to the client, and then closes the connection. What is the simplest way to write a client in aleph? Should I read messages from stream until it‚Äôs drained and then assemble the whole response? Or is there a better way</z><z id="t1549444626" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/UA6TBJPN0&quot;}] i would (manifold.stream/reduce conj [] &lt;stream&gt;) the stream into a response buffer... i&apos;ve not used the aleph tcp client though - do you get chunks on the stream or bytes ? if it&apos;s chunks then you would need to concatenate them too, if it&apos;s bytes you might want to use a ByteArrayOutputStream or something for more efficient collection (then a vector)"><y>#</y><d>2019-02-06</d><h>09:17</h><w>mccraigmccraig</w><a>@romantsopin</a> i would <code>(manifold.stream/reduce conj [] &lt;stream&gt;)</code> the stream into a response buffer... i&apos;ve not used the aleph tcp client though - do you get chunks on the stream or bytes ? if it&apos;s chunks then you would need to concatenate them too, if it&apos;s bytes you might want to use a ByteArrayOutputStream or something for more efficient collection (then a vector)</z><z id="t1549448193" t="Roman Tsopin Thanks, I will try it. I got bytes on the stream"><y>#</y><d>2019-02-06</d><h>10:16</h><r>Roman Tsopin</r>Thanks, I will try it. I got bytes on the stream</z><z id="t1549451718" t="Roman Tsopin Also, am I correct, that manifold messages for tcp is just arbitrary slices of tcp stream? And written string could be potentially splitted across different messages? And for websocket every manifold message 1to1 corresponds to websocket message"><y>#</y><d>2019-02-06</d><h>11:15</h><w>Roman Tsopin</w>Also, am I correct, that manifold messages for tcp is just arbitrary slices of tcp stream? And written string could be potentially splitted across different messages? And for websocket every manifold message 1to1 corresponds to websocket message</z><z id="t1549451972" t="kachayev [:attrs {:href &quot;/_/_/users/UA6TBJPN0&quot;}] Websocket has framed format for transmitting messages, meaning you can understand where message starts/ends and if it has continuations. This structure is translated into text, binary, close etc frames. If you want to do the same for arbitrary TCP, you need to explicitly tell what the ‚Äúmessage‚Äù means, otherwise it‚Äôs just a raw stream of bytes. For arbitrary length strings it makes sense to write length of the message in known format, like i32 or i64, after that writes the string, goto ‚Äúbegin‚Äù."><y>#</y><d>2019-02-06</d><h>11:19</h><w>kachayev</w><a>@romantsopin</a> Websocket has framed format for transmitting messages, meaning you can understand where message starts/ends and if it has continuations. This structure is translated into text, binary, close etc frames. If you want to do the same for arbitrary TCP, you need to explicitly tell what the ‚Äúmessage‚Äù means, otherwise it‚Äôs just a raw stream of bytes. For arbitrary length strings it makes sense to write length of the message in known format, like i32 or i64, after that writes the string, goto ‚Äúbegin‚Äù.</z><z id="t1549452347" t="Roman Tsopin Yep, thanks, just wanted to make sure I have correct assumptions about manifold abstraction in that case. Unfortunately I can‚Äôt control server protocol, it could signals end of the stream only by closing the connection, which is not very convenient. I think something like read until stream is closed (readAllBytes) could be convenient in that particular case.."><y>#</y><d>2019-02-06</d><h>11:25</h><r>Roman Tsopin</r>Yep, thanks, just wanted to make sure I have correct assumptions about manifold abstraction in that case. Unfortunately I can‚Äôt control server protocol, it could signals end of the stream only by closing the connection, which is not very convenient. I think something like read until stream is closed (readAllBytes) could be convenient in that particular case..</z></g><g id="s5"><z id="t1549452180" t="kachayev Here you can see example that uses gloss library to encode/decode bytes https://github.com/ztellman/aleph/blob/d35d5bbbb090c31f3f53997ee1e0d68fc7b03044/examples/src/aleph/examples/tcp.clj#L22-L27"><y>#</y><d>2019-02-06</d><h>11:23</h><w>kachayev</w>Here you can see example that uses <code>gloss</code> library to encode/decode bytes <a href="https://github.com/ztellman/aleph/blob/d35d5bbbb090c31f3f53997ee1e0d68fc7b03044/examples/src/aleph/examples/tcp.clj#L22-L27" target="_blank">https://github.com/ztellman/aleph/blob/d35d5bbbb090c31f3f53997ee1e0d68fc7b03044/examples/src/aleph/examples/tcp.clj#L22-L27</a></z><z id="t1549452690" t="Roman Tsopin It‚Äôs a bit off topic but is this library still supported? I‚Äôm asking because repo is archived now"><y>#</y><d>2019-02-06</d><h>11:31</h><r>Roman Tsopin</r>It‚Äôs a bit off topic but is this library still supported? I‚Äôm asking because repo is archived now</z><z id="t1549452942" t="kachayev I don‚Äôt know, I‚Äôve never used it. I‚Äôve just share this as an example of how strings of arbitrary length are typically encoded to be represented as a ‚Äúmessage‚Äù"><y>#</y><d>2019-02-06</d><h>11:35</h><r>kachayev</r>I don‚Äôt know, I‚Äôve never used it. I‚Äôve just share this as an example of how strings of arbitrary length are typically encoded to be represented as a ‚Äúmessage‚Äù</z><z id="t1550225483" t="igrishaev Can anybody help me with that manifold-related question? https://github.com/ztellman/manifold/issues/168"><y>#</y><d>2019-02-15</d><h>10:11</h><w>igrishaev</w>Can anybody help me with that manifold-related question? <a href="https://github.com/ztellman/manifold/issues/168" target="_blank">https://github.com/ztellman/manifold/issues/168</a></z><z id="t1550228787" t="mccraigmccraig finally is generally used for resource cleanup, and doesn&apos;t stop the propagation of an exception or otherwise affect flow control - i don&apos;t know what would happen in your example, i&apos;ve never tried similar, but it seems unnatural to do flow-control stuff in a finally block - why not just do it straight after the catch ?"><y>#</y><d>2019-02-15</d><h>11:06</h><w>mccraigmccraig</w><code>finally</code> is generally used for resource cleanup, and doesn&apos;t stop the propagation of an exception or otherwise affect flow control - i don&apos;t know what would happen in your example, i&apos;ve never tried similar, but it seems unnatural to do flow-control stuff in a <code>finally</code> block - why not just do it straight after the <code>catch</code> ?</z><z id="t1550233915" t="igrishaev hm, makes sense, thank you"><y>#</y><d>2019-02-15</d><h>12:31</h><w>igrishaev</w>hm, makes sense, thank you</z><z id="t1550234772" t="igrishaev put a proper version of code there"><y>#</y><d>2019-02-15</d><h>12:46</h><w>igrishaev</w>put a proper version of code there</z><z id="t1550240049" t="oyakushev [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] Replied."><y>#</y><d>2019-02-15</d><h>14:14</h><w>oyakushev</w><a>@igrishaev</a> Replied.</z><z id="t1551346810" t="Empperi Hi! Using websocket-client to connect into websocket endpoint. This works just fine but I have a problem when target endpoint is not there when trying to make the connection"><y>#</y><d>2019-02-28</d><h>09:40</h><w>Empperi</w>Hi! Using <code>websocket-client</code> to connect into websocket endpoint. This works just fine but I have a problem when target endpoint is not there when trying to make the connection</z><z id="t1551346827" t="Empperi The connection creation just hangs forever, no errors or anything"><y>#</y><d>2019-02-28</d><h>09:40</h><w>Empperi</w>The connection creation just hangs forever, no errors or anything</z><z id="t1551346831" t="Empperi I must be missing something"><y>#</y><d>2019-02-28</d><h>09:40</h><w>Empperi</w>I must be missing something</z><z id="t1551346876" t="Empperi I think it is because websocket-client returns a deferred which I must first dereference to use it"><y>#</y><d>2019-02-28</d><h>09:41</h><w>Empperi</w>I think it is because <code>websocket-client</code> returns a deferred which I must first dereference to use it</z><z id="t1551346907" t="Empperi And that dereferencing will hang until the connection is established, which it never manages to do since the target endpoint isn&apos;t available"><y>#</y><d>2019-02-28</d><h>09:41</h><w>Empperi</w>And that dereferencing will hang until the connection is established, which it never manages to do since the target endpoint isn&apos;t available</z><z id="t1551346973" t="Empperi So, is there a way to tell the websocket-client a connection timeout?"><y>#</y><d>2019-02-28</d><h>09:42</h><w>Empperi</w>So, is there a way to tell the <code>websocket-client</code> a connection timeout?</z><z id="t1551347059" t="kachayev First, you can use (d/timeout _) to fail the deferred after timeout you need"><y>#</y><d>2019-02-28</d><h>09:44</h><w>kachayev</w>First, you can use <code>(d/timeout _)</code> to fail the deferred after timeout you need</z><z id="t1551347195" t="Empperi OK, that was what I was more or less looking for I think"><y>#</y><d>2019-02-28</d><h>09:46</h><w>Empperi</w>OK, that was what I was more or less looking for I think</z><z id="t1551347377" t="kachayev Second, there‚Äôs a ConnectionTimeout that fires when you cannot establish a TCP connection. The problem with Websocket protocol is that it requires one another round-trip to setup the stream: handshake request/response (see https://github.com/ztellman/aleph/pull/422 and https://github.com/netty/netty/issues/8841 ). If your server is ‚Äúnot there‚Äù, it fails. If your server unable to finish the handshake - it‚Äôs not managed by the Aleph for now (it would be after PR is merged tho‚Äô)."><y>#</y><d>2019-02-28</d><h>09:49</h><w>kachayev</w>Second, there‚Äôs a ConnectionTimeout that fires when you cannot establish a TCP connection. The problem with Websocket protocol is that it requires one another round-trip to setup the stream: handshake request/response (see <a href="https://github.com/ztellman/aleph/pull/422" target="_blank">https://github.com/ztellman/aleph/pull/422</a> and <a href="https://github.com/netty/netty/issues/8841" target="_blank">https://github.com/netty/netty/issues/8841</a>). If your server is ‚Äúnot there‚Äù, it fails. If your server unable to finish the handshake - it‚Äôs not managed by the Aleph for now (it would be after PR is merged tho‚Äô).</z><z id="t1551347429" t="Empperi Right"><y>#</y><d>2019-02-28</d><h>09:50</h><w>Empperi</w>Right</z><z id="t1551347450" t="Empperi Well in this case the target server is starting sometimes when I&apos;m trying to establish connection"><y>#</y><d>2019-02-28</d><h>09:50</h><w>Empperi</w>Well in this case the target server is starting sometimes when I&apos;m trying to establish connection</z><z id="t1551347464" t="Empperi And it will get up eventually"><y>#</y><d>2019-02-28</d><h>09:51</h><w>Empperi</w>And it will get up eventually</z><z id="t1551347474" t="Empperi (or if it doesn&apos;t then there&apos;s a bigger problem)"><y>#</y><d>2019-02-28</d><h>09:51</h><w>Empperi</w>(or if it doesn&apos;t then there&apos;s a bigger problem)</z><z id="t1551347582" t="kachayev (-&gt; (websocket-client ...) (d/timeout! 5e3 ::timeout) (d/chain&apos; (fn [conn] (if-not (identical? ::timeout conn) conn (time/in 5e3 (websocket-client ...)))))) "><y>#</y><d>2019-02-28</d><h>09:53</h><w>kachayev</w><pre>(-&gt; (websocket-client ...)
    (d/timeout! 5e3 ::timeout)
    (d/chain&apos; (fn [conn] (if-not (identical? ::timeout conn) conn (time/in 5e3 (websocket-client ...))))))
</pre></z><z id="t1551347612" t="kachayev Out of my head, didn‚Äôt test it üôÇ"><y>#</y><d>2019-02-28</d><h>09:53</h><w>kachayev</w>Out of my head, didn‚Äôt test it <b>üôÇ</b></z><z id="t1551347616" t="Empperi hehe"><y>#</y><d>2019-02-28</d><h>09:53</h><w>Empperi</w>hehe</z><z id="t1551347640" t="kachayev TCP doesn‚Äôt have a solution for ‚Äúserver is starting‚Äù as a protocol, unfortunately üòâ"><y>#</y><d>2019-02-28</d><h>09:54</h><w>kachayev</w>TCP doesn‚Äôt have a solution for ‚Äúserver is starting‚Äù as a protocol, unfortunately <b>üòâ</b></z><z id="t1551347649" t="Empperi Yeah I know"><y>#</y><d>2019-02-28</d><h>09:54</h><w>Empperi</w>Yeah I know</z><z id="t1551347670" t="Empperi It is pretty obvious that I need to retry a bit later if it isn&apos;t just there"><y>#</y><d>2019-02-28</d><h>09:54</h><w>Empperi</w>It is pretty obvious that I need to retry a bit later if it isn&apos;t just there</z><z id="t1551347683" t="Empperi And do that for x times or give up"><y>#</y><d>2019-02-28</d><h>09:54</h><w>Empperi</w>And do that for x times or give up</z><z id="t1551347704" t="kachayev Correct"><y>#</y><d>2019-02-28</d><h>09:55</h><w>kachayev</w>Correct</z><z id="t1551351351" t="igrishaev Hi! There is a lot of middleware for the HTTP client. Yet I don‚Äôt understand how to use them when sending HTTP calls. For example, when GET-ting a JSON file, how to finish with the body being parsed automatically? What option should I specify?"><y>#</y><d>2019-02-28</d><h>10:55</h><w>igrishaev</w>Hi! There is a lot of middleware for the HTTP client. Yet I don‚Äôt understand how to use them when sending HTTP calls. For example, when GET-ting a JSON file, how to finish with the body being parsed automatically? What option should I specify?</z><z id="t1551351441" t="igrishaev What I‚Äôve tried: @(http/get &quot;&quot;) returns just a byte stream as body"><y>#</y><d>2019-02-28</d><h>10:57</h><w>igrishaev</w>What I‚Äôve tried:
<pre>@(http/get &quot;&quot;)
</pre>
returns just a byte stream as body</z><z id="t1551351461" t="igrishaev @(http/get &quot;&quot; {:middleware middleware/wrap-request}) gives the same result"><y>#</y><d>2019-02-28</d><h>10:57</h><w>igrishaev</w><pre>@(http/get &quot;&quot; 
           {:middleware middleware/wrap-request})
</pre>
gives the same result</z><z id="t1551351563" t="kachayev Wrap-request is applied automatically "><y>#</y><d>2019-02-28</d><h>10:59</h><w>kachayev</w>Wrap-request is applied automatically </z><z id="t1551351580" t="kachayev :as :json should work "><y>#</y><d>2019-02-28</d><h>10:59</h><w>kachayev</w>:as :json should work </z><z id="t1551351780" t="igrishaev let me try"><y>#</y><d>2019-02-28</d><h>11:03</h><w>igrishaev</w>let me try</z><z id="t1551351830" t="igrishaev what works! Does it mean, I can just pass the standard clj-http args?"><y>#</y><d>2019-02-28</d><h>11:03</h><w>igrishaev</w>what works! Does it mean, I can just pass the standard clj-http args?</z><z id="t1551351854" t="kachayev Almost always :) "><y>#</y><d>2019-02-28</d><h>11:04</h><w>kachayev</w>Almost always :) </z><z id="t1551351872" t="kachayev There‚Äôs a list of those things that are different "><y>#</y><d>2019-02-28</d><h>11:04</h><w>kachayev</w>There‚Äôs a list of those things that are different </z><z id="t1551351885" t="kachayev In README"><y>#</y><d>2019-02-28</d><h>11:04</h><w>kachayev</w>In README</z><z id="t1551351898" t="igrishaev when sending JSON body, with that work? :form-params {:foo 42} :content-type :json "><y>#</y><d>2019-02-28</d><h>11:04</h><w>igrishaev</w>when sending JSON body, with that work?
<pre>:form-params {:foo 42}
:content-type :json
</pre></z><z id="t1551352170" t="kachayev Yep "><y>#</y><d>2019-02-28</d><h>11:09</h><w>kachayev</w>Yep </z><z id="t1551352179" t="kachayev Or :application/json"><y>#</y><d>2019-02-28</d><h>11:09</h><w>kachayev</w>Or :application/json</z><z id="t1551352187" t="kachayev I don‚Äôt remember exactly "><y>#</y><d>2019-02-28</d><h>11:09</h><w>kachayev</w>I don‚Äôt remember exactly </z><z id="t1551352372" t="igrishaev yes, it seems to be the full version (defmethod coerce-form-params :application/json"><y>#</y><d>2019-02-28</d><h>11:12</h><w>igrishaev</w>yes, it seems to be the full version
<code>(defmethod coerce-form-params :application/json</code></z><z id="t1551352630" t="kachayev What about clj-http? Do they accept short version? "><y>#</y><d>2019-02-28</d><h>11:17</h><w>kachayev</w>What about clj-http? Do they accept short version? </z><z id="t1551352649" t="igrishaev yes, the take just :content-type :json"><y>#</y><d>2019-02-28</d><h>11:17</h><w>igrishaev</w>yes, the take just <code>:content-type :json</code></z><z id="t1551352673" t="kachayev Feel free to open an issue with ‚Äúclj-http parity‚Äù tag :) "><y>#</y><d>2019-02-28</d><h>11:17</h><w>kachayev</w>Feel free to open an issue with ‚Äúclj-http parity‚Äù tag :) </z><z id="t1551352680" t="kachayev Or I‚Äôll do that in the evening"><y>#</y><d>2019-02-28</d><h>11:18</h><w>kachayev</w>Or I‚Äôll do that in the evening</z><z id="t1551352712" t="igrishaev but it‚Äôs not a problem, really. Instead, it would be nice to add more examples in readme because auto encode/decode JSON happens constantly"><y>#</y><d>2019-02-28</d><h>11:18</h><w>igrishaev</w>but it‚Äôs not a problem, really. Instead, it would be nice to add more examples in readme because auto encode/decode JSON happens constantly</z><z id="t1551352734" t="igrishaev ok probably I‚Äôll contribute"><y>#</y><d>2019-02-28</d><h>11:18</h><w>igrishaev</w>ok probably I‚Äôll contribute</z><z id="t1551352904" t="kachayev Let me know if I can help with anything "><y>#</y><d>2019-02-28</d><h>11:21</h><r>kachayev</r>Let me know if I can help with anything </z><z id="t1551352823" t="igrishaev what is good about clj-http, you never remember all the options, but they‚Äôve got rich base of examples, so you just copy and paste"><y>#</y><d>2019-02-28</d><h>11:20</h><w>igrishaev</w>what is good about clj-http, you never remember all the options, but they‚Äôve got rich base of examples, so you just copy and paste</z><z id="t1551352948" t="kachayev The idea was that you can just copy example for clj-http and it works üòÇ "><y>#</y><d>2019-02-28</d><h>11:22</h><w>kachayev</w>The idea was that you can just copy example for clj-http and it works <b>üòÇ</b> </z><z id="t1551352965" t="kachayev But, yeah... documentation is a weak point for now "><y>#</y><d>2019-02-28</d><h>11:22</h><w>kachayev</w>But, yeah... documentation is a weak point for now </z><z id="t1551352979" t="kachayev And it requires constant attention "><y>#</y><d>2019-02-28</d><h>11:22</h><w>kachayev</w>And it requires constant attention </z><z id="t1551353051" t="igrishaev maybe I was confused with a docstring to aleph.http/request function which highlights only the basic args"><y>#</y><d>2019-02-28</d><h>11:24</h><w>igrishaev</w>maybe I was confused with a docstring to <code>aleph.http/request</code> function which highlights only the basic args</z><z id="t1551353080" t="igrishaev but it‚Äôs clear now, thanks a lot!"><y>#</y><d>2019-02-28</d><h>11:24</h><w>igrishaev</w>but it‚Äôs clear now, thanks a lot!</z><z id="t1551353126" t="kachayev My pleasure! "><y>#</y><d>2019-02-28</d><h>11:25</h><w>kachayev</w>My pleasure! </z><z id="t1551765526" t="Ahmed Hassan How do I approach network programming in Clojure as beginner?"><y>#</y><d>2019-03-05</d><h>05:58</h><w>Ahmed Hassan</w>How do I approach network programming in Clojure as beginner?</z><z id="t1551776568" t="Empperi With care? troll"><y>#</y><d>2019-03-05</d><h>09:02</h><w>Empperi</w>With care? <b>troll</b></z><z id="t1551776582" t="Empperi Seriously speaking, you need to be more specific than that"><y>#</y><d>2019-03-05</d><h>09:03</h><w>Empperi</w>Seriously speaking, you need to be more specific than that</z><z id="t1551777963" t="Ahmed Hassan Trying to implement a server to host multimedia like images, videos. I&apos;m a beginner."><y>#</y><d>2019-03-05</d><h>09:26</h><r>Ahmed Hassan</r>Trying to implement a server to host multimedia like images, videos. I&apos;m a beginner.</z><z id="t1551787872" t="Empperi Ok. And apparently you are planning to use Aleph. Well, the easiest solution is to just return an InputStream object to your media file to the browser"><y>#</y><d>2019-03-05</d><h>12:11</h><r>Empperi</r>Ok. And apparently you are planning to use Aleph. Well, the easiest solution is to just return an InputStream object to your media file to the browser</z><z id="t1551787900" t="Empperi This allows streaming the file from filesystem to the browser without you having to first load it into server memory"><y>#</y><d>2019-03-05</d><h>12:11</h><r>Empperi</r>This allows streaming the file from filesystem to the browser without you having to first load it into server memory</z><z id="t1551787910" t="Empperi Which would be disastrous especially with videos and multiple concurrent users"><y>#</y><d>2019-03-05</d><h>12:11</h><r>Empperi</r>Which would be disastrous especially with videos and multiple concurrent users</z><z id="t1551787946" t="Empperi Plus would make it way slower to start the download for the client since server would have to first load the whole file. By returning a stream client will start to receive the file immediately"><y>#</y><d>2019-03-05</d><h>12:12</h><r>Empperi</r>Plus would make it way slower to start the download for the client since server would have to first load the whole file. By returning a stream client will start to receive the file immediately</z><z id="t1551787989" t="Empperi Now when implementing a true video media server then you&apos;d have to take into account also jumping around in the video, this is more about video codecs and formats and how to deal with those"><y>#</y><d>2019-03-05</d><h>12:13</h><r>Empperi</r>Now when implementing a true video media server then you&apos;d have to take into account also jumping around in the video, this is more about video codecs and formats and how to deal with those</z><z id="t1551788026" t="Empperi But basically the basic idea is the same there: you find the correct position in the video file, then create an InputStream to that file starting at that specific point in time and send that to the client"><y>#</y><d>2019-03-05</d><h>12:13</h><r>Empperi</r>But basically the basic idea is the same there: you find the correct position in the video file, then create an InputStream to that file starting at that specific point in time and send that to the client</z><z id="t1551788075" t="Empperi But it gets more complex since you cannot just start streaming from a random byte in a video file: in most codecs there is a concept called &quot;keyframe&quot; which is a point in time where you can rewind into and start streaming from there"><y>#</y><d>2019-03-05</d><h>12:14</h><r>Empperi</r>But it gets more complex since you cannot just start streaming from a random byte in a video file: in most codecs there is a concept called &quot;keyframe&quot; which is a point in time where you can rewind into and start streaming from there</z><z id="t1551788115" t="Empperi Basically a time segment between two keyframes is a &quot;full video file&quot; so normal video file is actually a sequence of these"><y>#</y><d>2019-03-05</d><h>12:15</h><r>Empperi</r>Basically a time segment between two keyframes is a &quot;full video file&quot; so normal video file is actually a sequence of these</z><z id="t1551788139" t="Empperi And this is the actual video part of the file, audio is a story on itself"><y>#</y><d>2019-03-05</d><h>12:15</h><r>Empperi</r>And this is the actual video part of the file, audio is a story on itself</z><z id="t1551788166" t="Empperi But anyway, you get the point. This is a way too complex topic to cover in detail here but the very basics of it is very simple when it comes to your original question"><y>#</y><d>2019-03-05</d><h>12:16</h><r>Empperi</r>But anyway, you get the point. This is a way too complex topic to cover in detail here but the very basics of it is very simple when it comes to your original question</z><z id="t1551788213" t="Empperi With images however it is very simple, client always needs the whole image. Just send it in whole to the client as a stream"><y>#</y><d>2019-03-05</d><h>12:16</h><r>Empperi</r>With images however it is very simple, client always needs the whole image. Just send it in whole to the client as a stream</z><z id="t1551788232" t="Empperi Remember to set proper Content-Type header so browser knows what kind of data it is it is receiving"><y>#</y><d>2019-03-05</d><h>12:17</h><r>Empperi</r>Remember to set proper Content-Type header so browser knows what kind of data it is it is receiving</z><z id="t1551788273" t="Empperi All this has nothing to do with Aleph itself really although Aleph can be used as a server for this"><y>#</y><d>2019-03-05</d><h>12:17</h><r>Empperi</r>All this has nothing to do with Aleph itself really although Aleph can be used as a server for this</z><z id="t1551788315" t="Empperi Hope this helps"><y>#</y><d>2019-03-05</d><h>12:18</h><r>Empperi</r>Hope this helps</z><z id="t1551789644" t="Ahmed Hassan Thanks alot üôÇ"><y>#</y><d>2019-03-05</d><h>12:40</h><r>Ahmed Hassan</r>Thanks alot <b>üôÇ</b></z><z id="t1551791435" t="kachayev [:attrs {:href &quot;/_/_/users/UCMNZLJ93&quot;}] Please, check this example I‚Äôve implemented recently: static files server on top of Aleph https://github.com/kachayev/nasus"><y>#</y><d>2019-03-05</d><h>13:10</h><r>kachayev</r><a>@UCMNZLJ93</a> Please, check this example I‚Äôve implemented recently: static files server on top of Aleph <a href="https://github.com/kachayev/nasus" target="_blank">https://github.com/kachayev/nasus</a></z><z id="t1551791546" t="kachayev Other than that‚Ä¶ the question is really about details: number of clients, size of files and frequency of changes, geo distribution, goals/plans, hardware/network in terms of bandwidth etc etc etc"><y>#</y><d>2019-03-05</d><h>13:12</h><r>kachayev</r>Other than that‚Ä¶ the question is really about details: number of clients, size of files and frequency of changes, geo distribution, goals/plans, hardware/network in terms of bandwidth etc etc etc</z><z id="t1551791611" t="kachayev If you need to implement backend for video- or sound streaming‚Ä¶. that‚Äôs an entirely different dimension and different problems"><y>#</y><d>2019-03-05</d><h>13:13</h><r>kachayev</r>If you need to implement backend for video- or sound streaming‚Ä¶. that‚Äôs an entirely different dimension and different problems</z><z id="t1551790512" t="lispyclouds Hello, I have a TarArchiveInputStream object and I want to make it available as a download over http. I tried the response on the handler like this {:status 200 :headers {&quot;Content-Type&quot; &quot;archive/tar&quot; &quot;Content-Disposition&quot; &quot;inline; filename=download.tar&quot;} :body (get-stream)} I am able to trigger a download with the correct file names and content types, but the response is of 0 bytes. What am I doing wrong?"><y>#</y><d>2019-03-05</d><h>12:55</h><w>lispyclouds</w>Hello, I have a TarArchiveInputStream object and I want to make it available as a download over http. I tried the response on the handler like this
<pre>{:status  200
 :headers {&quot;Content-Type&quot;        &quot;archive/tar&quot;
           &quot;Content-Disposition&quot; &quot;inline; filename=download.tar&quot;}
 :body    (get-stream)}
</pre>
I am able to trigger a download with the correct file names and content types, but the response is of 0 bytes. What am I doing wrong?</z><z id="t1551791183" t="Empperi You need to provide also Content-Length header"><y>#</y><d>2019-03-05</d><h>13:06</h><w>Empperi</w>You need to provide also Content-Length header</z><z id="t1551791229" t="Empperi Aleph cannot deduce that automatically from stream (in order to do that it would first have to read the whole stream which would make the whole stream pretty pointless)"><y>#</y><d>2019-03-05</d><h>13:07</h><w>Empperi</w>Aleph cannot deduce that automatically from stream (in order to do that it would first have to read the whole stream which would make the whole stream pretty pointless)</z><z id="t1551791249" t="Empperi Thus you need to retrieve that information from somewhere else,"><y>#</y><d>2019-03-05</d><h>13:07</h><w>Empperi</w>Thus you need to retrieve that information from somewhere else,</z><z id="t1551791257" t="Empperi If it is in filesystem, retrieve that data from filesystem"><y>#</y><d>2019-03-05</d><h>13:07</h><w>Empperi</w>If it is in filesystem, retrieve that data from filesystem</z><z id="t1551791271" t="Empperi if it is in database, record the content-length to database when you store it as a blob"><y>#</y><d>2019-03-05</d><h>13:07</h><w>Empperi</w>if it is in database, record the content-length to database when you store it as a blob</z><z id="t1551791308" t="Empperi Also if your file is in the filesystem you can just pass a File object to aleph and it understands what you want to do"><y>#</y><d>2019-03-05</d><h>13:08</h><w>Empperi</w>Also if your file is in the filesystem you can just pass a <code>File</code> object to aleph and it understands what you want to do</z><z id="t1551791330" t="Empperi Aleph will get the file size from filesystem and will send the FIle as a stream to the client"><y>#</y><d>2019-03-05</d><h>13:08</h><w>Empperi</w>Aleph will get the file size from filesystem and will send the <code>FIle</code> as a stream to the client</z><z id="t1551791349" t="Empperi However, if you are calculating the tar file on fly from something else then you need to solve your problem separately"><y>#</y><d>2019-03-05</d><h>13:09</h><w>Empperi</w>However, if you are calculating the tar file on fly from something else then you need to solve your problem separately</z><z id="t1551792416" t="kachayev [:attrs {:href &quot;/_/_/users/U7MRZK43B&quot;}] in fact‚Ä¶ it‚Äôs better not to provide content-length header. In such a case the chance that it would work correctly is actually higher üôÇ If body is represented as an InputStream , Aleph should invoke send-streaming-body that automatically sets ‚ÄúTransfer-Encoding: chunked‚Äù header when content length is not provided manually https://github.com/ztellman/aleph/blob/626bec56dea84ddc5930f8bd9852fc1a236e23f7/src/aleph/http/core.clj#L260 (usually you‚Äôre not able to tell the size of the stream upfront anyways)"><y>#</y><d>2019-03-05</d><h>13:26</h><w>kachayev</w><a>@niklas.collin</a> in fact‚Ä¶ it‚Äôs better not to provide content-length header. In such a case the chance that it would work correctly is actually higher <b>üôÇ</b> If <code>body</code> is represented as an <code>InputStream</code>, Aleph should invoke <code>send-streaming-body</code> that automatically sets ‚ÄúTransfer-Encoding: chunked‚Äù header when content length is not provided manually <a href="https://github.com/ztellman/aleph/blob/626bec56dea84ddc5930f8bd9852fc1a236e23f7/src/aleph/http/core.clj#L260" target="_blank">https://github.com/ztellman/aleph/blob/626bec56dea84ddc5930f8bd9852fc1a236e23f7/src/aleph/http/core.clj#L260</a> (usually you‚Äôre not able to tell the size of the stream upfront anyways)</z><z id="t1551792484" t="kachayev [:attrs {:href &quot;/_/_/users/U7ERLH6JX&quot;}] Do you have any debug information about packets sent? (either from browser or wireshark or similar) So we can check raw request/responses?"><y>#</y><d>2019-03-05</d><h>13:28</h><w>kachayev</w><a>@rahul080327</a> Do you have any debug information about packets sent? (either from browser or wireshark or similar) So we can check raw request/responses?</z><z id="t1551792693" t="lispyclouds [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] So to give some context im building a clojure system over a lib i created. It exposes a path in a docker container as a TarArchiveInputStream. https://github.com/lispyclouds/clj-docker-client/blob/master/src/clj_docker_client/core.clj#L318 This is beacuse the Spotify docker lib im using does it. I want to expose this over HTTP so that a client can download the stuff from the container"><y>#</y><d>2019-03-05</d><h>13:31</h><w>lispyclouds</w><a>@kachayev</a> So to give some context im building a clojure system over a lib i created. It exposes a path in a docker container as a TarArchiveInputStream. <a href="https://github.com/lispyclouds/clj-docker-client/blob/master/src/clj_docker_client/core.clj#L318" target="_blank">https://github.com/lispyclouds/clj-docker-client/blob/master/src/clj_docker_client/core.clj#L318</a>
This is beacuse the Spotify docker lib im using does it. I want to expose this over HTTP so that a client can download the stuff from the container</z><z id="t1551792761" t="lispyclouds This is how i call my lib: (defn get-stream-of &quot;Fetches the TarStream of a path from a container.&quot; [path id] (docker/stream-path e/conn id path)) "><y>#</y><d>2019-03-05</d><h>13:32</h><w>lispyclouds</w>This is how i call my lib:
<pre>(defn get-stream-of
  &quot;Fetches the TarStream of a path from a container.&quot;
  [path id]
  (docker/stream-path e/conn id path))
</pre></z><z id="t1551792814" t="lispyclouds This is my aleph handler: (defn stream-artifact [name group number artifact] (d/let-flow [pipeline (u/name-of name group) id (a/artifact-container-of pipeline number) path (a/get-artifact-path-of pipeline artifact) stream (a/get-stream-of path id)] (if (f/failed? stream) (res/bad-request {:message &quot;No such artifact.&quot;}) {:status 200 :headers {&quot;Content-Type&quot; &quot;archive/tar&quot; &quot;Content-Disposition&quot; (format &quot;inline; filename=%s.tar&quot; artifact)} :body stream}))) "><y>#</y><d>2019-03-05</d><h>13:33</h><w>lispyclouds</w>This is my aleph handler:
<pre>(defn stream-artifact
  [name group number artifact]
  (d/let-flow [pipeline (u/name-of name group)
               id       (a/artifact-container-of pipeline number)
               path     (a/get-artifact-path-of pipeline artifact)
               stream   (a/get-stream-of path id)]
    (if (f/failed? stream)
      (res/bad-request {:message &quot;No such artifact.&quot;})
      {:status  200
       :headers {&quot;Content-Type&quot;        &quot;archive/tar&quot;
                 &quot;Content-Disposition&quot; (format &quot;inline; filename=%s.tar&quot;
                                               artifact)}
       :body    stream})))
</pre></z><z id="t1551792857" t="lispyclouds im able to list all files in if i do it in the REPL. just that i cant send it over http"><y>#</y><d>2019-03-05</d><h>13:34</h><w>lispyclouds</w>im able to list all files in if i do it in the REPL. just that i cant send it over http</z><z id="t1551793055" t="kachayev If you want the browser to start downloading, you need attachment not inline , right?"><y>#</y><d>2019-03-05</d><h>13:37</h><w>kachayev</w>If you want the browser to start downloading, you need <code>attachment</code> not <code>inline</code>, right?</z><z id="t1551793065" t="lispyclouds tried that too"><y>#</y><d>2019-03-05</d><h>13:37</h><w>lispyclouds</w>tried that too</z><z id="t1551793099" t="kachayev inline means that you want this to be shown on the page, which is impossible. Yeah, I known this is not the root of the problem, just noticed"><y>#</y><d>2019-03-05</d><h>13:38</h><w>kachayev</w><code>inline</code> means that you want this to be shown on the page, which is impossible. Yeah, I known this is not the root of the problem, just noticed</z><z id="t1551793184" t="lispyclouds Just tried a curl, totally empty response"><y>#</y><d>2019-03-05</d><h>13:39</h><w>lispyclouds</w>Just tried a curl, totally empty response</z><z id="t1551793235" t="kachayev Could you please show the result of curl -vvv ... ?"><y>#</y><d>2019-03-05</d><h>13:40</h><w>kachayev</w>Could you please show the result of <code>curl -vvv ...</code>?</z><z id="t1551793274" t="lispyclouds $ curl -vvv * Trying ::1... * TCP_NODELAY set * Connected to localhost (::1) port 7777 (#0) &gt; GET /api/pipeline/test/test/1/artifact/source HTTP/1.1 &gt; Host: localhost:7777 &gt; User-Agent: curl/7.54.0 &gt; Accept: */* &gt; &lt; HTTP/1.1 200 OK &lt; Content-Type: archive/tar &lt; Content-Disposition: attachement; filename=source.tar &lt; Server: Aleph/0.4.4 &lt; Connection: Keep-Alive &lt; Date: Tue, 05 Mar 2019 13:40:48 GMT &lt; transfer-encoding: chunked &lt; ‚Ä¢ Connection #0 to host localhost left intact "><y>#</y><d>2019-03-05</d><h>13:41</h><w>lispyclouds</w><pre>$ curl -vvv 
*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 7777 (#0)
&gt; GET /api/pipeline/test/test/1/artifact/source HTTP/1.1
&gt; Host: localhost:7777
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: archive/tar
&lt; Content-Disposition: attachement; filename=source.tar
&lt; Server: Aleph/0.4.4
&lt; Connection: Keep-Alive
&lt; Date: Tue, 05 Mar 2019 13:40:48 GMT
&lt; transfer-encoding: chunked
&lt;
‚Ä¢ Connection #0 to host localhost left intact
</pre></z><z id="t1551793340" t="lispyclouds Dunno if it may help, im using compojure-api for the routing"><y>#</y><d>2019-03-05</d><h>13:42</h><w>lispyclouds</w>Dunno if it may help, im using compojure-api for the routing</z><z id="t1551793400" t="lispyclouds https://github.com/bob-cd/bob/blob/master/src/bob/api/routes.clj these are the routes where im creating a new one"><y>#</y><d>2019-03-05</d><h>13:43</h><w>lispyclouds</w><a href="https://github.com/bob-cd/bob/blob/master/src/bob/api/routes.clj" target="_blank">https://github.com/bob-cd/bob/blob/master/src/bob/api/routes.clj</a> these are the routes where im creating a new one</z><z id="t1551793457" t="kachayev Any chance to upgrade at least to 0.4.6?"><y>#</y><d>2019-03-05</d><h>13:44</h><w>kachayev</w>Any chance to upgrade at least to 0.4.6?</z><z id="t1551793466" t="lispyclouds I can"><y>#</y><d>2019-03-05</d><h>13:44</h><w>lispyclouds</w>I can</z><z id="t1551793481" t="kachayev Let‚Äôs try, this version is ancient üòâ"><y>#</y><d>2019-03-05</d><h>13:44</h><w>kachayev</w>Let‚Äôs try, this version is ancient <b>üòâ</b></z><z id="t1551793504" t="lispyclouds it is at 0.4.6"><y>#</y><d>2019-03-05</d><h>13:45</h><w>lispyclouds</w>it is at 0.4.6</z><z id="t1551793516" t="kachayev &lt; Server: Aleph/0.4.4"><y>#</y><d>2019-03-05</d><h>13:45</h><w>kachayev</w>&lt; Server: Aleph/0.4.4</z><z id="t1551793518" t="lispyclouds https://github.com/bob-cd/bob/blob/master/build.boot#L27"><y>#</y><d>2019-03-05</d><h>13:45</h><w>lispyclouds</w><a href="https://github.com/bob-cd/bob/blob/master/build.boot#L27" target="_blank">https://github.com/bob-cd/bob/blob/master/build.boot#L27</a></z><z id="t1551793546" t="kachayev transitive deps?"><y>#</y><d>2019-03-05</d><h>13:45</h><w>kachayev</w>transitive deps?</z><z id="t1551793563" t="kachayev you‚Äôre cURL response indicates another version"><y>#</y><d>2019-03-05</d><h>13:46</h><w>kachayev</w>you‚Äôre cURL response indicates another version</z><z id="t1551793563" t="lispyclouds not sure where to put it."><y>#</y><d>2019-03-05</d><h>13:46</h><w>lispyclouds</w>not sure where to put it.</z><z id="t1551793588" t="lispyclouds yeah ive noticed it too. saw it with plain standalone aleph projects too"><y>#</y><d>2019-03-05</d><h>13:46</h><w>lispyclouds</w>yeah ive noticed it too. saw it with plain standalone aleph projects too</z><z id="t1551793621" t="lispyclouds but afaik im using 0.4.6"><y>#</y><d>2019-03-05</d><h>13:47</h><w>lispyclouds</w>but afaik im using 0.4.6</z><z id="t1551793678" t="lispyclouds ls ~/.m2/repository/aleph/aleph/ 0.4.6 "><y>#</y><d>2019-03-05</d><h>13:47</h><w>lispyclouds</w><pre>ls ~/.m2/repository/aleph/aleph/
0.4.6
</pre></z><z id="t1551793826" t="kachayev Ah, I see"><y>#</y><d>2019-03-05</d><h>13:50</h><w>kachayev</w>Ah, I see</z><z id="t1551793850" t="kachayev https://github.com/ztellman/aleph/blame/626bec56dea84ddc5930f8bd9852fc1a236e23f7/src/aleph/http/server.clj#L113 this was changed only in 0.4.7-alpha2"><y>#</y><d>2019-03-05</d><h>13:50</h><w>kachayev</w><a href="https://github.com/ztellman/aleph/blame/626bec56dea84ddc5930f8bd9852fc1a236e23f7/src/aleph/http/server.clj#L113" target="_blank">https://github.com/ztellman/aleph/blame/626bec56dea84ddc5930f8bd9852fc1a236e23f7/src/aleph/http/server.clj#L113</a> this was changed only in <code>0.4.7-alpha2</code></z><z id="t1551793857" t="kachayev thisisfine"><y>#</y><d>2019-03-05</d><h>13:50</h><w>kachayev</w><b>thisisfine</b></z><z id="t1551793883" t="lispyclouds aha üòÑ"><y>#</y><d>2019-03-05</d><h>13:51</h><w>lispyclouds</w>aha <b>üòÑ</b></z><z id="t1551794015" t="lispyclouds im not sure if its an aleph problem or something else, have a lot of moving parts in my code. can try it without the compojure-api routing"><y>#</y><d>2019-03-05</d><h>13:53</h><w>lispyclouds</w>im not sure if its an aleph problem or something else, have a lot of moving parts in my code. can try it without the compojure-api routing</z><z id="t1551794063" t="kachayev I doubt it‚Äôs about routing"><y>#</y><d>2019-03-05</d><h>13:54</h><w>kachayev</w>I doubt it‚Äôs about routing</z><z id="t1551794105" t="kachayev Nevertheless, I will try to reproduce locally with just a single tar stream to see how it works"><y>#</y><d>2019-03-05</d><h>13:55</h><w>kachayev</w>Nevertheless, I will try to reproduce locally with just a single tar stream to see how it works</z><z id="t1551794143" t="lispyclouds Thanks a lot for the help! üòÑ you have all the repos there too. lemme know if you need more info"><y>#</y><d>2019-03-05</d><h>13:55</h><w>lispyclouds</w>Thanks a lot for the help! <b>üòÑ</b> you have all the repos there too. lemme know if you need more info</z><z id="t1551794722" t="kachayev [:attrs {:href &quot;/_/_/users/U7ERLH6JX&quot;}] another question, you said you‚Äôre using TarArchiveInputStream but the filename is *.tar ‚Ä¶ what do you want to archive? read file and return as a tar archive? or read an archive and return as unzipped file?"><y>#</y><d>2019-03-05</d><h>14:05</h><w>kachayev</w><a>@rahul080327</a> another question, you said you‚Äôre using <code>TarArchiveInputStream</code> but the <code>filename</code> is <code>*.tar</code>‚Ä¶ what do you want to archive? read file and return as a tar archive? or read an archive and return as unzipped file?</z><z id="t1551794761" t="lispyclouds I wanna return the file itself. a single download, as the path may contain multiple files"><y>#</y><d>2019-03-05</d><h>14:06</h><w>lispyclouds</w>I wanna return the file itself. a single download, as the path may contain multiple files</z><z id="t1551794791" t="lispyclouds the docker lib returns a tar stream of the path. i want to return an archive of that path over http"><y>#</y><d>2019-03-05</d><h>14:06</h><w>lispyclouds</w>the docker lib returns a tar stream of the path. i want to return an archive of that path over http</z><z id="t1551795097" t="kachayev if they‚Äôre reading directory to create a tar‚Ä¶ shouldn‚Äôt that return TarArchiveOutputStream ?"><y>#</y><d>2019-03-05</d><h>14:11</h><w>kachayev</w>if they‚Äôre reading directory to create a tar‚Ä¶ shouldn‚Äôt that return <code>TarArchiveOutputStream</code>?</z><z id="t1551795201" t="lispyclouds https://github.com/spotify/docker-client/blob/master/docs/user_manual.md#get-an-archive-of-a-filesystem-resource-in-a-container"><y>#</y><d>2019-03-05</d><h>14:13</h><w>lispyclouds</w><a href="https://github.com/spotify/docker-client/blob/master/docs/user_manual.md#get-an-archive-of-a-filesystem-resource-in-a-container" target="_blank">https://github.com/spotify/docker-client/blob/master/docs/user_manual.md#get-an-archive-of-a-filesystem-resource-in-a-container</a></z><z id="t1551795235" t="lispyclouds should i convert to an output stream? i was under the impression aleph needs an input stream to send stuff over http"><y>#</y><d>2019-03-05</d><h>14:13</h><w>lispyclouds</w>should i convert to an output stream? i was under the impression aleph needs an input stream to send stuff over http</z><z id="t1551795305" t="kachayev no, but you don‚Äôt need to wrap it in TarArchiveInputStream either"><y>#</y><d>2019-03-05</d><h>14:15</h><w>kachayev</w>no, but you don‚Äôt need to wrap it in <code>TarArchiveInputStream</code> either</z><z id="t1551795341" t="kachayev https://github.com/spotify/docker-client/blob/14b4464fb7acec25073c8c9c564136188f94562c/src/main/java/com/spotify/docker/client/DockerClient.java#L1348 this returns you an InputStream already (they just do a copy and then open you a stream to a copied archive)"><y>#</y><d>2019-03-05</d><h>14:15</h><w>kachayev</w><a href="https://github.com/spotify/docker-client/blob/14b4464fb7acec25073c8c9c564136188f94562c/src/main/java/com/spotify/docker/client/DockerClient.java#L1348" target="_blank">https://github.com/spotify/docker-client/blob/14b4464fb7acec25073c8c9c564136188f94562c/src/main/java/com/spotify/docker/client/DockerClient.java#L1348</a> this returns you an <code>InputStream</code> already (they just do a copy and then open you a stream to a copied archive)</z><z id="t1551795362" t="kachayev You need TarArchiveInputStream *only* in case you want to get raw files (decompressed)"><y>#</y><d>2019-03-05</d><h>14:16</h><w>kachayev</w>You need <code>TarArchiveInputStream</code> *only* in case you want to get raw files (decompressed)</z><z id="t1551795458" t="lispyclouds ah okay. But will this cause an issue for Aleph? TarArchiveInputStream is an InputStream too, so i thought it would be okay"><y>#</y><d>2019-03-05</d><h>14:17</h><w>lispyclouds</w>ah okay. But will this cause an issue for Aleph? TarArchiveInputStream is an InputStream too, so i thought it would be okay</z><z id="t1551795467" t="kachayev this works"><y>#</y><d>2019-03-05</d><h>14:17</h><w>kachayev</w>this works</z><z id="t1551795486" t="kachayev Tried with FileInputStream , - works fine"><y>#</y><d>2019-03-05</d><h>14:18</h><w>kachayev</w>Tried with <code>FileInputStream</code>, - works fine</z><z id="t1551795501" t="kachayev Try this, let me know if it works"><y>#</y><d>2019-03-05</d><h>14:18</h><w>kachayev</w>Try this, let me know if it works</z><z id="t1551795510" t="lispyclouds okay"><y>#</y><d>2019-03-05</d><h>14:18</h><w>lispyclouds</w>okay</z><z id="t1551795527" t="kachayev üëç"><y>#</y><d>2019-03-05</d><h>14:18</h><w>kachayev</w><b>üëç</b></z><z id="t1551795745" t="lispyclouds [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] But these are the constructors of FileInputStream FileInputStream(File file) FileInputStream(FileDescriptor fdObj) FileInputStream(String name) and i have a InputStream"><y>#</y><d>2019-03-05</d><h>14:22</h><w>lispyclouds</w><a>@kachayev</a> But these are the constructors of FileInputStream
FileInputStream(File file)
FileInputStream(FileDescriptor fdObj)
FileInputStream(String name)
and i have a InputStream</z><z id="t1551795759" t="kachayev Right"><y>#</y><d>2019-03-05</d><h>14:22</h><w>kachayev</w>Right</z><z id="t1551795769" t="kachayev I‚Äôve just showed that as an example"><y>#</y><d>2019-03-05</d><h>14:22</h><w>kachayev</w>I‚Äôve just showed that as an example</z><z id="t1551795784" t="kachayev You can set :body to your InputStream"><y>#</y><d>2019-03-05</d><h>14:23</h><w>kachayev</w>You can set <code>:body</code> to your <code>InputStream</code></z><z id="t1551795814" t="lispyclouds okay without the wrapping"><y>#</y><d>2019-03-05</d><h>14:23</h><w>lispyclouds</w>okay without the wrapping</z><z id="t1551795825" t="kachayev Yep, exactly"><y>#</y><d>2019-03-05</d><h>14:23</h><w>kachayev</w>Yep, exactly</z><z id="t1551796151" t="lispyclouds Ah yesss, it works!!"><y>#</y><d>2019-03-05</d><h>14:29</h><w>lispyclouds</w>Ah yesss, it works!!</z><z id="t1551796160" t="lispyclouds Thanks a ton! üòÑ üòÑ"><y>#</y><d>2019-03-05</d><h>14:29</h><w>lispyclouds</w>Thanks a ton! <b>üòÑ</b> <b>üòÑ</b></z><z id="t1551796181" t="kachayev Sure! Let me know if you have more questions. Glad to help"><y>#</y><d>2019-03-05</d><h>14:29</h><w>kachayev</w>Sure! Let me know if you have more questions. Glad to help</z><z id="t1551796215" t="lispyclouds will do. great learnings and kudos for having aleph around!"><y>#</y><d>2019-03-05</d><h>14:30</h><w>lispyclouds</w>will do. great learnings and kudos for having aleph around!</z><z id="t1553679131" t="valerauko is anyone using new relic with aleph?"><y>#</y><d>2019-03-27</d><h>09:32</h><w>valerauko</w>is anyone using new relic with aleph?</z><z id="t1553695082" t="pithyless [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] You may want to ask @seancorfield (who is not in this channel) if you have questions about instrumenting NewRelic."><y>#</y><d>2019-03-27</d><h>13:58</h><r>pithyless</r><a>@UAEH11THP</a> You may want to ask <code>@seancorfield</code> (who is not in this channel) if you have questions about instrumenting NewRelic.</z><z id="t1553696972" t="igrishaev Hi! When sending an HTTP request with aleph, I prefer to wrap http/get into a future. This is to catch some possible exceptions related to a malformed URL, for example. One of my teammates noticed that such a structure consumes two threads that probably leads to a bottleneck. It it really so? clojure (-&gt; (d/future (http/get url)) (d/chain (fn [response] (let [{:keys [headers]} response content-length (get headers &quot;content-length&quot;)] ...))) (d/catch (fn [^Exception e] ...))) "><y>#</y><d>2019-03-27</d><h>14:29</h><w>igrishaev</w>Hi! When sending an HTTP request with aleph, I prefer to wrap <code>http/get</code> into a future. This is to catch some possible exceptions related to a malformed URL, for example. One of my teammates noticed that such a structure consumes two threads that probably leads to a bottleneck. It it really so?


<pre>clojure
(-&gt;

  (d/future
    (http/get url))

  (d/chain

   (fn [response]
     (let [{:keys [headers]} response
           content-length (get headers &quot;content-length&quot;)]
       ...)))

  (d/catch
   (fn [^Exception e]
     ...)))
</pre></z><z id="t1553730163" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] http/get is non-blocking, while d/future uses a thread, so isn&apos;t a good wrapper for http/get . if you are seeing exceptions before the first callback of http/get , what I&apos;ve done in similar circumstances is use a macro which wraps its body in a d/catch and a try ... catch and ensures you always get a Deferred result"><y>#</y><d>2019-03-27</d><h>23:42</h><w>mccraigmccraig</w><a>@igrishaev</a> <code>http/get</code> is non-blocking, while <code>d/future</code> uses a thread, so isn&apos;t a good wrapper for <code>http/get</code>. if you are seeing exceptions before the first callback of <code>http/get</code>, what I&apos;ve done in similar circumstances is use a macro which wraps its body in a <code>d/catch</code> and a <code>try ... catch</code> and ensures you always get a <code>Deferred</code> result</z><z id="t1553730225" t="mccraigmccraig I&apos;m afk atm, I&apos;ll try and post some code tomorrow if that would be helpful"><y>#</y><d>2019-03-27</d><h>23:43</h><w>mccraigmccraig</w>I&apos;m afk atm, I&apos;ll try and post some code tomorrow if that would be helpful</z><z id="t1553752357" t="kachayev Well, technically anything that you run on JVM ‚Äúconsumes‚Äù thread in some meaning of the word ‚Äúconsume‚Äù. Even ‚Äúnon-blocking‚Äù calls. [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] the code you‚Äôve showed is actually doing some redundant work moving computation to manifold.executor/execute-pool . If you just remove d/future it should give you the same final result."><y>#</y><d>2019-03-28</d><h>05:52</h><w>kachayev</w>Well, technically anything that you run on JVM ‚Äúconsumes‚Äù thread in some meaning of the word ‚Äúconsume‚Äù. Even ‚Äúnon-blocking‚Äù calls. <a>@igrishaev</a> the code you‚Äôve showed is actually doing some redundant work moving computation to <code>manifold.executor/execute-pool</code>. If you just remove <code>d/future</code> it should give you the same final result.</z><z id="t1553766387" t="igrishaev one more example: when a URL is nil, I get an exception immediately, like this: (-&gt; (http/get nil) (d/chain (fn [result] :good))) ;; throws Execution error (URISyntaxException) at java.net.URI$Parser/fail But with the following approach, I‚Äôll capture any exception with d/catch: (-&gt; nil (d/chain #(http/get %) (fn [result] :good)) (d/catch (fn [e] :error))) "><y>#</y><d>2019-03-28</d><h>09:46</h><w>igrishaev</w>one more example: when a URL is nil, I get an exception immediately, like this:

<pre>(-&gt; (http/get nil) 
    (d/chain 
     (fn [result] :good)))
;; throws Execution error (URISyntaxException) at java.net.URI$Parser/fail
</pre>

But with the following approach, I‚Äôll capture any exception with d/catch:
<pre>(-&gt; nil 
    
    (d/chain 
     #(http/get %) 
     (fn [result] :good)) 
    
    (d/catch 
        (fn [e] :error)))
</pre></z><z id="t1553766417" t="igrishaev I wonder if the second variant is alright?"><y>#</y><d>2019-03-28</d><h>09:46</h><w>igrishaev</w>I wonder if the second variant is alright?</z><z id="t1553767005" t="igrishaev so the idea is, I‚Äôd like to have only one entry point for all the the exceptions."><y>#</y><d>2019-03-28</d><h>09:56</h><w>igrishaev</w>so the idea is, I‚Äôd like to have only one entry point for all the the exceptions.</z><z id="t1553768642" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] we do that with a macro - our real code would be confusing, &apos;cos it&apos;s got a lot of cross-platform stuff in, but something like this should do it"><y>#</y><d>2019-03-28</d><h>10:24</h><w>mccraigmccraig</w><a>@igrishaev</a> we do that with a macro - our real code would be confusing, &apos;cos it&apos;s got a lot of cross-platform stuff in, but something like this should do it</z><z id="t1553768647" t="mccraigmccraig (defmacro safe-catch [pr-form error-handler] `(manifold.deferred/catch (try ~pr-form (catch Exception x# (manifold.deferred/error-deferred x#))) ~error-handler)) "><y>#</y><d>2019-03-28</d><h>10:24</h><w>mccraigmccraig</w><pre>(defmacro safe-catch
  [pr-form error-handler]
  `(manifold.deferred/catch
       (try
         ~pr-form
         (catch Exception x#
             (manifold.deferred/error-deferred x#)))
       ~error-handler))
</pre></z><z id="t1553768727" t="mccraigmccraig then you have"><y>#</y><d>2019-03-28</d><h>10:25</h><w>mccraigmccraig</w>then you have</z><z id="t1553768733" t="mccraigmccraig (def r (-&gt; (manifold.deferred/success-deferred 1) (manifold.deferred/chain inc) (manifold.deferred/chain (fn [&amp; args] (throw (ex-info &quot;boo&quot; {})))) (safe-catch identity))) "><y>#</y><d>2019-03-28</d><h>10:25</h><w>mccraigmccraig</w><pre>(def r (-&gt; (manifold.deferred/success-deferred 1)
           (manifold.deferred/chain inc)
           (manifold.deferred/chain
            (fn [&amp; args] (throw (ex-info &quot;boo&quot; {}))))
           (safe-catch identity)))
</pre></z><z id="t1553768735" t="mccraigmccraig or"><y>#</y><d>2019-03-28</d><h>10:25</h><w>mccraigmccraig</w>or</z><z id="t1553768743" t="mccraigmccraig (def r (-&gt; (throw (ex-info &quot;boo&quot; {})) (safe-catch identity))) "><y>#</y><d>2019-03-28</d><h>10:25</h><w>mccraigmccraig</w><pre>(def r (-&gt; (throw (ex-info &quot;boo&quot; {}))
           (safe-catch identity)))
</pre></z><z id="t1553768774" t="mccraigmccraig and you get a promise out the end even if the exception happens before the first callback"><y>#</y><d>2019-03-28</d><h>10:26</h><w>mccraigmccraig</w>and you get a promise out the end even if the exception happens before the first callback</z><z id="t1553768827" t="igrishaev yes, that‚Äôs approach is clear to me. I‚Äôm wondering what might be wrong in the second block of code I posted above?"><y>#</y><d>2019-03-28</d><h>10:27</h><w>igrishaev</w>yes, that‚Äôs approach is clear to me. I‚Äôm wondering what might be wrong in the second block of code I posted above?</z><z id="t1553768857" t="igrishaev when you just pass a value and the main function is under a chain"><y>#</y><d>2019-03-28</d><h>10:27</h><w>igrishaev</w>when you just pass a value and the main function is under a chain</z><z id="t1553768906" t="oyakushev Sorry, missed the threading."><y>#</y><d>2019-03-28</d><h>10:28</h><w>oyakushev</w>Sorry, missed the threading.</z><z id="t1553768948" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] no, it throws immediately, but the error is caught and returned as an errored promise"><y>#</y><d>2019-03-28</d><h>10:29</h><w>mccraigmccraig</w><a>@alexyakushev</a> no, it throws immediately, but the error is caught and returned as an errored promise</z><z id="t1553768969" t="igrishaev yes, so would be great to hear your thoughts on that"><y>#</y><d>2019-03-28</d><h>10:29</h><w>igrishaev</w>yes, so would be great to hear your thoughts on that</z><z id="t1553769048" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] i like the &quot;always use safe-catch rather than catch &quot; approach because it&apos;s easy to find violations with ag... but chaining a simple value should also work fine"><y>#</y><d>2019-03-28</d><h>10:30</h><w>mccraigmccraig</w><a>@igrishaev</a> i like the &quot;always use <code>safe-catch</code> rather than <code>catch</code>&quot; approach because it&apos;s easy to find violations with ag... but chaining a simple value should also work fine</z><z id="t1553769106" t="mccraigmccraig and when you get into more complex scenarios with some other promise which you need to compose on to... having a catch which works in all situations is nice"><y>#</y><d>2019-03-28</d><h>10:31</h><w>mccraigmccraig</w>and when you get into more complex scenarios with some other promise which you need to compose on to... having a <code>catch</code> which works in all situations is nice</z><z id="t1553769760" t="igrishaev ok I made my own version of your macro: (defmacro with-catch [&amp; body] `(try ~@body (catch Throwable e# (d/error-deferred e#)))) so the chain body looks like: (-&gt; (with-catch (http/get url http-options)) (d/chain (fn [response] (let [{:keys [body headers]} response content-length (get headers &quot;content-length&quot;)] ... "><y>#</y><d>2019-03-28</d><h>10:42</h><w>igrishaev</w>ok I made my own version of your macro:

<pre>(defmacro with-catch
  [&amp; body]
  `(try
     ~@body
     (catch Throwable e#
       (d/error-deferred e#))))
</pre>

so the chain body looks like:

<pre>(-&gt;

       (with-catch
         (http/get url http-options))

       (d/chain

        (fn [response]

          (let [{:keys [body headers]} response
                content-length (get headers &quot;content-length&quot;)]
...
</pre></z><z id="t1553769990" t="mccraigmccraig well that will work - but you will have an uncaught errored promise at the end... so you&apos;ll perhaps want a d/catch too ? i like the &quot;you don&apos;t have to think about it anymore&quot; aspect of the safe-catch macro approach, and the way it has the same shape as the d/catch fn and plays the same way with threading"><y>#</y><d>2019-03-28</d><h>10:46</h><w>mccraigmccraig</w>well that will work - but you will have an uncaught errored promise at the end... so you&apos;ll perhaps want a <code>d/catch</code> too ? i like the &quot;you don&apos;t have to think about it anymore&quot; aspect of the <code>safe-catch</code> macro approach, and the way it has the same shape as the <code>d/catch</code> fn and plays the same way with threading</z><z id="t1553770062" t="igrishaev There is a d/catch at the bottom, I didn‚Äôt put it here"><y>#</y><d>2019-03-28</d><h>10:47</h><w>igrishaev</w>There is a <code>d/catch</code> at the bottom, I didn‚Äôt put it here</z><z id="t1553770089" t="igrishaev I always finish the chain like with a common d/chain handler"><y>#</y><d>2019-03-28</d><h>10:48</h><w>igrishaev</w>I always finish the chain like with a common d/chain handler</z><z id="t1553770219" t="mccraigmccraig with safe-catch then you can just replace the d/catch with the safe-catch and you get everything"><y>#</y><d>2019-03-28</d><h>10:50</h><w>mccraigmccraig</w>with <code>safe-catch</code> then you can just replace the <code>d/catch</code> with the <code>safe-catch</code> and you get everything</z><z id="t1553770240" t="igrishaev the whole pipeline in my example would be: (-&gt; (with-catch (http/get url http-options)) (d/chain (fn [response] (:body response))) (fn [body] (process-the-body body)) (d/catch (fn [^Exception e] (reporn-error e)))) "><y>#</y><d>2019-03-28</d><h>10:50</h><w>igrishaev</w>the whole pipeline in my example would be:

<pre>(-&gt;

 (with-catch
     (http/get url http-options))

 (d/chain

  (fn [response]
      (:body response)))
 
  (fn [body]
    (process-the-body body))

 (d/catch
  (fn [^Exception e]
    (reporn-error e))))
</pre></z><z id="t1553770581" t="igrishaev And also, can anyone help me with d/loop ? I‚Äôm a bit confused with it. What I‚Äôm going to do is to poll Kafka and feed messages from it to a stream. That stream should be processes by several workers. I‚Äôm not sure about how to build a d/loop logic."><y>#</y><d>2019-03-28</d><h>10:56</h><w>igrishaev</w>And also, can anyone help me with <code>d/loop</code>? I‚Äôm a bit confused with it. What I‚Äôm going to do is to poll Kafka and feed messages from it to a stream. That stream should be processes by several workers. I‚Äôm not sure about how to build a d/loop logic.</z><z id="t1553770628" t="igrishaev Inside d/loop, I‚Äôve got a d/chain clause that polls a consumer. However, this approach is blocking."><y>#</y><d>2019-03-28</d><h>10:57</h><w>igrishaev</w>Inside d/loop, I‚Äôve got a d/chain clause that polls a consumer. However, this approach is blocking.</z><z id="t1553770684" t="igrishaev (-&gt; nil (d/chain (fn [&amp; _] (consumer/poll! consumer poll-timeout)) (fn [messages] (when-not (empty? messages) (s/put-all! stream messages)))) (d/catch (fn [^Throwable e] (report-exeption e {:topic topic}))) (d/chain (fn [&amp; _] (d/recur)))) "><y>#</y><d>2019-03-28</d><h>10:58</h><w>igrishaev</w><pre>(-&gt;

 nil

 (d/chain

  (fn [&amp; _]
      (consumer/poll! consumer poll-timeout))

  (fn [messages]
      (when-not (empty? messages)
                (s/put-all! stream messages))))

 (d/catch
  (fn [^Throwable e]
      (report-exeption e {:topic topic})))

 (d/chain
  (fn [&amp; _]
      (d/recur))))
</pre></z><z id="t1553770719" t="igrishaev But when I move polling into d/future , that works:"><y>#</y><d>2019-03-28</d><h>10:58</h><w>igrishaev</w>But when I move polling into <code>d/future</code>, that works:</z><z id="t1553770745" t="igrishaev (-&gt; (d/future (consumer/poll! consumer poll-timeout)) (d/chain (fn [messages] (when-not (empty? messages) (s/put-all! stream messages)))) (d/catch (fn [^Throwable e] (report-exeption e {:topic topic}))) (d/chain (fn [&amp; _] (d/recur)))) "><y>#</y><d>2019-03-28</d><h>10:59</h><w>igrishaev</w><pre>(-&gt;

 (d/future
   (consumer/poll! consumer poll-timeout))

 (d/chain

  (fn [messages]
      (when-not (empty? messages)
                (s/put-all! stream messages))))

 (d/catch
  (fn [^Throwable e]
      (report-exeption e {:topic topic})))

 (d/chain
  (fn [&amp; _]
      (d/recur))))
</pre></z><z id="t1553770798" t="igrishaev So my question is, why does the first variant block the main thread?"><y>#</y><d>2019-03-28</d><h>10:59</h><w>igrishaev</w>So my question is, why does the first variant block the main thread?</z><z id="t1553772284" t="igrishaev btw [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] thank you fore sharing your macro. Only now I‚Äôve got what‚Äôs behind it, I‚Äôm a bit slow."><y>#</y><d>2019-03-28</d><h>11:24</h><w>igrishaev</w>btw <a>@mccraigmccraig</a> thank you fore sharing your macro. Only now I‚Äôve got what‚Äôs behind it, I‚Äôm a bit slow.</z><z id="t1553782330" t="igrishaev anyone familiar with aleph-http stuff, could you take a look please? https://github.com/ztellman/aleph/issues/500"><y>#</y><d>2019-03-28</d><h>14:12</h><w>igrishaev</w>anyone familiar with aleph-http stuff, could you take a look please?
<a href="https://github.com/ztellman/aleph/issues/500" target="_blank">https://github.com/ztellman/aleph/issues/500</a></z><z id="t1553782338" t="igrishaev (get!)"><y>#</y><d>2019-03-28</d><h>14:12</h><w>igrishaev</w>(get!)</z><z id="t1553789819" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] hmm - i&apos;ve not seen this, and we often upload mobile video files which can get quite large - i wonder why your connection is being closed ?"><y>#</y><d>2019-03-28</d><h>16:16</h><w>mccraigmccraig</w><a>@igrishaev</a> hmm - i&apos;ve not seen this, and we often upload mobile video files which can get quite large - i wonder why your connection is being closed ?</z><z id="t1553789865" t="igrishaev so am I, really. I even managed to reproduce that in repl"><y>#</y><d>2019-03-28</d><h>16:17</h><w>igrishaev</w>so am I, really. I even managed to reproduce that in repl</z><z id="t1553789938" t="igrishaev first, get stream from http/get , then wrap it with AWS stream what counts the number of bytes consumed"><y>#</y><d>2019-03-28</d><h>16:18</h><w>igrishaev</w>first, get stream from <code>http/get</code>, then wrap it with AWS stream what counts the number of bytes consumed</z><z id="t1553789970" t="igrishaev then read that wrapped stream in a loop into a byte-array"><y>#</y><d>2019-03-28</d><h>16:19</h><w>igrishaev</w>then read that wrapped stream in a loop into a byte-array</z><z id="t1553789990" t="igrishaev and it time the exception will araise"><y>#</y><d>2019-03-28</d><h>16:19</h><w>igrishaev</w>and it time the exception will araise</z><z id="t1553790248" t="mccraigmccraig one thing i remember from way back... we don&apos;t stream directly to S3, we go via a tmpfile first - and we had terrible trouble (with the sort of random truncation errors you are seeing) until we started using the :raw-stream? option and doing things async https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/http.clj#L177"><y>#</y><d>2019-03-28</d><h>16:24</h><w>mccraigmccraig</w>one thing i remember from way back... we don&apos;t stream directly to S3, we go via a tmpfile first - and we had terrible trouble (with the sort of random truncation errors you are seeing) until we started using the <code>:raw-stream?</code> option and doing things async <a href="https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/http.clj#L177" target="_blank">https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/http.clj#L177</a></z><z id="t1553790269" t="mccraigmccraig but we&apos;ve got #yada in between us and raw #aleph so it may have been some other problem"><y>#</y><d>2019-03-28</d><h>16:24</h><w>mccraigmccraig</w>but we&apos;ve got #yada in between us and raw #aleph so it may have been some other problem</z><z id="t1553791647" t="hiredman if you haven&apos;t considered/are not aware of multipart uploads to s3, I would suggest checking those out. instead of having to deal with figuring out the size from a stream you can upload fixed size chunks"><y>#</y><d>2019-03-28</d><h>16:47</h><w>hiredman</w>if you haven&apos;t considered/are not aware of multipart uploads to s3, I would suggest checking those out. instead of having to deal with figuring out the size from a stream you can upload fixed size chunks</z><z id="t1553792423" t="igrishaev [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] I‚Äôm a bit confused about how to turn a raw-stream into a intputStream that AWS needs?"><y>#</y><d>2019-03-28</d><h>17:00</h><w>igrishaev</w><a>@mccraigmccraig</a> I‚Äôm a bit confused about how to turn a raw-stream into a intputStream that AWS needs?</z><z id="t1553792500" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] i haven&apos;t tried - we just wrote the bytes from the raw-stream to a tmpfile and then gave the whole tmpfile to the s3 uploader"><y>#</y><d>2019-03-28</d><h>17:01</h><w>mccraigmccraig</w><a>@igrishaev</a> i haven&apos;t tried - we just wrote the bytes from the raw-stream to a tmpfile and then gave the whole tmpfile to the s3 uploader</z><z id="t1553792550" t="igrishaev [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] I see, but it won‚Äôt apply in my case. I‚Äôve got to do the whole stuff in memory"><y>#</y><d>2019-03-28</d><h>17:02</h><w>igrishaev</w><a>@mccraigmccraig</a> I see, but it won‚Äôt apply in my case. I‚Äôve got to do the whole stuff in memory</z><z id="t1553792581" t="igrishaev but I put a comment in the issue, I figured out with clj-http"><y>#</y><d>2019-03-28</d><h>17:03</h><w>igrishaev</w>but I put a comment in the issue, I figured out with <code>clj-http</code></z><z id="t1553792630" t="igrishaev when you pass {:as :stream} , the connection won‚Äôt close until you consume it till the end"><y>#</y><d>2019-03-28</d><h>17:03</h><w>igrishaev</w>when you pass <code>{:as :stream}</code>, the connection won‚Äôt close until you consume it till the end</z><z id="t1553794468" t="hiredman also, I am pretty sure using multipart uploading is the only way to get true streaming, I think (I am not 100% sure) the cognitect aws-api clients turn inputstreams into byte arrays (read them all in as one big one) when passed"><y>#</y><d>2019-03-28</d><h>17:34</h><w>hiredman</w>also, I am pretty sure using multipart uploading is the only way to get true streaming, I think (I am not 100% sure) the cognitect aws-api clients turn inputstreams into byte arrays (read them all in as one big one) when passed</z><z id="t1553794544" t="hiredman https://github.com/cognitect-labs/aws-api/blob/master/src/cognitect/aws/client.clj#L75 and https://github.com/cognitect-labs/aws-api/blob/master/src/cognitect/aws/util.clj#L135 (but I have just started using the library myself so I am not sure)"><y>#</y><d>2019-03-28</d><h>17:35</h><w>hiredman</w><a href="https://github.com/cognitect-labs/aws-api/blob/master/src/cognitect/aws/client.clj#L75" target="_blank">https://github.com/cognitect-labs/aws-api/blob/master/src/cognitect/aws/client.clj#L75</a> and <a href="https://github.com/cognitect-labs/aws-api/blob/master/src/cognitect/aws/util.clj#L135" target="_blank">https://github.com/cognitect-labs/aws-api/blob/master/src/cognitect/aws/util.clj#L135</a> (but I have just started using the library myself so I am not sure)</z><z id="t1556297612" t="jmromrell Can I rely on a manifold stream as a response to a web request to behave as a delay (meaning no execution of its content until it is realized after being handled by middleware)?"><y>#</y><d>2019-04-26</d><h>16:53</h><w>jmromrell</w>Can I rely on a manifold stream as a response to a web request to behave as a delay (meaning no execution of its content until it is realized after being handled by middleware)?</z><z id="t1556297706" t="jmromrell I&apos;m wanting to write auth middleware which relies on this property and enforces authentication/authorization after the response is being passed back up the middleware chain, rather than checking auth before the handler is reached."><y>#</y><d>2019-04-26</d><h>16:55</h><w>jmromrell</w>I&apos;m wanting to write auth middleware which relies on this property and enforces authentication/authorization after the response is being passed back up the middleware chain, rather than checking auth before the handler is reached.</z><z id="t1556297770" t="jmromrell I have been running into issues with compojure where if I try to handle auth in middleware as the request is coming in, it will end up enforcing auth even if the request didn&apos;t match any of the routes I was trying to implement auth for."><y>#</y><d>2019-04-26</d><h>16:56</h><w>jmromrell</w>I have been running into issues with compojure where if I try to handle auth in middleware as the request is coming in, it will end up enforcing auth even if the request didn&apos;t match any of the routes I was trying to implement auth for.</z><z id="t1556438227" t="valerauko This could be resolved by using #reitit instead which has per-route middleware"><y>#</y><d>2019-04-28</d><h>07:57</h><r>valerauko</r>This could be resolved by using #reitit instead which has per-route middleware</z><z id="t1556297837" t="jmromrell But if I delay checking auth until after a handler returns something (so I know a route was matched), then the handler has already executed the contents regardless of if the user were authenticated/authorized."><y>#</y><d>2019-04-26</d><h>16:57</h><w>jmromrell</w>But if I delay checking auth until after a handler returns something (so I know a route was matched), then the handler has already executed the contents regardless of if the user were authenticated/authorized.</z><z id="t1559127183" t="valerauko anyone knows how many simultaneous websocket connections can aleph handle at most?"><y>#</y><d>2019-05-29</d><h>10:53</h><w>valerauko</w>anyone knows how many simultaneous websocket connections can aleph handle at most?</z><z id="t1559334318" t="lmergen I don‚Äôt think there is any built in limit but it‚Äôs more a limit of your OS and/or netty. "><y>#</y><d>2019-05-31</d><h>20:25</h><w>lmergen</w>I don‚Äôt think there is any built in limit but it‚Äôs more a limit of your OS and/or netty. </z><z id="t1560129377" t="mss poking around aleph and I‚Äôm wondering what the shutdown api for a server is, if any? don‚Äôt see anything in the codox related to shutdown"><y>#</y><d>2019-06-10</d><h>01:16</h><w>mss</w>poking around aleph and I‚Äôm wondering what the shutdown api for a server is, if any? don‚Äôt see anything in the codox related to shutdown</z><z id="t1560140893" t="kardan (.close server)"><y>#</y><d>2019-06-10</d><h>04:28</h><w>kardan</w>(.close server)</z><z id="t1560140903" t="kardan Where server is returned from start-server"><y>#</y><d>2019-06-10</d><h>04:28</h><w>kardan</w>Where server is returned from start-server</z><z id="t1560191187" t="mss perfect, thanks!"><y>#</y><d>2019-06-10</d><h>18:26</h><w>mss</w>perfect, thanks!</z><z id="t1562579440" t="dimovich Hello all"><y>#</y><d>2019-07-08</d><h>09:50</h><w>dimovich</w>Hello all</z><z id="t1562579462" t="dimovich did anyone bump into this kind of error? any tips appreciated"><y>#</y><d>2019-07-08</d><h>09:51</h><w>dimovich</w>did anyone bump into this kind of error? any tips appreciated</z><z id="t1562579489" t="dimovich"><y>#</y><d>2019-07-08</d><h>09:51</h><w>dimovich</w></z><z id="t1562579655" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U051951T6&quot;}] looking at the stacktrace you are attempting to use a vanilla ring middleware which doesn&apos;t support Deferred responses"><y>#</y><d>2019-07-08</d><h>09:54</h><w>mccraigmccraig</w><a>@dimovich</a> looking at the stacktrace you are attempting to use a vanilla ring middleware which doesn&apos;t support <code>Deferred</code> responses</z><z id="t1563127748" t="dimovich [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] What&apos;s the best approach here? Only thing that I see possible is to wrap my initial handler with a middleware that will dereference the Deferred."><y>#</y><d>2019-07-14</d><h>18:09</h><r>dimovich</r><a>@mccraigmccraig</a> What&apos;s the best approach here? Only thing that I see possible is to wrap my initial handler with a middleware that will dereference the Deferred.</z><z id="t1563128023" t="mccraigmccraig derefing is pretty much a no-no for an async program - you will block a thread and possibly cause a deadlock (the only places derefing makes sense are in the repl and maybe in a sync test driving async code). either find a different middleware which is async compatible, or copy the existing middleware and modify it to be async friendly"><y>#</y><d>2019-07-14</d><h>18:13</h><r>mccraigmccraig</r>derefing is pretty much a no-no for an async program - you will block a thread and possibly cause a deadlock (the only places derefing makes sense are in the repl and maybe in a sync test driving async code). either find a different middleware which is async compatible, or copy the existing middleware and modify it to be async friendly</z><z id="t1563140003" t="dimovich thank you for the tips! will experiment with that."><y>#</y><d>2019-07-14</d><h>21:33</h><r>dimovich</r>thank you for the tips! will experiment with that.</z><z id="t1562579668" t="oyakushev Apparently, your handler returns a Deferred, but you have some Ring middleware that post-processes the response."><y>#</y><d>2019-07-08</d><h>09:54</h><w>oyakushev</w>Apparently, your handler returns a Deferred, but you have some Ring middleware that post-processes the response.</z><z id="t1563127578" t="dimovich [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] yes, ring.middleware.session/wrap-session is trying to read the Deferred response and fails. Seems there is a project that provides async versions of middlewares -- https://github.com/muhuk/aleph-middleware"><y>#</y><d>2019-07-14</d><h>18:06</h><r>dimovich</r><a>@alexyakushev</a> yes, <code>ring.middleware.session/wrap-session</code> is trying to read the Deferred response and fails. Seems there is a project that provides async versions of middlewares -- <a href="https://github.com/muhuk/aleph-middleware" target="_blank">https://github.com/muhuk/aleph-middleware</a></z><z id="t1562579732" t="dimovich [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] thanks!"><y>#</y><d>2019-07-08</d><h>09:55</h><w>dimovich</w><a>@mccraigmccraig</a> <a>@alexyakushev</a> thanks!</z><z id="t1563071986" t="runeb Trying to get timeouts to work in tcp server. Following examples and documentation, yet (s/connect a b {:timeout 5000}) never times out (according to doc, this would be a 5 second timeout). I connect to the server by regular telnet from terminal, but I am never kicked off. Anyone have a clue what goes south?"><y>#</y><d>2019-07-14</d><h>02:39</h><w>runeb</w>Trying to get timeouts to work in tcp server. Following examples and documentation, yet <pre>(s/connect a b {:timeout 5000})</pre> never times out (according to doc, this would be  a 5 second timeout). I connect to the server by regular telnet from terminal, but I am never kicked off. Anyone have a clue what goes south?</z><z id="t1563080963" t="hiredman Timeout there likely means tcp socket timeout"><y>#</y><d>2019-07-14</d><h>05:09</h><w>hiredman</w>Timeout there likely means tcp socket timeout</z><z id="t1563081029" t="hiredman Which is below the level of say telnet"><y>#</y><d>2019-07-14</d><h>05:10</h><w>hiredman</w>Which is below the level of say telnet</z><z id="t1563094675" t="runeb [:attrs {:href &quot;/_/_/users/U0NCTKEV8&quot;}] aha.. that might be the reason. A bit unclear from the documentation in that case what is meant by &apos;timeout&apos;. I will run with this assumption. Thank you for you input!"><y>#</y><d>2019-07-14</d><h>08:57</h><w>runeb</w><a>@hiredman</a> aha.. that might be the reason. A bit unclear from the documentation in that case what is meant by &apos;timeout&apos;. I will run with this assumption. Thank you for you input!</z><z id="t1563168170" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U5VH0SALC&quot;}] dyu mean you added a :timeout to the fast-echo-handler example s/connect ?"><y>#</y><d>2019-07-15</d><h>05:22</h><w>mccraigmccraig</w><a>@runeb</a> dyu mean you added a <code>:timeout</code> to the <code>fast-echo-handler</code> example <code>s/connect</code> ?</z><z id="t1563223060" t="runeb [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] yes, precisely. I think the response from [:attrs {:href &quot;/_/_/users/U0NCTKEV8&quot;}] explains perfectly why I did not see what I initially expected (timeout when lack of incoming data). If timeout is meant to address the tcp layer it makes sense."><y>#</y><d>2019-07-15</d><h>20:37</h><w>runeb</w><a>@mccraigmccraig</a> yes, precisely. I think the response from <a>@hiredman</a> explains perfectly why I did not see what I initially expected (timeout when lack of incoming data). If timeout is meant to address the tcp layer it makes sense.</z><z id="t1563224170" t="mccraigmccraig manifold.stream/connect :timeout doesn&apos;t address the tcp layer... it&apos;s timing out a connection between streams, which in the case of the fast-echo-handler is a connection between the rx and tx sides of the tcp socket, but it&apos;s not a tcp layer timeout"><y>#</y><d>2019-07-15</d><h>20:56</h><w>mccraigmccraig</w><code>manifold.stream/connect :timeout</code> doesn&apos;t address the tcp layer... it&apos;s timing out a connection between streams, which in the case of the <code>fast-echo-handler</code> is a connection between the rx and tx sides of the tcp socket, but it&apos;s not a tcp layer timeout</z><z id="t1563225102" t="runeb [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] hmmm in my test case outlined originally (connecting to the handler by way of telnet). Should I expect to see a disconnect from said time out in case I dont touch the keyboard?"><y>#</y><d>2019-07-15</d><h>21:11</h><w>runeb</w><a>@mccraigmccraig</a> hmmm in my test case outlined originally (connecting to the handler by way of telnet). Should I expect to see a disconnect from said time out in case I dont touch the keyboard?</z><z id="t1563225854" t="mccraigmccraig no, i don&apos;t think so - the only thing being disconnected is the connection between the two streams based on the underlying socket channels - i don&apos;t think stream/connect :timeout closes its source or sink"><y>#</y><d>2019-07-15</d><h>21:24</h><w>mccraigmccraig</w>no, i don&apos;t think so - the only thing being disconnected is the connection between the two streams based on the underlying socket channels - i don&apos;t think <code>stream/connect :timeout</code> closes its source or sink</z><z id="t1563225888" t="mccraigmccraig do you observe that it stops echoing after the timeout?"><y>#</y><d>2019-07-15</d><h>21:24</h><w>mccraigmccraig</w>do you observe that it stops echoing after the timeout?</z><z id="t1563226914" t="runeb They dont close as far as i cant tell. I set the flags for closing also. I would like to see a disconnect on the telnet side. I need to kick clients that are not chatting for some set period and thought timeout was the answer. I made a watchdog to check &quot;chattiness&quot; of each connection and closing those that fail the timeout threshold. I am curious if this is the expected way of handling such conditions. I am not so sure what benefit I get from the current behavior of timeout? To set tcp socket timeout pr connection instead of on a system level? Do you know?"><y>#</y><d>2019-07-15</d><h>21:41</h><w>runeb</w>They dont close as far as i cant tell. I set the flags for closing also. I would like to see a disconnect on the telnet side. I need to kick clients that are not chatting for some set period and thought timeout was the answer. I made a watchdog to check &quot;chattiness&quot; of each connection and closing those that fail the timeout threshold. I am curious if this is the expected way of handling such conditions. I am not so sure what benefit I get from the current behavior of timeout? To set tcp socket timeout pr connection instead of on a system level? Do you know?</z><z id="t1563226956" t="runeb Hope I make sense üôÇ"><y>#</y><d>2019-07-15</d><h>21:42</h><w>runeb</w>Hope I make sense <b>üôÇ</b></z><z id="t1563230855" t="mccraigmccraig can you show some code [:attrs {:href &quot;/_/_/users/U5VH0SALC&quot;}] ? easier to understand then..."><y>#</y><d>2019-07-15</d><h>22:47</h><w>mccraigmccraig</w>can you show some code <a>@runeb</a>? easier to understand then...</z><z id="t1563307310" t="geraldodev hi, Could someone explain why the 24 line of aleph-middleware invokes (handler req) out of a chain ? Why content-type-response needs to be called using (d/chain&apos;) and (handler req) does not ?"><y>#</y><d>2019-07-16</d><h>20:01</h><w>geraldodev</w>hi, Could someone explain why the 24 line of aleph-middleware invokes (handler req) out of a chain ? Why content-type-response needs to be called using (d/chain&apos;) and (handler req)  does not ?</z><z id="t1563307927" t="geraldodev https://github.com/muhuk/aleph-middleware/blob/master/src/aleph/middleware/util.clj#L11 defer implementation"><y>#</y><d>2019-07-16</d><h>20:12</h><w>geraldodev</w><a href="https://github.com/muhuk/aleph-middleware/blob/master/src/aleph/middleware/util.clj#L11" target="_blank">https://github.com/muhuk/aleph-middleware/blob/master/src/aleph/middleware/util.clj#L11</a> defer implementation</z><z id="t1563345501" t="oyakushev [:attrs {:href &quot;/_/_/users/U0516053R&quot;}] content-type-response is a standard Ring middleware that accepts a handler request -&gt; response and returns an updated handler request -&gt; response . Response in assumed to be a steady here-and-now value, so the middleware can access it and modify at will. Aleph, however, allows the handler to return not only response , but also (deferred response) . Ring middleware out-of-the-box doesn&apos;t know what to do with deferreds, that it has to chain callbacks onto them rather than call functions directly. So, this defer function transforms a regular Ring middleware into deferred-aware middleware."><y>#</y><d>2019-07-17</d><h>06:38</h><w>oyakushev</w><a>@geraldodev</a> <code>content-type-response</code> is a standard Ring middleware that accepts a handler <code>request -&gt; response</code> and returns an updated handler <code>request -&gt; response</code>. Response in assumed to be a steady here-and-now value, so the middleware can access it and modify at will.

Aleph, however, allows the handler to return not only <code>response</code>, but also <code>(deferred response)</code>. Ring middleware out-of-the-box doesn&apos;t know what to do with deferreds, that it has to chain callbacks onto them rather than call functions directly. So, this <code>defer</code> function transforms a regular Ring middleware into deferred-aware middleware.</z><z id="t1563345619" t="oyakushev Answering your exact question, (handler req) can be invoked directly because req cannot be a deferred, it&apos;s always a concrete value."><y>#</y><d>2019-07-17</d><h>06:40</h><w>oyakushev</w>Answering your exact question, <code>(handler req)</code> can be invoked directly because <code>req</code> cannot be a deferred, it&apos;s always a concrete value.</z><z id="t1563346753" t="dimovich [:attrs {:href &quot;/_/_/users/U0516053R&quot;}] The request comes in as a Netty request, while the response is a Deferred, so that&apos;s why we&apos;re chaining only the response, to be able to access its content."><y>#</y><d>2019-07-17</d><h>06:59</h><w>dimovich</w><a>@geraldodev</a> The request comes in as a Netty request, while the response is a Deferred, so that&apos;s why we&apos;re chaining only the response, to be able to access its content.</z><z id="t1563346848" t="dimovich [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] wonder if its possible to use Ring&apos;s async handler arity to chain the deferred callbacks, instead of changing the middleware handlers."><y>#</y><d>2019-07-17</d><h>07:00</h><w>dimovich</w><a>@alexyakushev</a> wonder if its possible to use Ring&apos;s async handler arity to chain the deferred callbacks, instead of changing the middleware handlers.</z><z id="t1563361519" t="oyakushev I never tried Ring async arity, so I&apos;m not sure how complete and usable it is."><y>#</y><d>2019-07-17</d><h>11:05</h><w>oyakushev</w>I never tried Ring async arity, so I&apos;m not sure how complete and usable it is.</z><z id="t1563361592" t="oyakushev [:attrs {:href &quot;/_/_/users/U051951T6&quot;}] The request actually comes as a Ring request, it is transformed from Netty request to Ring request inside Aleph."><y>#</y><d>2019-07-17</d><h>11:06</h><w>oyakushev</w><a>@dimovich</a> The request actually comes as a Ring request, it is transformed from Netty request to Ring request inside Aleph.</z><z id="t1563361660" t="oyakushev Or you can say it&apos;s a NettyRequest implementation-wise, but for the purposes of using Ring it&apos;s a valid up-to-spec Ring request."><y>#</y><d>2019-07-17</d><h>11:07</h><w>oyakushev</w>Or you can say it&apos;s a NettyRequest implementation-wise, but for the purposes of using Ring it&apos;s a valid up-to-spec Ring request.</z><z id="t1563436032" t="ikitommi Ring expects the response to be map, so there should be a custom middleware before each component (handler or middleware) that converts Deferred into map so the next step sees a map"><y>#</y><d>2019-07-18</d><h>07:47</h><w>ikitommi</w>Ring expects the response to be map, so there should be a custom middleware before each component (handler or middleware) that converts Deferred into map so the next step sees a map</z><z id="t1563436107" t="ikitommi if only handler emits Deferreds, just add that mw just before the handler and you are good to go."><y>#</y><d>2019-07-18</d><h>07:48</h><w>ikitommi</w>if only handler emits Deferreds, just add that mw just before the handler and you are good to go.</z><z id="t1563436343" t="ikitommi like https://github.com/ztellman/aleph/pull/442 , but the other way around"><y>#</y><d>2019-07-18</d><h>07:52</h><w>ikitommi</w>like <a href="https://github.com/ztellman/aleph/pull/442" target="_blank">https://github.com/ztellman/aleph/pull/442</a>, but the other way around</z><z id="t1563436396" t="ikitommi maybe that mw could be added to aleph?"><y>#</y><d>2019-07-18</d><h>07:53</h><w>ikitommi</w>maybe that mw could be added to aleph?</z><z id="t1563436494" t="ikitommi at least reitit-ring allows one to manipulate the mw chain at creation time, so one could interleave easily such mw between all other mw."><y>#</y><d>2019-07-18</d><h>07:54</h><w>ikitommi</w>at least reitit-ring allows one to manipulate the mw chain at creation time, so one could interleave easily  such mw between all other mw.</z><z id="t1563436548" t="ikitommi (not saying it&apos;s a good idea, just possible)"><y>#</y><d>2019-07-18</d><h>07:55</h><w>ikitommi</w>(not saying it&apos;s a good idea, just possible)</z><z id="t1563462194" t="dimovich [:attrs {:href &quot;/_/_/users/U055NJ5CC&quot;}] Do you mean a mw that would deref the incoming response and pass the plain map to the next handler?"><y>#</y><d>2019-07-18</d><h>15:03</h><w>dimovich</w><a>@ikitommi</a> Do you mean a mw that would deref the incoming response and pass the plain map to the next handler?</z><z id="t1563514126" t="ikitommi [:attrs {:href &quot;/_/_/users/U051951T6&quot;}] no deref, with async ring, hook the deferred success and error to ring&apos;s respond and raise."><y>#</y><d>2019-07-19</d><h>05:28</h><w>ikitommi</w><a>@dimovich</a> no deref, with async ring, hook the deferred success and error to ring&apos;s respond and raise.</z><z id="t1563660228" t="dimovich [:attrs {:href &quot;/_/_/users/U055NJ5CC&quot;}] something like this? Works for me also when the ring-handler returns mixed responses - plain maps and deferreds. https://gist.github.com/dimovich/3f9cd75a21e5073bffc703f2417b136d"><y>#</y><d>2019-07-20</d><h>22:03</h><w>dimovich</w><a>@ikitommi</a> something like this? Works for me also when the ring-handler returns mixed responses - plain maps and deferreds. <a href="https://gist.github.com/dimovich/3f9cd75a21e5073bffc703f2417b136d" target="_blank">https://gist.github.com/dimovich/3f9cd75a21e5073bffc703f2417b136d</a></z><z id="t1563660229" t="dimovich"><y>#</y><d>2019-07-20</d><h>22:03</h><w>dimovich</w></z><z id="t1563713506" t="geraldodev"><y>#</y><d>2019-07-21</d><h>12:51</h><w>geraldodev</w></z><z id="t1563713551" t="geraldodev Hi, Why in this minimal case when the :status is 500 wrap-request throws an Exception java.lang.String cannot be cast to manifold.stream.core.IEventSource. Otherwise if I change the status to 200 the unhandled exception does not occur anymore."><y>#</y><d>2019-07-21</d><h>12:52</h><w>geraldodev</w>Hi, Why in this minimal case when the :status is 500 wrap-request throws an Exception java.lang.String cannot be cast to manifold.stream.core.IEventSource. Otherwise if I change the status to 200 the unhandled exception does not occur anymore.</z><z id="t1563737444" t="dimovich [:attrs {:href &quot;/_/_/users/U0516053R&quot;}] btw, is it ok to wrap your server handler in a client middleware?"><y>#</y><d>2019-07-21</d><h>19:30</h><r>dimovich</r><a>@U0516053R</a> btw, is it ok to wrap your server handler in a client middleware?</z><z id="t1563740206" t="geraldodev I&apos;m assuming that it is. The checking that I did was , http/post&apos;s middleware defaults do identity (so no middleware at the client by default). I assumed that it was like ring (plug middleware at server). But I didnt relate the word client with with that fact that It had to be used at client."><y>#</y><d>2019-07-21</d><h>20:16</h><r>geraldodev</r>I&apos;m assuming that it is. The checking that I did was , http/post&apos;s middleware defaults do identity (so no middleware at the client by default). I  assumed that it was like ring (plug middleware at server). But I didnt relate the word client with with that fact that It had to be used at client.</z><z id="t1563775211" t="geraldodev [:attrs {:href &quot;/_/_/users/U051951T6&quot;}] Thnx for pointing the rookie mystake. Very much appreciated."><y>#</y><d>2019-07-22</d><h>06:00</h><r>geraldodev</r><a>@dimovich</a> Thnx for pointing the rookie mystake. Very much appreciated.</z><z id="t1563719313" t="ikitommi [:attrs {:href &quot;/_/_/users/U051951T6&quot;}] looks good to me. If the mw also can return deferred, you need to convert &apos;em too."><y>#</y><d>2019-07-21</d><h>14:28</h><w>ikitommi</w><a>@dimovich</a> looks good to me. If the mw also can return deferred, you need to convert &apos;em too.</z><z id="t1563719582" t="ikitommi In general, the interceptor pattern fits much better with async: the interceptor executor takes care of passing the unwrapped maps to step functions. Just need a de facto specification to interceptors, to get an ecosystem of interceptor libs, like there is for ring. #interceptors btw."><y>#</y><d>2019-07-21</d><h>14:33</h><w>ikitommi</w>In general, the interceptor pattern fits much better with async: the interceptor executor takes care of passing the unwrapped maps to step functions. Just need a de facto specification to interceptors, to get an ecosystem of interceptor libs, like there is for ring. #interceptors btw.</z><z id="t1564107828" t="Faisal Hasnain How Aleph compares to Immutant? What are the tradeoffs? It seems Netty is more performant than Undertow. But Undertow is sponsored by Red Hat. Are there any production stories of Aleph?"><y>#</y><d>2019-07-26</d><h>02:23</h><w>Faisal Hasnain</w>How Aleph compares to Immutant? What are the tradeoffs? It seems Netty is more performant than Undertow. But Undertow is sponsored by Red Hat. Are there any production stories of Aleph?</z><z id="t1564157338" t="pablore check this video: https://youtu.be/zwuFJovzdHg"><y>#</y><d>2019-07-26</d><h>16:08</h><r>pablore</r>check this video: <a href="https://youtu.be/zwuFJovzdHg" target="_blank">https://youtu.be/zwuFJovzdHg</a></z><z id="t1564169001" t="Faisal Hasnain Great talk, thanks for sharing üôÇ"><y>#</y><d>2019-07-26</d><h>19:23</h><r>Faisal Hasnain</r>Great talk, thanks for sharing <b>üôÇ</b></z><z id="t1564126905" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/ULA2TC4BA&quot;}] I think it&apos;s hard to compare Aleph with immutant. Aleph is made to serve ring applications and can power asynchronous logic well by building on top of manifold"><y>#</y><d>2019-07-26</d><h>07:41</h><w>jeroenvandijk</w><a>@faisalhasnain90</a> I think it&apos;s hard to compare Aleph with immutant. Aleph is made to serve ring applications and can power asynchronous logic well by building on top of manifold</z><z id="t1564126946" t="jeroenvandijk I think many people use Aleph in production (including me). #yada is built on top of Aleph. Maybe you want to ask there too"><y>#</y><d>2019-07-26</d><h>07:42</h><w>jeroenvandijk</w>I think many people use Aleph in production (including me). #yada is built on top of Aleph. Maybe you want to ask there too</z><z id="t1564140113" t="yogthos I recall that immutant is no longer maintained"><y>#</y><d>2019-07-26</d><h>11:21</h><w>yogthos</w>I recall that immutant is no longer maintained</z><z id="t1564142606" t="romain The team were looking for a new maintainer"><y>#</y><d>2019-07-26</d><h>12:03</h><w>romain</w>The team were looking for a new maintainer</z><z id="t1564170559" t="Faisal Hasnain I see, thanks for the updates. I think, it would be fairly straight forward to use Netty under the hood without Aleph Clojure abstractions for server side libraries like Pedestal/Reitit."><y>#</y><d>2019-07-26</d><h>19:49</h><w>Faisal Hasnain</w>I see, thanks for the updates. I think, it would be fairly straight forward to use Netty under the hood without Aleph Clojure abstractions for server side libraries like Pedestal/Reitit.</z><z id="t1564171088" t="Faisal Hasnain [:attrs {:href &quot;/_/_/users/U0FT7SRLP&quot;}] Thanks, It would be interesting to have more facts on Pedestal vs Yada: https://clojurians.slack.com/archives/C0K65B20P/p1564170981014100"><y>#</y><d>2019-07-26</d><h>19:58</h><w>Faisal Hasnain</w><a>@jeroenvandijk</a> Thanks, It would be interesting to have more facts on Pedestal vs Yada: <a href="https://clojurians.slack.com/archives/C0K65B20P/p1564170981014100" target="_blank">https://clojurians.slack.com/archives/C0K65B20P/p1564170981014100</a></z><z id="t1564229239" t="ikitommi Immutant uses Undertow, which will start using Netty under the hoods in 3.0. Perf-wise, both Yada &amp; Pedestal (and many others) add a lot of components to request pipeline by default, so they can be easily an order of magnitude slower than raw Netty. For raw byte-perf, just use the Java servers or lite clojure wrappers, Aleph being one."><y>#</y><d>2019-07-27</d><h>12:07</h><w>ikitommi</w>Immutant uses Undertow, which will start using Netty under the hoods in 3.0. Perf-wise, both Yada &amp; Pedestal (and many others) add a lot of components to request pipeline by default, so they can be easily an order of magnitude slower than raw Netty. For raw byte-perf, just use the Java servers or lite clojure wrappers, Aleph being one.</z><z id="t1564637388" t="valerauko wow undertow will switch to netty? is there any point in using it over netty at that rate though?"><y>#</y><d>2019-08-01</d><h>05:29</h><r>valerauko</r>wow undertow will switch to netty? is there any point in using it over netty at that rate though?</z><z id="t1564433749" t="Faisal Hasnain [:attrs {:href &quot;/_/_/users/U055NJ5CC&quot;}] perfect! Aleph is awesome. I saw forked version of Immutant in recent benchmarks showing impress results. Does Metosin anticipates to maintain it?"><y>#</y><d>2019-07-29</d><h>20:55</h><w>Faisal Hasnain</w><a>@ikitommi</a> perfect! Aleph is awesome. I saw forked version of Immutant in recent benchmarks showing impress results. Does Metosin anticipates to maintain it?</z><z id="t1564482973" t="ikitommi It&apos;s metosin/pohjavirta now, marked still as alpha &amp; experimental. Goal is to make it production quality, will announce when/if that happens."><y>#</y><d>2019-07-30</d><h>10:36</h><r>ikitommi</r>It&apos;s <code>metosin/pohjavirta</code> now, marked still as alpha &amp; experimental. Goal is to make it production quality, will announce when/if that happens.</z><z id="t1564483136" t="Faisal Hasnain üëç awesome, keep up the good work."><y>#</y><d>2019-07-30</d><h>10:38</h><r>Faisal Hasnain</r><b>üëç</b> awesome, keep up the good work.</z><z id="t1565109891" t="valerauko [:attrs {:href &quot;/_/_/users/U052BJL37&quot;}] do i recall correctly you were becoming the maintainer for aleph?"><y>#</y><d>2019-08-06</d><h>16:44</h><w>valerauko</w><a>@kachayev</a> do i recall correctly you were becoming the maintainer for aleph?</z><z id="t1565213794" t="geraldodev Do you have any advice/library/example for implementing sessions on aleph ? (thnx in advance)"><y>#</y><d>2019-08-07</d><h>21:36</h><w>geraldodev</w>Do you have any advice/library/example for implementing sessions on aleph ? (thnx in advance)</z><z id="t1565237879" t="valerauko i use the ring session middleware, it works just fine https://github.com/ring-clojure/ring/wiki/Sessions"><y>#</y><d>2019-08-08</d><h>04:17</h><r>valerauko</r>i use the ring session middleware, it works just fine <a href="https://github.com/ring-clojure/ring/wiki/Sessions" target="_blank">https://github.com/ring-clojure/ring/wiki/Sessions</a></z><z id="t1565253793" t="mccraigmccraig that middleware is expecting a plain value response [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] ( https://github.com/ring-clojure/ring/blob/master/ring-core/src/ring/middleware/session.clj#L108 ) - it won&apos;t work if your responses are Deferred - should be trivial to modify it to work with Deferred responses though"><y>#</y><d>2019-08-08</d><h>08:43</h><r>mccraigmccraig</r>that middleware is expecting a plain value response <a>@UAEH11THP</a> ( <a href="https://github.com/ring-clojure/ring/blob/master/ring-core/src/ring/middleware/session.clj#L108" target="_blank">https://github.com/ring-clojure/ring/blob/master/ring-core/src/ring/middleware/session.clj#L108</a> ) - it won&apos;t work if your responses are <code>Deferred</code> - should be trivial to modify it to work with <code>Deferred</code> responses though</z><z id="t1565255123" t="valerauko yeah things get tricky if you use deferred responses"><y>#</y><d>2019-08-08</d><h>09:05</h><r>valerauko</r>yeah things get tricky if you use deferred responses</z><z id="t1565766564" t="rbarker Has anyone dealt with an error along the lines of ‚ÄúI/O reactor status: STOPPED` and `I/O reactor terminated abnormally‚Äù previously?"><y>#</y><d>2019-08-14</d><h>07:09</h><w>rbarker</w>Has anyone dealt with an error along the lines of ‚ÄúI/O reactor status: STOPPED` and `I/O reactor terminated abnormally‚Äù previously?</z><z id="t1567034048" t="thomascothran I&apos;m using Aleph&apos;s client to connect to a push feed. It uses a chunked response encoding to push out JSON objects. I&apos;m using manifold.stream/stream-&gt;seq to convert the chunks into a sequences. Effectively, something like this: (require &apos;[manifold.stream :as ms]) (require &apos;[aleph.http :as http]) (defn connect-to-push-stream [{:keys [::process-fn ::push-url]}] (m-d/chain (http/get push-url {:pool (http/connection-pool {:connection-options {:raw-stream? true}})}) :body ms/stream-&gt;seq ;; TODO transform to seq of maps from json objects ;; Apply process-fn to each map created from the json object #(map process-fn %))) Of course, the items in the sequence are not the complete json payloads. I can iterate over the sequence and look for the CRLF endings to combine them. However, I wasn&apos;t sure if there is anything Aleph provides that does this out of the box. I looked at the coerce-json-response middleware, but it doesn&apos;t look like it works with a push feed."><y>#</y><d>2019-08-28</d><h>23:14</h><w>thomascothran</w>I&apos;m using Aleph&apos;s client to connect to a push feed. It uses a chunked response encoding to push out JSON objects. I&apos;m using <code>manifold.stream/stream-&gt;seq</code> to convert the chunks into a sequences. Effectively, something like this:

<pre>(require &apos;[manifold.stream :as ms])
(require &apos;[aleph.http :as http])

(defn connect-to-push-stream
  [{:keys [::process-fn ::push-url]}]
  (m-d/chain (http/get push-url
                        {:pool (http/connection-pool
                                {:connection-options {:raw-stream? true}})})
              :body
              ms/stream-&gt;seq
              ;; TODO transform to seq of maps from json objects
              ;; Apply process-fn to each map created from the json object
              #(map process-fn %)))
</pre>

Of course, the items in the sequence are not the complete json payloads. I can iterate over the sequence and look for the CRLF endings to combine them.

However, I wasn&apos;t sure if there is anything Aleph provides that does this out of the box. I looked at the <code>coerce-json-response</code> middleware, but it doesn&apos;t look like it works with a push feed.</z><z id="t1567073486" t="mccraigmccraig i don&apos;t know about assembling the JSON fragments [:attrs {:href &quot;/_/_/users/U7GK705MM&quot;}] , but be aware the manifold.stream/stream-&gt;seq may cause blocking - if your app is non-blocking then you will probably want to use a combination of manifold.stream/map and manifold.stream/reduce instead"><y>#</y><d>2019-08-29</d><h>10:11</h><w>mccraigmccraig</w>i don&apos;t know about assembling the JSON fragments <a>@thomas559</a> , but be aware the <code>manifold.stream/stream-&gt;seq</code> may cause blocking - if your app is non-blocking then you will probably want to use a combination of <code>manifold.stream/map</code> and <code>manifold.stream/reduce</code> instead</z><z id="t1567102424" t="thomascothran [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] - does it become blocking any time the stream is converted to a lazy seq, or is that specific to the stream-&gt;seq function? I was exploring either using lazy-seq to assemble the pieces, or else manifold.stream/transform ."><y>#</y><d>2019-08-29</d><h>18:13</h><w>thomascothran</w><a>@mccraigmccraig</a> - does it become blocking any time the stream is converted to a lazy seq, or is that specific to the <code>stream-&gt;seq</code> function? I was exploring either using <code>lazy-seq</code> to assemble the pieces, or else <code>manifold.stream/transform</code>.</z><z id="t1567102545" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U7GK705MM&quot;}] it&apos;s because stream-&gt;seq does a deref internally, and deref is blocking - https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L552"><y>#</y><d>2019-08-29</d><h>18:15</h><w>mccraigmccraig</w><a>@thomas559</a> it&apos;s because <code>stream-&gt;seq</code> does a <code>deref</code> internally, and <code>deref</code> is blocking - <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L552" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L552</a></z><z id="t1567102605" t="mccraigmccraig using manifold.stream/transform should be fine"><y>#</y><d>2019-08-29</d><h>18:16</h><w>mccraigmccraig</w>using <code>manifold.stream/transform</code> should be fine</z><z id="t1567102620" t="thomascothran Ah, got it. Thanks!"><y>#</y><d>2019-08-29</d><h>18:17</h><w>thomascothran</w>Ah, got it. Thanks!</z><z id="t1567146136" t="onetom I was looking into both Aleph server and client finally (after http-kit, clj-json, HTTPUrlConnection, etc) I can&apos;t find an example showing how to implement a typical JSON API and how should I talk to one using the aleph http client. I looked into the source and as I see it supposed to respond with the value of cheshire.core/encode which is a string in newer versions, but I&apos;m getting a java.io.ByteArrayInputStream instead."><y>#</y><d>2019-08-30</d><h>06:22</h><w>onetom</w>I was looking into both Aleph server and client finally
(after http-kit, clj-json, HTTPUrlConnection, etc)

I can&apos;t find an example showing how to implement a typical JSON API
and how should I talk to one using the aleph http client.

I looked into the source and as I see it supposed to respond with the value of <code>cheshire.core/encode</code> which is a string in newer versions, but I&apos;m getting a <code>java.io.ByteArrayInputStream</code> instead.</z><z id="t1567146273" t="onetom That input stream indeed contains the JSON string, which I&apos;ve passed in via aleph.http/request and it was coerced from the :form-params field because I specified the :content-type :application/json in the request map. @(http/request {:request-method :post :url &quot;&quot; :content-type :application/json :form-params {:test 1234} :as :json :cookie-store jar :connection-timeout 1000 :request-timeout 2000}) "><y>#</y><d>2019-08-30</d><h>06:24</h><w>onetom</w>That input stream indeed contains the JSON string, which I&apos;ve passed in via <code>aleph.http/request</code> and it was coerced from the <code>:form-params</code> field because I specified the <code>:content-type :application/json</code> in the request map.

<pre>@(http/request
         {:request-method     :post
          :url                &quot;&quot;
          :content-type       :application/json
          :form-params        {:test 1234}
          :as                 :json
          :cookie-store       jar
          :connection-timeout 1000
          :request-timeout    2000})
</pre></z><z id="t1567146653" t="onetom Do I understand well, that parsing the request body within an aleph.http.server is the responsibility of the ring middleware it is serving?"><y>#</y><d>2019-08-30</d><h>06:30</h><w>onetom</w>Do I understand well, that parsing the request body within an <code>aleph.http.server</code> is the responsibility of the ring middleware it is serving?</z><z id="t1567147021" t="onetom If that&apos;s the case, what&apos;s the recommended ring middleware to deal with this? It seems like ring.core doesn&apos;t provide any and googling yields a bunch of alternatives: ‚Ä¢ ring.middleware.json/wrap-json-params from ring/ring-json ‚Ä¢ weavejester/ring-json-response ‚Ä¢ ngrunwald/ring-middleware-format and it&apos;s modern incarnation muuntaja.middleware/wrap-format from metosin/muuntaja ‚Ä¢ ring-clojure/ring-json"><y>#</y><d>2019-08-30</d><h>06:37</h><w>onetom</w>If that&apos;s the case, what&apos;s the recommended ring middleware to deal with this?
It seems like <code>ring.core</code> doesn&apos;t provide any and googling yields a bunch of alternatives:

‚Ä¢ <code>ring.middleware.json/wrap-json-params</code> from <code>ring/ring-json</code>
‚Ä¢ <code>weavejester/ring-json-response</code>
‚Ä¢ <code>ngrunwald/ring-middleware-format</code> and it&apos;s modern incarnation <code>muuntaja.middleware/wrap-format</code> from <code>metosin/muuntaja</code>
‚Ä¢ <code>ring-clojure/ring-json</code></z><z id="t1567147935" t="onetom Putting all this together is such a patchwork compared to other language ecosystems, it makes me suspicious that I&apos;m doing something wrong... üòï Please enlighten me if that&apos;s the case!"><y>#</y><d>2019-08-30</d><h>06:52</h><w>onetom</w>Putting all this together is such a patchwork compared to other language ecosystems, it makes me suspicious that I&apos;m doing something wrong... <b>üòï</b>
Please enlighten me if that&apos;s the case!</z><z id="t1567153407" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U086D6TBN&quot;}] for an http/json api you might want to look at #yada which layers a lot of http handling stuff on top of aleph, and includes nice things like swagger generation, schema-based coercion (from json&apos;s limited types to clojure&apos;s richer types) and async multipart handling"><y>#</y><d>2019-08-30</d><h>08:23</h><w>mccraigmccraig</w><a>@onetom</a> for an http/json api you might want to look at #yada which layers a lot of http handling stuff on top of aleph, and includes nice things like swagger generation, schema-based coercion (from json&apos;s limited types to clojure&apos;s richer types) and async multipart handling</z><z id="t1567157605" t="onetom thanks! i haven&apos;t realized it&apos;s also based on aleph. i would consider it then, though the reitit approach feels so much nicer and general and flexible and everything üôÇ"><y>#</y><d>2019-08-30</d><h>09:33</h><r>onetom</r>thanks! i haven&apos;t realized it&apos;s also based on aleph. i would consider it then, though the reitit approach feels so much nicer and general and flexible and everything <b>üôÇ</b></z><z id="t1567155370" t="dimovich [:attrs {:href &quot;/_/_/users/U086D6TBN&quot;}] I think muuntaja.middleware/wrap-format should do the job. Does it work for you?"><y>#</y><d>2019-08-30</d><h>08:56</h><w>dimovich</w><a>@onetom</a> I think <code>muuntaja.middleware/wrap-format</code> should do the job. Does it work for you?</z><z id="t1567157500" t="onetom [:attrs {:href &quot;/_/_/users/U051951T6&quot;}] im trying the reitit.ring.middleware.muuntaja/format-middleware , since i&apos;ve just switched to reitit , but currently i have routing issues, so i can&apos;t confirm whether it works or not"><y>#</y><d>2019-08-30</d><h>09:31</h><w>onetom</w><a>@dimovich</a> im trying the <code>reitit.ring.middleware.muuntaja/format-middleware</code>, since i&apos;ve just switched to <code>reitit</code>, but currently i have routing issues, so i can&apos;t confirm whether it works or not</z><z id="t1567160377" t="ikitommi [:attrs {:href &quot;/_/_/users/U086D6TBN&quot;}] updated the reitit-http swagger example to run with aleph, just comment the jetty out and aleph in: https://github.com/metosin/reitit/tree/master/examples/http-swagger . There is also example routes for files &amp; async values via Manifold. Reitit doesn‚Äôt ship with any default interceptor stack, but the example has a bare-bones api-stack included."><y>#</y><d>2019-08-30</d><h>10:19</h><w>ikitommi</w><a>@onetom</a> updated the <code>reitit-http</code> swagger example to run with aleph, just comment the jetty out and aleph in: <a href="https://github.com/metosin/reitit/tree/master/examples/http-swagger" target="_blank">https://github.com/metosin/reitit/tree/master/examples/http-swagger</a>. There is also example routes for files &amp; async values via Manifold. Reitit doesn‚Äôt ship with any default interceptor stack, but the example has a bare-bones api-stack included.</z><z id="t1567161028" t="onetom thanks! i was studying that example earlier, but it&apos;s a bit hard to follow without navigating around the source with some proper clojure editor. for example both the ring/router and the ring/ring-handler accept options, but extra middlewares i supply to the ring/ring-handler , but the example only shows interceptors within a {:data {:interceptors ...}} structure of the http/routes function the indentation is not deep enough to immediately see which option block belongs to which function. so im still a bit confused because of the lot of similar names..."><y>#</y><d>2019-08-30</d><h>10:30</h><r>onetom</r>thanks!
i was studying that example earlier, but it&apos;s a bit hard to follow without navigating around the source with some proper clojure editor.

for example both the <code>ring/router</code> and the <code>ring/ring-handler</code> accept options, but extra middlewares i supply to the <code>ring/ring-handler</code>, but the example only shows interceptors within a <code>{:data {:interceptors ...}}</code> structure of the <code>http/routes</code> function

the indentation is not deep enough to immediately see which option block belongs to which function.

so im still a bit confused because of the lot of similar names...</z><z id="t1567161152" t="onetom the source code is really clear though, so even without more documentation and examples i could figure out a lot of it myself. your conference talk also helped a lot! you reminded me that i can just test the middleware functions directly first; i don&apos;t need them into a webserver necessarily"><y>#</y><d>2019-08-30</d><h>10:32</h><r>onetom</r>the source code is really clear though, so even without more documentation and examples i could figure out a lot of it myself.

your conference talk also helped a lot!

you reminded me that i can just test the middleware functions directly first; i don&apos;t need them into a webserver necessarily</z><z id="t1567161777" t="onetom the screenshot on the https://metosin.github.io/reitit/ring/transforming_middleware_chain.html page is showing middleware names. is that really what im supposed to see if i do (defn router [] (reitit.ring/router [[&quot;/test&quot; {:get test-route}] {:reitit.middleware/transform print-request-diffs})) ? i only see a request and a response; nothing about middlewares, although i have the following handler: (def app (reitit.ring/ring-handler (router) (reitit.ring/create-default-handler) {:middleware [muuntaja/format-middleware ring.middleware.cookies/wrap-cookies [ring.middleware.session/wrap-session {:store (ring.middleware.session.memory/memory-store sessions)}]]})) "><y>#</y><d>2019-08-30</d><h>10:42</h><w>onetom</w>the screenshot on the <a href="https://metosin.github.io/reitit/ring/transforming_middleware_chain.html" target="_blank">https://metosin.github.io/reitit/ring/transforming_middleware_chain.html</a> page is showing middleware names.
is that really what im supposed to see if i do
<pre>(defn router []
  (reitit.ring/router
    [[&quot;/test&quot; {:get test-route}]
    {:reitit.middleware/transform print-request-diffs}))
</pre>
?

i only see a request and a response; nothing about middlewares, although i have the following handler:

<pre>(def app
  (reitit.ring/ring-handler
    (router)
    (reitit.ring/create-default-handler)
    {:middleware
       [muuntaja/format-middleware
        ring.middleware.cookies/wrap-cookies
        [ring.middleware.session/wrap-session
         {:store (ring.middleware.session.memory/memory-store sessions)}]]}))
</pre></z></g><g id="s6"><z id="t1567162074" t="ikitommi let‚Äôs continue on #reitit"><y>#</y><d>2019-08-30</d><h>10:47</h><w>ikitommi</w>let‚Äôs continue on #reitit</z><z id="t1567162135" t="onetom sorry, i thought i was on #reitit üôÇ"><y>#</y><d>2019-08-30</d><h>10:48</h><r>onetom</r>sorry, i thought i was on #reitit <b>üôÇ</b></z><z id="t1569164963" t="akond i&apos;m trying to map a sequence through a function concurrently. but i&apos;m completely new to manifold and my code does not get executed concurrently."><y>#</y><d>2019-09-22</d><h>15:09</h><w>akond</w>i&apos;m trying to map a sequence through a function concurrently. but i&apos;m completely new to manifold and my code does not get executed concurrently.</z><z id="t1569164993" t="akond i guessed i need (executor/utilization-executor 1 6)"><y>#</y><d>2019-09-22</d><h>15:09</h><w>akond</w>i guessed i need <code>(executor/utilization-executor 1 6)</code></z><z id="t1569165041" t="akond and then (-&gt;&gt; (s/-&gt;source files) ... (s/onto exec-pool) but other than that"><y>#</y><d>2019-09-22</d><h>15:10</h><w>akond</w>and then <code>(-&gt;&gt; (s/-&gt;source files) ... (s/onto exec-pool)</code> but other than that</z><z id="t1569165067" t="akond i do not yet understand"><y>#</y><d>2019-09-22</d><h>15:11</h><w>akond</w>i do not yet understand</z><z id="t1569165414" t="akond i need your help"><y>#</y><d>2019-09-22</d><h>15:16</h><w>akond</w>i need your help</z><z id="t1569168112" t="akond i think i&apos;ve figured that out"><y>#</y><d>2019-09-22</d><h>16:01</h><w>akond</w>i think i&apos;ve figured that out</z><z id="t1569878935" t="gmercer Hi, is there a way to accept TCP for legacy payloads but identify if the connection is HTTP and the &quot;upgrade&quot; to HTTP and pass through the HTTP handler ?"><y>#</y><d>2019-09-30</d><h>21:28</h><w>gmercer</w>Hi, is there a way to accept TCP for legacy payloads but identify if the connection is HTTP and the &quot;upgrade&quot; to HTTP and pass through the HTTP handler ?</z><z id="t1569990397" t="sofra when using the HTTP client how it seem to uncompress the body of the 200&apos;s but not of other statuses, how do I get around this?"><y>#</y><d>2019-10-02</d><h>04:26</h><w>sofra</w>when using the HTTP client how it seem to uncompress the body of the 200&apos;s but not of other statuses, how do I get around this?</z><z id="t1570054265" t="cddr I do this using the chain operator from manifold. e.g. (d/chain (http/get &quot;&quot; get-params) (fn [response] (if (ok? response) (inflate (:body response)) (throw (ex-info &quot;request failed&quot; {}))))) "><y>#</y><d>2019-10-02</d><h>22:11</h><w>cddr</w>I do this using the <code>chain</code> operator from manifold. e.g.

<pre>(d/chain (http/get &quot;&quot; get-params)
  (fn [response]
     (if (ok? response)
        (inflate (:body response))
        (throw (ex-info &quot;request failed&quot; {})))))
</pre></z><z id="t1570054353" t="cddr This will give you a deferred. When you deref it, you&apos;ll get either the decompressed body or an exception will be thrown."><y>#</y><d>2019-10-02</d><h>22:12</h><w>cddr</w>This will give you a deferred. When you deref it, you&apos;ll get either the decompressed body or an exception will be thrown.</z><z id="t1570083700" t="sofra thanks [:attrs {:href &quot;/_/_/users/U065JNAN8&quot;}] where does the inflate fn come from? or is that just a function you have written your self?"><y>#</y><d>2019-10-03</d><h>06:21</h><w>sofra</w>thanks <a>@cddr</a> where does the <code>inflate</code> fn come from? or is that just a function you have written your self?</z><z id="t1570083775" t="sofra [:attrs {:href &quot;/_/_/users/U065JNAN8&quot;}] that is what I have settled on too but wrote my on decompression function so was wondering if there was something to do it that I had missed"><y>#</y><d>2019-10-03</d><h>06:22</h><w>sofra</w><a>@cddr</a> that is what I have settled on too but wrote my on decompression function so was wondering if there was something to do it that I had missed</z><z id="t1570096368" t="cddr Ah yeah inflate is just a placeholder for whatever you have that decompresses the response."><y>#</y><d>2019-10-03</d><h>09:52</h><w>cddr</w>Ah yeah <code>inflate</code> is just a placeholder for whatever you have that decompresses the response.</z><z id="t1570099239" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U093DA4QY&quot;}] our http client checks headers to detect whether responses are compressed and decompresses them as necessary - here it is - there are private deps, so you won&apos;t be able to use it directly, but parts of it may be useful - https://gist.github.com/mccraigmccraig/7e44ff82d9fb66f6809614f1ed65cd04"><y>#</y><d>2019-10-03</d><h>10:40</h><w>mccraigmccraig</w><a>@sofra</a> our http client checks headers to detect whether responses are compressed and decompresses them as necessary - here it is - there are private deps, so you won&apos;t be able to use it directly, but parts of it may be useful - <a href="https://gist.github.com/mccraigmccraig/7e44ff82d9fb66f6809614f1ed65cd04" target="_blank">https://gist.github.com/mccraigmccraig/7e44ff82d9fb66f6809614f1ed65cd04</a></z><z id="t1570100754" t="sofra thanks [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] !"><y>#</y><d>2019-10-03</d><h>11:05</h><w>sofra</w>thanks <a>@mccraigmccraig</a>!</z><z id="t1570178220" t="pbaille Hello! question: how can I achieve this with manifold? (async/go-loop [] (async/&lt;! (async/timeout 1000)) (println &quot;tic&quot;) (recur)) "><y>#</y><d>2019-10-04</d><h>08:37</h><w>pbaille</w>Hello! question: how can I achieve this with manifold?
<pre>(async/go-loop []
  (async/&lt;! (async/timeout 1000))
  (println &quot;tic&quot;)
  (recur))
</pre></z><z id="t1570178640" t="valerauko deferred/loop and deferred/let-flow should work i think"><y>#</y><d>2019-10-04</d><h>08:44</h><w>valerauko</w>deferred/loop and deferred/let-flow should work i think</z><z id="t1570178674" t="pbaille in my little experience deferred/loop blocks"><y>#</y><d>2019-10-04</d><h>08:44</h><w>pbaille</w>in my little experience deferred/loop blocks</z><z id="t1570178682" t="pbaille I must missing something üôÇ"><y>#</y><d>2019-10-04</d><h>08:44</h><w>pbaille</w>I must missing something <b>üôÇ</b></z><z id="t1570178716" t="pbaille is there an analog manifold construct for async/timeout?"><y>#</y><d>2019-10-04</d><h>08:45</h><w>pbaille</w>is there an analog manifold construct for async/timeout?</z><z id="t1570178756" t="valerauko there&apos;s deferred/timeout"><y>#</y><d>2019-10-04</d><h>08:45</h><w>valerauko</w>there&apos;s deferred/timeout</z><z id="t1570178847" t="valerauko manifold.stream/consume might be similar too"><y>#</y><d>2019-10-04</d><h>08:47</h><w>valerauko</w>manifold.stream/consume might be similar too</z><z id="t1570179418" t="pbaille [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] thank you for your help üôÇ"><y>#</y><d>2019-10-04</d><h>08:56</h><w>pbaille</w><a>@vale</a> thank you for your help <b>üôÇ</b></z><z id="t1570182318" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U0A7SU3FS&quot;}] cheesy, but (defn tics [n] (d/chain (d/timeout! (d/deferred) n ::timeout) (fn [_] (prn &quot;tic&quot;) (tics n)))) "><y>#</y><d>2019-10-04</d><h>09:45</h><w>mccraigmccraig</w><a>@pbaille</a> cheesy, but
<pre>(defn tics [n] (d/chain (d/timeout! (d/deferred) n ::timeout) (fn [_] (prn &quot;tic&quot;) (tics n))))
</pre></z><z id="t1570182414" t="pbaille üôÇ thank you!"><y>#</y><d>2019-10-04</d><h>09:46</h><w>pbaille</w><b>üôÇ</b> thank you!</z><z id="t1570468321" t="matthavener Might be a repost: Here‚Äôs the source of the name ‚Äúaleph‚Äù (from a podcast with ztellman) http://www.mit.edu/~allanmc/borgesaleph.pdf"><y>#</y><d>2019-10-07</d><h>17:12</h><w>matthavener</w>Might be a repost: Here‚Äôs the source of the name ‚Äúaleph‚Äù (from a podcast with ztellman) <a href="http://www.mit.edu/~allanmc/borgesaleph.pdf" target="_blank">http://www.mit.edu/~allanmc/borgesaleph.pdf</a></z><z id="t1570868627" t="Ho0man Hi, is there a way that I could receive each server-sent event as soon as they arrive individually not as a whole response ?"><y>#</y><d>2019-10-12</d><h>08:23</h><w>Ho0man</w>Hi, is there a way that I could receive each server-sent event as soon as they arrive individually not as a whole response ?</z><z id="t1573513525" t="wcalderipe Hey folks, do you know any compojure + aleph open-source projects out into the wild? I&apos;m looking for references of how people are using the Ring&apos;s async. handlers [request respond raise] on Aleph. üôÇ"><y>#</y><d>2019-11-11</d><h>23:05</h><w>wcalderipe</w>Hey folks, do you know any compojure + aleph open-source projects out into the wild? I&apos;m looking for references of how people are using the Ring&apos;s async. handlers <code>[request respond raise]</code> on Aleph. <b>üôÇ</b></z><z id="t1573577331" t="lispyclouds [:attrs {:href &quot;/_/_/users/UHD67JRL4&quot;}] you need to use the latest alpha version of Aleph for this https://github.com/ztellman/aleph/releases/tag/0.4.7-alpha5 as this has the wrap-ring-async-handler function which is not released yet. you can then wrap your handler as (wrap-ring-async-handler app) and pass it to start-server"><y>#</y><d>2019-11-12</d><h>16:48</h><w>lispyclouds</w><a>@wcalderipe</a> you need to use the latest alpha version of Aleph for this <a href="https://github.com/ztellman/aleph/releases/tag/0.4.7-alpha5" target="_blank">https://github.com/ztellman/aleph/releases/tag/0.4.7-alpha5</a> as this has the <code>wrap-ring-async-handler</code> function which is not released yet. you can then wrap your handler as <code>(wrap-ring-async-handler app)</code> and pass it to <code>start-server</code></z><z id="t1573577335" t="lispyclouds https://github.com/metosin/reitit/blob/master/examples/http-swagger/src/example/server.clj#L149"><y>#</y><d>2019-11-12</d><h>16:48</h><w>lispyclouds</w><a href="https://github.com/metosin/reitit/blob/master/examples/http-swagger/src/example/server.clj#L149" target="_blank">https://github.com/metosin/reitit/blob/master/examples/http-swagger/src/example/server.clj#L149</a></z><z id="t1573636057" t="wcalderipe [:attrs {:href &quot;/_/_/users/U7ERLH6JX&quot;}] thanks for the insight! üôå I did read the article on http://booleanknot.com which is also mentioned in the docstring of the middleware. Have you used this approach in production? Source: https://github.com/ztellman/aleph/blob/5cc7bcab723bf3b64de7998fc782531c554636e5/src/aleph/http.clj#L436-L445"><y>#</y><d>2019-11-13</d><h>09:07</h><w>wcalderipe</w><a>@rahul080327</a> thanks for the insight! <b>üôå</b> I did read the article on <a href="http://booleanknot.com" target="_blank">http://booleanknot.com</a> which is also mentioned in the docstring of the middleware. Have you used this approach in production?

Source: <a href="https://github.com/ztellman/aleph/blob/5cc7bcab723bf3b64de7998fc782531c554636e5/src/aleph/http.clj#L436-L445" target="_blank">https://github.com/ztellman/aleph/blob/5cc7bcab723bf3b64de7998fc782531c554636e5/src/aleph/http.clj#L436-L445</a></z><z id="t1573636334" t="wcalderipe AFAIU, the proposed solution is not backwards compatible and you can&apos;t have a mix of sync and async handlers in the application level. Am I right?"><y>#</y><d>2019-11-13</d><h>09:12</h><w>wcalderipe</w>AFAIU, the proposed solution is not backwards compatible and you can&apos;t have a mix of sync and async handlers in the application level. Am I right?</z><z id="t1573636731" t="wcalderipe At the moment, we have a poor design solution for async handler. Every Compojure sync handler (signature fn [request] -&gt; response ) is returning a channel instead of the response map and a downstream middleware is responsible to unwrap the channel and take the value out (same approach of wrap-ring-async-handler but different üòÖ ). That being in place, every application middleware needs to know how to handle a channel instead of a map which is a big deviation from the community standard and it&apos;s leading us to have lots of in-house solutions for problems already solved."><y>#</y><d>2019-11-13</d><h>09:18</h><w>wcalderipe</w>At the moment, we have a poor design solution for async handler. Every Compojure sync handler (signature <code>fn [request] -&gt; response</code>) is returning a channel instead of the response map and a downstream middleware is responsible to unwrap the channel and take the value out (same approach of <code>wrap-ring-async-handler</code> but different <b>üòÖ</b>). That being in place, every application middleware needs to know how to handle a channel instead of a map which is a big deviation from the community standard and it&apos;s leading us to have lots of in-house solutions for problems already solved.</z><z id="t1573637365" t="valerauko i don&apos;t think wrap-ring-async-handler would require the middleware to know about deferred"><y>#</y><d>2019-11-13</d><h>09:29</h><w>valerauko</w>i don&apos;t think wrap-ring-async-handler would require the middleware to know about deferred</z><z id="t1573637406" t="valerauko at least i&apos;d expect it not to"><y>#</y><d>2019-11-13</d><h>09:30</h><w>valerauko</w>at least i&apos;d expect it not to</z><z id="t1573669102" t="ikitommi [:attrs {:href &quot;/_/_/users/UHD67JRL4&quot;}] middleware is very async-friendly. The reitit example above uses the interceptor-model (reitit supports both mw &amp; interceptors via separate modules) which allows any step to return an async value (e.g.core.async channel), the interceptor runner unwraps the value automatically for the next step. Pedestal also uses interceptors and yada uses manifold for easy one-way async chaining."><y>#</y><d>2019-11-13</d><h>18:18</h><w>ikitommi</w><a>@wcalderipe</a> middleware is very async-friendly. The reitit example above uses the interceptor-model (reitit supports both mw &amp; interceptors via separate modules) which allows any step to return an async value (e.g.core.async channel), the interceptor runner unwraps the value automatically for the next step. Pedestal also uses interceptors and yada uses manifold for easy one-way async chaining.</z><z id="t1574134972" t="wcalderipe Sorry for the late reply and thank you for put that together on a message!"><y>#</y><d>2019-11-19</d><h>03:42</h><r>wcalderipe</r>Sorry for the late reply and thank you for put that together on a message!</z><z id="t1573931507" t="cddr Little blog post with a real life use-case for aleph‚Äôs http client https://grumpyhacker.com/kafka-connect-status-report/"><y>#</y><d>2019-11-16</d><h>19:11</h><w>cddr</w>Little blog post with a real life use-case for aleph‚Äôs http client

<a href="https://grumpyhacker.com/kafka-connect-status-report/" target="_blank">https://grumpyhacker.com/kafka-connect-status-report/</a></z><z id="t1574086517" t="flowthing I have a request handler that instantiates a PipedReader and a PipedWriter . I write messages into the pipe, they&apos;re handled in another thread, which puts the result back into the pipe. Everything works fine, except when the processing takes enough time, the pipe just up and dies with Stream closed . Everything works OK if I instantiate the reader and the writer outside the request handler, but that&apos;s not going to work because I need to be able to close the reader and the writer. Does anyone have any ideas what might cause something like this? It&apos;s driving me crazy."><y>#</y><d>2019-11-18</d><h>14:15</h><w>flowthing</w>I have a request handler that instantiates a <code>PipedReader</code> and a <code>PipedWriter</code>. I write messages into the pipe, they&apos;re handled in another thread, which puts the result back into the pipe. Everything works fine, except when the processing takes enough time, the pipe just up and dies with <code>Stream closed</code>. Everything works OK if I instantiate the reader and the writer outside the request handler, but that&apos;s not going to work because I need to be able to close the reader and the writer. Does anyone have any ideas what might cause something like this? It&apos;s driving me crazy.</z><z id="t1574087565" t="flowthing Actually, looks like I&apos;m getting Stream closed even when I instantiate them outside the handler... sigh."><y>#</y><d>2019-11-18</d><h>14:32</h><r>flowthing</r>Actually, looks like I&apos;m getting <code>Stream closed</code> even when I instantiate them outside the handler... sigh.</z><z id="t1574089074" t="flowthing Looks like using wrapping the pipe with BufferedWriter and BufferedReader solves the issue."><y>#</y><d>2019-11-18</d><h>14:57</h><r>flowthing</r>Looks like using wrapping the pipe with <code>BufferedWriter</code> and <code>BufferedReader</code> solves the issue.</z><z id="t1574089490" t="flowthing Or not."><y>#</y><d>2019-11-18</d><h>15:04</h><r>flowthing</r>Or not.</z><z id="t1574135191" t="wcalderipe Following up with the async and sync discussion. I still couldn&apos;t figure this out so maybe a good soul in the community would post something about it. I&apos;m sure this isn&apos;t the first time this issue is bring to the light. I created a repository with the problem scenario: I&apos;m back working in the issue and I created a repository with the scenario.. https://github.com/wcalderipe/lab-compojure-aleph-sync-and-async/blob/master/src/lab_compojure_aleph_async/core.clj"><y>#</y><d>2019-11-19</d><h>03:46</h><w>wcalderipe</w>Following up with the async and sync discussion. I still couldn&apos;t figure this out so maybe a good soul in the community would post something about it. I&apos;m sure this isn&apos;t the first time this issue is bring to the light.

I created a repository with the problem scenario: I&apos;m back working in the issue and I created a repository with the scenario..

<a href="https://github.com/wcalderipe/lab-compojure-aleph-sync-and-async/blob/master/src/lab_compojure_aleph_async/core.clj" target="_blank">https://github.com/wcalderipe/lab-compojure-aleph-sync-and-async/blob/master/src/lab_compojure_aleph_async/core.clj</a></z><z id="t1574141650" t="ikitommi [:attrs {:href &quot;/_/_/users/UHD67JRL4&quot;}] you app should either be fully (sync) ring or async-ring (3 arity). In your example, line41, you define it as sync (1 arity). I don&apos;t think you can mix them in ring. Interceptor-model allows you to do it."><y>#</y><d>2019-11-19</d><h>05:34</h><w>ikitommi</w><a>@wcalderipe</a> you app should either be fully (sync) ring or async-ring (3 arity). In your example, line41, you define it as sync (1 arity). I don&apos;t think you can mix them in ring. Interceptor-model allows you to do it.</z><z id="t1574144102" t="wcalderipe Thanks for taking a look on it üôå basically this is my original questions &quot;can sync and async handlers coexist in ring?&quot; and you might have answered it. Also, after you mentioned the interceptor model, I quickly found a good article about it, thanks! https://lispcast.com/a-model-of-interceptors/"><y>#</y><d>2019-11-19</d><h>06:15</h><w>wcalderipe</w>Thanks for taking a look on it <b>üôå</b> basically this is my original questions &quot;can sync and async handlers coexist in ring?&quot; and you might have answered it. Also, after you mentioned the interceptor model, I quickly found a good article about it, thanks!

<a href="https://lispcast.com/a-model-of-interceptors/" target="_blank">https://lispcast.com/a-model-of-interceptors/</a></z><z id="t1574145217" t="ikitommi an easy comparison: ‚Ä¢ with middleware: https://github.com/metosin/reitit/blob/master/examples/ring-swagger/src/example/server.clj ‚Ä¢ with interceptors: https://github.com/metosin/reitit/blob/master/examples/http-swagger/src/example/server.clj ‚Ä¶ the latter has one route returning a async value, a Manifold Deferred. All others all sync."><y>#</y><d>2019-11-19</d><h>06:33</h><r>ikitommi</r>an easy comparison:
‚Ä¢ with middleware: <a href="https://github.com/metosin/reitit/blob/master/examples/ring-swagger/src/example/server.clj" target="_blank">https://github.com/metosin/reitit/blob/master/examples/ring-swagger/src/example/server.clj</a>
‚Ä¢ with interceptors: <a href="https://github.com/metosin/reitit/blob/master/examples/http-swagger/src/example/server.clj" target="_blank">https://github.com/metosin/reitit/blob/master/examples/http-swagger/src/example/server.clj</a>
‚Ä¶ the latter has one route returning a async value, a Manifold Deferred. All others all sync.</z><z id="t1574145262" t="wcalderipe Thanks for sharing it!"><y>#</y><d>2019-11-19</d><h>06:34</h><r>wcalderipe</r>Thanks for sharing it!</z><z id="t1574151760" t="pithyless More interceptor docs: http://pedestal.io/reference/interceptors Although it was really this Cognicast podcast that first introduced me to the reasoning behind Pedestal&apos;s interceptors and how they can be useful in modeling flow (outside of HTTP): http://blog.cognitect.com/cognicast-transcripts/118"><y>#</y><d>2019-11-19</d><h>08:22</h><r>pithyless</r>More interceptor docs: <a href="http://pedestal.io/reference/interceptors" target="_blank">http://pedestal.io/reference/interceptors</a>

Although it was really this Cognicast podcast that first introduced me to the reasoning behind Pedestal&apos;s interceptors and how they can be useful in modeling flow (outside of HTTP):
<a href="http://blog.cognitect.com/cognicast-transcripts/118" target="_blank">http://blog.cognitect.com/cognicast-transcripts/118</a></z><z id="t1574151854" t="pithyless I never really used Pedestal for anything, but I sure am happy that Paul deGrandis introduced me to the interceptor pattern. And it&apos;s nice that with things like metosin/sieppari I can use them without importing pedestal ."><y>#</y><d>2019-11-19</d><h>08:24</h><r>pithyless</r>I never really used Pedestal for anything, but I sure am happy that Paul deGrandis introduced me to the interceptor pattern. And it&apos;s nice that with things like <code>metosin/sieppari</code> I can use them without importing <code>pedestal</code>.</z><z id="t1574290450" t="wcalderipe Thanks for sharing [:attrs {:href &quot;/_/_/users/U05476190&quot;}] I&apos;ll definitely listen to it today"><y>#</y><d>2019-11-20</d><h>22:54</h><r>wcalderipe</r>Thanks for sharing <a>@U05476190</a> I&apos;ll definitely listen to it today</z><z id="t1574275574" t="pithyless I&apos;m seeing this kind of error after pathom Index Explorer is trying to serialize the entire context and push it across the wire. java.lang.Exception: Not supported: class com.wsscode.pathom.connect$fn__54398 java.lang.RuntimeException: java.lang.Exception: Not supported: class com.wsscode.pathom.connect$fn__54398 clojure.lang.ExceptionInfo: Malformed application/transit+json in :muuntaja/encode format: &quot;application/transit+json&quot; type: :muuntaja/encode "><y>#</y><d>2019-11-20</d><h>18:46</h><w>pithyless</w>I&apos;m seeing this kind of error after pathom Index Explorer is trying to serialize the entire context and push it across the wire.
<pre>java.lang.Exception: Not supported: class com.wsscode.pathom.connect$fn__54398
java.lang.RuntimeException: java.lang.Exception: Not supported: class com.wsscode.pathom.connect$fn__54398
clojure.lang.ExceptionInfo: Malformed application/transit+json in :muuntaja/encode
    format: &quot;application/transit+json&quot;
      type: :muuntaja/encode
</pre></z><z id="t1574275615" t="pithyless What is the best way to configure muuntaja to simply ignore things it can&apos;t encode correctly in application/transit+json ?"><y>#</y><d>2019-11-20</d><h>18:46</h><r>pithyless</r>What is the best way to configure muuntaja to simply ignore things it can&apos;t encode correctly in <code>application/transit+json</code>?</z><z id="t1574275641" t="pithyless Is there a way to configure a default handler?"><y>#</y><d>2019-11-20</d><h>18:47</h><r>pithyless</r>Is there a way to configure a default handler?</z><z id="t1574276026" t="ikitommi You are returning a function, which can&apos;t be serialized. I don&apos;t think disabling encoding helps here. I would double-check how to serialize the context."><y>#</y><d>2019-11-20</d><h>18:53</h><r>ikitommi</r>You are returning a function, which can&apos;t be serialized. I don&apos;t think disabling encoding helps here. I would double-check how to serialize the context.</z><z id="t1574276030" t="pithyless Just trying to think this through, I&apos;ve tried e.g.: (def generic-function-writer (transit/write-handler (constantly &quot;fn&quot;) (fn [v] (pr-str v)) (fn [v] (pr-str v)))) (def muuntaja-instance (muuntaja/create (-&gt; muuntaja/default-options (assoc-in [:formats &quot;application/transit+json&quot; :encode-opts] {:handlers {java.util.function.Function generic-function-writer}})))) "><y>#</y><d>2019-11-20</d><h>18:53</h><r>pithyless</r>Just trying to think this through, I&apos;ve tried e.g.:
<pre>(def generic-function-writer
  (transit/write-handler
   (constantly &quot;fn&quot;)
   (fn [v] (pr-str v))
   (fn [v] (pr-str v))))


(def muuntaja-instance
  (muuntaja/create
   (-&gt; muuntaja/default-options
       (assoc-in
        [:formats &quot;application/transit+json&quot; :encode-opts]
        {:handlers {java.util.function.Function generic-function-writer}}))))
</pre></z><z id="t1574276050" t="pithyless But it doesn&apos;t seem to be called (would it match the java.util.function.Function ?"><y>#</y><d>2019-11-20</d><h>18:54</h><r>pithyless</r>But it doesn&apos;t seem to be called (would it match the <code>java.util.function.Function</code>?</z><z id="t1574276100" t="ikitommi you can set response &quot;Content-Type&quot; manually to disable the automatic encoding."><y>#</y><d>2019-11-20</d><h>18:55</h><r>ikitommi</r>you can set response <code>&quot;Content-Type&quot;</code> manually to disable the automatic encoding.</z><z id="t1574276141" t="ikitommi ... but, will most likely to blow up in the web server. Maybe you should invoke the function yourself?"><y>#</y><d>2019-11-20</d><h>18:55</h><r>ikitommi</r>... but, will most likely to blow up in the web server. Maybe you should invoke the function yourself?</z><z id="t1574276240" t="pithyless To clarify, I&apos;m using reitit-http and my router has {:data {:muuntaja my-muuntaja-instance}} ."><y>#</y><d>2019-11-20</d><h>18:57</h><r>pithyless</r>To clarify, I&apos;m using <code>reitit-http</code> and my router has <code>{:data {:muuntaja my-muuntaja-instance}}</code>.</z><z id="t1574276269" t="pithyless I expect, that the (interceptor.muuntaja/format-response-interceptor) should pick up this custom muuntaja instance?"><y>#</y><d>2019-11-20</d><h>18:57</h><r>pithyless</r>I expect, that the <code>(interceptor.muuntaja/format-response-interceptor)</code> should pick up this custom muuntaja instance?</z><z id="t1574276360" t="pithyless This is a weird setup - I didn&apos;t expect to get hit with a serialization problem like this. But it looks like a real thing, and the expected workaround for now: https://wilkerlucio.github.io/pathom/v2/pathom/2.2.0/connect/exploration.html#_fixing_transit_encoding_issues"><y>#</y><d>2019-11-20</d><h>18:59</h><r>pithyless</r>This is a weird setup - I didn&apos;t expect to get hit with a serialization problem like this. But it looks like a real thing, and the expected workaround for now: <a href="https://wilkerlucio.github.io/pathom/v2/pathom/2.2.0/connect/exploration.html#_fixing_transit_encoding_issues" target="_blank">https://wilkerlucio.github.io/pathom/v2/pathom/2.2.0/connect/exploration.html#_fixing_transit_encoding_issues</a></z><z id="t1574277962" t="pithyless I&apos;ve done as you suggested for now [:attrs {:href &quot;/_/_/users/U055NJ5CC&quot;}] - just invoking the custom transit writer myself for this specific route. I&apos;d still like to circle back to this later and figure out a nicer solution. Thanks!"><y>#</y><d>2019-11-20</d><h>19:26</h><r>pithyless</r>I&apos;ve done as you suggested for now <a>@U055NJ5CC</a> - just invoking the custom transit writer myself for this specific route. I&apos;d still like to circle back to this later and figure out a nicer solution. Thanks!</z><z id="t1574371246" t="gzmask I tried http/post and found out the request is only made after I deference the result. can I make it like core.async go block such that the request is made eagerly?"><y>#</y><d>2019-11-21</d><h>21:20</h><w>gzmask</w> I tried http/post and found out the request is only made after I deference the result. can I make it like core.async go block such that the request is made eagerly?</z><z id="t1574372048" t="gzmask found the answer: https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L148 I was expecting over 9000"><y>#</y><d>2019-11-21</d><h>21:34</h><r>gzmask</r>found the answer: <a href="https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L148" target="_blank">https://github.com/ztellman/aleph/blob/master/src/aleph/http.clj#L148</a>
I was expecting over 9000</z><z id="t1574656744" t="ScArcher Would anyone be able to point me towards a simple TCP Client with Aleph? I&apos;m new to Clojure and I&apos;m trying to write a TCP client. I have one working with java interop, but I&apos;d really like to see what it would look like in Aleph. The socket I&apos;m connecting to sends and receives string messages terminated by newline."><y>#</y><d>2019-11-25</d><h>04:39</h><w>ScArcher</w>Would anyone be able to point me towards a simple TCP Client with Aleph? I&apos;m new to Clojure and I&apos;m trying to write a TCP client. I have one working with java interop, but I&apos;d really like to see what it would look like in Aleph. The socket I&apos;m connecting to sends and receives string messages terminated by newline.</z><z id="t1574657038" t="hiredman https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/tcp.clj"><y>#</y><d>2019-11-25</d><h>04:43</h><w>hiredman</w><a href="https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/tcp.clj" target="_blank">https://github.com/ztellman/aleph/blob/master/examples/src/aleph/examples/tcp.clj</a></z><z id="t1578186921" t="jeaye I just started seeing aleph start throwing some wonky handshake error on connection: Invalid handshake response getStatus: 200 OK After digging into it, I found this: https://github.com/ztellman/aleph/issues/21 which mentioned issues with headers, so I took at look at what my headers were. It turns out, the issue here is the authorization header, but I still have no idea why. The header is this: {&quot;Authorization&quot; &quot;Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJtSjB2MENCdzF0dUhqT2pYMGpQTE9zY19oMW96WWo5WXQyeEV6SVpGeDV3In0.eyJqdGkiOiI4ZWYwYzY3My1jZjZiLTRjMmQtODQyZS1mZDY1ZjQyMTI1NmEiLCJleHAiOjE1Nzg3OTA0NzIsIm5iZiI6MCwiaWF0IjoxNTc4MTg1NjcyLCJpc3MiOiJodHRwOi8vYXV0aC5va2xldHNwbGF5LmNvbTo4MDgwL2F1dGgvcmVhbG1zL2xldHNiZXQiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMzlkZWQwODktODIwMi00M2QxLWE4NTgtZTQ3Zjk1ZDU0ZTFiIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoicmVhbC10aW1lLXJlYWQiLCJhdXRoX3RpbWUiOjAsInNlc3Npb25fc3RhdGUiOiIyM2NmZGQ4NC1hMzc1LTRhZTctOTAwNC1jNjNiZWFiMGQxODAiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJjbGllbnRIb3N0IjoiMTcyLjE4LjAuMiIsImNsaWVudElkIjoicmVhbC10aW1lLXJlYWQiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1yZWFsLXRpbWUtcmVhZCIsImNsaWVudEFkZHJlc3MiOiIxNzIuMTguMC4yIiwiZW1haWwiOiJzZXJ2aWNlLWFjY291bnQtcmVhbC10aW1lLXJlYWRAcGxhY2Vob2xkZXIub3JnIn0.llQew9yXjAqajcZXVJz2LgHZN0SsEuRXD3EyW_UCK_vddOPu84_ANElypv1Z9zaa1ffTEuMrs89JyBPBRShh_xMVAAc_QpPRfGas-01Qz4WPwHk4Phs7TMv3VvBwCWRGF4V97ZxmstDs2eTKnR5-NtNiaG-Bzx87ZLHAIUV6sn0bDyhCBX3yOQRg9pPk8KH1fh40NesgRUbQP7CT6ySiT0HzS6s0dvvUdpwk8nmKdMWcoN5EF0UkdeGBcMevCaoMxzpRxU89_NpyUIqT3QKy1x0ulBHySJirRKQr2BnB8WLl25Rj071TYRbSTX5iud7MXyUtc6tQ2j7hBlLUI0TVhw&quot;}"><y>#</y><d>2020-01-05</d><h>01:15</h><w>jeaye</w>I just started seeing aleph start throwing some wonky handshake error on connection: <code>Invalid handshake response getStatus: 200 OK</code>

After digging into it, I found this: <a href="https://github.com/ztellman/aleph/issues/21" target="_blank">https://github.com/ztellman/aleph/issues/21</a> which mentioned issues with headers, so I took at look at what my headers were. It turns out, the issue here is the authorization header, but I still have no idea why. The header is this:

<pre>{&quot;Authorization&quot; &quot;Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJtSjB2MENCdzF0dUhqT2pYMGpQTE9zY19oMW96WWo5WXQyeEV6SVpGeDV3In0.eyJqdGkiOiI4ZWYwYzY3My1jZjZiLTRjMmQtODQyZS1mZDY1ZjQyMTI1NmEiLCJleHAiOjE1Nzg3OTA0NzIsIm5iZiI6MCwiaWF0IjoxNTc4MTg1NjcyLCJpc3MiOiJodHRwOi8vYXV0aC5va2xldHNwbGF5LmNvbTo4MDgwL2F1dGgvcmVhbG1zL2xldHNiZXQiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMzlkZWQwODktODIwMi00M2QxLWE4NTgtZTQ3Zjk1ZDU0ZTFiIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoicmVhbC10aW1lLXJlYWQiLCJhdXRoX3RpbWUiOjAsInNlc3Npb25fc3RhdGUiOiIyM2NmZGQ4NC1hMzc1LTRhZTctOTAwNC1jNjNiZWFiMGQxODAiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJjbGllbnRIb3N0IjoiMTcyLjE4LjAuMiIsImNsaWVudElkIjoicmVhbC10aW1lLXJlYWQiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1yZWFsLXRpbWUtcmVhZCIsImNsaWVudEFkZHJlc3MiOiIxNzIuMTguMC4yIiwiZW1haWwiOiJzZXJ2aWNlLWFjY291bnQtcmVhbC10aW1lLXJlYWRAcGxhY2Vob2xkZXIub3JnIn0.llQew9yXjAqajcZXVJz2LgHZN0SsEuRXD3EyW_UCK_vddOPu84_ANElypv1Z9zaa1ffTEuMrs89JyBPBRShh_xMVAAc_QpPRfGas-01Qz4WPwHk4Phs7TMv3VvBwCWRGF4V97ZxmstDs2eTKnR5-NtNiaG-Bzx87ZLHAIUV6sn0bDyhCBX3yOQRg9pPk8KH1fh40NesgRUbQP7CT6ySiT0HzS6s0dvvUdpwk8nmKdMWcoN5EF0UkdeGBcMevCaoMxzpRxU89_NpyUIqT3QKy1x0ulBHySJirRKQr2BnB8WLl25Rj071TYRbSTX5iud7MXyUtc6tQ2j7hBlLUI0TVhw&quot;}</pre></z><z id="t1578186949" t="jeaye (yes, I&apos;m fine sharing that JWT)"><y>#</y><d>2020-01-05</d><h>01:15</h><w>jeaye</w>(yes, I&apos;m fine sharing that JWT)</z><z id="t1578187318" t="jeaye I thought it was due to length, but it&apos;s not. I can have a much longer header and it works fine. However, I&apos;ve found that various tweaks to this header end up making it work. Note, though: 1. There are no new lines here (Slack&apos;s rendering is bad) 2. There is whitespace, between Bearer and the token, but other headers (even long ones) with whitespace work fine 3. There are no non-visible chars in there (see below) user=&gt; (def v &quot;Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJtSjB2MENCdzF0dUhqT2pYMGpQTE9zY19oMW96WWo5WXQyeEV6SVpGeDV3In0.eyJqdGkiOiI4ZWYwYzY3My1jZjZiLTRjMmQtODQyZS1mZDY1ZjQyMTI1NmEiLCJleHAiOjE1Nzg3OTA0NzIsIm5iZiI6MCwiaWF0IjoxNTc4MTg1NjcyLCJpc3MiOiJodHRwOi8vYXV0aC5va2xldHNwbGF5LmNvbTo4MDgwL2F1dGgvcmVhbG1zL2xldHNiZXQiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMzlkZWQwODktODIwMi00M2QxLWE4NTgtZTQ3Zjk1ZDU0ZTFiIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoicmVhbC10aW1lLXJlYWQiLCJhdXRoX3RpbWUiOjAsInNlc3Npb25fc3RhdGUiOiIyM2NmZGQ4NC1hMzc1LTRhZTctOTAwNC1jNjNiZWFiMGQxODAiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJjbGllbnRIb3N0IjoiMTcyLjE4LjAuMiIsImNsaWVudElkIjoicmVhbC10aW1lLXJlYWQiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1yZWFsLXRpbWUtcmVhZCIsImNsaWVudEFkZHJlc3MiOiIxNzIuMTguMC4yIiwiZW1haWwiOiJzZXJ2aWNlLWFjY291bnQtcmVhbC10aW1lLXJlYWRAcGxhY2Vob2xkZXIub3JnIn0.llQew9yXjAqajcZXVJz2LgHZN0SsEuRXD3EyW_UCK_vddOPu84_ANElypv1Z9zaa1ffTEuMrs89JyBPBRShh_xMVAAc_QpPRfGas-01Qz4WPwHk4Phs7TMv3VvBwCWRGF4V97ZxmstDs2eTKnR5-NtNiaG-Bzx87ZLHAIUV6sn0bDyhCBX3yOQRg9pPk8KH1fh40NesgRUbQP7CT6ySiT0HzS6s0dvvUdpwk8nmKdMWcoN5EF0UkdeGBcMevCaoMxzpRxU89_NpyUIqT3QKy1x0ulBHySJirRKQr2BnB8WLl25Rj071TYRbSTX5iud7MXyUtc6tQ2j7hBlLUI0TVhw&quot;) #&apos;user/v user=&gt; (-&gt; v sort distinct) (\space \- \. \0 \1 \2 \3 \4 \5 \6 \7 \8 \9 \A \B \C \D \E \F \G \H \I \J \K \L \M \N \O \P \Q \R \S \T \U \V \W \X \Y \Z \_ \a \b \c \d \e \f \g \h \i \j \k \l \m \n \o \p \q \r \s \t \u \v \w \x \y \z)"><y>#</y><d>2020-01-05</d><h>01:21</h><w>jeaye</w>I thought it was due to length, but it&apos;s not. I can have a much longer header and it works fine. However, I&apos;ve found that various tweaks to this header end up making it work. Note, though:

1. There are no new lines here (Slack&apos;s rendering is bad)
2. There is whitespace, between <code>Bearer</code> and the token, but other headers (even long ones) with whitespace work fine
3. There are no non-visible chars in there (see below)
<pre>user=&gt; (def v &quot;Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJtSjB2MENCdzF0dUhqT2pYMGpQTE9zY19oMW96WWo5WXQyeEV6SVpGeDV3In0.eyJqdGkiOiI4ZWYwYzY3My1jZjZiLTRjMmQtODQyZS1mZDY1ZjQyMTI1NmEiLCJleHAiOjE1Nzg3OTA0NzIsIm5iZiI6MCwiaWF0IjoxNTc4MTg1NjcyLCJpc3MiOiJodHRwOi8vYXV0aC5va2xldHNwbGF5LmNvbTo4MDgwL2F1dGgvcmVhbG1zL2xldHNiZXQiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMzlkZWQwODktODIwMi00M2QxLWE4NTgtZTQ3Zjk1ZDU0ZTFiIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoicmVhbC10aW1lLXJlYWQiLCJhdXRoX3RpbWUiOjAsInNlc3Npb25fc3RhdGUiOiIyM2NmZGQ4NC1hMzc1LTRhZTctOTAwNC1jNjNiZWFiMGQxODAiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJjbGllbnRIb3N0IjoiMTcyLjE4LjAuMiIsImNsaWVudElkIjoicmVhbC10aW1lLXJlYWQiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1yZWFsLXRpbWUtcmVhZCIsImNsaWVudEFkZHJlc3MiOiIxNzIuMTguMC4yIiwiZW1haWwiOiJzZXJ2aWNlLWFjY291bnQtcmVhbC10aW1lLXJlYWRAcGxhY2Vob2xkZXIub3JnIn0.llQew9yXjAqajcZXVJz2LgHZN0SsEuRXD3EyW_UCK_vddOPu84_ANElypv1Z9zaa1ffTEuMrs89JyBPBRShh_xMVAAc_QpPRfGas-01Qz4WPwHk4Phs7TMv3VvBwCWRGF4V97ZxmstDs2eTKnR5-NtNiaG-Bzx87ZLHAIUV6sn0bDyhCBX3yOQRg9pPk8KH1fh40NesgRUbQP7CT6ySiT0HzS6s0dvvUdpwk8nmKdMWcoN5EF0UkdeGBcMevCaoMxzpRxU89_NpyUIqT3QKy1x0ulBHySJirRKQr2BnB8WLl25Rj071TYRbSTX5iud7MXyUtc6tQ2j7hBlLUI0TVhw&quot;)
#&apos;user/v
user=&gt; (-&gt; v sort distinct)
(\space \- \. \0 \1 \2 \3 \4 \5 \6 \7 \8 \9 \A \B \C \D \E \F \G \H \I \J \K \L \M \N \O \P \Q \R \S \T \U \V \W \X \Y \Z \_ \a \b \c \d \e \f \g \h \i \j \k \l \m \n \o \p \q \r \s \t \u \v \w \x \y \z)</pre></z><z id="t1578187348" t="jeaye Any ideas?"><y>#</y><d>2020-01-05</d><h>01:22</h><w>jeaye</w>Any ideas?</z><z id="t1578187525" t="jeaye Actually, if I make any change to the value (remove a single space, add a single space, remove or add single chars, lower-casing something, etc), aleph doesn&apos;t fail the handshake. Only this exact value does; is aleph doing some JWT validation on its own, which is trying to interpret this string?"><y>#</y><d>2020-01-05</d><h>01:25</h><w>jeaye</w>Actually, if I make any change to the value (remove a single space, add a single space, remove or add single chars, lower-casing something, etc), aleph doesn&apos;t fail the handshake. Only this exact value does; is aleph doing some JWT validation on its own, which is trying to interpret this string?</z><z id="t1578188657" t="jeaye Ok, crisis averted. The issue was with some other middleware we had. I&apos;m sorry for ever doubting you, aleph."><y>#</y><d>2020-01-05</d><h>01:44</h><w>jeaye</w>Ok, crisis averted. The issue was with some other middleware we had. I&apos;m sorry for ever doubting you, aleph.</z><z id="t1578655904" t="cddr Aleph maintenance in the running for clojure together funding... https://www.clojuriststogether.org/news/q1-2020-survey-results/"><y>#</y><d>2020-01-10</d><h>11:31</h><w>cddr</w>Aleph maintenance in the running for clojure together funding...

<a href="https://www.clojuriststogether.org/news/q1-2020-survey-results/" target="_blank">https://www.clojuriststogether.org/news/q1-2020-survey-results/</a></z><z id="t1578917430" t="lmergen i recall it was in Q1 or Q2 2019 as well"><y>#</y><d>2020-01-13</d><h>12:10</h><w>lmergen</w>i recall it was in Q1 or Q2 2019 as well</z><z id="t1579017549" t="rschmukler Hey all! Are there any maintainers of this on clojars besides ztellman? A whole bunch of websocket fixes got released after the last release and it&apos;d be great to get them into my project. Normally I&apos;d just use git, but I&apos;m on tools.deps and there&apos;s no deps.edn or pom.xml committed for it to use üòû"><y>#</y><d>2020-01-14</d><h>15:59</h><w>rschmukler</w>Hey all! Are there any maintainers of this on clojars besides ztellman? A whole bunch of websocket fixes got released after the last release and it&apos;d be great to get them into my project. Normally I&apos;d just use git, but I&apos;m on tools.deps and there&apos;s no <code>deps.edn</code> or <code>pom.xml</code> committed for it to use <b>üòû</b></z><z id="t1579163892" t="miikka [:attrs {:href &quot;/_/_/users/UEC8W94AE&quot;}] Fork the repo on Github, run lein pom, commit and push pom.xml and use git deps üòõ"><y>#</y><d>2020-01-16</d><h>08:38</h><w>miikka</w><a>@rschmukler</a> Fork the repo on Github, run lein pom, commit and push pom.xml and use git deps <b>üòõ</b></z><z id="t1579188670" t="rschmukler [:attrs {:href &quot;/_/_/users/U1NDXLDUG&quot;}] That does indeed seem to be the move üòõ"><y>#</y><d>2020-01-16</d><h>15:31</h><w>rschmukler</w><a>@miikka</a> That does indeed seem to be the move <b>üòõ</b></z><z id="t1579241529" t="miikka It‚Äôs not great but it works"><y>#</y><d>2020-01-17</d><h>06:12</h><w>miikka</w> It‚Äôs not great but it works</z><z id="t1579274809" t="Dan Hi all - does anyone have any experience with using raw-stream? as an option when consuming data via aleph‚Äôs websocket-client ? My understanding after reading some of Netty‚Äôs docs is that I‚Äôll need to call release on the ByteBuf object when I‚Äôm done processing it and I‚Äôm just wondering if it‚Äôs actually that simple‚Ä¶?"><y>#</y><d>2020-01-17</d><h>15:26</h><w>Dan</w>Hi all - does anyone have any experience with using <code>raw-stream?</code> as an option when consuming data via aleph‚Äôs <code>websocket-client</code>? My understanding after reading some of Netty‚Äôs docs is that I‚Äôll need to call <code>release</code> on the ByteBuf object when I‚Äôm done processing it and I‚Äôm just wondering if it‚Äôs actually that simple‚Ä¶?</z><z id="t1579774502" t="igrishaev A small question: what is the best way to implement a ‚Äúworker‚Äù entity? By this I mean a separate loop/recur in the background which consumes a stream? Say I have a stream of events and would like to process them by four workers."><y>#</y><d>2020-01-23</d><h>10:15</h><w>igrishaev</w>A small question: what is the best way to implement a ‚Äúworker‚Äù entity? By this I mean a separate loop/recur in the background which consumes a stream? Say I have a stream of events and would like to process them by four workers.</z><z id="t1579775343" t="flowthing Well, I guess you could use manifold.stream/consume or manifold.stream/consume-async , at least. Or, depending on what you&apos;re trying to do, you could also look at manifold.bus ."><y>#</y><d>2020-01-23</d><h>10:29</h><r>flowthing</r>Well, I guess you could use <code>manifold.stream/consume</code> or <code>manifold.stream/consume-async</code>, at least. Or, depending on what you&apos;re trying to do, you could also look at <code>manifold.bus</code>.</z><z id="t1579783107" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U1WAUKQ3E&quot;}] we have map-concurrently which uses stream-buffers to control concurrency of non-blocking ops (or Futures wrapping blocking ops) - https://gist.github.com/mccraigmccraig/b10156ed0b59de6ccc93dbb1115df7c9"><y>#</y><d>2020-01-23</d><h>12:38</h><r>mccraigmccraig</r><a>@U1WAUKQ3E</a> we have <code>map-concurrently</code> which uses stream-buffers to control concurrency of non-blocking ops (or <code>Futures</code>  wrapping blocking ops) - <a href="https://gist.github.com/mccraigmccraig/b10156ed0b59de6ccc93dbb1115df7c9" target="_blank">https://gist.github.com/mccraigmccraig/b10156ed0b59de6ccc93dbb1115df7c9</a></z><z id="t1579783174" t="igrishaev Thanks, looks interesting, let me read."><y>#</y><d>2020-01-23</d><h>12:39</h><r>igrishaev</r>Thanks, looks interesting, let me read.</z><z id="t1579783573" t="mccraigmccraig our general pattern is to map-concurrently then reduce to consume the stream"><y>#</y><d>2020-01-23</d><h>12:46</h><r>mccraigmccraig</r>our general pattern is to <code>map-concurrently</code> then <code>reduce</code> to consume the stream</z><z id="t1579783638" t="mccraigmccraig we&apos;ve also wrapped all the core manifold.stream functions to propagate errors sensibly - errors during map get captured in a marker record on the output stream, and returned (as an errored deferred) by any reduce"><y>#</y><d>2020-01-23</d><h>12:47</h><r>mccraigmccraig</r>we&apos;ve also wrapped all the core <code>manifold.stream</code> functions to propagate errors sensibly - errors during <code>map</code> get captured in a marker record on the output stream, and returned (as an errored deferred) by any <code>reduce</code></z><z id="t1579783778" t="igrishaev Still, I‚Äôm looking for something like that: (let [stream (...) limit 4] (doseq [n limit] (spawn-worker stream msg-function)))"><y>#</y><d>2020-01-23</d><h>12:49</h><r>igrishaev</r>Still, I‚Äôm looking for something like that:
<pre>(let [stream (...)
      limit 4]
  (doseq [n limit]
    (spawn-worker stream msg-function)))</pre></z><z id="t1579783799" t="igrishaev what should be in spawn-worker ?"><y>#</y><d>2020-01-23</d><h>12:49</h><r>igrishaev</r>what should be in <code>spawn-worker</code> ?</z><z id="t1579784917" t="mccraigmccraig we would do (-&gt;&gt; stream (map-concurrently 4 #(run-task whatever %)) (reduce conj [])) to run 4 concurrent tasks over a stream - we don&apos;t really use &quot;workers&quot; as such, which would probably need a queue to feed them etc."><y>#</y><d>2020-01-23</d><h>13:08</h><r>mccraigmccraig</r>we would do <code>(-&gt;&gt; stream (map-concurrently 4 #(run-task whatever %)) (reduce conj []))</code>  to run 4 concurrent tasks over a stream - we don&apos;t really use &quot;workers&quot;  as such, which would probably need a queue to feed them etc.</z><z id="t1579785188" t="mccraigmccraig most of our tasks are non-blocking, but for the (rare) cases in our platform where run-task is a blocking thing we wrap it in a deferred/future"><y>#</y><d>2020-01-23</d><h>13:13</h><r>mccraigmccraig</r>most of our tasks are non-blocking, but for the (rare) cases in our platform where <code>run-task</code>  is a blocking thing we wrap it in a <code>deferred/future</code></z><z id="t1579774600" t="igrishaev (let [stream (get-stream) number 4] (doseq [n number] (d/loop [] (let [message (get-from-stream stream)] (process-message message) (d/recur)))))"><y>#</y><d>2020-01-23</d><h>10:16</h><w>igrishaev</w><pre>(let [stream (get-stream)
      number 4]
  (doseq [n number]
    (d/loop []
      (let [message (get-from-stream stream)]
        (process-message message)
        (d/recur)))))</pre></z><z id="t1579774629" t="igrishaev Am I right?"><y>#</y><d>2020-01-23</d><h>10:17</h><w>igrishaev</w>Am I right?</z><z id="t1579779716" t="cddr The devil is in the detail. Do you care about order? What if item-a got popped off the stream by the first loop and for some reason takes a long time to process, meanwhile item-b got popped off by the second loop and gets processed immediately."><y>#</y><d>2020-01-23</d><h>11:41</h><w>cddr</w>The devil is in the detail. Do you care about order? What if <code>item-a</code> got popped off the stream by the first loop and for some reason takes a long time to process, meanwhile <code>item-b</code> got popped off by the second loop and gets processed immediately.</z><z id="t1579781739" t="igrishaev No the order is not important."><y>#</y><d>2020-01-23</d><h>12:15</h><w>igrishaev</w>No the order is not important.</z><z id="t1579888882" t="cddr Think that&apos;ll probably work then"><y>#</y><d>2020-01-24</d><h>18:01</h><w>cddr</w>Think that&apos;ll probably work then</z><z id="t1580522517" t="vincentjames501 Any manifold experts here? Is there something idiomatically wrong with this or a better approach? We need to poll a stream for a new value and take an action on timeout. When this runs, we eventually hit 100% cpu and the garbage collector starts going crazy. (let [shutdown (d/deferred) s (s/stream)] (d/loop [] (d/chain (s/try-take! s nil 100 ::timeout) (fn [_] (when-not (d/realized? shutdown) (d/recur))))) shutdown) If you change the timeout from 100 to 1, the problem happens within a minute and you‚Äôll also see this: WARNING: excessive pending takes (&gt; 16384), closing stream java.lang.IllegalStateException at manifold.stream.default.Stream.take(default.clj:234) at foo.manifold_test$run_BANG_$this__2988__auto____4284$fn__4285.invoke(manifold_test.clj:10) at foo.manifold_test$run_BANG_$this__2988__auto____4284.invoke(manifold_test.clj:9) at clojure.lang.AFn.applyToHelper(AFn.java:154) at clojure.lang.AFn.applyTo(AFn.java:144) at clojure.core$apply.invokeStatic(core.clj:667) at clojure.core$apply.invoke(core.clj:660) at foo.manifold_test$run_BANG_$this__2988__auto____4284$fn__4289.invoke(manifold_test.clj:9) at manifold.deferred.Listener.onSuccess(deferred.clj:219) at manifold.deferred.Deferred$fn__2673.invoke(deferred.clj:398) ... "><y>#</y><d>2020-02-01</d><h>02:01</h><w>vincentjames501</w>Any manifold experts here?

Is there something idiomatically wrong with this or a better approach? We need to poll a stream for a new value and take an action on timeout. When this runs, we eventually hit 100% cpu and the garbage collector starts going crazy.

<pre>(let [shutdown (d/deferred)
      s (s/stream)]
    (d/loop []
      (d/chain (s/try-take! s nil 100 ::timeout)
               (fn [_]
                 (when-not (d/realized? shutdown)
                   (d/recur)))))
    shutdown)</pre>
If you change the timeout from 100 to 1, the problem happens within a minute and you‚Äôll also see this:
<pre>WARNING: excessive pending takes (&gt; 16384), closing stream
java.lang.IllegalStateException
	at manifold.stream.default.Stream.take(default.clj:234)
	at foo.manifold_test$run_BANG_$this__2988__auto____4284$fn__4285.invoke(manifold_test.clj:10)
	at foo.manifold_test$run_BANG_$this__2988__auto____4284.invoke(manifold_test.clj:9)
	at clojure.lang.AFn.applyToHelper(AFn.java:154)
	at clojure.lang.AFn.applyTo(AFn.java:144)
	at clojure.core$apply.invokeStatic(core.clj:667)
	at clojure.core$apply.invoke(core.clj:660)
	at foo.manifold_test$run_BANG_$this__2988__auto____4284$fn__4289.invoke(manifold_test.clj:9)
	at manifold.deferred.Listener.onSuccess(deferred.clj:219)
	at manifold.deferred.Deferred$fn__2673.invoke(deferred.clj:398)
	...</pre>
</z><z id="t1580552662" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U0BCYM09K&quot;}] can&apos;t say I&apos;ve used try-take! much, but you could try repeating a deferred timeout on the try-take! deferred instead of repeating the try-take!"><y>#</y><d>2020-02-01</d><h>10:24</h><w>mccraigmccraig</w><a>@vincentjames501</a> can&apos;t say I&apos;ve used <code>try-take!</code> much, but you could try  repeating a deferred timeout on the <code>try-take!</code> deferred instead of repeating the <code>try-take!</code></z><z id="t1580736301" t="cddr [:attrs {:href &quot;/_/_/users/U0BCYM09K&quot;}] I think if you make the try-take! part of the loop argument, then when you recur you can recur with another call to try-take! which should slow it down. (d/loop [msg (s/try-take! s nil 100 ::timeout)] (d/chain msg (fn [msg] (if (= ::timeout msg) (do (backoff-a-bit) (d/recur (s/try-take! s nil 100 ::timeout))) (d/recur (s/try-take! s nil 100 ::timeout))))))"><y>#</y><d>2020-02-03</d><h>13:25</h><w>cddr</w><a>@vincentjames501</a> I think if you make the <code>try-take!</code> part of the loop argument, then when you <code>recur</code> you can recur with another call to <code>try-take!</code> which should slow it down.

<pre>(d/loop [msg (s/try-take! s nil 100 ::timeout)]
  (d/chain msg
    (fn [msg]
      (if (= ::timeout msg)
         (do (backoff-a-bit)
             (d/recur (s/try-take! s nil 100 ::timeout)))
         (d/recur (s/try-take! s nil 100 ::timeout))))))</pre></z><z id="t1581505786" t="erik I&apos;m trying to create a stream from an existing stream xs in a way that put! s are automatically encoded to JSON and takes! decoded from JSON ‚Äî¬†it doesn&apos;t seem possible with the current API; should I just create two separate streams, one that is sink-only and another that is source-only?"><y>#</y><d>2020-02-12</d><h>11:09</h><w>erik</w>I&apos;m trying to create a stream from an existing stream <code>xs</code> in a way that <code>put!</code>s are automatically encoded to JSON and <code>takes!</code> decoded from JSON ‚Äî¬†it doesn&apos;t seem possible with the current API;  should I just create two separate streams, one that is sink-only and another that is source-only?</z><z id="t1581505803" t="erik the question is about Manifold not Aleph, but I thought this would be the right place to ask nevertheless"><y>#</y><d>2020-02-12</d><h>11:10</h><w>erik</w>the question is about Manifold not Aleph, but I thought this would be the right place to ask nevertheless</z><z id="t1581507330" t="mccraigmccraig i don&apos;t know that you can do that [:attrs {:href &quot;/_/_/users/UECLGBLES&quot;}] - there&apos;s just the single xform on the stream constructor"><y>#</y><d>2020-02-12</d><h>11:35</h><w>mccraigmccraig</w>i don&apos;t know that you can do that <a>@eallik</a> - there&apos;s just the single <code>xform</code> on the <code>stream</code> constructor</z><z id="t1581507363" t="mccraigmccraig but why do you want to do that ? why not just put the object directly on the stream ?"><y>#</y><d>2020-02-12</d><h>11:36</h><w>mccraigmccraig</w>but why do you want to do that ? why not just put the object directly on the stream ?</z><z id="t1581507401" t="erik I have WS connections for exchanging messages in JSON format."><y>#</y><d>2020-02-12</d><h>11:36</h><w>erik</w>I have WS connections for exchanging messages in JSON format.</z><z id="t1581507430" t="erik I thought I&apos;d just remove the hassle of json-&gt; and -&gt;json every time I take! from or put! to a connection"><y>#</y><d>2020-02-12</d><h>11:37</h><w>erik</w>I thought I&apos;d just remove the hassle of <code>json-&gt;</code> and <code>-&gt;json</code> every time I <code>take!</code> from or <code>put!</code> to a connection</z><z id="t1581507481" t="mccraigmccraig (stream/transform (map json-&gt;) s)"><y>#</y><d>2020-02-12</d><h>11:38</h><w>mccraigmccraig</w><code>(stream/transform (map json-&gt;) s)</code></z><z id="t1581507496" t="mccraigmccraig (stream/transform (map -&gt;json) s)"><y>#</y><d>2020-02-12</d><h>11:38</h><w>mccraigmccraig</w><code>(stream/transform (map -&gt;json) s)</code></z><z id="t1581507512" t="erik and then make one sink-only and the other source-only ?"><y>#</y><d>2020-02-12</d><h>11:38</h><w>erik</w>and then make one <code>sink-only</code> and the other <code>source-only</code>?</z><z id="t1581507513" t="mccraigmccraig will those not do the trick ?"><y>#</y><d>2020-02-12</d><h>11:38</h><w>mccraigmccraig</w>will those not do the trick ?</z><z id="t1581507824" t="mccraigmccraig yes, use sink-only and source-only where it makes sense"><y>#</y><d>2020-02-12</d><h>11:43</h><w>mccraigmccraig</w>yes, use <code>sink-only</code> and <code>source-only</code> where it makes sense</z><z id="t1581507887" t="erik wait, transform returns a source, not a stream"><y>#</y><d>2020-02-12</d><h>11:44</h><w>erik</w>wait, <code>transform</code> returns a source, not a stream</z><z id="t1581507908" t="erik (stream/transform (map json-&gt;) s) makes sense but the other doesn&apos;t"><y>#</y><d>2020-02-12</d><h>11:45</h><w>erik</w><code>(stream/transform (map json-&gt;) s)</code> makes sense but the other doesn&apos;t</z><z id="t1581507975" t="mccraigmccraig ah, ok - in which case does a plain (stream/map -&gt;json s) do the trick for you ? iirc stream/map is very simply implemented with connect-via"><y>#</y><d>2020-02-12</d><h>11:46</h><w>mccraigmccraig</w>ah, ok - in which case does a plain <code>(stream/map -&gt;json s)</code> do the trick for you ? iirc <code>stream/map</code> is very simply implemented with <code>connect-via</code></z><z id="t1581508115" t="erik (defn convert-stream [f-src f-dst s] (let [src (s/map f-src s) sink (s/stream)] (s/connect-via sink #(s/put! s (f-dst %)) s) (s/splice sink src)))"><y>#</y><d>2020-02-12</d><h>11:48</h><w>erik</w><pre>(defn convert-stream [f-src f-dst s]
  (let [src (s/map f-src s)
        sink (s/stream)]
    (s/connect-via sink #(s/put! s (f-dst %)) s)
    (s/splice sink src)))</pre></z><z id="t1581508139" t="erik this is what I came up with. new to Manifold, making sure I got it right."><y>#</y><d>2020-02-12</d><h>11:48</h><w>erik</w>this is what I came up with.  new to Manifold, making sure I got it right.</z><z id="t1581508340" t="mccraigmccraig looks like it will work"><y>#</y><d>2020-02-12</d><h>11:52</h><w>mccraigmccraig</w>looks like it will work</z><z id="t1581508365" t="mccraigmccraig (without me doing any testing, anyway üò¨ )"><y>#</y><d>2020-02-12</d><h>11:52</h><w>mccraigmccraig</w>(without me doing any testing, anyway <b>üò¨</b>)</z><z id="t1581542399" t="erik it worked when I changed to (s/connect-via sink #(s/put! s (f-src %)) s) ‚Äî I got confused by the fact that messages should be delivered from the sink to the source, because on the outside, they are written to the sink and read from the source"><y>#</y><d>2020-02-12</d><h>21:19</h><w>erik</w>it worked when I changed to <code>(s/connect-via sink #(s/put! s (f-src %)) s)</code> ‚Äî I got confused by the fact that messages should be delivered from the sink to the source, because on the outside, they are written to the sink and read from the source</z><z id="t1581542450" t="erik in fact, the names f-src and f-dst are confusion ‚Äî they should instead be f-sink and f-source to indicate which one gets applied to which end of s"><y>#</y><d>2020-02-12</d><h>21:20</h><w>erik</w>in fact, the names <code>f-src</code> and <code>f-dst</code> are confusion ‚Äî they should instead be <code>f-sink</code> and <code>f-source</code> to indicate which one gets applied to which end of <code>s</code></z><z id="t1581542556" t="erik also, it seems that it only makes sense to use my convert-stream over duplex streams, otherwise any value put! on the sink will be passed thru both functions"><y>#</y><d>2020-02-12</d><h>21:22</h><w>erik</w>also, it seems that it only makes sense to use my <code>convert-stream</code> over duplex streams, otherwise any value <code>put!</code> on the sink will be passed thru both functions</z><z id="t1581542572" t="erik does that make sense?"><y>#</y><d>2020-02-12</d><h>21:22</h><w>erik</w>does that make sense?</z><z id="t1581581015" t="mccraigmccraig yeah, that seems to make sense - it&apos;s a bit of an unfamiliar use-case for me - we have precisely 1 duplex stream in our whole (decent sized - 238 namespaces require manifold.stream ) codebase, and that, like yours, is the websocket stream. most of our stream ops are data-transformations"><y>#</y><d>2020-02-13</d><h>08:03</h><w>mccraigmccraig</w>yeah, that seems to make sense - it&apos;s a bit of an unfamiliar use-case for me - we have precisely 1 duplex stream in our whole (decent sized - 238 namespaces require <code>manifold.stream</code>) codebase, and that, like yours, is the websocket stream. most of our stream ops are data-transformations</z><z id="t1581581098" t="mccraigmccraig there is also the xform based stream constructor you could use - (s/stream 0 (map -&gt;json)) although you&apos;d have to use a s/connect too, so i&apos;m not sure that&apos;s any more succinct than s/connect-via"><y>#</y><d>2020-02-13</d><h>08:04</h><w>mccraigmccraig</w>there is also the <code>xform</code> based stream constructor you could use - <code>(s/stream 0 (map -&gt;json))</code> although you&apos;d have to use a <code>s/connect</code> too, so i&apos;m not sure that&apos;s any more succinct than <code>s/connect-via</code></z><z id="t1581608202" t="erik yes"><y>#</y><d>2020-02-13</d><h>15:36</h><w>erik</w>yes</z><z id="t1583117427" t="sofra Hi all, when using the Aleph http client there are a few different timeout options. the last two are the ones I am curious about `request-timeout` | timeout in milliseconds for the arrival of a response over the established connection `read-timeout` | timeout in milliseconds for the response to be completed is request-timeout then the full time for request to response and the read-time the time taken to process the response once it has come back?"><y>#</y><d>2020-03-02</d><h>02:50</h><w>sofra</w>Hi all, when using the Aleph http client there are a few different timeout options.
the last two are the ones I am curious about
<pre>`request-timeout` | timeout in milliseconds for the arrival of a response over the established connection
`read-timeout` | timeout in milliseconds for the response to be completed</pre>
is <code>request-timeout</code> then the full time for request to response and the <code>read-time</code> the time taken to process the response once it has come back?</z><z id="t1583228058" t="lmergen request timeout is the timeout of the arrival of the first packet, read timeout the timeout for subsequent packets "><y>#</y><d>2020-03-03</d><h>09:34</h><w>lmergen</w>request timeout is the timeout of the arrival of the first packet, read timeout the timeout for subsequent packets </z><z id="t1583335451" t="Timur Latypoff Is there a way to make aleph&apos;s TCP server (or my own stream handler) detect that TCP client is too slow, in order to drop the connection to prevent infinite buffering of old data? From what I experience, the TCP socket buffers (server side + client side + intermediary router buffers I guess) could store minutes of stale data, I would love to find a way to prevent it."><y>#</y><d>2020-03-04</d><h>15:24</h><w>Timur Latypoff</w>Is there a way to make aleph&apos;s TCP server (or my own stream handler) detect that TCP client is too slow, in order to drop the connection to prevent infinite buffering of old data?

From what I experience, the TCP socket buffers (server side + client side + intermediary router buffers I guess) could store minutes of stale data, I would love to find a way to prevent it.</z><z id="t1583338255" t="mccraigmccraig how do you want it to behave [:attrs {:href &quot;/_/_/users/UTXR46DS6&quot;}] ? would the timeout on connect work for you ? https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L300"><y>#</y><d>2020-03-04</d><h>16:10</h><w>mccraigmccraig</w>how do you want it to behave <a>@timur058</a>? would the timeout on <code>connect</code> work for you ? <a href="https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L300" target="_blank">https://github.com/ztellman/manifold/blob/master/src/manifold/stream.clj#L300</a></z><z id="t1583339647" t="Timur Latypoff I think it would, if sending outgoing messages actually slowed down. For some reason, I don&apos;t feel the back pressure from the system ‚Äî¬†it seems to gorge all my outgoing messages into its endless internal socket buffers without slowing me down as their producer. At the same time, my consumer received messages with bigger and bigger delay. It there a way to maybe reduce outgoing TCP buffer?"><y>#</y><d>2020-03-04</d><h>16:34</h><r>Timur Latypoff</r>I think it would, if sending outgoing messages actually slowed down.

For some reason, I don&apos;t feel the back pressure from the system ‚Äî¬†it seems to gorge all my outgoing messages into its endless internal socket buffers without slowing me down as their producer. At the same time, my consumer received messages with bigger and bigger delay.

It there a way to maybe reduce outgoing TCP buffer?</z><z id="t1583340503" t="mccraigmccraig sadly beyond my ken, i&apos;ve not done anything serious with tcp and aleph"><y>#</y><d>2020-03-04</d><h>16:48</h><r>mccraigmccraig</r>sadly beyond my ken, i&apos;ve not done anything serious with tcp and aleph</z><z id="t1583341184" t="hiredman You could write something like https://github.com/hiredman/roundabout/blob/master/src/com/manigfeald/roundabout.cljc for manifold"><y>#</y><d>2020-03-04</d><h>16:59</h><w>hiredman</w>You could write something like <a href="https://github.com/hiredman/roundabout/blob/master/src/com/manigfeald/roundabout.cljc" target="_blank">https://github.com/hiredman/roundabout/blob/master/src/com/manigfeald/roundabout.cljc</a> for manifold</z><z id="t1583413765" t="Timur Latypoff This is some kind of rate-limiting solution for manifold streams, right?"><y>#</y><d>2020-03-05</d><h>13:09</h><r>Timur Latypoff</r>This is some kind of rate-limiting solution for manifold streams, right?</z><z id="t1583426316" t="hiredman It is flow control, not entirely the same thing as rate limiting, and it is using core.async, not manifold, but a similar approach there would allow you to directly control the rate of flow without having to wait for back pressure from lower level buffers filling up"><y>#</y><d>2020-03-05</d><h>16:38</h><r>hiredman</r>It is flow control, not entirely the same thing as rate limiting, and it is using core.async, not manifold, but a similar approach there would allow you to directly control the rate of flow without having to wait for back pressure from lower level buffers filling up</z><z id="t1583481689" t="Timur Latypoff [:attrs {:href &quot;/_/_/users/U0NCTKEV8&quot;}] I see. Thank you for the tip. I kind of want to see what could be done automatically, based on how slow the network client is. My use case is streaming real-time financial data (e.g. exchange quotes) ‚Äî there‚Äôs a lot of data, and sometimes consumer could get slow to process it. I would like to detect the situation ‚Äî and to start programmatically filtering out some non-essential data to reduce bandwidth requirements (instead of building up delivery delays for real-time data). To be fair, it‚Äôs not Clojure- or aleph-related question per se, more like general TCP server question. I am using aleph, so I thought maybe other people using aleph servers know best practices in this case."><y>#</y><d>2020-03-06</d><h>08:01</h><r>Timur Latypoff</r><a>@U0NCTKEV8</a> I see. Thank you for the tip.

I kind of want to see what could be done automatically, based on how slow the network client is.

My use case is streaming real-time financial data (e.g. exchange quotes) ‚Äî there‚Äôs a lot of data, and sometimes consumer could get slow to process it. I would like to detect the situation ‚Äî and to start programmatically filtering out some non-essential data to reduce bandwidth requirements (instead of building up delivery delays for real-time data).

To be fair, it‚Äôs not Clojure- or aleph-related question per se, more like general TCP server question. I am using aleph, so I thought maybe other people using aleph servers know best practices in this case.</z><z id="t1584086565" t="Ramon Rios Hello everyone. Does someone already tried to handle erros while your using stream/consume ??"><y>#</y><d>2020-03-13</d><h>08:02</h><w>Ramon Rios</w>Hello everyone. Does someone already tried to handle erros while your using <code>stream/consume</code> ??</z><z id="t1584086822" t="mccraigmccraig what do you want to happen when there are errors in your callback [:attrs {:href &quot;/_/_/users/UNST81B9P&quot;}] ?"><y>#</y><d>2020-03-13</d><h>08:07</h><w>mccraigmccraig</w>what do you want to happen when there are errors in your callback <a>@ramonp.rios</a> ?</z><z id="t1584086837" t="Ramon Rios Let me give some code"><y>#</y><d>2020-03-13</d><h>08:07</h><w>Ramon Rios</w>Let me give some code</z><z id="t1584086842" t="Ramon Rios and then explain"><y>#</y><d>2020-03-13</d><h>08:07</h><w>Ramon Rios</w>and then explain</z><z id="t1584086896" t="Ramon Rios (let¬†[handler¬†(fn¬†[msg] ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†(log/info¬†(str¬†&quot;creating¬†customer¬†into¬†&quot;¬†http-url¬†&quot;¬†:¬†&quot;¬†msg)) ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†(-&gt;&gt;¬†@(add-customer-ror¬†http-url¬†msg) ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†(log/info¬†&quot;returned¬†from¬†server¬†&quot;))) ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†stream¬†(m/topic-&gt;stream¬†conn¬†topic)] ¬†¬†¬†¬†¬†¬†(ms/consume¬†handler¬†stream))"><y>#</y><d>2020-03-13</d><h>08:08</h><w>Ramon Rios</w><pre>(let¬†[handler¬†(fn¬†[msg]
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†(log/info¬†(str¬†&quot;creating¬†customer¬†into¬†&quot;¬†http-url¬†&quot;¬†:¬†&quot;¬†msg))
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†(-&gt;&gt;¬†@(add-customer-ror¬†http-url¬†msg)
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†(log/info¬†&quot;returned¬†from¬†server¬†&quot;)))
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†stream¬†(m/topic-&gt;stream¬†conn¬†topic)]
¬†¬†¬†¬†¬†¬†(ms/consume¬†handler¬†stream))</pre></z><z id="t1584086956" t="Ramon Rios I&apos;m connecting to activemq and getting messages from topics. Every time i send a message , i get this message and save into a http endpoint"><y>#</y><d>2020-03-13</d><h>08:09</h><w>Ramon Rios</w>I&apos;m connecting to activemq and getting messages from topics. Every time i send a message , i get this message and save into a http endpoint</z><z id="t1584086991" t="Ramon Rios I test that, when i do not connect or got some 404 or another error in http, my function will handle it"><y>#</y><d>2020-03-13</d><h>08:09</h><w>Ramon Rios</w>I test that, when i do not connect or got some 404 or another error in http, my function will handle it</z><z id="t1584087013" t="Ramon Rios Sending a message to another topic and/or restarting to consume"><y>#</y><d>2020-03-13</d><h>08:10</h><w>Ramon Rios</w>Sending a message to another topic and/or restarting to consume</z><z id="t1584087063" t="Ramon Rios I read that catch is my function, but not useful because it&apos;s with deferred and not stream."><y>#</y><d>2020-03-13</d><h>08:11</h><w>Ramon Rios</w>I read that <code>catch</code> is my function, but not useful because it&apos;s with deferred and not stream.</z><z id="t1584087248" t="mccraigmccraig if you use consume then the only error will be in your callback, not on the stream - you can use deferred/catch or just plain catch there (since you are derefing what i presume is a deferred from add-customer-ror )"><y>#</y><d>2020-03-13</d><h>08:14</h><w>mccraigmccraig</w>if you use <code>consume</code> then the only error will be in your callback, not on the stream - you can use <code>deferred/catch</code> or just plain <code>catch</code> there (since you are derefing what i presume is a deferred from <code>add-customer-ror</code>)</z><z id="t1584087710" t="mccraigmccraig i would generally take a different approach - rather than using consume i would map the source stream with a fn which calls add-customer-ror , catches any error and stashes it in a marker record or variant etc... then you can [1] buffer the mapped stream to control your concurrency hitting the API, [2] get backpressure and [3] process the mapped stream to do anything you want with normal and error responses"><y>#</y><d>2020-03-13</d><h>08:21</h><w>mccraigmccraig</w>i would generally take a different approach - rather than using <code>consume</code> i would <code>map</code> the source stream with a fn which calls <code>add-customer-ror</code> , catches any error and stashes it in a marker record or variant etc... then you can [1] buffer the mapped stream to control your concurrency hitting the API, [2] get backpressure and [3] process the mapped stream to do anything you want with normal and error responses</z><z id="t1584087843" t="mccraigmccraig (the final piece of the puzzle being to stream/reduce the mapped stream, to force consumption)"><y>#</y><d>2020-03-13</d><h>08:24</h><w>mccraigmccraig</w>(the final piece of the puzzle being to <code>stream/reduce</code> the mapped stream, to force consumption)</z><z id="t1584089159" t="mccraigmccraig oh, and of course stream/realize-each to turn any deferred values on a stream into plain values"><y>#</y><d>2020-03-13</d><h>08:45</h><w>mccraigmccraig</w>oh, and of course <code>stream/realize-each</code> to turn any deferred values on a stream into plain values</z><z id="t1584095864" t="Ramon Rios Thank you [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}]"><y>#</y><d>2020-03-13</d><h>10:37</h><w>Ramon Rios</w>Thank you <a>@mccraigmccraig</a></z><z id="t1584095874" t="Ramon Rios I use it and really supply my needs"><y>#</y><d>2020-03-13</d><h>10:37</h><w>Ramon Rios</w>I use it and really supply my needs</z><z id="t1584095894" t="Ramon Rios I put a catch in my handler and now it works as expected"><y>#</y><d>2020-03-13</d><h>10:38</h><w>Ramon Rios</w>I put a catch in my handler and now it works as expected</z><z id="t1584220433" t="rschmukler Hey all - does anyone know how to explicitly close a client connection? I&apos;ve got a server that is using SSE to send events. I&apos;m taking the response body stream and feeding that into a manifold stream. I&apos;d like to register an on-close handler for the manifold stream that releases the HTTP connection, but I&apos;m having trouble figuring out what I should be calling to do that"><y>#</y><d>2020-03-14</d><h>21:13</h><w>rschmukler</w>Hey all - does anyone know how to explicitly close a client connection? I&apos;ve got a server that is using SSE to send events. I&apos;m taking the response body stream and feeding that into a manifold stream. I&apos;d like to register an <code>on-close</code> handler for the manifold stream that releases the HTTP connection, but I&apos;m having trouble figuring out what I should be calling to do that</z><z id="t1588513785" t="Sam DeSota Looking through the Aleph manifold API, is there an easy way to merge 2 streams? I&apos;ve primarily familiar with the Rx model of streams, I know manifold has different semantics. I&apos;d like to do a merge-map operation, like mapcat but instead of concating the streams, it merges all returned streams together, emitting events concurrenty. Tried to create the method myself, but struggling to get a working solution."><y>#</y><d>2020-05-03</d><h>13:49</h><w>Sam DeSota</w>Looking through the Aleph manifold API, is there an easy way to merge 2 streams? I&apos;ve primarily familiar with the Rx model of streams, I know manifold has different semantics. I&apos;d like to do a <code>merge-map</code> operation, like mapcat but instead of concating the streams, it merges all returned streams together, emitting events concurrenty.  Tried to create the method myself, but struggling to get a working solution.</z><z id="t1588519025" t="mccraigmccraig what are the semantics of the op you want [:attrs {:href &quot;/_/_/users/USQ5P4FT4&quot;}] ? are you wanting to merge maps from each stream or are you wanting the contents of the streams unchanged but mixed?"><y>#</y><d>2020-05-03</d><h>15:17</h><w>mccraigmccraig</w>what are the semantics of the op you want <a>@me1260</a>? are you wanting to merge maps from each stream or are you wanting the contents of the streams unchanged but mixed?</z><z id="t1588519829" t="Sam DeSota Ended up implementing via: (defn merge-streams &quot;Takes a stream of streams, and merges them into a single stream.&quot; [s] (let [out (s/stream)] (s/consume #(s/consume (fn [value] (s/put! out value)) %) s) (s/source-only out)))"><y>#</y><d>2020-05-03</d><h>15:30</h><w>Sam DeSota</w>Ended up implementing via:
<pre>(defn merge-streams
  &quot;Takes a stream of streams, and merges them into a single stream.&quot;
  [s]
  (let [out (s/stream)]
    (s/consume #(s/consume (fn [value] (s/put! out value)) %) s)
    (s/source-only out)))</pre></z><z id="t1588519899" t="Sam DeSota Not sure how well this compares to concat , but the semantics are to merge each stream unchanged into the destination stream. Seems like it would be a useful operator to have in the library."><y>#</y><d>2020-05-03</d><h>15:31</h><w>Sam DeSota</w>Not sure how well this compares to <code>concat</code> , but the semantics are to merge each stream unchanged into the destination stream. Seems like it would be a useful operator to have in the library.</z><z id="t1588519987" t="Sam DeSota The use case is a websocket server that recieves a subscribe message, then starts streaming updates about the resource to the client. Each time a new resource is subscribed via a websocket message, I merge in a new stream of updates about the resource."><y>#</y><d>2020-05-03</d><h>15:33</h><w>Sam DeSota</w>The use case is a websocket server that recieves a subscribe message, then starts streaming updates about the resource to the client. Each time a new resource is subscribed via a websocket message, I merge in a new stream of updates about the resource.</z><z id="t1588536882" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/USQ5P4FT4&quot;}] ah, ok, you aren&apos;t doing anything with the values on the stream - in similar circumstances I&apos;ve connect ed the new streams to the merged stream"><y>#</y><d>2020-05-03</d><h>20:14</h><w>mccraigmccraig</w><a>@me1260</a> ah, ok, you aren&apos;t doing anything with the values on the stream - in similar circumstances I&apos;ve <code>connect</code>ed the new streams to the merged stream</z><z id="t1591971729" t="lukasz Hi! üëã I&apos;m working on a UDP server, based on Aleph. The idea is to eventually ship it as a single binary, compiled via native-image. I got to the point where a binary is produced but I&apos;m running into an issue: When the server starts I get an exception that NioDatagramChannel doesn&apos;t have a 0-arity public constructor https://github.com/ztellman/aleph/blob/d3dc2e9835b58fb53b957171765e8da68e52aa84/src/aleph/udp.clj#L51 The error doesn&apos;t happen when running the code directly via Lein or good old uberjar. Has anybody run into this problem? Or should I ask in #graalvm channel?"><y>#</y><d>2020-06-12</d><h>14:22</h><w>lukasz</w>Hi! <b>üëã</b> I&apos;m working on a UDP server, based on Aleph. The idea is to eventually ship it as a single binary, compiled via native-image. I got to the point where a binary is produced but I&apos;m running into an issue: When the server starts I get an exception that NioDatagramChannel doesn&apos;t have a 0-arity public constructor <a href="https://github.com/ztellman/aleph/blob/d3dc2e9835b58fb53b957171765e8da68e52aa84/src/aleph/udp.clj#L51" target="_blank">https://github.com/ztellman/aleph/blob/d3dc2e9835b58fb53b957171765e8da68e52aa84/src/aleph/udp.clj#L51</a> The error doesn&apos;t happen when running the code directly via Lein or good old uberjar. Has anybody run into this problem? Or should I ask in #graalvm channel?</z><z id="t1593174200" t="zarkone hey, i‚Äôm trying to benchmark what are the limitation of websocket capabilities of Aleph. It fails when i do about 500 connections , with "><y>#</y><d>2020-06-26</d><h>12:23</h><w>zarkone</w>hey, i‚Äôm trying to benchmark what are the limitation of websocket capabilities of Aleph. It fails when i do about 500 connections , with
</z><z id="t1593174200" t="zarkone 18:02:59.076 ERROR [] manifold.deferred - error in deferred handler java.util.concurrent.RejectedExecutionException: null at io.aleph.dirigiste.Executor.execute(Executor.java:342) at manifold.deferred.Deferred$fn__28716.invoke(deferred.clj:398) at manifold.deferred.Deferred.success(deferred.clj:398) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243) at manifold.deferred$success_BANG_.invoke(deferred.clj:240) at manifold.deferred$eval28870$chain_SINGLEQUOTE____28891.invoke(deferred.clj:754) at manifold.deferred$eval28870$subscribe__28871$fn__28876.invoke(deferred.clj:715) at manifold.deferred.Listener.onSuccess(deferred.clj:219) at manifold.deferred.Deferred$fn__28716.invoke(deferred.clj:398) at manifold.deferred.Deferred.success(deferred.clj:398) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243) at manifold.deferred$success_BANG_.invoke(deferred.clj:240) at aleph.netty$wrap_future$reify__32441.operationComplete(netty.clj:227) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:502) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:476) at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:415) at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:540) at io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:529) at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:93) at io.netty.channel.DefaultChannelPromise.setSuccess(DefaultChannelPromise.java:78) at io.netty.channel.DefaultChannelPromise.setSuccess(DefaultChannelPromise.java:73) at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:200) at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:194) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:502) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:476) at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:415) at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:540) at io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:529) at io.netty.util.concurrent.DefaultPromise.trySuccess(DefaultPromise.java:101) at io.netty.util.internal.PromiseNotificationUtil.trySuccess(PromiseNotificationUtil.java:48) at io.netty.channel.ChannelOutboundBuffer.safeSuccess(ChannelOutboundBuffer.java:715) at io.netty.channel.ChannelOutboundBuffer.remove(ChannelOutboundBuffer.java:270) at io.netty.channel.ChannelOutboundBuffer.removeBytes(ChannelOutboundBuffer.java:350) at io.netty.channel.socket.nio.NioSocketChannel.doWrite(NioSocketChannel.java:411) at io.netty.channel.AbstractChannel$AbstractUnsafe.flush0(AbstractChannel.java:939) at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.flush0(AbstractNioChannel.java:360) at io.netty.channel.AbstractChannel$AbstractUnsafe.flush(AbstractChannel.java:906) at io.netty.channel.DefaultChannelPipeline$HeadContext.flush(DefaultChannelPipeline.java:1370) at io.netty.channel.AbstractChannelHandlerContext.invokeFlush0(AbstractChannelHandlerContext.java:749) at io.netty.channel.AbstractChannelHandlerContext.invokeFlush(AbstractChannelHandlerContext.java:741) at io.netty.channel.AbstractChannelHandlerContext.flush(AbstractChannelHandlerContext.java:727) at io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.flush(CombinedChannelDuplexHandler.java:533) at io.netty.channel.ChannelOutboundHandlerAdapter.flush(ChannelOutboundHandlerAdapter.java:125) at io.netty.channel.CombinedChannelDuplexHandler.flush(CombinedChannelDuplexHandler.java:358) at io.netty.channel.AbstractChannelHandlerContext.invokeFlush0(AbstractChannelHandlerContext.java:749) at io.netty.channel.AbstractChannelHandlerContext.invokeFlush(AbstractChannelHandlerContext.java:741) at io.netty.channel.AbstractChannelHandlerContext.access$2100(AbstractChannelHandlerContext.java:56) at io.netty.channel.AbstractChannelHandlerContext$WriteAndFlushTask.write(AbstractChannelHandlerContext.java:1150) at io.netty.channel.AbstractChannelHandlerContext$AbstractWriteTask.run(AbstractChannelHandlerContext.java:1073) at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163) at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:405) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:500) at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:906) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at manifold.executor$thread_factory$reify__28091$f__28092.invoke(executor.clj:47) at clojure.lang.AFn.run(AFn.java:22) at java.base/java.lang.Thread.run(Thread.java:834)"><y>#</y><d>2020-06-26</d><h>12:23</h><w>zarkone</w><pre>18:02:59.076 ERROR [] manifold.deferred - error in deferred handler
java.util.concurrent.RejectedExecutionException: null
	at io.aleph.dirigiste.Executor.execute(Executor.java:342)
	at manifold.deferred.Deferred$fn__28716.invoke(deferred.clj:398)
	at manifold.deferred.Deferred.success(deferred.clj:398)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:240)
	at manifold.deferred$eval28870$chain_SINGLEQUOTE____28891.invoke(deferred.clj:754)
	at manifold.deferred$eval28870$subscribe__28871$fn__28876.invoke(deferred.clj:715)
	at manifold.deferred.Listener.onSuccess(deferred.clj:219)
	at manifold.deferred.Deferred$fn__28716.invoke(deferred.clj:398)
	at manifold.deferred.Deferred.success(deferred.clj:398)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:240)
	at aleph.netty$wrap_future$reify__32441.operationComplete(netty.clj:227)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:502)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:476)
	at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:415)
	at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:540)
	at io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:529)
	at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:93)
	at io.netty.channel.DefaultChannelPromise.setSuccess(DefaultChannelPromise.java:78)
	at io.netty.channel.DefaultChannelPromise.setSuccess(DefaultChannelPromise.java:73)
	at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:200)
	at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:194)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:502)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:476)
	at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:415)
	at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:540)
	at io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:529)
	at io.netty.util.concurrent.DefaultPromise.trySuccess(DefaultPromise.java:101)
	at io.netty.util.internal.PromiseNotificationUtil.trySuccess(PromiseNotificationUtil.java:48)
	at io.netty.channel.ChannelOutboundBuffer.safeSuccess(ChannelOutboundBuffer.java:715)
	at io.netty.channel.ChannelOutboundBuffer.remove(ChannelOutboundBuffer.java:270)
	at io.netty.channel.ChannelOutboundBuffer.removeBytes(ChannelOutboundBuffer.java:350)
	at io.netty.channel.socket.nio.NioSocketChannel.doWrite(NioSocketChannel.java:411)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.flush0(AbstractChannel.java:939)
	at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.flush0(AbstractNioChannel.java:360)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.flush(AbstractChannel.java:906)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.flush(DefaultChannelPipeline.java:1370)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush0(AbstractChannelHandlerContext.java:749)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush(AbstractChannelHandlerContext.java:741)
	at io.netty.channel.AbstractChannelHandlerContext.flush(AbstractChannelHandlerContext.java:727)
	at io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.flush(CombinedChannelDuplexHandler.java:533)
	at io.netty.channel.ChannelOutboundHandlerAdapter.flush(ChannelOutboundHandlerAdapter.java:125)
	at io.netty.channel.CombinedChannelDuplexHandler.flush(CombinedChannelDuplexHandler.java:358)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush0(AbstractChannelHandlerContext.java:749)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush(AbstractChannelHandlerContext.java:741)
	at io.netty.channel.AbstractChannelHandlerContext.access$2100(AbstractChannelHandlerContext.java:56)

at io.netty.channel.AbstractChannelHandlerContext$WriteAndFlushTask.write(AbstractChannelHandlerContext.java:1150)
	at io.netty.channel.AbstractChannelHandlerContext$AbstractWriteTask.run(AbstractChannelHandlerContext.java:1073)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:405)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:500)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:906)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at manifold.executor$thread_factory$reify__28091$f__28092.invoke(executor.clj:47)
	at clojure.lang.AFn.run(AFn.java:22)
	at java.base/java.lang.Thread.run(Thread.java:834)</pre></z><z id="t1593174237" t="zarkone trying to understand how to improve the situation or at least how to understand when system gets close to the limit"><y>#</y><d>2020-06-26</d><h>12:23</h><w>zarkone</w>trying to understand how to improve the situation or at least how to understand when system gets close to the limit</z><z id="t1593174262" t="zarkone wonder if anyone has any clues \ advices.. Thanks!"><y>#</y><d>2020-06-26</d><h>12:24</h><w>zarkone</w>wonder if anyone has any clues \ advices.. Thanks!</z><z id="t1593175454" t="zarkone ah, actually i just needed to spend some more time on sources. Found in server.clj that by default it created with 512 executors"><y>#</y><d>2020-06-26</d><h>12:44</h><w>zarkone</w>ah, actually i just needed to spend some more time on sources. Found in server.clj that by default it created with 512 executors</z><z id="t1602516701" t="jjttjj Anyone know why I might be getting 400 errors with aleph&apos;s http client, when clj-http gives a 200 response for the same request? It&apos;s just a basic get request with no params"><y>#</y><d>2020-10-12</d><h>15:31</h><w>jjttjj</w>Anyone know why I might be getting 400 errors with aleph&apos;s http client, when clj-http gives a 200 response for the same request? It&apos;s just a basic get request with no params</z><z id="t1602524270" t="jeroenvandijk Could be anything I guess, missing query params, authentication. Can you share the request map?"><y>#</y><d>2020-10-12</d><h>17:37</h><w>jeroenvandijk</w>Could be anything I guess, missing query params, authentication. Can you share the request map?</z><z id="t1602524536" t="jjttjj Just a basic get on a public endpoint with no params ;;clj-http works as expected: (clj-http/get &quot;&quot; {:debug true :debug-body? true :as :json}) @(aleph-http/get &quot;&quot; {:debug true :debug-body? true :as :json}) ;;=&gt; {:aleph/keep-alive? true, :aleph/complete #object[manifold.deferred.SuccessDeferred &quot;0x7397ac1&quot; {:status :ready, :val false}], :headers {&quot;server&quot; &quot;cloudflare&quot;, &quot;content-type&quot; &quot;application/json; charset=utf-8&quot;, &quot;content-length&quot; &quot;44&quot;, &quot;connection&quot; &quot;keep-alive&quot;, &quot;cf-request-id&quot; &quot;05bf7ff214000091da2324c200000001&quot;, &quot;set-cookie&quot; &quot;__cfduid=d66496ec04481eff43488e02e22fcad141602524469; expires=Wed, 11-Nov-20 17:41:09 GMT; path=/; domain=.; HttpOnly; SameSite=Lax; Secure&quot;, &quot;expect-ct&quot; &quot;max-age=604800, report-uri=\&quot;\&quot;&quot;, &quot;cf-cache-status&quot; &quot;EXPIRED&quot;, &quot;cf-ray&quot; &quot;5e129c302f8691da-EWR&quot;, &quot;date&quot; &quot;Mon, 12 Oct 2020 17:41:09 GMT&quot;}, :status 400, :body #object[java.io.ByteArrayInputStream &quot;0x5d066dd&quot; &quot;java.io.ByteArrayInputStream@5d066dd&quot;]}{:aleph/keep-alive? true, :aleph/complete #object[manifold.deferred.SuccessDeferred &quot;0x7397ac1&quot; {:status :ready, :val false}], :headers {&quot;server&quot; &quot;cloudflare&quot;, &quot;content-type&quot; &quot;application/json; charset=utf-8&quot;, &quot;content-length&quot; &quot;44&quot;, &quot;connection&quot; &quot;keep-alive&quot;, &quot;cf-request-id&quot; &quot;05bf7ff214000091da2324c200000001&quot;, &quot;set-cookie&quot; &quot;__cfduid=d66496ec04481eff43488e02e22fcad141602524469; expires=Wed, 11-Nov-20 17:41:09 GMT; path=/; domain=.; HttpOnly; SameSite=Lax; Secure&quot;, &quot;expect-ct&quot; &quot;max-age=604800, report-uri=\&quot;\&quot;&quot;, &quot;cf-cache-status&quot; &quot;EXPIRED&quot;, &quot;cf-ray&quot; &quot;5e129c302f8691da-EWR&quot;, &quot;date&quot; &quot;Mon, 12 Oct 2020 17:41:09 GMT&quot;}, :status 400, :body #object[java.io.ByteArrayInputStream &quot;0x5d066dd&quot; &quot;java.io.ByteArrayInputStream@5d066dd&quot;]}"><y>#</y><d>2020-10-12</d><h>17:42</h><w>jjttjj</w>Just a basic get on a public endpoint with no params
<pre>;;clj-http works as expected:
(clj-http/get &quot;&quot;
  {:debug       true
   :debug-body? true
   :as :json})

@(aleph-http/get &quot;&quot;
   {:debug true
    :debug-body? true
    :as :json})
;;=&gt;
{:aleph/keep-alive? true,
    :aleph/complete #object[manifold.deferred.SuccessDeferred
                            &quot;0x7397ac1&quot;
                            {:status :ready, :val false}],
    :headers {&quot;server&quot; &quot;cloudflare&quot;,
              &quot;content-type&quot; &quot;application/json; charset=utf-8&quot;,
              &quot;content-length&quot; &quot;44&quot;,
              &quot;connection&quot; &quot;keep-alive&quot;,
              &quot;cf-request-id&quot; &quot;05bf7ff214000091da2324c200000001&quot;,
              &quot;set-cookie&quot; &quot;__cfduid=d66496ec04481eff43488e02e22fcad141602524469; expires=Wed, 11-Nov-20 17:41:09 GMT; path=/; domain=.; HttpOnly; SameSite=Lax; Secure&quot;,
              &quot;expect-ct&quot; &quot;max-age=604800, report-uri=\&quot;\&quot;&quot;,
              &quot;cf-cache-status&quot; &quot;EXPIRED&quot;,
              &quot;cf-ray&quot; &quot;5e129c302f8691da-EWR&quot;,
              &quot;date&quot; &quot;Mon, 12 Oct 2020 17:41:09 GMT&quot;},
    :status 400,
    :body #object[java.io.ByteArrayInputStream
                  &quot;0x5d066dd&quot;
                  &quot;java.io.ByteArrayInputStream@5d066dd&quot;]}{:aleph/keep-alive? true,
    :aleph/complete #object[manifold.deferred.SuccessDeferred
                            &quot;0x7397ac1&quot;
                            {:status :ready, :val false}],
    :headers {&quot;server&quot; &quot;cloudflare&quot;,
              &quot;content-type&quot; &quot;application/json; charset=utf-8&quot;,
              &quot;content-length&quot; &quot;44&quot;,
              &quot;connection&quot; &quot;keep-alive&quot;,
              &quot;cf-request-id&quot; &quot;05bf7ff214000091da2324c200000001&quot;,
              &quot;set-cookie&quot; &quot;__cfduid=d66496ec04481eff43488e02e22fcad141602524469; expires=Wed, 11-Nov-20 17:41:09 GMT; path=/; domain=.; HttpOnly; SameSite=Lax; Secure&quot;,
              &quot;expect-ct&quot; &quot;max-age=604800, report-uri=\&quot;\&quot;&quot;,
              &quot;cf-cache-status&quot; &quot;EXPIRED&quot;,
              &quot;cf-ray&quot; &quot;5e129c302f8691da-EWR&quot;,
              &quot;date&quot; &quot;Mon, 12 Oct 2020 17:41:09 GMT&quot;},
    :status 400,
    :body #object[java.io.ByteArrayInputStream
                  &quot;0x5d066dd&quot;
                  &quot;java.io.ByteArrayInputStream@5d066dd&quot;]}</pre></z><z id="t1602524607" t="jjttjj could it be related to SSL config?"><y>#</y><d>2020-10-12</d><h>17:43</h><w>jjttjj</w>could it be related to SSL config?</z><z id="t1602524853" t="mccraigmccraig i suspect probably not ssl config, since you are getting an http 400 back. what&apos;s in that :body ByteArrayInputStream ? there might a useful error description in there..."><y>#</y><d>2020-10-12</d><h>17:47</h><w>mccraigmccraig</w>i suspect probably not ssl config, since you are getting an http 400 back. what&apos;s in that <code>:body ByteArrayInputStream</code> ? there might a useful error description in there...</z><z id="t1602525398" t="jjttjj Ah! &quot;{\&quot;message\&quot;:\&quot;User-Agent header is required.\&quot;}&quot; that explains it. Thanks for the help!"><y>#</y><d>2020-10-12</d><h>17:56</h><w>jjttjj</w>Ah!
<pre>&quot;{\&quot;message\&quot;:\&quot;User-Agent header is required.\&quot;}&quot;</pre>
that explains it. Thanks for the help!</z><z id="t1602527095" t="mccraigmccraig yw!"><y>#</y><d>2020-10-12</d><h>18:24</h><w>mccraigmccraig</w>yw!</z><z id="t1602539509" t="euccastro yes, clj-http and other libraries that try and imitate that do supply a &quot;User-Agent&quot; on their own. bit me when porting code from that to Aleph"><y>#</y><d>2020-10-12</d><h>21:51</h><w>euccastro</w>yes, clj-http and other libraries that try and imitate that do supply a &quot;User-Agent&quot; on their own.  bit me when porting code from that to Aleph</z><z id="t1603556460" t="jjttjj Code review wanted for this automatic/reconnecting websocket client. The idea is basically to have something which acts exactly as the aleph websocket client except it uses the source/sink streams you provide it, and it reconnects to those streams when the connection is closed unintentionally. I&apos;m mainly wondering if the stream splicing/connection logic can be better. ;;;goal: pass input/output streams which connect to a websocket client duplex ;;;stream. when the inner websocket stream is closed unintentionally by server, ;;;make a new one and reconnect the input/output streams. close the websocket ;;;stream when the output stream is closed. (require &apos;[manifold.stream :as ms] &apos;[manifold.deferred :as md] &apos;[alep.http :as http] &apos;[taoensso.timbre :as log] &apos;[clojure.data.json :as json]) (defn ws-conn [url] (http/websocket-client url {:max-frame-payload 1e7 :max-frame-size 1e7})) (defn reconnecting-websocket-stream [{::keys [url on-connect in-stream out-stream] :or {in-stream (ms/stream) out-stream (ms/stream)}}] (let [in* (ms/stream* {:permanent? true :buffer-size 1000}) _ (ms/connect in-stream in*) s (ms/splice in-stream out-stream) renew-connection (fn this ([] (this 0 (quot (System/currentTimeMillis) 1000))) ([n last-reset-second] (md/chain (ws-conn url) (fn [conn] (log/debug &quot;Starting connection. Restart count:&quot; n) (ms/on-closed out-stream (fn [] (.close conn))) (ms/connect in* conn) (ms/connect conn out-stream {:downstream? false}) (ms/on-closed conn (fn [] (log/info &quot;connection closed&quot;) (when (not (ms/closed? out-stream)) (when (= last-reset-second (quot (System/currentTimeMillis) 1000)) (log/info &quot;attempted to reset more than once per second, waiting&quot;) (Thread/sleep 1000)) (log/info &quot;restarting after connectiong closed closed&quot;) (this (inc n) (quot (System/currentTimeMillis) 1000))))) (when on-connect (on-connect s))))))] (renew-connection) s)) usage: (def subscribe-msg {:type :subscribe :product_ids [&quot;BTC-USD&quot;] :channels [:heartbeat :full]}) (def in (ms/stream)) (def out (ms/stream)) (reconnecting-websocket-stream {::url &quot;&quot; ::on-connect (fn [s] (ms/put! s (json/write-str subscribe-msg))) ::in-stream in ::out-stream out}) (ms/consume (fn [msg] (log/sometimes 0.002 (log/info msg))) out) ;;; to close (ms/close! out)"><y>#</y><d>2020-10-24</d><h>16:21</h><w>jjttjj</w>Code review wanted for this automatic/reconnecting websocket client. The idea is basically to have something which acts exactly as the aleph websocket client except it uses the source/sink streams you provide it, and it reconnects to those streams when the connection is closed unintentionally. I&apos;m mainly wondering if the stream splicing/connection logic can be better.

<pre>;;;goal: pass input/output streams which connect to a websocket client duplex
;;;stream. when the inner websocket stream is closed unintentionally by server,
;;;make a new one and reconnect the input/output streams. close the websocket
;;;stream when the output stream is closed.


(require &apos;[manifold.stream :as ms]
         &apos;[manifold.deferred :as md]
         &apos;[alep.http :as http]
         &apos;[taoensso.timbre :as log]
         &apos;[clojure.data.json :as json])

(defn ws-conn [url]
  (http/websocket-client url
    {:max-frame-payload 1e7 :max-frame-size 1e7}))

(defn reconnecting-websocket-stream [{::keys [url on-connect
                                              in-stream
                                              out-stream]
                                      :or    {in-stream  (ms/stream)
                                              out-stream (ms/stream)}}]
  (let [in* (ms/stream* {:permanent? true :buffer-size 1000})
        _   (ms/connect in-stream in*)
        s   (ms/splice in-stream out-stream)
        renew-connection
        (fn this
          ([] (this 0 (quot (System/currentTimeMillis) 1000)))
          ([n last-reset-second]
           (md/chain (ws-conn url)
             (fn [conn]
               (log/debug &quot;Starting connection. Restart count:&quot; n)

               (ms/on-closed out-stream (fn [] (.close conn)))
               (ms/connect in* conn)
               (ms/connect conn out-stream {:downstream? false})
               (ms/on-closed conn
                 (fn []
                   (log/info &quot;connection closed&quot;)
                   (when (not (ms/closed? out-stream))
                     (when (= last-reset-second (quot (System/currentTimeMillis) 1000))
                       (log/info &quot;attempted to reset more than once per second, waiting&quot;)
                       (Thread/sleep 1000))
                     (log/info &quot;restarting after connectiong closed closed&quot;)
                     (this (inc n) (quot (System/currentTimeMillis) 1000)))))
               (when on-connect (on-connect s))))))]
    (renew-connection)
    s))</pre>
usage:
<pre>(def subscribe-msg {:type        :subscribe
                    :product_ids [&quot;BTC-USD&quot;]
                    :channels     [:heartbeat :full]})

(def in (ms/stream))
(def out (ms/stream))

(reconnecting-websocket-stream
  {::url        &quot;&quot;
   ::on-connect (fn [s] (ms/put! s (json/write-str subscribe-msg)))
   ::in-stream  in
   ::out-stream out})


(ms/consume
  (fn [msg]
    (log/sometimes 0.002
      (log/info msg)))
  out)

;;; to close
(ms/close! out)</pre></z><z id="t1604079536" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U064UGEUQ&quot;}] Do you want to save it as a gist for a longer-lasting record than Clojurians Slack? I&apos;m not too familiar with the WS side of Aleph yet, but I&apos;ll want to do something very similar (feed a stream to a WS with start/stop capabilities) in the next couple weeks. If you&apos;re not in a hurry, I can give a better review then."><y>#</y><d>2020-10-30</d><h>17:38</h><w>Matthew Davidson (kingmob)</w><a>@jjttjj</a> Do you want to save it as a gist for a longer-lasting record than Clojurians Slack? I&apos;m not too familiar with the WS side of Aleph yet, but I&apos;ll want to do something very similar (feed a stream to a WS with start/stop capabilities) in the next couple weeks. If you&apos;re not in a hurry, I can give a better review then.</z><z id="t1604079571" t="Matthew Davidson (kingmob) (Minor typo: alep.http should be aleph.http , I assume)"><y>#</y><d>2020-10-30</d><h>17:39</h><w>Matthew Davidson (kingmob)</w>(Minor typo: <code>alep.http</code> should be <code>aleph.http</code>, I assume)</z><z id="t1604083349" t="jjttjj [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Sure, it&apos;s changed considerably since I sent that one, here&apos;s what I&apos;m currently working with. Now it just returns a stream on which is put each new connection duplex stream upon being connected. I just changed it a bunch this morning and there might still be a bug or two https://gist.github.com/jjttjj/0dc1fbe001578f5580fedfad8ed81a80"><y>#</y><d>2020-10-30</d><h>18:42</h><w>jjttjj</w><a>@kingmob</a> Sure, it&apos;s changed considerably since I sent that one, here&apos;s what I&apos;m currently working with. Now it just returns a stream on which is put each new connection duplex stream upon being connected. I just changed it a bunch this morning and there might still be a bug or two
<a href="https://gist.github.com/jjttjj/0dc1fbe001578f5580fedfad8ed81a80" target="_blank">https://gist.github.com/jjttjj/0dc1fbe001578f5580fedfad8ed81a80</a></z><z id="t1604083465" t="Matthew Davidson (kingmob) Cool, will check out."><y>#</y><d>2020-10-30</d><h>18:44</h><w>Matthew Davidson (kingmob)</w>Cool, will check out.</z><z id="t1605311588" t="Matthew Davidson (kingmob) If this helps anyone, I wrote an adapter to treat a java.util.concurrent.SubmissionPublisher as a Manifold sink: https://gist.github.com/KingMob/149e1b21674c9b027699753143878ab8 I ended up choosing to use Websockets in the end, but I did successfully use this for a few weeks. (The reason I switched is the whole http://reactive-streams.org / Java Flow design is more like a complicated, pull-based lazy sequence, while most reactive patterns, including Manifold, are more like blockable chains of dominos. I understand the stated goals of http://reactive-streams.org , I just don&apos;t think the result very stream-like)"><y>#</y><d>2020-11-13</d><h>23:53</h><w>Matthew Davidson (kingmob)</w>If this helps anyone, I wrote an adapter to treat a java.util.concurrent.SubmissionPublisher as a Manifold sink: <a href="https://gist.github.com/KingMob/149e1b21674c9b027699753143878ab8" target="_blank">https://gist.github.com/KingMob/149e1b21674c9b027699753143878ab8</a>

I ended up choosing to use Websockets in the end, but I did successfully use this for a few weeks.

(The reason I switched is the whole <a href="http://reactive-streams.org" target="_blank">http://reactive-streams.org</a> / Java Flow design is more like a complicated, pull-based lazy sequence, while most reactive patterns, including Manifold, are more like blockable chains of dominos. I understand the stated goals of <a href="http://reactive-streams.org" target="_blank">http://reactive-streams.org</a>, I just don&apos;t think the result very stream-like)</z><z id="t1605347608" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] i&apos;ve been working on a stream thing too... and after having looked at the reactive-streams stuff and the rxjava stuff concluded that manifold&apos;s approach to backpressure was much more elegant"><y>#</y><d>2020-11-14</d><h>09:53</h><w>mccraigmccraig</w><a>@kingmob</a> i&apos;ve been working on a stream thing too... and after having looked at the reactive-streams stuff and the rxjava stuff concluded that manifold&apos;s approach to backpressure was much more elegant</z><z id="t1605365940" t="Matthew Davidson (kingmob) I haven‚Äôt looked at RxJava as much, but it seemed like it was more aligned with Manifold, and should therefore be easier to adapt. I was surprised there wasn‚Äôt already a Manifold adapter for it"><y>#</y><d>2020-11-14</d><h>14:59</h><w>Matthew Davidson (kingmob)</w>I haven‚Äôt looked at RxJava as much, but it seemed like it was more aligned with Manifold, and should therefore be easier to adapt. I was surprised there wasn‚Äôt already a Manifold adapter for it</z><z id="t1605436685" t="mccraigmccraig the rxjava approach to streams is quite similar to rxjava, with one crucial difference - there is a callback on the put! equivalent op, but they don&apos;t really make use of it"><y>#</y><d>2020-11-15</d><h>10:38</h><w>mccraigmccraig</w>the rxjava approach to streams is quite similar to rxjava, with one crucial difference - there is a callback on the <code>put!</code> equivalent op, but they don&apos;t really make use of it</z><z id="t1605436824" t="mccraigmccraig my code is still nascent, but i think it is the case that the manifold approach to backpressure (returning a promise from put! which resolve when the op completes) is more powerful than the rxjava pull approach... it was quite easy to implement the pull approach using the manifold approach"><y>#</y><d>2020-11-15</d><h>10:40</h><w>mccraigmccraig</w>my code is still nascent, but i think it is the case that the manifold approach to backpressure (returning a promise from <code>put!</code> which resolve when the op completes) is more powerful than the rxjava pull approach... it was quite easy to implement the pull approach using the manifold approach</z><z id="t1605436898" t="mccraigmccraig here where i am: https://github.com/mccraigmccraig/laters/blob/master/src/laters/concurrency/stream/read_write_stream.cljc"><y>#</y><d>2020-11-15</d><h>10:41</h><w>mccraigmccraig</w>here where i am: <a href="https://github.com/mccraigmccraig/laters/blob/master/src/laters/concurrency/stream/read_write_stream.cljc" target="_blank">https://github.com/mccraigmccraig/laters/blob/master/src/laters/concurrency/stream/read_write_stream.cljc</a></z><z id="t1605436968" t="mccraigmccraig i borrowed from the rxjava approach of implementing a buffer which takes care of most of the detail of backpressure, then using that to implement the stream"><y>#</y><d>2020-11-15</d><h>10:42</h><w>mccraigmccraig</w>i borrowed from the rxjava approach of implementing a buffer which takes care of most of the detail of backpressure, then using that to implement the stream</z><z id="t1605437054" t="mccraigmccraig still a way to go though... the current impl only accepts a single downstream handler"><y>#</y><d>2020-11-15</d><h>10:44</h><w>mccraigmccraig</w>still a way to go though... the current impl only accepts a single downstream handler</z><z id="t1605551364" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] Looks interesting. I&apos;d like to see more when you think it&apos;s ready. Quick question: are the protocol methods meant to be directly invoked, or indirectly via some other methods that aren&apos;t there yet? The examples directly call them, but prefixing them with dashes suggests they&apos;re low-level and should be called via something else."><y>#</y><d>2020-11-16</d><h>18:29</h><w>Matthew Davidson (kingmob)</w><a>@mccraigmccraig</a> Looks interesting. I&apos;d like to see more when you think it&apos;s ready.

Quick question: are the protocol methods meant to be directly invoked, or indirectly via some other methods that aren&apos;t there yet? The examples directly call them, but prefixing them with dashes suggests they&apos;re low-level and should be called via something else.</z><z id="t1605551534" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] right now it&apos;s just plain inconsistency üò¨ ... my expectation is that the protocol methods will end up being hidden behind something else though"><y>#</y><d>2020-11-16</d><h>18:32</h><w>mccraigmccraig</w><a>@kingmob</a> right now it&apos;s just plain inconsistency <b>üò¨</b> ... my expectation is that the protocol methods will end up being hidden behind something else though</z><z id="t1605551635" t="Matthew Davidson (kingmob) Ahh, got it. Keep us posted!"><y>#</y><d>2020-11-16</d><h>18:33</h><w>Matthew Davidson (kingmob)</w>Ahh, got it. Keep us posted!</z><z id="t1606775314" t="Matthew Davidson (kingmob) To all in the channel, Zach is considering moving stewardship of Aleph and its related libs to clj-commons, and is looking for help: https://github.com/clj-commons/meta/issues/59"><y>#</y><d>2020-11-30</d><h>22:28</h><w>Matthew Davidson (kingmob)</w>To all in the channel, Zach is considering moving stewardship of Aleph and its related libs to clj-commons, and is looking for help: <a href="https://github.com/clj-commons/meta/issues/59" target="_blank">https://github.com/clj-commons/meta/issues/59</a></z><z id="t1608314326" t="GusWill Hey guys, I have a question about manifold, not sure if this is the appropriate channel since I couldn&apos;t find a manifold-specific channel."><y>#</y><d>2020-12-18</d><h>17:58</h><w>GusWill</w>Hey guys, I have a question about manifold, not sure if this is the appropriate channel since I couldn&apos;t find a manifold-specific channel.</z><z id="t1608314423" t="GusWill I&apos;m building a pubsub system on top of manifold.bus and I don&apos;t understand why subcribers stop consuming a bus stream when an error is thrown. Any ideas?"><y>#</y><d>2020-12-18</d><h>18:00</h><w>GusWill</w>I&apos;m building a pubsub system on top of manifold.bus and I don&apos;t understand why subcribers stop consuming a bus stream when an error is thrown. Any ideas?</z><z id="t1608316144" t="mccraigmccraig manifold doesn&apos;t deal with errors very well - there are some places where an error thrown can silently close a stream [:attrs {:href &quot;/_/_/users/U01H8V25FSN&quot;}]"><y>#</y><d>2020-12-18</d><h>18:29</h><w>mccraigmccraig</w>manifold doesn&apos;t deal with errors very well - there are some places where an error thrown can silently close a stream <a>@guswill</a></z><z id="t1608316295" t="mccraigmccraig this caused us no end of trouble at some point... we wrap the stream api now to make sure it never happens and flow errors downstream sensibly"><y>#</y><d>2020-12-18</d><h>18:31</h><w>mccraigmccraig</w>this caused us no end of trouble at some point... we wrap the stream api now to make sure it never happens and flow errors downstream sensibly</z><z id="t1608335281" t="GusWill Thanks for the pointers [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] . Is this wrapping lib open source by any chance?"><y>#</y><d>2020-12-18</d><h>23:48</h><w>GusWill</w>Thanks for the pointers <a>@mccraigmccraig</a>. Is this wrapping lib open source by any chance?</z><z id="t1608335467" t="GusWill For now I&apos;m wrapping consumers in a exception-handling macro, but it feels kinda hack-ish."><y>#</y><d>2020-12-18</d><h>23:51</h><w>GusWill</w>For now I&apos;m wrapping consumers in a exception-handling macro, but it feels kinda hack-ish.</z><z id="t1608335551" t="GusWill Would you say core.async is a better option for unreliable consumers in fan-out topologies then?"><y>#</y><d>2020-12-18</d><h>23:52</h><w>GusWill</w>Would you say <code>core.async</code> is a better option for unreliable consumers in fan-out topologies then?</z><z id="t1608335574" t="GusWill core.async doesn&apos;t have the best error handling story either üòû"><y>#</y><d>2020-12-18</d><h>23:52</h><w>GusWill</w>core.async doesn&apos;t have the best error handling story either <b>üòû</b></z><z id="t1608375629" t="mccraigmccraig sadly the wrapping is not open-source atm [:attrs {:href &quot;/_/_/users/U01H8V25FSN&quot;}] - for no particular reason other than it&apos;s in a monorepo and it would be work to extract an oss version and maintain it"><y>#</y><d>2020-12-19</d><h>11:00</h><w>mccraigmccraig</w>sadly the wrapping is not open-source atm <a>@guswill</a> - for no particular reason other than it&apos;s in a monorepo and it would be work to extract an oss version and maintain it</z><z id="t1608375816" t="mccraigmccraig what the wrapper does is define an error container record, transparently wrap consumer fns in exception handling which outputs an error container, and provide modified versions of the stream processing fns like map , transform and reduce so that errors are propagated - i.e. preserved in a container on the stream, and returned when a reduce happens"><y>#</y><d>2020-12-19</d><h>11:03</h><w>mccraigmccraig</w>what the wrapper does is define an error container record, transparently wrap consumer fns in exception handling which outputs an error container, and provide modified versions of the stream processing fns like <code>map</code>, <code>transform</code> and <code>reduce</code> so that errors are propagated - i.e. preserved in a container on the stream, and returned when a <code>reduce</code> happens</z><z id="t1608477506" t="GusWill Coincidentally I&apos;ve found this while looking for error handling strategies: https://github.com/yapsterapp/er-cassandra/blob/5be28c1ed868c87f5d344f21880345dd65326651/src/er_cassandra/util/stream.clj"><y>#</y><d>2020-12-20</d><h>15:18</h><r>GusWill</r>Coincidentally I&apos;ve found this while looking for error handling strategies: <a href="https://github.com/yapsterapp/er-cassandra/blob/5be28c1ed868c87f5d344f21880345dd65326651/src/er_cassandra/util/stream.clj" target="_blank">https://github.com/yapsterapp/er-cassandra/blob/5be28c1ed868c87f5d344f21880345dd65326651/src/er_cassandra/util/stream.clj</a></z><z id="t1608492639" t="mccraigmccraig haha, well i wrote that, but it&apos;s quite old... things have moved on a long way since then üôÇ"><y>#</y><d>2020-12-20</d><h>19:30</h><r>mccraigmccraig</r>haha, well i wrote that, but it&apos;s quite old... things have moved on a long way since then <b>üôÇ</b></z><z id="t1608492779" t="mccraigmccraig that&apos;s probably around the time we were realising we had a serious issue with manifold error handling - we had some cases in prod where streams were closed early with no errors, leading to downstream processes thinking that some records were gone from the input and then deleting other records to maintain consistency"><y>#</y><d>2020-12-20</d><h>19:32</h><r>mccraigmccraig</r>that&apos;s probably around the time we were realising we had a serious issue with manifold error handling - we had some cases in prod where streams were closed early with no errors, leading to downstream processes thinking that some records were gone from the input and then deleting other records to maintain consistency</z><z id="t1608587469" t="GusWill Almost exactly the problem we&apos;re having now..."><y>#</y><d>2020-12-21</d><h>21:51</h><r>GusWill</r>Almost exactly the problem we&apos;re having now...</z><z id="t1608632287" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U01H8V25FSN&quot;}] i don&apos;t have time to do a proper job and extract our promise/stream stuff to a library ... but maybe this will help - here&apos;s our wrapper code, and the tests for it :"><y>#</y><d>2020-12-22</d><h>10:18</h><r>mccraigmccraig</r><a>@guswill</a> i don&apos;t have time to do a proper job and extract our promise/stream stuff to a library ... but maybe this will help - here&apos;s our wrapper code, and the tests for it :</z><z id="t1608632289" t="mccraigmccraig https://gist.github.com/2e026ebd3463bfd84a9a70ec3cf37e3b"><y>#</y><d>2020-12-22</d><h>10:18</h><r>mccraigmccraig</r><a href="https://gist.github.com/2e026ebd3463bfd84a9a70ec3cf37e3b" target="_blank">https://gist.github.com/2e026ebd3463bfd84a9a70ec3cf37e3b</a></z><z id="t1608632301" t="mccraigmccraig https://gist.github.com/edbe963f6a7ee6b55170557f474910b8"><y>#</y><d>2020-12-22</d><h>10:18</h><r>mccraigmccraig</r><a href="https://gist.github.com/edbe963f6a7ee6b55170557f474910b8" target="_blank">https://gist.github.com/edbe963f6a7ee6b55170557f474910b8</a></z><z id="t1608632391" t="mccraigmccraig in our code we replace all manifold.stream usage with the equivalent prpr.stream wrapper fn"><y>#</y><d>2020-12-22</d><h>10:19</h><r>mccraigmccraig</r>in our code we replace all <code>manifold.stream</code> usage with the equivalent <code>prpr.stream</code> wrapper fn</z><z id="t1608632489" t="mccraigmccraig errors will be copied to the new stream for fns like map , filter , mapcat , transform while reduce will return the first error it encounters in an errored promise"><y>#</y><d>2020-12-22</d><h>10:21</h><r>mccraigmccraig</r>errors will be copied to the new stream for fns like <code>map</code>, <code>filter</code>, <code>mapcat</code>, <code>transform</code> while <code>reduce</code> will return the first error it encounters in an errored promise</z><z id="t1609034076" t="GusWill Sorry, I missed your messages! These are very useful, thanks a lot for sharing them!"><y>#</y><d>2021-12-27</d><h>01:54</h><r>GusWill</r>Sorry, I missed your messages! These are very useful, thanks a lot for sharing them!</z><z id="t1609034327" t="GusWill Wow, you should totally publish this as a wrapper lib; it makes manifold errors way more tractable."><y>#</y><d>2021-12-27</d><h>01:58</h><r>GusWill</r>Wow, you should totally publish this as a wrapper lib; it makes manifold errors way more tractable.</z><z id="t1608375946" t="mccraigmccraig even given that, i prefer the manifold model of streams+promises over core.async &apos;s approach. and as you say, core.async &apos;s error handling story isn&apos;t great either"><y>#</y><d>2020-12-19</d><h>11:05</h><w>mccraigmccraig</w>even given that, i prefer the manifold model of streams+promises over <code>core.async</code>&apos;s approach. and as you say, <code>core.async</code>&apos;s error handling story isn&apos;t great either</z><z id="t1608376047" t="mccraigmccraig given manifold&apos;s state of abandonment, and lack of support for cljs, i&apos;ve started work on a replacement - it&apos;s looking promising, but it won&apos;t be ready for a while yet"><y>#</y><d>2020-12-19</d><h>11:07</h><w>mccraigmccraig</w>given manifold&apos;s state of abandonment, and lack of support for cljs, i&apos;ve started work on a replacement - it&apos;s looking promising, but it won&apos;t be ready for a while yet</z><z id="t1608477764" t="GusWill Yes, that&apos;s a good point. The fact that the community hasn&apos;t stepped up to maintain it signals that either most people don&apos;t find it very useful or that they are fine with the alternatives."><y>#</y><d>2020-12-20</d><h>15:22</h><w>GusWill</w>Yes, that&apos;s a good point. The fact that the community hasn&apos;t stepped up to maintain it signals that either most people don&apos;t find it very useful or that they are fine with the alternatives.</z><z id="t1608478001" t="GusWill And, tbh, I don&apos;t see any alternative that&apos;s equivalent in scope and &quot;holisticness&quot;."><y>#</y><d>2020-12-20</d><h>15:26</h><w>GusWill</w>And, tbh, I don&apos;t see any alternative that&apos;s equivalent in scope and &quot;holisticness&quot;.</z><z id="t1608482110" t="valerauko That&apos;s not exactly right though: there&apos;s a transition in progress for all of the http://aleph.io repos to clj-commons where they will be community maintained. https://github.com/clj-commons/meta/issues/59"><y>#</y><d>2020-12-20</d><h>16:35</h><w>valerauko</w>That&apos;s not exactly right though: there&apos;s a transition in progress for all of the <a href="http://aleph.io" target="_blank">http://aleph.io</a> repos to clj-commons where they will be community maintained. <a href="https://github.com/clj-commons/meta/issues/59" target="_blank">https://github.com/clj-commons/meta/issues/59</a></z><z id="t1608488862" t="nha I am not using manifold as much as I was, but I still like manifold.deferred"><y>#</y><d>2020-12-20</d><h>18:27</h><w>nha</w>I am not using manifold as much as I was, but I still like manifold.deferred</z><z id="t1608491624" t="GusWill [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] I applaud the effort but, in the long run, I don&apos;t think it means much. There&apos;s an old saying in my native language that can be roughly translated to &quot;A dog with many owners dies of hunger&quot; which I think is relevant in this case."><y>#</y><d>2020-12-20</d><h>19:13</h><w>GusWill</w><a>@vale</a> I applaud the effort but, in the long run, I don&apos;t think it means much. There&apos;s an old saying in my native language that can be roughly translated to &quot;A dog with many owners dies of hunger&quot; which I think is relevant in this case.</z><z id="t1608494609" t="valerauko There&apos;s no mythical &quot;community&quot; that &quot;steps up&quot; -- it&apos;s people like you and me."><y>#</y><d>2020-12-20</d><h>20:03</h><w>valerauko</w>There&apos;s no mythical &quot;community&quot; that &quot;steps up&quot; -- it&apos;s people like you and me.</z><z id="t1608503178" t="GusWill [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Well, you&apos;re just reinforcing my argument... You and me are not going to maintain a project as complex as Manifold in our spare time. Its centerpiece tech in a lot of projects and can only be maintained by someone who knows the internals well."><y>#</y><d>2020-12-20</d><h>22:26</h><w>GusWill</w><a>@vale</a> Well, you&apos;re just reinforcing my argument... You and me are not going to maintain a project as complex as Manifold in our spare time. Its centerpiece tech in a lot of projects and can only be maintained by someone who knows the internals well.</z><z id="t1608503307" t="GusWill So the intersection between &quot;still uses manifold&quot; + &quot;knows the internals&quot; + &quot;has spare time to dedicate to OS&quot; is, tbh, really small."><y>#</y><d>2020-12-20</d><h>22:28</h><w>GusWill</w>So the intersection between &quot;still uses manifold&quot; + &quot;knows the internals&quot; + &quot;has spare time to dedicate to OS&quot; is, tbh, really small.</z><z id="t1608535199" t="slipset [:attrs {:href &quot;/_/_/users/U01H8V25FSN&quot;}] I almost totally agree, but we‚Äôre working Zach to find proper maintainers for Manifold and Aleph. In the mean time they are now living in a place where the few individuals who live in that intersection can come forward and contribute."><y>#</y><d>2020-12-21</d><h>07:19</h><w>slipset</w><a>@guswill</a> I almost totally agree, but we‚Äôre working Zach to find proper maintainers for Manifold and Aleph. In the mean time they are now living in a place where the few individuals who live in that intersection can come forward and contribute.</z><z id="t1608587215" t="GusWill [:attrs {:href &quot;/_/_/users/U04V5VAUN&quot;}] Awesome man! I hope it works out, big shoes to fill, but there is a lot of talent in this community."><y>#</y><d>2020-12-21</d><h>21:46</h><w>GusWill</w><a>@slipset</a> Awesome man! I hope it works out, big shoes to fill, but there is a lot of talent in this community.</z><z id="t1611829232" t="Shantanu Kumar Hi, has anybody tried Aleph with Clojure 1.10.2?"><y>#</y><d>2021-01-28</d><h>10:20</h><w>Shantanu Kumar</w>Hi, has anybody tried Aleph with Clojure 1.10.2?</z><z id="t1611829267" t="Shantanu Kumar I saw few exceptions, e.g. java.lang.NoClassDefFoundError: Could not initialize class manifold.deferred.Deferred$fn__13971 at manifold.deferred.Deferred.success(deferred.clj:398) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243) at manifold.deferred$success_BANG_.invoke(deferred.clj:240) at aleph.netty$wrap_future$reify__17246.operationComplete(netty.clj:199) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424) at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94) at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33) at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435) at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Thread.java:832)"><y>#</y><d>2021-01-28</d><h>10:21</h><w>Shantanu Kumar</w>I saw few exceptions, e.g.
<pre>java.lang.NoClassDefFoundError: Could not initialize class manifold.deferred.Deferred$fn__13971
	at manifold.deferred.Deferred.success(deferred.clj:398)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:240)
	at aleph.netty$wrap_future$reify__17246.operationComplete(netty.clj:199)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424)
	at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33)
	at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435)
	at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:832)</pre></z><z id="t1611829326" t="Shantanu Kumar and"><y>#</y><d>2021-01-28</d><h>10:22</h><w>Shantanu Kumar</w>and</z><z id="t1611829332" t="Shantanu Kumar java.lang.ExceptionInInitializerError: null at manifold.deferred.Deferred.success(deferred.clj:398) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243) at manifold.deferred$success_BANG_.invoke(deferred.clj:240) at aleph.netty$wrap_future$reify__17246.operationComplete(netty.clj:199) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424) at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94) at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485) at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33) at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435) at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Thread.java:832) Caused by: java.lang.ClassNotFoundException: clojure/lang/PersistentArrayMap at java.base/java.lang.Class.forName0(Native Method) at java.base/java.lang.Class.forName(Class.java:468) at clojure.lang.RT.classForName(RT.java:2212) at clojure.lang.RT.classForName(RT.java:2221) at clojure.lang.Reflector.invokeStaticMethod(Reflector.java:324) at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1322) at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.read(LispReader.java:220) at clojure.lang.LispReader.access$200(LispReader.java:41) at clojure.lang.LispReader$MetaReader.invoke(LispReader.java:954) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.readDelimitedList(LispReader.java:1398) at clojure.lang.LispReader$ListReader.invoke(LispReader.java:1243) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.read(LispReader.java:220) at clojure.lang.LispReader.access$200(LispReader.java:41) at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1301) at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853) at clojure.lang.LispReader.read(LispReader.java:285) at clojure.lang.LispReader.read(LispReader.java:216) at clojure.lang.LispReader.read(LispReader.java:205) at clojure.lang.RT.readString(RT.java:1879) at clojure.lang.RT.readString(RT.java:1874) at manifold.deferred.Deferred$fn__13971.&lt;clinit&gt;(deferred.clj:398) ... 16 common frames omitted"><y>#</y><d>2021-01-28</d><h>10:22</h><w>Shantanu Kumar</w><pre>java.lang.ExceptionInInitializerError: null
	at manifold.deferred.Deferred.success(deferred.clj:398)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:243)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:240)
	at aleph.netty$wrap_future$reify__17246.operationComplete(netty.clj:199)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:424)
	at io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:94)
	at io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117)
	at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:511)
	at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:485)
	at io.netty.util.concurrent.DefaultPromise.access$000(DefaultPromise.java:33)
	at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:435)
	at io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:248)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:832)
Caused by: java.lang.ClassNotFoundException: clojure/lang/PersistentArrayMap
	at java.base/java.lang.Class.forName0(Native Method)
	at java.base/java.lang.Class.forName(Class.java:468)
	at clojure.lang.RT.classForName(RT.java:2212)
	at clojure.lang.RT.classForName(RT.java:2221)
	at clojure.lang.Reflector.invokeStaticMethod(Reflector.java:324)
	at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1322)
	at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.read(LispReader.java:220)
	at clojure.lang.LispReader.access$200(LispReader.java:41)
	at clojure.lang.LispReader$MetaReader.invoke(LispReader.java:954)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.readDelimitedList(LispReader.java:1398)
	at clojure.lang.LispReader$ListReader.invoke(LispReader.java:1243)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.read(LispReader.java:220)
	at clojure.lang.LispReader.access$200(LispReader.java:41)
	at clojure.lang.LispReader$EvalReader.invoke(LispReader.java:1301)
	at clojure.lang.LispReader$DispatchReader.invoke(LispReader.java:853)
	at clojure.lang.LispReader.read(LispReader.java:285)
	at clojure.lang.LispReader.read(LispReader.java:216)
	at clojure.lang.LispReader.read(LispReader.java:205)
	at clojure.lang.RT.readString(RT.java:1879)
	at clojure.lang.RT.readString(RT.java:1874)
	at manifold.deferred.Deferred$fn__13971.&lt;clinit&gt;(deferred.clj:398)
	... 16 common frames omitted</pre></z><z id="t1611829401" t="Shantanu Kumar Java version: openjdk version &quot;15.0.1&quot; 2020-10-20 OpenJDK Runtime Environment AdoptOpenJDK (build 15.0.1+9) OpenJDK 64-Bit Server VM AdoptOpenJDK (build 15.0.1+9, mixed mode, sharing)"><y>#</y><d>2021-01-28</d><h>10:23</h><w>Shantanu Kumar</w>Java version:
<pre>openjdk version &quot;15.0.1&quot; 2020-10-20
OpenJDK Runtime Environment AdoptOpenJDK (build 15.0.1+9)
OpenJDK 64-Bit Server VM AdoptOpenJDK (build 15.0.1+9, mixed mode, sharing)</pre></z><z id="t1611829435" t="Shantanu Kumar on OSX 10.15.7 (Catalina)"><y>#</y><d>2021-01-28</d><h>10:23</h><w>Shantanu Kumar</w>on OSX 10.15.7 (Catalina)</z><z id="t1611832033" t="chrisblom which version of aleph?"><y>#</y><d>2021-01-28</d><h>11:07</h><w>chrisblom</w>which version of aleph?</z><z id="t1611841487" t="Shantanu Kumar [:attrs {:href &quot;/_/_/users/U0P1MGUSX&quot;}] This is for Aleph 0.4.6"><y>#</y><d>2021-01-28</d><h>13:44</h><w>Shantanu Kumar</w><a>@chrisblom</a> This is for Aleph <code>0.4.6</code></z><z id="t1611844159" t="chrisblom aleph 0.4.6 works on my machine with clojure 1.10.2 and OpenJDK 64-Bit Server VM 11.0.3+7"><y>#</y><d>2021-01-28</d><h>14:29</h><w>chrisblom</w>aleph 0.4.6 works on my machine with clojure 1.10.2  and OpenJDK 64-Bit Server VM 11.0.3+7</z><z id="t1611866152" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U066J7E2U&quot;}] Can you give us a little more info, or maybe a demo repo? How are you starting it? What‚Äôs the project.clj/deps.edn look like?"><y>#</y><d>2021-01-28</d><h>20:35</h><w>Matthew Davidson (kingmob)</w><a>@kumarshantanu</a> Can you give us a little more info, or maybe a demo repo? How are you starting it? What‚Äôs the project.clj/deps.edn look like?</z><z id="t1614154324" t="eelke Hello, I have a question. I am trying to set up a server that can receive and process multipart messages. My attempt is with aleph with yada resources. But I have difficulties in processing the manifold.stream in the response. Do you have some tips and tricks?"><y>#</y><d>2021-02-24</d><h>08:12</h><w>eelke</w>Hello, I have a question. I am trying to set up a server that can receive and process multipart messages. My attempt is with aleph with yada resources. But I have difficulties in processing the manifold.stream in the response. Do you have some tips and tricks?</z><z id="t1614154544" t="eelke This is the code I have: (yada/listener [&quot;/some-route&quot; (yada/resource {:methods {:post {:consumes &quot;multipart/form-data&quot; :produces &quot;application/json&quot; :response (fn [ctx] (let [boundary (last (clojure.string/split (get-in ctx [:request :headers &quot;content-type&quot;]) #&quot;=&quot;))] (try (-&gt;&gt; (get-in ctx [:request :body]) (yada.multipart/parse-multipart boundary 10000 1000) (manifold.stream/transform (xf-bytes-&gt;content)) manifold.stream/stream-&gt;seq) (catch Exception e (println (.getMessage e))))) (clojure.data.json/write-str {:success true}))}}})] {:port 1234 :raw-stream? true :executor (flow/utilization-executor 0.9 64)})"><y>#</y><d>2021-02-24</d><h>08:15</h><w>eelke</w>This is the code I have:
<pre>(yada/listener
    [&quot;/some-route&quot;
     (yada/resource {:methods
                     {:post {:consumes &quot;multipart/form-data&quot;
                             :produces &quot;application/json&quot;
                             :response (fn [ctx]
                                         (let [boundary (last (clojure.string/split (get-in ctx [:request :headers &quot;content-type&quot;]) #&quot;=&quot;))]
                                           (try   (-&gt;&gt; (get-in ctx [:request :body])
                                                       (yada.multipart/parse-multipart boundary 10000 1000)
                                                       (manifold.stream/transform (xf-bytes-&gt;content))
                                                       manifold.stream/stream-&gt;seq)
                                                  (catch Exception e
                                                    (println (.getMessage e)))))
                                         (clojure.data.json/write-str {:success true}))}}})]
    {:port        1234
     :raw-stream? true
     :executor    (flow/utilization-executor 0.9 64)})</pre></z><z id="t1614155108" t="mccraigmccraig what do you want to do with the stream [:attrs {:href &quot;/_/_/users/U258C7RB2&quot;}] ? note that stream-&gt;seq should probably come with a warning - it&apos;s a blocking function"><y>#</y><d>2021-02-24</d><h>08:25</h><w>mccraigmccraig</w>what do you want to do with the stream <a>@eelke</a>? note that <code>stream-&gt;seq</code> should probably come with a warning - it&apos;s a blocking function</z><z id="t1614155313" t="eelke Hey [:attrs {:href &quot;/_/_/users/U0524B4UW&quot;}] , thanks for the response. I would like to process what comes through the stream. I can be that the client sends large multipart requests, containing tens of images or videos, and the server needs to handle this"><y>#</y><d>2021-02-24</d><h>08:28</h><w>eelke</w>Hey <a>@mccraigmccraig</a>, thanks for the response. I would like to process what comes through the stream. I can be that the client sends large multipart requests, containing tens of images or videos, and the server needs to handle this</z><z id="t1614155412" t="eelke @(d/chain (get-in ctx [:request :body]) #(manifold.stream/map bs/to-byte-array %) #(manifold.stream/reduce conj [] %) bs/to-string) "><y>#</y><d>2021-02-24</d><h>08:30</h><w>eelke</w><pre>@(d/chain (get-in ctx [:request :body])
           #(manifold.stream/map bs/to-byte-array %)
           #(manifold.stream/reduce conj [] %)
           bs/to-string)
                                                                      </pre></z><z id="t1614155462" t="eelke This does result in a string but it does not always contain everything that was send, I think"><y>#</y><d>2021-02-24</d><h>08:31</h><w>eelke</w>This does result in a string but it does not always contain everything that was send, I think</z><z id="t1614155605" t="mccraigmccraig ha, i&apos;m recalling a very bad evening spent debugging..."><y>#</y><d>2021-02-24</d><h>08:33</h><w>mccraigmccraig</w>ha, i&apos;m recalling a very bad evening spent debugging...</z><z id="t1614155715" t="mccraigmccraig question - do you have {:raw-stream? true} specified in your aleph.http/start-server opts ?"><y>#</y><d>2021-02-24</d><h>08:35</h><w>mccraigmccraig</w>question - do you have <code>{:raw-stream? true}</code> specified in your <code>aleph.http/start-server</code> opts ?</z><z id="t1614155857" t="mccraigmccraig as per: https://github.com/juxt/yada#troubleshooting-faq"><y>#</y><d>2021-02-24</d><h>08:37</h><w>mccraigmccraig</w>as per: <a href="https://github.com/juxt/yada#troubleshooting-faq" target="_blank">https://github.com/juxt/yada#troubleshooting-faq</a></z><z id="t1614155892" t="mccraigmccraig if you don&apos;t, flaky multipart parsing ensues"><y>#</y><d>2021-02-24</d><h>08:38</h><w>mccraigmccraig</w>if you don&apos;t, flaky multipart parsing ensues</z><z id="t1614155945" t="eelke ahah, I can imagine. I have it as an option indeed"><y>#</y><d>2021-02-24</d><h>08:39</h><w>eelke</w>ahah, I can imagine. I have it as an option indeed</z><z id="t1614155960" t="eelke you can see it in the map I sent with the listener"><y>#</y><d>2021-02-24</d><h>08:39</h><w>eelke</w>you can see it in the map I sent with the listener</z><z id="t1614156026" t="mccraigmccraig doh, yeah"><y>#</y><d>2021-02-24</d><h>08:40</h><w>mccraigmccraig</w>doh, yeah</z><z id="t1614156060" t="eelke I feel like I am close"><y>#</y><d>2021-02-24</d><h>08:41</h><w>eelke</w>I feel like I am close</z><z id="t1614156716" t="mccraigmccraig i&apos;ve not been using the stream-based multipart interface - what does yada.multipart/parse-multipart create a stream of ?"><y>#</y><d>2021-02-24</d><h>08:51</h><w>mccraigmccraig</w>i&apos;ve not been using the stream-based multipart interface - what does yada.multipart/parse-multipart create a stream of ?</z><z id="t1614157224" t="eelke Is there something else you use for multipart?"><y>#</y><d>2021-02-24</d><h>09:00</h><w>eelke</w>Is there something else you use for multipart?</z><z id="t1614157701" t="mccraigmccraig we&apos;ve been using the PartConsumer interface ... but iirc that&apos;s because that came first and we&apos;ve been using it since the beginning - i would have preferred a stream-based interface"><y>#</y><d>2021-02-24</d><h>09:08</h><w>mccraigmccraig</w>we&apos;ve been using the PartConsumer interface ... but iirc that&apos;s because that came first and we&apos;ve been using it since the beginning - i would have preferred a stream-based interface</z><z id="t1614157898" t="mccraigmccraig i&apos;d have a look around for an example of what the canonical yada resource should do now... PartConsumer wasn&apos;t the easiest to get working"><y>#</y><d>2021-02-24</d><h>09:11</h><w>mccraigmccraig</w>i&apos;d have a look around for an example of what the canonical yada resource should do now... PartConsumer wasn&apos;t the easiest to get working</z><z id="t1614158680" t="eelke ah ok, I&apos;ll keep trying"><y>#</y><d>2021-02-24</d><h>09:24</h><w>eelke</w>ah ok, I&apos;ll keep trying</z><z id="t1614340530" t="alvinfrancis Greetings, I have a quick question with aleph&apos;s http client. Is there a way to keep binding conveyance (like you get in other clojure core stuff)? Don&apos;t have much experience with it and wondering if it&apos;s even possible. (def ^:dynamic *val* :a) (binding [*val* :b] (-&gt; (aleph/get &quot;&quot;) (d/chain (fn [_] *val*)) deref)) ; returns :a but want to keep :b"><y>#</y><d>2021-02-26</d><h>11:55</h><w>alvinfrancis</w>Greetings, I have a quick question with aleph&apos;s http client.  Is there a way to keep binding conveyance (like you get in other clojure core stuff)?  Don&apos;t have much experience with it and wondering if it&apos;s even possible.
<pre>(def ^:dynamic *val* :a)
(binding [*val* :b]
  (-&gt;
   (aleph/get &quot;&quot;)
   (d/chain (fn [_] *val*))
   deref)) ; returns :a but want to keep :b</pre></z><z id="t1614343888" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/U83GQU8LE&quot;}] no - deferred&apos;s result in callbacks under the hood, and the callback may be processed on a different thread, so dynamic bindings will not generally be visible"><y>#</y><d>2021-02-26</d><h>12:51</h><w>mccraigmccraig</w><a>@alvin.francis.dumalus</a> no - deferred&apos;s result in callbacks under the hood, and the callback may be processed on a different thread, so dynamic bindings will not generally be visible</z><z id="t1614357423" t="hiredman Bound-fn"><y>#</y><d>2021-02-26</d><h>16:37</h><w>hiredman</w>Bound-fn</z><z id="t1614357846" t="mccraigmccraig bound-fn might be ok in some simple cases, but as soon as you start composing with promises you are in trouble again - i&apos;ve found it easier to stay away from dynvars altogether"><y>#</y><d>2021-02-26</d><h>16:44</h><w>mccraigmccraig</w>bound-fn might be ok in some simple cases, but as soon as you start composing with promises you are in trouble again - i&apos;ve found it easier to stay away from dynvars altogether</z><z id="t1615476675" t="ABeltramo Hello everyone, [:attrs {:href &quot;/_/_/users/U4ZDX466T&quot;}] suggested me to post my question over here, I posted it in the clojure channel too, here it goes:"><y>#</y><d>2021-03-11</d><h>15:31</h><w>ABeltramo</w>Hello everyone, <a>@flowthing</a> suggested me to post my question over here, I posted it in the clojure channel too, here it goes:</z><z id="t1615476764" t="ABeltramo I&apos;m using manifold and I can&apos;t wrap my head around splitting a stream: here&apos;s an example code: (defn split-stream [condition stream] (let [pos-stream (ms/stream) neg-stream (ms/stream)] (ms/consume (fn [e] (if (condition e) (ms/put! pos-stream e) (ms/put! neg-stream e))) stream) [(ms/source-only pos-stream) (ms/source-only neg-stream)])) (deftest streamz (let [rand-stream (ms/-&gt;source (repeatedly #(- (rand) 0.5)))] (-&gt;&gt; rand-stream (split-stream pos?) (apply ms/zip) ; ... Process pairs of [pos neg] ... (ms/stream-&gt;seq) (take 10) (println)))) A simple example that should capture my problem: I have a fn that generates values and put it into a stream. I need to process that stream in pairs based on a condition, can I split a stream into two streams? How can I accomplish that?"><y>#</y><d>2021-03-11</d><h>15:32</h><w>ABeltramo</w>I&apos;m using <code>manifold</code> and I can&apos;t wrap my head around splitting a stream: here&apos;s an example code:
<pre>(defn split-stream [condition stream]
  (let [pos-stream (ms/stream)
        neg-stream (ms/stream)]
    (ms/consume (fn [e]
                  (if (condition e)
                    (ms/put! pos-stream e)
                    (ms/put! neg-stream e)))
                stream)

    [(ms/source-only pos-stream)
     (ms/source-only neg-stream)]))

(deftest streamz
  (let [rand-stream (ms/-&gt;source (repeatedly #(- (rand) 0.5)))]
    (-&gt;&gt; rand-stream
         (split-stream pos?)
         (apply ms/zip)
         ; ... Process pairs of [pos neg] ...
         (ms/stream-&gt;seq)
         (take 10)
         (println))))</pre>
A simple example that should capture my problem: I have a fn that generates values and put it into a stream. I need to process that stream in pairs based on a condition, can I split a stream into two streams? How can I accomplish that?</z><z id="t1615476968" t="ABeltramo I tried something like (defn split-stream [condition stream] [(ms/filter condition stream) (ms/filter (comp not condition) stream)]) but this seems to not work with a single stream. I guess I could have two separate input streams but that will mean to discard valid inputs"><y>#</y><d>2021-03-11</d><h>15:36</h><w>ABeltramo</w>I tried something like
<pre>(defn split-stream [condition stream]
  [(ms/filter condition stream)
   (ms/filter (comp not condition) stream)])</pre>
but this seems to not work with a single stream. I guess I could have two separate input streams but that will mean to discard valid inputs</z><z id="t1615477447" t="ABeltramo (defn split-stream [condition stream] (let [pos-stream (ms/stream) neg-stream (ms/stream)] (ms/connect-via stream (fn [e] (if (condition e) (ms/put! pos-stream e) (ms/put! neg-stream e))) pos-stream) (ms/connect-via stream (fn [e] (if (condition e) (ms/put! pos-stream e) (ms/put! neg-stream e))) neg-stream) [(ms/source-only pos-stream) (ms/source-only neg-stream)])) Doing something like this seems to result in an infinite waiting. I guess you can&apos;t connect two stream to a single stream?"><y>#</y><d>2021-03-11</d><h>15:44</h><w>ABeltramo</w><pre>(defn split-stream [condition stream]
  (let [pos-stream (ms/stream)
        neg-stream (ms/stream)]
    (ms/connect-via stream
                    (fn [e]
                      (if (condition e)
                        (ms/put! pos-stream e)
                        (ms/put! neg-stream e)))
                    pos-stream)

    (ms/connect-via stream
                    (fn [e]
                      (if (condition e)
                        (ms/put! pos-stream e)
                        (ms/put! neg-stream e)))
                    neg-stream)

    [(ms/source-only pos-stream)
     (ms/source-only neg-stream)]))</pre>
Doing something like this seems to result in an infinite waiting. I guess you can&apos;t connect two stream to a single stream?</z><z id="t1615477546" t="lilactown when I limit the repeatedly call to 10 elements above, it seems to work"><y>#</y><d>2021-03-11</d><h>15:45</h><w>lilactown</w>when I limit the <code>repeatedly</code> call to 10 elements above, it seems to work</z><z id="t1615477750" t="ABeltramo Which split-stream does work with the 10 elements limit for you?"><y>#</y><d>2021-03-11</d><h>15:49</h><r>ABeltramo</r>Which <code>split-stream</code> does work with the 10 elements limit for you?</z><z id="t1615477784" t="lilactown the first one you pasted in the channel"><y>#</y><d>2021-03-11</d><h>15:49</h><r>lilactown</r>the first one you pasted in the channel</z><z id="t1615477798" t="lilactown also just return a vector with [(ms/filter ,,,) (ms/filter ,,,)]"><y>#</y><d>2021-03-11</d><h>15:49</h><r>lilactown</r>also just return a vector with <code>[(ms/filter ,,,) (ms/filter ,,,)]</code></z><z id="t1615477845" t="ABeltramo the first one should work because I&apos;m forcing the consume but it doesn&apos;t seem like a good solution (since there&apos;s no end to the generator)"><y>#</y><d>2021-03-11</d><h>15:50</h><r>ABeltramo</r>the first one should work because I&apos;m forcing the <code>consume</code> but it doesn&apos;t seem like a good solution (since there&apos;s no end to the generator)</z><z id="t1615586863" t="Matthew Davidson (kingmob) Bit late to the party, but consume isn‚Äôt what you want in the middle of a stream. It‚Äôs more a terminal thing."><y>#</y><d>2021-03-12</d><h>22:07</h><r>Matthew Davidson (kingmob)</r>Bit late to the party, but consume isn‚Äôt what you want in the middle of a stream. It‚Äôs more a terminal thing.</z><z id="t1615477677" t="lilactown going to 1000 seems to lock up my REPL"><y>#</y><d>2021-03-11</d><h>15:47</h><w>lilactown</w>going to 1000 seems to lock up my REPL</z><z id="t1615477682" t="lilactown so this seems to be an issue trying to chunk the stream of values"><y>#</y><d>2021-03-11</d><h>15:48</h><w>lilactown</w>so this seems to be an issue trying to chunk the stream of values</z><z id="t1615478119" t="ABeltramo Maybe I should take a different approach and making a transducer to be used with transform , I don&apos;t really need two streams, I need pairs."><y>#</y><d>2021-03-11</d><h>15:55</h><w>ABeltramo</w>Maybe I should take a different approach and making a transducer to be used with <code>transform</code>, I don&apos;t really need two streams, I need pairs.</z><z id="t1615478210" t="lilactown I guess I just don&apos;t see where the issue is yet."><y>#</y><d>2021-03-11</d><h>15:56</h><w>lilactown</w>I guess I just don&apos;t see where the issue is yet.</z><z id="t1615478432" t="ABeltramo Don&apos;t worry, it&apos;s probably me, I&apos;m very new to Manifold! Thing is that I would like to split a stream into two separate streams based on a condition. I would like to generate stuff once and put it in the right stream, at the same time, I would like to generate only when someone needs to take downstream from the two child streams."><y>#</y><d>2021-03-11</d><h>16:00</h><w>ABeltramo</w>Don&apos;t worry, it&apos;s probably me, I&apos;m very new to Manifold! Thing is that I would like to split a stream into two separate streams based on a condition. I would like to generate stuff once and put it in the right stream, at the same time, I would like to generate only when someone needs to <code>take</code>  downstream from the two child streams.</z><z id="t1615587663" t="Matthew Davidson (kingmob) ‚ÄúI would like to generate only when someone needs to¬†take¬† downstream from the two child streams.‚Äù This is a bit antithetical to how Manifold streams work. Manifold streams (and most stream libs) are push-based. A value enters the top of the stream, and a chain of callbacks and/or continuations propagates it automatically. What you describe is closer to standard lazy seqs, or the reactive-streams specification (e.g., java.util.concurrent.Flow), which are pull-based."><y>#</y><d>2021-03-12</d><h>22:21</h><r>Matthew Davidson (kingmob)</r>‚ÄúI would like to generate only when someone needs to¬†take¬† downstream from the two child streams.‚Äù

This is a bit antithetical to how Manifold streams work. Manifold streams (and most stream libs) are push-based. A value enters the top of the stream, and a chain of callbacks and/or continuations propagates it automatically.

What you describe is closer to standard lazy seqs, or the reactive-streams specification (e.g., java.util.concurrent.Flow), which are pull-based.</z><z id="t1615587879" t="Matthew Davidson (kingmob) (That being said, a seq source wrapped around an infinite seq like repeatedly will pull values on demand)"><y>#</y><d>2021-03-12</d><h>22:24</h><r>Matthew Davidson (kingmob)</r>(That being said, a seq source wrapped around an infinite seq like repeatedly will pull values on demand)</z><z id="t1615478568" t="lilactown so the examples I&apos;ve been working through, eventually my REPL locks up trying to run them"><y>#</y><d>2021-03-11</d><h>16:02</h><w>lilactown</w>so the examples I&apos;ve been working through, eventually my REPL locks up trying to run them</z><z id="t1615478575" t="lilactown I guess the problem is that the producer that connects the streams together needs to buffer the values"><y>#</y><d>2021-03-11</d><h>16:02</h><w>lilactown</w>I guess the problem is that the producer that connects the streams together needs to buffer the values</z><z id="t1615478584" t="ABeltramo (deftest streamz (let [rand-stream-1 (ms/-&gt;source (repeatedly #(- (rand) 0.5))) rand-stream-2 (ms/-&gt;source (repeatedly #(- (rand) 0.5)))] (-&gt;&gt; (ms/zip (ms/filter pos? rand-stream-1) (ms/filter neg? rand-stream-2)) ; ... Process pairs of [pos neg] ... (ms/stream-&gt;seq) (take 10) (println)))) For example this works fine, but in my use case generating is an expensive operation and I would really prefer to not waste generated stuff using filter."><y>#</y><d>2021-03-11</d><h>16:03</h><w>ABeltramo</w><pre>(deftest streamz
  (let [rand-stream-1 (ms/-&gt;source (repeatedly  #(- (rand) 0.5)))
        rand-stream-2 (ms/-&gt;source (repeatedly  #(- (rand) 0.5)))]
    (-&gt;&gt; (ms/zip (ms/filter pos? rand-stream-1)
                 (ms/filter neg? rand-stream-2))
         ; ... Process pairs of [pos neg] ...
         (ms/stream-&gt;seq)
         (take 10)
         (println))))</pre>
For example this works fine, but in my use case generating is an expensive operation and I would really prefer to not waste generated stuff using filter.</z><z id="t1615478714" t="lilactown (require &apos;[manifold.deferred :as m] &apos;[manifold.stream :as ms]) (defn split-stream [condition stream] [(ms/buffer 100 (ms/filter condition stream)) (ms/buffer 100 (ms/filter (comp not condition) stream))]) (comment (let [rand-stream (-&gt;&gt; (repeatedly 100 #(- (rand) 0.5)) (ms/-&gt;source))] (-&gt;&gt; rand-stream (split-stream pos?) (apply ms/zip) ;; ... Process pairs of [pos neg] ... (ms/consume (fn [[a b]] (prn a b))))) )"><y>#</y><d>2021-03-11</d><h>16:05</h><w>lilactown</w><pre>(require &apos;[manifold.deferred :as m]
         &apos;[manifold.stream :as ms])

(defn split-stream [condition stream]
  [(ms/buffer 100 (ms/filter condition stream))
   (ms/buffer 100 (ms/filter (comp not condition) stream))])

(comment
  (let [rand-stream (-&gt;&gt; (repeatedly 100 #(- (rand) 0.5))
                         (ms/-&gt;source))]
    (-&gt;&gt; rand-stream
         (split-stream pos?)
         (apply ms/zip)
         ;; ... Process pairs of [pos neg] ...
         (ms/consume
          (fn [[a b]]
            (prn a b)))))
  )</pre></z><z id="t1615478724" t="lilactown this appears to work for me"><y>#</y><d>2021-03-11</d><h>16:05</h><w>lilactown</w>this appears to work for me</z><z id="t1615478800" t="ABeltramo Thanks, I&apos;ll try it out. Just by looking at it, is it working because you produce 100 elements and buffers have the same size? Because I don&apos;t know how much elements I have to produce in advance, I would like to be something that comes downstream, hence the take at the bottom."><y>#</y><d>2021-03-11</d><h>16:06</h><w>ABeltramo</w>Thanks, I&apos;ll try it out. Just by looking at it, is it working because you produce 100 elements and buffers have the same size? Because I don&apos;t know how much elements I have to produce in advance, I would like to be something that comes downstream, hence the <code>take</code> at the bottom.</z><z id="t1615479124" t="lilactown yes, I think the problem is that the zip will repeatedly take! from each stream, and if you end up with a stream that doesn&apos;t alternative between the two conditions, you end up in a deadlock"><y>#</y><d>2021-03-11</d><h>16:12</h><w>lilactown</w>yes, I think the problem is that the <code>zip</code> will repeatedly <code>take!</code> from each stream, and if you end up with a stream that doesn&apos;t alternative between the two conditions, you end up in a deadlock</z><z id="t1615479241" t="ABeltramo So, for example, the issue will be when you generate batch-size elements that are all positive, am I right?"><y>#</y><d>2021-03-11</d><h>16:14</h><w>ABeltramo</w>So, for example, the issue will be when you generate <code>batch-size</code> elements that are all positive, am I right?</z><z id="t1615479326" t="lilactown or just something like: (let [rand-stream (-&gt;&gt; [1 2 3 -4 1 2 3 -4] (ms/-&gt;source))] ,,,)"><y>#</y><d>2021-03-11</d><h>16:15</h><w>lilactown</w>or just something like:
<pre>(let [rand-stream (-&gt;&gt; [1 2 3 -4 1 2 3 -4]
                         (ms/-&gt;source))]
   ,,,)</pre></z><z id="t1615479382" t="ABeltramo I see, but I have an infinite generator of numbers! üòÖ"><y>#</y><d>2021-03-11</d><h>16:16</h><w>ABeltramo</w>I see, but I have an infinite generator of numbers! <b>üòÖ</b></z><z id="t1615479436" t="ABeltramo I think I&apos;ll go with the two generator streams and filter that discards elements. If anyone have a better solution, please ping me!"><y>#</y><d>2021-03-11</d><h>16:17</h><w>ABeltramo</w>I think I&apos;ll go with the two generator streams and filter that discards elements. If anyone have a better solution, please ping me!</z><z id="t1615479451" t="lilactown yeah, the issue is not the total number of positive or negative but the fact that you might end up needing to put! multiple positive or negative numbers in a row"><y>#</y><d>2021-03-11</d><h>16:17</h><w>lilactown</w>yeah, the issue is not the total number of positive or negative but the fact that you might end up needing to <code>put!</code> multiple positive or negative numbers in a row</z><z id="t1615479562" t="lilactown in this example, without buffering, the producer blocks trying to put! the 2 value on the filter pos? stream until it&apos;s consumed, and the zip consumer won&apos;t take! from the filter pos? stream until it can take! a value from the filter not pos? stream"><y>#</y><d>2021-03-11</d><h>16:19</h><w>lilactown</w>in this example, without buffering, the producer blocks trying to <code>put!</code> the <code>2</code> value on the <code>filter pos?</code> stream until it&apos;s consumed, and the <code>zip</code> consumer won&apos;t <code>take!</code> from the <code>filter pos?</code> stream until it can <code>take!</code> a value from the <code>filter not pos?</code> stream</z><z id="t1615479620" t="ABeltramo Thank you [:attrs {:href &quot;/_/_/users/U4YGF4NGM&quot;}] for your help, I got a better understanding of the issue now!"><y>#</y><d>2021-03-11</d><h>16:20</h><w>ABeltramo</w>Thank you <a>@lilactown</a> for your help, I got a better understanding of the issue now!</z><z id="t1615479826" t="lilactown perhaps you could do the filtering before creating the stream? I don&apos;t really know what this looks like in your application"><y>#</y><d>2021-03-11</d><h>16:23</h><w>lilactown</w>perhaps you could do the filtering before creating the stream? I don&apos;t really know what this looks like in your application</z><z id="t1615479987" t="lilactown ex. this works: (let [rand-seq (repeatedly #(- (rand) 0.5)) pos (ms/-&gt;source (filter pos? rand-seq)) neg (ms/-&gt;source (filter neg? rand-seq))] (-&gt;&gt; (ms/zip pos neg) ;; ... Process pairs of [pos neg] ... (ms/stream-&gt;seq) (take 10) prn))"><y>#</y><d>2021-03-11</d><h>16:26</h><w>lilactown</w>ex. this works:
<pre>(let [rand-seq (repeatedly #(- (rand) 0.5))
        pos (ms/-&gt;source (filter pos? rand-seq))
        neg (ms/-&gt;source (filter neg? rand-seq))]
    (-&gt;&gt; (ms/zip pos neg)
         ;; ... Process pairs of [pos neg] ...
         (ms/stream-&gt;seq)
         (take 10)
         prn))</pre></z><z id="t1615480054" t="lilactown since you said that the generation is expensive, this wraps it in a single sequence but then creates two different producers on top of it"><y>#</y><d>2021-03-11</d><h>16:27</h><w>lilactown</w>since you said that the generation is expensive, this wraps it in a single sequence but then creates two different producers on top of it</z><z id="t1615480087" t="ABeltramo Ah! You might be right!"><y>#</y><d>2021-03-11</d><h>16:28</h><w>ABeltramo</w>Ah! You might be right!</z><z id="t1615480162" t="ABeltramo So instead of doing the filtering inside the stream I generate two lazy lazy seqs from the original sequence."><y>#</y><d>2021-03-11</d><h>16:29</h><w>ABeltramo</w>So instead of doing the filtering inside the stream I generate two lazy lazy seqs from the original sequence.</z><z id="t1615480216" t="lilactown I think the key insight is to create two sources based on the original sequence, I don&apos;t think it matters whether you do the filtering as a seq or a stream"><y>#</y><d>2021-03-11</d><h>16:30</h><w>lilactown</w>I think the key insight is to create two sources based on the original sequence, I don&apos;t think it matters whether you do the filtering as a seq or a stream</z><z id="t1615480222" t="lilactown (let [rand-seq (repeatedly #(- (rand) 0.5)) pos (-&gt;&gt; (ms/-&gt;source rand-seq) (ms/filter pos?)) neg (-&gt;&gt; (ms/-&gt;source rand-seq) (ms/filter neg?))] (-&gt;&gt; (ms/zip pos neg) ;; ... Process pairs of [pos neg] ... (ms/stream-&gt;seq) (take 10) prn))"><y>#</y><d>2021-03-11</d><h>16:30</h><w>lilactown</w><pre>(let [rand-seq (repeatedly #(- (rand) 0.5))
        pos (-&gt;&gt; (ms/-&gt;source rand-seq)
                 (ms/filter pos?))
        neg (-&gt;&gt; (ms/-&gt;source rand-seq)
                 (ms/filter neg?))]
    (-&gt;&gt; (ms/zip pos neg)
         ;; ... Process pairs of [pos neg] ...
         (ms/stream-&gt;seq)
         (take 10)
         prn))</pre></z><z id="t1615480282" t="ABeltramo Right right I see.. And this will not call rand-seq twice?"><y>#</y><d>2021-03-11</d><h>16:31</h><w>ABeltramo</w>Right right I see.. And this will not call <code>rand-seq</code> twice?</z><z id="t1615480469" t="lilactown I can&apos;t imagine how it would"><y>#</y><d>2021-03-11</d><h>16:34</h><w>lilactown</w>I can&apos;t imagine how it would</z><z id="t1615480574" t="lilactown that would break a lot of assumptions I have about lazy seqs"><y>#</y><d>2021-03-11</d><h>16:36</h><w>lilactown</w>that would break a lot of assumptions I have about lazy seqs</z><z id="t1615482164" t="ABeltramo I&apos;m sorry, I need some hammock time to think about it but it really seems the solution I was looking for. [:attrs {:href &quot;/_/_/users/U4YGF4NGM&quot;}] thank you so much for the help!"><y>#</y><d>2021-03-11</d><h>17:02</h><w>ABeltramo</w>I&apos;m sorry, I need some hammock time to think about it but it really seems the solution I was looking for. <a>@lilactown</a> thank you so much for the help!</z><z id="t1615483007" t="lilactown you&apos;re welcome!"><y>#</y><d>2021-03-11</d><h>17:16</h><w>lilactown</w>you&apos;re welcome!</z><z id="t1615483053" t="lilactown I learned a bunch as well üòÑ tbh I only have a surface knowledge of manifold"><y>#</y><d>2021-03-11</d><h>17:17</h><w>lilactown</w>I learned a bunch as well <b>üòÑ</b> tbh I only have a surface knowledge of manifold</z><z id="t1615483117" t="lilactown interestingly this is related to a problem I&apos;ve been thinking about in asynchronous programming. would it be okay if I took the example we&apos;ve been talking about here and used it in a blog post?"><y>#</y><d>2021-03-11</d><h>17:18</h><w>lilactown</w>interestingly this is related to a problem I&apos;ve been thinking about in asynchronous programming. would it be okay if I took the example we&apos;ve been talking about here and used it in a blog post?</z><z id="t1615484128" t="ABeltramo You sure can! There&apos;s nothing confidential in the example I made."><y>#</y><d>2021-03-11</d><h>17:35</h><r>ABeltramo</r>You sure can! There&apos;s nothing confidential in the example I made.</z></g><g id="s7"><z id="t1615483161" t="pablore [:attrs {:href &quot;/_/_/users/UCNA9LQLA&quot;}] You tried using transform with (juxt filter remove) ?"><y>#</y><d>2021-03-11</d><h>17:19</h><w>pablore</w><a>@beltramo.ale</a> You tried using <code>transform</code> with <code>(juxt filter remove)</code>?</z><z id="t1615484189" t="ABeltramo I tried and failed, but this was in the middle of trying out [:attrs {:href &quot;/_/_/users/U4YGF4NGM&quot;}] solutions so I might have missed something.."><y>#</y><d>2021-03-11</d><h>17:36</h><r>ABeltramo</r>I tried and failed, but this was in the middle of trying out <a>@lilactown</a> solutions so I might have missed something..</z><z id="t1615484294" t="ABeltramo I saw that usage of juxt when I was looking at a transducer to be used and I stumble upon the separate fn."><y>#</y><d>2021-03-11</d><h>17:38</h><r>ABeltramo</r>I saw that usage of <code>juxt</code> when I was looking at a transducer to be used and I stumble upon the  <code>separate</code>  fn.</z><z id="t1615483188" t="pablore (juxt filter remove) solves your problem for sequences"><y>#</y><d>2021-03-11</d><h>17:19</h><w>pablore</w><code>(juxt filter remove)</code> solves your problem for sequences</z><z id="t1620719246" t="gomosdg Hi everyone, Thanks to everyone that‚Äôs contributed to aleph. Really cool tool! I just need to know, is there a way to find out when a websocket is clodes? For example, on http-kit there‚Äôs on-close function that you can provide."><y>#</y><d>2021-05-11</d><h>07:47</h><w>gomosdg</w>Hi everyone,

Thanks to everyone that‚Äôs contributed to aleph. Really cool tool!

I just need to know, is there a way to find out when a websocket is clodes? For example, on http-kit there‚Äôs on-close function that you can provide.</z><z id="t1620719981" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/UNWQR4Q83&quot;}] the manifold stream you get from the websocket will close when the websocket closes - you can use stream/on-closed to register a callback: https://github.com/clj-commons/manifold/blob/master/src/manifold/stream.clj#L209"><y>#</y><d>2021-05-11</d><h>07:59</h><w>mccraigmccraig</w><a>@lilokoego</a> the manifold <code>stream</code> you get from the websocket will close when the websocket closes - you can use <code>stream/on-closed</code> to register a callback: <a href="https://github.com/clj-commons/manifold/blob/master/src/manifold/stream.clj#L209" target="_blank">https://github.com/clj-commons/manifold/blob/master/src/manifold/stream.clj#L209</a></z><z id="t1620720094" t="gomosdg Awesome, thanks! Both bits of information are very helpful!"><y>#</y><d>2021-05-11</d><h>08:01</h><w>gomosdg</w>Awesome, thanks! Both bits of information are very helpful!</z><z id="t1620807749" t="gomosdg I am trying to serve ws connection and html from a single controller using: (d/catch (http/websocket-connection req) (fn [_] nil))"><y>#</y><d>2021-05-12</d><h>08:22</h><w>gomosdg</w>I am trying to serve ws connection and html from a single controller using:

<pre>(d/catch
                        (http/websocket-connection req)
                        (fn [_] nil))</pre></z><z id="t1620807772" t="gomosdg and serving html when conn is nil"><y>#</y><d>2021-05-12</d><h>08:22</h><w>gomosdg</w>and serving html when conn is nil</z><z id="t1620807831" t="gomosdg But when it seems like aleph ends up getting the exception from http/websocket-connection anyways and instead of displaying my html it shows ‚Äúexpected websocket request‚Äù on the browser"><y>#</y><d>2021-05-12</d><h>08:23</h><w>gomosdg</w>But when it seems like aleph ends up getting the exception from http/websocket-connection anyways and instead of displaying my html it shows ‚Äúexpected websocket request‚Äù on the browser</z><z id="t1620807863" t="gomosdg The full handler: (defn room-handler [req] (d/let-flow [room-id (get-in req [:params :room-id]) username (get-in req [:session :identity]) room (get @rooms room-id) conn (d/catch (http/websocket-connection req) (fn [_] nil))] (if conn (r/add-user! room {:username username :stream conn}) (layouts/main (str &quot;SDG Rooms - &quot; (r/get-name room)) (r/get-view room)))))"><y>#</y><d>2021-05-12</d><h>08:24</h><w>gomosdg</w>The full handler:

<pre>(defn room-handler [req]
  (d/let-flow [room-id (get-in req [:params :room-id])
               username (get-in req [:session :identity])
               room (get @rooms room-id)
               conn (d/catch
                        (http/websocket-connection req)
                        (fn [_] nil))]

              (if conn
                (r/add-user! room {:username username
                                   :stream conn})
                (layouts/main (str &quot;SDG Rooms - &quot; (r/get-name room))
                              (r/get-view room)))))</pre></z><z id="t1620841204" t="hiredman the way websockets are usually handled (in netty, not sure about aleph) is you pick a specific url path (route) for websockets"><y>#</y><d>2021-05-12</d><h>17:40</h><w>hiredman</w>the way websockets are usually handled (in netty, not sure about aleph) is you pick a specific url path (route) for websockets</z><z id="t1620841268" t="hiredman my guess is the netty websocket stuff returns the ‚Äúexpected websocket request‚Äù instead of throwing any kind of exception"><y>#</y><d>2021-05-12</d><h>17:41</h><w>hiredman</w>my guess is the netty websocket stuff returns the ‚Äúexpected websocket request‚Äù instead of throwing any kind of exception</z><z id="t1621443737" t="Leonid Korogodski Hey, everyone. I have a reverse proxy that currently uses http-kit , but I want to replace it with aleph because I want to be able to stream large files through the proxy, and http-kit insists on buffering the entire response before sending it back. However, I&apos;m getting the following error: 2021-05-19T10:52:10,976 [aleph-netty-server-event-pool-5] ERROR aleph.http.core - error sending body of type clojure.lang.PersistentArrayMap java.lang.IllegalArgumentException: Don&apos;t know how to convert class clojure.lang.PersistentArrayMap into (stream-of io.netty.buffer.ByteBuf) at byte_streams$convert.invokeStatic(byte_streams.clj:196) at byte_streams$convert.invoke(byte_streams.clj:162) at aleph.netty$to_byte_buf_stream.invokeStatic(netty.clj:203) at aleph.netty$to_byte_buf_stream.invoke(netty.clj:202) at aleph.http.core$send_streaming_body.invokeStatic(core.clj:318) at aleph.http.core$send_streaming_body.invoke(core.clj:273) at aleph.http.core$eval10167$send_message__10174$fn__10175.invoke(core.clj:535) at aleph.http.core$eval10167$send_message__10174.invoke(core.clj:534) at aleph.http.server$eval10262$send_response__10267$f__9568__auto____10273.invoke(server.clj:140) at aleph.http.server$eval10262$send_response__10267$fn__10275.invoke(server.clj:129) at clojure.lang.AFn.run(AFn.java:22) at io.netty.util.concurrent.AbstractEventExecutor.safeExecute$$$capture(AbstractEventExecutor.java:164) at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java) at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:500) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at manifold.executor$thread_factory$reify__4367$f__4368.invoke(executor.clj:47) at clojure.lang.AFn.run(AFn.java:22) at java.base/java.lang.Thread.run(Thread.java:829) The code in question is simple: (http/request {:url (create-url api request) :method request-method :query-params query-params :headers (create-headers request api) :body body :as :stream}) In this particular case, the method is GET, the body is nil, and there are no query params."><y>#</y><d>2021-05-19</d><h>17:02</h><w>Leonid Korogodski</w>Hey, everyone. I have a reverse proxy that currently uses <code>http-kit</code>, but I want to replace it with <code>aleph</code> because I want to be able to stream large files through the proxy, and <code>http-kit</code> insists on buffering the entire response before sending it back.

However, I&apos;m getting the following error:
<pre>2021-05-19T10:52:10,976 [aleph-netty-server-event-pool-5] ERROR aleph.http.core - error sending body of type  clojure.lang.PersistentArrayMap 
java.lang.IllegalArgumentException: Don&apos;t know how to convert class clojure.lang.PersistentArrayMap into (stream-of io.netty.buffer.ByteBuf)
	at byte_streams$convert.invokeStatic(byte_streams.clj:196)
	at byte_streams$convert.invoke(byte_streams.clj:162)
	at aleph.netty$to_byte_buf_stream.invokeStatic(netty.clj:203)
	at aleph.netty$to_byte_buf_stream.invoke(netty.clj:202)
	at aleph.http.core$send_streaming_body.invokeStatic(core.clj:318)
	at aleph.http.core$send_streaming_body.invoke(core.clj:273)
	at aleph.http.core$eval10167$send_message__10174$fn__10175.invoke(core.clj:535)
	at aleph.http.core$eval10167$send_message__10174.invoke(core.clj:534)
	at aleph.http.server$eval10262$send_response__10267$f__9568__auto____10273.invoke(server.clj:140)
	at aleph.http.server$eval10262$send_response__10267$fn__10275.invoke(server.clj:129)
	at clojure.lang.AFn.run(AFn.java:22)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute$$$capture(AbstractEventExecutor.java:164)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:500)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at manifold.executor$thread_factory$reify__4367$f__4368.invoke(executor.clj:47)
	at clojure.lang.AFn.run(AFn.java:22)
	at java.base/java.lang.Thread.run(Thread.java:829)</pre>
The code in question is simple:
<pre>(http/request {:url          (create-url api request)
               :method       request-method
               :query-params query-params
               :headers      (create-headers request api)
               :body         body
               :as           :stream})</pre>
In this particular case, the method is GET, the body is nil, and there are no query params.</z><z id="t1621445480" t="valerauko what are create-url and create-headers?"><y>#</y><d>2021-05-19</d><h>17:31</h><r>valerauko</r>what are create-url and create-headers?</z><z id="t1621448133" t="valerauko i&apos;m suspecting you&apos;re accidentally passing a map as a parameter that aleph expects to be a (netty) bytebuf"><y>#</y><d>2021-05-19</d><h>18:15</h><r>valerauko</r>i&apos;m suspecting you&apos;re accidentally passing a map as a parameter that aleph expects to be a (netty) bytebuf</z><z id="t1621448149" t="valerauko which is probably body by the way"><y>#</y><d>2021-05-19</d><h>18:15</h><r>valerauko</r>which is probably body by the way</z><z id="t1621443764" t="Leonid Korogodski Using 0.4.7-alpha7 ."><y>#</y><d>2021-05-19</d><h>17:02</h><w>Leonid Korogodski</w>Using <code>0.4.7-alpha7</code>.</z><z id="t1621447580" t="hiredman looks like that isn&apos;t from the request code you shared, but looks like you are trying to return the result of the request as an http response, and the error is from there"><y>#</y><d>2021-05-19</d><h>18:06</h><w>hiredman</w>looks like that isn&apos;t from the request code you shared, but looks like you are trying to return the result of the request as an http response, and the error is from there</z><z id="t1621447989" t="Leonid Korogodski Yes, of course. It&apos;s a reverse proxy."><y>#</y><d>2021-05-19</d><h>18:13</h><w>Leonid Korogodski</w>Yes, of course. It&apos;s a reverse proxy.</z><z id="t1621448032" t="Leonid Korogodski But why the error?"><y>#</y><d>2021-05-19</d><h>18:13</h><w>Leonid Korogodski</w>But why the error?</z><z id="t1621448524" t="hiredman whatever request returns isn&apos;t something that aleph knows how to serve as an http response"><y>#</y><d>2021-05-19</d><h>18:22</h><w>hiredman</w>whatever request returns isn&apos;t something that aleph knows how to serve as an http response</z><z id="t1621448650" t="hiredman if I had to guess (which I kind of do, because I don&apos;t really use aleph ever), request returns a deferred that yields a map, and aleph expects a deferred to just yield bytes to serve"><y>#</y><d>2021-05-19</d><h>18:24</h><w>hiredman</w>if I had to guess (which I kind of do, because I don&apos;t really use aleph ever), request returns a deferred that yields a map, and aleph expects a deferred to just yield bytes to serve</z><z id="t1621448720" t="Leonid Korogodski Yes. Strange that aleph wouldn&apos;t handle that."><y>#</y><d>2021-05-19</d><h>18:25</h><w>Leonid Korogodski</w>Yes. Strange that aleph wouldn&apos;t handle that.</z><z id="t1625568603" t="pithyless Has anybody seen a lock on java.util.ListResourceBundle coming from aleph.http.server/rfc-1123-date-string before? I&apos;ve started a thread in #java if someone would like to offer some suggestions or insights: https://clojurians.slack.com/archives/C1AC4BU2K/p1625568233016600"><y>#</y><d>2021-07-06</d><h>10:50</h><w>pithyless</w>Has anybody seen a lock on <code>java.util.ListResourceBundle</code> coming from <code>aleph.http.server/rfc-1123-date-string</code> before?

I&apos;ve started a thread in #java if someone would like to offer some suggestions or insights: <a href="https://clojurians.slack.com/archives/C1AC4BU2K/p1625568233016600" target="_blank">https://clojurians.slack.com/archives/C1AC4BU2K/p1625568233016600</a></z><z id="t1628237061" t="dsp Hi folks. Just made a new issue: https://github.com/clj-commons/aleph/issues/569"><y>#</y><d>2021-08-06</d><h>08:04</h><w>dsp</w>Hi folks. Just made a new issue: <a href="https://github.com/clj-commons/aleph/issues/569" target="_blank">https://github.com/clj-commons/aleph/issues/569</a></z><z id="t1628951581" t="Ivan Fedorov Having an intermittent issue between aleph-0.4.7 - nginx - iOS Safari in a Fullscreen (PWA) mode Websocket kept being cancelled. Web app in safari reopens the connection in a second, and then in two seconds it‚Äôs closed again. Other browsers behaved good. Safari said it was the server who dropped the connection. Logging showed it was closed via (manifold.stream/on-closed channel callback) Don‚Äôt know how to diagnose it further."><y>#</y><d>2021-08-14</d><h>14:33</h><w>Ivan Fedorov</w>Having an intermittent issue between aleph-0.4.7 - nginx - iOS Safari in a Fullscreen (PWA) mode
Websocket kept being cancelled.
Web app in safari reopens the connection in a second, and then in two seconds it‚Äôs closed again.
Other browsers behaved good.
Safari said it was the server who dropped the connection.
Logging showed it was closed via <code>(manifold.stream/on-closed channel callback)</code>
Don‚Äôt know how to diagnose it further.</z><z id="t1628964476" t="Matthew Davidson (kingmob) Manifold 0.1.9-alpha5 is now out with a bunch of bug fixes. Please give it a whirl. https://github.com/clj-commons/manifold/blob/master/CHANGES.md"><y>#</y><d>2021-08-14</d><h>18:07</h><w>Matthew Davidson (kingmob)</w>Manifold 0.1.9-alpha5 is now out with a bunch of bug fixes. Please give it a whirl. <a href="https://github.com/clj-commons/manifold/blob/master/CHANGES.md" target="_blank">https://github.com/clj-commons/manifold/blob/master/CHANGES.md</a></z><z id="t1628964530" t="Matthew Davidson (kingmob) Also, would people like a Manifold-specific Slack channel?"><y>#</y><d>2021-08-14</d><h>18:08</h><w>Matthew Davidson (kingmob)</w>Also, would people like a Manifold-specific Slack channel?</z><z id="t1630052162" t="valerauko I&apos;m happy to see manifold getting updates. It&apos;s a wonderful interface to dealing with async stuff."><y>#</y><d>2021-08-27</d><h>08:16</h><w>valerauko</w>I&apos;m happy to see manifold getting updates. It&apos;s a wonderful interface to dealing with async stuff.</z><z id="t1630295624" t="Matthew Davidson (kingmob) Manifold 0.1.9-alpha6 is out. Only change is to bump some deps to modern versions. If nobody complains, alpha6 will be promoted to 0.1.9, and then I‚Äôll start on 0.2.0 with a bunch of the waiting Yummly bug fixes and features."><y>#</y><d>2021-08-30</d><h>03:53</h><w>Matthew Davidson (kingmob)</w>Manifold 0.1.9-alpha6 is out. Only change is to bump some deps to modern versions. If nobody complains, alpha6 will be promoted to 0.1.9, and then I‚Äôll start on 0.2.0 with a bunch of the waiting Yummly bug fixes and features.</z><z id="t1630567436" t="Ben Sless Is there an issue relating to memory leaks with aleph? When profiling with wrk2 I noticed terrible results which eventually got me to investigate gc and memory usage. Looks like ~50% of the heap is consumed by LinkedList, Deferred and ReentrantLock. Also looks like old gen keeps growing indefinitely. I can share more details and help with reproduction"><y>#</y><d>2021-09-02</d><h>07:23</h><w>Ben Sless</w>Is there an issue relating to memory leaks with aleph? When profiling with wrk2 I noticed terrible results which eventually got me to investigate gc and memory usage. Looks like ~50% of the heap is consumed by LinkedList, Deferred and ReentrantLock. Also looks like old gen keeps growing indefinitely.
I can share more details and help with reproduction</z><z id="t1630577970" t="Ben Sless Anyway, reproduction is easy run Aleph server with non blocking ring handler for 10 minutes at a high rate (I tried 10k qps), attach visual vm, behold the mess"><y>#</y><d>2021-09-02</d><h>10:19</h><r>Ben Sless</r>Anyway, reproduction is easy
run Aleph server with non blocking ring handler for 10 minutes at a high rate (I tried 10k qps), attach visual vm, behold the mess</z><z id="t1630578435" t="Ben Sless The garbage can be collected once the benchmark finishes, could be perhaps some link between open connections and deferred-s not being collected?"><y>#</y><d>2021-09-02</d><h>10:27</h><r>Ben Sless</r>The garbage can be collected once the benchmark finishes, could be perhaps some link between open connections and deferred-s not being collected?</z><z id="t1630614247" t="nha I am not sure if this can be related: https://github.com/juxt/yada/issues/324"><y>#</y><d>2021-09-02</d><h>20:24</h><r>nha</r>I am not sure if this can be related: <a href="https://github.com/juxt/yada/issues/324" target="_blank">https://github.com/juxt/yada/issues/324</a></z><z id="t1630614351" t="Ben Sless I&apos;ll give it a shot tomorrow, thanks for the hint!"><y>#</y><d>2021-09-02</d><h>20:25</h><r>Ben Sless</r>I&apos;ll give it a shot tomorrow, thanks for the hint!</z><z id="t1630669493" t="Ben Sless Still leaks memory"><y>#</y><d>2021-09-03</d><h>11:44</h><r>Ben Sless</r>Still leaks memory</z><z id="t1630671798" t="Matthew Davidson (kingmob) Zach just cut dirigiste 1.0.0, based off 0.1.6-alpha3. However, I don‚Äôt know who besides Zach can upload it to clojars. It‚Äôs not one of his repos that we added to clj-commons. Not sure if it fixes your issue, but fyi"><y>#</y><d>2021-09-03</d><h>12:23</h><r>Matthew Davidson (kingmob)</r>Zach just cut dirigiste 1.0.0, based off 0.1.6-alpha3. However, I don‚Äôt know who besides Zach can upload it to clojars. It‚Äôs not one of his repos that we added to clj-commons. Not sure if it fixes your issue, but fyi</z><z id="t1630672183" t="Ben Sless You can ping me when he releases it an I&apos;ll give it another try. In the meanwhile, I tried passing an executor both to the server and the wrapper which creates the original deferred value. No luck."><y>#</y><d>2021-09-03</d><h>12:29</h><r>Ben Sless</r>You can ping me when he releases it an I&apos;ll give it another try.
In the meanwhile, I tried passing an executor both to the server and the wrapper which creates the original deferred value. No luck.</z><z id="t1630686580" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UK0810AQ2&quot;}] My apologies, it‚Äôs available now. He released it to Maven Central, not clojars: https://search.maven.org/artifact/io.aleph/dirigiste/1.0.0/jar"><y>#</y><d>2021-09-03</d><h>16:29</h><r>Matthew Davidson (kingmob)</r><a>@ben.sless</a> My apologies, it‚Äôs available now. He released it to Maven Central, not clojars: <a href="https://search.maven.org/artifact/io.aleph/dirigiste/1.0.0/jar" target="_blank">https://search.maven.org/artifact/io.aleph/dirigiste/1.0.0/jar</a></z><z id="t1630691475" t="Ben Sless Nice. I&apos;ll probably be able to squeeze in a test in the next couple of hours"><y>#</y><d>2021-09-03</d><h>17:51</h><r>Ben Sless</r>Nice. I&apos;ll probably be able to squeeze in a test in the next couple of hours</z><z id="t1630694881" t="Ben Sless ugh, still broken. I&apos;m not going to hunt the cause down but if you need help reproducing it feel free to ping me"><y>#</y><d>2021-09-03</d><h>18:48</h><r>Ben Sless</r>ugh, still broken.
I&apos;m not going to hunt the cause down but if you need help reproducing it feel free to ping me</z><z id="t1630698763" t="Matthew Davidson (kingmob) Hmmm, ok."><y>#</y><d>2021-09-03</d><h>19:52</h><r>Matthew Davidson (kingmob)</r>Hmmm, ok.</z><z id="t1630751105" t="Ben Sless I&apos;m sorry if it sounds like I&apos;m abandoning it. It&apos;s just something I accidentally came across while benchmarking different servers. I don&apos;t use aleph and I don&apos;t think any of my colleagues do, either."><y>#</y><d>2021-09-04</d><h>10:25</h><r>Ben Sless</r>I&apos;m sorry if it sounds like I&apos;m abandoning it. It&apos;s just something I accidentally came across while benchmarking different servers. I don&apos;t use aleph and I don&apos;t think any of my colleagues do, either.</z><z id="t1630779028" t="Matthew Davidson (kingmob) Oh, no worries!"><y>#</y><d>2021-09-04</d><h>18:10</h><r>Matthew Davidson (kingmob)</r>Oh, no worries!</z><z id="t1631167791" t="Ben Sless update: Made some changes which should not be related and now the leak is gone"><y>#</y><d>2021-09-09</d><h>06:09</h><r>Ben Sless</r>update: Made some changes which should not be related and now the leak is gone</z><z id="t1631184367" t="Ben Sless I changed two things: ‚Ä¢ return byte array instead of input stream in muuntaja ‚Ä¢ did not inject match in reitit"><y>#</y><d>2021-09-09</d><h>10:46</h><r>Ben Sless</r>I changed two things:
‚Ä¢ return byte array instead of input stream in muuntaja
‚Ä¢ did not inject match in reitit</z><z id="t1648008252" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UK0810AQ2&quot;}] If you have the time/interest to check it out again, I think I have a fix for the memory leak with ByteArrayInputStreams: https://github.com/clj-commons/aleph/issues/523#issuecomment-1075429913"><y>#</y><d>2022-03-23</d><h>04:04</h><r>Matthew Davidson (kingmob)</r><a>@ben.sless</a> If you have the time/interest to check it out again, I think I have a fix for the memory leak with ByteArrayInputStreams: <a href="https://github.com/clj-commons/aleph/issues/523#issuecomment-1075429913" target="_blank">https://github.com/clj-commons/aleph/issues/523#issuecomment-1075429913</a></z><z id="t1648008456" t="Ben Sless Thank you for bringing this up, I intend to do another run this weekend üëç"><y>#</y><d>2022-03-23</d><h>04:07</h><r>Ben Sless</r>Thank you for bringing this up, I intend to do another run this weekend <b>üëç</b></z><z id="t1648008573" t="Matthew Davidson (kingmob) I need to push the branch up then‚Ä¶"><y>#</y><d>2022-03-23</d><h>04:09</h><r>Matthew Davidson (kingmob)</r>I need to push the branch up then‚Ä¶</z><z id="t1648008625" t="Matthew Davidson (kingmob) https://github.com/clj-commons/aleph/tree/bugfix/byte-array-input-stream-leak"><y>#</y><d>2022-03-23</d><h>04:10</h><r>Matthew Davidson (kingmob)</r><a href="https://github.com/clj-commons/aleph/tree/bugfix/byte-array-input-stream-leak" target="_blank">https://github.com/clj-commons/aleph/tree/bugfix/byte-array-input-stream-leak</a></z><z id="t1648008869" t="Ben Sless No pressure, worst case I can use a local install"><y>#</y><d>2022-03-23</d><h>04:14</h><r>Ben Sless</r>No pressure, worst case I can use a local install</z><z id="t1630570106" t="mccraigmccraig [:attrs {:href &quot;/_/_/users/UK0810AQ2&quot;}] i&apos;ve seen a leak issue with manifold and stream/transform - https://github.com/clj-commons/manifold/issues/197"><y>#</y><d>2021-09-02</d><h>08:08</h><w>mccraigmccraig</w><a>@ben.sless</a> i&apos;ve seen a leak issue with manifold and <code>stream/transform</code> - <a href="https://github.com/clj-commons/manifold/issues/197" target="_blank">https://github.com/clj-commons/manifold/issues/197</a></z><z id="t1630570759" t="Ben Sless not even sure if it&apos;s the same issue :thinking_face:"><y>#</y><d>2021-09-02</d><h>08:19</h><r>Ben Sless</r>not even sure if it&apos;s the same issue <b>:thinking_face:</b></z><z id="t1630570792" t="Ben Sless how can we find the cause?"><y>#</y><d>2021-09-02</d><h>08:19</h><r>Ben Sless</r>how can we find the cause?</z><z id="t1630571681" t="mccraigmccraig yeah, it might not be the same issue - this was quite specific to stream/transform . i played around in yourkit for a while - i could reliably duplicate the issue on our prod system, but never managed to get a minimal test-case, and in the end i ran out of time"><y>#</y><d>2021-09-02</d><h>08:34</h><r>mccraigmccraig</r>yeah, it might not be the same issue - this was quite specific to <code>stream/transform</code>. i played around in yourkit for a while - i could reliably duplicate the issue on our prod system, but never managed to get a minimal test-case, and in the end i ran out of time</z><z id="t1630785408" t="Matthew Davidson (kingmob) Manifold 0.1.9 is now out, boasting a long list of bug fixes and a few minor improvements. Many thanks to everyone involved. https://github.com/clj-commons/manifold/blob/master/CHANGES.md"><y>#</y><d>2021-09-04</d><h>19:56</h><w>Matthew Davidson (kingmob)</w>Manifold 0.1.9 is now out, boasting a long list of bug fixes and a few minor improvements. Many thanks to everyone involved. <a href="https://github.com/clj-commons/manifold/blob/master/CHANGES.md" target="_blank">https://github.com/clj-commons/manifold/blob/master/CHANGES.md</a></z><z id="t1634062756" t="sb I would like to create a client for websockify (clojure version). Exactly I saw every language have own solution.. without Clojure (eg. python, golang). Plus I would like to learn, how to manage TCP/websockets. I tested with python client and works well the websockify server. When I tested with my clojure code I get the raw html response via websocket server (coming from python simpleHTTPServer TCP &gt; websocket server): &quot;HTTP/1.0 200 OK\r Server: SimpleHTTP/0.6 Python/3.9.6\r Date: Mon, 11 Oct 2021 14:17:54 GMT\r Content-type: text/html\r Content-Length: 20\r Last-Modified: Fri, 08 Oct 2021 12:43:13 GMT\r \r Hello from Desktop! &quot; Ofc I can use this if I drop this response into 2 parts (headers/ body). My question is: is that possible todo better (like duplex) and use with Aleph/ Manifold (as Netty?), is there any example code, where I need to add the response into Aleph TCP server? or what is the easiest way to use raw html request response (via ws) in Aleph? Thanks!"><y>#</y><d>2021-10-12</d><h>18:19</h><w>sb</w>I would like to create a client for websockify (clojure version). Exactly I saw every language have own solution.. without Clojure (eg. python, golang). Plus I would like to learn, how to manage TCP/websockets. I tested with python client and works well the websockify server. When I tested with my clojure code I get the raw html response via websocket server (coming from python simpleHTTPServer TCP &gt; websocket server):
<pre>&quot;HTTP/1.0 200 OK\r
Server: SimpleHTTP/0.6 Python/3.9.6\r
Date: Mon, 11 Oct 2021 14:17:54 GMT\r
Content-type: text/html\r
Content-Length: 20\r
Last-Modified: Fri, 08 Oct 2021 12:43:13 GMT\r
\r
Hello from Desktop!
&quot;</pre>
Ofc I can use this if I drop this response into 2 parts (headers/ body). My question is: is that possible todo better (like duplex) and use with Aleph/ Manifold (as Netty?), is there any example code, where I need to add the response into Aleph TCP server? or what is the easiest way to use raw html request response (via ws) in Aleph? Thanks!</z><z id="t1634062814" t="sb So I would like to solve this route: browser website &gt; websocket client &lt;---------&gt; websocket server &lt; http server"><y>#</y><d>2021-10-12</d><h>18:20</h><w>sb</w>So I would like to solve this route:  browser website &gt; websocket client &lt;---------&gt; websocket server &lt; http server</z><z id="t1634062849" t="sb That is the goal."><y>#</y><d>2021-10-12</d><h>18:20</h><w>sb</w>That is the goal.</z><z id="t1634126652" t="valerauko Does this help? https://aleph.io/examples/literate.html#aleph.examples.websocket"><y>#</y><d>2021-10-13</d><h>12:04</h><w>valerauko</w>Does this help? <a href="https://aleph.io/examples/literate.html#aleph.examples.websocket" target="_blank">https://aleph.io/examples/literate.html#aleph.examples.websocket</a></z><z id="t1634159430" t="Matthew Davidson (kingmob) Hi, everyone. [:attrs {:href &quot;/_/_/users/U236LQYB0&quot;}] and the Yummly team have done some amazing work, and we‚Äôre almost done backporting their equivalent of core.async‚Äôs go macro to Manifold. It works with deferreds and streams, and includes the widespread &lt;!? macro that rethrows errors after getting one. I have a question for everyone. Since it reuses core.async‚Äôs IOC state machine code, core.async itself is a dependency to make this new code work. If you use Manifold, would you prefer: 1. core.async become a dependency of Manifold, or 2. We use conditional compilation to only include the code if core.async is available Please reply in a thread. (I also considered extracting the fns we need from core.async, but I believe the EPL 1.0 license forbids that. http://www.eclipse.org/legal/epl-2.0/faq.php#h.5ucozq4kvv7o ) I‚Äôm moving for the next few days, but I‚Äôll be back next week."><y>#</y><d>2021-10-13</d><h>21:10</h><w>Matthew Davidson (kingmob)</w>Hi, everyone. <a>@tanzoniteblack</a> and the Yummly team have done some amazing work, and we‚Äôre almost done backporting their equivalent of core.async‚Äôs <code>go</code> macro to Manifold. It works with deferreds and streams, and includes the widespread &lt;!? macro that rethrows errors after getting one.

I have a question for everyone. Since it reuses core.async‚Äôs IOC state machine code, core.async itself is a dependency to make this new code work. If you use Manifold, would you prefer:
1. core.async become a dependency of Manifold, or
2. We use conditional compilation to only include the code if core.async is available
Please reply in a thread.

(I also considered extracting the fns we need from core.async, but I believe the EPL 1.0 license forbids that. <a href="http://www.eclipse.org/legal/epl-2.0/faq.php#h.5ucozq4kvv7o" target="_blank">http://www.eclipse.org/legal/epl-2.0/faq.php#h.5ucozq4kvv7o</a> )

I‚Äôm moving for the next few days, but I‚Äôll be back next week.</z><z id="t1634180969" t="valerauko I&apos;d go with 2."><y>#</y><d>2021-10-14</d><h>03:09</h><r>valerauko</r>I&apos;d go with 2.</z><z id="t1634199088" t="mccraigmccraig i have a vague preference for [2], but i would lose no sleep whatsoever were it much simpler to just go with [1]"><y>#</y><d>2021-10-14</d><h>08:11</h><r>mccraigmccraig</r>i have a vague preference for [2], but i would lose no sleep whatsoever were it much simpler to just go with [1]</z><z id="t1634232102" t="tanzoniteblack https://clojurians.slack.com/archives/C02H9GF74CF/p1634232066000100?thread_ts=1634162283.002000&amp;amp;cid=C02H9GF74CF I put this in the #manifold thread on the same topic..but now see only on here is there active discussion"><y>#</y><d>2021-10-14</d><h>17:21</h><r>tanzoniteblack</r><a href="https://clojurians.slack.com/archives/C02H9GF74CF/p1634232066000100?thread_ts=1634162283.002000&amp;amp;cid=C02H9GF74CF" target="_blank">https://clojurians.slack.com/archives/C02H9GF74CF/p1634232066000100?thread_ts=1634162283.002000&amp;amp;cid=C02H9GF74CF</a>

I put this in the #manifold thread on the same topic..but now see only on here is there active discussion</z><z id="t1634232163" t="mccraigmccraig ha, i hadn&apos;t noticed that there was a #manifold channel!"><y>#</y><d>2021-10-14</d><h>17:22</h><r>mccraigmccraig</r>ha, i hadn&apos;t noticed that there was a #manifold channel!</z><z id="t1634232196" t="tanzoniteblack Matthew appears to have created it yesterday explicitly to have this talk üòÜ"><y>#</y><d>2021-10-14</d><h>17:23</h><r>tanzoniteblack</r>Matthew appears to have created it yesterday explicitly to have this talk <b>üòÜ</b></z><z id="t1634247118" t="Matthew Davidson (kingmob) I always thought manifold should get its own channel and figured now was as good a time as any üòÅ"><y>#</y><d>2021-10-14</d><h>21:31</h><r>Matthew Davidson (kingmob)</r>I always thought manifold should get its own channel and figured now was as good a time as any <b>üòÅ</b></z><z id="t1635419085" t="Shantanu Kumar Hi, is Aleph (as of 0.4.6) supported to run on Java 11 or higher?"><y>#</y><d>2021-10-28</d><h>11:04</h><w>Shantanu Kumar</w>Hi, is Aleph (as of 0.4.6) supported to run on Java 11 or higher?</z><z id="t1635422763" t="thom Works for me in Java 16 and 17 (the TCP and HTTP bits at least)."><y>#</y><d>2021-10-28</d><h>12:06</h><r>thom</r>Works for me in Java 16 and 17 (the TCP and HTTP bits at least).</z><z id="t1635427630" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U066J7E2U&quot;}] Are you seeing an issue, or asking in general?"><y>#</y><d>2021-10-28</d><h>13:27</h><r>Matthew Davidson (kingmob)</r><a>@U066J7E2U</a> Are you seeing an issue, or asking in general?</z><z id="t1635427964" t="Shantanu Kumar Just asking in general, [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] - I have tried out Aleph with Java 11 and 17, which works."><y>#</y><d>2021-10-28</d><h>13:32</h><r>Shantanu Kumar</r>Just asking in general, <a>@U10EC98F5</a> - I have tried out Aleph with Java 11 and 17, which works.</z><z id="t1635510118" t="Shantanu Kumar I tried out benchmarking Aleph (among other servers) using https://github.com/BrunoBonacci/clojure-http-servers-benchmark but it fails for Aleph on Java 11 and 17. I had to add the following dependencies (beside bumping aleph up to version 0.4.6 ) to get past the uberjar&apos;ing error: [javax.xml.bind/jaxb-api &quot;2.3.0&quot;] [org.eclipse.persistence/eclipselink &quot;2.7.0&quot;]"><y>#</y><d>2021-10-29</d><h>12:21</h><w>Shantanu Kumar</w>I tried out benchmarking Aleph (among other servers) using <a href="https://github.com/BrunoBonacci/clojure-http-servers-benchmark" target="_blank">https://github.com/BrunoBonacci/clojure-http-servers-benchmark</a> but it fails for Aleph on Java 11 and 17. I had to add the following dependencies (beside bumping aleph up to version <code>0.4.6</code>) to get past the uberjar&apos;ing error:
<pre>[javax.xml.bind/jaxb-api &quot;2.3.0&quot;]
[org.eclipse.persistence/eclipselink &quot;2.7.0&quot;]</pre></z><z id="t1635510404" t="Shantanu Kumar I have filed two issues (one of them is closed now) in the repo, where you can see more details."><y>#</y><d>2021-10-29</d><h>12:26</h><r>Shantanu Kumar</r>I have filed two issues (one of them is closed now) in the repo, where you can see more details.</z><z id="t1635617924" t="Matthew Davidson (kingmob) Thanks, [:attrs {:href &quot;/_/_/users/U066J7E2U&quot;}] , The clojure-http-servers-benchmark repo isn‚Äôt ours, so I can‚Äôt update it. That being said, I know tests fail on JDK 17 due to some BouncyCastle self-signed cert error."><y>#</y><d>2021-10-30</d><h>18:18</h><r>Matthew Davidson (kingmob)</r>Thanks, <a>@U066J7E2U</a>, The clojure-http-servers-benchmark repo isn‚Äôt ours, so I can‚Äôt update it.

That being said, I know tests fail on JDK 17 due to some BouncyCastle self-signed cert error.</z><z id="t1635617945" t="Matthew Davidson (kingmob) aleph 0.4.7-alpha10 is out. This includes fixes for WS upgrade requests in Firefox, DNS improvements, an upgrade to Netty 4.1.64, and an upgrade to byte-streams 0.2.10. https://github.com/clj-commons/aleph"><y>#</y><d>2021-10-30</d><h>18:19</h><w>Matthew Davidson (kingmob)</w>aleph 0.4.7-alpha10 is out. This includes fixes for WS upgrade requests in Firefox, DNS improvements, an upgrade to Netty 4.1.64, and an upgrade to byte-streams 0.2.10.
<a href="https://github.com/clj-commons/aleph" target="_blank">https://github.com/clj-commons/aleph</a></z><z id="t1635618274" t="Matthew Davidson (kingmob) Also, byte-streams 0.2.10 is out. This release removes the old use of clj-tuple, which was causing issues on more recent JVM versions. https://github.com/clj-commons/byte-streams"><y>#</y><d>2021-10-30</d><h>18:24</h><w>Matthew Davidson (kingmob)</w>Also, <code>byte-streams 0.2.10</code> is out. This release removes the old use of clj-tuple, which was causing issues on more recent JVM versions.
<a href="https://github.com/clj-commons/byte-streams" target="_blank">https://github.com/clj-commons/byte-streams</a></z><z id="t1635676153" t="thom Love seeing Aleph et al moving again, great work [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] !"><y>#</y><d>2021-10-31</d><h>10:29</h><w>thom</w>Love seeing Aleph et al moving again, great work <a>@kingmob</a>!</z><z id="t1635676287" t="thom Does anyone know if there are any plans for Gloss to get adopted under the clj-commons umbrella, or what the process is to help that happen?"><y>#</y><d>2021-10-31</d><h>10:31</h><w>thom</w>Does anyone know if there are any plans for Gloss to get adopted under the clj-commons umbrella, or what the process is to help that happen?</z><z id="t1635688709" t="Matthew Davidson (kingmob) Thanks [:attrs {:href &quot;/_/_/users/UTF99QP7V&quot;}] , just trying to help. I could use some assistance from people who know Netty, though. There aren‚Äôt any plans for Gloss, afaik. Best bet is to reach out to Erik (slipset) to see what would be involved. Do you have some changes or bugfixes you want to see added?"><y>#</y><d>2021-10-31</d><h>13:58</h><w>Matthew Davidson (kingmob)</w>Thanks <a>@thom704</a>, just trying to help. I could use some assistance from people who know Netty, though.

There aren‚Äôt any plans for Gloss, afaik. Best bet is to reach out to Erik (slipset) to see what would be involved.  Do you have some changes or bugfixes you want to see added?</z><z id="t1637641254" t="valerauko are there issues around netty?"><y>#</y><d>2021-11-23</d><h>04:20</h><r>valerauko</r>are there issues around netty?</z><z id="t1638556279" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Some bug fixes are needed, but mostly Aleph needs updating to the latest netty it‚Äôs a bit behind"><y>#</y><d>2021-12-03</d><h>18:31</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> Some bug fixes are needed, but mostly Aleph needs updating to the latest netty it‚Äôs a bit behind</z><z id="t1638604019" t="valerauko I can help with that. Where do you manage issues like that?"><y>#</y><d>2021-12-04</d><h>07:46</h><r>valerauko</r>I can help with that. Where do you manage issues like that?</z><z id="t1638822191" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Mostly in GitHub. I‚Äôm away and don‚Äôt recall if there‚Äôs a particular story, but we need to build Aleph with the latest netty and make sure it all works. Then we can consider taking advantage of any new features if there some worth using"><y>#</y><d>2021-12-06</d><h>20:23</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> Mostly in GitHub. I‚Äôm away and don‚Äôt recall if there‚Äôs a particular story, but we need to build Aleph with the latest netty and make sure it all works. Then we can consider taking advantage of any new features if there some worth using</z><z id="t1638825951" t="valerauko All right gonna look through it and see if there&apos;s anythign i can help with"><y>#</y><d>2021-12-06</d><h>21:25</h><r>valerauko</r>All right gonna look through it and see if there&apos;s anythign i can help with</z><z id="t1636713718" t="Matthew Davidson (kingmob) Is anyone here using Manifold with Graal? I have a few questions‚Ä¶"><y>#</y><d>2021-11-12</d><h>10:41</h><w>Matthew Davidson (kingmob)</w>Is anyone here using Manifold with Graal? I have a few questions‚Ä¶</z><z id="t1637185648" t="FiVo I want to test something against a local proxy: (require &apos;[aleph.http :as aleph] &apos;[manifold.deferred :as d]) (def aleph-pool (aleph/connection-pool {:connection-options {:proxy-options {:host &quot;localhost&quot; :port 8080}}})) (d/on-realized (aleph/get url {:pool aleph-pool}) (fn [r] (println &quot;Status: &quot; (:status r))) (fn [e] (println &quot;Error type: &quot; (type e)))) but I am running into io.netty.handler.ssl.NotSslRecordException whenever I request a https site. Can I somehow circumvent this on the client side or do I need to fix the ssl certificates for my proxy server? I am not having this issue with other clients like http-kit ."><y>#</y><d>2021-11-17</d><h>21:47</h><w>FiVo</w>I want to test something against a local proxy:
<pre>(require &apos;[aleph.http :as aleph]
         &apos;[manifold.deferred :as d])

(def aleph-pool (aleph/connection-pool {:connection-options
                                        {:proxy-options {:host &quot;localhost&quot;
                                                         :port 8080}}}))

(d/on-realized (aleph/get url {:pool aleph-pool})
               (fn [r] (println &quot;Status: &quot; (:status r)))
               (fn [e] (println &quot;Error type: &quot; (type e))))</pre>
but I am running into <code>io.netty.handler.ssl.NotSslRecordException</code> whenever I request a <code>https</code>  site. Can I somehow circumvent this on the client side or do I need to fix the ssl certificates for my proxy server? I am not having this issue with other clients like <code>http-kit</code>.</z><z id="t1637586689" t="Matthew Davidson (kingmob) Hmm, this sounds like a bug I saw recently‚Ä¶"><y>#</y><d>2021-11-22</d><h>13:11</h><r>Matthew Davidson (kingmob)</r>Hmm, this sounds like a bug I saw recently‚Ä¶</z><z id="t1637587053" t="Matthew Davidson (kingmob) Nm, that was for tests, I doubt it would apply here. [:attrs {:href &quot;/_/_/users/UL638RXE2&quot;}] I would try setting up a valid local TLS cert if you can."><y>#</y><d>2021-11-22</d><h>13:17</h><r>Matthew Davidson (kingmob)</r>Nm, that was for tests, I doubt it would apply here.

<a>@UL638RXE2</a> I would try setting up a valid local TLS cert if you can.</z><z id="t1637591815" t="FiVo Yes, probably the best approach. Also realized that only http-kit has no issues with the proxy."><y>#</y><d>2021-11-22</d><h>14:36</h><r>FiVo</r>Yes, probably the best approach. Also realized that only <code>http-kit</code> has no issues with the proxy.</z><z id="t1638142458" t="frozenlock Hello! Is there a way to increase the maximum size of requests in Aleph http sever? In http-kit one can provide :max-body and :max-line when starting the server. (server/run-server #&apos;handler/app {:port (Integer. port) :max-body 52428800 :max-line 1048576}) "><y>#</y><d>2021-11-28</d><h>23:34</h><w>frozenlock</w>Hello! Is there a way to increase the maximum size of requests in Aleph http sever?
In <code>http-kit</code> one can provide <code>:max-body</code> and <code>:max-line</code> when starting the server.

<pre>(server/run-server #&apos;handler/app {:port     (Integer. port)
                                  :max-body 52428800
                                  :max-line 1048576})</pre>
</z><z id="t1638172123" t="FiVo https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L475-L477"><y>#</y><d>2021-11-29</d><h>07:48</h><r>FiVo</r><a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L475-L477" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L475-L477</a></z><z id="t1638172160" t="FiVo https://netty.io/4.1/api/io/netty/handler/codec/http/HttpRequestDecoder.html"><y>#</y><d>2021-11-29</d><h>07:49</h><r>FiVo</r><a href="https://netty.io/4.1/api/io/netty/handler/codec/http/HttpRequestDecoder.html" target="_blank">https://netty.io/4.1/api/io/netty/handler/codec/http/HttpRequestDecoder.html</a></z><z id="t1638204861" t="frozenlock Thanks!"><y>#</y><d>2021-11-29</d><h>16:54</h><r>frozenlock</r>Thanks!</z><z id="t1638814777" t="Matthew Davidson (kingmob)"><y>#</y><d>2021-12-06</d><h>18:19</h><w>Matthew Davidson (kingmob)</w></z><z id="t1639394802" t="Matthew Davidson (kingmob) In case is anyone is wondering, AFAICT, Aleph isn‚Äôt at risk of CVE-2021-44228: https://github.com/clj-commons/aleph/issues/576 ."><y>#</y><d>2021-12-13</d><h>11:26</h><w>Matthew Davidson (kingmob)</w>In case is anyone is wondering, AFAICT, Aleph isn‚Äôt at risk of CVE-2021-44228: <a href="https://github.com/clj-commons/aleph/issues/576" target="_blank">https://github.com/clj-commons/aleph/issues/576</a>.</z><z id="t1639797431" t="mafcocinco beginner question about using manifold.stream/connect with a aleph.http/websocket-connection . Here is a handler function I wrote to try to get the hang of things and push some primitive data through a websocket"><y>#</y><d>2021-12-18</d><h>03:17</h><w>mafcocinco</w>beginner question about using <code>manifold.stream/connect</code> with a <code>aleph.http/websocket-connection</code>.  Here is a handler function I wrote to try to get the hang of things and push some primitive data through a websocket</z><z id="t1639797500" t="mafcocinco state* is an atom . I‚Äôm trying to just create a stream that I can push data to and read from the connection object."><y>#</y><d>2021-12-18</d><h>03:18</h><w>mafcocinco</w><code>state*</code> is an <code>atom</code>.  I‚Äôm trying to just create a stream that I can push data to and read from the connection object.</z><z id="t1640109977" t="Matthew Davidson (kingmob) Hi [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] . I‚Äôd be happy to help, but I need a few more details. A minimal, but full, example would help. For starters, are you passing the handler fn directly into start-server as is? Because Aleph handlers only accept a single request parameter, but your handler takes two."><y>#</y><d>2021-12-21</d><h>18:06</h><r>Matthew Davidson (kingmob)</r>Hi <a>@mafcocinco</a>. I‚Äôd be happy to help, but I need a few more details. A minimal, but full, example would help.

For starters, are you passing the <code>handler</code> fn directly into <code>start-server</code> as is? Because Aleph handlers only accept a single request parameter, but your handler takes two.</z><z id="t1640110157" t="mafcocinco Cool. I‚Äôll get you a full example."><y>#</y><d>2021-12-21</d><h>18:09</h><r>mafcocinco</r>Cool.  I‚Äôll get you a full example.</z><z id="t1640111717" t="mafcocinco This could probably be slightly simpler but hopefully gives the general idea of what I‚Äôm trying to accomplish"><y>#</y><d>2021-12-21</d><h>18:35</h><r>mafcocinco</r>This could probably be slightly simpler but hopefully gives the general idea of what I‚Äôm trying to accomplish</z><z id="t1640112470" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] And is the commented code what you‚Äôre running to test it, when you get the error? (For future reference, you probably want to put all that in a (comment ....) block for ease of REPLing)"><y>#</y><d>2021-12-21</d><h>18:47</h><r>Matthew Davidson (kingmob)</r><a>@mafcocinco</a> And is the commented code what you‚Äôre running to test it, when you get the error?

(For future reference, you probably want to put all that in a <code>(comment ....)</code> block for ease of REPLing)</z><z id="t1640115324" t="mafcocinco yes, it is. And thanks, I will use comment going forward."><y>#</y><d>2021-12-21</d><h>19:35</h><r>mafcocinco</r>yes, it is.  And thanks, I will use <code>comment</code> going forward.</z><z id="t1640115412" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] Hey, can you run your minimal example and verify that it shows the error you expect? There‚Äôs several things going wrong that aren‚Äôt what you initially described üôÇ 1. ring.util.http-response isn‚Äôt a ring namespace. 2. I‚Äôm getting `SEVERE: cannot coerce clojure.lang.PersistentArrayMap into binary representation java.lang.IllegalArgumentException: Don‚Äôt know how to convert class clojure.lang.PersistentArrayMap into class java.nio.ByteBuffer` when I try to put into the core.async channel, which is a totally different error 1. Why did you add core.async? Manifold‚Äôs s/put , which you described using earlier, is correct. You can use it to write directly to the stream in state*"><y>#</y><d>2021-12-21</d><h>19:36</h><r>Matthew Davidson (kingmob)</r><a>@mafcocinco</a> Hey, can you run your minimal example and verify that it shows the error you expect? There‚Äôs several things going wrong that aren‚Äôt what you initially described <b>üôÇ</b>

1. <code>ring.util.http-response</code> isn‚Äôt a ring namespace.
2. I‚Äôm getting `SEVERE: cannot coerce clojure.lang.PersistentArrayMap into binary representation
java.lang.IllegalArgumentException: Don‚Äôt know how to convert class clojure.lang.PersistentArrayMap into class java.nio.ByteBuffer` when I try to put into the core.async channel, which is a totally different error
1. Why did you add core.async? Manifold‚Äôs <code>s/put</code>, which you described using earlier, is correct. You can use it to write directly to the stream in state*</z><z id="t1640115710" t="mafcocinco Let me revise."><y>#</y><d>2021-12-21</d><h>19:41</h><r>mafcocinco</r>Let me revise.</z><z id="t1640115925" t="mafcocinco ring.util.http-response is part of a metosin library. That should be easy to remove"><y>#</y><d>2021-12-21</d><h>19:45</h><r>mafcocinco</r><code>ring.util.http-response</code> is part of a  <code>metosin</code> library.  That should be easy to remove</z><z id="t1640116009" t="Matthew Davidson (kingmob) Cool. Can you also remove the worker thread relaying from core.async to the websocket stream? I think we need to simplify this a bit"><y>#</y><d>2021-12-21</d><h>19:46</h><r>Matthew Davidson (kingmob)</r>Cool. Can you also remove the worker thread relaying from core.async to the websocket stream? I think we need to simplify this a bit</z><z id="t1640116042" t="Matthew Davidson (kingmob) Also, have you run the websocket examples in https://aleph.io/aleph/literate.html#aleph.examples.websocket ? Did they work ok?"><y>#</y><d>2021-12-21</d><h>19:47</h><r>Matthew Davidson (kingmob)</r>Also, have you run the websocket examples in <a href="https://aleph.io/aleph/literate.html#aleph.examples.websocket" target="_blank">https://aleph.io/aleph/literate.html#aleph.examples.websocket</a> ? Did they work ok?</z><z id="t1640116059" t="mafcocinco yes, the examples worked for me."><y>#</y><d>2021-12-21</d><h>19:47</h><r>mafcocinco</r>yes, the examples worked for me.</z><z id="t1640116210" t="mafcocinco"><y>#</y><d>2021-12-21</d><h>19:50</h><r>mafcocinco</r></z><z id="t1640116257" t="mafcocinco the s/put! returns true but the s/take! from conn returns nil"><y>#</y><d>2021-12-21</d><h>19:50</h><r>mafcocinco</r>the <code>s/put!</code> returns <code>true</code> but the <code>s/take!</code> from <code>conn</code> returns <code>nil</code></z><z id="t1640116800" t="Matthew Davidson (kingmob) OK, let me take another look. Which version of aleph are you on, btw?"><y>#</y><d>2021-12-21</d><h>20:00</h><r>Matthew Davidson (kingmob)</r>OK, let me take another look. Which version of aleph are you on, btw?</z><z id="t1640165459" t="Matthew Davidson (kingmob) ^^^ [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] Which Aleph version (and other dep versions) are you using?"><y>#</y><d>2021-12-22</d><h>09:30</h><r>Matthew Davidson (kingmob)</r>^^^ <a>@mafcocinco</a> Which Aleph version (and other dep versions) are you using?</z><z id="t1640544377" t="mafcocinco aleph 0.4.6 , reitit vesion 0.4.2"><y>#</y><d>2022-12-26</d><h>18:46</h><r>mafcocinco</r>aleph <code>0.4.6</code>, reitit vesion <code>0.4.2</code></z><z id="t1640544514" t="mafcocinco sorry for the delay, out on holiday break"><y>#</y><d>2022-12-26</d><h>18:48</h><r>mafcocinco</r>sorry for the delay, out on holiday break</z><z id="t1640603977" t="Matthew Davidson (kingmob) Thanks [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] I‚Äôll take a look later"><y>#</y><d>2022-12-27</d><h>11:19</h><r>Matthew Davidson (kingmob)</r>Thanks <a>@mafcocinco</a> I‚Äôll take a look later</z><z id="t1640975340" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] I took another look, and your problem is due to making the websocket handler fn Ring-compatible. Websockets don‚Äôt transmit HTTP, and thus, aren‚Äôt turned into Ring request maps. If you check the spec ( https://datatracker.ietf.org/doc/html/rfc6455#page-38 ), you‚Äôll see Websockets transmit either binary data or UTF-8 text frames (plus some control frames you don‚Äôt care about). I ran a few tests to refresh my memory, and you can put strings on a websocket, or anything byte-streams can convert to a byte array. On the receiving side, it looks like you get either strings or plain byte arrays."><y>#</y><d>2022-12-31</d><h>18:29</h><r>Matthew Davidson (kingmob)</r><a>@mafcocinco</a> I took another look, and your problem is due to making the websocket handler fn Ring-compatible. Websockets don‚Äôt transmit HTTP, and thus, aren‚Äôt turned into Ring request maps.

If you check the spec (<a href="https://datatracker.ietf.org/doc/html/rfc6455#page-38" target="_blank">https://datatracker.ietf.org/doc/html/rfc6455#page-38</a>), you‚Äôll see Websockets transmit either binary data or UTF-8 text frames (plus some control frames you don‚Äôt care about).

I ran a few tests to refresh my memory, and you can put strings on a websocket, or anything byte-streams can convert to a byte array. On the receiving side, it looks like you get either strings or plain byte arrays.</z><z id="t1641397219" t="mafcocinco I understand conceptually what you are saying but not sure how to implement it. Would that basically mean not calling (ring/ring-handler default) for any websocket routes? E.g. passing the result of (ring/router) directly to (http/start-server ‚Ä¶) ?"><y>#</y><d>2022-01-05</d><h>15:40</h><r>mafcocinco</r>I understand conceptually what you are saying but not sure how to implement it.  Would that basically mean not calling <code>(ring/ring-handler default)</code> for any websocket routes?  E.g. passing the result of <code>(ring/router)</code> directly to <code>(http/start-server ‚Ä¶)</code>?</z><z id="t1641677284" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] I think so. And you may or may not be able to use ring/router either, if it tries to transform data. You want something that directly routes data to the handler, with no attempt to interpret the data as HTTP at all, invoke middlewares, etc. After the initial handshake, WebSockets ditches HTTP and is much lower-level, more like TCP sockets. Ring and HTTP don‚Äôt apply. Maybe try reitit‚Äôs default, non-ring router."><y>#</y><d>2022-01-08</d><h>21:28</h><r>Matthew Davidson (kingmob)</r><a>@mafcocinco</a> I think so. And you may or may not be able to use <code>ring/router</code> either, if it tries to transform data. You want something that directly routes data to the handler, with no attempt to interpret the data as HTTP at all, invoke middlewares, etc.

After the initial handshake, WebSockets ditches HTTP and is much lower-level, more like TCP sockets. Ring and HTTP don‚Äôt apply. Maybe try reitit‚Äôs default, non-ring router.</z><z id="t1641824466" t="mafcocinco I‚Äôll give that a try. Thank you for your help!"><y>#</y><d>2022-01-10</d><h>14:21</h><r>mafcocinco</r>I‚Äôll give that a try.  Thank you for your help!</z><z id="t1639797657" t="mafcocinco I create start up the server (similar to what is shown in the https://aleph.io/examples/literate.html#aleph.examples.websocket ), create the connection object by calling the handler (i.e. ). I then try to push data by pulling the stream object out of the atom and call (s/put! stream {:a 42}) . That appears to work successfully but when I try to retrieve the data with (s/take! conn) via the websocket connection, I get nil ."><y>#</y><d>2021-12-18</d><h>03:20</h><w>mafcocinco</w>I create start up the server (similar to what is shown in the <a href="https://aleph.io/examples/literate.html#aleph.examples.websocket" target="_blank">https://aleph.io/examples/literate.html#aleph.examples.websocket</a>), create the connection object by calling the handler (i.e. <code></code>).  I then try to push data by pulling the <code>stream</code> object out of the atom and call <code>(s/put! stream {:a 42})</code>.  That appears to work successfully but when I try to retrieve the data with <code>(s/take! conn)</code> via the websocket connection, I get <code>nil</code>.</z><z id="t1640975340" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U6SN41SJC&quot;}] I took another look, and your problem is due to making the websocket handler fn Ring-compatible. Websockets don‚Äôt transmit HTTP, and thus, aren‚Äôt turned into Ring request maps. If you check the spec ( https://datatracker.ietf.org/doc/html/rfc6455#page-38 ), you‚Äôll see Websockets transmit either binary data or UTF-8 text frames (plus some control frames you don‚Äôt care about). I ran a few tests to refresh my memory, and you can put strings on a websocket, or anything byte-streams can convert to a byte array. On the receiving side, it looks like you get either strings or plain byte arrays."><y>#</y><d>2022-12-31</d><h>18:29</h><w>Matthew Davidson (kingmob)</w><a>@mafcocinco</a> I took another look, and your problem is due to making the websocket handler fn Ring-compatible. Websockets don‚Äôt transmit HTTP, and thus, aren‚Äôt turned into Ring request maps.

If you check the spec (<a href="https://datatracker.ietf.org/doc/html/rfc6455#page-38" target="_blank">https://datatracker.ietf.org/doc/html/rfc6455#page-38</a>), you‚Äôll see Websockets transmit either binary data or UTF-8 text frames (plus some control frames you don‚Äôt care about).

I ran a few tests to refresh my memory, and you can put strings on a websocket, or anything byte-streams can convert to a byte array. On the receiving side, it looks like you get either strings or plain byte arrays.</z><z id="t1641253399" t="chucklehead I spent quite a while this weekend trying to replicate the aleph.tcp echo example with a different protocol and failing miserably. It was my first attempt at a server in Clojure, so I initially assumed I was doing something wrong with aleph or manifold, but finally tracked it down to a reflection/type-hinting issue with Gloss. Since it&apos;s archived, I forked it to make a git dependency I could use. In case it&apos;s useful to anyone else it&apos;s available here: https://github.com/casselc/gloss The only changes are a handful of type hints, updated the dependencies to the latest versions, and converted from lein to deps/tools.build."><y>#</y><d>2022-01-03</d><h>23:43</h><w>chucklehead</w>I spent quite a while this weekend trying to replicate the aleph.tcp echo example with a different protocol and failing miserably. It was my first attempt at a server in Clojure, so I initially assumed I was doing something wrong with aleph or manifold, but finally tracked it down to a reflection/type-hinting issue with Gloss.

Since it&apos;s archived, I forked it to make a git dependency I could use. In case it&apos;s useful to anyone else it&apos;s available here:
<a href="https://github.com/casselc/gloss" target="_blank">https://github.com/casselc/gloss</a>

The only changes are a handful of type hints, updated the dependencies to the latest versions, and converted from lein to deps/tools.build.</z><z id="t1641253755" t="chucklehead the specific issue I was having was that the Gloss codec would decode buf sequences but not the same data as a single contiguous buffer"><y>#</y><d>2022-01-03</d><h>23:49</h><w>chucklehead</w>the specific issue I was having was that the Gloss codec would decode buf sequences but not the same data as a single contiguous buffer</z><z id="t1641312863" t="Matthew Davidson (kingmob) Heh, ironically, I ran into those same reflection errors in Gloss a while back. Maybe we should try to place it under the clj-commons banner with the rest of Zach‚Äôs old libs? [:attrs {:href &quot;/_/_/users/U015879P2F8&quot;}] Do you want to step up and do it?"><y>#</y><d>2022-01-04</d><h>16:14</h><w>Matthew Davidson (kingmob)</w>Heh, ironically, I ran into those same reflection errors in Gloss a while back. Maybe we should try to place it under the clj-commons banner with the rest of Zach‚Äôs old libs?

<a>@chuck.cassel</a> Do you want to step up and do it?</z><z id="t1641354829" t="chucklehead not sure I&apos;m entirely qualified - still pretty inexperienced with gloss and Clojure in general - but I guess I&apos;d be willing to give it a shot"><y>#</y><d>2022-01-05</d><h>03:53</h><w>chucklehead</w>not sure I&apos;m entirely qualified - still pretty inexperienced with gloss and Clojure in general - but I guess I&apos;d be willing to give it a shot</z><z id="t1641463538" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U015879P2F8&quot;}] What‚Äôs your github username?"><y>#</y><d>2022-01-06</d><h>10:05</h><w>Matthew Davidson (kingmob)</w><a>@chuck.cassel</a> What‚Äôs your github username?</z><z id="t1641518170" t="chucklehead casselc"><y>#</y><d>2022-01-07</d><h>01:16</h><r>chucklehead</r>casselc</z><z id="t1645813639" t="mattyulrich Hi all - I&apos;m using aleph 0.4.6 to create websocket client connections (using aleph/websocket-client ). When I connect to a locally running server, all of my writes and reads are good. But when I connect to a remote server, after certain writes (consistently reproducible), the connection just closes seemingly from the client side. Is there any way I can get some debug information around the connection to try and understand why it is disconnecting?"><y>#</y><d>2022-02-25</d><h>18:27</h><w>mattyulrich</w>Hi all - I&apos;m using aleph 0.4.6 to create websocket client connections (using <code>aleph/websocket-client</code>).  When I connect to a locally running server, all of my writes and reads are good.  But when I connect to a remote server, after certain writes (consistently reproducible), the connection just closes seemingly from the client side.  Is there any way I can get some debug information around the connection to try and understand why it is disconnecting?</z><z id="t1645813743" t="hiredman reproducible how? you write the same data and it disconnects? it disconnects after the same amount of time?"><y>#</y><d>2022-02-25</d><h>18:29</h><r>hiredman</r>reproducible how? you write the same data and it disconnects? it disconnects after the same amount of time?</z><z id="t1645813914" t="hiredman a good first step would be to make sure the client and server are the only things involved, if you have some kind of load balancer / proxy in the middle somewhere, try with a direct connection"><y>#</y><d>2022-02-25</d><h>18:31</h><r>hiredman</r>a good first step would be to make sure the client and server are the only things involved, if you have some kind of load balancer / proxy in the middle somewhere, try with a direct connection</z><z id="t1645813935" t="mattyulrich Yes - there is a load balancer."><y>#</y><d>2022-02-25</d><h>18:32</h><r>mattyulrich</r>Yes - there is a load balancer.</z><z id="t1645813939" t="mattyulrich I&apos;ll try with a direct connection."><y>#</y><d>2022-02-25</d><h>18:32</h><r>mattyulrich</r>I&apos;ll try with a direct connection.</z><z id="t1645813962" t="mattyulrich Reproducible meaning the same write always yields disconnect, multiple other writes work fine."><y>#</y><d>2022-02-25</d><h>18:32</h><r>mattyulrich</r>Reproducible meaning the same write always yields disconnect, multiple other writes work fine.</z><z id="t1645813975" t="mattyulrich It may be on the server... actually - investigating further."><y>#</y><d>2022-02-25</d><h>18:32</h><r>mattyulrich</r>It may be on the server... actually - investigating further.</z><z id="t1645814005" t="mattyulrich But is there a way that I can see more about the connection on the client short of sniffing the traffic?"><y>#</y><d>2022-02-25</d><h>18:33</h><r>mattyulrich</r>But is there a way that I can see more about the connection on the client short of sniffing the traffic?</z><z id="t1645814010" t="hiredman you maybe exceeding some max frame size thing"><y>#</y><d>2022-02-25</d><h>18:33</h><r>hiredman</r>you maybe exceeding some max frame size thing</z><z id="t1645814029" t="mattyulrich Yeah - I think that&apos;s what&apos;s happening - I&apos;m getting a large payload when I connect using a python client."><y>#</y><d>2022-02-25</d><h>18:33</h><r>mattyulrich</r>Yeah - I think that&apos;s what&apos;s happening - I&apos;m getting a large payload when I connect using a python client.</z><z id="t1645814051" t="hiredman ah, it is a write from the server that is killing it?"><y>#</y><d>2022-02-25</d><h>18:34</h><r>hiredman</r>ah, it is a write from the server that is killing it?</z><z id="t1645814052" t="mattyulrich Are there settings for this on the aleph side?"><y>#</y><d>2022-02-25</d><h>18:34</h><r>mattyulrich</r>Are there settings for this on the aleph side?</z><z id="t1645814056" t="mattyulrich Yup"><y>#</y><d>2022-02-25</d><h>18:34</h><r>mattyulrich</r>Yup</z><z id="t1645814081" t="mattyulrich I send a request, then I get a response from the server and it triggers a disconnect; seemingly from the client."><y>#</y><d>2022-02-25</d><h>18:34</h><r>mattyulrich</r>I send a request, then I get a response from the server and it triggers a disconnect; seemingly from the client.</z><z id="t1645814173" t="hiredman | `max-frame-payload` | maximum allowable frame payload length, in bytes, defaults to `65536`. | `max-frame-size` | maximum aggregate message size, in bytes, defaults to `1048576`. "><y>#</y><d>2022-02-25</d><h>18:36</h><r>hiredman</r><pre>| `max-frame-payload` | maximum allowable frame payload length, in bytes, defaults to `65536`.
   | `max-frame-size` | maximum aggregate message size, in bytes, defaults to `1048576`.</pre>
</z><z id="t1645814404" t="hiredman the websocket protocol itself can break up large data over multiple frames, which is why there are two settings there, max-frame-payload is the max for a single frame, and max-frame-size is the max it will allow when recombining multiple frames (I think)"><y>#</y><d>2022-02-25</d><h>18:40</h><r>hiredman</r>the websocket protocol itself can break up large data over multiple frames, which is why there are two settings there,  max-frame-payload is the max for a single frame, and max-frame-size is the max it will allow when recombining multiple frames (I think)</z><z id="t1645814418" t="mattyulrich Gotcha.. I think this is the problem - my response is 450k bytes; other payloads that work are 15k bytes..."><y>#</y><d>2022-02-25</d><h>18:40</h><r>mattyulrich</r>Gotcha.. I think this is the problem - my response is 450k bytes; other payloads that work are 15k bytes...</z><z id="t1645814629" t="mattyulrich Yup - this is the guy! I put a limit on the response and now it&apos;s working. Thanks for the help here!"><y>#</y><d>2022-02-25</d><h>18:43</h><r>mattyulrich</r>Yup - this is the guy!  I put a limit on the response and now it&apos;s working.  Thanks for the help here!</z><z id="t1646234238" t="delaguardo https://twitter.com/kachayev/status/1498735985064095754"><y>#</y><d>2022-03-02</d><h>15:17</h><w>delaguardo</w><a href="https://twitter.com/kachayev/status/1498735985064095754" target="_blank">https://twitter.com/kachayev/status/1498735985064095754</a></z><z id="t1646317324" t="Matthew Davidson (kingmob) For context, Oleksii has contributed the most to Aleph after Zach. I hope he&apos;s ok. "><y>#</y><d>2022-03-03</d><h>14:22</h><r>Matthew Davidson (kingmob)</r>For context, Oleksii has contributed the most to Aleph after Zach. I hope he&apos;s ok. </z><z id="t1646478775" t="Matthew Davidson (kingmob) Hey everyone, Aleph 0.4.7 has been in alpha for way too long (almost four years at this point!) I‚Äôd like to cut an official 0.4.7 release (and just gnerally have smaller, more frequent releases), but I don‚Äôt know how much people have banged on the 0.4.7 code. I just pushed 0.4.7-rc1 to Clojars; could people try it out, and let me know if they have any issues? https://clojars.org/aleph/versions/0.4.7-rc1"><y>#</y><d>2022-03-05</d><h>11:12</h><w>Matthew Davidson (kingmob)</w>Hey everyone, Aleph 0.4.7 has been in alpha for way too long (almost four years at this point!)

I‚Äôd like to cut an official 0.4.7 release (and just gnerally have smaller, more frequent releases), but I don‚Äôt know how much people have banged on the 0.4.7 code. I just pushed 0.4.7-rc1 to Clojars; could people try it out, and let me know if they have any issues?

<a href="https://clojars.org/aleph/versions/0.4.7-rc1" target="_blank">https://clojars.org/aleph/versions/0.4.7-rc1</a></z><z id="t1646715338" t="Matthew Davidson (kingmob) Just cut rc2. Thanks to [:attrs {:href &quot;/_/_/users/U09FL65DK&quot;}] for pointing out it had been built with Java 17 classes. https://clojars.org/aleph/versions/0.4.7-rc2"><y>#</y><d>2022-03-08</d><h>04:55</h><w>Matthew Davidson (kingmob)</w>Just cut rc2. Thanks to <a>@xifi</a> for pointing out it had been built with Java 17 classes.
<a href="https://clojars.org/aleph/versions/0.4.7-rc2" target="_blank">https://clojars.org/aleph/versions/0.4.7-rc2</a></z><z id="t1646715373" t="Matthew Davidson (kingmob) No code differences, just recompiled for Java 8"><y>#</y><d>2022-03-08</d><h>04:56</h><w>Matthew Davidson (kingmob)</w>No code differences, just recompiled for Java 8</z><z id="t1646803764" t="Matthew Davidson (kingmob) RC3 has been released. Only major change is a slight bump in Netty to 4.1.65.Final for a regression. (More current Netty versions will be tested after this release.) https://clojars.org/aleph/versions/0.4.7-rc3"><y>#</y><d>2022-03-09</d><h>05:29</h><w>Matthew Davidson (kingmob)</w>RC3 has been released. Only major change is a slight bump in Netty to 4.1.65.Final for a regression. (More current Netty versions will be tested after this release.)

<a href="https://clojars.org/aleph/versions/0.4.7-rc3" target="_blank">https://clojars.org/aleph/versions/0.4.7-rc3</a></z><z id="t1647402311" t="Matthew Davidson (kingmob) OK, after 4 years, Aleph 0.4.7 is now available! https://clojars.org/aleph/versions/0.4.7"><y>#</y><d>2022-03-16</d><h>03:45</h><w>Matthew Davidson (kingmob)</w>OK, after 4 years, Aleph 0.4.7 is now available! <a href="https://clojars.org/aleph/versions/0.4.7" target="_blank">https://clojars.org/aleph/versions/0.4.7</a></z><z id="t1647611549" t="Eugen what are the release highlights for 0.4.7 ? I am quite new to it and the changes list seems quite big"><y>#</y><d>2022-03-18</d><h>13:52</h><w>Eugen</w>what are the release highlights for 0.4.7 ?
I am quite new to it and the changes list seems quite big</z><z id="t1647679488" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U011NGC5FFY&quot;}] It‚Äôs mostly the accumulation of years of bug fixes and upgraded libraries, no real new features. 0.4.6 was the last version the original author, Zach Tellman, released before leaving the Clojure community and moving on to other things. The 0.4.7 release is primarily to get all that out there. I became de facto maintainer of many of Zach‚Äôs old libs about a year ago, but my primary interest was in Manifold; I don‚Äôt know Netty that well (yet), so other than bug fixes, and keeping up-to-date with Netty versions, I don‚Äôt have major plans for Aleph. This is ok, though, in many ways, it‚Äôs pretty feature-complete. I plan to test out java virtual threads (from Project Loom) in dirigiste, and if it pans out, may change Manifold and Aleph to use them. We‚Äôll see. Of course, suggestions and help is welcome!"><y>#</y><d>2022-03-19</d><h>08:44</h><w>Matthew Davidson (kingmob)</w><a>@eugen.stan</a> It‚Äôs mostly the accumulation of years of bug fixes and upgraded libraries, no real new features. 0.4.6 was the last version the original author, Zach Tellman, released before leaving the Clojure community and moving on to other things. The 0.4.7 release is primarily to get all that out there.

I became de facto maintainer of many of Zach‚Äôs old libs about a year ago, but my primary interest was in Manifold; I don‚Äôt know Netty that well (yet), so other than bug fixes, and keeping up-to-date with Netty versions, I don‚Äôt have major plans for Aleph. This is ok, though, in many ways, it‚Äôs pretty feature-complete.

I plan to test out java virtual threads (from Project Loom) in dirigiste, and if it pans out, may change Manifold and Aleph to use them. We‚Äôll see.

Of course, suggestions and help is welcome!</z><z id="t1648104222" t="Ben Sless One thing I noticed regarding manifold which might benefit from some work is it allocates quite a lot and creates deep call stacks even for &quot;trivial&quot; code."><y>#</y><d>2022-03-24</d><h>06:43</h><r>Ben Sless</r>One thing I noticed regarding manifold which might benefit from some work is it allocates quite a lot and creates deep call stacks even for &quot;trivial&quot; code.</z><z id="t1648115982" t="Matthew Davidson (kingmob) Any scenarios in particular you think should be looked into [:attrs {:href &quot;/_/_/users/UK0810AQ2&quot;}] ?"><y>#</y><d>2022-03-24</d><h>09:59</h><r>Matthew Davidson (kingmob)</r>Any scenarios in particular you think should be looked into <a>@UK0810AQ2</a>?</z><z id="t1648127469" t="Eugen I think we noticed that too in our code ... (not 100% sure it&apos;s manifold). I remember lots of threads and thread exhaustion by manifold threads. I checked to see if we can limit the pool but did not find things. (new to clojure)"><y>#</y><d>2022-03-24</d><h>13:11</h><r>Eugen</r>I think we noticed that too in our code ... (not 100% sure it&apos;s manifold). I remember lots of threads and thread exhaustion by manifold threads. I checked to see if we can limit the pool but did not find things. (new to clojure)</z><z id="t1648362861" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U011NGC5FFY&quot;}] If you have a memory snapshot you can share, that would be awesome. If you were returning InputStreams of any sort in Aleph, I might have a fix for the memory leak here: https://github.com/clj-commons/aleph/issues/523#issuecomment-1075429913"><y>#</y><d>2022-03-27</d><h>06:34</h><r>Matthew Davidson (kingmob)</r><a>@eugen.stan</a> If you have a memory snapshot you can share, that would be awesome. If you were returning InputStreams of any sort in Aleph, I might have a fix for the memory leak here: <a href="https://github.com/clj-commons/aleph/issues/523#issuecomment-1075429913" target="_blank">https://github.com/clj-commons/aleph/issues/523#issuecomment-1075429913</a></z><z id="t1648489678" t="Ben Sless [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] I forgot I already had profiling results for a server with Aleph and manifold, you can take a look at the flame graph and see where time is spent https://github.com/bsless/stress-server/blob/master/results/svg/aleph.ring-middleware.async.java15.G1GC.svg"><y>#</y><d>2022-03-28</d><h>17:47</h><r>Ben Sless</r><a>@U10EC98F5</a> I forgot I already had profiling results for a server with Aleph and manifold, you can take a look at the flame graph and see where time is spent
<a href="https://github.com/bsless/stress-server/blob/master/results/svg/aleph.ring-middleware.async.java15.G1GC.svg" target="_blank">https://github.com/bsless/stress-server/blob/master/results/svg/aleph.ring-middleware.async.java15.G1GC.svg</a></z><z id="t1648489713" t="Ben Sless raw view is more convenient https://raw.githubusercontent.com/bsless/stress-server/master/results/svg/aleph.ring-middleware.async.java15.G1GC.svg"><y>#</y><d>2022-03-28</d><h>17:48</h><r>Ben Sless</r>raw view is more convenient <a href="https://raw.githubusercontent.com/bsless/stress-server/master/results/svg/aleph.ring-middleware.async.java15.G1GC.svg" target="_blank">https://raw.githubusercontent.com/bsless/stress-server/master/results/svg/aleph.ring-middleware.async.java15.G1GC.svg</a></z><z id="t1648517772" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UK0810AQ2&quot;}] thanks for sharing that. The SVG isn&apos;t labeled in the deep call stack (on my phone), but can I generate a new one from the repo? I&apos;d like to zoom in if possible. My immediate guess is work is being done on the main thread that should be on an executor thread, but I&apos;ll have to see"><y>#</y><d>2022-03-29</d><h>01:36</h><r>Matthew Davidson (kingmob)</r><a>@UK0810AQ2</a>  thanks for sharing that. The SVG isn&apos;t labeled in the deep call stack (on my phone), but can I generate a new one from the repo? I&apos;d like to zoom in if possible. 

My immediate guess is work is being done on the main thread that should be on an executor thread, but I&apos;ll have to see</z><z id="t1648528660" t="Ben Sless [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] entirely possible, feel free to dm me and we&apos;ll schedule something"><y>#</y><d>2022-03-29</d><h>04:37</h><r>Ben Sless</r><a>@U10EC98F5</a> entirely possible, feel free to dm me and we&apos;ll schedule something</z><z id="t1648246234" t="flipmokid Hi all, I‚Äôm calling the Twitter API for its filtered stream endpoint which uses long polling to stream results back. I‚Äôm able to connect and see data stream back but I‚Äôm not sure of the best way to close this connection when I‚Äôm done. The aleph.http/get function returns a deferred and I‚Äôm not sure how to cancel/close this."><y>#</y><d>2022-03-25</d><h>22:10</h><w>flipmokid</w>Hi all, I‚Äôm calling the Twitter API for its filtered stream endpoint which uses long polling to stream results back. I‚Äôm able to connect and see data stream back but I‚Äôm not sure of the best way to close this connection when I‚Äôm done. The <code>aleph.http/get</code> function returns a deferred and I‚Äôm not sure how to cancel/close this.</z><z id="t1648370061" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0C6HAPFU&quot;}] You shouldn‚Äôt need to close the deferred. You can call .close on the underlying InputStream in :body to be polite, but 99% of the time, that‚Äôs a no-op. It should be fine to stop using them and let them go out of scope. Just don‚Äôt hold on to any references, and they‚Äôll be GCed."><y>#</y><d>2022-03-27</d><h>08:34</h><r>Matthew Davidson (kingmob)</r><a>@U0C6HAPFU</a> You shouldn‚Äôt need to close the deferred. You can call <code>.close</code> on the underlying InputStream in <code>:body</code>  to be polite, but 99% of the time, that‚Äôs a no-op.

It should be fine to stop using them and let them go out of scope. Just don‚Äôt hold on to any references, and they‚Äôll be GCed.</z><z id="t1648376427" t="flipmokid Ah, not sure why I hadn‚Äôt thought about closing the InputStream. Thank you very much [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] - much appreciated!"><y>#</y><d>2022-03-27</d><h>10:20</h><r>flipmokid</r>Ah, not sure why I hadn‚Äôt thought about closing the InputStream. Thank you very much <a>@U10EC98F5</a> - much appreciated!</z><z id="t1648413539" t="flipmokid I gave closing the InputStream a go and it doesn‚Äôt look like it worked. After connecting to Twitter using @(d/chain (http/get (:stream twitter-urls) {:headers {&quot;authorization&quot; (str &quot;Bearer &quot; bearer) &quot;user-agent&quot; &quot;Aleph&quot;}}) :body) I store the input stream and later call (.close input-stream) on it in the REPL. When trying to create a new connection (seconds to minutes later) Twitter responds with {&quot;title&quot;:&quot;ConnectionException&quot;,&quot;detail&quot;:&quot;This stream is currently at the maximum allowed connection limit.&quot;,&quot;connection_issue&quot;:&quot;TooManyConnections&quot;,&quot;type&quot;:&quot;&quot;} Twitter only allows one connection at a time per project and so it looks like the connection is maintained despite calling close on the input-stream. If I restart the REPL then it works again for the first connection."><y>#</y><d>2022-03-27</d><h>20:38</h><r>flipmokid</r>I gave closing the InputStream a go and it doesn‚Äôt look like it worked.

After connecting to Twitter using

<pre>@(d/chain 
 (http/get (:stream twitter-urls)
           {:headers {&quot;authorization&quot; (str &quot;Bearer &quot; bearer)
                      &quot;user-agent&quot;    &quot;Aleph&quot;}})
 :body)</pre>
I store the input stream and later call <code>(.close input-stream)</code>  on it in the REPL. When trying to create a new connection (seconds to minutes later) Twitter responds with

<pre>{&quot;title&quot;:&quot;ConnectionException&quot;,&quot;detail&quot;:&quot;This stream is currently at the maximum allowed connection limit.&quot;,&quot;connection_issue&quot;:&quot;TooManyConnections&quot;,&quot;type&quot;:&quot;&quot;}</pre>
Twitter only allows one connection at a time per project and so it looks like the connection is maintained despite calling close on the input-stream. If I restart the REPL then it works again for the first connection.</z><z id="t1648464263" t="Matthew Davidson (kingmob) Yeah, .close on the InputStream probably does nothing. Aleph‚Äôs set up to completely manage connections behind the scenes for you. In theory, you could call aleph.http.client/close-connection on the stored connection in the default-connection-pool, but I couldn‚Äôt get that to work off the top of my head, since the underlying Dirigiste object pool is kind of opaque. You could use intermediate functions to directly get a conn, like copying and calling create-connection , but there‚Äôs a lot of intermediate code that would be bypassed that‚Äôs necessary to correct functioning. I tried returning the connection used as a field in the response. While it does give you a handle to close, thus freeing you up to make another call to twitter, it gets into tricky territory, since it means either you or dirigiste could close the underlying netty channel without the other knowing about it. I need to think more about this."><y>#</y><d>2022-03-28</d><h>10:44</h><r>Matthew Davidson (kingmob)</r>Yeah, <code>.close</code> on the InputStream probably does nothing.

Aleph‚Äôs set up to completely manage connections behind the scenes for you. In theory, you could call <code>aleph.http.client/close-connection</code> on the stored connection in the default-connection-pool, but I couldn‚Äôt get that to work off the top of my head, since the underlying Dirigiste object pool is kind of opaque. You could use intermediate functions to directly get a conn, like copying and calling <code>create-connection</code>, but there‚Äôs a lot of intermediate code that would be bypassed that‚Äôs necessary to correct functioning.

I tried returning the connection used as a field in the response. While it does give you a handle to close, thus freeing you up to make another call to twitter, it gets into tricky territory, since it means either you or dirigiste could close the underlying netty channel without the other knowing about it.

I need to think more about this.</z><z id="t1650015823" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0C6HAPFU&quot;}] Did you ever try setting the header Connection: close ?"><y>#</y><d>2022-04-15</d><h>09:43</h><r>Matthew Davidson (kingmob)</r><a>@U0C6HAPFU</a> Did you ever try setting the header <code>Connection: close</code>?</z><z id="t1650017101" t="Matthew Davidson (kingmob) That would be on the Twitter side, but I‚Äôm not sure that would suffice for Dirigste without some testing. Really just speculating here. Waitaminit. What about on the client side, using request directly instead of get , post , etc, and adding :aleph.http.client/close true to the Ring map when you want to close it?"><y>#</y><d>2022-04-15</d><h>10:05</h><r>Matthew Davidson (kingmob)</r>That would be on the Twitter side, but I‚Äôm not sure that would suffice for Dirigste without some testing. Really just speculating here.

Waitaminit. What about on the client side, using <code>request</code> directly instead of <code>get</code>, <code>post</code>, etc, and adding <code>:aleph.http.client/close true</code> to the Ring map when you want to close it?</z><z id="t1650366386" t="flipmokid Thanks for the suggestions. I‚Äôll have a go but would this work if I want to start a request, get a few minutes of streaming data come back before ending it? If so would you be able to briefly explain how that‚Äôd work as I had assumed you send the request and then cannot send further data or update the request map after that."><y>#</y><d>2022-04-19</d><h>11:06</h><r>flipmokid</r>Thanks for the suggestions. I‚Äôll have a go but would this work if I want to start a request, get a few minutes of streaming data come back before ending it? If so would you be able to briefly explain how that‚Äôd work as I had assumed you send the request and then cannot send further data or update the request map after that.</z><z id="t1650377813" t="Matthew Davidson (kingmob) Http requests are independent, but the underlying connections are almost always kept open to avoid startup overhead (tcp, tls). But the request map with :aleph.http.client/close in it won&apos;t actually be sent, it&apos;s just a sentinel value to close a connection in Aleph. Usually it&apos;s just a random internal detail. If the same connection processes the sentinel, it will close. However, I haven&apos;t checked to see that it works while the existing connection is still open. It might not. It should work if the reused connection got the request, but if the connection was reused, then you wouldn&apos;t have your initial problem. You might also be able to alter the default conn pool so there&apos;s a max of 1 conn per site, which could force the existing conn to process the sentinel‚Ä¶or just make it block/throw üòú"><y>#</y><d>2022-04-19</d><h>14:16</h><r>Matthew Davidson (kingmob)</r>Http requests are independent, but the underlying connections are almost always kept open to avoid startup overhead (tcp, tls). But the request map with <code>:aleph.http.client/close</code> in it won&apos;t actually be sent, it&apos;s just a sentinel value to close a connection in Aleph. Usually it&apos;s just a random internal detail.

If the same connection processes the sentinel, it will close. However, I haven&apos;t checked to see that it works while the existing connection is still open. It might not. It should work if the reused connection got the request, but if the connection was reused, then you wouldn&apos;t have your initial problem. 

You might also be able to alter the default conn pool so there&apos;s a max of 1 conn per site, which could force the existing conn to process the sentinel‚Ä¶or just make it block/throw <b>üòú</b></z><z id="t1648437779" t="skynet anyone know if it&apos;s possible to use Aleph TCP in a graal native image? it seems to pull in all too much of netty when requiring the aleph.tcp namespace"><y>#</y><d>2022-03-28</d><h>03:22</h><w>skynet</w>anyone know if it&apos;s possible to use Aleph TCP in a graal native image? it seems to pull in all too much of netty when requiring the <code>aleph.tcp</code> namespace</z><z id="t1648477933" t="Matthew Davidson (kingmob) Aleph is built on Netty, so I would expect it to pull in a lot of it. In particular, it requires (def netty-modules &apos;[transport transport-native-epoll codec codec-http handler handler-proxy resolver resolver-dns]) which results in the following dep tree: [io.netty/netty-codec-http &quot;4.1.65.Final&quot;] [io.netty/netty-codec &quot;4.1.65.Final&quot;] [io.netty/netty-handler-proxy &quot;4.1.65.Final&quot;] [io.netty/netty-codec-socks &quot;4.1.65.Final&quot;] [io.netty/netty-handler &quot;4.1.65.Final&quot;] [io.netty/netty-resolver-dns &quot;4.1.65.Final&quot;] [io.netty/netty-codec-dns &quot;4.1.65.Final&quot;] [io.netty/netty-resolver &quot;4.1.65.Final&quot;] [io.netty/netty-transport-native-epoll &quot;4.1.65.Final&quot;] [io.netty/netty-transport-native-unix-common &quot;4.1.65.Final&quot;] [io.netty/netty-transport &quot;4.1.65.Final&quot;] [io.netty/netty-buffer &quot;4.1.65.Final&quot;] [io.netty/netty-common &quot;4.1.65.Final&quot;]"><y>#</y><d>2022-03-28</d><h>14:32</h><r>Matthew Davidson (kingmob)</r>Aleph is built on Netty, so I would expect it to pull in a lot of it. In particular, it requires
<pre>(def netty-modules
  &apos;[transport
    transport-native-epoll
    codec
    codec-http
    handler
    handler-proxy
    resolver
    resolver-dns])</pre>
which results in the following dep tree:
<pre>[io.netty/netty-codec-http &quot;4.1.65.Final&quot;]
 [io.netty/netty-codec &quot;4.1.65.Final&quot;]
 [io.netty/netty-handler-proxy &quot;4.1.65.Final&quot;]
   [io.netty/netty-codec-socks &quot;4.1.65.Final&quot;]
 [io.netty/netty-handler &quot;4.1.65.Final&quot;]
 [io.netty/netty-resolver-dns &quot;4.1.65.Final&quot;]
   [io.netty/netty-codec-dns &quot;4.1.65.Final&quot;]
 [io.netty/netty-resolver &quot;4.1.65.Final&quot;]
 [io.netty/netty-transport-native-epoll &quot;4.1.65.Final&quot;]
   [io.netty/netty-transport-native-unix-common &quot;4.1.65.Final&quot;]
 [io.netty/netty-transport &quot;4.1.65.Final&quot;]
   [io.netty/netty-buffer &quot;4.1.65.Final&quot;]
   [io.netty/netty-common &quot;4.1.65.Final&quot;]</pre></z><z id="t1648478165" t="Matthew Davidson (kingmob) You may have some issues building Aleph with Graal. A few people have asked over the last couple years, but Aleph was never built with Graal‚Äôs requirements in mind. There‚Äôs issues with top-level single namespaces in deps, statically-initialized threads, and probably some others. If you want to try it and catalog the issues you find, we could use the assistance."><y>#</y><d>2022-03-28</d><h>14:36</h><r>Matthew Davidson (kingmob)</r>You may have some issues building Aleph with Graal. A few people have asked over the last couple years, but Aleph was never built with Graal‚Äôs requirements in mind. There‚Äôs issues with top-level single namespaces in deps, statically-initialized threads, and probably some others. If you want to try it and catalog the issues you find, we could use the assistance.</z><z id="t1648478169" t="skynet [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] thanks for the reply, I guess I&apos;m not sure why the aleph.tcp namespace causes netty classes like io.netty.channel.epoll.Native to be initialized, while aleph.http does not and can be built fine here https://github.com/clj-easy/graalvm-clojure/tree/master/aleph I&apos;m starting to dig into the aleph.netty namespace and I think it might be due to some macro in there that tcp uses"><y>#</y><d>2022-03-28</d><h>14:36</h><r>skynet</r><a>@U10EC98F5</a> thanks for the reply, I guess I&apos;m not sure why the <code>aleph.tcp</code> namespace causes netty classes like <code>io.netty.channel.epoll.Native</code> to be initialized, while <code>aleph.http</code> does not and can be built fine here <a href="https://github.com/clj-easy/graalvm-clojure/tree/master/aleph" target="_blank">https://github.com/clj-easy/graalvm-clojure/tree/master/aleph</a>

I&apos;m starting to dig into the <code>aleph.netty</code> namespace and I think it might be due to some macro in there that tcp uses</z><z id="t1648478943" t="Matthew Davidson (kingmob) I‚Äôm not familiar with clj-easy, although I know [:attrs {:href &quot;/_/_/users/UM4NVAD62&quot;}] has been working to get Aleph working with it. It‚Äôs another layer on top of Graal, and has its own issues (namely, it can‚Äôt handle single-segment namespaces, which some of Zach‚Äôs libs use since they were written at the dawn of time). At a low level, the use of epoll shouldn‚Äôt have anything to do with your protocol of interest (e.g., http vs tcp). It‚Äôs supposed to be an optimization for Linux. That being said, I haven‚Äôt looked into that stuff at all since becoming maintainer. WHy do you want/need to not load io.netty.channel.epoll.Native?"><y>#</y><d>2022-03-28</d><h>14:49</h><r>Matthew Davidson (kingmob)</r>I‚Äôm not familiar with clj-easy, although I know <a>@UM4NVAD62</a> has been working to get Aleph working with it. It‚Äôs another layer on top of Graal, and has its own issues (namely, it can‚Äôt handle single-segment namespaces, which some of Zach‚Äôs libs use since they were written at the dawn of time).

At a low level, the use of epoll shouldn‚Äôt have anything to do with your protocol of interest (e.g., http vs tcp). It‚Äôs supposed to be an optimization for Linux. That being said, I haven‚Äôt looked into that stuff at all since becoming maintainer.

WHy do you want/need to not load io.netty.channel.epoll.Native?</z><z id="t1648482019" t="skynet [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] so that specific clj-easy repo graalvm-clojure has just small example projects showing basic graalvm native image compatibility for various clojure libs. you can see that it needs to tell graal to initialize various netty classes at runtime in order to work https://github.com/clj-easy/graalvm-clojure/blob/master/aleph/project.clj#L32 I believe you&apos;re thinking of this repo https://github.com/clj-easy/graal-build-time#graal-build-time which does indeed have the single-segment ns issue you mentioned I see people claim that they have success building at least parts of netty with graal native https://github.com/netty/netty/issues/10616#issuecomment-997282655 so that makes me think it might be possible to get a netty tcp client in a native image. but something in either Aleph or the specific netty classes that it uses is causing these classes to be initialized at build time, which breaks the native-image build for me"><y>#</y><d>2022-03-28</d><h>15:40</h><r>skynet</r><a>@U10EC98F5</a> so that specific clj-easy repo graalvm-clojure has just small example projects showing basic graalvm native image compatibility for various clojure libs. you can see that it needs to tell graal to initialize various netty classes at runtime in order to work <a href="https://github.com/clj-easy/graalvm-clojure/blob/master/aleph/project.clj#L32" target="_blank">https://github.com/clj-easy/graalvm-clojure/blob/master/aleph/project.clj#L32</a>

I believe you&apos;re thinking of this repo <a href="https://github.com/clj-easy/graal-build-time#graal-build-time" target="_blank">https://github.com/clj-easy/graal-build-time#graal-build-time</a> which does indeed have the single-segment ns issue you mentioned

I see people claim that they have success building at least parts of netty with graal native <a href="https://github.com/netty/netty/issues/10616#issuecomment-997282655" target="_blank">https://github.com/netty/netty/issues/10616#issuecomment-997282655</a>
so that makes me think it might be possible to get a netty tcp client in a native image. but something in either Aleph or the specific netty classes that it uses is causing these classes to be initialized at build time, which breaks the native-image build  for me</z><z id="t1648498767" t="skynet making some progress, got an image to build, and am now running into reflection issues in gloss. I see someone else did some work on that https://clojurians.slack.com/archives/C0G922PCH/p1641253399033500 might try starting there and adding more type hints that I need"><y>#</y><d>2022-03-28</d><h>20:19</h><r>skynet</r>making some progress, got an image to build, and am now running into reflection issues in gloss. I see someone else did some work on that <a href="https://clojurians.slack.com/archives/C0G922PCH/p1641253399033500" target="_blank">https://clojurians.slack.com/archives/C0G922PCH/p1641253399033500</a>
might try starting there and adding more type hints that I need</z><z id="t1648512922" t="skynet [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] fixed my issue with Gloss, needed to replace the match-loop fn with a version that doesn&apos;t use eval https://github.com/skynet-gh/gloss/commit/d3db3b9d7f5a39d1ae504b0c2adae1d43f18b1f0"><y>#</y><d>2022-03-29</d><h>00:15</h><r>skynet</r><a>@U10EC98F5</a> fixed my issue with Gloss, needed to replace the <code>match-loop</code> fn with a version that doesn&apos;t use <code>eval</code> <a href="https://github.com/skynet-gh/gloss/commit/d3db3b9d7f5a39d1ae504b0c2adae1d43f18b1f0" target="_blank">https://github.com/skynet-gh/gloss/commit/d3db3b9d7f5a39d1ae504b0c2adae1d43f18b1f0</a></z><z id="t1648517065" t="Matthew Davidson (kingmob) The original gloss is archived, but a few people have had problems, and it&apos;s available in clj-commons now, which we can edit. Maybe make an issue for it?"><y>#</y><d>2022-03-29</d><h>01:24</h><r>Matthew Davidson (kingmob)</r>The original gloss is archived, but a few people have had problems, and it&apos;s available in clj-commons now, which we can edit. Maybe make an issue for it?</z><z id="t1648518470" t="skynet perfect, I&apos;ll do that. thanks for managing these old libraries."><y>#</y><d>2022-03-29</d><h>01:47</h><r>skynet</r>perfect, I&apos;ll do that. thanks for managing these old libraries.</z><z id="t1648518542" t="skynet what are your plans for the libraries with single segment namespaces like byte-streams ?"><y>#</y><d>2022-03-29</d><h>01:49</h><r>skynet</r>what are your plans for the libraries with single segment namespaces like <code>byte-streams</code> ?</z><z id="t1648524623" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UM4NVAD62&quot;}] was doing some work on it, but I haven‚Äôt heard back from him in a while. Without him, I‚Äôll get around to it when I get to it. But for both byte-streams and primitive-math, the plan is to copy the code to a multi-segment ns, and leave the old code in place. For byte-streams, I‚Äôll update manifold/aleph to use the multi-segment ns, which should alleviate those clj-easy issues."><y>#</y><d>2022-03-29</d><h>03:30</h><r>Matthew Davidson (kingmob)</r><a>@UM4NVAD62</a> was doing some work on it, but I haven‚Äôt heard back from him in a while. Without him, I‚Äôll get around to it when I get to it.

But for both byte-streams and primitive-math, the plan is to copy the code to a multi-segment ns, and leave the old code in place. For byte-streams, I‚Äôll update manifold/aleph to use the multi-segment ns, which should alleviate those clj-easy issues.</z><z id="t1648524828" t="skynet that makes sense, thanks! if I get impatient enough I might send a PR to add the multi-segment version of byte-streams, since it causes a pain in graal"><y>#</y><d>2022-03-29</d><h>03:33</h><r>skynet</r>that makes sense, thanks! if I get impatient enough I might send a PR to add the multi-segment version of byte-streams, since it causes a pain in graal</z><z id="t1648614270" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0DSU64Q1&quot;}] Great! Here‚Äôs what I sent Piotr about his changes (in https://github.com/piotr-yuxuan/byte-streams ) for primitive-math and byte-streams. The tl;dr is we want to copy code to a ns like clj-commons.byte-streams, and deprecate the single-segment ns for byte-streams (but not primitive-math, I think that would cause chaos, it‚Äôs too popular). ------------------- I‚Äôm catching up on the primitive-math issue for clj-easy. Your fork of the master branch looks good, want to make a PR for it against the clj-commons repo? My only request is to remove ^:deprecated and @Deprecated() from the namespace/packages. The deprecation comments should remain, though, and maybe add a note at the bottom of the README explaining that the nested ns is available if needed. The reason for this is, with over 4 million downloads, we don‚Äôt want lots of people upgrading, and immediately thinking they need to change their namespaces to fix something, or asking questions, when the change is only necessary for a handful of people. I can see this causing a lot of unnecessary work by accident. We can do the same with byte-streams when primitive-math is ready, but we can leave the deprecation metadata in, because unlike primitive-math, byte-streams will probably get updates."><y>#</y><d>2022-03-30</d><h>04:24</h><r>Matthew Davidson (kingmob)</r><a>@U0DSU64Q1</a> Great!

Here‚Äôs what I sent Piotr about his changes (in <a href="https://github.com/piotr-yuxuan/byte-streams" target="_blank">https://github.com/piotr-yuxuan/byte-streams</a>) for primitive-math and byte-streams. The tl;dr is we want to copy code to a ns like clj-commons.byte-streams, and deprecate the single-segment ns for byte-streams (but not primitive-math, I think that would cause chaos, it‚Äôs too popular).

-------------------
I‚Äôm catching up on the primitive-math issue for clj-easy. Your fork of the <code>master</code> branch looks good, want to make a PR for it against the clj-commons repo?

My only request is to remove <code>^:deprecated</code> and <code>@Deprecated()</code> from the namespace/packages. The deprecation comments should remain, though, and maybe add a note at the bottom of the README explaining that the nested ns is available if needed.

The reason for this is, with over 4 million downloads, we don‚Äôt want lots of people upgrading, and immediately thinking they need to change their namespaces to fix something, or asking questions, when the change is only necessary for a handful of people. I can see this causing a lot of unnecessary work by accident.

We can do the same with byte-streams when primitive-math is ready, but we can leave the deprecation metadata in, because unlike primitive-math, byte-streams will probably get updates.</z><z id="t1648653426" t="skynet cool ty, I&apos;ll take a look when I get a chance, probably this coming weekend. I think I understand what you&apos;re saying, that primitive-math should get the cloned namespaces first, and merged and released, and then byte-streams can since it depends on it"><y>#</y><d>2022-03-30</d><h>15:17</h><r>skynet</r>cool ty, I&apos;ll take a look when I get a chance, probably this coming weekend.

I think I understand what you&apos;re saying, that <code>primitive-math</code> should get the cloned namespaces first, and merged and released, and then <code>byte-streams</code> can since it depends on it</z><z id="t1648684654" t="skynet [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] found some time to look at primitive-math https://github.com/clj-commons/primitive-math/pull/14 let me know if that PR is in the right direction, happy to make other changes if you want"><y>#</y><d>2022-03-30</d><h>23:57</h><r>skynet</r><a>@U10EC98F5</a> found some time to look at <code>primitive-math</code> <a href="https://github.com/clj-commons/primitive-math/pull/14" target="_blank">https://github.com/clj-commons/primitive-math/pull/14</a>
let me know if that PR is in the right direction, happy to make other changes if you want</z><z id="t1649956554" t="bhurlow Is there a way to detect when a connection to an aleph server is closed?"><y>#</y><d>2022-04-14</d><h>17:15</h><w>bhurlow</w>Is there a way to detect when a connection to an aleph server is closed?</z><z id="t1650015556" t="Matthew Davidson (kingmob) Hmmm. That question has multiple possible answers. If you‚Äôre using the Aleph http client, you‚Äôll start getting error-deferreds if you try to get responses from a closed connection, iiuc. There are certain HTTP signals that a connection is over: e.g., the ‚ÄúConnection: close‚Äù header means ‚ÄúThis is the last message, closing after‚Äù, and a zero-length chunk signals the end of chunked streaming in HTTP/1.1. Likewise for TCP. But without signaling, you can‚Äôt distinguish whether a connection is dead or just really slow, so we use timeouts."><y>#</y><d>2022-04-15</d><h>09:39</h><r>Matthew Davidson (kingmob)</r>Hmmm. That question has multiple possible answers. If you‚Äôre using the Aleph http client, you‚Äôll start getting error-deferreds if you try to get responses from a closed connection, iiuc.

There are certain HTTP signals that a connection is over: e.g., the ‚ÄúConnection: close‚Äù header means ‚ÄúThis is the last message, closing after‚Äù, and a zero-length chunk signals the end of chunked streaming in HTTP/1.1. Likewise for TCP. But without signaling, you can‚Äôt  distinguish whether a connection is dead or just really slow, so we use timeouts.</z><z id="t1651079603" t="Leonid Korogodski Is there a configuration option somewhere to automatically coerce the body of a request from an input stream to a byte array? I only need streaming for responses. The request bodies are very small."><y>#</y><d>2022-04-27</d><h>17:13</h><w>Leonid Korogodski</w>Is there a configuration option somewhere to automatically coerce the body of a request from an input stream to a byte array? I only need streaming for responses. The request bodies are very small.</z><z id="t1651135554" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U01AQEJJ8NS&quot;}] Not exactly. When starting the server, you could pass in :raw-stream? true , which will prevent Aleph from turning the netty ByteBuf objects into an InputStream, but instead, you‚Äôll get a Manifold stream of ByteBufs. If you want to aggregate the whole request body into a byte[], you probably want to use something like clj-commons.byte-streams/to-byte-array . The byte-streams library was built to work with the underlying streams of Aleph. Also, check out the examples/ subdirectory to see uses of byte-streams in action."><y>#</y><d>2022-04-28</d><h>08:45</h><w>Matthew Davidson (kingmob)</w><a>@lkorogodski</a> Not exactly. When starting the server, you could pass in <code>:raw-stream? true</code> , which will prevent Aleph from turning the netty ByteBuf objects into an InputStream, but instead, you‚Äôll get a Manifold stream of ByteBufs.

If you want to aggregate the whole request body into a byte[], you probably want to use something like <code>clj-commons.byte-streams/to-byte-array</code> . The byte-streams library was built to work with the underlying streams of Aleph. Also, check out the <code>examples/</code> subdirectory to see uses of <code>byte-streams</code> in action.</z><z id="t1651151179" t="Leonid Korogodski Ok, thanks. I just wanted to spare myself some pain with the middleware that reads the response body. Came across a malli bug when validating the payload."><y>#</y><d>2022-04-28</d><h>13:06</h><w>Leonid Korogodski</w>Ok, thanks. I just wanted to spare myself some pain with the middleware that reads the response body. Came across a <code>malli</code> bug when validating the payload.</z><z id="t1651151248" t="Leonid Korogodski Post-validation, the body became nil ."><y>#</y><d>2022-04-28</d><h>13:07</h><w>Leonid Korogodski</w>Post-validation, the body became <code>nil</code> .</z><z id="t1652467682" t="jjttjj https://github.com/clj-commons/aleph/issues/569 I&apos;m getting this same error when I add jepsen ( https://github.com/jepsen-io/jepsen/tree/main/jepsen ) to my (deps.edn) project, even when I exclude byte-streams/manifold/aleph from the jepsen dep. Using latest versions of aleph (tried the snapshot and 0.4.7) and manifold. Any tips? Here&apos;s the deps tree it&apos;s showing below Jepsen. jepsen/jepsen 0.2.6 . org.clojure/data.fressian 1.0.0 . org.clojure/tools.logging 1.2.4 :newer-version . org.clojure/tools.cli 1.0.206 :newer-version . spootnik/unilog 0.7.29 . net.logstash.logback/logstash-logback-encoder 6.6 . com.fasterxml.jackson.core/jackson-databind 2.12.0 :newer-version . com.fasterxml.jackson.core/jackson-annotations 2.12.0 X com.fasterxml.jackson.core/jackson-core 2.12.0 :older-version . org.slf4j/slf4j-api 1.7.32 . org.slf4j/log4j-over-slf4j 1.7.32 . org.slf4j/slf4j-api 1.7.32 . org.slf4j/jul-to-slf4j 1.7.32 . org.slf4j/slf4j-api 1.7.32 . org.slf4j/jcl-over-slf4j 1.7.32 . org.slf4j/slf4j-api 1.7.32 . ch.qos.logback/logback-classic 1.2.8 . ch.qos.logback/logback-core 1.2.8 . org.slf4j/slf4j-api 1.7.32 . ch.qos.logback/logback-core 1.2.8 . elle/elle 0.1.4 . slingshot/slingshot 0.12.2 . dom-top/dom-top 1.0.7 X hiccup/hiccup 1.0.5 :older-version . knossos/knossos 0.3.8 . org.clojure/tools.logging 1.2.4 . rhizome/rhizome 0.2.9 . jepsen.txn/jepsen.txn 0.1.2 . io.lacuna/bifurcan 0.1.0 . clj-time/clj-time 0.15.2 . jepsen.txn/jepsen.txn 0.1.2 . knossos/knossos 0.3.8 . org.clojure/math.combinatorics 0.1.6 . potemkin/potemkin 0.4.5 . slingshot/slingshot 0.12.2 . interval-metrics/interval-metrics 1.0.0 . org.clojure/tools.cli 1.0.206 . com.boundary/high-scale-lib 1.0.6 . org.clojars.pallix/analemma 1.0.0 X org.clojure/tools.logging 1.1.0 :older-version . metametadata/multiset 0.1.1 . clj-ssh/clj-ssh 0.5.14 X org.clojure/tools.logging 0.2.6 :older-version . com.jcraft/jsch.agentproxy.usocket-jna 0.0.9 . com.jcraft/jsch.agentproxy.core 0.0.9 X net.java.dev.jna/jna 4.1.0 :older-version X net.java.dev.jna/jna-platform 4.1.0 :superseded X net.java.dev.jna/jna 4.1.0 :parent-omitted . com.jcraft/jsch.agentproxy.usocket-nc 0.0.9 . com.jcraft/jsch.agentproxy.core 0.0.9 . com.jcraft/jsch.agentproxy.sshagent 0.0.9 . com.jcraft/jsch.agentproxy.core 0.0.9 . com.jcraft/jsch.agentproxy.pageant 0.0.9 . com.jcraft/jsch.agentproxy.core 0.0.9 X net.java.dev.jna/jna 4.1.0 :older-version . net.java.dev.jna/jna-platform 4.1.0 . com.jcraft/jsch.agentproxy.core 0.0.9 . com.jcraft/jsch.agentproxy.jsch 0.0.9 X com.jcraft/jsch 0.1.49 :older-version . com.jcraft/jsch.agentproxy.core 0.0.9 . com.jcraft/jsch 0.1.53 . gnuplot/gnuplot 0.1.3 X byte-streams/byte-streams 0.2.5-alpha2 :excluded . http-kit/http-kit 2.5.3 . ring/ring 1.9.5 . ring/ring-core 1.9.5 :newer-version . ring/ring-codec 1.1.3 . commons-codec/commons-codec 1.15 X commons-io/commons-io 2.10.0 :older-version . commons-fileupload/commons-fileupload 1.4 X commons-io/commons-io 2.2 :older-version . crypto-random/crypto-random 1.2.1 . commons-codec/commons-codec 1.15 . crypto-equality/crypto-equality 1.0.0 . ring/ring-devel 1.9.5 . ring/ring-core 1.9.5 X hiccup/hiccup 1.0.5 :older-version . clj-stacktrace/clj-stacktrace 0.2.8 . ns-tracker/ns-tracker 0.4.0 X org.clojure/tools.namespace 0.2.11 :older-version X org.clojure/java.classpath 0.3.0 :older-version . ring/ring-jetty-adapter 1.9.5 . ring/ring-core 1.9.5 . ring/ring-servlet 1.9.5 . org.eclipse.jetty/jetty-server 9.4.44.v20210927 . javax.servlet/javax.servlet-api 3.1.0 . org.eclipse.jetty/jetty-http 9.4.44.v20210927 . org.eclipse.jetty/jetty-io 9.4.44.v20210927 . ring/ring-servlet 1.9.5 . ring/ring-core 1.9.5 X com.hierynomus/sshj 0.32.0 :use-top . com.jcraft/jsch.agentproxy.connector-factory 0.0.9 . com.jcraft/jsch.agentproxy.core 0.0.9 . com.jcraft/jsch.agentproxy.usocket-jna 0.0.9 . com.jcraft/jsch.agentproxy.usocket-nc 0.0.9 . com.jcraft/jsch.agentproxy.sshagent 0.0.9 . com.jcraft/jsch.agentproxy.pageant 0.0.9 . com.jcraft/jsch.agentproxy.sshj 0.0.9 . com.jcraft/jsch.agentproxy.core 0.0.9 . org.bouncycastle/bcprov-jdk15on 1.70 X hiccup/hiccup 1.0.5 :older-version . metametadata/multiset 0.1.1 . org.clojure/algo.generic 0.1.2 . dom-top/dom-top 1.0.7 X riddley/riddley 0.2.0 :excluded . slingshot/slingshot 0.12.2 . org.clojure/data.codec 0.1.1 . fipp/fipp 0.6.25 . org.clojure/core.rrb-vector 0.1.2 . io.lacuna/bifurcan 0.1.0"><y>#</y><d>2022-05-13</d><h>18:48</h><w>jjttjj</w><a href="https://github.com/clj-commons/aleph/issues/569" target="_blank">https://github.com/clj-commons/aleph/issues/569</a>
I&apos;m getting this same error when I add jepsen (<a href="https://github.com/jepsen-io/jepsen/tree/main/jepsen" target="_blank">https://github.com/jepsen-io/jepsen/tree/main/jepsen</a>) to my (deps.edn) project, even when I exclude byte-streams/manifold/aleph from the jepsen dep. Using latest versions of aleph (tried the snapshot and 0.4.7) and manifold. Any tips?
Here&apos;s the deps tree it&apos;s showing below Jepsen.
<pre>jepsen/jepsen 0.2.6
  . org.clojure/data.fressian 1.0.0
  . org.clojure/tools.logging 1.2.4 :newer-version
  . org.clojure/tools.cli 1.0.206 :newer-version
  . spootnik/unilog 0.7.29
    . net.logstash.logback/logstash-logback-encoder 6.6
      . com.fasterxml.jackson.core/jackson-databind 2.12.0 :newer-version
        . com.fasterxml.jackson.core/jackson-annotations 2.12.0
        X com.fasterxml.jackson.core/jackson-core 2.12.0 :older-version
    . org.slf4j/slf4j-api 1.7.32
    . org.slf4j/log4j-over-slf4j 1.7.32
      . org.slf4j/slf4j-api 1.7.32
    . org.slf4j/jul-to-slf4j 1.7.32
      . org.slf4j/slf4j-api 1.7.32
    . org.slf4j/jcl-over-slf4j 1.7.32
      . org.slf4j/slf4j-api 1.7.32
    . ch.qos.logback/logback-classic 1.2.8
      . ch.qos.logback/logback-core 1.2.8
      . org.slf4j/slf4j-api 1.7.32
    . ch.qos.logback/logback-core 1.2.8
  . elle/elle 0.1.4
    . slingshot/slingshot 0.12.2
    . dom-top/dom-top 1.0.7
    X hiccup/hiccup 1.0.5 :older-version
    . knossos/knossos 0.3.8
    . org.clojure/tools.logging 1.2.4
    . rhizome/rhizome 0.2.9
    . jepsen.txn/jepsen.txn 0.1.2
    . io.lacuna/bifurcan 0.1.0
  . clj-time/clj-time 0.15.2
  . jepsen.txn/jepsen.txn 0.1.2
  . knossos/knossos 0.3.8
    . org.clojure/math.combinatorics 0.1.6
    . potemkin/potemkin 0.4.5
    . slingshot/slingshot 0.12.2
    . interval-metrics/interval-metrics 1.0.0
    . org.clojure/tools.cli 1.0.206
    . com.boundary/high-scale-lib 1.0.6
    . org.clojars.pallix/analemma 1.0.0
    X org.clojure/tools.logging 1.1.0 :older-version
    . metametadata/multiset 0.1.1
  . clj-ssh/clj-ssh 0.5.14
    X org.clojure/tools.logging 0.2.6 :older-version
    . com.jcraft/jsch.agentproxy.usocket-jna 0.0.9
      . com.jcraft/jsch.agentproxy.core 0.0.9
      X net.java.dev.jna/jna 4.1.0 :older-version
      X net.java.dev.jna/jna-platform 4.1.0 :superseded
        X net.java.dev.jna/jna 4.1.0 :parent-omitted
    . com.jcraft/jsch.agentproxy.usocket-nc 0.0.9
      . com.jcraft/jsch.agentproxy.core 0.0.9
    . com.jcraft/jsch.agentproxy.sshagent 0.0.9
      . com.jcraft/jsch.agentproxy.core 0.0.9
    . com.jcraft/jsch.agentproxy.pageant 0.0.9
      . com.jcraft/jsch.agentproxy.core 0.0.9
      X net.java.dev.jna/jna 4.1.0 :older-version
      . net.java.dev.jna/jna-platform 4.1.0
    . com.jcraft/jsch.agentproxy.core 0.0.9
    . com.jcraft/jsch.agentproxy.jsch 0.0.9
      X com.jcraft/jsch 0.1.49 :older-version
      . com.jcraft/jsch.agentproxy.core 0.0.9
    . com.jcraft/jsch 0.1.53
  . gnuplot/gnuplot 0.1.3
    X byte-streams/byte-streams 0.2.5-alpha2 :excluded
  . http-kit/http-kit 2.5.3
  . ring/ring 1.9.5
    . ring/ring-core 1.9.5 :newer-version
      . ring/ring-codec 1.1.3
        . commons-codec/commons-codec 1.15
      X commons-io/commons-io 2.10.0 :older-version
      . commons-fileupload/commons-fileupload 1.4
        X commons-io/commons-io 2.2 :older-version
      . crypto-random/crypto-random 1.2.1
        . commons-codec/commons-codec 1.15
      . crypto-equality/crypto-equality 1.0.0
    . ring/ring-devel 1.9.5
      . ring/ring-core 1.9.5
      X hiccup/hiccup 1.0.5 :older-version
      . clj-stacktrace/clj-stacktrace 0.2.8
      . ns-tracker/ns-tracker 0.4.0
        X org.clojure/tools.namespace 0.2.11 :older-version
        X org.clojure/java.classpath 0.3.0 :older-version
    . ring/ring-jetty-adapter 1.9.5
      . ring/ring-core 1.9.5
      . ring/ring-servlet 1.9.5
      . org.eclipse.jetty/jetty-server 9.4.44.v20210927
        . javax.servlet/javax.servlet-api 3.1.0
        . org.eclipse.jetty/jetty-http 9.4.44.v20210927
        . org.eclipse.jetty/jetty-io 9.4.44.v20210927
    . ring/ring-servlet 1.9.5
      . ring/ring-core 1.9.5
  X com.hierynomus/sshj 0.32.0 :use-top
  . com.jcraft/jsch.agentproxy.connector-factory 0.0.9
    . com.jcraft/jsch.agentproxy.core 0.0.9
    . com.jcraft/jsch.agentproxy.usocket-jna 0.0.9
    . com.jcraft/jsch.agentproxy.usocket-nc 0.0.9
    . com.jcraft/jsch.agentproxy.sshagent 0.0.9
    . com.jcraft/jsch.agentproxy.pageant 0.0.9
  . com.jcraft/jsch.agentproxy.sshj 0.0.9
    . com.jcraft/jsch.agentproxy.core 0.0.9
  . org.bouncycastle/bcprov-jdk15on 1.70
  X hiccup/hiccup 1.0.5 :older-version
  . metametadata/multiset 0.1.1
    . org.clojure/algo.generic 0.1.2
  . dom-top/dom-top 1.0.7
    X riddley/riddley 0.2.0 :excluded
  . slingshot/slingshot 0.12.2
  . org.clojure/data.codec 0.1.1
  . fipp/fipp 0.6.25
    . org.clojure/core.rrb-vector 0.1.2
  . io.lacuna/bifurcan 0.1.0</pre></z><z id="t1652497487" t="Matthew Davidson (kingmob) I&apos;ll take a look later/tomorrow, but off the top of my head, aleph shouldn&apos;t be involved, and using a more recent byte-streams should work‚Ä¶"><y>#</y><d>2022-05-14</d><h>03:04</h><r>Matthew Davidson (kingmob)</r>I&apos;ll take a look later/tomorrow, but off the top of my head, aleph shouldn&apos;t be involved, and using a more recent byte-streams should work‚Ä¶</z><z id="t1652499907" t="jjttjj Thanks I can try to get a minimal reproduction this weekend, was just curious if it was anything obvious"><y>#</y><d>2022-05-14</d><h>03:45</h><r>jjttjj</r>Thanks I can try to get a minimal reproduction this weekend, was just curious if it was anything obvious</z><z id="t1653045102" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U064UGEUQ&quot;}] OK, after a bit of digging, I found the issue. Jepsen is being deployed to Maven as an uberjar, which means it comes bundled with its own versions of byte-streams and manifold. If you check with clj -Spath , you can see it precedes the actual manifold dep in the classpath, making later specified lib jars irrelevant. I once debugged the same issue with Lein, and in that case, it handed off the deps to Maven, and got a set of jars. I don‚Äôt recall if Maven or Lein was at fault, but both effectively assume the jars‚Äô classes were disjoint. I‚Äôm saddened/annoyed/unsurprised to see tools.deps have the same flaw. I‚Äôll open an issue with aphyr, in case this isn‚Äôt intended behavior, and for you, maybe using a git coordinate, or downloading the jepsen code and using a local coordinate will work?"><y>#</y><d>2022-05-20</d><h>11:11</h><r>Matthew Davidson (kingmob)</r><a>@jjttjj</a> OK, after a bit of digging, I found the issue. Jepsen is being deployed to Maven as an uberjar, which means it comes bundled with its own versions of byte-streams and manifold. If you check with <code>clj -Spath</code>, you can see it precedes the actual manifold dep in the classpath, making later specified lib jars irrelevant.

I once debugged the same issue with Lein, and in that case, it handed off the deps to Maven, and got a set of jars. I don‚Äôt recall if Maven or Lein was at fault, but both effectively assume the jars‚Äô classes were disjoint. I‚Äôm saddened/annoyed/unsurprised to see tools.deps have the same flaw.

I‚Äôll open an issue with aphyr, in case this isn‚Äôt intended behavior, and for you, maybe using a git coordinate, or downloading the jepsen code and using a local coordinate will work?</z><z id="t1653046083" t="Matthew Davidson (kingmob) You can track the issue here: https://github.com/jepsen-io/jepsen/issues/535"><y>#</y><d>2022-05-20</d><h>11:28</h><r>Matthew Davidson (kingmob)</r>You can track the issue here: <a href="https://github.com/jepsen-io/jepsen/issues/535" target="_blank">https://github.com/jepsen-io/jepsen/issues/535</a></z><z id="t1653050104" t="jjttjj [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] thank you so much for looking into that I really appreciate it! I was stumped"><y>#</y><d>2022-05-20</d><h>12:35</h><r>jjttjj</r><a>@U10EC98F5</a> thank you so much for looking into that I really appreciate it! I was stumped</z><z id="t1653045102" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U064UGEUQ&quot;}] OK, after a bit of digging, I found the issue. Jepsen is being deployed to Maven as an uberjar, which means it comes bundled with its own versions of byte-streams and manifold. If you check with clj -Spath , you can see it precedes the actual manifold dep in the classpath, making later specified lib jars irrelevant. I once debugged the same issue with Lein, and in that case, it handed off the deps to Maven, and got a set of jars. I don‚Äôt recall if Maven or Lein was at fault, but both effectively assume the jars‚Äô classes were disjoint. I‚Äôm saddened/annoyed/unsurprised to see tools.deps have the same flaw. I‚Äôll open an issue with aphyr, in case this isn‚Äôt intended behavior, and for you, maybe using a git coordinate, or downloading the jepsen code and using a local coordinate will work?"><y>#</y><d>2022-05-20</d><h>11:11</h><w>Matthew Davidson (kingmob)</w><a>@jjttjj</a> OK, after a bit of digging, I found the issue. Jepsen is being deployed to Maven as an uberjar, which means it comes bundled with its own versions of byte-streams and manifold. If you check with <code>clj -Spath</code>, you can see it precedes the actual manifold dep in the classpath, making later specified lib jars irrelevant.

I once debugged the same issue with Lein, and in that case, it handed off the deps to Maven, and got a set of jars. I don‚Äôt recall if Maven or Lein was at fault, but both effectively assume the jars‚Äô classes were disjoint. I‚Äôm saddened/annoyed/unsurprised to see tools.deps have the same flaw.

I‚Äôll open an issue with aphyr, in case this isn‚Äôt intended behavior, and for you, maybe using a git coordinate, or downloading the jepsen code and using a local coordinate will work?</z><z id="t1653012296" t="lilactown I&apos;m returning a stream as the body of a handler. I&apos;m noticing that streaming the results seems to hang until a certain amount of content is put into the stream"><y>#</y><d>2022-05-20</d><h>02:04</h><w>lilactown</w>I&apos;m returning a stream as the body of a handler. I&apos;m noticing that streaming the results seems to hang until a certain amount of content is put into the stream</z><z id="t1653012363" t="lilactown e.g. (defn handler [req] (let [stream (s/stream)] (doseq [i (range 0 100)] (s/put! stream i)) (d/future (Thread/sleep 4000) (s/close! stream)) {:status 200 :headers {&quot;content-type&quot; &quot;text/plain&quot;} :body stream}))"><y>#</y><d>2022-05-20</d><h>02:06</h><w>lilactown</w>e.g.
<pre>(defn handler [req]
  (let [stream (s/stream)]
    (doseq [i (range 0 100)]
      (s/put! stream i))
    (d/future
     (Thread/sleep 4000)
     (s/close! stream))
    {:status 200
     :headers {&quot;content-type&quot; &quot;text/plain&quot;}
     :body stream}))</pre></z><z id="t1653012496" t="lilactown this will wait until the stream is closed (4 seconds later) to send the content to the client"><y>#</y><d>2022-05-20</d><h>02:08</h><w>lilactown</w>this will wait until the stream is closed (4 seconds later) to send the content to the client</z><z id="t1653012528" t="lilactown I&apos;d like to be able to flush it manually, ideally. is there a way to do that?"><y>#</y><d>2022-05-20</d><h>02:08</h><w>lilactown</w>I&apos;d like to be able to flush it manually, ideally. is there a way to do that?</z><z id="t1653046355" t="Matthew Davidson (kingmob) Hmm, well there are some flush fns in aleph.netty , but they‚Äôre not really designed to be used directly. I‚Äôll take a closer look at the delay in the next few days, it kind of defeats the point of a streaming server if it can‚Äôt, ya know, stream üòÑ"><y>#</y><d>2022-05-20</d><h>11:32</h><r>Matthew Davidson (kingmob)</r>Hmm, well there are some flush fns in <code>aleph.netty</code>, but they‚Äôre not really designed to be used directly.

I‚Äôll take a closer look at the delay in the next few days, it kind of defeats the point of a streaming server if it can‚Äôt, ya know, stream <b>üòÑ</b></z><z id="t1653057271" t="lilactown yeah. if I shove a bunch more data down the pipe (e.g. 1000 numbers) then it will send it to the client quickly, and keep the connection open until the stream closes, which is what I want"><y>#</y><d>2022-05-20</d><h>14:34</h><r>lilactown</r>yeah. if I shove a bunch more data down the pipe (e.g. 1000 numbers) then it will send it to the client quickly, and keep the connection open until the stream closes, which is what I want</z><z id="t1653084742" t="lilactown this might actually be a safari issue. I don&apos;t see the same behavior on chrome"><y>#</y><d>2022-05-20</d><h>22:12</h><r>lilactown</r>this might actually be a safari issue. I don&apos;t see the same behavior on chrome</z><z id="t1653084754" t="lilactown so it might be safari that is waiting to render the results"><y>#</y><d>2022-05-20</d><h>22:12</h><r>lilactown</r>so it might be safari that is waiting to render the results</z><z id="t1653084900" t="lilactown ah yep https://stackoverflow.com/questions/33464381/safari-render-html-as-received"><y>#</y><d>2022-05-20</d><h>22:15</h><r>lilactown</r>ah yep <a href="https://stackoverflow.com/questions/33464381/safari-render-html-as-received" target="_blank">https://stackoverflow.com/questions/33464381/safari-render-html-as-received</a></z><z id="t1653084917" t="lilactown &gt; Ok in order for Safari to render the html at least 1024 bytes have to be written before it starts to render as received. üÜí"><y>#</y><d>2022-05-20</d><h>22:15</h><r>lilactown</r>&gt; Ok in order for Safari to render the html at least 1024 bytes have to be written before it starts to render as received.
<b>üÜí</b></z><z id="t1653105654" t="Matthew Davidson (kingmob) Ahh, good ol‚Äô SafarIE"><y>#</y><d>2022-05-21</d><h>04:00</h><r>Matthew Davidson (kingmob)</r>Ahh, good ol‚Äô SafarIE</z><z id="t1653388481" t="Matthew Davidson (kingmob) Aleph 0.5.0-rc1 is available. It comes with many, many bugfixes, see the change log for more. https://github.com/clj-commons/aleph/blob/master/CHANGES.md There probably won‚Äôt be any new features before releasing 0.5.0, other than adding better support for Netty‚Äôs custom ThreadLocal Threads by updating to the latest Manifold version."><y>#</y><d>2022-05-24</d><h>10:34</h><w>Matthew Davidson (kingmob)</w>Aleph 0.5.0-rc1 is available. It comes with many, many bugfixes, see the change log for more. <a href="https://github.com/clj-commons/aleph/blob/master/CHANGES.md" target="_blank">https://github.com/clj-commons/aleph/blob/master/CHANGES.md</a>
There probably won‚Äôt be any new features before releasing 0.5.0, other than adding better support for Netty‚Äôs custom ThreadLocal Threads by updating to the latest Manifold version.</z><z id="t1653391388" t="delaguardo hi! any chance to include https://github.com/clj-commons/aleph/pull/521 into 0.5.0?"><y>#</y><d>2022-05-24</d><h>11:23</h><w>delaguardo</w>hi! any chance to include <a href="https://github.com/clj-commons/aleph/pull/521" target="_blank">https://github.com/clj-commons/aleph/pull/521</a> into 0.5.0?</z><z id="t1653403748" t="Matthew Davidson (kingmob) Hey. [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] was working on oleksii‚Äôs old error handling branch, he might have some thoughts. That being said, 0.5.0 has a bunch of stuff already, and I prefer smaller releases, so maybe for 0.5.1. "><y>#</y><d>2022-05-24</d><h>14:49</h><w>Matthew Davidson (kingmob)</w>Hey. <a>@arnaudgeiser</a> was working on oleksii‚Äôs old error handling branch, he might have some thoughts.

That being said, 0.5.0 has a bunch of stuff already, and I prefer smaller releases, so maybe for 0.5.1. </z><z id="t1653404125" t="Matthew Davidson (kingmob) One knock against that specific PR is, it changes the signature of public fns in non-backwards-compatible ways. It&apos;s probably past time to make a 1-arity map version of many of these fns, to better support new options. "><y>#</y><d>2022-05-24</d><h>14:55</h><w>Matthew Davidson (kingmob)</w>One knock against that specific PR is, it changes the signature of public fns in non-backwards-compatible ways. It&apos;s probably past time to make a 1-arity map version of many of these fns, to better support new options. </z><z id="t1653415151" t="Arnaud Geiser Hi [:attrs {:href &quot;/_/_/users/U04V4KLKC&quot;}] ! We already brought back some changes from the old error handling branch. Maybe the next step would be to tackle the error-handler (or error-logger ) as it&apos;s unlikely we&apos;ll ever merge the old error handling branch at once. Unfortunately, I don&apos;t have a lot of time to spend on it during the two following weeks but that&apos;s definitely something we can prioritize on the next Aleph version (0.5.1)."><y>#</y><d>2022-05-24</d><h>17:59</h><w>Arnaud Geiser</w>Hi <a>@delaguardo</a>!
We already brought back some changes from the old error handling branch.
Maybe the next step would be to tackle the <code>error-handler</code> (or <code>error-logger</code> ) as it&apos;s unlikely we&apos;ll ever merge the old error handling branch
at once. Unfortunately, I don&apos;t have a lot of time to spend on it during the two following weeks but that&apos;s definitely something we can
prioritize on the next Aleph version (0.5.1).</z><z id="t1653574595" t="Matthew Davidson (kingmob) Aleph 0.5.0-rc2 is now available. Everyone, please kick the tires. The only addition is Aleph now defaults to Netty‚Äôs FastThreadLocalThread (I hate Java naming sometimes), so some things should be faster under the hood. https://clojars.org/aleph/versions/0.5.0-rc2"><y>#</y><d>2022-05-26</d><h>14:16</h><w>Matthew Davidson (kingmob)</w>Aleph 0.5.0-rc2 is now available. Everyone, please kick the tires. The only addition is Aleph now defaults to Netty‚Äôs FastThreadLocalThread (I hate Java naming sometimes), so some things should be faster under the hood. <a href="https://clojars.org/aleph/versions/0.5.0-rc2" target="_blank">https://clojars.org/aleph/versions/0.5.0-rc2</a></z><z id="t1655066724" t="Eugen any idea on how I can log the requests and responses I get via aleph client ? I can&apos;t seem to figure this out based on the docs. I&apos;ve tried several combinations, including: (netty/set-logger! :slf4j) (def conn-pool (http/connection-pool {:connection-options {:log-activity :trace} :log-activity :trace})) and using this like: req (merge {:method :get :pool conn-pool :url url} opts) I can see my log messages but nothing from aleph http client p.s. I am willing to improve the docs for this"><y>#</y><d>2022-06-12</d><h>20:45</h><w>Eugen</w>any idea on how I can log the requests and responses I get via aleph client ?
I can&apos;t seem to figure this out based on the docs.

I&apos;ve tried several combinations, including:
<pre>(netty/set-logger! :slf4j)

(def conn-pool (http/connection-pool {:connection-options {:log-activity :trace}
                                      :log-activity :trace}))
and using this like:

   req (merge {:method :get
                    :pool conn-pool
                    :url url} opts)</pre>
I can see my log messages but nothing from aleph http client
p.s. I am willing to improve the docs for this</z><z id="t1655066877" t="jcf One simple approach is to compose functions on to the deferred response. Something like this: (manifold.deferred/chain (http/request req) (fn [response] (log/info :response response) response))"><y>#</y><d>2022-06-12</d><h>20:47</h><r>jcf</r>One simple approach is to compose functions on to the deferred response. Something like this:

<pre>(manifold.deferred/chain (http/request req) (fn [response] (log/info :response response) response))</pre></z><z id="t1655066930" t="jcf I often convert my responses into a map of request and response in all cases to make testing and debugging easier using a similar approach."><y>#</y><d>2022-06-12</d><h>20:48</h><r>jcf</r>I often convert my responses into a map of request and response in all cases to make testing and debugging easier using a similar approach.</z><z id="t1655067346" t="Eugen thanks, but I might be doing something wrong, because it does not work for me"><y>#</y><d>2022-06-12</d><h>20:55</h><r>Eugen</r>thanks, but I might be doing something wrong, because it does not work for me</z><z id="t1655067411" t="Eugen (try+ (let [res (-&gt; @(d/chain (http/request req) (fn [response] (log/info &quot;WHAAAA &quot; :response response) response))) body (:body res)] (log/info &quot;Writing statement to file&quot; file) (bs/transfer body file)) I can see &quot;Writing statement&quot; line but nothing for the manifold chain"><y>#</y><d>2022-06-12</d><h>20:56</h><r>Eugen</r><pre>(try+
     (let [res (-&gt; @(d/chain (http/request req)
                             (fn [response] (log/info &quot;WHAAAA &quot; :response response) response)))
           body (:body res)]
       (log/info &quot;Writing statement to file&quot; file)
       (bs/transfer body file))</pre>
I can see &quot;Writing statement&quot; line but nothing for the manifold chain</z><z id="t1655069793" t="Eugen so it seems to work but I was looking for the logs in the wrong window"><y>#</y><d>2022-06-12</d><h>21:36</h><r>Eugen</r>so it seems to work but I was looking for the logs in the wrong window</z><z id="t1655069832" t="jcf I was about to ask about log configuration and tooling. Glad to hear you&apos;ve found the output. üôÇ"><y>#</y><d>2022-06-12</d><h>21:37</h><r>jcf</r>I was about to ask about log configuration and tooling. Glad to hear you&apos;ve found the output. <b>üôÇ</b></z><z id="t1655111271" t="Eugen yeah, the experience is not great (being gentle). I&apos;ll see if I can improve it somehow (docs at least)"><y>#</y><d>2022-06-13</d><h>09:07</h><r>Eugen</r>yeah, the experience is not great (being gentle). I&apos;ll see if I can improve it somehow (docs at least)</z><z id="t1655111279" t="Eugen thanks for the help üôÇ"><y>#</y><d>2022-06-13</d><h>09:07</h><r>Eugen</r>thanks for the help <b>üôÇ</b></z><z id="t1655190082" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U011NGC5FFY&quot;}] doc improvements are always welcome. Maybe it belongs in examples/ ?"><y>#</y><d>2022-06-14</d><h>07:01</h><r>Matthew Davidson (kingmob)</r><a>@U011NGC5FFY</a> doc improvements are always welcome. Maybe it belongs in <code>examples/</code>?</z><z id="t1655190377" t="Eugen there was some logging in the repl output window and some (from timbre) in the calva output file. that was a bit confusing. I was checking only calva output file"><y>#</y><d>2022-06-14</d><h>07:06</h><r>Eugen</r>there was some logging in the repl output window and some (from timbre) in the calva output file.
that was a bit confusing. I was checking only calva output file</z><z id="t1657125359" t="Javier Pereira Hi, I can&apos;t seem to read off a web socket using deferred/loop or consume. Web socket seems to stop buffering new values or closes the socket? When it stops buffering the connection is still opened, not drained and has a pending take. Using aleph 0.4.6 and manifold 0.1.8 I&apos;ve tried the latest releases of these as well without success. Namespace if you want to try it out: (ns somenamespace (:gen-class) (:require [aleph.http :as http] [manifold.stream :as s] [manifold.deferred :as d] [cheshire.core :refer [encode decode]])) Subscribe message and connect functions: (defn submsg [topic symbol &amp; {:keys [encoded?] :or {encoded? true}}] &quot;subscribe message&quot; (let [ msg {&quot;topic&quot; (if (keyword? topic) (name topic) topic) &quot;event&quot; &quot;sub&quot; &quot;params&quot; {&quot;binary&quot; false &quot;symbol&quot; symbol}}] (if encoded? (encode msg) msg) )) (defn on-connect [sock] (println &quot;Connected.&quot;) sock) (defn on-close [sock] (s/on-closed sock #(println &quot;ws-closed.&quot;)) sock) (defn ws-connect [uri] &quot;Connect to web socket&quot; (let [options {:insecure? false :max-frame-payload (* 10 65536) :max-frame-size (* 10 1048567)} sock @(http/websocket-client uri options)] (-&gt; sock on-connect on-close) sock)) At the repl connect and subscribe with: (def ws (ws-connect &quot;&quot;)) (s/put! ws (submsg :trade &quot;BTCUSDT&quot;)) Then repeatedly evaluating the following from the repl works as expected, the buffer goes to zero, new data keeps arriving, keeps printing: (do (prn &quot;buffer-size: &quot; (:buffer-size (:source (s/description ws)))) (s/take! ws ::Closed)) However loop seems to stop buffering new values after printing the values in socket source buffer: (d/loop [] (-&gt; (s/take! ws ::Closed) (d/chain #(do (println (str &quot;buffer-size AfterTake: &quot; (:buffer-size (:source (s/description ws))))) (println (str %)) (if-not (= ::Closed %) (d/recur)))) (d/catch (fn [ex] (println (str &quot;ERROR: &quot; ex)) (s/close! ws))))) and this closes the socket after printing one value: (s/consume-async #((prn &apos;message! (str %)) true) ws) Use these to view ws state and close socket: (s/description ws) (s/close! ws) I&apos;ve tried different library versions, consume, consume-async, frame-size, frame payload and different take! loop recur implementations. No idea what else to do? Any help would be very much appreciated!"><y>#</y><d>2022-07-06</d><h>16:35</h><w>Javier Pereira</w>Hi, I can&apos;t seem to read off a web socket using deferred/loop or consume. Web socket seems to stop buffering new values or closes the socket? When it stops buffering the connection is still opened, not drained and has a pending take. Using aleph 0.4.6 and manifold 0.1.8 I&apos;ve tried the latest releases of these as well without success.

Namespace if you want to try it out:
<pre>(ns somenamespace
  (:gen-class)
  (:require
   [aleph.http :as http]
   [manifold.stream :as s]
   [manifold.deferred :as d]
   [cheshire.core :refer [encode decode]]))</pre>
Subscribe message and connect functions:
<pre>(defn submsg [topic symbol &amp; {:keys [encoded?] :or {encoded? true}}]
  &quot;subscribe message&quot;
  (let [ msg {&quot;topic&quot; (if (keyword? topic) (name topic) topic)
              &quot;event&quot; &quot;sub&quot;
              &quot;params&quot; {&quot;binary&quot; false
                        &quot;symbol&quot; symbol}}]
    (if encoded? (encode msg) msg)
    ))

(defn on-connect [sock]
  (println &quot;Connected.&quot;)
  sock)

(defn on-close [sock]
  (s/on-closed sock #(println &quot;ws-closed.&quot;))
  sock)

(defn ws-connect [uri]
  &quot;Connect to web socket&quot;
  (let [options {:insecure? false
                 :max-frame-payload (* 10 65536)
                 :max-frame-size (* 10 1048567)}
        sock @(http/websocket-client uri options)]
    (-&gt; sock
        on-connect
        on-close)
    sock))</pre>
At the repl connect and subscribe with:
<pre>(def ws (ws-connect &quot;&quot;))
(s/put! ws (submsg :trade &quot;BTCUSDT&quot;))</pre>
Then repeatedly evaluating the following from the repl works as expected, the buffer goes to zero, new data keeps arriving, keeps printing:
<pre>(do (prn &quot;buffer-size: &quot; (:buffer-size (:source (s/description ws))))
      (s/take! ws ::Closed))</pre>
However loop seems to stop buffering new values after printing the values in socket source buffer:
<pre>(d/loop []
    (-&gt; (s/take! ws ::Closed)
        (d/chain
         #(do (println (str &quot;buffer-size AfterTake: &quot; (:buffer-size (:source (s/description ws)))))
              (println (str %))
              (if-not (= ::Closed %)
                (d/recur))))

        (d/catch
         (fn [ex]
           (println (str &quot;ERROR: &quot; ex))
           (s/close! ws)))))</pre>
and this closes the socket after printing one value:
<pre>(s/consume-async #((prn &apos;message! (str %)) true) ws)</pre>
Use these to view ws state and close socket:
<pre>(s/description ws)
(s/close! ws)</pre>
 I&apos;ve tried different library versions, consume, consume-async, frame-size, frame payload  and different take! loop recur implementations. No idea what else to do? Any help would be very much appreciated!</z><z id="t1657179719" t="Matthew Davidson (kingmob) Hi [:attrs {:href &quot;/_/_/users/U02SN4RR82C&quot;}] . You have a few issues going on at once, but the main one is buffering pauses because it‚Äôs not needed. First, d/loop . This behavior seems expected to me. The only effect buffering should have here is to allow the websocket stream to accumulate some data before you start take! ing. If you open the ws and subscribe, but don‚Äôt do any take! s, the buffer will fill up. When you start the d/loop , it will print out all the buffered values very fast, and then slow down to the actual rate of incoming messages. The buffer is empty because it doesn‚Äôt need to buffer; messages are processed faster than they come in. Check the v values, they‚Äôre sequential, so no trades are being missed (Though, if you wait too long to start taking, the buffer may fill up, and messages will be missed then, but that‚Äôs not a bug). Otherwise d/loop seems to work for me. It goes into an infinite loop of printing trades as they come. I‚Äôm not seeing any disconnections. There might be something rate- or load-sensitive that I‚Äôm not seeing from my timezone. Another possibility to consider is network flakiness. The Bybits docs say that to prevent network timeouts, you should https://bybit-exchange.github.io/docs/spot/#t-heartbeat . See the heartbeats config option in Aleph for more on that (or send them in your own separate thread if you like). Second, consume-async . Your code has a bug. The anonymous fn literal #() has a few limitations, one of which is that it has to be a single valid form. You have to wrap in a do like you do inside the d/loop . Better still, switch to fn , #() is meant to be for short one-liners. Once I wrapped it in a do , consumer-async also works as expected, an inifinte loop of messages. Given the message sizes, I don‚Äôt think increasing the max frame parameters should have an effect here. I checked this with both 0.4.6 and the latest 0.5.0-rc2, same behavior in both cases."><y>#</y><d>2022-07-07</d><h>07:41</h><w>Matthew Davidson (kingmob)</w>Hi <a>@pereira.cj</a>. You have a few issues going on at once, but the main one is buffering pauses because it‚Äôs not needed.

First, <code>d/loop</code>. This behavior seems expected to me. The only effect buffering should have here is to allow the websocket stream to accumulate some data before you start <code>take!</code>ing. If you open the ws and subscribe, but don‚Äôt do any <code>take!</code>s, the buffer will fill up. When you start the <code>d/loop</code>, it will print out all the buffered values very fast, and then slow down to the actual rate of incoming messages. The buffer is empty because it doesn‚Äôt need to buffer; messages are processed faster than they come in. Check the <code>v</code> values, they‚Äôre sequential, so no trades are being missed (Though, if you wait too long to start taking, the buffer may fill up, and messages will be missed then, but that‚Äôs not a bug).

Otherwise <code>d/loop</code>  seems to work for me. It goes into an infinite loop of printing trades as they come. I‚Äôm not seeing any disconnections. There might be something rate- or load-sensitive that I‚Äôm not seeing from my timezone. Another possibility to consider is network flakiness. The Bybits docs say that to prevent network timeouts, you should <a href="https://bybit-exchange.github.io/docs/spot/#t-heartbeat" target="_blank">https://bybit-exchange.github.io/docs/spot/#t-heartbeat</a>. See the <code>heartbeats</code> config option in Aleph for more on that (or send them in your own separate thread if you like).

Second, <code>consume-async</code>. Your code has a bug. The anonymous fn literal <code>#()</code> has a few limitations, one of which is that it has to be a single valid form. You have to wrap in a <code>do</code> like you do inside the <code>d/loop</code>. Better still, switch to <code>fn</code>, <code>#()</code> is meant to be for short one-liners.  Once I wrapped it in a <code>do</code>, <code>consumer-async</code> also works as expected, an inifinte loop of messages.

Given the message sizes, I don‚Äôt think increasing the max frame parameters should have an effect here.

I checked this with both 0.4.6 and the latest 0.5.0-rc2, same behavior in both cases.</z><z id="t1657219433" t="Javier Pereira Thanks [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] , your buffering explanation makes sense however once the initial buffer is cleared the d/loop stops printing messages eg: message! &quot;{\&quot;topic\&quot;:\&quot;trade\&quot;,\&quot;event\&quot;:\&quot;sub\&quot;,\&quot;params\&quot;:{\&quot;symbol\&quot;:\&quot;BTCUSDT\&quot;,\&quot;binary\&quot;:\&quot;false\&quot;,\&quot;symbolName\&quot;:\&quot;BTCUSDT\&quot;},\&quot;code\&quot;:\&quot;0\&quot;,\&quot;msg\&quot;:\&quot;Success\&quot;}&quot; message! &quot;{\&quot;topic\&quot;:\&quot;trade\&quot;,\&quot;params\&quot;:{\&quot;symbol\&quot;:\&quot;BTCUSDT\&quot;,\&quot;binary\&quot;:\&quot;false\&quot;,\&quot;symbolName\&quot;:\&quot;BTCUSDT\&quot;},\&quot;data\&quot;:{\&quot;v\&quot;:\&quot;2290000000006808487\&quot;,\&quot;t\&quot;:1657216191559,\&quot;p\&quot;:\&quot;20906.82\&quot;,\&quot;q\&quot;:\&quot;0.001099\&quot;,\&quot;m\&quot;:true}}&quot; #&lt;Deferred@76fbe620: :not-delivered&gt; I am aware of the heartbeat, the connection stays open long enough for now, I&apos;ll add it later. Yes I am new to clojure! thanks for the #() tip now the consume-async has the same behaviour as the d/loop i.e. no messages are ever printed after the buffer is cleared. Yeah i didn&apos;t think the max frame parameters would affect it but was trying everything! You got me thinking though, I am running in a container and using graalvm. Tried switching to the clojure image, it didn&apos;t help. The connection stays open unless you wait too long which is expected. Not really sure what to do next, I can sit at the repl and eval takes! forever and everything is fine until I use a d/loop or consume-async at which point the fun stops and nothing happens. Unless i s/close! the connection which prints the close message as expected."><y>#</y><d>2022-07-07</d><h>18:43</h><r>Javier Pereira</r>Thanks <a>@U10EC98F5</a>, your buffering explanation makes sense however once the initial buffer is cleared the <code>d/loop</code> stops printing messages eg:

message! &quot;{\&quot;topic\&quot;:\&quot;trade\&quot;,\&quot;event\&quot;:\&quot;sub\&quot;,\&quot;params\&quot;:{\&quot;symbol\&quot;:\&quot;BTCUSDT\&quot;,\&quot;binary\&quot;:\&quot;false\&quot;,\&quot;symbolName\&quot;:\&quot;BTCUSDT\&quot;},\&quot;code\&quot;:\&quot;0\&quot;,\&quot;msg\&quot;:\&quot;Success\&quot;}&quot;
message! &quot;{\&quot;topic\&quot;:\&quot;trade\&quot;,\&quot;params\&quot;:{\&quot;symbol\&quot;:\&quot;BTCUSDT\&quot;,\&quot;binary\&quot;:\&quot;false\&quot;,\&quot;symbolName\&quot;:\&quot;BTCUSDT\&quot;},\&quot;data\&quot;:{\&quot;v\&quot;:\&quot;2290000000006808487\&quot;,\&quot;t\&quot;:1657216191559,\&quot;p\&quot;:\&quot;20906.82\&quot;,\&quot;q\&quot;:\&quot;0.001099\&quot;,\&quot;m\&quot;:true}}&quot;
#&lt;Deferred@76fbe620: :not-delivered&gt;

I am aware of the heartbeat, the connection stays open long enough for now, I&apos;ll add it later. Yes I am new to clojure! thanks for the #() tip now the <code>consume-async</code> has the same behaviour as the <code>d/loop</code> i.e. no messages are ever printed after the buffer is cleared. Yeah i didn&apos;t think the max frame parameters would affect it but was trying everything!

You got me thinking though, I am running in a container and using graalvm.
Tried switching to the clojure image, it didn&apos;t help.

The connection stays open unless you wait too long which is expected.
Not really sure what to do next, I can sit at the repl and eval <code>takes!</code> forever and everything is fine until I use a <code>d/loop</code> or <code>consume-async</code> at which point the fun stops and nothing happens. Unless i <code>s/close!</code> the connection which prints the close message as expected.</z><z id="t1657246924" t="Matthew Davidson (kingmob) Hmmm. First, I would try removing Graal and Docker from the situation entirely, just to simplify the problem. I&apos;m not certain Graal, in particular, is 100% compatible with Aleph yet. My next guess is it&apos;s related to logging config somehow. It sounds like logging on other threads goes somewhere else; is there another file to check? If takes are available immediately, they can be processed on the same thread, but if not, a callback is scheduled and that&apos;s almost always run on a background thread. This might be one difference between the buffered up mesgs, and new mesgs. One way to test that is not to hunt around for logs, but to append mesgs to an atom as they come in. That won&apos;t be affected by logging config. If the number of messages keeps growing after the initial buffered messages, then you know it&apos;s just a logging problem. "><y>#</y><d>2022-07-08</d><h>02:22</h><r>Matthew Davidson (kingmob)</r>Hmmm. First, I would try removing Graal and Docker from the situation entirely, just to simplify the problem. I&apos;m not certain Graal, in particular, is 100% compatible with Aleph yet. 

My next guess is it&apos;s related to logging config somehow. It sounds like logging on other threads goes somewhere else; is there another file to check?

If takes are available immediately, they can be processed on the same thread, but if not, a callback is scheduled and that&apos;s almost always run on a background thread. This might be one difference between the buffered up mesgs, and new mesgs. 

One way to test that is not to hunt around for logs, but to append mesgs to an atom as they come in. That won&apos;t be affected by logging config. If the number of messages keeps growing after the initial buffered messages, then you know it&apos;s just a logging problem. </z><z id="t1657247124" t="Matthew Davidson (kingmob) One of the Graal issues I recall was related to statically-initialized threads being a problem for Graal. There may be some threads missing, which may or may not be fixed with a Graal command line param. Check the GitHub issues. But try removing Graal first üòÑ"><y>#</y><d>2022-07-08</d><h>02:25</h><r>Matthew Davidson (kingmob)</r>One of the Graal issues I recall was related to statically-initialized threads being a problem for Graal. There may be some threads missing, which may or may not be fixed with a Graal command line param. Check the GitHub issues. 

But try removing Graal first <b>üòÑ</b></z><z id="t1657299397" t="Javier Pereira I tried your logging to an atom suggestion first and it works. Which means it&apos;s been working all along (with graal in a container) only the println was lost to the abyss. Just like the atom I would have thought stdout would be the same on any thread but clearly that is not the case. Thanks so much for your suggestions! I&apos;ll keep them in mind in case I encounter more resistance. Thanks again! üëç"><y>#</y><d>2022-07-08</d><h>16:56</h><r>Javier Pereira</r>I tried your logging to an atom suggestion first and it works. Which means it&apos;s been working all along (with graal in a container) only the <code>println</code> was lost to the abyss. Just like the atom I would have thought <code>stdout</code> would be the same on any thread but clearly that is not the case.

Thanks so much for your suggestions! I&apos;ll keep them in mind in case I encounter more resistance.
Thanks again!<b>üëç</b></z><z id="t1657348696" t="Matthew Davidson (kingmob) Logging in Java (and by extension, Clojure) is way more complicated than it ought to be. If you don‚Äôt want to learn the intricacies of logback.xml just yet, give the Timbre logging lib a try. One major issue with bare println is it‚Äôs not multi-thread friendly (one line might print in the middle of another line). Still, I can‚Äôt recall ever seeing println fail to display anything from other threads before. Exceptions getting swallowed by the default exception handler on other threads, yes, but never println. Not sure if that‚Äôs a Graal thing or not‚Ä¶ Anyway, glad to hear it‚Äôs all working"><y>#</y><d>2022-07-09</d><h>06:38</h><r>Matthew Davidson (kingmob)</r>Logging in Java (and by extension, Clojure) is way more complicated than it ought to be. If you don‚Äôt want to learn the intricacies of logback.xml just yet, give the Timbre logging lib a try. One major issue with bare println is it‚Äôs not multi-thread friendly (one line might print in the middle of another line). Still, I can‚Äôt recall ever seeing println fail to display anything from other threads before. Exceptions getting swallowed by the default exception handler on other threads, yes, but never println. Not sure if that‚Äôs a Graal thing or not‚Ä¶

Anyway, glad to hear it‚Äôs all working</z><z id="t1657179923" t="Matthew Davidson (kingmob) (Minor note, since you seem to be newish to Clojure: fn docstrings go before the param vector. The reverse still works, since it‚Äôs an unused string literal evaluation, but your docstring won‚Äôt be picked up)"><y>#</y><d>2022-07-07</d><h>07:45</h><w>Matthew Davidson (kingmob)</w>(Minor note, since you seem to be newish to Clojure: fn docstrings go before the param vector. The reverse still works, since it‚Äôs an unused string literal evaluation, but your docstring won‚Äôt be picked up)</z><z id="t1657181934" t="Matthew Davidson (kingmob) https://clojars.org/aleph/versions/0.5.0-rc3 is out. This includes some minor changes to better handle callbacks running on non-Clojure threads, potentially without an app classloader in the chain."><y>#</y><d>2022-07-07</d><h>08:18</h><w>Matthew Davidson (kingmob)</w><a href="https://clojars.org/aleph/versions/0.5.0-rc3" target="_blank">https://clojars.org/aleph/versions/0.5.0-rc3</a> is out. This includes some minor changes to better handle callbacks running on non-Clojure threads, potentially without an app classloader in the chain.</z><z id="t1657202307" t="Matthew Davidson (kingmob) Dirigiste 1.0.2 is out. I know nobody uses it directly, but it would be very helpful if people could test out the new version with Aleph https://clojars.org/org.clj-commons/dirigiste/versions/1.0.2 It includes several changes from [:attrs {:href &quot;/_/_/users/U6JH2LEKT&quot;}]"><y>#</y><d>2022-07-07</d><h>13:58</h><w>Matthew Davidson (kingmob)</w>Dirigiste 1.0.2 is out. I know nobody uses it directly, but it would be very helpful if people could test out the new version with Aleph <a href="https://clojars.org/org.clj-commons/dirigiste/versions/1.0.2" target="_blank">https://clojars.org/org.clj-commons/dirigiste/versions/1.0.2</a> It includes several changes from <a>@rborer</a></z><z id="t1657202359" t="Matthew Davidson (kingmob) Also, 1.0.1 includes changes from [:attrs {:href &quot;/_/_/users/U45T93RA6&quot;}]"><y>#</y><d>2022-07-07</d><h>13:59</h><w>Matthew Davidson (kingmob)</w>Also, 1.0.1 includes changes from <a>@vemv</a></z><z id="t1657618678" t="Eugen hello, wanted to ask if there is any interest in having an option (in byte-stream I imagine) to convert only a part of the stream to string. The use case is that I would like to limit the number of processed bytes to a specific manageable size: 1-10k and avoid processing the whole buffer. One simple application of this is that in case of errors I get a body back and I would like to print a &quot;preview&quot; of that buffer: first 1-2k characters. I can do it like this: (when-let [body (-&gt; (:body (ex-data e)) bs/to-string)] (log/error &quot;With body&quot; body)) but I still get to process the WHOLE body. In theory that could be 1GB of data. What do you think? I could solve this in a number of ways. One option would be somthing like the SizeLimit InputStream https://zditect.com/code/java/size-limit-inputstream--inputstreamnbsplaquonbspfile-input-outputnbsplaquonbspjava.html . But they all fall a bit short in one way or another."><y>#</y><d>2022-07-12</d><h>09:37</h><w>Eugen</w>hello, wanted to ask if there is any interest in having an option (in byte-stream I imagine) to convert only a part of the stream to string.
The use case is that I would like to limit the number of processed bytes to a specific manageable size: 1-10k and avoid processing the whole buffer.

One simple application of this is that in case of errors I get a body back and I would like to print a &quot;preview&quot; of that buffer: first 1-2k characters.
I can do it like this:
<pre>(when-let [body (-&gt; (:body (ex-data e))
                      bs/to-string)]
    (log/error &quot;With body&quot; body))</pre>
but I still get to process the WHOLE body.
In theory that could be 1GB of data.
What do you think?
I could solve this in a number of ways.
One option would be somthing like the SizeLimit InputStream  <a href="https://zditect.com/code/java/size-limit-inputstream--inputstreamnbsplaquonbspfile-input-outputnbsplaquonbspjava.html" target="_blank">https://zditect.com/code/java/size-limit-inputstream--inputstreamnbsplaquonbspfile-input-outputnbsplaquonbspjava.html</a> .
But they all fall a bit short in one way or another.</z><z id="t1657694070" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U011NGC5FFY&quot;}] bs/to-string is one of the few operations that‚Äôs going to try and consume everything. I‚Äôm not sure what your source is made of, but most of the alternatives are lazier. Consider using to-reader , to-line-seq , or to-char-sequence instead. You can read only as much data as you feel like, and then convert that to a string."><y>#</y><d>2022-07-13</d><h>06:34</h><r>Matthew Davidson (kingmob)</r><a>@U011NGC5FFY</a> <code>bs/to-string</code> is one of the few operations that‚Äôs going to try and consume everything.

I‚Äôm not sure what your source is made of, but most of the alternatives are lazier. Consider using <code>to-reader</code>, <code>to-line-seq</code>, or <code>to-char-sequence</code> instead. You can read only as much data as you feel like, and then convert that to a string.</z><z id="t1657704237" t="Eugen made a PR https://github.com/clj-commons/byte-streams/pull/57 . I think it&apos;s good info."><y>#</y><d>2022-07-13</d><h>09:23</h><r>Eugen</r>made a PR <a href="https://github.com/clj-commons/byte-streams/pull/57" target="_blank">https://github.com/clj-commons/byte-streams/pull/57</a>. I think it&apos;s good info.</z><z id="t1657625369" t="lepistane Is there a way to detect that client disconnected from websocket server?"><y>#</y><d>2022-07-12</d><h>11:29</h><w>lepistane</w>Is there a way to detect that client disconnected from websocket server?</z><z id="t1657649679" t="lepistane how do you guys deal with stale websocket connections? Do you manually clear them or leave it to garbage collection?"><y>#</y><d>2022-07-12</d><h>18:14</h><w>lepistane</w>how do you guys deal with stale websocket connections?
Do you manually clear them or leave it to garbage collection?</z><z id="t1657696320" t="lepistane cross posting here: https://www.reddit.com/r/Clojure/comments/vxc7ta/aleph_can_it_handle_client_disconnect/"><y>#</y><d>2022-07-13</d><h>07:12</h><w>lepistane</w>cross posting here: <a href="https://www.reddit.com/r/Clojure/comments/vxc7ta/aleph_can_it_handle_client_disconnect/" target="_blank">https://www.reddit.com/r/Clojure/comments/vxc7ta/aleph_can_it_handle_client_disconnect/</a></z><z id="t1657698410" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U45SLGVHV&quot;}] You mean, a client that has just fallen silent, instead of sending a WS Close control frame? It‚Äôs usually impossible to distinguish between a client that has died vs one that is technically still active but very slow/delayed. The usual answer is to set an idle timeout, which is the idle-timeout param when starting the server. I can see a zombie client that‚Äôs effectively dead, but still sending heartbeat Ping frames could be a problem (like if a client thread responsible for sending data crashed, but a separate heartbeat thread was still going), so you may need to detect that manually. I haven‚Äôt tested it, but I think the same issue would happen if you told the server to send Pings, but forgot to set the timeout field in heartbeats , in which case the server‚Äôs Ping frames would keep the conn alive, even if it didn‚Äôt get a Pong response. Closing a stream will eventually shut down a WS connection once drained, but if you don‚Äôt want to wait, you can call aleph.http/websocket-close! You shouldn‚Äôt need to manually clear anything. Let GC take care of it if/when it gets to it. Under the hood, Netty pools and reuses a lot of resources to minimize expensive object construction."><y>#</y><d>2022-07-13</d><h>07:46</h><w>Matthew Davidson (kingmob)</w><a>@lepistane</a> You mean, a client that has just fallen silent, instead of sending a WS Close control frame? It‚Äôs usually impossible to distinguish between a client that has died vs one that is technically still active but very slow/delayed. The usual answer is to set an idle timeout, which is the <code>idle-timeout</code> param when starting the server.

I can see a zombie client that‚Äôs effectively dead, but still sending heartbeat Ping frames could be a problem (like if a client thread responsible for sending data crashed, but a separate heartbeat thread was still going), so you may need to detect that manually.

I haven‚Äôt tested it, but I think the same issue would happen if you told the server to send Pings, but forgot to set the <code>timeout</code> field in <code>heartbeats</code>, in which case the server‚Äôs Ping frames would keep the conn alive, even if it didn‚Äôt get a Pong response.



Closing a stream will eventually shut down a WS connection once drained, but if you don‚Äôt want to wait, you can call <code>aleph.http/websocket-close!</code>

You shouldn‚Äôt need to manually clear anything. Let GC take care of it if/when it gets to it. Under the hood, Netty pools and reuses a lot of resources to minimize expensive object construction.</z><z id="t1657700122" t="Matthew Davidson (kingmob) This is your example code, right? (defn handler [conn] (fn [raw-command] (try (let [cmd (-&gt;edn raw-command)] ;;do stuff to conn, stream/put conn type of thing (catch Exception e (timbre/error e &quot;Exception caught in command handler&quot;) (stream/put! conn (-&gt;json {:status :error :message (:cause (Throwable-&gt;map e))}))))))) (defn sub-and-serve [request] (let [twenty-seconds 20000 ten-seconds 10000] (d/let-flow [conn (http/websocket-connection request {:heartbeats {:send-after-idle twenty-seconds :timeout ten-seconds}})] (stream/put! conn (-&gt;json {:message &quot;Events incoming...&quot;})) (stream/consume (handler conn) conn)) nil)) I think the do stuff is hiding something. This server basically sends endless messages to any clients that request it? If so, I can think of one possibility. The current idle state handler only checks to see if both the server and client are idle before shutting it down, but if the servers sends at least one message every 20 seconds, the conn‚Äôs never idle. So really, the question is, what‚Äôs happening on the client side? On reddit, you said: &gt; The thing that bothers me is that when frontend disconnects/closes connection, backend continues to serve those messages to that aleph ws connection. &gt; Frontend is disconnected manually - that‚Äôs fine and expected, but backend continues to put messages into a connection stream. How are you closing the connection on the client side? And what behavior are you seeing? Even if the idle handler isn‚Äôt being triggered, if the client ever sent a Close frame, the server should close that connection pretty quickly"><y>#</y><d>2022-07-13</d><h>08:15</h><w>Matthew Davidson (kingmob)</w>This is your example code, right?
<pre>(defn handler [conn]
  (fn [raw-command]
    (try
      (let [cmd (-&gt;edn raw-command)]
        ;;do stuff to conn, stream/put conn type of thing
        (catch Exception e
          (timbre/error e &quot;Exception caught in command handler&quot;)
          (stream/put! conn (-&gt;json {:status  :error
                                     :message (:cause (Throwable-&gt;map e))})))))))

(defn sub-and-serve [request]
  (let [twenty-seconds 20000
        ten-seconds 10000]
    (d/let-flow [conn (http/websocket-connection request
                                                 {:heartbeats {:send-after-idle twenty-seconds
                                                               :timeout         ten-seconds}})]
                (stream/put! conn (-&gt;json {:message &quot;Events incoming...&quot;}))
                (stream/consume (handler conn) conn))
    nil))</pre>
I think the <code>do stuff</code> is hiding something. This server basically sends endless messages to any clients that request it?

If so, I can think of one possibility. The current idle state handler only checks to see if both the server and client are idle before shutting it down, but if the servers sends at least one message every 20 seconds, the conn‚Äôs never idle.

So really, the question is, what‚Äôs happening on the client side? On reddit, you said:
&gt; The thing that bothers me is that when frontend disconnects/closes connection, backend continues to serve those messages to that aleph ws connection.
&gt; Frontend is disconnected manually - that‚Äôs fine and expected, but backend continues to put messages into a connection stream.
How are you closing the connection on the client side? And what behavior are you seeing? Even if the idle handler isn‚Äôt being triggered, if the client ever sent a Close frame, the server should close that connection pretty quickly</z><z id="t1657701425" t="lepistane [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] This is the whole code, it&apos;s very much WIP and maybe i should&apos;ve been more specific what i am trying to do. I was trying to reduce complexity. I apologize (defn -&gt;json [edn] (json/generate-string edn)) (defn -&gt;edn [json] (json/parse-string json true)) (defn ws-send [sock msg] (timbre/info &quot;Sending message: &quot; msg) (s/put! sock msg)) (defn ws-close [sock] (timbre/info &quot;Closing connection...&quot;) (s/close! sock)) (defstate connections :start (atom {:clients {} :bots {}}) :stop (do (when-let [conns (vals (:clients @connections))] (doseq [c conns] (ws-close c))) (atom {}))) (defn ws-conn [uri &amp; {:keys [on-connect on-msg on-close aleph]}] (let [sock (http/websocket-client uri aleph) handle-messages (fn [sock] (d/chain (s/consume (fn [msg] (on-msg sock msg)) sock) (fn [sock-closed] sock))) handle-shutdown (fn [sock] (let [state (:sink (s/description sock))] (on-close sock {:stat (:websocket-close-code state) :desc (:websocket-close-msg state)})))] (d/chain sock #(doto % on-connect) handle-messages handle-shutdown) @sock)) (defn create-connection &quot;ref: &quot; [conn id {:keys [fixture] :as cmd}] (let [url (get (:game-server-ws config) fixture) json-cmd (-&gt;json cmd)] (when-let [connection (ws-conn url {:on-connect (fn [sock] (timbre/info &quot;Websocket Client Connected.&quot;) (ws-send sock json-cmd)) :on-msg (fn [sock msg] (timbre/info &quot;Passing to client following message: &quot; msg) (stream/put! conn msg)) :on-close (fn [sock msg] (timbre/info &quot;Websocket Client Closed.&quot; msg))})] (swap! connections assoc-in [:clients id] connection)))) (defn handler [conn id] (fn [raw-command] (try (let [cmd (-&gt;edn raw-command)] (if-let [existing-conn (get-in @connections [:clients id])] (ws-send existing-conn (-&gt;json cmd)) (create-connection conn id cmd))) (catch Exception e (timbre/error e &quot;Exception caught in command handler&quot;) (stream/put! conn (-&gt;json {:status :error :message (:cause (Throwable-&gt;map e))})))))) (defn sub-and-serve [request] (let [twenty-seconds 20000 ten-seconds 10000 id (random-uuid)] (d/let-flow [conn (http/websocket-connection request {:heartbeats {:send-after-idle twenty-seconds :timeout ten-seconds :idle-timeout ten-seconds}})] (stream/put! conn (-&gt;json {:message &quot;Events incoming...&quot;})) (stream/consume (handler conn id) conn)) nil)) So i am doing a very naughty thing. I am creating a middleman between frontend and actual backend. I don&apos;t want to change frontend and i don&apos;t want to change backend (that&apos;s a requirement) I want middleman to to connect to backend and wire messages to the frontend. I am using postman to simulate frontend client) The reason why i ask asking about client disconnects is because if i don&apos;t the connections atom will only grow because when i &apos;disconnect&apos; using postman the middleman (code above) doesn&apos;t react. Messages from backend continue coming (and being logged as seen in on-msg I could be going about this in a very wrong way and i am open for suggestions"><y>#</y><d>2022-07-13</d><h>08:37</h><w>lepistane</w><a>@kingmob</a>

This is the whole code, it&apos;s very much WIP and maybe i should&apos;ve been more specific what i am trying to do.
I was trying to reduce complexity. I apologize

<pre>(defn -&gt;json [edn]
  (json/generate-string edn))


(defn -&gt;edn [json]
  (json/parse-string json true))


(defn ws-send [sock msg]
  (timbre/info &quot;Sending message: &quot; msg)
  (s/put! sock msg))


(defn ws-close [sock]
  (timbre/info &quot;Closing connection...&quot;)
  (s/close! sock))


(defstate connections
  :start (atom {:clients {}
                :bots {}})
  :stop (do (when-let [conns (vals (:clients @connections))]
              (doseq [c conns]
                (ws-close c)))
            (atom {})))


(defn ws-conn
  [uri &amp; {:keys [on-connect on-msg on-close aleph]}]
  (let [sock (http/websocket-client uri aleph)
        handle-messages (fn [sock]
                          (d/chain
                            (s/consume (fn [msg] (on-msg sock msg)) sock)
                            (fn [sock-closed] sock)))
        handle-shutdown (fn [sock]
                          (let [state (:sink (s/description sock))]
                            (on-close
                              sock {:stat (:websocket-close-code state)
                                    :desc (:websocket-close-msg state)})))]
    (d/chain sock #(doto % on-connect) handle-messages handle-shutdown)
    @sock))


(defn create-connection
  &quot;ref: &quot;
  [conn id {:keys [fixture] :as cmd}]
  (let [url (get (:game-server-ws config) fixture)
        json-cmd (-&gt;json cmd)]
    (when-let [connection (ws-conn url
                                   {:on-connect (fn [sock]
                                                  (timbre/info &quot;Websocket Client Connected.&quot;)
                                                  (ws-send sock json-cmd))
                                    :on-msg (fn [sock msg]
                                              (timbre/info &quot;Passing to client following message: &quot; msg)
                                              (stream/put! conn msg))
                                    :on-close (fn [sock msg]
                                                (timbre/info &quot;Websocket Client Closed.&quot; msg))})]
      (swap! connections assoc-in [:clients id] connection))))


(defn handler [conn id]
  (fn [raw-command]
    (try
      (let [cmd (-&gt;edn raw-command)]
        (if-let [existing-conn (get-in @connections [:clients id])]
          (ws-send existing-conn (-&gt;json cmd))
          (create-connection conn id cmd)))
      (catch Exception e
        (timbre/error e &quot;Exception caught in command handler&quot;)
        (stream/put! conn (-&gt;json {:status :error
                                   :message (:cause (Throwable-&gt;map e))}))))))


(defn sub-and-serve [request]
  (let [twenty-seconds 20000
        ten-seconds 10000
        id (random-uuid)]
    (d/let-flow [conn (http/websocket-connection request {:heartbeats {:send-after-idle twenty-seconds
                                                                       :timeout ten-seconds
                                                                       :idle-timeout ten-seconds}})]
                (stream/put! conn (-&gt;json {:message &quot;Events incoming...&quot;}))
                (stream/consume (handler conn id) conn))
    nil))</pre>
So i am doing a very naughty thing. I am creating a middleman between frontend and actual backend.
I don&apos;t want to change frontend and i don&apos;t want to change backend (that&apos;s a requirement)
I want middleman to to connect to backend and wire messages to the frontend.

I am using postman to simulate frontend client)

The reason why i ask asking about client disconnects is because if i don&apos;t the connections atom will only grow because when i &apos;disconnect&apos; using postman the middleman (code above) doesn&apos;t react. Messages from backend continue coming (and being logged as seen in <code>on-msg</code>

I could be going about this in a very wrong way and i am open for suggestions</z><z id="t1657704956" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U45SLGVHV&quot;}] So, sub-and-serve and handler serve the frontend, and then create-connection and ws-conn talk to the backend, right? (I think it would help to more clearly separate back and front in this code‚Ä¶) How are you disconnecting with Postman? Are you sending a WS Close frame? I‚Äôve never used it for WS. I can easily see it keeping the connection open indefinitely, by responding to Ping frames the middle sends."><y>#</y><d>2022-07-13</d><h>09:35</h><w>Matthew Davidson (kingmob)</w><a>@lepistane</a> So, <code>sub-and-serve</code> and <code>handler</code> serve the frontend, and then <code>create-connection</code> and <code>ws-conn</code> talk to the backend, right? (I think it would help to more clearly separate back and front in this code‚Ä¶)

How are you disconnecting with Postman? Are you sending a WS Close frame? I‚Äôve never used it for WS. I can easily see it keeping the connection open indefinitely, by responding to Ping frames the middle sends.</z><z id="t1657705260" t="lepistane [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] that&apos;s correct. Noted. There is a button connect/disconnect. I am not sure if it&apos;s sending the WS close frame. Pretty sure it&apos;s not but i couldn&apos;t find confirmation online. I&apos;ve tested using another websocket client and that&apos;s Smart Websocket Client (chrome extension) - behavior is exactly the same as postman."><y>#</y><d>2022-07-13</d><h>09:41</h><w>lepistane</w><a>@kingmob</a> that&apos;s correct. Noted.

There is a button connect/disconnect. I am not sure if it&apos;s sending the WS close frame.
Pretty sure it&apos;s not but i couldn&apos;t find confirmation online.

I&apos;ve tested using another websocket client and that&apos;s Smart Websocket Client (chrome extension) - behavior is exactly the same as postman.</z><z id="t1657717539" t="lepistane Solved (defn sub-and-serve [request] (let [twenty-seconds 20000 ten-seconds 10000 id (random-uuid)] (d/let-flow [conn (http/websocket-connection request {:heartbeats {:send-after-idle twenty-seconds :timeout ten-seconds}})] (stream/on-drained conn (fn [] (timbre/debug &quot;Drained connection: &quot; conn) (timbre/debug &quot;Client disconnected&quot;) ;;reset )) (stream/put! conn (-&gt;json {:message &quot;Events incoming...&quot;})) (stream/consume (handler conn id) conn)) nil)) i needed to put on-drain. That triggers when frontend disconnects."><y>#</y><d>2022-07-13</d><h>13:05</h><w>lepistane</w>Solved

<pre>(defn sub-and-serve [request]
  (let [twenty-seconds 20000
        ten-seconds 10000
        id (random-uuid)]
    (d/let-flow [conn (http/websocket-connection request {:heartbeats {:send-after-idle twenty-seconds
                                                                       :timeout ten-seconds}})]
                (stream/on-drained conn (fn []
                                          (timbre/debug &quot;Drained connection: &quot; conn)
                                          (timbre/debug &quot;Client disconnected&quot;)
                                          ;;reset
                                          ))
                (stream/put! conn (-&gt;json {:message &quot;Events incoming...&quot;}))
                (stream/consume (handler conn id) conn))
    nil))</pre>
i needed to put on-drain. That triggers when frontend disconnects.</z><z id="t1657717695" t="lepistane friend helped i have no idea how he knew about it"><y>#</y><d>2022-07-13</d><h>13:08</h><w>lepistane</w>friend helped i have no idea how he knew about it</z><z id="t1657717702" t="lepistane thanks for your time as well!"><y>#</y><d>2022-07-13</d><h>13:08</h><w>lepistane</w>thanks for your time as well!</z><z id="t1657718081" t="lepistane just wanna mention https://clojars.org/aleph doesn&apos;t have [aleph &quot;0.5.0&quot;] but that&apos;s mentioned on the git [aleph &quot;0.5.0-rc3&quot;] is latest on clojars"><y>#</y><d>2022-07-13</d><h>13:14</h><w>lepistane</w>just wanna mention <a href="https://clojars.org/aleph" target="_blank">https://clojars.org/aleph</a>
doesn&apos;t have [aleph &quot;0.5.0&quot;] but that&apos;s mentioned on the git

[aleph &quot;0.5.0-rc3&quot;] is latest on clojars</z><z id="t1657720113" t="Matthew Davidson (kingmob) I‚Äôm aware, but thx for letting me know. I was in the middle of cutting a 0.5.0 release, but it got delayed by a slow timing bug. The code is pushed to Github (if not, http://cljdoc.org won‚Äôt build docs correctly), but no artifact has been pushed to clojars yet."><y>#</y><d>2022-07-13</d><h>13:48</h><r>Matthew Davidson (kingmob)</r>I‚Äôm aware, but thx for letting me know. I was in the middle of cutting a 0.5.0 release, but it got delayed by a slow timing bug. The code is pushed to Github (if not, <a href="http://cljdoc.org" target="_blank">http://cljdoc.org</a> won‚Äôt build docs correctly), but no artifact has been pushed to clojars yet.</z><z id="t1657719986" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U45SLGVHV&quot;}] Glad to hear your problem is gone! But, are you doing something else in the real on-drained callback (maybe in the ;;reset )? Adding a logging callback itself shouldn‚Äôt fix anything. More worryingly, I would have thought that https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L621-L628 would have taken care of closing it the same way. I might need to look into websocket closing behavior when the underlying streams are closed but websocket-close! isn‚Äôt used."><y>#</y><d>2022-07-13</d><h>13:46</h><w>Matthew Davidson (kingmob)</w><a>@lepistane</a> Glad to hear your problem is gone!

But, are you doing something else in the real <code>on-drained</code> callback (maybe in the <code>;;reset</code>)? Adding a logging callback itself shouldn‚Äôt fix anything.

More worryingly, I would have thought that <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L621-L628" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L621-L628</a> would have taken care of closing it the same way. I might need to look into websocket closing behavior when the underlying streams are closed but <code>websocket-close!</code> isn‚Äôt used.</z><z id="t1657720635" t="lepistane yes yes, i am just closing the connection from the middleman to backend. This is the final version (stream/on-drained conn (fn [] (timbre/debug &quot;Drained connection: &quot; conn) (timbre/debug &quot;Client disconnected: &quot; id) (swap! client-connections (fn [state] (when-let [gs-conn (get state id)] (ws-close gs-conn)) (dissoc state id)))))"><y>#</y><d>2022-07-13</d><h>13:57</h><w>lepistane</w>yes yes, i am just closing the connection from the middleman to backend. This is the final version
<pre>(stream/on-drained conn (fn []
                                          (timbre/debug &quot;Drained connection: &quot; conn)
                                          (timbre/debug &quot;Client disconnected: &quot; id)
                                          (swap! client-connections (fn [state]
                                                                      (when-let [gs-conn (get state id)]
                                                                        (ws-close gs-conn))
                                                                      (dissoc state id)))))</pre></z><z id="t1657721883" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U45SLGVHV&quot;}] Ahh, of course, now it all makes sense. Your issue was the backend ws connections still existed even when the associated frontend ws conns were closed. Is that right? (BTW, I double-checked, and calling manifold.stream/close! on the ws stream works just fine to close it, too.) Anyway, if you want to wire up the frontend ws stream to the backend ws stream in a way that‚Äôs 1) much simpler, and 2) will automatically propagate closing, look into manifold.stream‚Äôs connect and connect-via fns"><y>#</y><d>2022-07-13</d><h>14:18</h><w>Matthew Davidson (kingmob)</w><a>@lepistane</a> Ahh, of course, now it all makes sense. Your issue was the backend ws connections still existed even when the associated frontend ws conns were closed. Is that right?

(BTW, I double-checked, and calling <code>manifold.stream/close!</code> on the ws stream works just fine to close it, too.)

Anyway, if you want to wire up the frontend ws stream to the backend ws stream in a way that‚Äôs 1) much simpler, and 2) will automatically propagate closing, look into manifold.stream‚Äôs <code>connect</code> and <code>connect-via</code> fns</z><z id="t1657723265" t="lepistane Yes that&apos;s right. That&apos;s great ! Thanks i will check it out"><y>#</y><d>2022-07-13</d><h>14:41</h><w>lepistane</w>Yes that&apos;s right.

That&apos;s great !

Thanks i will check it out</z><z id="t1657786706" t="Matthew Davidson (kingmob) Aleph 0.5.0 is now available. It includes many bugfixes, and some speed improvements. Please give it a try! https://clojars.org/aleph/versions/0.5.0 Many thanks to our contributors: Arnaud Geiser, Moritz Heidkamp, Erik Assum, Ivar Refsdal, and Matthew Davidson (me) Changes: ‚Ä¢ Add initial clj-kondo hooks ‚Ä¢ Minor bugfix in examples code ‚Ä¢ Add pipeline-transform test ‚Ä¢ Add missing type hint in websocket-server-handler ‚Ä¢ Correctly handle too large headers/URIs ‚Ä¢ Add doc for undocumented response-executor parameter ‚Ä¢ Minor bugfix for keep-alive? false ‚Ä¢ Fixed major memory leak when sending InputStreams ‚Ä¢ Fixed bug when sending empty files ‚Ä¢ Fix returned filename in multipart uploads for clj-http parity ‚Ä¢ Ensure client exceptions handled and channel closed on invalid input ‚Ä¢ Fix minor bug with redirects and :method key ‚Ä¢ Fix bug in idle state timeouts ‚Ä¢ Disable misleading logs during tests ‚Ä¢ Switch to Netty‚Äôs FastThreadLocalThread for threads ‚Ä¢ Ensure wrap-future callbacks have thread bindings and a full classloader chain ‚Ä¢ Fix minor reflection warning in HttpContentCompressor ctor ‚Ä¢ Add missing direct dependency on Dirigiste"><y>#</y><d>2022-07-14</d><h>08:18</h><w>Matthew Davidson (kingmob)</w>Aleph 0.5.0 is now available. It includes many bugfixes, and some speed improvements. Please give it a try! <a href="https://clojars.org/aleph/versions/0.5.0" target="_blank">https://clojars.org/aleph/versions/0.5.0</a>

Many thanks to our contributors: Arnaud Geiser, Moritz Heidkamp, Erik Assum, Ivar Refsdal, and Matthew Davidson (me)

Changes:
‚Ä¢ Add initial clj-kondo hooks
‚Ä¢ Minor bugfix in examples code
‚Ä¢ Add pipeline-transform test
‚Ä¢ Add missing type hint in websocket-server-handler
‚Ä¢ Correctly handle too large headers/URIs
‚Ä¢ Add doc for undocumented response-executor parameter
‚Ä¢ Minor bugfix for keep-alive? false
‚Ä¢ Fixed major memory leak when sending InputStreams
‚Ä¢ Fixed bug when sending empty files
‚Ä¢ Fix returned filename in multipart uploads for clj-http parity
‚Ä¢ Ensure client exceptions handled and channel closed on invalid input
‚Ä¢ Fix minor bug with redirects and <code>:method</code> key
‚Ä¢ Fix bug in idle state timeouts
‚Ä¢ Disable misleading logs during tests
‚Ä¢ Switch to Netty‚Äôs <code>FastThreadLocalThread</code> for threads
‚Ä¢ Ensure <code>wrap-future</code> callbacks have thread bindings and a full classloader chain
‚Ä¢ Fix minor reflection warning in HttpContentCompressor ctor
‚Ä¢ Add missing direct dependency on Dirigiste</z><z id="t1659036160" t="Ivar Refsdal Great work, and great to see aleph still going strong!"><y>#</y><d>2022-07-28</d><h>19:22</h><r>Ivar Refsdal</r>Great work, and great to see aleph still going strong!</z><z id="t1659091544" t="Matthew Davidson (kingmob) It&apos;s thanks to people like you helping out!"><y>#</y><d>2022-07-29</d><h>10:45</h><r>Matthew Davidson (kingmob)</r>It&apos;s thanks to people like you helping out!</z><z id="t1659200254" t="bpiel Hi. https://github.com/clj-commons/aleph states that: &quot;Aleph exposes data from the network as a https://github.com/clj-commons/manifold stream, which can easily be transformed into a java.io.InputStream &quot; Can anyone tell me how to transform a manifold stream into an InputStream (or an OutputStream)? I&apos;ve worked with aleph and manifold many times over the years, but it seems like I&apos;ve never done this. I&apos;ve read through docs and googled, so I suspect I&apos;m missing something obvious. thanks"><y>#</y><d>2022-07-30</d><h>16:57</h><w>bpiel</w>Hi. <a href="https://github.com/clj-commons/aleph" target="_blank">https://github.com/clj-commons/aleph</a> states that: &quot;Aleph exposes data from the network as a <a href="https://github.com/clj-commons/manifold" target="_blank">https://github.com/clj-commons/manifold</a> stream, which can easily be transformed into a <code>java.io.InputStream</code>&quot;

Can anyone tell me how to transform a manifold stream into an InputStream (or an OutputStream)?

I&apos;ve worked with <code>aleph</code> and <code>manifold</code> many times over the years, but it seems like I&apos;ve never done this. I&apos;ve read through docs and googled, so I suspect I&apos;m missing something obvious. thanks</z><z id="t1659200557" t="dergutemoritz https://github.com/clj-commons/byte-streams would be the idiomatic choice (in the context of aleph at least :))"><y>#</y><d>2022-07-30</d><h>17:02</h><r>dergutemoritz</r><a href="https://github.com/clj-commons/byte-streams" target="_blank">https://github.com/clj-commons/byte-streams</a> would be the idiomatic choice (in the context of aleph at least :))</z><z id="t1659200625" t="bpiel [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] I should have mentioned that I&apos;ve tried that lib out as well, but still have not succeeded"><y>#</y><d>2022-07-30</d><h>17:03</h><r>bpiel</r><a>@U06GVE6NR</a>
I should have mentioned that I&apos;ve tried that lib out as well, but still have not succeeded</z><z id="t1659200635" t="dergutemoritz Oh! How did you try it?"><y>#</y><d>2022-07-30</d><h>17:03</h><r>dergutemoritz</r>Oh! How did you try it?</z><z id="t1659200641" t="bpiel Let&apos;s see"><y>#</y><d>2022-07-30</d><h>17:04</h><r>bpiel</r>Let&apos;s see</z><z id="t1659200704" t="bpiel ok, by &quot;try&quot; I guess I meant that I tried, but failed, to determine (from the docs) which function would be of use here"><y>#</y><d>2022-07-30</d><h>17:05</h><r>bpiel</r>ok, by &quot;try&quot; I guess I meant that I tried, but failed, to determine (from the docs) which function would be of use here</z><z id="t1659200723" t="dergutemoritz Try to-input-stream"><y>#</y><d>2022-07-30</d><h>17:05</h><r>dergutemoritz</r>Try <code>to-input-stream</code></z><z id="t1659200755" t="bpiel haha..........."><y>#</y><d>2022-07-30</d><h>17:05</h><r>bpiel</r>haha...........</z><z id="t1659200776" t="dergutemoritz Too obvious? üòÑ"><y>#</y><d>2022-07-30</d><h>17:06</h><r>dergutemoritz</r>Too obvious? <b>üòÑ</b></z><z id="t1659200777" t="bpiel hmmm... ok, so apparently I did do that already"><y>#</y><d>2022-07-30</d><h>17:06</h><r>bpiel</r>hmmm... ok, so apparently I did do that already</z><z id="t1659200794" t="bpiel which means that I guess I meant to ask how to go the opposite direction"><y>#</y><d>2022-07-30</d><h>17:06</h><r>bpiel</r>which means that I guess I meant to ask how to go the opposite direction</z><z id="t1659200823" t="bpiel but yeah, there was definitely a mismatch between what I was reading/saying and what I wanted to do"><y>#</y><d>2022-07-30</d><h>17:07</h><r>bpiel</r>but yeah, there was definitely a mismatch between what I was reading/saying and what I wanted to do</z><z id="t1659200886" t="dergutemoritz Ah so you want to convert a java.io.OutputStream to a manifold stream instead?"><y>#</y><d>2022-07-30</d><h>17:08</h><r>dergutemoritz</r>Ah so you want to convert a <code>java.io.OutputStream</code> to a manifold stream instead?</z><z id="t1659200902" t="dergutemoritz or what would the opposite direction be?"><y>#</y><d>2022-07-30</d><h>17:08</h><r>dergutemoritz</r>or what would the opposite direction be?</z><z id="t1659200961" t="bpiel I&apos;ll elaborate... I want to connect a TCP port with a UNIX domain socket. I&apos;m trying to use aleph/manifold and junixsocket"><y>#</y><d>2022-07-30</d><h>17:09</h><r>bpiel</r>I&apos;ll elaborate...
I want to connect a TCP port with a UNIX domain socket.
I&apos;m trying to use aleph/manifold and junixsocket</z><z id="t1659201056" t="bpiel the former gives me manifold streams, the latter Input/OutputStreams It seems like I should be able to use manifold.streams/connect to do this (easily?) but I&apos;m stuck not knowing how to turn the java I/OStreams into a manifold stream Does this make any sense?"><y>#</y><d>2022-07-30</d><h>17:10</h><r>bpiel</r>the former gives me manifold streams, the latter Input/OutputStreams
It seems like I should be able to use <code>manifold.streams/connect</code> to do this (easily?) but I&apos;m stuck not knowing how to turn the java I/OStreams into a manifold stream

Does this make any sense?</z><z id="t1659201114" t="bpiel for reference: https://github.com/kohlschutter/junixsocket"><y>#</y><d>2022-07-30</d><h>17:11</h><r>bpiel</r>for reference: <a href="https://github.com/kohlschutter/junixsocket" target="_blank">https://github.com/kohlschutter/junixsocket</a></z><z id="t1659201276" t="dergutemoritz Ah! Perhaps https://github.com/clj-commons/byte-streams#transfers is what you&apos;re looking for then?"><y>#</y><d>2022-07-30</d><h>17:14</h><r>dergutemoritz</r>Ah! Perhaps <a href="https://github.com/clj-commons/byte-streams#transfers" target="_blank">https://github.com/clj-commons/byte-streams#transfers</a> is what you&apos;re looking for then?</z><z id="t1659201329" t="bpiel maybe, lets&apos; see..."><y>#</y><d>2022-07-30</d><h>17:15</h><r>bpiel</r>maybe, lets&apos; see...</z><z id="t1659201368" t="dergutemoritz Hmm but it doesn&apos;t come with an implementation for your case it seems"><y>#</y><d>2022-07-30</d><h>17:16</h><r>dergutemoritz</r>Hmm but it doesn&apos;t come with an implementation for your case it seems</z><z id="t1659201398" t="bpiel yeah, I just tried and didn&apos;t work"><y>#</y><d>2022-07-30</d><h>17:16</h><r>bpiel</r>yeah, I just tried and didn&apos;t work</z><z id="t1659201476" t="bpiel I&apos;m sure I can convert the manifold streams to java streams and then write something simple to move the bytes back and forth... it just seems like this is exactly what aleph/manifold would do easily, so I felt dumb doing it outside aleph/manifold"><y>#</y><d>2022-07-30</d><h>17:17</h><r>bpiel</r>I&apos;m sure I can convert the manifold streams to java streams and then write something simple to move the bytes back and forth...  it just seems like this is exactly what aleph/manifold would do easily, so I felt dumb doing it outside aleph/manifold</z><z id="t1659201649" t="bpiel I&apos;m supposed to take the kids to the pool now, so I need to go.. but thanks for your time and suggestions!"><y>#</y><d>2022-07-30</d><h>17:20</h><r>bpiel</r>I&apos;m supposed to take the kids to the pool now, so I need to go.. but thanks for your time and suggestions!</z><z id="t1659201696" t="dergutemoritz Try (clj-commons.byte-streams/convert your-junixsocket-input-stream (clj-commons.byte-streams/stream-of bytes)) (and likewise with the output stream) and then s/connect them to your aleph stream"><y>#</y><d>2022-07-30</d><h>17:21</h><r>dergutemoritz</r>Try <code>(clj-commons.byte-streams/convert your-junixsocket-input-stream (clj-commons.byte-streams/stream-of bytes))</code> (and likewise with the output stream) and then <code>s/connect</code> them to your aleph stream</z><z id="t1659201740" t="dergutemoritz just not sure if this actually gives you a continuous stream or whether it will block until the io stream closes"><y>#</y><d>2022-07-30</d><h>17:22</h><r>dergutemoritz</r>just not sure if this actually gives you a continuous stream or whether it will block until the io stream closes</z><z id="t1659201866" t="dergutemoritz FWIW, netty also comes with some support for Unix Domain Sockets: https://netty.io/4.1/api/io/netty/channel/unix/DomainSocketChannel.html"><y>#</y><d>2022-07-30</d><h>17:24</h><r>dergutemoritz</r>FWIW, netty also comes with some support for Unix Domain Sockets: <a href="https://netty.io/4.1/api/io/netty/channel/unix/DomainSocketChannel.html" target="_blank">https://netty.io/4.1/api/io/netty/channel/unix/DomainSocketChannel.html</a></z><z id="t1659201891" t="dergutemoritz Maybe using that will make your life a bit easier"><y>#</y><d>2022-07-30</d><h>17:24</h><r>dergutemoritz</r>Maybe using that will make your life a bit easier</z><z id="t1659202138" t="dergutemoritz Ah, you should/could probably use s/splice rather than s/connect above"><y>#</y><d>2022-07-30</d><h>17:28</h><r>dergutemoritz</r>Ah, you should/could probably use <code>s/splice</code> rather than <code>s/connect</code> above</z><z id="t1659202247" t="bpiel Awesome. I will try this all when I get back. Thanks!"><y>#</y><d>2022-07-30</d><h>17:30</h><r>bpiel</r>Awesome. I will try this all when I get back. Thanks!</z><z id="t1659336115" t="Matthew Davidson (kingmob) Late to the party, did you get this sorted out [:attrs {:href &quot;/_/_/users/U4FFD43T4&quot;}] ?"><y>#</y><d>2022-08-01</d><h>06:41</h><r>Matthew Davidson (kingmob)</r>Late to the party, did you get this sorted out <a>@U4FFD43T4</a> ?</z><z id="t1659357516" t="bpiel [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] I ended up doing it outside aleph, which is fine, but any advice would be appreciated. thanks (future (try (loop [] (let [bs @(s/take! s)] (when (-&gt; bs count pos?) (.write fcos bs)) (Thread/yield) (recur))) (catch Throwable ex ex))) (I did something similar to handle the opposite direction)"><y>#</y><d>2022-08-01</d><h>12:38</h><r>bpiel</r><a>@U10EC98F5</a> I ended up doing it outside aleph, which is fine, but any advice would be appreciated. thanks
<pre>(future
  (try (loop []
         (let [bs @(s/take! s)]
           (when (-&gt; bs count pos?)
             (.write fcos bs))
           (Thread/yield)
           (recur)))
       (catch Throwable ex
         ex)))</pre>
(I did something similar to handle the opposite direction)</z><z id="t1659357551" t="bpiel ...where fcos is an OutputStream"><y>#</y><d>2022-08-01</d><h>12:39</h><r>bpiel</r>...where <code>fcos</code> is an <code>OutputStream</code></z><z id="t1659359407" t="bpiel (also, thanks for maintaining aleph/manifold! They&apos;ve been central to multiple projects I&apos;ve done over the past ~5 years)"><y>#</y><d>2022-08-01</d><h>13:10</h><r>bpiel</r>(also, thanks for maintaining aleph/manifold! They&apos;ve been central to multiple projects I&apos;ve done over the past ~5 years)</z><z id="t1659362725" t="Matthew Davidson (kingmob) Ok, I&apos;ll take a deeper look tomorrow. But off the top of my head, I think dergutemoritz has the right idea. "><y>#</y><d>2022-08-01</d><h>14:05</h><r>Matthew Davidson (kingmob)</r>Ok, I&apos;ll take a deeper look tomorrow. But off the top of my head, I think dergutemoritz has the right idea. </z><z id="t1659405095" t="bpiel The issue that I&apos;m having with [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] suggestion above is that while this works: (bys/convert (InputStream/nullInputStream) (bys/stream-of bytes)) ...this does not: (bys/convert (OutputStream/nullOutputStream) (bys/stream-of bytes)) Unhandled java.lang.IllegalArgumentException: Don&apos;t know how to convert class java.io.OutputStream$1 into (stream-of [B) "><y>#</y><d>2022-08-02</d><h>01:51</h><r>bpiel</r>The issue that I&apos;m having with <a>@U06GVE6NR</a> suggestion above is that while this works:

<pre>(bys/convert (InputStream/nullInputStream)
                 (bys/stream-of bytes))</pre>
...this does not:
<pre>(bys/convert (OutputStream/nullOutputStream)
                 (bys/stream-of bytes))

Unhandled java.lang.IllegalArgumentException: Don&apos;t know how to convert class java.io.OutputStream$1 into (stream-of [B)</pre>
</z><z id="t1659405145" t="bpiel but, I may be misinterpreting &quot;(and likewise with the output stream)&quot;"><y>#</y><d>2022-08-02</d><h>01:52</h><r>bpiel</r>but, I may be misinterpreting &quot;(and likewise with the output stream)&quot;</z><z id="t1659451489" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U4FFD43T4&quot;}] OK, I‚Äôm a bit sleep-deprived, but my take is the discrepancy you‚Äôre seeing may be due to the difference in pull vs push stream semantics. Roughly speaking, Clojure seqs and http://java.io .Input/OutputStreams are pull-based, while Manifold is push-based. Manifold tries to automatically send things downstream, and stops when it can‚Äôt push (backpressure); in contrast, seqs/java.io.*Streams do nothing until you tell them to write or read data for you. It‚Äôs easy to make a pull-based source work in Manifold: stream take!s become derefs or .read()s of the underlying source as needed. Likewise for turning a Manifold stream into a seq/j.io.*Stream: backpressure forces manifold to slow down to the rate of seq/j.io.InputStream consumption (e.g., see manifold.stream/stream-&gt;seq ). Sinks are a bit harder. Since Manifold is designed to automatically push values downstream as they appear, to turn that into a pull-based sink requires ferrying code to call .write()s, and potentially a buffer in-between (potentially unbounded) or a timeout. I don‚Äôt know Zach‚Äôs original rationale, but my guess is that the policy to go from a Manifold stream to an OutputStream might vary between users, so he didn‚Äôt want to prescribe what to do. E.g., yoke them, use a buffer, write to a temp file, drop excess mesgs, use background threads or not, etc? Or, it could be he just built it for his own purposes, which seems mostly about getting bytes in, not out. ¬Ø\(„ÉÑ)/¬Ø Your solution to yoke the two together seems fine, btw (although Thread/yield seems sus). Since it only take!s as fast as it .write()s, backpressure forces the stream to slow down to the speed of the OutputStream, so that should be ok."><y>#</y><d>2022-08-02</d><h>14:44</h><r>Matthew Davidson (kingmob)</r><a>@U4FFD43T4</a> OK, I‚Äôm a bit sleep-deprived, but my take is the discrepancy you‚Äôre seeing may be due to the difference in pull vs push stream semantics. Roughly speaking, Clojure seqs and <a href="http://java.io" target="_blank">http://java.io</a>.Input/OutputStreams are pull-based, while Manifold is push-based. Manifold tries to automatically send things downstream, and stops when it can‚Äôt push (backpressure); in contrast, seqs/java.io.*Streams do nothing until you tell them to write or read data for you.

It‚Äôs easy to make a pull-based source work in Manifold: stream take!s become derefs or .read()s of the underlying source as needed. Likewise for turning a Manifold stream into a seq/j.io.*Stream: backpressure forces manifold to slow down to the rate of seq/j.io.InputStream consumption (e.g., see <code>manifold.stream/stream-&gt;seq</code>).

Sinks are a bit harder. Since Manifold is designed to automatically push values downstream as they appear, to turn that into a pull-based sink requires ferrying code to call .write()s, and potentially a buffer in-between (potentially unbounded) or a timeout.

I don‚Äôt know Zach‚Äôs original rationale, but my guess is that the policy to go from a Manifold stream to an OutputStream might vary between users, so he didn‚Äôt want to prescribe what to do. E.g., yoke them, use a buffer, write to a temp file, drop excess mesgs, use background threads or not, etc? Or, it could be he just built it for his own purposes, which seems mostly about getting bytes in, not out. ¬Ø\(„ÉÑ)/¬Ø

Your solution to yoke the two together seems fine, btw (although Thread/yield seems sus). Since it only take!s as fast as it .write()s, backpressure forces the stream to slow down to the speed of the OutputStream, so that should be ok.</z></g><g id="s8"><z id="t1659452929" t="bpiel [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Thank you for the thorough and thoughtful response!"><y>#</y><d>2022-08-02</d><h>15:08</h><r>bpiel</r><a>@U10EC98F5</a> Thank you for the thorough and thoughtful response!</z><z id="t1659200315" t="bpiel I&apos;ve tried -&gt;sink and -&gt;source but get exceptions"><y>#</y><d>2022-07-30</d><h>16:58</h><w>bpiel</w>I&apos;ve tried <code>-&gt;sink</code> and <code>-&gt;source</code> but get exceptions</z><z id="t1659364538" t="dergutemoritz Heya, does anyone know what exactly the advantage is of using netty-transport-native-epoll over Netty&apos;s default NIO based transport? Since JDK 9, the latter also uses epoll on Linux by default (cf. https://bugs.openjdk.org/browse/JDK-8142872 ) which makes me wonder :thinking_face:"><y>#</y><d>2022-08-01</d><h>14:35</h><w>dergutemoritz</w>Heya, does anyone know what exactly the advantage is of using <code>netty-transport-native-epoll</code> over Netty&apos;s default NIO based transport?  Since JDK 9, the latter also uses <code>epoll</code> on Linux by default (cf. <a href="https://bugs.openjdk.org/browse/JDK-8142872" target="_blank">https://bugs.openjdk.org/browse/JDK-8142872</a>) which makes me wonder <b>:thinking_face:</b></z><z id="t1659365398" t="dergutemoritz Ha, found some anecdotal evidence in the issue tracker that it could be more performant: https://github.com/clj-commons/aleph/issues/475#issuecomment-460428052"><y>#</y><d>2022-08-01</d><h>14:49</h><r>dergutemoritz</r>Ha, found some anecdotal evidence in the issue tracker that it could be more performant: <a href="https://github.com/clj-commons/aleph/issues/475#issuecomment-460428052" target="_blank">https://github.com/clj-commons/aleph/issues/475#issuecomment-460428052</a></z><z id="t1663585621" t="valerauko last time i tested (which was like two years back) epoll performed much better. i can&apos;t find the records anymore but iirc nio had to run through much more stuff and the stack depth showed. (also you need to specify architecture too when you use the native transport packages, like [io.netty/netty-transport-native-epoll &quot;4.1.50.Final&quot; :classifier &quot;linux-x86_64&quot;] )"><y>#</y><d>2022-09-19</d><h>11:07</h><r>valerauko</r>last time i tested (which was like two years back) epoll performed much better. i can&apos;t find the records anymore but iirc nio had to run through much more stuff and the stack depth showed. (also you need to specify architecture too when you use the native transport packages, like <code>[io.netty/netty-transport-native-epoll &quot;4.1.50.Final&quot; :classifier &quot;linux-x86_64&quot;]</code> )</z><z id="t1660229453" t="mafcocinco A GET request I make successfully via clj-http is failing when made through aleph . There is an exception thrown with connection was closed after 0.072 seconds . Does anyone know or know where to find the differences in defaults between clj-http and aleph when making a GET request. I‚Äôm hoping it is just a header that is missing or something like that which will resolve it. We use aelph exclusively and I do not want to have to introduce a second HTTP client library."><y>#</y><d>2022-08-11</d><h>14:50</h><w>mafcocinco</w>A <code>GET</code> request I make successfully via <code>clj-http</code> is failing when made through <code>aleph</code>.  There is an exception thrown with <code>connection was closed after 0.072 seconds</code>.  Does anyone know or know where to find the differences in defaults between <code>clj-http</code> and <code>aleph</code> when making a <code>GET</code> request.  I‚Äôm hoping it is just a header that is missing or something like that which will resolve it.  We use <code>aelph</code> exclusively and I do not want to have to introduce a second HTTP client library.</z><z id="t1660234521" t="mafcocinco solved: needed to upgrade from 0.4.6 to 0.5.0"><y>#</y><d>2022-08-11</d><h>16:15</h><r>mafcocinco</r>solved: needed to upgrade from <code>0.4.6</code> to <code>0.5.0</code></z><z id="t1660282536" t="Matthew Davidson (kingmob) Glad to hear upgrading worked. What was the request, btw? It might be useful to know, if others run into the issue"><y>#</y><d>2022-08-12</d><h>05:35</h><r>Matthew Davidson (kingmob)</r>Glad to hear upgrading worked. What was the request, btw? It might be useful to know, if others run into the issue</z><z id="t1660315540" t="mafcocinco The company I work for integrates with restaurant POS systems and it was for the integration with Casey‚Äôs pizza, so pretty niche but that was it."><y>#</y><d>2022-08-12</d><h>14:45</h><r>mafcocinco</r>The company I work for integrates with restaurant POS systems and it was for the integration with Casey‚Äôs pizza, so pretty niche but that was it.</z><z id="t1661499352" t="tlonist it seems to be a fairly simple request, curious how it failed with aleph. Do you happen to know what was improved specifically from 0.4.6 to 0.5.0?"><y>#</y><d>2022-08-26</d><h>07:35</h><r>tlonist</r>it seems to be a fairly simple request, curious how it failed with aleph. Do you happen to know what was improved specifically from 0.4.6 to 0.5.0?</z><z id="t1661545702" t="mafcocinco I don‚Äôt, [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] might."><y>#</y><d>2022-08-26</d><h>20:28</h><r>mafcocinco</r>I don‚Äôt, <a>@U10EC98F5</a> might.</z><z id="t1661585247" t="Matthew Davidson (kingmob) Hard to say, 0.4.6 is four years old, and according to the changelog, there have been 130+ changes since then."><y>#</y><d>2022-08-27</d><h>07:27</h><r>Matthew Davidson (kingmob)</r>Hard to say, 0.4.6 is four years old, and according to the changelog, there have been 130+ changes since then.</z><z id="t1660312462" t="Leonid Korogodski Does aleph server close the InputStream s that it sends as responses? Say, I have a reitit route like this: [&quot;/my/route&quot; {:get {;; a lot of stuff :handler (function-that-returns-response-with-body-as-inputstream)}}] The handler returns a response whose :body is an InputStream . Will aleph call .close on it after it&apos;s done streaming it out? Because I cannot close it while it is still being streamed, and I don&apos;t know when aleph would be done with it. Or is there a post-processing callback that I can use? Or does aleph guarantee that the stream will be closed (as I would expect when passing it on in this fashion)?"><y>#</y><d>2022-08-12</d><h>13:54</h><w>Leonid Korogodski</w>Does <code>aleph</code> server close the <code>InputStream</code>s that it sends as responses?

Say, I have a <code>reitit</code> route like this:
<pre>[&quot;/my/route&quot;
  {:get {;; a lot of stuff
         :handler (function-that-returns-response-with-body-as-inputstream)}}]</pre>
The handler returns a response whose <code>:body</code> is an <code>InputStream</code>. Will <code>aleph</code> call <code>.close</code> on it after it&apos;s done streaming it out? Because I cannot close it while it is still being streamed, and I don&apos;t know when <code>aleph</code> would be done with it. Or is there a post-processing callback that I can use? Or does <code>aleph</code> guarantee that the stream will be closed (as I would expect when passing it on in this fashion)?</z><z id="t1660403815" t="Matthew Davidson (kingmob) Yes, Aleph closes it when done. See send-streaming-body and byte-streams‚Äô conversion-fn for details"><y>#</y><d>2022-08-13</d><h>15:16</h><r>Matthew Davidson (kingmob)</r>Yes, Aleph closes it when done. See <code>send-streaming-body</code> and byte-streams‚Äô <code>conversion-fn</code> for details</z><z id="t1660575429" t="Leonid Korogodski Thanks for the confirmation!"><y>#</y><d>2022-08-15</d><h>14:57</h><r>Leonid Korogodski</r>Thanks for the confirmation!</z><z id="t1663649782" t="Matthew Davidson (kingmob) I have a question for users of the Aleph HTTP client as it relates to clj-http compatibility. When the response body is empty, clj-http returns nil, while aleph currently returns an empty InputStream. On the one hand, clj-http compatibility is explicitly the goal of Aleph‚Äôs HTTP client, and incompatibility is usually treated as a bug. On the other hand, we‚Äôre concerned about the impact of switching to returning nil. Would this change heavily affect you? React with an emoji to answer. &gt; ‚úÖ it wouldn‚Äôt affect me, or it‚Äôs not a big deal, go ahead and change it &gt; ‚ùå it would affect me, please leave the current behavior as is"><y>#</y><d>2022-09-20</d><h>04:56</h><w>Matthew Davidson (kingmob)</w>I have a question for users of the Aleph HTTP client as it relates to clj-http compatibility. When the response body is empty, clj-http returns nil, while aleph currently returns an empty InputStream. On the one hand, clj-http compatibility is explicitly the goal of Aleph‚Äôs HTTP client, and incompatibility is usually treated as a bug. On the other hand, we‚Äôre concerned about the impact of switching to returning nil. Would this change heavily affect you? React with an emoji to answer.

&gt; <b>‚úÖ</b> it wouldn‚Äôt affect me, or it‚Äôs not a big deal, go ahead and change it
&gt; <b>‚ùå</b> it would affect me, please leave the current behavior as is</z><z id="t1664879510" t="spariev Hi, I have an app which uses aleph (0.4.5-alpha) + manifold (0.1.7-alpha6) streams to serve SSE. I noticed that response that is served is not being compressed, and given there is a lot of data it goes pretty slow. So I wonder if there is an easy way to enable the compression or I need to do it manually, and if the latter, what is the best way to do it. The code looks something like this - (defn sse-handler [req] (let [event-stream (s/stream) keep-alive-stream (s/periodically timeout (fn [] &quot;:keepalive\n&quot;))] (s/connect keep-alive-stream event-stream {:timeout timeout}) (s/put! event-stream (str &quot;data: &quot; (write-transit (export-data)}) &quot;\n\n&quot;)) {:status 200 :headers {&quot;Content-Type&quot; &quot;text/event-stream; charset=utf-8&quot; &quot;Access-Control-Allow-Origin&quot; &quot;*&quot; &quot;Cache-Control&quot; &quot;no-cache&quot;} :body event-stream})) I&apos;ve enabled :compression? true in aleph http server and it looks like the usual responses are being indeed compressed but not SSE. Thanks in advance."><y>#</y><d>2022-10-04</d><h>10:31</h><w>spariev</w>Hi, I have an app which uses aleph (0.4.5-alpha) + manifold (0.1.7-alpha6) streams to serve SSE.
I noticed that response that is served is not being compressed, and given there is a lot of data it goes pretty slow.
So I wonder if there is an easy way to enable the compression or I need to do it manually, and if the latter, what is the best way to do it.

The code looks something like this -
<pre>(defn sse-handler
  [req]
  (let [event-stream (s/stream)
        keep-alive-stream (s/periodically timeout (fn [] &quot;:keepalive\n&quot;))]
    (s/connect keep-alive-stream event-stream {:timeout timeout})
    (s/put! event-stream (str &quot;data: &quot; (write-transit (export-data)}) &quot;\n\n&quot;))
    {:status 200
     :headers {&quot;Content-Type&quot; &quot;text/event-stream; charset=utf-8&quot;
               &quot;Access-Control-Allow-Origin&quot; &quot;*&quot;
               &quot;Cache-Control&quot; &quot;no-cache&quot;}
     :body event-stream}))</pre>
I&apos;ve enabled <code>:compression? true</code> in aleph http server and it looks like the usual responses are being indeed compressed but not SSE.

Thanks in advance.</z><z id="t1664881209" t="dergutemoritz :compression? true should apply here, too. Perhaps your SSE client request doesn&apos;t include the proper Accept-Encoding header?"><y>#</y><d>2022-10-04</d><h>11:00</h><r>dergutemoritz</r><code>:compression? true</code> should apply here, too. Perhaps your SSE client request doesn&apos;t include the proper <code>Accept-Encoding</code> header?</z><z id="t1664881341" t="dergutemoritz Nice idea with the keep-alive-stream btw üôÇ Although it&apos;s a bit suboptimal in that it also sends keepalive messages even when regular events are being sent during the timeout period. I wonder if there&apos;s a straightforward way to account for that, too :thinking_face:"><y>#</y><d>2022-10-04</d><h>11:02</h><r>dergutemoritz</r>Nice idea with the <code>keep-alive-stream</code> btw <b>üôÇ</b> Although it&apos;s a bit suboptimal in that it also sends keepalive messages even when regular events are being sent during the timeout period. I wonder if there&apos;s a straightforward way to account for that, too <b>:thinking_face:</b></z><z id="t1664882009" t="spariev As far as I know client request is set up properly, but I will recheck it, thanks"><y>#</y><d>2022-10-04</d><h>11:13</h><r>spariev</r>As far as I know client request is set up properly, but I will recheck it, thanks</z><z id="t1664882281" t="dergutemoritz Hm looks correct indeed"><y>#</y><d>2022-10-04</d><h>11:18</h><r>dergutemoritz</r>Hm looks correct indeed</z><z id="t1664882308" t="dergutemoritz Which aleph version are you on btw?"><y>#</y><d>2022-10-04</d><h>11:18</h><r>dergutemoritz</r>Which aleph version are you on btw?</z><z id="t1664882627" t="dergutemoritz and can you post the full set of request headers? üôè"><y>#</y><d>2022-10-04</d><h>11:23</h><r>dergutemoritz</r>and can you post the full set of request headers? <b>üôè</b></z><z id="t1664883321" t="spariev aleph version is 0.4.5-alpha3 , a bit old, but this is kinda legacy app I&apos;m maintaining (so that keep-alive-stream idea was not mine, still thanks though üôÇ )"><y>#</y><d>2022-10-04</d><h>11:35</h><r>spariev</r>aleph version is <code>0.4.5-alpha3</code>, a bit old, but this is kinda legacy app I&apos;m maintaining (so that <code>keep-alive-stream</code> idea was not mine, still thanks though <b>üôÇ</b> )</z><z id="t1664883332" t="dergutemoritz Ha!"><y>#</y><d>2022-10-04</d><h>11:35</h><r>dergutemoritz</r>Ha!</z><z id="t1664883347" t="dergutemoritz Then you&apos;re missing 061ee43090fcf793942a6b24945af3e7d43b37b1 which might be the fix you&apos;re looking for"><y>#</y><d>2022-10-04</d><h>11:35</h><r>dergutemoritz</r>Then you&apos;re missing 061ee43090fcf793942a6b24945af3e7d43b37b1 which might be the fix you&apos;re looking for</z><z id="t1664883372" t="dergutemoritz Try updating to 0.5.0 if possible"><y>#</y><d>2022-10-04</d><h>11:36</h><r>dergutemoritz</r>Try updating to 0.5.0 if possible</z><z id="t1664883454" t="spariev oh cool thanks a lot! this totally looks like it should help my case"><y>#</y><d>2022-10-04</d><h>11:37</h><r>spariev</r>oh cool thanks a lot! this totally looks like it should help my case</z><z id="t1664883473" t="dergutemoritz ü§û"><y>#</y><d>2022-10-04</d><h>11:37</h><r>dergutemoritz</r><b>ü§û</b></z><z id="t1664883604" t="dergutemoritz Hmm but the PR that includes that commit doesn&apos;t seem too relevant: https://github.com/clj-commons/aleph/pull/357 But worth a shot regardless"><y>#</y><d>2022-10-04</d><h>11:40</h><r>dergutemoritz</r>Hmm but the PR that includes that commit doesn&apos;t seem too relevant: <a href="https://github.com/clj-commons/aleph/pull/357" target="_blank">https://github.com/clj-commons/aleph/pull/357</a> But worth a shot regardless</z><z id="t1664883919" t="spariev anyway I&apos;ll try to upgrade aleph later in the day or tomorrow and will report tomorrow"><y>#</y><d>2022-10-04</d><h>11:45</h><r>spariev</r>anyway I&apos;ll try to upgrade aleph later in the day or tomorrow and will report tomorrow</z><z id="t1665044956" t="Matthew Davidson (kingmob) The more relevant PR is probably https://github.com/clj-commons/aleph/pull/360 , which wasn‚Äôt released until 0.4.5-alpha6"><y>#</y><d>2022-10-06</d><h>08:29</h><r>Matthew Davidson (kingmob)</r>The more relevant PR is probably <a href="https://github.com/clj-commons/aleph/pull/360" target="_blank">https://github.com/clj-commons/aleph/pull/360</a>, which wasn‚Äôt released until 0.4.5-alpha6</z><z id="t1665049439" t="dergutemoritz Don&apos;t think it is - that one affects websockets while [:attrs {:href &quot;/_/_/users/U07M31NA0&quot;}] is using SSE via the regular HTTP server"><y>#</y><d>2022-10-06</d><h>09:43</h><r>dergutemoritz</r>Don&apos;t think it is - that one affects websockets while <a>@U07M31NA0</a> is using SSE via the regular HTTP server</z><z id="t1665050209" t="Matthew Davidson (kingmob) Ahh, right, right."><y>#</y><d>2022-10-06</d><h>09:56</h><r>Matthew Davidson (kingmob)</r>Ahh, right, right.</z><z id="t1665054795" t="spariev hi guys, I have an update I&apos;ve tried to update aleph to 0.5.0 (had to bump up manifold and netty along the way) but no luck so far - still no Content-Encoding header What place in the aleph source code you would suggest to look into ? Maybe I can come up with the PR to fix this. Truth to be told it is not my biggest problem right now though, but I might have time later to dig into it."><y>#</y><d>2022-10-06</d><h>11:13</h><r>spariev</r>hi guys, I have an update
I&apos;ve tried to update <code>aleph</code> to <code>0.5.0</code> (had to bump up manifold and netty along the way) but no luck so far - still no <code>Content-Encoding</code>  header
What place in the <code>aleph</code> source code you would suggest to look into ? Maybe I can come up with the PR to fix this.
Truth to be told it is not my biggest problem right now though, but I might have time later to dig into it.</z><z id="t1665060075" t="dergutemoritz Thanks! At least we know that we&apos;re not chasing an obsolete bug here then üôÇ The deflater is added to the Netty pipeline https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L559-L562 ."><y>#</y><d>2022-10-06</d><h>12:41</h><r>dergutemoritz</r>Thanks! At least we know that we&apos;re not chasing an obsolete bug here then <b>üôÇ</b> The deflater is added to the Netty pipeline <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L559-L562" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L559-L562</a>.</z><z id="t1665060126" t="dergutemoritz I don&apos;t see why it shouldn&apos;t work. I also already checked Netty&apos;s codebase for whether they have any special handling for text/event-stream but doesn&apos;t seem to be the case."><y>#</y><d>2022-10-06</d><h>12:42</h><r>dergutemoritz</r>I don&apos;t see why it shouldn&apos;t work. I also already checked Netty&apos;s codebase for whether they have any special handling for <code>text/event-stream</code> but doesn&apos;t seem to be the case.</z><z id="t1665060565" t="spariev Thanks for the pointers, will look into it. I also was thinking it should just work, but somehow it doesn&apos;t for me."><y>#</y><d>2022-10-06</d><h>12:49</h><r>spariev</r>Thanks for the pointers, will look into it. I also was thinking it should just work, but somehow it doesn&apos;t for me.</z><z id="t1665062567" t="dergutemoritz Keep us posted on your investigation!"><y>#</y><d>2022-10-06</d><h>13:22</h><r>dergutemoritz</r>Keep us posted on your investigation!</z><z id="t1665053703" t="Matthew Davidson (kingmob) Hey all, if you‚Äôre thinking of contributing, and want a t-shirt (or a tree planted in your name), we‚Äôre participating in Hacktoberfest!"><y>#</y><d>2022-10-06</d><h>10:55</h><w>Matthew Davidson (kingmob)</w>Hey all, if you‚Äôre thinking of contributing, and want a t-shirt (or a tree planted in your name), we‚Äôre participating in Hacktoberfest!</z><z id="t1665062605" t="valerauko what are issues that you want to prioritize?"><y>#</y><d>2022-10-06</d><h>13:23</h><r>valerauko</r>what are issues that you want to prioritize?</z><z id="t1665063397" t="valerauko I just made https://github.com/clj-commons/aleph/pull/630 I myself want to see asap. Happy to help with other stuff too."><y>#</y><d>2022-10-06</d><h>13:36</h><r>valerauko</r>I just made <a href="https://github.com/clj-commons/aleph/pull/630" target="_blank">https://github.com/clj-commons/aleph/pull/630</a> I myself want to see asap. Happy to help with other stuff too.</z><z id="t1665063744" t="dergutemoritz Ah great, I also meant to do that for the same reason :D"><y>#</y><d>2022-10-06</d><h>13:42</h><r>dergutemoritz</r>Ah great, I also meant to do that for the same reason :D</z><z id="t1665064006" t="Matthew Davidson (kingmob) Weird, the Circle checkout phase is failing again. ???"><y>#</y><d>2022-10-06</d><h>13:46</h><r>Matthew Davidson (kingmob)</r>Weird, the Circle checkout phase is failing again. ???</z><z id="t1665064086" t="dergutemoritz Indeed"><y>#</y><d>2022-10-06</d><h>13:48</h><r>dergutemoritz</r>Indeed</z><z id="t1665064131" t="dergutemoritz I found https://discuss.circleci.com/t/switched-our-template-over-to-2-0-and-getting-git-error-trying-to-pull-remote-ref/20371/11 which seems to be about the same issue. But if the multiple slashes were the problem, it should have never worked, shouldn&apos;t it :thinking_face:"><y>#</y><d>2022-10-06</d><h>13:48</h><r>dergutemoritz</r>I found <a href="https://discuss.circleci.com/t/switched-our-template-over-to-2-0-and-getting-git-error-trying-to-pull-remote-ref/20371/11" target="_blank">https://discuss.circleci.com/t/switched-our-template-over-to-2-0-and-getting-git-error-trying-to-pull-remote-ref/20371/11</a> which seems to be about the same issue. But if the multiple slashes were the problem, it should have never worked, shouldn&apos;t it <b>:thinking_face:</b></z><z id="t1665064176" t="dergutemoritz Hm mabye it&apos;s caused by the / in your branch name [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}]"><y>#</y><d>2022-10-06</d><h>13:49</h><r>dergutemoritz</r>Hm mabye it&apos;s caused by the <code>/</code> in your branch name <a>@UAEH11THP</a></z><z id="t1665064238" t="Matthew Davidson (kingmob) Maybe, but I tend to label my branches git flow-style, too"><y>#</y><d>2022-10-06</d><h>13:50</h><r>Matthew Davidson (kingmob)</r>Maybe, but I tend to label my branches git flow-style, too</z><z id="t1665064249" t="Matthew Davidson (kingmob) e.g., bugfix/‚Ä¶"><y>#</y><d>2022-10-06</d><h>13:50</h><r>Matthew Davidson (kingmob)</r>e.g., <code>bugfix/‚Ä¶</code></z><z id="t1665064265" t="valerauko i could try re-pushing on a non-/ branch but it&apos;s never caused a problem before"><y>#</y><d>2022-10-06</d><h>13:51</h><r>valerauko</r>i could try re-pushing on a non-/ branch but it&apos;s never caused a problem before</z><z id="t1665064273" t="Matthew Davidson (kingmob) And our circle config file has barely changed in two years"><y>#</y><d>2022-10-06</d><h>13:51</h><r>Matthew Davidson (kingmob)</r>And our circle config file has barely changed in two years</z><z id="t1665064336" t="dergutemoritz Hmm yeah seems unlikely to be the culprit. The original branch name doesn&apos;t even show up in the output."><y>#</y><d>2022-10-06</d><h>13:52</h><r>dergutemoritz</r>Hmm yeah seems unlikely to be the culprit. The original branch name doesn&apos;t even show up in the output.</z><z id="t1665064516" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Can you try adding some whitespace and push up another commit? (We‚Äôll squash later.)"><y>#</y><d>2022-10-06</d><h>13:55</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> Can you try adding some whitespace and push up another commit? (We‚Äôll squash later.)</z><z id="t1665064636" t="dergutemoritz My best guess is that CircleCI changed something on their end wrt how they check out PRs"><y>#</y><d>2022-10-06</d><h>13:57</h><r>dergutemoritz</r>My best guess is that CircleCI changed something on their end wrt how they check out PRs</z><z id="t1665064918" t="dergutemoritz Hm no, the script is no different from when it last worked in a similar case"><y>#</y><d>2022-10-06</d><h>14:01</h><r>dergutemoritz</r>Hm no, the script is no different from when it last worked in a similar case</z><z id="t1665064974" t="dergutemoritz https://www.githubstatus.com/incidents/gq1x0j8bv67v looks very relevant: &gt; We identified an issue with the checkout action download which was causing elevated actions failures. But according to them, it should have been fixed 2 hours ago already."><y>#</y><d>2022-10-06</d><h>14:02</h><r>dergutemoritz</r><a href="https://www.githubstatus.com/incidents/gq1x0j8bv67v" target="_blank">https://www.githubstatus.com/incidents/gq1x0j8bv67v</a> looks very relevant:

&gt; We identified an issue with the checkout action download which was causing elevated actions failures.
But according to them, it should have been fixed 2 hours ago already.</z><z id="t1665064990" t="Matthew Davidson (kingmob) That‚Äôs not quite true. This section: if [ &quot;$existing_repo&quot; = &apos;true&apos; ] || [ &apos;false&apos; = &apos;true&apos; ]; then echo &apos;Fetching from remote repository&apos; if [ -n &quot;$CIRCLE_TAG&quot; ]; then git fetch --force --tags origin else git fetch --force origin +refs/heads/master:refs/remotes/origin/master fi fi became this: if [ &quot;$existing_repo&quot; = &apos;true&apos; ] || [ &apos;true&apos; = &apos;true&apos; ]; then echo &apos;Fetching from remote repository&apos; if [ -n &quot;$CIRCLE_TAG&quot; ]; then git fetch --force --tags origin else git fetch --force origin +refs/pull/630/head:refs/remotes/origin/pull/630 fi fi "><y>#</y><d>2022-10-06</d><h>14:03</h><r>Matthew Davidson (kingmob)</r>That‚Äôs not quite true. This section:
<pre>if [ &quot;$existing_repo&quot; = &apos;true&apos; ] || [ &apos;false&apos; = &apos;true&apos; ]; then
  echo &apos;Fetching from remote repository&apos;
  if [ -n &quot;$CIRCLE_TAG&quot; ]; then
    git fetch --force --tags origin
  else
    git fetch --force origin +refs/heads/master:refs/remotes/origin/master
  fi
fi</pre>
became this:
<pre>if [ &quot;$existing_repo&quot; = &apos;true&apos; ] || [ &apos;true&apos; = &apos;true&apos; ]; then
  echo &apos;Fetching from remote repository&apos;
  if [ -n &quot;$CIRCLE_TAG&quot; ]; then
    git fetch --force --tags origin
  else
    git fetch --force origin +refs/pull/630/head:refs/remotes/origin/pull/630
  fi
fi</pre>
</z><z id="t1665065027" t="dergutemoritz Compare with https://app.circleci.com/pipelines/github/clj-commons/aleph/200/workflows/c069ea02-3682-4ef3-9be6-f86c64b30dea/jobs/195"><y>#</y><d>2022-10-06</d><h>14:03</h><r>dergutemoritz</r>Compare with <a href="https://app.circleci.com/pipelines/github/clj-commons/aleph/200/workflows/c069ea02-3682-4ef3-9be6-f86c64b30dea/jobs/195" target="_blank">https://app.circleci.com/pipelines/github/clj-commons/aleph/200/workflows/c069ea02-3682-4ef3-9be6-f86c64b30dea/jobs/195</a></z><z id="t1665065053" t="dergutemoritz That&apos;s a similar case in that it also uses the refs/pull thing"><y>#</y><d>2022-10-06</d><h>14:04</h><r>dergutemoritz</r>That&apos;s a similar case in that it also uses the <code>refs/pull</code> thing</z><z id="t1665065067" t="dergutemoritz the only difference there is the PR ID"><y>#</y><d>2022-10-06</d><h>14:04</h><r>dergutemoritz</r>the only difference there is the PR ID</z><z id="t1665065089" t="dergutemoritz Ah, the whitespace push did the trick üëç"><y>#</y><d>2022-10-06</d><h>14:04</h><r>dergutemoritz</r>Ah, the whitespace push did the trick <b>üëç</b></z><z id="t1665065103" t="dergutemoritz Now the check is failing with a legitimate error üôÇ"><y>#</y><d>2022-10-06</d><h>14:05</h><r>dergutemoritz</r>Now the check is failing with a legitimate error <b>üôÇ</b></z><z id="t1665065154" t="valerauko i kinda expected something like that to be necessary... that&apos;s why i opened https://github.com/clj-commons/aleph/issues/631"><y>#</y><d>2022-10-06</d><h>14:05</h><r>valerauko</r>i kinda expected something like that to be necessary... that&apos;s why i opened <a href="https://github.com/clj-commons/aleph/issues/631" target="_blank">https://github.com/clj-commons/aleph/issues/631</a></z><z id="t1665065250" t="Matthew Davidson (kingmob) Build 200 is much, much older, but yeah, it has the same script and worked"><y>#</y><d>2022-10-06</d><h>14:07</h><r>Matthew Davidson (kingmob)</r>Build 200 is much, much older, but yeah, it has the same script and worked</z><z id="t1665065304" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Does the failing check&apos;s output suffice to steer you to the solution? (curious because it&apos;s the first time it comes up üòÑ )"><y>#</y><d>2022-10-06</d><h>14:08</h><r>dergutemoritz</r><a>@UAEH11THP</a> Does the failing check&apos;s output suffice to steer you to the solution? (curious because it&apos;s the first time it comes up <b>üòÑ</b>)</z><z id="t1665065335" t="Matthew Davidson (kingmob) It‚Äôs something new to support deps.edn"><y>#</y><d>2022-10-06</d><h>14:08</h><r>Matthew Davidson (kingmob)</r>It‚Äôs something new to support deps.edn</z><z id="t1665065370" t="dergutemoritz Right - I tried to make the error and hwo to resolve it self-explanatory ü§û"><y>#</y><d>2022-10-06</d><h>14:09</h><r>dergutemoritz</r>Right - I tried to make the error and hwo to resolve it self-explanatory <b>ü§û</b></z><z id="t1665065392" t="valerauko I was confused by the &quot;deps/lein-to-deps&quot;. I thought it meant lein deps or lein-to-deps, not realizing there&apos;s a deps folder"><y>#</y><d>2022-10-06</d><h>14:09</h><r>valerauko</r>I was confused by the &quot;deps/lein-to-deps&quot;. I thought it meant lein deps or lein-to-deps, not realizing there&apos;s a deps folder</z><z id="t1665065408" t="dergutemoritz Ah, I see"><y>#</y><d>2022-10-06</d><h>14:10</h><r>dergutemoritz</r>Ah, I see</z><z id="t1665065412" t="Matthew Davidson (kingmob) It feels like there should be a way to automate it, or at least automate the check, with git pre-commit or something"><y>#</y><d>2022-10-06</d><h>14:10</h><r>Matthew Davidson (kingmob)</r>It feels like there should be a way to automate it, or at least automate the check, with git pre-commit or something</z><z id="t1665065436" t="dergutemoritz A bit too heavy for pre-commit"><y>#</y><d>2022-10-06</d><h>14:10</h><r>dergutemoritz</r>A bit too heavy for pre-commit</z><z id="t1665065450" t="Matthew Davidson (kingmob) How so?"><y>#</y><d>2022-10-06</d><h>14:10</h><r>Matthew Davidson (kingmob)</r>How so?</z><z id="t1665065453" t="valerauko at work i have a lein alias that runs lein ancient upgrade and lein pom then all i need is run lein update-deps and it just does all the steps we use the pom.xml to get dependabot alerts, so it&apos;s a very similar workflow to this"><y>#</y><d>2022-10-06</d><h>14:10</h><r>valerauko</r>at work i have a lein alias that runs lein ancient upgrade and lein pom

then all i need is run lein update-deps and it just does all the steps

we use the pom.xml to get dependabot alerts, so it&apos;s a very similar workflow to this</z><z id="t1665065587" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] it involves two lein invocations which makes it too slow to run on every commit IMHO"><y>#</y><d>2022-10-06</d><h>14:13</h><r>dergutemoritz</r><a>@U10EC98F5</a> it involves two <code>lein</code> invocations which makes it too slow to run on every commit IMHO</z><z id="t1665065618" t="Matthew Davidson (kingmob) Hmmm, yeah, I didn‚Äôt know it was so slow"><y>#</y><d>2022-10-06</d><h>14:13</h><r>Matthew Davidson (kingmob)</r>Hmmm, yeah, I didn‚Äôt know it was so slow</z><z id="t1665065689" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Yeah it could be written as a Leiningen task instead and I started doing that initially but it became pretty unwieldy. Another option would be to invoke the shell script via Leiningen but that would add yet another heavy lein invocation üò¨"><y>#</y><d>2022-10-06</d><h>14:14</h><r>dergutemoritz</r><a>@UAEH11THP</a> Yeah it could be written as a Leiningen task instead and I started doing that initially but it became pretty unwieldy. Another option would be to invoke the shell script via Leiningen but that would add yet another heavy <code>lein</code>  invocation <b>üò¨</b></z><z id="t1665065727" t="dergutemoritz FWIW, I also condidered babashaka but didn&apos;t want to add another external dependency because that&apos;s also quite unwieldy to do the way things are set up right now"><y>#</y><d>2022-10-06</d><h>14:15</h><r>dergutemoritz</r>FWIW, I also condidered babashaka but didn&apos;t want to add another external dependency because that&apos;s also quite unwieldy to do the way things are set up right now</z><z id="t1665065833" t="valerauko running it shouldn&apos;t be a common occurrence so just documenting it is fine imo"><y>#</y><d>2022-10-06</d><h>14:17</h><r>valerauko</r>running it shouldn&apos;t be a common occurrence so just documenting it is fine imo</z><z id="t1665065838" t="dergutemoritz But I see how the error message can be misunderstood the way you did - making a note to improve it"><y>#</y><d>2022-10-06</d><h>14:17</h><r>dergutemoritz</r>But I see how the error message can be misunderstood the way you did - making a note to improve it</z><z id="t1665065846" t="Matthew Davidson (kingmob) Can bb easily get the lein deps, regardless? How hard would it be to duplicate the output of lein pprint without lein?"><y>#</y><d>2022-10-06</d><h>14:17</h><r>Matthew Davidson (kingmob)</r>Can bb easily get the lein deps, regardless? How hard would it be to duplicate the output of <code>lein pprint</code> without lein?</z><z id="t1665065846" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] indeed!"><y>#</y><d>2022-10-06</d><h>14:17</h><r>dergutemoritz</r><a>@UAEH11THP</a> indeed!</z><z id="t1665065888" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] At that point I didn&apos;t yet have the epiphany of using lein pprint and would have implemented a good enough parser for the raw project.clj"><y>#</y><d>2022-10-06</d><h>14:18</h><r>dergutemoritz</r><a>@U10EC98F5</a> At that point I didn&apos;t yet have the epiphany of using <code>lein pprint</code> and would have implemented a good enough parser for the raw <code>project.clj</code></z><z id="t1665065897" t="Matthew Davidson (kingmob) I don‚Äôt personally mind adding bb as a dep. It‚Äôs used in many of the CircleCI builds already, so it‚Äôs not a new depthere"><y>#</y><d>2022-10-06</d><h>14:18</h><r>Matthew Davidson (kingmob)</r>I don‚Äôt personally mind adding bb as a dep. It‚Äôs used in many of the CircleCI builds already, so it‚Äôs not a new depthere</z><z id="t1665065911" t="Matthew Davidson (kingmob) heh"><y>#</y><d>2022-10-06</d><h>14:18</h><r>Matthew Davidson (kingmob)</r>heh</z><z id="t1665065913" t="valerauko - echo &quot;ERROR: ${f} needs to be re-generated via deps/lein-to-deps&quot; &gt;&amp;2 + echo &quot;ERROR: ${f} needs to be re-generated using the script \&quot;deps/lein-to-deps\&quot;&quot; &gt;&amp;2"><y>#</y><d>2022-10-06</d><h>14:18</h><r>valerauko</r><pre>-        echo &quot;ERROR: ${f} needs to be re-generated via deps/lein-to-deps&quot; &gt;&amp;2
+        echo &quot;ERROR: ${f} needs to be re-generated using the script \&quot;deps/lein-to-deps\&quot;&quot; &gt;&amp;2</pre></z><z id="t1665065924" t="dergutemoritz Ah so the Clojure image we&apos;re using already has it? I assumed not. Well then, will keep it in mind üôÇ"><y>#</y><d>2022-10-06</d><h>14:18</h><r>dergutemoritz</r>Ah so the Clojure image we&apos;re using already has it? I assumed not. Well then, will keep it in mind <b>üôÇ</b></z><z id="t1665065948" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] lgtm! Feel free to include in your PR"><y>#</y><d>2022-10-06</d><h>14:19</h><r>dergutemoritz</r><a>@UAEH11THP</a> lgtm! Feel free to include in your PR</z><z id="t1665066121" t="Matthew Davidson (kingmob) I don‚Äôt think it does, or if it does, I don‚Äôt think it‚Äôs kept up-to-date with the speed of bb development. Pretty sure slipset wrote a script to download the latest as needed"><y>#</y><d>2022-10-06</d><h>14:22</h><r>Matthew Davidson (kingmob)</r>I don‚Äôt think it does, or if it does, I don‚Äôt think it‚Äôs kept up-to-date with the speed of bb development. Pretty sure slipset wrote a script to download the latest as needed</z><z id="t1665066255" t="dergutemoritz Ah yeah, that&apos;s the unwieldiness I didn&apos;t want to drag in üòÑ"><y>#</y><d>2022-10-06</d><h>14:24</h><r>dergutemoritz</r>Ah yeah, that&apos;s the unwieldiness I didn&apos;t want to drag in <b>üòÑ</b></z><z id="t1665066284" t="dergutemoritz At least in this particular case, given the lein pprint situation, it wouldn&apos;t have been worth it."><y>#</y><d>2022-10-06</d><h>14:24</h><r>dergutemoritz</r>At least in this particular case, given the <code>lein pprint</code> situation, it wouldn&apos;t have been worth it.</z><z id="t1665066465" t="Matthew Davidson (kingmob) I guess if it‚Äôs only needed when updating deps, we can live with it. Can we add a comment reminding us in the project.clj?"><y>#</y><d>2022-10-06</d><h>14:27</h><r>Matthew Davidson (kingmob)</r>I guess if it‚Äôs only needed when updating deps, we can live with it. Can we add a comment reminding us in the project.clj?</z><z id="t1665066492" t="Matthew Davidson (kingmob) Maybe in https://github.com/clj-commons/aleph/pull/632 ?"><y>#</y><d>2022-10-06</d><h>14:28</h><r>Matthew Davidson (kingmob)</r>Maybe in <a href="https://github.com/clj-commons/aleph/pull/632" target="_blank">https://github.com/clj-commons/aleph/pull/632</a> ?</z><z id="t1665066544" t="Matthew Davidson (kingmob) Not just the CONTRIBUTING file, but inline with the deps themselves"><y>#</y><d>2022-10-06</d><h>14:29</h><r>Matthew Davidson (kingmob)</r>Not just the CONTRIBUTING file, but inline with the deps themselves</z><z id="t1665066614" t="dergutemoritz Certainly wouldn&apos;t hurt!"><y>#</y><d>2022-10-06</d><h>14:30</h><r>dergutemoritz</r>Certainly wouldn&apos;t hurt!</z><z id="t1665066783" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Do you want to continue working on CONTRIBUTING.md?"><y>#</y><d>2022-10-06</d><h>14:33</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> Do you want to continue working on CONTRIBUTING.md?</z><z id="t1665066791" t="Matthew Davidson (kingmob) Or is it done?"><y>#</y><d>2022-10-06</d><h>14:33</h><r>Matthew Davidson (kingmob)</r>Or is it done?</z><z id="t1665066795" t="Matthew Davidson (kingmob) (for now)"><y>#</y><d>2022-10-06</d><h>14:33</h><r>Matthew Davidson (kingmob)</r>(for now)</z><z id="t1665066820" t="valerauko for this PR i think so yeah. unless you want me to add anything dependency-update specific"><y>#</y><d>2022-10-06</d><h>14:33</h><r>valerauko</r>for this PR i think so yeah. unless you want me to add anything dependency-update specific</z><z id="t1665066908" t="Matthew Davidson (kingmob) Nah, that‚Äôs ok"><y>#</y><d>2022-10-06</d><h>14:35</h><r>Matthew Davidson (kingmob)</r>Nah, that‚Äôs ok</z><z id="t1665067329" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Great initiative! Left you some feedback on that one"><y>#</y><d>2022-10-06</d><h>14:42</h><r>dergutemoritz</r><a>@UAEH11THP</a> Great initiative! Left you some feedback on that one</z><z id="t1665068505" t="dergutemoritz Merged! Two more to go and the shirt is yours üòÑ"><y>#</y><d>2022-10-06</d><h>15:01</h><r>dergutemoritz</r>Merged! Two more to go and the shirt is yours <b>üòÑ</b></z><z id="t1665068520" t="dergutemoritz Or your name on the tree, of course!"><y>#</y><d>2022-10-06</d><h>15:02</h><r>dergutemoritz</r>Or your name on the tree, of course!</z><z id="t1665068658" t="valerauko haha, i&apos;ve cleared the hacktoberfest bar on 10/1 already. i&apos;m just happy to see aleph come back to life"><y>#</y><d>2022-10-06</d><h>15:04</h><r>valerauko</r>haha, i&apos;ve cleared the hacktoberfest bar on 10/1 already. i&apos;m just happy to see aleph come back to life</z><z id="t1665084200" t="Eugen I was checking out Jetty the other day qnd saw they have a Conformance / HTTP compatibility information and I think even tests. Is there something like this for Aleph? a list of RFCs that aleph (tries) to conform with? Is there a TCK to check? is there prior work or interest in this direction?"><y>#</y><d>2022-10-06</d><h>19:23</h><r>Eugen</r>I was checking out Jetty the other day qnd saw they have a Conformance / HTTP compatibility information and I think even tests.  Is there something like this for Aleph? a list of RFCs that aleph (tries) to conform with? Is there a TCK to check? is there prior work or interest in this direction?</z><z id="t1665114403" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U011NGC5FFY&quot;}] I don‚Äôt believe there‚Äôs any such thing, but PRs would be welcome. "><y>#</y><d>2022-10-07</d><h>03:46</h><r>Matthew Davidson (kingmob)</r><a>@U011NGC5FFY</a> I don‚Äôt believe there‚Äôs any such thing, but PRs would be welcome. </z><z id="t1665115735" t="valerauko I&apos;m aware of https://github.com/summerwind/h2spec/ for http/2 and the apparently since-then-unmaintained https://github.com/kazu-yamamoto/h3spec/ for http/3 but I don&apos;t know of any for http/1.1"><y>#</y><d>2022-10-07</d><h>04:08</h><r>valerauko</r>I&apos;m aware of <a href="https://github.com/summerwind/h2spec/" target="_blank">https://github.com/summerwind/h2spec/</a> for http/2 and the apparently since-then-unmaintained <a href="https://github.com/kazu-yamamoto/h3spec/" target="_blank">https://github.com/kazu-yamamoto/h3spec/</a> for http/3 but I don&apos;t know of any for http/1.1</z><z id="t1665122598" t="Matthew Davidson (kingmob) Well, you know, we would like to support HTTP 2 and 3‚Ä¶ üòâ"><y>#</y><d>2022-10-07</d><h>06:03</h><r>Matthew Davidson (kingmob)</r>Well, you know, we would like to support HTTP 2 and 3‚Ä¶ <b>üòâ</b></z><z id="t1665122772" t="Eugen thanks for the info and the links. will check them out"><y>#</y><d>2022-10-07</d><h>06:06</h><r>Eugen</r>thanks for the info and the links. will check them out</z><z id="t1665123574" t="valerauko i have implemented http/2 before in clojure on top of netty so i can help with that. i also tried my hands at http/3 but their incubator project was too early at that time so i bailed. https://github.com/valerauko/iny"><y>#</y><d>2022-10-07</d><h>06:19</h><r>valerauko</r>i have implemented http/2 before in clojure on top of netty so i can help with that. i also tried my hands at http/3 but their incubator project was too early at that time so i bailed. <a href="https://github.com/valerauko/iny" target="_blank">https://github.com/valerauko/iny</a></z><z id="t1667239709" t="kkruit Hey all, I&apos;m using aleph to create a tcp client to a service that i&apos;m using and i want the connection to be persistent. It seems like after about 20 seconds of inactivity the connection is closed. Is there any way to make sure the tcp connection doesn&apos;t close unless I explicitly close it or the server disconnects for some reason. Could I do something with the bootstrap or pipeline transform options? (defn start-tcp [] (log/info &quot;Starting.&quot;) (let [tcp (-&gt;&gt; @config ((fn [conf] (if (= 1 (:ssl conf)) (merge conf {:ssl? true :ssl-context ssl-context}) (merge conf {:ssl? false})))) tcp/client)] (d/loop [] (d/chain (gio/decode-stream @tcp protocol) (partial s/transform (get-message-parser @config)) (partial s/transform @andi-transducer-stack) (fn [msg] (when-not (s/closed? msg) (d/recur))))) (on-connect @tcp)))"><y>#</y><d>2022-10-31</d><h>18:08</h><w>kkruit</w>Hey all, I&apos;m using aleph to create a tcp client to a service that i&apos;m using and i want the connection to be persistent. It seems like after about 20 seconds of inactivity the connection is closed. Is there any way to make sure the tcp connection doesn&apos;t close unless I explicitly close it or the server disconnects for some reason. Could I do something with the bootstrap or pipeline transform options?

<pre>(defn start-tcp []
    (log/info &quot;Starting.&quot;)
    (let [tcp (-&gt;&gt; @config
                   ((fn [conf] (if (= 1 (:ssl conf))
                                 (merge conf {:ssl? true
                                              :ssl-context
                                              ssl-context})
                                 (merge conf {:ssl? false}))))
                   tcp/client)]
      (d/loop
        []
        (d/chain
          (gio/decode-stream @tcp protocol)
          (partial s/transform (get-message-parser @config))
          (partial s/transform @andi-transducer-stack)
          (fn [msg]
            (when-not (s/closed? msg) (d/recur)))))
      (on-connect @tcp)))</pre></z><z id="t1667240551" t="Arnaud Geiser Hello! Are you sure it&apos;s related to your Aleph TCP client? We are doing much on Aleph side regarding TCP, It&apos;s rather trivial. [1] I don&apos;t know about the Netty defaults, so maybe you can use a bootstrap-transform to set SO_TIMEOUT [2] to a bigger value. [1] : https://github.com/exoscale/aleph/blob/master/src/aleph/netty.clj#L977-L984 [2] : https://netty.io/4.1/api/io/netty/channel/ChannelOption.html#SO_TIMEOUT"><y>#</y><d>2022-10-31</d><h>18:22</h><r>Arnaud Geiser</r>Hello!
Are you sure it&apos;s related to your Aleph TCP client? We are doing much on Aleph side regarding TCP, It&apos;s rather trivial. [1]
I don&apos;t know about the Netty defaults, so maybe you can use a <code>bootstrap-transform</code> to set SO_TIMEOUT [2] to a bigger value.

[1] : <a href="https://github.com/exoscale/aleph/blob/master/src/aleph/netty.clj#L977-L984" target="_blank">https://github.com/exoscale/aleph/blob/master/src/aleph/netty.clj#L977-L984</a>
[2] : <a href="https://netty.io/4.1/api/io/netty/channel/ChannelOption.html#SO_TIMEOUT" target="_blank">https://netty.io/4.1/api/io/netty/channel/ChannelOption.html#SO_TIMEOUT</a></z><z id="t1667240685" t="kkruit thanks for the quick response! I&apos;ll look into that."><y>#</y><d>2022-10-31</d><h>18:24</h><r>kkruit</r>thanks for the quick response! I&apos;ll look into that.</z><z id="t1667240725" t="Arnaud Geiser Otherwise, I know that [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] is writing TCP servers with Aleph and might help you better than I can."><y>#</y><d>2022-10-31</d><h>18:25</h><r>Arnaud Geiser</r>Otherwise, I know that <a>@U06GVE6NR</a> is writing TCP servers with Aleph and might help you better than I can.</z><z id="t1667240757" t="kkruit And to your point I don&apos;t think it&apos;s aleph I&apos;m pretty sure it&apos;s netty I just am not too familiar with it."><y>#</y><d>2022-10-31</d><h>18:25</h><r>kkruit</r>And to your point I don&apos;t think it&apos;s aleph I&apos;m pretty sure it&apos;s netty I just am not too familiar with it.</z><z id="t1667240758" t="Arnaud Geiser Is it possible it&apos;s related to a timeout on the server side also?"><y>#</y><d>2022-10-31</d><h>18:25</h><r>Arnaud Geiser</r>Is it possible it&apos;s related to a timeout on the server side also?</z><z id="t1667240825" t="kkruit No, I don&apos;t think so I&apos;ve connected using generic java Socket before and it stays open so I don&apos;t think it&apos;s the server."><y>#</y><d>2022-10-31</d><h>18:27</h><r>kkruit</r>No, I don&apos;t think so I&apos;ve connected using generic java Socket before and it stays open so I don&apos;t think it&apos;s the server.</z><z id="t1667240918" t="Arnaud Geiser I&apos;m more confortable with the HTTP part of it, but to have an idle-timeout behaviour, you need to explicitly define an IdleStateHandler [1] otherwise it will be no timeout at all. That&apos;s why I would expect the default Bootstrap to have no timeout at all. [1] : https://github.com/clj-commons/aleph/blob/master/src/aleph/http/core.clj#L633-L638"><y>#</y><d>2022-10-31</d><h>18:28</h><r>Arnaud Geiser</r>I&apos;m more confortable with the HTTP part of it, but to have an <code>idle-timeout</code> behaviour, you need to explicitly define an <code>IdleStateHandler</code>  [1] otherwise it will be no timeout at all.

That&apos;s why I would expect the default Bootstrap to have no timeout at all.

[1] : <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/core.clj#L633-L638" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/core.clj#L633-L638</a></z><z id="t1667257435" t="kkruit I&apos;ve mostly figured it out. I had a few issues. The biggest underlying issue is the server i&apos;m connecting to allows for 32 bit messages on TLS so any message over 16709 bytes throws a SSLProtocolException. Thanks again for your help!"><y>#</y><d>2022-10-31</d><h>23:03</h><r>kkruit</r>I&apos;ve mostly figured it out. I had a few issues. The biggest underlying issue is the server i&apos;m connecting to allows for 32 bit messages on TLS so any message over 16709 bytes throws a SSLProtocolException. Thanks again for your help!</z><z id="t1667284431" t="Arnaud Geiser Great! You figured it by ourselves.Thanks for the feedback and do not hesitate if we can help."><y>#</y><d>2022-11-01</d><h>06:33</h><r>Arnaud Geiser</r>Great!
You figured it by ourselves.Thanks for the feedback and do not hesitate if we can help.</z><z id="t1667380843" t="dergutemoritz Just to confirm: Yeah, there is no default idle timeout at all for TCP servers and clients."><y>#</y><d>2022-11-02</d><h>09:20</h><r>dergutemoritz</r>Just to confirm: Yeah, there is no default idle timeout at all for TCP servers and clients.</z><z id="t1667380910" t="Arnaud Geiser Thank you Moritz"><y>#</y><d>2022-11-02</d><h>09:21</h><r>Arnaud Geiser</r>Thank you Moritz</z><z id="t1667874395" t="valerauko Would it be possible to make manifold an optional (provided?) dependency in byte-streams? I feel dirty for pulling in half a ton of dependencies when I don&apos;t think I&apos;m using async stream transformations at all"><y>#</y><d>2022-11-08</d><h>02:26</h><w>valerauko</w>Would it be possible to make manifold an optional (provided?) dependency in byte-streams?

I feel dirty for pulling in half a ton of dependencies when I don&apos;t think I&apos;m using async stream transformations at all</z><z id="t1667882251" t="valerauko Something along the lines of splitting the manifold-dependent pushback stream conversions into a separate namespace and only loading them if manifold is on the classpath"><y>#</y><d>2022-11-08</d><h>04:37</h><r>valerauko</r>Something along the lines of splitting the manifold-dependent pushback stream conversions into a separate namespace and only loading them if manifold is on the classpath</z><z id="t1667882414" t="Matthew Davidson (kingmob) Well, depending on your conversion pathway, you might still be using manifold internally. Regardless, it could be done, but not easily. The pushback-related code isn&apos;t the real problem. Conditionally compiling the relevant def-conversion s wouldn&apos;t be too hard either. No, the issue is the code isn&apos;t very polymorphic, so we&apos;d have to weave a lot of conditional compilation macros through various functions. Also def is a special form, and doesn&apos;t play too well with conditional compilation macros, iirc."><y>#</y><d>2022-11-08</d><h>04:40</h><r>Matthew Davidson (kingmob)</r>Well, depending on your conversion pathway, you might still be using manifold internally.

Regardless, it could be done, but not easily. The pushback-related code isn&apos;t the real problem. Conditionally compiling the relevant <code>def-conversion</code> s wouldn&apos;t be too hard either. No, the issue is the code isn&apos;t very polymorphic, so we&apos;d have to weave a lot of conditional compilation macros through various functions. Also <code>def</code> is a special form, and doesn&apos;t play too well with conditional compilation macros, iirc.</z><z id="t1667882523" t="Matthew Davidson (kingmob) Requiring users to know they have to supply manifold is a breaking change, anyway. I would however, be fine with factoring the code out into sub-libraries, as long as the byte-streams API is the same. Then you could use the sublibrary"><y>#</y><d>2022-11-08</d><h>04:42</h><r>Matthew Davidson (kingmob)</r>Requiring users to know they have to supply manifold is a breaking change, anyway. I would however, be fine with factoring the code out into sub-libraries, as long as the byte-streams API is the same. Then you could use the sublibrary</z><z id="t1667882576" t="Matthew Davidson (kingmob) (Btw, we have a #C02H9GF74CF channel for this)"><y>#</y><d>2022-11-08</d><h>04:42</h><r>Matthew Davidson (kingmob)</r>(Btw, we have a #C02H9GF74CF channel for this)</z><z id="t1667882779" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] I don&apos;t have the time to tackle this, but byte-streams could use modernization, and this could be part of it. If you want to separate them, I could work with you on it."><y>#</y><d>2022-11-08</d><h>04:46</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> I don&apos;t have the time to tackle this, but byte-streams could use modernization, and this could be part of it. If you want to separate them, I could work with you on it.</z><z id="t1667883752" t="valerauko Do you imagine something like the way many modular metosin projects are organized? Having a core without the manifold dependency, a module with manifold and then having the &quot;old&quot; top-level library pull in all those?"><y>#</y><d>2022-11-08</d><h>05:02</h><r>valerauko</r>Do you imagine something like the way many modular metosin projects are organized? Having a <code>core</code> without the manifold dependency, a module with manifold and then having the &quot;old&quot; top-level library pull in all those?</z><z id="t1667886599" t="Matthew Davidson (kingmob) I&apos;m not that familiar with the metosin layout, but yes, something like that"><y>#</y><d>2022-11-08</d><h>05:49</h><r>Matthew Davidson (kingmob)</r>I&apos;m not that familiar with the metosin layout, but yes, something like that</z><z id="t1667949315" t="nivekuil what&apos;s up with the https://github.com/clj-commons/aleph/tree/1.0.0 branch? it looks very diverged from master"><y>#</y><d>2022-11-08</d><h>23:15</h><w>nivekuil</w>what&apos;s up with the <a href="https://github.com/clj-commons/aleph/tree/1.0.0" target="_blank">https://github.com/clj-commons/aleph/tree/1.0.0</a> branch? it looks very diverged from master</z><z id="t1667967791" t="Matthew Davidson (kingmob) That was something Oleksii Kachaiev was working on before he moved on from the project. Unfortunately, it was never merged in to master, although we&apos;ve been pulling pieces out here and there, especially for error-handling."><y>#</y><d>2022-11-09</d><h>04:23</h><w>Matthew Davidson (kingmob)</w>That was something Oleksii Kachaiev was working on before he moved on from the project. Unfortunately, it was never merged in to master, although we&apos;ve been pulling pieces out here and there, especially for error-handling.</z><z id="t1668056244" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] We&apos;ve just cut an alpha release of Dirigiste, with some improvements under the hood. If any kind souls want to, give it a spin, and let us know if you find any weirdness or slowness. https://clojars.org/org.clj-commons/dirigiste/versions/1.0.3-alpha1"><y>#</y><d>2022-11-10</d><h>04:57</h><w>Matthew Davidson (kingmob)</w><a>@arnaudgeiser</a> We&apos;ve just cut an alpha release of Dirigiste, with some improvements under the hood. If any kind souls want to, give it a spin, and let us know if you find any weirdness or slowness. <a href="https://clojars.org/org.clj-commons/dirigiste/versions/1.0.3-alpha1" target="_blank">https://clojars.org/org.clj-commons/dirigiste/versions/1.0.3-alpha1</a></z><z id="t1668400078" t="Matthew Davidson (kingmob) I opened up an issue with CircleCI about all the build failures we&apos;re seeing. The suggested fixes (logging out/in, resetting the OAuth) don&apos;t work. circleci config validate says everything is OK. And the failure is intermittent, even on the same branch. The only clue we have is that, timing-wise, the errors started showing up around when the command to download bb was added to the config.yml. I doubt that code itself is the problem, but ¬Ø\(„ÉÑ)/¬Ø"><y>#</y><d>2022-11-14</d><h>04:27</h><w>Matthew Davidson (kingmob)</w>I opened up an issue with CircleCI about all the build failures we&apos;re seeing. The suggested fixes (logging out/in, resetting the OAuth) don&apos;t work. <code>circleci config validate</code> says everything is OK. And the failure is intermittent, even on the same branch.

The only clue we have is that, timing-wise, the errors started showing up around when the command to download bb was added to the config.yml. I doubt that code itself is the problem, but ¬Ø\(„ÉÑ)/¬Ø</z><z id="t1668420811" t="dergutemoritz Hmmm I also added https://github.com/clj-commons/aleph/commit/95cbbdfb8788c0cfa18acf331febb2f4f944f3ee at the same time to switch to CircleCI&apos;s new Docker image. Maybe that&apos;s somehow causing the issue?"><y>#</y><d>2022-11-14</d><h>10:13</h><r>dergutemoritz</r>Hmmm I also added <a href="https://github.com/clj-commons/aleph/commit/95cbbdfb8788c0cfa18acf331febb2f4f944f3ee" target="_blank">https://github.com/clj-commons/aleph/commit/95cbbdfb8788c0cfa18acf331febb2f4f944f3ee</a> at the same time to switch to CircleCI&apos;s new Docker image. Maybe that&apos;s somehow causing the issue?</z><z id="t1668423021" t="Matthew Davidson (kingmob) Could be. Still wouldn‚Äôt explain the error though. If circle is stumped, we can try reverting those changes."><y>#</y><d>2022-11-14</d><h>10:50</h><r>Matthew Davidson (kingmob)</r>Could be. Still wouldn‚Äôt explain the error though. If circle is stumped, we can try reverting those changes.</z><z id="t1668423195" t="dergutemoritz Yeah I can&apos;t see how this would cause this particular issue unless they somehow special-case behavior on the image used üò¨"><y>#</y><d>2022-11-14</d><h>10:53</h><r>dergutemoritz</r>Yeah I can&apos;t see how this would cause this particular issue unless they somehow special-case behavior on the image used <b>üò¨</b></z><z id="t1668423210" t="dergutemoritz Thanks for taking this up!"><y>#</y><d>2022-11-14</d><h>10:53</h><r>dergutemoritz</r>Thanks for taking this up!</z><z id="t1668575605" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U04V5VAUN&quot;}] are you familiar with this issue? CircleCI confirmed this is because the PR submitter is logged out of, or never signed up with, CircleCI. In that case, the Circle workflows are just not run. Unfortunately, the error messages were addressed to me, and didn&apos;t mention the PR submitter, which led to a bunch of wasted time looking at other causes. From me: &gt; Are you saying contributors submitting PRs who have never logged-in/signed up to CircleCI won&apos;t have our CI process run? That&apos;s a huge annoyance for an open-source project accepting PRs from the general public. &gt; &gt; Is there a way around this? Can we run all CI pipelines as a particular user or group? Not require PR contributors to login? Circle&apos;s response: &gt; Our team has been making some changes to how we trigger pipelines depending on whether the committer is known to us or not, and this appears to be affecting Open Source projects like yours in a negative way. We are re-working this methodology and would like to implement something that won&apos;t cause the errors you see any longer. This process is already underway and we are working to get it released as soon as possible. &gt; &gt; Currently, our advice is that the user opening the PR should log in to CircleCI and then trigger the workflow again by re-pushing."><y>#</y><d>2022-11-16</d><h>05:13</h><r>Matthew Davidson (kingmob)</r><a>@slipset</a> are you familiar with this issue?

CircleCI confirmed this is because the PR submitter is logged out of, or never signed up with, CircleCI. In that case, the Circle workflows are just not run. Unfortunately, the error messages were addressed to me, and didn&apos;t mention the PR submitter, which led to a bunch of wasted time looking at other causes.

From me:
&gt; Are you saying contributors submitting PRs who have never logged-in/signed up to CircleCI won&apos;t have our CI process run? That&apos;s a huge annoyance for an open-source project accepting PRs from the general public.
&gt; 
&gt; Is there a way around this? Can we run all CI pipelines as a particular user or group? Not require PR contributors to login?
Circle&apos;s response:
&gt; Our team has been making some changes to how we trigger pipelines depending on whether the committer is known to us or not, and this appears to be affecting Open Source projects like yours in a negative way. We are re-working this methodology and would like to implement something that won&apos;t cause the errors you see any longer. This process is already underway and we are working to get it released as soon as possible.
&gt; 
&gt; Currently, our advice is that the user opening the PR should log in to CircleCI and then trigger the workflow again by re-pushing.</z><z id="t1668585731" t="valerauko that sounds so circleci. stuff like this is why i now run most of my stuff on github actions"><y>#</y><d>2022-11-16</d><h>08:02</h><r>valerauko</r>that sounds so circleci. stuff like this is why i now run most of my stuff on github actions</z><z id="t1668587860" t="Arnaud Geiser At least it&apos;s known on their side.."><y>#</y><d>2022-11-16</d><h>08:37</h><r>Arnaud Geiser</r>At least it&apos;s known on their side..</z><z id="t1668575605" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U04V5VAUN&quot;}] are you familiar with this issue? CircleCI confirmed this is because the PR submitter is logged out of, or never signed up with, CircleCI. In that case, the Circle workflows are just not run. Unfortunately, the error messages were addressed to me, and didn&apos;t mention the PR submitter, which led to a bunch of wasted time looking at other causes. From me: &gt; Are you saying contributors submitting PRs who have never logged-in/signed up to CircleCI won&apos;t have our CI process run? That&apos;s a huge annoyance for an open-source project accepting PRs from the general public. &gt; &gt; Is there a way around this? Can we run all CI pipelines as a particular user or group? Not require PR contributors to login? Circle&apos;s response: &gt; Our team has been making some changes to how we trigger pipelines depending on whether the committer is known to us or not, and this appears to be affecting Open Source projects like yours in a negative way. We are re-working this methodology and would like to implement something that won&apos;t cause the errors you see any longer. This process is already underway and we are working to get it released as soon as possible. &gt; &gt; Currently, our advice is that the user opening the PR should log in to CircleCI and then trigger the workflow again by re-pushing."><y>#</y><d>2022-11-16</d><h>05:13</h><w>Matthew Davidson (kingmob)</w><a>@slipset</a> are you familiar with this issue?

CircleCI confirmed this is because the PR submitter is logged out of, or never signed up with, CircleCI. In that case, the Circle workflows are just not run. Unfortunately, the error messages were addressed to me, and didn&apos;t mention the PR submitter, which led to a bunch of wasted time looking at other causes.

From me:
&gt; Are you saying contributors submitting PRs who have never logged-in/signed up to CircleCI won&apos;t have our CI process run? That&apos;s a huge annoyance for an open-source project accepting PRs from the general public.
&gt; 
&gt; Is there a way around this? Can we run all CI pipelines as a particular user or group? Not require PR contributors to login?
Circle&apos;s response:
&gt; Our team has been making some changes to how we trigger pipelines depending on whether the committer is known to us or not, and this appears to be affecting Open Source projects like yours in a negative way. We are re-working this methodology and would like to implement something that won&apos;t cause the errors you see any longer. This process is already underway and we are working to get it released as soon as possible.
&gt; 
&gt; Currently, our advice is that the user opening the PR should log in to CircleCI and then trigger the workflow again by re-pushing.</z><z id="t1668505248" t="Matthew Davidson (kingmob) For anyone who wants to try the latest and greatest, we have just cut 0.6.0-rc1. Big changes are deps.edn support, better TLS config and error-handling, the ability to replace Dirigiste connection pools with custom versions, and shutdown configuration. Plus, the usual litany of bug fixes and Netty upgrades. https://clojars.org/aleph/versions/0.6.0-rc1 https://github.com/clj-commons/aleph/blob/master/CHANGES.md"><y>#</y><d>2022-11-15</d><h>09:40</h><w>Matthew Davidson (kingmob)</w>For anyone who wants to try the latest and greatest, we have just cut 0.6.0-rc1. Big changes are deps.edn support, better TLS config and error-handling, the ability to replace Dirigiste connection pools with custom versions, and shutdown configuration. Plus, the usual litany of bug fixes and Netty upgrades.

<a href="https://clojars.org/aleph/versions/0.6.0-rc1" target="_blank">https://clojars.org/aleph/versions/0.6.0-rc1</a>
<a href="https://github.com/clj-commons/aleph/blob/master/CHANGES.md" target="_blank">https://github.com/clj-commons/aleph/blob/master/CHANGES.md</a></z><z id="t1668505442" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U04V15CAJ&quot;}] Hey, you helped Moritz with the lein2deps support, right? I&apos;ll add you to the contributors list"><y>#</y><d>2022-11-15</d><h>09:44</h><r>Matthew Davidson (kingmob)</r><a>@U04V15CAJ</a> Hey, you helped Moritz with the lein2deps support, right? I&apos;ll add you to the contributors list</z><z id="t1668509153" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Good call to push a preview release üëç I spotted a bug and possibly an omission in the changelog - I&apos;ll make a PR!"><y>#</y><d>2022-11-15</d><h>10:45</h><r>dergutemoritz</r><a>@U10EC98F5</a> Good call to push a preview release <b>üëç</b> I spotted a bug and possibly an omission in the changelog - I&apos;ll make a PR!</z><z id="t1668509387" t="Arnaud Geiser [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] : We are going to release this version on production soonish. Can I ask you where the bug is located?"><y>#</y><d>2022-11-15</d><h>10:49</h><r>Arnaud Geiser</r><a>@U06GVE6NR</a>: We are going to release this version on production soonish. Can I ask you where the bug is located?</z><z id="t1668509425" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] Only in the changelog itself, see https://github.com/clj-commons/aleph/pull/644 üôÇ"><y>#</y><d>2022-11-15</d><h>10:50</h><r>dergutemoritz</r><a>@UFKCFTVB8</a> Only in the changelog itself, see <a href="https://github.com/clj-commons/aleph/pull/644" target="_blank">https://github.com/clj-commons/aleph/pull/644</a> <b>üôÇ</b></z><z id="t1668509479" t="Arnaud Geiser Ah, could be worse!"><y>#</y><d>2022-11-15</d><h>10:51</h><r>Arnaud Geiser</r>Ah, could be worse!</z><z id="t1668509540" t="Arnaud Geiser [:attrs {:href &quot;/_/_/users/U04V15CAJ&quot;}] : I&apos;m not German, but I got the joke!"><y>#</y><d>2022-11-15</d><h>10:52</h><r>Arnaud Geiser</r><a>@U04V15CAJ</a>: I&apos;m not German, but I got the joke!</z><z id="t1668509540" t="dergutemoritz Indeed, just polish for the release proper üôÇ"><y>#</y><d>2022-11-15</d><h>10:52</h><r>dergutemoritz</r>Indeed, just polish for the release proper <b>üôÇ</b></z><z id="t1668509570" t="dergutemoritz Did you hear that at the 2022 sausage competition, Germany did the wurst?"><y>#</y><d>2022-11-15</d><h>10:52</h><r>dergutemoritz</r>Did you hear that at the 2022 sausage competition, Germany did the wurst?</z><z id="t1668509578" t="borkdude lol"><y>#</y><d>2022-11-15</d><h>10:52</h><r>borkdude</r>lol</z><z id="t1668509809" t="borkdude https://twitter.com/borkdude/status/1592471608668852224 ;)"><y>#</y><d>2022-11-15</d><h>10:56</h><r>borkdude</r><a href="https://twitter.com/borkdude/status/1592471608668852224" target="_blank">https://twitter.com/borkdude/status/1592471608668852224</a> ;)</z><z id="t1668518361" t="valerauko would it be possible in the future to release netty upgrades quicker? like having a 0.5.x branch and now you make a 0.6.x branch and we could have quicker cadence getting latest netty. netty cut three new releases since i updated the version in aleph&apos;s project.clj... since netty patch releases are extremely unlikely to break anything, aleph users could get their hands on netty improvements asap. feature changes/additions could still take the rc16 route if necessary"><y>#</y><d>2022-11-15</d><h>13:19</h><w>valerauko</w>would it be possible in the future to release netty upgrades quicker?

like having a 0.5.x branch and now you make a 0.6.x branch and we could have quicker cadence getting latest netty. netty cut three new releases since i updated the version in aleph&apos;s project.clj...

since netty patch releases are extremely unlikely to break anything, aleph users could get their hands on netty improvements asap. feature changes/additions could still take the rc16 route if necessary</z><z id="t1668518533" t="Arnaud Geiser I don&apos;t know [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] &apos;s take on this. But my recommendation would be to enforce the Netty dependencies on your project and exclude the ones from Aleph. Otherwise, we&apos;ll constantly releasing Aleph versions which contain barely nothing on them."><y>#</y><d>2022-11-15</d><h>13:22</h><r>Arnaud Geiser</r>I don&apos;t know <a>@U10EC98F5</a>&apos;s take on this. But my recommendation would be to enforce the Netty dependencies on your project and exclude the ones from Aleph.
Otherwise, we&apos;ll constantly releasing Aleph versions which contain barely nothing on them.</z><z id="t1668518558" t="valerauko is there a problem with that?"><y>#</y><d>2022-11-15</d><h>13:22</h><r>valerauko</r>is there a problem with that?</z><z id="t1668518591" t="Arnaud Geiser You mean, releasing more often?"><y>#</y><d>2022-11-15</d><h>13:23</h><r>Arnaud Geiser</r>You mean, releasing more often?</z><z id="t1668518620" t="valerauko yes."><y>#</y><d>2022-11-15</d><h>13:23</h><r>valerauko</r>yes.</z><z id="t1668518718" t="Arnaud Geiser I don&apos;t think so... But I don&apos;t think [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] would like to release Aleph every 2 days. But maybe on a cadence of 2 weeks, would it work for you? (anyway, let&apos;s wait for his answer)"><y>#</y><d>2022-11-15</d><h>13:25</h><r>Arnaud Geiser</r>I don&apos;t think so... But I don&apos;t think <a>@U10EC98F5</a> would like to release Aleph every 2 days.
But maybe on a cadence of 2 weeks, would it work for you? (anyway, let&apos;s wait for his answer)</z><z id="t1668518838" t="valerauko https://mvnrepository.com/artifact/io.netty/netty-all that often... occasionally there&apos;s a quick next release to fix a regression but usually it&apos;s once a month or so."><y>#</y><d>2022-11-15</d><h>13:27</h><r>valerauko</r><a href="https://mvnrepository.com/artifact/io.netty/netty-all" target="_blank">https://mvnrepository.com/artifact/io.netty/netty-all</a> that often... occasionally there&apos;s a quick next release to fix a regression but usually it&apos;s once a month or so.</z><z id="t1668518869" t="Arnaud Geiser So I got your point, we are too slow here :D"><y>#</y><d>2022-11-15</d><h>13:27</h><r>Arnaud Geiser</r>So I got your point, we are too slow here :D</z><z id="t1668519148" t="valerauko it&apos;s got way better since the libraries went over to clj-commons, but i think there can be an even better balance"><y>#</y><d>2022-11-15</d><h>13:32</h><r>valerauko</r>it&apos;s got way better since the libraries went over to clj-commons, but i think there can be an even better balance</z><z id="t1668524464" t="Matthew Davidson (kingmob) I agree the current cadence should be sped up. But bumping Aleph just for Netty doesn&apos;t really appeal to me. There&apos;s still a little work involved, and as Arnaud mentioned, people who want the latest netty bugfixes can add it to their own project.clj. I think this is worth revisiting once we have automatic CI deployments for Aleph."><y>#</y><d>2022-11-15</d><h>15:01</h><r>Matthew Davidson (kingmob)</r>I agree the current cadence should be sped up. But bumping Aleph just for Netty doesn&apos;t really appeal to me. There&apos;s still a little work involved, and as Arnaud mentioned, people who want the latest netty bugfixes can add it to their own project.clj.

I think this is worth revisiting once we have automatic CI deployments for Aleph.</z><z id="t1668525879" t="valerauko sounds good. if you need reference for CI releases, https://github.com/valerauko/csele/blob/master/.github/workflows/deploy.yaml might be useful. i prefer to make my releases by hand but even that can be automated if you use tag pushes as trigger (dunno how it&apos;d work with circleci though)"><y>#</y><d>2022-11-15</d><h>15:24</h><r>valerauko</r>sounds good. if you need reference for CI releases, <a href="https://github.com/valerauko/csele/blob/master/.github/workflows/deploy.yaml" target="_blank">https://github.com/valerauko/csele/blob/master/.github/workflows/deploy.yaml</a> might be useful. i prefer to make my releases by hand but even that can be automated if you use tag pushes as trigger (dunno how it&apos;d work with circleci though)</z><z id="t1668527766" t="Matthew Davidson (kingmob) Thanks for sharing that. We might try it out. Erik already set up some clj-commons scripts for tag-based releases from CircleCI. Our obstacle is that Zach&apos;s biggest libs don&apos;t use the clj-commons mvn group, which means the credentials require a different set up. Due to the large install base (Aleph 0.4.6 was downloaded a million times), changing the mvn group could mean a lot of users won&apos;t find it. OTOH, it&apos;s been a while since we revived Aleph; maybe now&apos;s the time to switch to clj-commons."><y>#</y><d>2022-11-15</d><h>15:56</h><r>Matthew Davidson (kingmob)</r>Thanks for sharing that. We might try it out.

Erik already set up some clj-commons scripts for tag-based releases from CircleCI. Our obstacle is that Zach&apos;s biggest libs don&apos;t use the clj-commons mvn group, which means the credentials require a different set up. Due to the large install base (Aleph 0.4.6 was downloaded a million times), changing the mvn group could mean a lot of users won&apos;t find it. OTOH, it&apos;s been a while since we revived Aleph; maybe now&apos;s the time to switch to clj-commons.</z><z id="t1668529898" t="dergutemoritz Switching over to the clj-commons group sounds good to me, too üëç We could push a final release to the old group which just throws an exception on require which points to the new one üòÑ"><y>#</y><d>2022-11-15</d><h>16:31</h><r>dergutemoritz</r>Switching over to the  <code>clj-commons</code> group sounds good to me, too <b>üëç</b>  We could push a final release to the old group which just throws an exception on require which points to the new one <b>üòÑ</b></z><z id="t1668835589" t="nivekuil tried 0.6.0, got Caused by: java.lang.LinkageError: Possible multiple incompatible native libraries on the classpath for &apos;/tmp/libnetty_transport_native_epoll_x86_642482697031798244878.so when starting server"><y>#</y><d>2022-11-19</d><h>05:26</h><w>nivekuil</w>tried 0.6.0, got  <code>Caused by: java.lang.LinkageError: Possible multiple incompatible native libraries on the classpath for &apos;/tmp/libnetty_transport_native_epoll_x86_642482697031798244878.so</code> when starting server</z><z id="t1668843323" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U797MAJ8M&quot;}] Interesting. I‚Äôll take a closer look later, but right off the bat, are you bringing in your own netty deps somehow (check lein deps :tree )?"><y>#</y><d>2022-11-19</d><h>07:35</h><r>Matthew Davidson (kingmob)</r><a>@U797MAJ8M</a> Interesting. I‚Äôll take a closer look later, but right off the bat, are you bringing in your own netty deps somehow (check <code>lein deps :tree</code>)?</z><z id="t1668855299" t="nivekuil huh, yup apparently jackdaw snuck in a bunch of netty deps recently."><y>#</y><d>2022-11-19</d><h>10:54</h><r>nivekuil</r>huh, yup apparently jackdaw snuck in a bunch of netty deps recently.</z><z id="t1668859351" t="Matthew Davidson (kingmob) If you exclude the aleph and netty deps of Jackdaw, is it working?"><y>#</y><d>2022-11-19</d><h>12:02</h><r>Matthew Davidson (kingmob)</r>If you exclude the aleph and netty deps of Jackdaw, is it working?</z><z id="t1668907603" t="nivekuil indeed, just a dep conflict"><y>#</y><d>2022-11-20</d><h>01:26</h><r>nivekuil</r>indeed, just a dep conflict</z><z id="t1669154909" t="Eugen would it be hard to try aleph on virtual thread? I heard / read in a few places that it is comparable to native performance. https://medium.com/@zakgof/a-simple-benchmark-for-jdk-project-looms-virtual-threads-4f43ef8aeb1"><y>#</y><d>2022-11-22</d><h>22:08</h><w>Eugen</w>would it be hard to try aleph on virtual thread?
I heard / read in a few places that it is comparable to native performance.
<a href="https://medium.com/@zakgof/a-simple-benchmark-for-jdk-project-looms-virtual-threads-4f43ef8aeb1" target="_blank">https://medium.com/@zakgof/a-simple-benchmark-for-jdk-project-looms-virtual-threads-4f43ef8aeb1</a></z><z id="t1669169527" t="valerauko my naive and unresearched opinion is that if you can get a virtual thread executor and give it to aleph, you can try it"><y>#</y><d>2022-11-23</d><h>02:12</h><r>valerauko</r>my naive and unresearched opinion is that if you can get a virtual thread executor and give it to aleph, you can try it</z><z id="t1669177471" t="Matthew Davidson (kingmob) We&apos;ve been playing around with it, and I&apos;ve started work on a Manifold-compatible successor that uses vthreads, but off the top of my head, I&apos;m not sure how much higher performance we could expect to see in Aleph, from switching over immediately. Part of the underlying machinery is based off Netty, which is entirely event-driven off platform threads at the moment. An https://github.com/netty/netty/issues/12348 wasn&apos;t promising, but there&apos;s more to look into, to make netty take advantage of vthreads. It&apos;s not a simple drop-in, unfortunately, since things like ThreadLocal caches will hurt performance in a vthread world, if copied rampantly. Ultimately, though, the event-driven paradigm doesn&apos;t make much sense if vthreads are super-cheap. It&apos;s a shame https://github.com/puniverse/pulsar died out (one of the Pulsar authors went on to work on Loom); it was the first clj lib built for fibers. For now, you can partially try it out by redefining the wait-pool and executor-pool in manifold.executor to use the new vthread executor. Let us know what you find."><y>#</y><d>2022-11-23</d><h>04:24</h><r>Matthew Davidson (kingmob)</r>We&apos;ve been playing around with it, and I&apos;ve started work on a Manifold-compatible successor that uses vthreads, but off the top of my head, I&apos;m not sure how much higher performance we could expect to see in Aleph, from switching over immediately.

Part of the underlying machinery is based off Netty, which is entirely event-driven off platform threads at the moment. An <a href="https://github.com/netty/netty/issues/12348" target="_blank">https://github.com/netty/netty/issues/12348</a> wasn&apos;t promising, but there&apos;s more to look into, to make netty take advantage of vthreads. It&apos;s not a simple drop-in, unfortunately, since things like ThreadLocal caches will hurt performance in a vthread world, if copied rampantly.

Ultimately, though, the event-driven paradigm doesn&apos;t make much sense if vthreads are super-cheap. It&apos;s a shame <a href="https://github.com/puniverse/pulsar" target="_blank">https://github.com/puniverse/pulsar</a> died out (one of the Pulsar authors went on to work on Loom); it was the first clj lib built for fibers.

For now, you can partially try it out by redefining the <code>wait-pool</code> and <code>executor-pool</code> in <code>manifold.executor</code> to use the new vthread executor. Let us know what you find.</z><z id="t1669177837" t="valerauko there are caveats https://github.com/netty/netty/issues/12348"><y>#</y><d>2022-11-23</d><h>04:30</h><r>valerauko</r>there are caveats <a href="https://github.com/netty/netty/issues/12348" target="_blank">https://github.com/netty/netty/issues/12348</a></z><z id="t1669206215" t="Eugen thanks, I hope I find some time to play with this"><y>#</y><d>2022-11-23</d><h>12:23</h><r>Eugen</r>thanks, I hope I find some time to play with this</z><z id="t1669177471" t="Matthew Davidson (kingmob) We&apos;ve been playing around with it, and I&apos;ve started work on a Manifold-compatible successor that uses vthreads, but off the top of my head, I&apos;m not sure how much higher performance we could expect to see in Aleph, from switching over immediately. Part of the underlying machinery is based off Netty, which is entirely event-driven off platform threads at the moment. An https://github.com/netty/netty/issues/12348 wasn&apos;t promising, but there&apos;s more to look into, to make netty take advantage of vthreads. It&apos;s not a simple drop-in, unfortunately, since things like ThreadLocal caches will hurt performance in a vthread world, if copied rampantly. Ultimately, though, the event-driven paradigm doesn&apos;t make much sense if vthreads are super-cheap. It&apos;s a shame https://github.com/puniverse/pulsar died out (one of the Pulsar authors went on to work on Loom); it was the first clj lib built for fibers. For now, you can partially try it out by redefining the wait-pool and executor-pool in manifold.executor to use the new vthread executor. Let us know what you find."><y>#</y><d>2022-11-23</d><h>04:24</h><w>Matthew Davidson (kingmob)</w>We&apos;ve been playing around with it, and I&apos;ve started work on a Manifold-compatible successor that uses vthreads, but off the top of my head, I&apos;m not sure how much higher performance we could expect to see in Aleph, from switching over immediately.

Part of the underlying machinery is based off Netty, which is entirely event-driven off platform threads at the moment. An <a href="https://github.com/netty/netty/issues/12348" target="_blank">https://github.com/netty/netty/issues/12348</a> wasn&apos;t promising, but there&apos;s more to look into, to make netty take advantage of vthreads. It&apos;s not a simple drop-in, unfortunately, since things like ThreadLocal caches will hurt performance in a vthread world, if copied rampantly.

Ultimately, though, the event-driven paradigm doesn&apos;t make much sense if vthreads are super-cheap. It&apos;s a shame <a href="https://github.com/puniverse/pulsar" target="_blank">https://github.com/puniverse/pulsar</a> died out (one of the Pulsar authors went on to work on Loom); it was the first clj lib built for fibers.

For now, you can partially try it out by redefining the <code>wait-pool</code> and <code>executor-pool</code> in <code>manifold.executor</code> to use the new vthread executor. Let us know what you find.</z><z id="t1670318703" t="Matthew Davidson (kingmob) Released aleph 0.6.0-rc2. The only real differences from rc1 are upgrading to the latest Netty 4.1.85 and adding some basic kondo support for the HTTP verb macros. https://clojars.org/aleph/versions/0.6.0-rc2 This will probably the last release candidate before 0.6.0."><y>#</y><d>2022-12-06</d><h>09:25</h><w>Matthew Davidson (kingmob)</w>Released aleph 0.6.0-rc2. The only real differences from rc1 are upgrading to the latest Netty 4.1.85 and adding some basic kondo support for the HTTP verb macros. <a href="https://clojars.org/aleph/versions/0.6.0-rc2" target="_blank">https://clojars.org/aleph/versions/0.6.0-rc2</a>

This will probably the last release candidate before 0.6.0.</z><z id="t1670918420" t="Matthew Davidson (kingmob) Announcing Aleph 0.6.0! Huzzah! Big changes are deps.edn support, better TLS config and error-handling, the ability to replace Dirigiste connection pools with custom versions, and shutdown configuration options. Plus, the usual litany of bug fixes and Netty upgrades. https://clojars.org/aleph/versions/0.6.0 https://github.com/clj-commons/aleph/blob/master/CHANGES.md"><y>#</y><d>2022-12-13</d><h>08:00</h><w>Matthew Davidson (kingmob)</w>Announcing Aleph 0.6.0! Huzzah!

Big changes are deps.edn support, better TLS config and error-handling, the ability to replace Dirigiste connection pools with custom versions, and shutdown configuration options. Plus, the usual litany of bug fixes and Netty upgrades.

<a href="https://clojars.org/aleph/versions/0.6.0" target="_blank">https://clojars.org/aleph/versions/0.6.0</a>
<a href="https://github.com/clj-commons/aleph/blob/master/CHANGES.md" target="_blank">https://github.com/clj-commons/aleph/blob/master/CHANGES.md</a></z><z id="t1671653633" t="p-himik Just tried upgrading Aleph from 0.4.7-alpha5 to 0.6.0 (using Yada on top of it). It started giving this error: java.lang.IllegalArgumentException: Don&apos;t know how to convert class io.netty.buffer.PooledSlicedByteBuf into class [B at byte_streams$convert.invokeStatic(byte_streams.clj:212) at byte_streams$convert.invoke(byte_streams.clj:173) at byte_streams$to_byte_array.invokeStatic(byte_streams.clj:797) at byte_streams$to_byte_array.invoke(byte_streams.clj:789) at byte_streams$to_byte_array.invokeStatic(byte_streams.clj:792) at byte_streams$to_byte_array.invoke(byte_streams.clj:789) at manifold.stream$map$fn__31455.invoke(stream.clj:621) [...] It happens when Yada tries to convert a request&apos;s body into a byte array. Debugged for a bit, got it down to this code: (do (require &apos;[byte-streams.graph :as g]) (import io.netty.buffer.PooledSlicedByteBuf) (require &apos;byte-streams) (require &apos;aleph.netty) (g/conversion-fn @byte-streams/conversions (g/type PooledSlicedByteBuf) (g/type (class (byte-array 0))))) Running it on the old version gives me some conversion function. Running it on the new version gives me nil . What would be the right way to fix this?"><y>#</y><d>2022-12-21</d><h>20:13</h><w>p-himik</w>Just tried upgrading Aleph from <code>0.4.7-alpha5</code> to <code>0.6.0</code> (using Yada on top of it).
It started giving this error:
<pre>java.lang.IllegalArgumentException: Don&apos;t know how to convert class io.netty.buffer.PooledSlicedByteBuf into class [B
	at byte_streams$convert.invokeStatic(byte_streams.clj:212)
	at byte_streams$convert.invoke(byte_streams.clj:173)
	at byte_streams$to_byte_array.invokeStatic(byte_streams.clj:797)
	at byte_streams$to_byte_array.invoke(byte_streams.clj:789)
	at byte_streams$to_byte_array.invokeStatic(byte_streams.clj:792)
	at byte_streams$to_byte_array.invoke(byte_streams.clj:789)
	at manifold.stream$map$fn__31455.invoke(stream.clj:621)
    [...]</pre>
It happens when Yada tries to convert a request&apos;s body into a byte array.

Debugged for a bit, got it down to this code:
<pre>(do (require &apos;[byte-streams.graph :as g])
    (import io.netty.buffer.PooledSlicedByteBuf)
    (require &apos;byte-streams)
    (require &apos;aleph.netty)
    (g/conversion-fn @byte-streams/conversions (g/type PooledSlicedByteBuf) (g/type (class (byte-array 0)))))</pre>
Running it on the old version gives me some conversion function.
Running it on the new version gives me <code>nil</code>.

What would be the right way to fix this?</z><z id="t1671654560" t="p-himik Created an MRE: https://github.com/p-himik/aleph-bytebuf-conversion-issue-test"><y>#</y><d>2022-12-21</d><h>20:29</h><r>p-himik</r>Created an MRE: <a href="https://github.com/p-himik/aleph-bytebuf-conversion-issue-test" target="_blank">https://github.com/p-himik/aleph-bytebuf-conversion-issue-test</a></z><z id="t1671654892" t="p-himik Seems like the difference has appeared in 0.5.0-rc1 ."><y>#</y><d>2022-12-21</d><h>20:34</h><r>p-himik</r>Seems like the difference has appeared in <code>0.5.0-rc1</code>.</z><z id="t1671655737" t="p-himik Oh, crap... byte-streams is now split in two. Well that&apos;s a bloody nightmare. If I have any library that requires byte-streams , it will not be compatible with the new version of Aleph."><y>#</y><d>2022-12-21</d><h>20:48</h><r>p-himik</r>Oh, crap...
<code>byte-streams</code> is now split in two. Well that&apos;s a bloody nightmare.
If I have any library that requires <code>byte-streams</code>, it will not be compatible with the new version of Aleph.</z><z id="t1671656114" t="p-himik Commented here: https://github.com/clj-commons/byte-streams/issues/63#issuecomment-1362080491"><y>#</y><d>2022-12-21</d><h>20:55</h><r>p-himik</r>Commented here: <a href="https://github.com/clj-commons/byte-streams/issues/63#issuecomment-1362080491" target="_blank">https://github.com/clj-commons/byte-streams/issues/63#issuecomment-1362080491</a></z><z id="t1671687921" t="Matthew Davidson (kingmob) See https://github.com/clj-commons/byte-streams/pull/66"><y>#</y><d>2022-12-22</d><h>05:45</h><r>Matthew Davidson (kingmob)</r>See <a href="https://github.com/clj-commons/byte-streams/pull/66" target="_blank">https://github.com/clj-commons/byte-streams/pull/66</a></z><z id="t1671691149" t="p-himik Thanks! Will try a bit later today."><y>#</y><d>2022-12-22</d><h>06:39</h><r>p-himik</r>Thanks! Will try a bit later today.</z><z id="t1685705600" t="iku000888 Hello, sorry for the blast from the past... I googled the following and brought me here java.lang.IllegalArgumentException: Don&apos;t know how to convert class io.netty.buffer.PooledSlicedByteBuf into class [B at byte_streams$convert.invokeStatic (byte_streams.clj:196) byte_streams$convert.invoke (byte_streams.clj:162) byte_streams.graph$seq_conversion_fn$fn__27758$fn__27765.invoke (graph.clj:314) clojure.core$map$fn__5884.invoke (core.clj:2759) clojure.lang.LazySeq.sval (LazySeq.java:42) clojure.lang.LazySeq.seq (LazySeq.java:51) clojure.lang.RT.seq (RT.java:535) clojure.core$seq__5419.invokeStatic (core.clj:139) clojure.core$map$fn__5884.invoke (core.clj:2750) clojure.lang.LazySeq.sval (LazySeq.java:42) clojure.lang.LazySeq.seq (LazySeq.java:51) clojure.lang.RT.seq (RT.java:535) clojure.core$seq__5419.invokeStatic (core.clj:139) clojure.core$empty_QMARK_.invokeStatic (core.clj:6195) clojure.core$empty_QMARK_.invoke (core.clj:6195) manifold.stream.seq.SeqSource.take (seq.clj:42) manifold.stream.graph$sync_connect$f__2887__auto____4902.invoke (graph.clj:272) clojure.lang.AFn.run (AFn.java:22) io.aleph.dirigiste.Executor$3.run (Executor.java:320) io.aleph.dirigiste.Executor$Worker$1.run (Executor.java:62) manifold.executor$thread_factory$reify__2329$f__2330.invoke (executor.clj:70) clojure.lang.AFn.run (AFn.java:22) java.lang.Thread.run (Thread.java:833) I gathered from the links the issues were resolved in latest versions, bumped libs to the following and still seem to see the error. [yada &quot;1.2.15&quot;] ;; [aleph &quot;0.6.2&quot;] [org.clj-commons/byte-streams &quot;0.3.2&quot;] [manifold &quot;0.4.1&quot;] And thanks [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] for heroically maintaining all these libraries!"><y>#</y><d>2023-06-02</d><h>11:33</h><r>iku000888</r>Hello, sorry for the blast from the past...
I googled the following and brought me here
<pre>java.lang.IllegalArgumentException: Don&apos;t know how to convert class io.netty.buffer.PooledSlicedByteBuf into class [B
                                                                                                                    at byte_streams$convert.invokeStatic (byte_streams.clj:196)
                                                                                                                    byte_streams$convert.invoke (byte_streams.clj:162)
                                                                                                                    byte_streams.graph$seq_conversion_fn$fn__27758$fn__27765.invoke (graph.clj:314)
                                                                                                                    clojure.core$map$fn__5884.invoke (core.clj:2759)
                                                                                                                    clojure.lang.LazySeq.sval (LazySeq.java:42)
                                                                                                                    clojure.lang.LazySeq.seq (LazySeq.java:51)
                                                                                                                    clojure.lang.RT.seq (RT.java:535)
                                                                                                                    clojure.core$seq__5419.invokeStatic (core.clj:139)
                                                                                                                    clojure.core$map$fn__5884.invoke (core.clj:2750)
                                                                                                                    clojure.lang.LazySeq.sval (LazySeq.java:42)
                                                                                                                    clojure.lang.LazySeq.seq (LazySeq.java:51)
                                                                                                                    clojure.lang.RT.seq (RT.java:535)
                                                                                                                    clojure.core$seq__5419.invokeStatic (core.clj:139)
                                                                                                                    clojure.core$empty_QMARK_.invokeStatic (core.clj:6195)
                                                                                                                    clojure.core$empty_QMARK_.invoke (core.clj:6195)
                                                                                                                    manifold.stream.seq.SeqSource.take (seq.clj:42)
                                                                                                                    manifold.stream.graph$sync_connect$f__2887__auto____4902.invoke (graph.clj:272)
                                                                                                                    clojure.lang.AFn.run (AFn.java:22)
                                                                                                                    io.aleph.dirigiste.Executor$3.run (Executor.java:320)
                                                                                                                    io.aleph.dirigiste.Executor$Worker$1.run (Executor.java:62)
                                                                                                                    manifold.executor$thread_factory$reify__2329$f__2330.invoke (executor.clj:70)
                                                                                                                    clojure.lang.AFn.run (AFn.java:22)
                                                                                                                    java.lang.Thread.run (Thread.java:833)</pre>
I gathered from the links the issues were resolved in latest versions, bumped libs to the following and still seem to see the error.
<pre>[yada &quot;1.2.15&quot;]

                 ;; 
                 [aleph &quot;0.6.2&quot;]
                 [org.clj-commons/byte-streams &quot;0.3.2&quot;]
                 [manifold &quot;0.4.1&quot;]</pre>
And thanks <a>@U10EC98F5</a> for heroically maintaining all these libraries!</z><z id="t1685706688" t="iku000888 I downgraded the dependencies like this and the problem is gone (i.e. request body id properly consumed) ;; [aleph &quot;0.4.7-alpha5&quot;]#_[aleph &quot;0.6.2&quot;] #_[org.clj-commons/byte-streams &quot;0.3.2&quot;] [manifold &quot;0.1.9-alpha3&quot;]#_[manifold &quot;0.4.1&quot;]"><y>#</y><d>2023-06-02</d><h>11:51</h><r>iku000888</r>I downgraded the dependencies like this and the problem is gone (i.e. request body id properly consumed)
<pre>;; 
                 [aleph &quot;0.4.7-alpha5&quot;]#_[aleph &quot;0.6.2&quot;]
                 #_[org.clj-commons/byte-streams &quot;0.3.2&quot;]
                 [manifold &quot;0.1.9-alpha3&quot;]#_[manifold &quot;0.4.1&quot;]</pre></z><z id="t1685706856" t="Matthew Davidson (kingmob) Hmmm."><y>#</y><d>2023-06-02</d><h>11:54</h><r>Matthew Davidson (kingmob)</r>Hmmm.</z><z id="t1685706907" t="Matthew Davidson (kingmob) byte-streams is synced with the latest Aleph, but I&apos;ve been busy with adding HTTP/2 and haven&apos;t made sure the latest manifold is synced up"><y>#</y><d>2023-06-02</d><h>11:55</h><r>Matthew Davidson (kingmob)</r>byte-streams is synced with the latest Aleph, but I&apos;ve been busy with adding HTTP/2 and haven&apos;t made sure the latest manifold is synced up</z><z id="t1685707282" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0ZS009CN&quot;}] BTW, do you have a minimal example I could look at, with yada in the mix?"><y>#</y><d>2023-06-02</d><h>12:01</h><r>Matthew Davidson (kingmob)</r><a>@U0ZS009CN</a> BTW, do you have a minimal example I could look at, with yada in the mix?</z><z id="t1685707607" t="Matthew Davidson (kingmob) Also, does moving yada after aleph/bs/manifold fix the issues?"><y>#</y><d>2023-06-02</d><h>12:06</h><r>Matthew Davidson (kingmob)</r>Also, does moving yada after aleph/bs/manifold fix the issues?</z><z id="t1685735336" t="iku000888 Thanks [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] ! I did eventually figured out that yada&apos;s byte-streams was being picked up and excluding it from yada resolved the issue! https://clojurians.slack.com/archives/C0G922PCH/p1685706615663399 The project is not minimal so this is the best I can share at the moment üôè"><y>#</y><d>2023-06-02</d><h>19:48</h><r>iku000888</r>Thanks <a>@U10EC98F5</a>!
I did eventually figured out that yada&apos;s byte-streams was being picked up and excluding it from yada resolved the issue!
<a href="https://clojurians.slack.com/archives/C0G922PCH/p1685706615663399" target="_blank">https://clojurians.slack.com/archives/C0G922PCH/p1685706615663399</a>
The project is not minimal so this is the best I can share at the moment <b>üôè</b></z><z id="t1685773483" t="Matthew Davidson (kingmob) Glad it worked out"><y>#</y><d>2023-06-03</d><h>06:24</h><r>Matthew Davidson (kingmob)</r>Glad it worked out</z><z id="t1685773553" t="Matthew Davidson (kingmob) Unfortunately, it doesn&apos;t look like anyone&apos;s updated yada in 3 years, or I&apos;d submit a PR"><y>#</y><d>2023-06-03</d><h>06:25</h><r>Matthew Davidson (kingmob)</r>Unfortunately, it doesn&apos;t look like anyone&apos;s updated yada in 3 years, or I&apos;d submit a PR</z><z id="t1685781700" t="iku000888 Yeah, reading between the lines of https://gist.github.com/malcolmsparks/bcfdcd9ae51e69aa3018c04d48f8749b it seems like there is something on the horizon :thinking_face:"><y>#</y><d>2023-06-03</d><h>08:41</h><r>iku000888</r>Yeah, reading between the lines of <a href="https://gist.github.com/malcolmsparks/bcfdcd9ae51e69aa3018c04d48f8749b" target="_blank">https://gist.github.com/malcolmsparks/bcfdcd9ae51e69aa3018c04d48f8749b</a> it seems like there is something on the horizon <b>:thinking_face:</b></z><z id="t1685781838" t="iku000888 esp. &gt; I have since arrived at the opinion that what yada attempts is too ambitious."><y>#</y><d>2023-06-03</d><h>08:43</h><r>iku000888</r>esp.
&gt; I have since arrived at the opinion that what yada attempts is too ambitious.</z><z id="t1671678522" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U2FRKM4TW&quot;}] Sorry you had to go through that. We can&apos;t really remove the duplicate namespaces, but we can make one import the vars from the other, which should prevent this issue in the future. Fundamentally, single-segment namespaces are problematic, and are discouraged for good reason these days. We know they interfere with Graal, and there&apos;s certainly more lurking time bombs, because they violate the widespread assumption that a class will be in a package."><y>#</y><d>2022-12-22</d><h>03:08</h><w>Matthew Davidson (kingmob)</w><a>@p-himik</a> Sorry you had to go through that.

We can&apos;t really remove the duplicate namespaces, but we can make one import the vars from the other, which should prevent this issue in the future.

Fundamentally, single-segment namespaces are problematic, and are discouraged for good reason these days. We know they interfere with Graal, and there&apos;s certainly more lurking time bombs, because they violate the widespread assumption that a class will be in a package.</z><z id="t1671705574" t="Matthew Davidson (kingmob) https://clojars.org/org.clj-commons/byte-streams/versions/0.3.2 [:attrs {:href &quot;/_/_/users/U2FRKM4TW&quot;}]"><y>#</y><d>2022-12-22</d><h>10:39</h><w>Matthew Davidson (kingmob)</w><a href="https://clojars.org/org.clj-commons/byte-streams/versions/0.3.2" target="_blank">https://clojars.org/org.clj-commons/byte-streams/versions/0.3.2</a> <a>@p-himik</a></z><z id="t1671705689" t="Matthew Davidson (kingmob) Eugene, let us know if that fixes your issue, and if so I&apos;ll announce the release more widely"><y>#</y><d>2022-12-22</d><h>10:41</h><w>Matthew Davidson (kingmob)</w>Eugene, let us know if that fixes your issue, and if so I&apos;ll announce the release more widely</z><z id="t1671706993" t="p-himik Fantastic! That seems to be working just fine. Thank you for such a prompt fix."><y>#</y><d>2022-12-22</d><h>11:03</h><r>p-himik</r>Fantastic! That seems to be working just fine.
Thank you for such a prompt fix.</z><z id="t1671782754" t="Matthew Davidson (kingmob) I&apos;ve also got an updated Aleph 0.6.1 with updated deps, but I think it&apos;s going to wait until the new year, since nobody&apos;s around... üéÑ"><y>#</y><d>2022-12-23</d><h>08:05</h><r>Matthew Davidson (kingmob)</r>I&apos;ve also got an updated Aleph 0.6.1 with updated deps, but I think it&apos;s going to wait until the new year, since nobody&apos;s around... <b>üéÑ</b></z><z id="t1674227042" t="dergutemoritz Thanks for the fix, just went through the same pain üò¨ [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Happy to help shepherding through a 0.6.1 release!"><y>#</y><d>2023-01-20</d><h>15:04</h><r>dergutemoritz</r>Thanks for the fix, just went through the same pain <b>üò¨</b>  <a>@kingmob</a> Happy to help shepherding through a 0.6.1 release!</z><z id="t1674228492" t="dergutemoritz Argh, spoke too soon"><y>#</y><d>2023-01-20</d><h>15:28</h><r>dergutemoritz</r>Argh, spoke too soon</z><z id="t1674228505" t="dergutemoritz Looks like I actually have a different problem, it seemed similar"><y>#</y><d>2023-01-20</d><h>15:28</h><r>dergutemoritz</r>Looks like I actually have a different problem, it seemed similar</z><z id="t1674228509" t="dergutemoritz Execution error (ClassCastException) at clj_commons.byte_streams.graph.ConversionGraph/assoc_conversion (graph.clj:117). class clj_commons.byte_streams.graph.Type cannot be cast to class clj_commons.byte_streams.graph.Type (clj_commons.byte_streams.graph.Type is in unnamed module of loader &apos;app&apos;; clj_commons.byte_streams.graph.Type is in unnamed module of loader clojure.lang.DynamicClassLoader @157345d0)"><y>#</y><d>2023-01-20</d><h>15:28</h><r>dergutemoritz</r><pre>Execution error (ClassCastException) at clj_commons.byte_streams.graph.ConversionGraph/assoc_conversion (graph.clj:117).
class clj_commons.byte_streams.graph.Type cannot be cast to class clj_commons.byte_streams.graph.Type (clj_commons.byte_streams.graph.Type is in unnamed module of loader &apos;app&apos;; clj_commons.byte_streams.graph.Type is in unnamed module of loader clojure.lang.DynamicClassLoader @157345d0)</pre></z><z id="t1674228608" t="dergutemoritz Happens when compiling a code base which has a def-conversion . Commenting it out gets rid of the error."><y>#</y><d>2023-01-20</d><h>15:30</h><r>dergutemoritz</r>Happens when compiling a code base which has a  <code>def-conversion</code> . Commenting it out gets rid of the error.</z><z id="t1674228616" t="dergutemoritz It does use the new clj-commons.byte-streams namespace tho :thinking_face:"><y>#</y><d>2023-01-20</d><h>15:30</h><r>dergutemoritz</r>It does use the new <code>clj-commons.byte-streams</code> namespace tho <b>:thinking_face:</b></z><z id="t1674228661" t="dergutemoritz will try to come up with a minimal repro and file an issue"><y>#</y><d>2023-01-20</d><h>15:31</h><r>dergutemoritz</r>will try to come up with a minimal repro and file an issue</z><z id="t1674230126" t="dergutemoritz OK so far unable to come up with an isolated repro üòï"><y>#</y><d>2023-01-20</d><h>15:55</h><r>dergutemoritz</r>OK so far unable to come up with an isolated repro <b>üòï</b></z><z id="t1674230184" t="p-himik Are you 100% sure that the new version of the library is on the classpath?"><y>#</y><d>2023-01-20</d><h>15:56</h><r>p-himik</r>Are you 100% sure that the new version of the library is on the classpath?</z><z id="t1674230233" t="dergutemoritz yeah pretty much"><y>#</y><d>2023-01-20</d><h>15:57</h><r>dergutemoritz</r>yeah pretty much</z><z id="t1674230263" t="dergutemoritz no other versions in -Stree or -Spath"><y>#</y><d>2023-01-20</d><h>15:57</h><r>dergutemoritz</r>no other versions in <code>-Stree</code> or <code>-Spath</code></z><z id="t1674230425" t="p-himik Just to be absolutely sure - you use those flags with the right aliases you actually use when running the app, right? When I was facing this issue, I had to use a step debugger and manually and menially go backwards from the problematic call site. But it worked."><y>#</y><d>2023-01-20</d><h>16:00</h><r>p-himik</r>Just to be absolutely sure - you use those flags with the right aliases you actually use when running the app, right?

When I was facing this issue, I had to use a step debugger and manually and menially go backwards from the problematic call site. But it worked.</z><z id="t1674355997" t="Matthew Davidson (kingmob) Hmmm. Keep us posted"><y>#</y><d>2023-01-22</d><h>02:53</h><r>Matthew Davidson (kingmob)</r>Hmmm. Keep us posted</z><z id="t1674485583" t="dergutemoritz Intermediate update: Looks like I&apos;m running into https://github.com/clj-commons/byte-streams/issues/34 here, i.e. I&apos;m also aot-compiling sources here but using tools.build rather than Leiningen. https://github.com/clj-commons/byte-streams/issues/26 was a similar issue. I think I might be able to come up with an isolated repro now ..."><y>#</y><d>2023-01-23</d><h>14:53</h><r>dergutemoritz</r>Intermediate update: Looks like I&apos;m running into <a href="https://github.com/clj-commons/byte-streams/issues/34" target="_blank">https://github.com/clj-commons/byte-streams/issues/34</a> here, i.e. I&apos;m also aot-compiling sources here but using <code>tools.build</code> rather than Leiningen. <a href="https://github.com/clj-commons/byte-streams/issues/26" target="_blank">https://github.com/clj-commons/byte-streams/issues/26</a> was a similar issue. I think I might be able to come up with an isolated repro now ...</z><z id="t1674485985" t="dergutemoritz and bingo!"><y>#</y><d>2023-01-23</d><h>14:59</h><r>dergutemoritz</r>and bingo!</z><z id="t1674485997" t="dergutemoritz ok whittling down ..."><y>#</y><d>2023-01-23</d><h>14:59</h><r>dergutemoritz</r>ok whittling down ...</z><z id="t1674486305" t="Matthew Davidson (kingmob) AOT is always error-prone. At least every other year, I run into a problem caused by an AOT uberjar that has competing classes in it that it shouldn‚Äôt. It can be hard to debug since it depends heavily on the classpath order, making it intermittent. "><y>#</y><d>2023-01-23</d><h>15:05</h><r>Matthew Davidson (kingmob)</r>AOT is always error-prone. At least every other year, I run into a problem caused by an AOT uberjar that has competing classes in it that it shouldn‚Äôt. It can be hard to debug since it depends heavily on the classpath order, making it intermittent. </z><z id="t1674486392" t="dergutemoritz Indeed üòï I think it&apos;s an instance of https://clojure.atlassian.net/browse/CLJ-1741"><y>#</y><d>2023-01-23</d><h>15:06</h><r>dergutemoritz</r>Indeed <b>üòï</b> I think it&apos;s an instance of <a href="https://clojure.atlassian.net/browse/CLJ-1741" target="_blank">https://clojure.atlassian.net/browse/CLJ-1741</a></z><z id="t1674486544" t="dergutemoritz OK found a way to work around it in my original case"><y>#</y><d>2023-01-23</d><h>15:09</h><r>dergutemoritz</r>OK found a way to work around it in my original case</z><z id="t1674488207" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] in https://github.com/clj-commons/byte-streams/issues/34#issuecomment-1138535058 you suggested to re-open that issue if it re-surfaces. Do you want me to put my repro in a comment there or rather make separate issue for it?"><y>#</y><d>2023-01-23</d><h>15:36</h><r>dergutemoritz</r><a>@kingmob</a> in <a href="https://github.com/clj-commons/byte-streams/issues/34#issuecomment-1138535058" target="_blank">https://github.com/clj-commons/byte-streams/issues/34#issuecomment-1138535058</a> you suggested to re-open that issue if it re-surfaces. Do you want me to put my repro in a comment there or rather make separate issue for it?</z><z id="t1674488552" t="dergutemoritz Here&apos;s the minimal repro: https://github.com/bevuta/byte-streams-def-conversion-aot-issue"><y>#</y><d>2023-01-23</d><h>15:42</h><r>dergutemoritz</r>Here&apos;s the minimal repro: <a href="https://github.com/bevuta/byte-streams-def-conversion-aot-issue" target="_blank">https://github.com/bevuta/byte-streams-def-conversion-aot-issue</a></z><z id="t1674551912" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] Does the use of deftype+ help any? We can reopen the issue and add to it, or start a new issue. Either is fine with me. More importantly, is this something we can fix or workaround? Or is it, at best, a bug in the clojure compiler we should make people aware of?"><y>#</y><d>2023-01-24</d><h>09:18</h><r>Matthew Davidson (kingmob)</r><a>@U06GVE6NR</a> Does the use of <code>deftype+</code> help any?

We can reopen the issue and add to it, or start a new issue. Either is fine with me.

More importantly, is this something we can fix or workaround? Or is it, at best, a bug in the clojure compiler we should make people aware of?</z><z id="t1674566511" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] deftype+ doesn&apos;t make a difference in this situation alas üòï Thanks for the idea, tho!"><y>#</y><d>2023-01-24</d><h>13:21</h><r>dergutemoritz</r><a>@kingmob</a> <code>deftype+</code> doesn&apos;t make a difference in this situation alas <b>üòï</b> Thanks for the idea, tho!</z><z id="t1674566565" t="dergutemoritz In the light of my latest understanding, I think I would just point to the jira issue in the README, mentioning the error message for discoverability via web search"><y>#</y><d>2023-01-24</d><h>13:22</h><r>dergutemoritz</r>In the light of my latest understanding, I think I would just point to the jira issue in the README, mentioning the error message for discoverability via web search</z><z id="t1674566592" t="dergutemoritz Will file an issue anyway!"><y>#</y><d>2023-01-24</d><h>13:23</h><r>dergutemoritz</r>Will file an issue anyway!</z><z id="t1674567986" t="dergutemoritz Ah interesting, it doesn&apos;t even have to do with a custom type being involved"><y>#</y><d>2023-01-24</d><h>13:46</h><r>dergutemoritz</r>Ah interesting, it doesn&apos;t even have to do with a custom type being involved</z><z id="t1674568442" t="dergutemoritz The type causing trouble is apparently https://github.com/clj-commons/byte-streams/blob/master/src/clj_commons/byte_streams/graph.clj#L25 which also uses deftype+ already"><y>#</y><d>2023-01-24</d><h>13:54</h><r>dergutemoritz</r>The type causing trouble is apparently <a href="https://github.com/clj-commons/byte-streams/blob/master/src/clj_commons/byte_streams/graph.clj#L25" target="_blank">https://github.com/clj-commons/byte-streams/blob/master/src/clj_commons/byte_streams/graph.clj#L25</a> which also uses <code>deftype+</code> already</z><z id="t1674569262" t="dergutemoritz OK: https://github.com/clj-commons/byte-streams/issues/68 -- was actually able to come up with a fix / workaround!"><y>#</y><d>2023-01-24</d><h>14:07</h><r>dergutemoritz</r>OK: <a href="https://github.com/clj-commons/byte-streams/issues/68" target="_blank">https://github.com/clj-commons/byte-streams/issues/68</a> -- was actually able to  come up with a fix / workaround!</z><z id="t1674569270" t="dergutemoritz see https://github.com/clj-commons/byte-streams/pull/69"><y>#</y><d>2023-01-24</d><h>14:07</h><r>dergutemoritz</r>see <a href="https://github.com/clj-commons/byte-streams/pull/69" target="_blank">https://github.com/clj-commons/byte-streams/pull/69</a></z><z id="t1674227042" t="dergutemoritz Thanks for the fix, just went through the same pain üò¨ [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Happy to help shepherding through a 0.6.1 release!"><y>#</y><d>2023-01-20</d><h>15:04</h><w>dergutemoritz</w>Thanks for the fix, just went through the same pain <b>üò¨</b>  <a>@kingmob</a> Happy to help shepherding through a 0.6.1 release!</z><z id="t1672395592" t="lambdam Hello everyone, I&apos;m using Aleph + Manifold + Byte-streams to create an application that pushes ~ 6MB per second to a frontend through a websocket. With a recent laptop, I can&apos;t manage to have more than ~ 1MB per second stabilized, which seems strange. The data is stored as a vector of byte arrays that I put in the sending stream with the bs/to-byte-buffers function. That is the best performance that I managed to get. With htop, I see one core working at ~ 100% and the others doing almost nothing. Am I missing something? Is there a dedicated data structure conversion that enables Aleph to have a better throughput with a websocket? Or is the websocket the problem? Thanks a lot."><y>#</y><d>2022-12-30</d><h>10:19</h><w>lambdam</w>Hello everyone,
I&apos;m using Aleph + Manifold + Byte-streams to create an application that pushes ~ 6MB per second to a frontend through a websocket. With a recent laptop, I can&apos;t manage to have more than ~ 1MB per second stabilized, which seems strange.
The data is stored as a vector of byte arrays that I put in the sending stream with the <code>bs/to-byte-buffers</code> function. That is the best performance that I managed to get.
With htop, I see one core working at ~ 100% and the others doing almost nothing.
Am I missing something? Is there a dedicated data structure conversion that enables Aleph to have a better throughput with a websocket? Or is the websocket the problem?
Thanks a lot.</z><z id="t1672396284" t="p-himik What process exactly consumes that core? What exactly does it do during that time?"><y>#</y><d>2022-12-30</d><h>10:31</h><r>p-himik</r>What process exactly consumes that core?
What exactly does it do during that time?</z><z id="t1672404009" t="Matthew Davidson (kingmob) Hi [:attrs {:href &quot;/_/_/users/U94V75LDV&quot;}] , two things: 1) a lot of us are busy for the holidays, so it may take some time to get back to you, and 2) we could really use some more details, a minimal reproducible example would help a lot"><y>#</y><d>2022-12-30</d><h>12:40</h><r>Matthew Davidson (kingmob)</r>Hi <a>@U94V75LDV</a> , two things: 1) a lot of us are busy for the holidays, so it may take some time to get back to you, and 2) we could really use some more details, a minimal reproducible example would help a lot</z><z id="t1672441125" t="lambdam Thanks for the replies. Yes no hurry, the communication is asynchronous on Slack (as in Aleph :face_with_hand_over_mouth: ). I was hopping that my problem was trivial and that I would have missed something in the documentation but it doesn&apos;t seem so. I&apos;ll take time to describe it more thoroughly tomorrow. Happy new year!"><y>#</y><d>2022-12-30</d><h>22:58</h><r>lambdam</r>Thanks for the replies.
Yes no hurry, the communication is asynchronous on Slack (as in Aleph <b>:face_with_hand_over_mouth:</b>).
I was hopping that my problem was trivial and that I would have missed something in the documentation but it doesn&apos;t seem so.
I&apos;ll take time to describe it more thoroughly tomorrow.
Happy new year!</z><z id="t1672599929" t="lambdam Hello again, Here is a schema of the system."><y>#</y><d>2023-01-01</d><h>19:05</h><r>lambdam</r>Hello again,
Here is a schema of the system.</z><z id="t1672599951" t="lambdam"><y>#</y><d>2023-01-01</d><h>19:05</h><r>lambdam</r></z><z id="t1672600313" t="lambdam 1. There are 1000 TCP streams that push regularly messages of 240 bytes. 2. Those messages are stacked in a Clojure vector 3. Every n milliseconds the stacked byte arrays are flushed to a web frontend through a websocket connection."><y>#</y><d>2023-01-01</d><h>19:11</h><r>lambdam</r>1. There are 1000 TCP streams that push regularly messages of 240 bytes.
2. Those messages are stacked in a Clojure vector
3. Every n milliseconds the stacked byte arrays are flushed to a web frontend through a websocket connection.</z><z id="t1672602409" t="lambdam &gt; What process exactly consumes that core? &gt; What exactly does it do during that time? I can see with htop that the Java/Clojure process is at 100% of a CPU. Then I tried to use VisualVM but I didn&apos;t manage to figure which thread(s) were consuming CPU and what was happening exactly. I tried to use a flame graph with the flames package but did not manage to read it to understand what was happening."><y>#</y><d>2023-01-01</d><h>19:46</h><r>lambdam</r>&gt; What process exactly consumes that core?
&gt; What exactly does it do during that time?
I can see with htop that the Java/Clojure process is at 100% of a CPU. Then I tried to use VisualVM but I didn&apos;t manage to figure which thread(s) were consuming CPU and what was happening exactly. I tried to use a flame graph with the <code>flames</code> package but did not manage to read it to understand what was happening.</z><z id="t1672602590" t="lambdam I miss some skills to do profiling on a Java/Clojure application. Would someone have availability for a paid code review to help me on this situation?"><y>#</y><d>2023-01-01</d><h>19:49</h><r>lambdam</r>I miss some skills to do profiling on a Java/Clojure application.
Would someone have availability for a paid code review to help me on this situation?</z><z id="t1672637693" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U94V75LDV&quot;}] Hmm, it&apos;s interesting that you&apos;re seeing so much work on a single core. That suggests it&apos;s the aggregator or later, when things have become serial. A few questions: 1. What versions of things are you on? 2. Where precisely are you using byte-streams? Are those the 1000 TCP streams, or are you using it later to aggregate, or both? 3. If not, how are you aggregating? Are you using transients, or a ByteBuf, or something designed to efficiently accumulate bytes? 4. Is there any/a lot of serializing work being done? The amount of data doesn&apos;t seem that large I have little experience with VisualVM, but I&apos;ve used YourKit+IntelliJ pretty successfully for debugging Clojure in the past. I&apos;m on vacation in Japan, but I might be available for a paid review later this week. DM me and maybe we can work something out."><y>#</y><d>2023-01-02</d><h>05:34</h><r>Matthew Davidson (kingmob)</r><a>@U94V75LDV</a> Hmm, it&apos;s interesting that you&apos;re seeing so much work on a single core. That suggests it&apos;s the aggregator or later, when things have become serial.

A few questions:
1. What versions of things are you on? 
2. Where precisely are you using byte-streams? Are those the 1000 TCP streams, or are you using it later to aggregate, or both?
3. If not, how are you aggregating? Are you using transients, or a ByteBuf, or something designed to efficiently accumulate bytes?
4. Is there any/a lot of serializing work being done?
The amount of data doesn&apos;t seem that large

I have little experience with VisualVM, but I&apos;ve used YourKit+IntelliJ pretty successfully for debugging Clojure in the past.

I&apos;m on vacation in Japan, but I might be available for a paid review later this week. DM me and maybe we can work something out.</z><z id="t1672655550" t="lambdam [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] thanks, &gt; 1. What versions of things are you on? aleph/aleph {:mvn/version &quot;0.6.0&quot;} manifold/manifold {:mvn/version &quot;0.3.0&quot;} org.clj-commons/byte-streams {:mvn/version &quot;0.3.1&quot;} &gt; 2. Where precisely are you using byte-streams? Are those the 1000 TCP streams, or are you using it later to aggregate, or both? &gt; 3. If not, how are you aggregating? Are you using transients, or a ByteBuf, or something designed to efficiently accumulate bytes? The TCP streams (using aleph.tcp) seem to return byte arrays (`(class value)` returns [B ). I then accumulate them in a Clojure vector. Every 40ms I flush the accumulated byte-streams into the a stream that is connected to the socket returned by (http/websocket-connection req) . Whether I flush the byte-arrays directly or I transform them with bs/to-byte-buffers , I reach a maximum throughput that seems fairly low and see a core reaching 100% usage. I tried accumulating in a transient vector but nothing changed. &gt; 4. Is there any/a lot of serializing work being done? No the bytes are sent &quot;as is&quot;. Enjoy your trip in Japan. I&apos;ll DM you for a code review appointment."><y>#</y><d>2023-01-02</d><h>10:32</h><r>lambdam</r><a>@U10EC98F5</a> thanks,
&gt; 1. What versions of things are you on?
<pre>aleph/aleph {:mvn/version &quot;0.6.0&quot;}
manifold/manifold {:mvn/version &quot;0.3.0&quot;}
org.clj-commons/byte-streams {:mvn/version &quot;0.3.1&quot;}</pre>
&gt; 2. Where precisely are you using byte-streams? Are those the 1000 TCP streams, or are you using it later to aggregate, or both?
&gt; 3. If not, how are you aggregating? Are you using transients, or a ByteBuf, or something designed to efficiently accumulate bytes?
The TCP streams (using aleph.tcp) seem to return byte arrays (`(class value)` returns <code>[B</code>). I then accumulate them in a Clojure vector. Every 40ms I flush the accumulated byte-streams into the a stream that is connected to the socket returned by <code>(http/websocket-connection req)</code>. Whether I flush the byte-arrays directly or I transform them with <code>bs/to-byte-buffers</code> , I reach a maximum throughput that seems fairly low and see a core reaching 100% usage. I tried accumulating in a transient vector but nothing changed.
&gt; 4. Is there any/a lot of serializing work being done?
No the bytes are sent &quot;as is&quot;.

Enjoy your trip in Japan. I&apos;ll DM you for a code review appointment.</z><z id="t1672698659" t="Arnaud Geiser Hello [:attrs {:href &quot;/_/_/users/U94V75LDV&quot;}] . I was also interested by the exercise so I spent a bit of time on something real naive here (just evaluate line 64): https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj Does the design kind of match what you are trying to do? From my experience, here are some hints: 1. Ensure you are using raw-stream? from both your TCP and HTTP servers [1] 2. Do not aggregate your ByteBuf on a vector but on a CompositeByteBuf instead [2] 3. Try to send big chunks (64 KiB - websocket limit) instead of small ones (240 bytes) [3] A question: Why not streaming instead of aggregating with your websocket connection? Happy to help if I can but I&apos;m pretty sure that [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] will give you more robust insights as streaming is definitely his expertise. [1] : https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L54-L55 [2] : https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L17 [3] : https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L44"><y>#</y><d>2023-01-02</d><h>22:30</h><r>Arnaud Geiser</r>Hello <a>@U94V75LDV</a>.
I was also interested by the exercise so I spent a bit of time on something real naive here (just evaluate line 64): <a href="https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj" target="_blank">https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj</a>

Does the design kind of match what you are trying to do?

From my experience, here are some hints:
1. Ensure you are using <code>raw-stream?</code> from both your TCP and HTTP servers [1]
2. Do not aggregate your <code>ByteBuf</code> on a vector but on a <code>CompositeByteBuf</code> instead [2]
3. Try to send big chunks (64 KiB - websocket limit) instead of small ones (240 bytes) [3]
A question:
Why not streaming instead of aggregating with your websocket connection?

Happy to help if I can but I&apos;m pretty sure that <a>@U10EC98F5</a> will give you more robust insights as streaming is definitely his expertise.

[1] : <a href="https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L54-L55" target="_blank">https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L54-L55</a>
[2] : <a href="https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L17" target="_blank">https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L17</a>
[3] : <a href="https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L44" target="_blank">https://github.com/arnaudgeiser/aleph-tests/blob/master/src/aleph_tests/core.clj#L44</a></z><z id="t1672698995" t="Arnaud Geiser Another question: what are you doing in your websocket-handler? Having a single CPU core in use might match what you are doing inside this handler."><y>#</y><d>2023-01-02</d><h>22:36</h><r>Arnaud Geiser</r>Another question: what are you doing in your websocket-handler? Having a single CPU core in use might match what you are doing inside this handler.</z><z id="t1672750671" t="Arnaud Geiser Here is an alternative that uses a stateful transducer to construct chunk of 64 KiB. https://github.com/arnaudgeiser/aleph-tests/blob/streaming/src/aleph_tests/core.clj"><y>#</y><d>2023-01-03</d><h>12:57</h><r>Arnaud Geiser</r>Here is an alternative that uses a stateful transducer to construct chunk of 64 KiB.

<a href="https://github.com/arnaudgeiser/aleph-tests/blob/streaming/src/aleph_tests/core.clj" target="_blank">https://github.com/arnaudgeiser/aleph-tests/blob/streaming/src/aleph_tests/core.clj</a></z><z id="t1672752116" t="lambdam Thanks a lot [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] . I&apos;ll check all that with great interest and will bring back feedbacks."><y>#</y><d>2023-01-03</d><h>13:21</h><r>lambdam</r>Thanks a lot <a>@UFKCFTVB8</a>. I&apos;ll check all that with great interest and will bring back feedbacks.</z><z id="t1672752190" t="Arnaud Geiser I will post the associated flamegraph later on. There is actually something really interesting on it (related to Aleph internals, not related to the problem you are trying to solve)."><y>#</y><d>2023-01-03</d><h>13:23</h><r>Arnaud Geiser</r>I will post the associated flamegraph later on. There is actually something really interesting on it (related to Aleph internals, not  related to the problem you are trying to solve).</z><z id="t1672752651" t="Arnaud Geiser Most of the time spent on the user land is on bound-fn*"><y>#</y><d>2023-01-03</d><h>13:30</h><r>Arnaud Geiser</r>Most of the time spent on the user land is on <code>bound-fn*</code></z><z id="t1672754177" t="Arnaud Geiser Removing this bound-fn* from operation-complete really helps with the CPU usage. It has been introduced by the following PR. [1] It was actually NOT necessary to solve the related issues but we thought it was cheap enough. [1] : https://github.com/clj-commons/aleph/pull/604"><y>#</y><d>2023-01-03</d><h>13:56</h><r>Arnaud Geiser</r>Removing this <code>bound-fn*</code> from operation-complete really helps with the CPU usage.

It has been introduced by the following PR. [1]
It was actually NOT necessary to solve the related issues but we thought it was cheap enough.

[1] : <a href="https://github.com/clj-commons/aleph/pull/604" target="_blank">https://github.com/clj-commons/aleph/pull/604</a></z><z id="t1672754413" t="Arnaud Geiser Here is the gist from the discussion we had with [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] : Oh yeah, because the code runs on netty and signal threads that aren‚Äôt started by the Clojure test, so there‚Äôs no automatic thread frame propagation, defeating the use of binding under the hood. Well, the usual solution to interop with Java threads is bound-fn , and that works here. Truthfully, we could probably use bound-fn more when handing things off to Netty to run, it‚Äôs always safer. Anyway, this works: (deftest test-classloader (testing &quot;classloader: ensure the class loader is always a DynamicClassLoader&quot; (let [result (CompletableFuture.)] (with-dynamic-redefs [netty/operation-complete (partial operation-complete result)] (let [server (http/start-server (constantly {:body &quot;ok&quot;}) {:port 9999})] (on-signal :int (bound-fn [_] (.close ^java.io.Closeable server))) (.exec (Runtime/getRuntime) (format &quot;kill -SIGINT %s&quot; (pid))) (is (= (deref result 30000 ::timeout) true))))))) (defn wrap-future [^Future f] (when f (if (.isSuccess f) (d/success-deferred (.getNow f) nil) (let [d (d/deferred nil) bound-operation-complete (bound-fn* operation-complete)] (.addListener f (reify GenericFutureListener (operationComplete [_ _] (ensure-dynamic-classloader) (bound-operation-complete f d)))) d)))) (modifi√©) [9 h 28] The use of bound-fn in the test ensures it inherits the dynamic redef frame, and bound-fn* in wrap-future ensures the listener will work even if .close-&gt;wrap-future is called from a signal thread [9 h 29] We shold probably check everywhere we accept user callbacks for netty and wrap them in bound-fn for safety"><y>#</y><d>2023-01-03</d><h>14:00</h><r>Arnaud Geiser</r>Here is the gist from the discussion we had with <a>@U10EC98F5</a>:

Oh yeah, because the code runs on netty and signal threads that aren‚Äôt started by the Clojure test, so there‚Äôs no automatic thread frame propagation, defeating the use of <code>binding</code> under the hood. Well, the usual solution to interop with Java threads is <code>bound-fn</code> , and that works here. Truthfully, we could probably use bound-fn more when handing things off to Netty to run, it‚Äôs always safer.

Anyway, this works:

<pre>(deftest test-classloader
  (testing &quot;classloader: ensure the class loader is always a DynamicClassLoader&quot;
    (let [result (CompletableFuture.)]
      (with-dynamic-redefs [netty/operation-complete (partial operation-complete result)]
        (let [server (http/start-server
                      (constantly {:body &quot;ok&quot;})
                      {:port 9999})]
          (on-signal :int
                     (bound-fn [_]
                       (.close ^java.io.Closeable server)))
          (.exec (Runtime/getRuntime) (format &quot;kill -SIGINT %s&quot; (pid)))
          (is (= (deref result 30000 ::timeout) true)))))))</pre>
<pre>(defn wrap-future
  [^Future f]
  (when f
    (if (.isSuccess f)
      (d/success-deferred (.getNow f) nil)
      (let [d (d/deferred nil)
            bound-operation-complete (bound-fn* operation-complete)]
        (.addListener f
          (reify GenericFutureListener
            (operationComplete [_ _]
              (ensure-dynamic-classloader)
              (bound-operation-complete f d))))
        d))))</pre>
 (modifi√©)
[9 h 28] The use of bound-fn in the test ensures it inherits the dynamic redef frame, and bound-fn* in wrap-future ensures the listener will work even if .close-&gt;wrap-future is called from a signal thread
[9 h 29] We shold probably check everywhere we accept user callbacks for netty and wrap them in bound-fn for safety</z><z id="t1672754445" t="Arnaud Geiser I would consider removing that bound-fn* on operation-complete as it was clearly introduced for safety. What do you think Matthew?"><y>#</y><d>2023-01-03</d><h>14:00</h><r>Arnaud Geiser</r>I would consider removing that <code>bound-fn*</code> on operation-complete as it was clearly introduced for safety.
What do you think Matthew?</z><z id="t1672754562" t="Arnaud Geiser (I will create an issue later today on Aleph)"><y>#</y><d>2023-01-03</d><h>14:02</h><r>Arnaud Geiser</r>(I will create an issue later today on Aleph)</z><z id="t1672842380" t="Arnaud Geiser Here is the PR open for discussion : https://github.com/clj-commons/aleph/pull/652"><y>#</y><d>2023-01-04</d><h>14:26</h><r>Arnaud Geiser</r>Here is the PR open for discussion : <a href="https://github.com/clj-commons/aleph/pull/652" target="_blank">https://github.com/clj-commons/aleph/pull/652</a></z><z id="t1673084386" t="lambdam [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] and [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] thanks a lot. We managed to have something working correctly with your advice. I discovered the Netty documentation and... it&apos;s kind of hard to get used to. It is the first time I go this deep into a Java lib and it&apos;s not the same as using ClojureDocs and reading Clojure source code. [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] when I aggregate the ByteBuf returned by by the :raw-stream? TCP connection (which returns a PooledUnsafeDirectByteBuf ) I randomly get an IllegalReferenceCountException with info about a .release method not called before GC and a risk of memory leaks. This error seems to come when the ByteBufs are kept too long in the compositeBuffer . The code of the application should be open-sourced once finished. I&apos;ll post the link here when it&apos;s done. Thanks a lot for your time and advice."><y>#</y><d>2023-01-07</d><h>09:39</h><r>lambdam</r><a>@UFKCFTVB8</a> and <a>@U10EC98F5</a> thanks a lot. We managed to have something working correctly with your advice.
I discovered the Netty documentation and... it&apos;s kind of hard to get used to. It is the first time I go this deep into a Java lib and it&apos;s not the same as using ClojureDocs and reading Clojure source code.
<a>@UFKCFTVB8</a> when I aggregate the ByteBuf returned by by the :raw-stream? TCP connection (which returns a <code>PooledUnsafeDirectByteBuf</code>) I randomly get an <code>IllegalReferenceCountException</code>  with info about a .release method not called before GC and a risk of memory leaks. This error seems to come when the ByteBufs are kept too long in the <code>compositeBuffer</code>.
The code of the application should be open-sourced once finished. I&apos;ll post the link here when it&apos;s done.
Thanks a lot for your time and advice.</z><z id="t1673087378" t="Arnaud Geiser During development, I would use this JVM property to ensure all your ByteBuf are correctly released. -Dio.netty.leakDetection.level=paranoid This warning means there are ByteBuf objects with a refcounting of 1 while those can be garbage collected. So either you have a dangling CompositeByteBuf or some ByteBuf that were never tied to any CompositeByteBuf . Depending on how your solution is implemented, you probably have to call netty/release on your CompositeByteBuf . Without source code it&apos;s really hard to give you more information. üôÇ"><y>#</y><d>2023-01-07</d><h>10:29</h><r>Arnaud Geiser</r>During development, I would use this JVM property to ensure all your <code>ByteBuf</code> are correctly released.

<pre>-Dio.netty.leakDetection.level=paranoid</pre>
This warning means there are <code>ByteBuf</code> objects with a refcounting of 1 while those can be garbage collected.  So either you have a dangling <code>CompositeByteBuf</code> or some <code>ByteBuf</code> that were never tied to any <code>CompositeByteBuf</code>.

Depending on how your solution is implemented, you probably have to call <code>netty/release</code> on your <code>CompositeByteBuf</code> .

Without source code it&apos;s really hard to give you more information. <b>üôÇ</b></z><z id="t1673087618" t="Arnaud Geiser Here is the documentation regarding leak detection : https://netty.io/wiki/reference-counted-objects.html#leak-detection-levels"><y>#</y><d>2023-01-07</d><h>10:33</h><r>Arnaud Geiser</r>Here is the documentation regarding leak detection : <a href="https://netty.io/wiki/reference-counted-objects.html#leak-detection-levels" target="_blank">https://netty.io/wiki/reference-counted-objects.html#leak-detection-levels</a></z><z id="t1672997836" t="Francesco Pischedda Hi everyone üëã I am using aleph to handle SSE on the server side and I am not sure that the approach I have used is ideal, so I am looking for help. The code is structured like this: ‚Ä¢ For each &quot;room&quot; I create a source stream and put it in atom hashmap (key room id, value the stream) ‚Ä¢ For each user connecting to a room I get the source stream, create a sink stream and connect it to the source ‚ó¶ and return the sink stream in the response of the SSE endpoint so that I can send events to users ‚Ä¢ When I need to broadcast messages I send them to the source stream which then forwards to the users ‚Ä¢ Once user disconnects, their sink stream is marked as drained, so periodically I look at all the source stream and, using s/downstream to get all connected stream, if all downstreams are drained I close the source stream and remove it from the atom Questions: ‚Ä¢ are there better ways to broadcast messages to users in a room? ‚Ä¢ is there a better way to handle user disconnecting and cleanup an empty room? Is the current approach leaking resources? ‚Ä¢ I was thinking about using an event-bus with a topic for each room and user subscriptions to that topic? How does it scale? Does it automatically cleanup disconnected users? Sorry for the long post, and thanks in advance for your help! üôè"><y>#</y><d>2023-01-06</d><h>09:37</h><w>Francesco Pischedda</w>Hi everyone <b>üëã</b>
I am using aleph to handle SSE on the server side and I am not sure that the approach I have used is ideal, so I am looking for help.

The code is structured like this:
‚Ä¢ For each &quot;room&quot; I create a source stream and put it in atom hashmap (key room id, value the stream)
‚Ä¢ For each user connecting to a room I get the source stream, create a sink stream and connect it to the source
    ‚ó¶ and return the sink stream in the response of the SSE endpoint so that I can send events to users
‚Ä¢ When I need to broadcast messages I send them to the source stream which then forwards to the users
‚Ä¢ Once user disconnects, their sink stream is marked as drained, so periodically I look at all the source stream and, using s/downstream to get all connected stream, if all downstreams are drained I close the source stream and remove it from the atom
Questions:
‚Ä¢ are there better ways to broadcast messages to users in a room?
‚Ä¢ is there a better way to handle user disconnecting and cleanup an empty room? Is the current approach leaking resources?
‚Ä¢ I was thinking about using an event-bus with a topic for each room and user subscriptions to that topic? How does it scale? Does it automatically cleanup disconnected users?
Sorry for the long post, and thanks in advance for your help! <b>üôè</b></z><z id="t1672997919" t="Arnaud Geiser Hello Francesco! Do you have some code to share based on the approach you describe? Otherwise, I will give you an answer based on your message. üôÇ"><y>#</y><d>2023-01-06</d><h>09:38</h><r>Arnaud Geiser</r>Hello Francesco!

Do you have some code to share based on the approach you describe? Otherwise, I will give you an answer based on your message. <b>üôÇ</b></z><z id="t1672998332" t="Francesco Pischedda Hi Arnaud! Thanks for jumping into my question so quickly! üôÇ Here is the code of the whole application https://github.com/fpischedda/unrefined The state atom is handled https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/unrefined/state.clj#L9 . User connection is handled https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/refinements/handlers.clj#L13 on the ring side and https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/refinements/events.clj#L13 I do the connection between source and user sink. And finally https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/unrefined/mr_clean.clj is the cleanup part. Let me know if I have to clarify something! üôè"><y>#</y><d>2023-01-06</d><h>09:45</h><r>Francesco Pischedda</r>Hi Arnaud!
Thanks for jumping into my question so quickly! <b>üôÇ</b>
Here is the code of the whole application <a href="https://github.com/fpischedda/unrefined" target="_blank">https://github.com/fpischedda/unrefined</a>

The state atom is handled <a href="https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/unrefined/state.clj#L9" target="_blank">https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/unrefined/state.clj#L9</a>.
User connection is handled <a href="https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/refinements/handlers.clj#L13" target="_blank">https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/refinements/handlers.clj#L13</a> on the ring side and <a href="https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/refinements/events.clj#L13" target="_blank">https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/refinements/events.clj#L13</a> I do the connection between source and user sink.
And finally <a href="https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/unrefined/mr_clean.clj" target="_blank">https://github.com/fpischedda/unrefined/blob/main/src/clj/fpsd/unrefined/mr_clean.clj</a> is the cleanup part.

Let me know if I have to clarify something! <b>üôè</b></z><z id="t1672999627" t="Arnaud Geiser The global approach you are describing makes sense to me. &gt; ‚Ä¢ Once user disconnects, their sink stream is marked as drained, so periodically I look at all the source stream and, using s/downstream to get all connected stream, if all downstreams are drained I close the source stream and remove it from the atom Your approach works, but you could also subscribe to on-drained [1] instead of periodically checking the state of your stream. I would anyway keep your mechanism in place though, but with a higher interval (every hour, two hours?). &gt; are there better ways to broadcast messages to users in a room? For what it worth, I would have done it exactly this way. &gt; is there a better way to handle user disconnecting and cleanup an empty room? Is the current approach leaking resources? You should be safe with your approach. Talking about Netty internals, as soon as a channel becomes inactive, the stream is closed. So you should be fine : https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L362 However, maybe you would like to protect your system somehow and do not keep channel actives forever? &gt; ‚Ä¢ I was thinking about using an event-bus with a topic for each room and user subscriptions to that topic? How does it scale? Does it automatically cleanup disconnected users? Here I cannot say, I never used the event-bus part of manifold. We have no issue open regarding it, but I don&apos;t think it&apos;s either battle-tested or heavily in use. This is not a lot of code, so if you want to take a look : https://github.com/clj-commons/manifold/blob/master/src/manifold/bus.clj [1] : https://aleph.io/codox/manifold/manifold.stream.html#var-on-drained"><y>#</y><d>2023-01-06</d><h>10:07</h><r>Arnaud Geiser</r>The global approach you are describing makes sense to me.

&gt; ‚Ä¢ Once user disconnects, their sink stream is marked as drained, so periodically I look at all the source stream and, using s/downstream to get all connected stream, if all downstreams are drained I close the source stream and remove it from the atom
Your approach works, but you could also subscribe to <code>on-drained</code> [1] instead of periodically checking the state of your stream.

I would anyway keep your mechanism in place though, but with a higher interval (every hour, two hours?).

&gt;  are there better ways to broadcast messages to users in a room?
For what it worth, I would have done it exactly this way.

&gt;  is there a better way to handle user disconnecting and cleanup an empty room? Is the current approach leaking resources?
You should be safe with your approach.
Talking about Netty internals, as soon as a channel becomes inactive, the stream is closed.
So you should be fine : <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L362" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/server.clj#L362</a>
However, maybe you would like to protect your system somehow and do not keep channel actives forever?

&gt; ‚Ä¢ I was thinking about using an event-bus with a topic for each room and user subscriptions to that topic? How does it scale? Does it automatically cleanup disconnected users?
Here I cannot say, I never used the <code>event-bus</code>
part of manifold. We have no issue open regarding it, but I don&apos;t think it&apos;s either battle-tested or heavily in use.
This is not a lot of code, so if you want to take a look : <a href="https://github.com/clj-commons/manifold/blob/master/src/manifold/bus.clj" target="_blank">https://github.com/clj-commons/manifold/blob/master/src/manifold/bus.clj</a>

[1] : <a href="https://aleph.io/codox/manifold/manifold.stream.html#var-on-drained" target="_blank">https://aleph.io/codox/manifold/manifold.stream.html#var-on-drained</a></z><z id="t1673000421" t="Francesco Pischedda Thank a lot! This is my first time using aleph and I was afraid that my approach was not ideal. BTW the api offered by both aleph and manifold are great! I will look at the internals of event-bus even if I think I will stick to the current approach. Thank again for your help!"><y>#</y><d>2023-01-06</d><h>10:20</h><r>Francesco Pischedda</r>Thank a lot! This is my first time using aleph and I was afraid that my approach was not ideal. BTW the api offered by both aleph and manifold are great!
I will look at the internals of event-bus even if I think I will stick to the current approach.

Thank again for your help!</z><z id="t1673001093" t="Arnaud Geiser Yes, Zach Tellman did an amazing work in terms of API and on the provided abstractions. The documentation is a bit lacking and some internals and design choices unexplained. But both libraries are doing their jobs pretty well."><y>#</y><d>2023-01-06</d><h>10:31</h><r>Arnaud Geiser</r>Yes, Zach Tellman did an amazing work in terms of API and on the provided abstractions. The documentation is a bit lacking and some internals and design choices unexplained.
But both libraries are doing their jobs pretty well.</z><z id="t1673074271" t="Matthew Davidson (kingmob) Hi Francesco. First, some terminology, because the Manifold docs are a little vague on this. Draining applies to sources, and closing applies to sinks. The default stream is both a source and sink. So, when you say the user&apos;s sink stream is drained, do you mean the user has read all the messages they&apos;ll get? I ask, because it may be preferable to close the user&apos;s stream when they&apos;re done with it, instead of checking to see whether the stream is drained, for the reasons below. I ask because it sounds you&apos;re duplicating a bit of Manifold&apos;s default behavior. If you closed a downstream, Manifold&apos;s default behavior is to close the upstream when there are no more open downstreams, unless the upstream was created with permanent? set true (see stream* ). The catch is, Manifold can delay clean up until necessary. E.g., see the code buried in manifold.stream.graph/handle-async-put ; Manifold won&apos;t close the upstream until it runs out of open sinks to put to. So, if you stop putting messages on the upstream after you close the final downstream, the upstream could hang around for a while. Your use case is a pub/sub architecture, and is exactly what event-bus was built for. It automatically handles cleanup for you if you close the user&apos;s subscription stream. I suggest giving it a try."><y>#</y><d>2023-01-07</d><h>06:51</h><r>Matthew Davidson (kingmob)</r>Hi Francesco.

First, some terminology, because the Manifold docs are a little vague on this. Draining applies to sources, and closing applies to sinks. The default stream is both a source and sink. So, when you say the user&apos;s sink stream is drained, do you mean the user has read all the messages they&apos;ll get? I ask, because it may be preferable to close the user&apos;s stream when they&apos;re done with it, instead of checking to see whether the stream is drained, for the reasons below.

I ask because it sounds you&apos;re duplicating a bit of Manifold&apos;s default behavior.   If you closed a downstream, Manifold&apos;s default behavior is to close the upstream when there are no more open downstreams, unless the upstream was created with <code>permanent?</code> set true (see <code>stream*</code>).

The catch is, Manifold can delay clean up until necessary. E.g., see the code buried in <code>manifold.stream.graph/handle-async-put</code>; Manifold won&apos;t close the upstream until it runs out of open sinks to <code>put</code> to. So, if you stop putting messages on the upstream after you close the final downstream, the upstream could hang around for a while.

Your use case is a pub/sub architecture, and is exactly what <code>event-bus</code> was built for. It automatically handles cleanup for you if you close the user&apos;s subscription stream. I suggest giving it a try.</z><z id="t1673084246" t="Francesco Pischedda Hi [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] ! Thanks for the additional feedback. Regarding the terminology, yes, I am a bit confused üòÖ My assumptions are (were?): ‚Ä¢ the room stream is both a sink (it receives events to be broadcasted) and a source (send events to user streams), but the main &quot;role&quot; here is to broadcast so I have called it the source ‚Ä¢ user streams, s/connect ed to room streams are again sinks (receive events from the room) and sources (send SSE data to the browser), and for simplicity I&apos;ve called them sources Probably I have oversimplified and I need to adjust my understanding of the terminology, thanks for the feedback! üôè &gt; So, when you say the user&apos;s sink stream is drained, do you mean the user has read all the messages they&apos;ll get? This is what I have observed: ‚Ä¢ I have created a room and connected a user to it, using s/downstream on the room&apos;s stream I get the user&apos;s stream which, inspected, shows these properties Class: manifold.stream.default.Stream Value: &quot;&lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 0, :permanent? false, :type \&quot;manifold\&quot;, :sink? true, :closed? false, :pending-takes 1... --- Fields: &quot;__closedCallbacks&quot; = ( ) &quot;__drainedCallbacks&quot; = ( ) &quot;__isClosed&quot; = false &quot;__isDrained&quot; = false ‚Ä¢ closing the web page, the user&apos;s stream is still connected to the room stream and looks like this Class: manifold.stream.default.Stream Value: &quot;&lt;&lt; stream: {:pending-puts 0, :drained? true, :buffer-size 0, :permanent? false, :type \&quot;manifold\&quot;, :sink? true, :closed? true, :pending-takes 0, ... --- Fields: &quot;__closedCallbacks&quot; = ( ) &quot;__drainedCallbacks&quot; = ( ) &quot;__isClosed&quot; = true &quot;__isDrained&quot; = true Before I didn&apos;t notice that it was both drained and closed, and based on your comment I should use s/closed? instead of s/drained? to understand if all users have closed their page/connection, is that correct? (the room stream is still not closed or drained at this point so I should look at all downstream streams) I understand that the room&apos;s stream should be closed automatically at some point when there are no active downstream but the point is that events are generated after user action so if there are no users generating events then there will not be new put s which would mark the upstream as closed, so it looks like that the manual cleaning process is still needed. &gt; Your use case is a pub/sub architecture, and is exactly what event-bus was built for I&apos;ve learned about event-bus only recently and I want to give it a try but I have a couple of concerns: ‚Ä¢ how does it scale? should I have a bus for each room or one for the whole system with a topic per room? ‚Ä¢ how does cleaning works with the event-bus ? should I expect it to automatically remove subscriptions on user disconnections? Should I manage event-bus instances like I do for the stream approach? I really need to read its code and get familiar with it before taking a decision üôÇ Thanks again for your help!"><y>#</y><d>2023-01-07</d><h>09:37</h><r>Francesco Pischedda</r>Hi <a>@U10EC98F5</a>!
Thanks for the additional feedback.

Regarding the terminology, yes, I am a bit confused <b>üòÖ</b>
My assumptions are (were?):
‚Ä¢ the room stream is both a sink (it receives events to be broadcasted) and a source (send events to user streams), but the main &quot;role&quot; here is to broadcast so I have called it the <code>source</code>
‚Ä¢ user streams, <code>s/connect</code>ed to room streams are again sinks (receive events from the room) and sources (send SSE data to the browser), and for simplicity I&apos;ve called them sources
Probably I have oversimplified and I need to adjust my understanding of the terminology, thanks for the feedback! <b>üôè</b>

&gt; So, when you say the user&apos;s sink stream is drained, do you mean the user has read all the messages they&apos;ll get?
This is what I have observed:
‚Ä¢ I have created a room and connected a user to it, using <code>s/downstream</code> on the room&apos;s stream I get the user&apos;s stream which, inspected, shows these properties 
<pre>Class: manifold.stream.default.Stream
Value: &quot;&lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 0, :permanent? false, :type \&quot;manifold\&quot;, :sink? true, :closed? false, :pending-takes 1...

--- Fields:
  &quot;__closedCallbacks&quot; = (  )
  &quot;__drainedCallbacks&quot; = (  )
  &quot;__isClosed&quot; = false
  &quot;__isDrained&quot; = false</pre>
‚Ä¢ closing the web page, the user&apos;s stream is still connected to the room stream and looks like this 
<pre>Class: manifold.stream.default.Stream
Value: &quot;&lt;&lt; stream: {:pending-puts 0, :drained? true, :buffer-size 0, :permanent? false, :type \&quot;manifold\&quot;, :sink? true, :closed? true, :pending-takes 0, ...

--- Fields:
  &quot;__closedCallbacks&quot; = (  )
  &quot;__drainedCallbacks&quot; = (  )
  &quot;__isClosed&quot; = true
  &quot;__isDrained&quot; = true</pre>
Before I didn&apos;t notice that it was both drained and closed, and based on your comment I should use <code>s/closed?</code> instead of <code>s/drained?</code>to understand if all users have closed their page/connection, is that correct? (the room stream is still not closed or drained at this point so I should look at all downstream streams)

I understand that the room&apos;s stream should be closed automatically at some point when there are no active downstream but the point is that events are generated after user action so if there are no users generating events then there will not be new <code>put</code>s which would mark the upstream as closed, so it looks like that the manual cleaning process is still needed.

&gt; Your use case is a pub/sub architecture, and is exactly what <code>event-bus</code> was built for
I&apos;ve learned about <code>event-bus</code> only recently and I want to give it a try but I have a couple of concerns:
‚Ä¢ how does it scale? should I have a bus for each room or one for the whole system with a topic per room?
‚Ä¢ how does cleaning works with the <code>event-bus</code>? should I expect it to automatically remove subscriptions on user disconnections? Should I manage <code>event-bus</code> instances like I do for the stream approach?
I really need to read its code and get familiar with it before taking a decision <b>üôÇ</b>

Thanks again for your help!</z><z id="t1673098864" t="Francesco Pischedda After reading event-bus sources I have decided to try it out and it is working properly; also many concerns have disappeared. If you are curious https://github.com/fpischedda/unrefined/pull/37 are the changes to replace manual streams management with event-bus"><y>#</y><d>2023-01-07</d><h>13:41</h><r>Francesco Pischedda</r>After reading <code>event-bus</code> sources I have decided to try it out and it is working properly; also many concerns have disappeared.

If you are curious <a href="https://github.com/fpischedda/unrefined/pull/37" target="_blank">https://github.com/fpischedda/unrefined/pull/37</a> are the changes to replace manual streams management with <code>event-bus</code></z><z id="t1673098897" t="Arnaud Geiser Thank you Francesco for sharing!"><y>#</y><d>2023-01-07</d><h>13:41</h><r>Arnaud Geiser</r>Thank you Francesco for sharing!</z><z id="t1673098985" t="Arnaud Geiser We should definitely have some documentation regarding event-bus on Aleph"><y>#</y><d>2023-01-07</d><h>13:43</h><r>Arnaud Geiser</r>We should definitely have some documentation regarding <code>event-bus</code> on Aleph</z><z id="t1673099105" t="Francesco Pischedda I would be more than happy to try to write something about it but given my tiny experience with it I am not sure it would be a good idea üòÖ Maybe I can write about my journey from stream to event-bus"><y>#</y><d>2023-01-07</d><h>13:45</h><r>Francesco Pischedda</r>I would be more than happy to try to write something about it but given my tiny experience with it I am not sure it would be a good idea <b>üòÖ</b>
Maybe I can write about my journey from stream to event-bus</z><z id="t1673766792" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0165ADKUDU&quot;}] Sorry for the delay; I&apos;ve been traveling. Glad to hear it worked out, though! And PRs to clarify and improve docs are always welcome."><y>#</y><d>2023-01-15</d><h>07:13</h><r>Matthew Davidson (kingmob)</r><a>@U0165ADKUDU</a> Sorry for the delay; I&apos;ve been traveling. Glad to hear it worked out, though! And PRs to clarify and improve docs are always welcome.</z><z id="t1673074271" t="Matthew Davidson (kingmob) Hi Francesco. First, some terminology, because the Manifold docs are a little vague on this. Draining applies to sources, and closing applies to sinks. The default stream is both a source and sink. So, when you say the user&apos;s sink stream is drained, do you mean the user has read all the messages they&apos;ll get? I ask, because it may be preferable to close the user&apos;s stream when they&apos;re done with it, instead of checking to see whether the stream is drained, for the reasons below. I ask because it sounds you&apos;re duplicating a bit of Manifold&apos;s default behavior. If you closed a downstream, Manifold&apos;s default behavior is to close the upstream when there are no more open downstreams, unless the upstream was created with permanent? set true (see stream* ). The catch is, Manifold can delay clean up until necessary. E.g., see the code buried in manifold.stream.graph/handle-async-put ; Manifold won&apos;t close the upstream until it runs out of open sinks to put to. So, if you stop putting messages on the upstream after you close the final downstream, the upstream could hang around for a while. Your use case is a pub/sub architecture, and is exactly what event-bus was built for. It automatically handles cleanup for you if you close the user&apos;s subscription stream. I suggest giving it a try."><y>#</y><d>2023-01-07</d><h>06:51</h><w>Matthew Davidson (kingmob)</w>Hi Francesco.

First, some terminology, because the Manifold docs are a little vague on this. Draining applies to sources, and closing applies to sinks. The default stream is both a source and sink. So, when you say the user&apos;s sink stream is drained, do you mean the user has read all the messages they&apos;ll get? I ask, because it may be preferable to close the user&apos;s stream when they&apos;re done with it, instead of checking to see whether the stream is drained, for the reasons below.

I ask because it sounds you&apos;re duplicating a bit of Manifold&apos;s default behavior.   If you closed a downstream, Manifold&apos;s default behavior is to close the upstream when there are no more open downstreams, unless the upstream was created with <code>permanent?</code> set true (see <code>stream*</code>).

The catch is, Manifold can delay clean up until necessary. E.g., see the code buried in <code>manifold.stream.graph/handle-async-put</code>; Manifold won&apos;t close the upstream until it runs out of open sinks to <code>put</code> to. So, if you stop putting messages on the upstream after you close the final downstream, the upstream could hang around for a while.

Your use case is a pub/sub architecture, and is exactly what <code>event-bus</code> was built for. It automatically handles cleanup for you if you close the user&apos;s subscription stream. I suggest giving it a try.</z><z id="t1674244586" t="igrishaev Hi! Most of HTTP client like clj-http, clj-http-lite, http-kit and so on accept either connecton-timeout or socket-timeout parameters. I&apos;ve check Aleph docs but don&apos;t see if its client accepts something like this. The question is, how can I specify a timeout in case the remote server responds slowly or even doesn&apos;t respond?"><y>#</y><d>2023-01-20</d><h>19:56</h><w>igrishaev</w>Hi! Most of HTTP client like clj-http, clj-http-lite, http-kit and so on accept either connecton-timeout or socket-timeout parameters. I&apos;ve check Aleph docs but don&apos;t see if its client accepts something like this. The question is, how can I specify a timeout in case the remote server responds slowly or even doesn&apos;t respond?</z><z id="t1674246588" t="pithyless There are 3 separate timeouts - pool, connection, and request. They‚Äôre in the docstring for http/request - https://cljdoc.org/d/aleph/aleph/0.6.0/api/aleph.http#request"><y>#</y><d>2023-01-20</d><h>20:29</h><r>pithyless</r>There are 3 separate timeouts - pool, connection, and request. They‚Äôre in the docstring for <code>http/request</code> - <a href="https://cljdoc.org/d/aleph/aleph/0.6.0/api/aleph.http#request" target="_blank">https://cljdoc.org/d/aleph/aleph/0.6.0/api/aleph.http#request</a></z><z id="t1674739459" t="henrik I‚Äôm using the HTTP client to connect to a server that sends back server-sent events. Is there a way to receive a stream of these for consumption, rather than a deferred with the batched result?"><y>#</y><d>2023-01-26</d><h>13:24</h><w>henrik</w>I‚Äôm using the HTTP client to connect to a server that sends back server-sent events. Is there a way to receive a stream of these for consumption, rather than a deferred with the batched result?</z><z id="t1674805930" t="Arnaud Geiser Hello Henrik! Sorry for the delay, can you share the code with us so we can have a look?"><y>#</y><d>2023-01-27</d><h>07:52</h><r>Arnaud Geiser</r>Hello Henrik!

Sorry for the delay, can you share the code with us so we can have a look?</z><z id="t1674806599" t="henrik Hi [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] ! Sure, thank you! It‚Äôs not much to look at: (aleph-http/post endpoint {:body (json/write-str (assoc default-parameters :stream true)) :headers {&quot;Content-Type&quot; &quot;application/json&quot; &quot;Authorization&quot; (str &quot;Bearer &quot; (api-key))}}) :stream true tells the endpoint to stream back responses rather than send a single chunk, which is something I‚Äôd like to make use of as I can then stream them to the user. Being that it returns a deferred, I get the responses batched at the end of the request, however. So it‚Äôd be great to be able to consume the response stream as it happens. I‚Äôve mucked around with (aleph-http/post endpoint {:pool (aleph-http/connection-pool {:connection-options {:raw-stream? true}}) :body (json/write-str (assoc default-parameters :stream true)) :headers {&quot;Content-Type&quot; &quot;application/json&quot; &quot;Authorization&quot; (str &quot;Bearer &quot; (api-key))}}) But I don‚Äôt really know what I‚Äôm doing here."><y>#</y><d>2023-01-27</d><h>08:03</h><r>henrik</r>Hi <a>@UFKCFTVB8</a>! Sure, thank you! It‚Äôs not much to look at:

<pre>(aleph-http/post endpoint
  {:body    (json/write-str (assoc default-parameters :stream true))
   :headers {&quot;Content-Type&quot;  &quot;application/json&quot;
             &quot;Authorization&quot; (str &quot;Bearer &quot; (api-key))}})</pre>
<code>:stream true</code> tells the endpoint to stream back responses rather than send a single chunk, which is something I‚Äôd like to make use of as I can then stream them to the user.

Being that it returns a deferred, I get the responses batched at the end of the request, however. So it‚Äôd be great to be able to consume the response stream as it happens.

I‚Äôve mucked around with

<pre>(aleph-http/post endpoint
  {:pool    (aleph-http/connection-pool {:connection-options {:raw-stream? true}})
   :body    (json/write-str (assoc default-parameters :stream true))
   :headers {&quot;Content-Type&quot;  &quot;application/json&quot;
             &quot;Authorization&quot; (str &quot;Bearer &quot; (api-key))}})</pre>

But I don‚Äôt really know what I‚Äôm doing here.</z><z id="t1674808360" t="Arnaud Geiser Thanks! I don&apos;t have time to have a look now, I will do it this evening (CET timezone)."><y>#</y><d>2023-01-27</d><h>08:32</h><r>Arnaud Geiser</r>Thanks!
I don&apos;t have time to have a look now, I will do it this evening (CET timezone).</z><z id="t1674859633" t="Arnaud Geiser Here is a really dumb Aleph SSE server/client. [1] What http/get returns is a deferred that returns an InputStream , not the aggregated data. As you can see, the data is printed as it comes and not in an aggregated way. [1] : https://gist.github.com/arnaudgeiser/aec1efea5440160e61320e2aa9069b79"><y>#</y><d>2023-01-27</d><h>22:47</h><r>Arnaud Geiser</r>Here is a really dumb Aleph SSE server/client. [1]
What <code>http/get</code> returns is a deferred that returns an <code>InputStream</code>, not the aggregated data.

As you can see, the data is printed as it comes and not in an aggregated way.

[1] : <a href="https://gist.github.com/arnaudgeiser/aec1efea5440160e61320e2aa9069b79" target="_blank">https://gist.github.com/arnaudgeiser/aec1efea5440160e61320e2aa9069b79</a></z><z id="t1674859853" t="Arnaud Geiser To be honest, I&apos;m not aware of any &quot;good&quot; client side SSE library for Clojure. That&apos;s unfortunate. But depending what you are interested in from your server, it might be just applying a filtering on data: which might be good enough...."><y>#</y><d>2023-01-27</d><h>22:50</h><r>Arnaud Geiser</r>To be honest, I&apos;m not aware of any &quot;good&quot; client side SSE library for Clojure. That&apos;s unfortunate.
But depending what you are interested in from your server, it might be just applying a filtering on <code>data:</code> which might be good enough....</z><z id="t1675088809" t="henrik Thanks [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] , I appreciate the answer nevertheless. I thought there might be a solution for this native to Aleph, since stream constructs are native to it."><y>#</y><d>2023-01-30</d><h>14:26</h><r>henrik</r>Thanks <a>@UFKCFTVB8</a>, I appreciate the answer nevertheless. I thought there might be a solution for this native to Aleph, since stream constructs are native to it.</z><z id="t1675840646" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U06B8J0AJ&quot;}] Yeah, SSE is pretty old, and not well-supported outside of a browser. Aleph&apos;s minimal-level stream support is the basic InputStream, and that&apos;s the best you&apos;ll get for SSE. I&apos;m sure you know this, but server-to-server SSE is pretty unusual. I get that you might be constrained if the other server is outside your control, but if they support WebSockets, that will be 100x easier."><y>#</y><d>2023-02-08</d><h>07:17</h><r>Matthew Davidson (kingmob)</r><a>@U06B8J0AJ</a> Yeah, SSE is pretty old, and not well-supported outside of a browser. Aleph&apos;s minimal-level stream support is the basic InputStream, and that&apos;s the best you&apos;ll get for SSE.

I&apos;m sure you know this, but server-to-server SSE is pretty unusual. I get that you might be constrained if the other server is outside your control, but if they support WebSockets, that will be 100x easier.</z><z id="t1675843251" t="henrik [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] I‚Äôm talking to OpenAI, which offers this. Honestly, I need to scrutinize the API docs a bit further, but so far the only alternative for getting streamed responses I‚Äôve found is SSE."><y>#</y><d>2023-02-08</d><h>08:00</h><r>henrik</r><a>@U10EC98F5</a> I‚Äôm talking to OpenAI, which offers this. Honestly, I need to scrutinize the API docs a bit further, but so far the only alternative for getting streamed responses I‚Äôve found is SSE.</z><z id="t1675841294" t="Matthew Davidson (kingmob) Hi everyone, I got a https://www.clojuriststogether.org/news/q1-2023-funding-announcement/ to work on maintaining and improving Aleph. In addition to basic maintenance, we&apos;ve talked about adding support for HTTP/2 (and maybe even QUIC+HTTP/3), as well as some other niceties (more details in the announcement). Looking forward to multiplexing some streams!"><y>#</y><d>2023-02-08</d><h>07:28</h><w>Matthew Davidson (kingmob)</w>Hi everyone, I got a <a href="https://www.clojuriststogether.org/news/q1-2023-funding-announcement/" target="_blank">https://www.clojuriststogether.org/news/q1-2023-funding-announcement/</a> to work on maintaining and improving Aleph. In addition to basic maintenance, we&apos;ve talked about adding support for HTTP/2 (and maybe even QUIC+HTTP/3), as well as some other niceties (more details in the announcement). Looking forward to multiplexing some streams!</z><z id="t1675857038" t="Arnaud Geiser Congratulations Matthew!"><y>#</y><d>2023-02-08</d><h>11:50</h><r>Arnaud Geiser</r>Congratulations Matthew!</z><z id="t1675931898" t="dergutemoritz Wow that&apos;s great news! Congrats!"><y>#</y><d>2023-02-09</d><h>08:38</h><r>dergutemoritz</r>Wow that&apos;s great news! Congrats!</z><z id="t1675932127" t="Matthew Davidson (kingmob) Thanks!"><y>#</y><d>2023-02-09</d><h>08:42</h><r>Matthew Davidson (kingmob)</r>Thanks!</z><z id="t1675935468" t="dergutemoritz Just recalled that we&apos;re also CT funding member, so happy to see some of our Euros roll your way üôÇ"><y>#</y><d>2023-02-09</d><h>09:37</h><r>dergutemoritz</r>Just recalled that we&apos;re also CT funding member, so happy to see some of our Euros roll your way <b>üôÇ</b></z><z id="t1676895169" t="Ferdinand Beyer In a long-running server, I occasionally experience HTTP-Client connection timeout errors like such: clojure.lang.ExceptionInfo: connection was closed after N seconds I‚Äôm using the default connection pool, which sets keep-alive? true and idle-timeout 0 , so I assume by default connections are kept indefinitely and will eventually time out. There seems to be no automatic retry. This took me by surprise, and I have a few questions: ‚Ä¢ Is this by design? ‚Ä¢ Are the defaults meant for short-lived processes that execute a few requests and then terminate? ‚Ä¢ Am I supposed to use a custom connection pool with idle-timeout for long-lived processes?"><y>#</y><d>2023-02-20</d><h>12:12</h><w>Ferdinand Beyer</w>In a long-running server, I occasionally experience HTTP-Client connection timeout errors like such:

<pre>clojure.lang.ExceptionInfo: connection was closed after N seconds</pre>
I‚Äôm using the default connection pool, which sets <code>keep-alive? true</code> and <code>idle-timeout 0</code>, so I assume by default connections are kept indefinitely and will eventually time out. There seems to be no automatic retry.

This took me by surprise, and I have a few questions:

‚Ä¢ Is this by design?
‚Ä¢ Are the defaults meant for short-lived processes that execute a few requests and then terminate?
‚Ä¢ Am I supposed to use a custom connection pool with <code>idle-timeout</code> for long-lived processes?</z><z id="t1676896207" t="Arnaud Geiser Hello Ferdinand! Can I ask you which version of Aleph (0.6.1, 0.6.0?) you are using? You are correct, this is not &quot;supposed&quot; to happen. When idle-timeout is zero or not defined, the responses stream is not supposed to be closed on normal circumstances (this is what triggers the Exception). It can be when: ‚Ä¢ the Channel is detected as inactive (it should not be) ‚Ä¢ you have an issue with what you are sending (decoder failure handling since Aleph 0.6.1) ‚Ä¢ probably other reasons I don&apos;t have on top of my head If you are using Aleph version 0.6.1 already, can I ask you to downgrade to 0.6.0 and retry? Do you have any code to share?"><y>#</y><d>2023-02-20</d><h>12:30</h><r>Arnaud Geiser</r>Hello Ferdinand!

Can I ask you which version of Aleph (0.6.1, 0.6.0?) you are using?
You are correct, this is not &quot;supposed&quot; to happen. When <code>idle-timeout</code> is zero or not defined, the <code>responses</code> stream is not supposed to be closed on normal circumstances (this is what triggers the Exception).

It can be when:
‚Ä¢ the <code>Channel</code> is detected as inactive (it should not be)
‚Ä¢ you have an issue with what you are sending (decoder failure handling since Aleph 0.6.1)
‚Ä¢ probably other reasons I don&apos;t have on top of my head
If you are using Aleph version 0.6.1 already, can I ask you to downgrade to 0.6.0 and retry?
Do you have any code to share?</z><z id="t1676896299" t="Arnaud Geiser &gt; ‚Ä¢ Is this by design? No, it&apos;s not &gt; ‚Ä¢ Are the defaults meant for short-lived processes that execute a few requests and then terminate? No, by default, idle-timeout is unspecified and thus no IdleStateHandler is added inside the pipeline. &gt; ‚Ä¢ Am I supposed to use a custom connection pool with idle-timeout for long-lived processes? No"><y>#</y><d>2023-02-20</d><h>12:31</h><r>Arnaud Geiser</r>&gt; ‚Ä¢ Is this by design?
No, it&apos;s not

&gt; ‚Ä¢ Are the defaults meant for short-lived processes that execute a few requests and then terminate?
No, by default, <code>idle-timeout</code> is unspecified and thus no <code>IdleStateHandler</code> is added inside the pipeline.

&gt; ‚Ä¢ Am I supposed to use a custom connection pool with <code>idle-timeout</code> for long-lived processes?
No</z><z id="t1676896350" t="Ferdinand Beyer I do use 0.6.1 . Not sure which code to share, I basically call http/request without any ‚Äúfancy‚Äù options."><y>#</y><d>2023-02-20</d><h>12:32</h><r>Ferdinand Beyer</r>I do use <code>0.6.1</code>. Not sure which code to share, I basically call <code>http/request</code> without any ‚Äúfancy‚Äù options.</z><z id="t1676896410" t="Ferdinand Beyer When the server closes the connection, will the client get notified and remove it from the pool?"><y>#</y><d>2023-02-20</d><h>12:33</h><r>Ferdinand Beyer</r>When the server closes the connection, will the client get notified and remove it from the pool?</z><z id="t1676896470" t="Ferdinand Beyer I can downgrade to 0.6.0 for sure. Not sure how to reproduce this, I assume it happens when my server is idle for a while itself"><y>#</y><d>2023-02-20</d><h>12:34</h><r>Ferdinand Beyer</r>I can downgrade to 0.6.0 for sure. Not sure how to reproduce this, I assume it happens when my server is idle for a while itself</z><z id="t1676896539" t="Ferdinand Beyer My server basically acts as a HTTP reverse proxy"><y>#</y><d>2023-02-20</d><h>12:35</h><r>Ferdinand Beyer</r>My server basically acts as a HTTP reverse proxy</z><z id="t1676896765" t="Arnaud Geiser &gt; When the server closes the connection, will the client get notified and remove it from the pool? I&apos;m unsure if the issue is on the server or client side currently... But there is definitely something. Let me dig a little bit."><y>#</y><d>2023-02-20</d><h>12:39</h><r>Arnaud Geiser</r>&gt; When the server closes the connection, will the client get notified and remove it from the pool?
I&apos;m unsure if the issue is on the server or client side currently... But there is definitely something. Let me dig a little bit.</z><z id="t1676896804" t="Ferdinand Beyer Just to test my understanding of Aleph‚Äôs code: ‚Ä¢ connection-pool uses create-connection that in turn uses client/http-connection . This will eventually die, when the server closes the connection, right? ‚Ä¢ Subsequent attempts to retrieve a connection will fail ‚Ä¢ request will remove a connection from the pool on error ‚Ä¢ but as far as I can see the connection is not removed by other means?"><y>#</y><d>2023-02-20</d><h>12:40</h><r>Ferdinand Beyer</r>Just to test my understanding of Aleph‚Äôs code:

‚Ä¢ <code>connection-pool</code> uses <code>create-connection</code> that in turn uses <code>client/http-connection</code>. This will eventually die, when the server closes the connection, right?
‚Ä¢ Subsequent attempts to retrieve a connection will fail
‚Ä¢ <code>request</code> will remove a connection from the pool on error
‚Ä¢ but as far as I can see the connection is not removed by other means?</z><z id="t1676896810" t="Ferdinand Beyer This is purely client-side"><y>#</y><d>2023-02-20</d><h>12:40</h><r>Ferdinand Beyer</r>This is purely client-side</z><z id="t1676896852" t="Ferdinand Beyer E.g. my downstream request as a HTTP client fails on http/request"><y>#</y><d>2023-02-20</d><h>12:40</h><r>Ferdinand Beyer</r>E.g. my downstream request as a HTTP client fails on <code>http/request</code></z><z id="t1676896956" t="Arnaud Geiser &gt; ‚Ä¢ connection-pool uses create-connection that in turn uses client/http-connection . This will eventually die, when the server closes the connection, right? If keep-alive is used, the connection will be released to the pool and not destroyed. https://github.com/clj-commons/aleph/blob/master/src/aleph/http.clj#L387-L391"><y>#</y><d>2023-02-20</d><h>12:42</h><r>Arnaud Geiser</r>&gt; ‚Ä¢ <code>connection-pool</code> uses <code>create-connection</code> that in turn uses <code>client/http-connection</code>. This will eventually die, when the server closes the connection, right?
If <code>keep-alive</code> is used, the connection will be <code>released</code> to the pool and not destroyed. <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http.clj#L387-L391" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http.clj#L387-L391</a></z><z id="t1676896957" t="Ferdinand Beyer create-connection ‚Äôs docstring reads: If the server disconnects, all responses will be errors, and a new connection must be created. However, maybe we are missing an automated handling here?"><y>#</y><d>2023-02-20</d><h>12:42</h><r>Ferdinand Beyer</r><code>create-connection</code>‚Äôs docstring reads:

<pre>If the server disconnects, all responses will be errors, and a new connection must be created.</pre>
However, maybe we are missing an automated handling here?</z><z id="t1676897180" t="Arnaud Geiser (Random guess) : I&apos;m wondering if it&apos;s not related to the Dirigiste changes we have done recently to ensure the Pool is removed when not active after some time..."><y>#</y><d>2023-02-20</d><h>12:46</h><r>Arnaud Geiser</r>(Random guess) : I&apos;m wondering if it&apos;s not related to the Dirigiste changes we have done recently to ensure the <code>Pool</code> is removed when not active after some time...</z></g><g id="s9"><z id="t1676897241" t="Arnaud Geiser Is it something you can reproduce easily?"><y>#</y><d>2023-02-20</d><h>12:47</h><r>Arnaud Geiser</r>Is it something you can reproduce easily?</z><z id="t1676897267" t="Arnaud Geiser (I got my answer... yes) &gt; ERROR in (test-server-name) (client.clj:612) &gt; expected: (.startsWith (request) &quot;localhost&quot;) &gt; actual: clojure.lang.ExceptionInfo: connection was closed after 0.013 seconds &gt; {:request {:user-info nil, :pool #object[io.aleph.dirigiste.Pool 0x431298ef &quot;io.aleph.dirigiste.Pool@431298ef&quot;], :request-url &quot; http://localhost:8080/ &quot;, :headers nil, :server-port 8080, :uri &quot;/&quot;, :server-name &quot;localhost&quot;, :query-string nil, :body nil, :scheme :http, :request-method :get}}"><y>#</y><d>2023-02-20</d><h>12:47</h><r>Arnaud Geiser</r>(I got my answer... yes)

&gt;  ERROR in (test-server-name) (client.clj:612)
&gt; expected: (.startsWith (request) &quot;localhost&quot;)
&gt;   actual: clojure.lang.ExceptionInfo: connection was closed after 0.013 seconds
&gt; {:request {:user-info nil, :pool #object[io.aleph.dirigiste.Pool 0x431298ef &quot;io.aleph.dirigiste.Pool@431298ef&quot;], :request-url &quot;<a href="http://localhost:8080/" target="_blank">http://localhost:8080/</a>&quot;, :headers nil, :server-port 8080, :uri &quot;/&quot;, :server-name &quot;localhost&quot;, :query-string nil, :body nil, :scheme :http, :request-method :get}}</z><z id="t1676897309" t="Arnaud Geiser Please downgrade to version 0.6.0 for now"><y>#</y><d>2023-02-20</d><h>12:48</h><r>Arnaud Geiser</r>Please downgrade to version 0.6.0 for now</z><z id="t1676897356" t="Arnaud Geiser (It&apos;s most likely not Aleph related but due to Dirigiste)"><y>#</y><d>2023-02-20</d><h>12:49</h><r>Arnaud Geiser</r>(It&apos;s most likely not Aleph related but due to Dirigiste)</z><z id="t1676897424" t="Ferdinand Beyer Alright! Not sure though if I understood your hypothesis, probably because I‚Äôm not very familiar with Aleph‚Äôs or dirigiste‚Äôs code. Is there some mechanism in place to automatically remove closed connections from the pool?"><y>#</y><d>2023-02-20</d><h>12:50</h><r>Ferdinand Beyer</r>Alright!

Not sure though if I understood your hypothesis, probably because I‚Äôm not very familiar with Aleph‚Äôs or dirigiste‚Äôs code. Is there some mechanism in place to automatically remove closed connections from the pool?</z><z id="t1676897691" t="Arnaud Geiser (I need to validate my hypothesis first and I will come back with a clear explanation)"><y>#</y><d>2023-02-20</d><h>12:54</h><r>Arnaud Geiser</r>(I need to validate my hypothesis first and I will come back with a clear explanation)</z><z id="t1676897737" t="Ferdinand Beyer Thanks Arnaud!"><y>#</y><d>2023-02-20</d><h>12:55</h><r>Ferdinand Beyer</r>Thanks Arnaud!</z><z id="t1676900110" t="Arnaud Geiser Heads-up: It&apos;s also happening on my side on Aleph 0.6.0... So most likely unrelated to 0.6.1 (and thus Dirigiste changes)."><y>#</y><d>2023-02-20</d><h>13:35</h><r>Arnaud Geiser</r>Heads-up:
It&apos;s also happening on my side on Aleph 0.6.0... So most likely unrelated to 0.6.1 (and thus Dirigiste changes).</z><z id="t1676900157" t="Ferdinand Beyer How did you reproduce it locally?"><y>#</y><d>2023-02-20</d><h>13:35</h><r>Ferdinand Beyer</r>How did you reproduce it locally?</z><z id="t1676900224" t="Arnaud Geiser It&apos;s a bit random... but I executed the test-server-name 1000 times on ring_test.clj :"><y>#</y><d>2023-02-20</d><h>13:37</h><r>Arnaud Geiser</r>It&apos;s a bit random... but I executed the <code>test-server-name</code> 1000 times on <code>ring_test.clj</code> :</z><z id="t1676900230" t="Arnaud Geiser &gt; (deftest test-server-name &gt; (dotimes [_ 1000] &gt; (with-server [:server-name] &gt; (is (.startsWith ^String (request) &quot;localhost&quot;)))))"><y>#</y><d>2023-02-20</d><h>13:37</h><r>Arnaud Geiser</r>&gt;  (deftest test-server-name
&gt;   (dotimes [_ 1000]
&gt;     (with-server [:server-name]
&gt;       (is (.startsWith ^String (request) &quot;localhost&quot;)))))</z><z id="t1676900246" t="Ferdinand Beyer Ah, OK üôÇ"><y>#</y><d>2023-02-20</d><h>13:37</h><r>Ferdinand Beyer</r>Ah, OK <b>üôÇ</b></z><z id="t1676900303" t="Arnaud Geiser (I just wanted to validate if it&apos;s something new or not)"><y>#</y><d>2023-02-20</d><h>13:38</h><r>Arnaud Geiser</r>(I just wanted to validate if it&apos;s something new or not)</z><z id="t1676901504" t="Ferdinand Beyer Meanwhile I found out that the connection is supposed to be removed from the pool on close: (create-connection host conn-options&apos; middleware #(flow/dispose @p host [@c])) ;; &lt;-- This is the on-close callback "><y>#</y><d>2023-02-20</d><h>13:58</h><r>Ferdinand Beyer</r>Meanwhile I found out that the connection is supposed to be removed from the pool on close:

<pre>(create-connection
 host
 conn-options&apos;
 middleware
 #(flow/dispose @p host [@c])) ;; &lt;-- This is the on-close callback</pre>
</z><z id="t1676901988" t="Arnaud Geiser To make sure we are on the same page. Your hypothesis is that the HTTP connection is closed (removed from the pool) and later on reused while it should not?"><y>#</y><d>2023-02-20</d><h>14:06</h><r>Arnaud Geiser</r>To make sure we are on the same page.
Your hypothesis is that the HTTP connection is closed (removed from the pool) and later on reused while it should not?</z><z id="t1676902066" t="Ferdinand Beyer Yes, that‚Äôs right. I don‚Äôt know the internals, so I might be totally wrong."><y>#</y><d>2023-02-20</d><h>14:07</h><r>Ferdinand Beyer</r>Yes, that‚Äôs right. I don‚Äôt know the internals, so I might be totally wrong.</z><z id="t1676902212" t="Ferdinand Beyer Oh, you mentioned something about ‚Äúinactive‚Äù channels, and I see that there is invokeChannelInactive in the stack trace, if it helps? clojure.lang.ExceptionInfo: connection was closed after 1019.558 seconds at aleph.http.client$http_connection$fn__8848$fn__8869$fn__8873.invoke(client.clj:612) at manifold.deferred$fn__4795$chain_SINGLEQUOTE____4816.invoke(deferred.clj:748) at manifold.deferred$fn__4795$subscribe__4796$fn__4801.invoke(deferred.clj:714) at manifold.deferred.Listener.onSuccess(deferred.clj:218) at manifold.deferred.Deferred$fn__4647.invoke(deferred.clj:397) at manifold.deferred.Deferred.success(deferred.clj:397) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:242) at manifold.deferred$success_BANG_.invoke(deferred.clj:239) at manifold.stream.default.Stream$fn__5903.invoke(default.clj:124) at manifold.stream.default.Stream.close(default.clj:123) at aleph.http.client$client_handler$reify__8775.channelInactive(client.clj:210) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:305) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281) at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274) at io.netty.handler.stream.ChunkedWriteHandler.channelInactive(ChunkedWriteHandler.java:137) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:303) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281) at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274) at io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelInactive(CombinedChannelDuplexHandler.java:418) at io.netty.handler.codec.ByteToMessageDecoder.channelInputClosed(ByteToMessageDecoder.java:411) at io.netty.handler.codec.ByteToMessageDecoder.channelInactive(ByteToMessageDecoder.java:376) at io.netty.handler.codec.http.HttpClientCodec$Decoder.channelInactive(HttpClientCodec.java:329) at io.netty.channel.CombinedChannelDuplexHandler.channelInactive(CombinedChannelDuplexHandler.java:221) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:303) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281) at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274) at io.netty.handler.codec.ByteToMessageDecoder.channelInputClosed(ByteToMessageDecoder.java:411) at io.netty.handler.codec.ByteToMessageDecoder.channelInactive(ByteToMessageDecoder.java:376) at io.netty.handler.ssl.SslHandler.channelInactive(SslHandler.java:1075) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:305) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281) at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelInactive(DefaultChannelPipeline.java:1405) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:301) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281) at io.netty.channel.DefaultChannelPipeline.fireChannelInactive(DefaultChannelPipeline.java:901) at io.netty.channel.AbstractChannel$AbstractUnsafe$7.run(AbstractChannel.java:813) at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174) at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167) at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:566) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at manifold.executor$thread_factory$reify__4155$f__4156.invoke(executor.clj:70) at clojure.lang.AFn.run(AFn.java:22) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Unknown Source)"><y>#</y><d>2023-02-20</d><h>14:10</h><r>Ferdinand Beyer</r>Oh, you mentioned something about ‚Äúinactive‚Äù channels, and I see that there is <code>invokeChannelInactive</code> in the stack trace, if it helps?

<pre>clojure.lang.ExceptionInfo: connection was closed after 1019.558 seconds
	at aleph.http.client$http_connection$fn__8848$fn__8869$fn__8873.invoke(client.clj:612)
	at manifold.deferred$fn__4795$chain_SINGLEQUOTE____4816.invoke(deferred.clj:748)
	at manifold.deferred$fn__4795$subscribe__4796$fn__4801.invoke(deferred.clj:714)
	at manifold.deferred.Listener.onSuccess(deferred.clj:218)
	at manifold.deferred.Deferred$fn__4647.invoke(deferred.clj:397)
	at manifold.deferred.Deferred.success(deferred.clj:397)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:242)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:239)
	at manifold.stream.default.Stream$fn__5903.invoke(default.clj:124)
	at manifold.stream.default.Stream.close(default.clj:123)
	at aleph.http.client$client_handler$reify__8775.channelInactive(client.clj:210)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:305)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274)
	at io.netty.handler.stream.ChunkedWriteHandler.channelInactive(ChunkedWriteHandler.java:137)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:303)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274)
	at io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelInactive(CombinedChannelDuplexHandler.java:418)
	at io.netty.handler.codec.ByteToMessageDecoder.channelInputClosed(ByteToMessageDecoder.java:411)
	at io.netty.handler.codec.ByteToMessageDecoder.channelInactive(ByteToMessageDecoder.java:376)
	at io.netty.handler.codec.http.HttpClientCodec$Decoder.channelInactive(HttpClientCodec.java:329)
	at io.netty.channel.CombinedChannelDuplexHandler.channelInactive(CombinedChannelDuplexHandler.java:221)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:303)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274)
	at io.netty.handler.codec.ByteToMessageDecoder.channelInputClosed(ByteToMessageDecoder.java:411)
	at io.netty.handler.codec.ByteToMessageDecoder.channelInactive(ByteToMessageDecoder.java:376)
	at io.netty.handler.ssl.SslHandler.channelInactive(SslHandler.java:1075)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:305)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:274)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelInactive(DefaultChannelPipeline.java:1405)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:301)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:281)
	at io.netty.channel.DefaultChannelPipeline.fireChannelInactive(DefaultChannelPipeline.java:901)
	at io.netty.channel.AbstractChannel$AbstractUnsafe$7.run(AbstractChannel.java:813)
	at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:566)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at manifold.executor$thread_factory$reify__4155$f__4156.invoke(executor.clj:70)
	at clojure.lang.AFn.run(AFn.java:22)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Unknown Source)</pre></z><z id="t1676902742" t="Arnaud Geiser &gt; clojure.lang.ExceptionInfo: connection was closed after 1019.558 seconds We talked about the client, but are you also targeting an Aleph server?"><y>#</y><d>2023-02-20</d><h>14:19</h><r>Arnaud Geiser</r>&gt;  clojure.lang.ExceptionInfo: connection was closed after 1019.558 seconds
We talked about the client, but are you also targeting an Aleph server?</z><z id="t1676902765" t="Ferdinand Beyer Nope, the server is a third party"><y>#</y><d>2023-02-20</d><h>14:19</h><r>Ferdinand Beyer</r>Nope, the server is a third party</z><z id="t1676902786" t="Arnaud Geiser Can I be the third-party that closes the connection isntead?"><y>#</y><d>2023-02-20</d><h>14:19</h><r>Arnaud Geiser</r>Can I be the third-party that closes the connection isntead?</z><z id="t1676902789" t="Arnaud Geiser it*"><y>#</y><d>2023-02-20</d><h>14:19</h><r>Arnaud Geiser</r>it*</z><z id="t1676902841" t="Ferdinand Beyer Sure, that was my assumption. That Aleph tries to keep a connection open and the server closes it eventually"><y>#</y><d>2023-02-20</d><h>14:20</h><r>Ferdinand Beyer</r>Sure, that was my assumption. That Aleph tries to keep a connection open and the server closes it eventually</z><z id="t1676902856" t="Ferdinand Beyer Or do you mean mid-response?"><y>#</y><d>2023-02-20</d><h>14:20</h><r>Ferdinand Beyer</r>Or do you mean mid-response?</z><z id="t1676902868" t="Arnaud Geiser (Because what I&apos;m investigating - is not the same symptom as the one you sent me (the stacktrace)"><y>#</y><d>2023-02-20</d><h>14:21</h><r>Arnaud Geiser</r>(Because what I&apos;m investigating - is not the same symptom as the one you sent me (the stacktrace)</z><z id="t1676902883" t="Arnaud Geiser &gt; Sure, that was my assumption. That Aleph tries to keep a connection open and the server closes it eventually Yes, that&apos;s what I think too"><y>#</y><d>2023-02-20</d><h>14:21</h><r>Arnaud Geiser</r>&gt;  Sure, that was my assumption. That Aleph tries to keep a connection open and the server closes it eventually
Yes, that&apos;s what I think too</z><z id="t1676902985" t="Ferdinand Beyer That‚Äôs why I asked about the idle timeout. As a proxy, it might make sense to reuse a connection if I get multiple requests myself at the same time, but after a short idle time it does not make sense to assume the connection is still open for the next request"><y>#</y><d>2023-02-20</d><h>14:23</h><r>Ferdinand Beyer</r>That‚Äôs why I asked about the idle timeout. As a proxy, it might make sense to reuse a connection if I get multiple requests myself at the same time, but after a short idle time it does not make sense to assume the connection is still open for the next request</z><z id="t1676903237" t="Ferdinand Beyer Maybe some kind of race condition? Connection is closed -&gt; it is removed from the pool. Next request: acquires the connection-fn from the pool"><y>#</y><d>2023-02-20</d><h>14:27</h><r>Ferdinand Beyer</r>Maybe some kind of race condition?

Connection is closed -&gt; it is removed from the pool.
Next request: acquires the connection-fn from the pool</z><z id="t1676903255" t="Arnaud Geiser But here we are talking about a single request that took 17 minutes to be completed, no? https://github.com/clj-commons/aleph/blob/master/src/aleph/http/client.clj#L596-L613"><y>#</y><d>2023-02-20</d><h>14:27</h><r>Arnaud Geiser</r>But here we are talking about a single request that took 17 minutes to be completed, no?
<a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/client.clj#L596-L613" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/client.clj#L596-L613</a></z><z id="t1676903299" t="Ferdinand Beyer No, the request failed after 0.2s. The time t0 here is the time since the connection was created, right?"><y>#</y><d>2023-02-20</d><h>14:28</h><r>Ferdinand Beyer</r>No, the request failed after 0.2s. The time <code>t0</code> here is the time since the connection was created, right?</z><z id="t1676903356" t="Arnaud Geiser Yes, correct, sorry!"><y>#</y><d>2023-02-20</d><h>14:29</h><r>Arnaud Geiser</r>Yes, correct, sorry!</z><z id="t1676903366" t="Ferdinand Beyer No worries"><y>#</y><d>2023-02-20</d><h>14:29</h><r>Ferdinand Beyer</r>No worries</z><z id="t1676904039" t="Arnaud Geiser Anyway, it&apos;s a good lead. A connection that has been closed that went back to the pool while it should have not. AFAIK, only flow/release inside Aleph will move the connection back to the pool. There is something I don&apos;t get for now.."><y>#</y><d>2023-02-20</d><h>14:40</h><r>Arnaud Geiser</r>Anyway, it&apos;s a good lead.
A connection that has been closed that went back to the pool while it should have not.

AFAIK, only <code>flow/release</code> inside Aleph will move the connection back to the pool.
There is something I don&apos;t get for now..</z><z id="t1676904133" t="Ferdinand Beyer Well I think the connection was OK and sent back to the pool, but it can be closed by the server while it is in the pool, right? Theoretically it should then get disposed‚Ä¶"><y>#</y><d>2023-02-20</d><h>14:42</h><r>Ferdinand Beyer</r>Well I think the connection was OK and sent back to the pool, but it can be closed by the server while it is in the pool, right? Theoretically it should then get disposed‚Ä¶</z><z id="t1676904210" t="Arnaud Geiser Aaarrf.. that would be terribly annoying.."><y>#</y><d>2023-02-20</d><h>14:43</h><r>Arnaud Geiser</r>Aaarrf.. that would be terribly annoying..</z><z id="t1676904381" t="Arnaud Geiser &gt; Theoretically it should then get disposed‚Ä¶ But it means we&apos;ll only know when we&apos;ll try to fetch a connection back from the pool?"><y>#</y><d>2023-02-20</d><h>14:46</h><r>Arnaud Geiser</r>&gt; Theoretically it should then get disposed‚Ä¶
But it means we&apos;ll only know when we&apos;ll try to fetch a connection back from the pool?</z><z id="t1676904428" t="Ferdinand Beyer Not sure how this Dirigiste thing works."><y>#</y><d>2023-02-20</d><h>14:47</h><r>Ferdinand Beyer</r>Not sure how this Dirigiste thing works.</z><z id="t1676904465" t="Arnaud Geiser It&apos;s really just &quot;object pooling&quot;, nothing more. There is no janitor concept inside it."><y>#</y><d>2023-02-20</d><h>14:47</h><r>Arnaud Geiser</r>It&apos;s really just &quot;object pooling&quot;, nothing more. There is no janitor concept inside it.</z><z id="t1676904539" t="Arnaud Geiser You have the whole API of pool there : https://github.com/clj-commons/dirigiste/blob/master/test/java/io/aleph/dirigiste/PoolTest.java#L60-L67 ‚Ä¢ acquire ‚Ä¢ dispose ‚Ä¢ release "><y>#</y><d>2023-02-20</d><h>14:48</h><r>Arnaud Geiser</r>You have the whole API of pool there : <a href="https://github.com/clj-commons/dirigiste/blob/master/test/java/io/aleph/dirigiste/PoolTest.java#L60-L67" target="_blank">https://github.com/clj-commons/dirigiste/blob/master/test/java/io/aleph/dirigiste/PoolTest.java#L60-L67</a>

‚Ä¢ acquire
‚Ä¢ dispose
‚Ä¢ release
</z><z id="t1676905337" t="Ferdinand Beyer Thinking about the stacktrace. It looks like the channel became inactive and this closed the stream, while we tried to get the connection, and this is all synchronous: at aleph.http.client$http_connection$fn__8848$fn__8869$fn__8873.invoke(client.clj:612) at manifold.deferred$fn__4795$chain_SINGLEQUOTE____4816.invoke(deferred.clj:748) at manifold.deferred$fn__4795$subscribe__4796$fn__4801.invoke(deferred.clj:714) at manifold.deferred.Listener.onSuccess(deferred.clj:218) at manifold.deferred.Deferred$fn__4647.invoke(deferred.clj:397) at manifold.deferred.Deferred.success(deferred.clj:397) at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:242) at manifold.deferred$success_BANG_.invoke(deferred.clj:239) at manifold.stream.default.Stream$fn__5903.invoke(default.clj:124) at manifold.stream.default.Stream.close(default.clj:123) at aleph.http.client$client_handler$reify__8775.channelInactive(client.clj:210) If the connection got closed before request is called, I‚Äôd expect the stream to already be closed, and the deferred from (s/take! responses ::closed) would be a new one, so that the stack trace should not contain aleph.http.client$client_handler$reify__8775.channelInactive"><y>#</y><d>2023-02-20</d><h>15:02</h><r>Ferdinand Beyer</r>Thinking about the stacktrace. It looks like the channel became inactive and this closed the stream, while we tried to get the connection, and this is all synchronous:

<pre>at aleph.http.client$http_connection$fn__8848$fn__8869$fn__8873.invoke(client.clj:612)
	at manifold.deferred$fn__4795$chain_SINGLEQUOTE____4816.invoke(deferred.clj:748)
	at manifold.deferred$fn__4795$subscribe__4796$fn__4801.invoke(deferred.clj:714)
	at manifold.deferred.Listener.onSuccess(deferred.clj:218)
	at manifold.deferred.Deferred$fn__4647.invoke(deferred.clj:397)
	at manifold.deferred.Deferred.success(deferred.clj:397)
	at manifold.deferred$success_BANG_.invokeStatic(deferred.clj:242)
	at manifold.deferred$success_BANG_.invoke(deferred.clj:239)
	at manifold.stream.default.Stream$fn__5903.invoke(default.clj:124)
	at manifold.stream.default.Stream.close(default.clj:123)
	at aleph.http.client$client_handler$reify__8775.channelInactive(client.clj:210)</pre>
If the connection got closed before <code>request</code> is called, I‚Äôd expect the stream to already be closed, and the deferred from <code>(s/take! responses ::closed)</code> would be a new one, so that the stack trace should not contain <code>aleph.http.client$client_handler$reify__8775.channelInactive</code></z><z id="t1676905393" t="Ferdinand Beyer Not sure how netty works, maybe we only observe a connection to be closed when trying to send a request?"><y>#</y><d>2023-02-20</d><h>15:03</h><r>Ferdinand Beyer</r>Not sure how netty works, maybe we only observe a connection to be closed when trying to send a request?</z><z id="t1676905460" t="Arnaud Geiser Agreed. I was investigating this behavior (I had no channelInactive on my stacktrace) &gt; would be a new one, so that the stack trace should not contain aleph.http.client$client_handler$reify__8775.channelInactive"><y>#</y><d>2023-02-20</d><h>15:04</h><r>Arnaud Geiser</r>Agreed. I was investigating this behavior (I had no channelInactive on my stacktrace)

&gt;  would be a new one, so that the stack trace should not contain <code>aleph.http.client$client_handler$reify__8775.channelInactive</code></z><z id="t1676905531" t="Arnaud Geiser &gt; Not sure how netty works, maybe we only observe a connection to be closed when trying to send a request? Unfortunately, I don&apos;t know, I&apos;m trying to put some logging before sending the request to check for a &quot;.isClosed&quot;."><y>#</y><d>2023-02-20</d><h>15:05</h><r>Arnaud Geiser</r>&gt;  Not sure how netty works, maybe we only observe a connection to be closed when trying to send a request?
Unfortunately, I don&apos;t know, I&apos;m trying to put some logging before sending the request to check for a &quot;.isClosed&quot;.</z><z id="t1676905570" t="Arnaud Geiser (I will come later this evening (CET), I won&apos;t forget this issue)"><y>#</y><d>2023-02-20</d><h>15:06</h><r>Arnaud Geiser</r>(I will come later this evening (CET), I won&apos;t forget this issue)</z><z id="t1676911898" t="Arnaud Geiser I won&apos;t draw any conclusion.. but both on your case and mine, this is what triggers the &quot;ChannelInactive&quot; : https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/AbstractChannel.java#L795-L827"><y>#</y><d>2023-02-20</d><h>16:51</h><r>Arnaud Geiser</r>I won&apos;t draw any conclusion.. but both on your case and mine, this is what triggers the &quot;ChannelInactive&quot; : <a href="https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/AbstractChannel.java#L795-L827" target="_blank">https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/AbstractChannel.java#L795-L827</a></z><z id="t1676912273" t="Ferdinand Beyer I noticed something else: I only got this error in one handler, which provides a download of a 50 MB file, streaming the upstream input stream downstream to the client. I wonder if the connection is returned before this download completes, or if the connection remains in a weird state if the response is not consumer completely?"><y>#</y><d>2023-02-20</d><h>16:57</h><r>Ferdinand Beyer</r>I noticed something else: I only got this error in one handler, which provides a download of a 50 MB file, streaming the upstream input stream downstream to the client.

I wonder if the connection is returned before this download completes, or if the connection remains in a weird state if the response is not consumer completely?</z><z id="t1676913277" t="Arnaud Geiser Maybe.. To be completely honest, I&apos;m having a hard time understanding how this responses stream is supposed to work. [1] How do we even guarantee that the response we got from the stream is related to the req we wanted to send? What guarantees the ordering? [1] : https://github.com/clj-commons/aleph/blob/master/src/aleph/http/client.clj#L603"><y>#</y><d>2023-02-20</d><h>17:14</h><r>Arnaud Geiser</r>Maybe.. To be completely honest, I&apos;m having a hard time understanding how this <code>responses</code> stream is supposed to work. [1]

How do we even guarantee that the response we got from the stream is related to the <code>req</code> we wanted to send? What guarantees the ordering?

[1] : <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/client.clj#L603" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/client.clj#L603</a></z><z id="t1676917601" t="Matthew Davidson (kingmob) &gt; How do we even guarantee that the response we got from the stream is related to the req we wanted to send? What guarantees the ordering? Because of the request-response nature of HTTP, remember. The requestor waits for a response before requesting again. The keep-alive header is about the TCP connection, not the HTTP. Admittedly, it gets more convoluted once we add HTTP pipelining, which enables a requestor to send multiple requests before getting a response. This is where content-length and chunked transfer encoding comes in. On the server-side, if you use HTTP/1.1 pipelining, and a later handler finishes before an earlier one, it will be chained to wait until the previous one&apos;s deferred is finished, so there&apos;s no issues there."><y>#</y><d>2023-02-20</d><h>18:26</h><r>Matthew Davidson (kingmob)</r>&gt; How do we even guarantee that the response we got from the stream is related to the <code>req</code> we wanted to send? What guarantees the ordering?
Because of the request-response nature of HTTP, remember. The requestor waits for a response before requesting again. The keep-alive header is about the TCP connection, not the HTTP.

Admittedly, it gets more convoluted once we add HTTP pipelining, which enables a requestor to send multiple requests before getting a response. This is where content-length and chunked transfer encoding comes in.

On the server-side, if you use HTTP/1.1 pipelining, and a later handler finishes before an earlier one, it will be chained to wait until the previous one&apos;s deferred is finished, so there&apos;s no issues there.</z><z id="t1676917635" t="Matthew Davidson (kingmob) What evidence do we currently have that this is related to dirigiste? Because I suspect it may be a race elsewhere."><y>#</y><d>2023-02-20</d><h>18:27</h><r>Matthew Davidson (kingmob)</r>What evidence do we currently have that this is related to dirigiste? Because I suspect it may be a race elsewhere.</z><z id="t1676917798" t="Arnaud Geiser No evidence. Dirigiste was just an easy target. I don&apos;t think it is anymore. Maybe a destroy that got called why scaling down a Pool. To me, Dirigiste is no more a good lead to explore."><y>#</y><d>2023-02-20</d><h>18:29</h><r>Arnaud Geiser</r>No evidence. Dirigiste was just an easy target. I don&apos;t think it is anymore. Maybe a destroy that got called why scaling down a Pool. To me, Dirigiste is no more a good lead to explore.</z><z id="t1676918137" t="Arnaud Geiser Also, I had a build failure related to this issue when merging an unrelated PR. https://app.circleci.com/pipelines/github/clj-commons/aleph/470/workflows/17b1008d-4bbf-4b3c-b345-2545f3f5112b/jobs/455/parallel-runs/0/steps/0-107"><y>#</y><d>2023-02-20</d><h>18:35</h><r>Arnaud Geiser</r>Also, I had a build failure related to this issue when merging an unrelated PR.
<a href="https://app.circleci.com/pipelines/github/clj-commons/aleph/470/workflows/17b1008d-4bbf-4b3c-b345-2545f3f5112b/jobs/455/parallel-runs/0/steps/0-107" target="_blank">https://app.circleci.com/pipelines/github/clj-commons/aleph/470/workflows/17b1008d-4bbf-4b3c-b345-2545f3f5112b/jobs/455/parallel-runs/0/steps/0-107</a></z><z id="t1676918386" t="Matthew Davidson (kingmob) In http-connection , the responses stream is passed to the client handler, which sets up a callback for channelInactive events to close the stream. And on incoming requests, the request fn grabs the channel&apos;s monitor before putting requests on the requests stream and taking the response. Other places aren&apos;t locking on the channel, but even if they were, I&apos;m not sure netty itself is using that monitor, so a channel might be closed even if the monitor is held. E.g.: rsp (locking ch (s/put! requests req) (s/take! responses ::closed))] (-&gt; (netty/safe-execute ch (http/send-message ch true ssl? req&apos; body)) (d/catch&apos; (fn [e] (s/put! responses (d/error-deferred e)) (netty/close ch)))))) ;; this will usually happen because of a malformed request (catch Throwable e (s/put! responses (d/error-deferred e)) (netty/close ch)))) Both of the catch examples above could be a race, if the put! actually runs AFTER the netty/close -&gt; channelinactive handler closes the response stream. Solution is to either lock on the channel, or not close it until after the error-deferred has been put on the responses stream. However, I don&apos;t know how it will interact with netty, have to check..."><y>#</y><d>2023-02-20</d><h>18:39</h><r>Matthew Davidson (kingmob)</r>In <code>http-connection</code>, the <code>responses</code> stream is passed to the client handler, which sets up a callback for channelInactive events to close the stream.

And on incoming requests, the request fn grabs the channel&apos;s monitor before putting requests on the requests stream and taking the response. Other places aren&apos;t locking on the channel, but even if they were, I&apos;m not sure netty itself is using that monitor, so a channel might be closed even if the monitor is held.

E.g.:
<pre>rsp (locking ch
                                  (s/put! requests req)
                                  (s/take! responses ::closed))]</pre>
<pre>(-&gt; (netty/safe-execute ch
                                                  (http/send-message ch true ssl? req&apos; body))
                              (d/catch&apos; (fn [e]
                                          (s/put! responses (d/error-deferred e))
                                          (netty/close ch))))))

                      ;; this will usually happen because of a malformed request
                      (catch Throwable e
                        (s/put! responses (d/error-deferred e))
                        (netty/close ch)))) </pre>
Both of the catch examples above could be a race, if the <code>put!</code> actually runs AFTER the netty/close -&gt; channelinactive handler closes the response stream.

Solution is to either lock on the channel, or not close it until after the error-deferred has been put on the responses stream. However, I don&apos;t know how it will interact with netty, have to check...</z><z id="t1676918427" t="Matthew Davidson (kingmob) It&apos;s really late here, I have to call it a night..."><y>#</y><d>2023-02-20</d><h>18:40</h><r>Matthew Davidson (kingmob)</r>It&apos;s really late here, I have to call it a night...</z><z id="t1676918768" t="Arnaud Geiser For the record, here is the PR : https://github.com/clj-commons/aleph/pull/592/files"><y>#</y><d>2023-02-20</d><h>18:46</h><r>Arnaud Geiser</r>For the record, here is the PR : <a href="https://github.com/clj-commons/aleph/pull/592/files" target="_blank">https://github.com/clj-commons/aleph/pull/592/files</a></z><z id="t1676919418" t="Arnaud Geiser If it proved to be the root cause, we can definitely remove those netty/close. Aleph lived with it during a long time."><y>#</y><d>2023-02-20</d><h>18:56</h><r>Arnaud Geiser</r>If it proved to be the root cause, we can definitely remove those netty/close. Aleph lived with it during a long time.</z><z id="t1676944050" t="Matthew Davidson (kingmob) I didn‚Äôt get much sleep the night before, so I think I was concerned about the wrong thing. The ‚Äúrace‚Äù I was worried about shouldn‚Äôt be a concern, or at least, not be related to this issue. The locking call maybe needs a closer look, though"><y>#</y><d>2023-02-21</d><h>01:47</h><r>Matthew Davidson (kingmob)</r>I didn‚Äôt get much sleep the night before, so I think I was concerned about the wrong thing. The ‚Äúrace‚Äù I was worried about shouldn‚Äôt be a concern, or at least, not be related to this issue. 

The locking call maybe needs a closer look, though</z><z id="t1676952566" t="Matthew Davidson (kingmob) Hmm, if we go to the commit before PR #592, does that solve the problem?"><y>#</y><d>2023-02-21</d><h>04:09</h><r>Matthew Davidson (kingmob)</r>Hmm, if we go to the commit before PR #592, does that solve the problem?</z><z id="t1676976384" t="Arnaud Geiser (I haven&apos;t try yet, but for me, that&apos;s not the culprit) My current hypothesis is that we got closed asynchronously (for whatever reason, which might not even be an Exception) [1]. And later on, when the connection is reused, the response-stream is closed already. [1] : https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/AbstractChannel.java#L795-L827"><y>#</y><d>2023-02-21</d><h>10:46</h><r>Arnaud Geiser</r>(I haven&apos;t try yet, but for me, that&apos;s not the culprit)
My current hypothesis is that we got closed asynchronously (for whatever reason, which might not even be an Exception) [1].
And later on, when the connection is reused, the response-stream is closed already.

[1] : <a href="https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/AbstractChannel.java#L795-L827" target="_blank">https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/AbstractChannel.java#L795-L827</a></z><z id="t1677050180" t="Matthew Davidson (kingmob) (Minor addendum about HTTP/1.1 pipelining: we support it, but apparently almost no browsers do anymore; too problematic)"><y>#</y><d>2023-02-22</d><h>07:16</h><r>Matthew Davidson (kingmob)</r>(Minor addendum about HTTP/1.1 pipelining: we support it, but apparently almost no browsers do anymore; too problematic)</z><z id="t1705923268" t="Ferdinand Beyer Totally forgot about this. Back then, I added an ugly workaround to our code, that checks if an exception message starts with &quot;connection was closed&quot; and if so just retries to send the request again. This seemed to have worked in most cases, but today I encountered the same issue again. I think my workaround did not catch it because I retry only once. Did anyone of you by any chance follow up on this?"><y>#</y><d>2024-01-22</d><h>11:34</h><r>Ferdinand Beyer</r>Totally forgot about this. Back then, I added an ugly workaround to our code, that checks if an exception message starts with <code>&quot;connection was closed&quot;</code> and if so just retries to send the request again.

This seemed to have worked in most cases, but today I encountered the same issue again. I think my workaround did not catch it because I retry only once.

Did anyone of you by any chance follow up on this?</z><z id="t1705933130" t="Arnaud Geiser I&apos;m not follwing up on this since it&apos;s clearly a behaviour Aleph&apos;s client has. There is nothing that will guarantee the connection that is pulled from the pool is still active. What you have implemented (while ugly) makes sense in the current state. I would be keen on having this behaviour supported out-of-the box inside the Aleph&apos;s client. What is your current position on this [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] ?"><y>#</y><d>2024-01-22</d><h>14:18</h><r>Arnaud Geiser</r>I&apos;m not follwing up on this since it&apos;s clearly a behaviour Aleph&apos;s client has. There is nothing that will guarantee the connection that is pulled from the pool is still active. What you have implemented (while ugly) makes sense in the current state. I would be keen on having this behaviour supported out-of-the box inside the Aleph&apos;s client. What is your current position on this <a>@U10EC98F5</a>?</z><z id="t1705940435" t="Matthew Davidson (kingmob) Hmm, it definitely seems like a bug, albeit a rare one. Invalid conns are supposed to be disposed of, not released back to the pool. And if the other end/Netty kills it, it should be disposed of properly. I&apos;d prefer to figure out the right combination of locks and/or event callbacks to ensure that objs acquired from the pool are valid, and not check exception error msgs. Unfortunately, [:attrs {:href &quot;/_/_/users/U922FGW59&quot;}] , I have to focus on finding paying work for now, so it might be a while before I take a closer look."><y>#</y><d>2024-01-22</d><h>16:20</h><r>Matthew Davidson (kingmob)</r>Hmm, it definitely seems like a bug, albeit a rare one. Invalid conns are supposed to be disposed of, not released back to the pool. And if the other end/Netty kills it, it should be disposed of properly. I&apos;d prefer to figure out the right combination of locks and/or event callbacks to ensure that objs acquired from the pool are valid, and not check exception error msgs.

Unfortunately, <a>@U922FGW59</a>, I have to focus on finding paying work for now, so it might be a while before I take a closer look.</z><z id="t1705940500" t="Ferdinand Beyer That‚Äôs OK, same here! Thanks!"><y>#</y><d>2024-01-22</d><h>16:21</h><r>Ferdinand Beyer</r>That‚Äôs OK, same here! Thanks!</z><z id="t1705950824" t="Arnaud Geiser &gt; Invalid conns are supposed to be disposed of, not released back to the pool. And if the other end/Netty kills it, it should be disposed of properly. Yes, and that scenario definitely works without any bug I&apos;m aware of. What about a connection that is closed while being in the pool? Do we have a mechanism that is going to remove that invalid connection from the pool? Any pointer in the code so I can have a look?"><y>#</y><d>2024-01-22</d><h>19:13</h><r>Arnaud Geiser</r>&gt; Invalid conns are supposed to be disposed of, not released back to the pool. And if the other end/Netty kills it, it should be disposed of properly.
Yes, and that scenario definitely works without any bug I&apos;m aware of.
What about a connection that is closed while being in the pool? Do we have a mechanism that is going to remove that invalid connection from the pool? Any pointer in the code so I can have a look?</z><z id="t1705992572" t="Matthew Davidson (kingmob) If you look in aleph.http/request , lines 385-396, that&apos;s probably a good place to add a check. By then, it&apos;s successfully obtained a connection fn, but hasn&apos;t called it yet. Would have to obtain the Netty chan underlying it to check. Although...one thing that&apos;s confusing is in aleph.http.client/http-req-fn , lines 909-910, it checks if the chan is active and open, so maybe not. I still suspect it&apos;s a race related to the long-lived nature of the conns here. We do the check when we first make the request, but we don&apos;t really have any way to notify others holding the conn that it&apos;s been closed. &gt; What about a connection that is closed while being in the pool? That should be handled by the call to create-connection , which passes in #(flow/dispose @p host [@c]) for the on-closed parameter."><y>#</y><d>2024-01-23</d><h>06:49</h><r>Matthew Davidson (kingmob)</r>If you look in <code>aleph.http/request</code>, lines 385-396, that&apos;s probably a good place to add a check. By then, it&apos;s successfully obtained a connection fn, but hasn&apos;t called it yet. Would have to obtain the Netty chan underlying it to check.

Although...one thing that&apos;s confusing is in <code>aleph.http.client/http-req-fn</code> , lines 909-910, it checks if the chan is active and open, so maybe not.

I still suspect it&apos;s a race related to the long-lived nature of the conns here. We do the check when we first make the request, but we don&apos;t really have any way to notify others holding the conn that it&apos;s been closed.

&gt; What about a connection that is closed while being in the pool?
That should be handled by the call to <code>create-connection</code>, which passes in <code>#(flow/dispose @p host [@c])</code> for the <code>on-closed</code> parameter.</z><z id="t1677109039" t="Tom Fenton Hey all! I&apos;ve been trying to get figwheel-main up in a command prompt, running alongside aleph. WebSocket connection etc. appears to be fine, BUT I can&apos;t live-reload code because aleph locks resources served via wrap-resource (i.e. the .js files figwheel-main is trying to update). This behaviour is not present in http-kit (does it serve the files without locking them?); however, http-kit doesn&apos;t support ssl directly so it&apos;s not an option. Is this locking intended and/or configurable behaviour in aleph? Apologies for any errors in the above, I&apos;m very new to web dev üôÇ"><y>#</y><d>2023-02-22</d><h>23:37</h><w>Tom Fenton</w>Hey all! I&apos;ve been trying to get figwheel-main up in a command prompt, running alongside aleph. WebSocket connection etc. appears to be fine, BUT I can&apos;t live-reload code because aleph locks resources served via wrap-resource (i.e. the .js files figwheel-main is trying to update). This behaviour is not present in http-kit (does it serve the files without locking them?); however, http-kit doesn&apos;t support ssl directly so it&apos;s not an option. Is this locking intended and/or configurable behaviour in aleph?

Apologies for any errors in the above, I&apos;m very new to web dev <b>üôÇ</b></z><z id="t1677110734" t="hiredman what makes you think a resource is being locked?"><y>#</y><d>2023-02-23</d><h>00:05</h><r>hiredman</r>what makes you think a resource is being locked?</z><z id="t1677110950" t="hiredman most likely you aren&apos;t actual using wrap-resource when testing with http-kit and instead are serving files"><y>#</y><d>2023-02-23</d><h>00:09</h><r>hiredman</r>most likely you aren&apos;t actual using wrap-resource when testing with http-kit and instead are serving files</z><z id="t1677110991" t="hiredman resources are blobs of data read from a classloader, they may be backed by files on disk, or may be entries in a jar, or where ever a classloader chooses to reader them from"><y>#</y><d>2023-02-23</d><h>00:09</h><r>hiredman</r>resources are blobs of data read from a classloader, they may be backed by files on disk, or may be entries in a jar, or where ever a classloader chooses to reader them from</z><z id="t1677111041" t="hiredman in some cases classloaders will cache the contents of a resource, and not reread it again"><y>#</y><d>2023-02-23</d><h>00:10</h><r>hiredman</r>in some cases classloaders will cache the contents of a resource, and not reread it again</z><z id="t1677146275" t="Tom Fenton Hi [:attrs {:href &quot;/_/_/users/U0NCTKEV8&quot;}] , I used figwheel-main to reload my code under different circumstances. 1. Clojure REPL not running 2. Clojure REPL running 3. Clojure REPL running, aleph started 4. Clojure REPL running, aleph started, page served In the first attachment you can see that 1-3 are successful but 4 fails. Reloads continue to fail until I end the REPL process. I&apos;m also unable to delete the file from the file system because it&apos;s locked by the java.exe process. I&apos;m using wrap-resource as part of wrap-defaults (secure-site-defaults), but if I explicitly use the bare-minimum middleware (see second image) I get the same behaviour as soon as I add wrap-resource. I don&apos;t get the same behaviour if I swap in http-kit - the files remain writeable even after being served. Thanks for the insight about the classloader - maybe the two servers use different classloaders, or have them configured differently? But I don&apos;t know nearly enough to go under the hood in Netty üôÇ"><y>#</y><d>2023-02-23</d><h>09:57</h><r>Tom Fenton</r>Hi <a>@U0NCTKEV8</a>, I used figwheel-main to reload my code under different circumstances.

1. Clojure REPL not running
2. Clojure REPL running
3. Clojure REPL running, aleph started
4. Clojure REPL running, aleph started, page served
In the first attachment you can see that 1-3 are successful but 4 fails. Reloads continue to fail until I end the REPL process. I&apos;m also unable to delete the file from the file system because it&apos;s locked by the java.exe process.

I&apos;m using wrap-resource as part of wrap-defaults (secure-site-defaults), but if I explicitly use the bare-minimum middleware (see second image) I get the same behaviour as soon as I add wrap-resource.

I don&apos;t get the same behaviour if I swap in http-kit - the files remain writeable even after being served.

Thanks for the insight about the classloader - maybe the two servers use different classloaders, or have them configured differently? But I don&apos;t know nearly enough to go under the hood in Netty <b>üôÇ</b></z><z id="t1677213490" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAH1JFQV9&quot;}] Hmm, wrap-resource comes from Ring, so you may need to ask around on #C0A5GSC6T for help if the issue is unique to that middleware. If you&apos;re returning a deferred in Aleph and using Ring middleware that alters responses, you will have to wrap the middleware to handle that, because Ring doesn&apos;t understand deferreds. However, I suspect that&apos;s not the case here, because you don&apos;t have a custom handler based on your screenshot."><y>#</y><d>2023-02-24</d><h>04:38</h><r>Matthew Davidson (kingmob)</r><a>@UAH1JFQV9</a> Hmm, <code>wrap-resource</code> comes from Ring, so you may need to ask around on #C0A5GSC6T for help if the issue is unique to that middleware.

If you&apos;re returning a deferred in Aleph and using Ring middleware that alters responses, you will have to wrap the middleware to handle that, because Ring doesn&apos;t understand deferreds. However, I suspect that&apos;s not the case here, because you don&apos;t have a custom handler based on your screenshot.</z><z id="t1677214065" t="Matthew Davidson (kingmob) Looking at it a bit more closely, I suspect the classloader may be the culprit. Netty maintains its own threadpool, which doesn&apos;t use the clojure classloader. Try (wrap-resource &quot;public&quot; {:loader (.getClassLoader clojure.lang.Compiler)}) , something like that might work."><y>#</y><d>2023-02-24</d><h>04:47</h><r>Matthew Davidson (kingmob)</r>Looking at it a bit more closely, I suspect the classloader may be the culprit. Netty maintains its own threadpool, which doesn&apos;t use the clojure classloader.

Try <code>(wrap-resource &quot;public&quot; {:loader (.getClassLoader clojure.lang.Compiler)})</code> , something like that might work.</z><z id="t1677279097" t="Tom Fenton Hi [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] , thanks for taking the time to look into it! I tried experimenting with classloaders but no joy. After a lot of trial and error I think I&apos;ve been barking up the wrong tree. Running with SSL results in resource locking, running without SSL does not (and http-kit doesn&apos;t support SSL so was unaffected...). I still don&apos;t fully understand why yet, but at least I have a workable compromise now - -main starts a secure server, (start-dev) starts an insecure one."><y>#</y><d>2023-02-24</d><h>22:51</h><r>Tom Fenton</r>Hi <a>@U10EC98F5</a>, thanks for taking the time to look into it! I tried experimenting with classloaders but no joy.

After a lot of trial and error I think I&apos;ve been barking up the wrong tree. Running with SSL results in resource locking, running without SSL does not (and http-kit doesn&apos;t support SSL so was unaffected...). I still don&apos;t fully understand why yet, but at least I have a workable compromise now - <code>-main</code> starts a secure server, <code>(start-dev)</code> starts an insecure one.</z><z id="t1677302487" t="Matthew Davidson (kingmob) Hmmmm. Can we see some code? A minimal reproducing example would be great. It would help debug what&apos;s going on if we could see how you&apos;re initializing the server. What ssl-provider and trust-store are you passing in?"><y>#</y><d>2023-02-25</d><h>05:21</h><r>Matthew Davidson (kingmob)</r>Hmmmm. Can we see some code? A minimal reproducing example would be great. It would help debug what&apos;s going on if we could see how you&apos;re initializing the server. What <code>ssl-provider</code> and <code>trust-store</code> are you passing in?</z><z id="t1677302564" t="Matthew Davidson (kingmob) Also, have you talked to Bruce Hauman [:attrs {:href &quot;/_/_/users/U064J0EFR&quot;}] , the figwheel author, yet? He might have some insight."><y>#</y><d>2023-02-25</d><h>05:22</h><r>Matthew Davidson (kingmob)</r>Also, have you talked to Bruce Hauman <a>@U064J0EFR</a>, the figwheel author, yet? He might have some insight.</z><z id="t1677303277" t="Matthew Davidson (kingmob) Only other thing that immediately comes to mind is that placing the generated Js files under resources/ seems odd. As [:attrs {:href &quot;/_/_/users/U0NCTKEV8&quot;}] mentioned, if the resources/ files are being cached, you&apos;ll have an issue. I double-checked, and the standard figwheel location for files is under target/ , which seems more reasonable. I would place only finished files under resources/ as part of the final build steps."><y>#</y><d>2023-02-25</d><h>05:34</h><r>Matthew Davidson (kingmob)</r>Only other thing that immediately comes to mind is that placing the generated Js files under <code>resources/</code> seems odd. As <a>@U0NCTKEV8</a> mentioned, if the <code>resources/</code> files are being cached, you&apos;ll have an issue. I double-checked, and the standard figwheel location for files is under <code>target/</code>, which seems more reasonable. I would place only finished files under <code>resources/</code> as part of the final build steps.</z><z id="t1677451951" t="Tom Fenton No problem - I&apos;ve messaged you with details of a repo I&apos;ve set up to show you where I&apos;m at. Feel free to share if you think it&apos;s useful. It would be great if Bruce has any pointers, either about the locking issue or my poor folder structure üôÇ since I wasn&apos;t getting the behaviour in http-kit I&apos;d assumed the issue was aleph-specific, but now I know SSL is a factor, I&apos;ll experiment next week - will let you know if target vs resources and e.g. Jetty SSL makes any difference. My project is very new (learning how to use WebSockets) so at the moment I&apos;m just using a SelfSignedCertificate (io.netty.handler.ssl.util)."><y>#</y><d>2023-02-26</d><h>22:52</h><r>Tom Fenton</r>No problem - I&apos;ve messaged you with details of a repo I&apos;ve set up to show you where I&apos;m at. Feel free to share if you think it&apos;s useful.

It would be great if Bruce has any pointers, either about the locking issue or my poor folder structure <b>üôÇ</b> since I wasn&apos;t getting the behaviour in http-kit I&apos;d assumed the issue was aleph-specific, but now I know SSL is a factor, I&apos;ll experiment next week - will let you know if target vs resources and e.g. Jetty SSL makes any difference.

My project is very new (learning how to use WebSockets) so at the moment I&apos;m just using a SelfSignedCertificate (io.netty.handler.ssl.util).</z><z id="t1677480690" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAH1JFQV9&quot;}] Quick question before I look too closely at this: have you tried changing the :target-dir to &quot;target&quot;, or somewhere that&apos;s not resources ? It would help if you could rule that out first."><y>#</y><d>2023-02-27</d><h>06:51</h><r>Matthew Davidson (kingmob)</r><a>@UAH1JFQV9</a> Quick question before I look too closely at this: have you tried changing the <code>:target-dir</code> to &quot;target&quot;, or somewhere that&apos;s not <code>resources</code>? It would help if you could rule that out first.</z><z id="t1677544619" t="Tom Fenton Tested again - merged my code into a fresh project based on the official figwheel-main template. Template actually uses resources for the :target-dir , but even after changing it to target (and adding a wrap-resources to serve from target ), the result is the same. Fine for http, locked when enabling SSL."><y>#</y><d>2023-02-28</d><h>00:36</h><r>Tom Fenton</r>Tested again - merged my code into a fresh project based on the official figwheel-main template. Template actually uses <code>resources</code> for the <code>:target-dir</code>, but even after changing it to <code>target</code> (and adding a <code>wrap-resources</code> to serve from <code>target</code>), the result is the same. Fine for http, locked when enabling SSL.</z><z id="t1677739186" t="Matthew Davidson (kingmob) Hmm. What&apos;s weird is that Aleph literally does nothing with resources. It&apos;s possible it&apos;s a netty issue, but a quick search didn&apos;t turn up anything immediately relevant. Tom, I took a look at your minimal example, but it doesn&apos;t seem to be working, even in insecure mode. For starters, it would be helpful to strip out anything unnecessary to demonstrate the problem, like Sente, Timbre, and maybe the CSRF stuff. Next, I got some figwheel warnings about the classpath that I&apos;ve never seen before (probably because your watch dir src/minimal_example/cljs instead of src ): ‚ùØ lein fig:dev [Figwheel:WARNING] The watch directory &quot;src/minimal_example/cljs&quot; is not on the classpath! A watch directory must be on the classpath and point to the root directory of your namespace source tree. A general all encompassing watch directory will not work. [Figwheel:WARNING] Attempting to dynamically add &quot;src/minimal_example/cljs&quot; to classpath! [Figwheel:WARNING] Source directory &quot;src/minimal_example/cljs&quot; is not on the classpath [Figwheel:WARNING] Please fix this by adding &quot;src/minimal_example/cljs&quot; to your classpath I.E. For Clojure CLI Tools in your deps.edn file: ensure &quot;src/minimal_example/cljs&quot; is in your :paths key For Leiningen in your project.clj: add it to the :source-paths key After that, I ran lein repl , and the instructions are wrong. I assume it should be minimal-example.clj.core/start-dev , and not minimal-example.core/start-dev which doesn&apos;t exist. This runs and opens up the app page, but the reagent code never renders, the web page still says &quot;Please wait - loading&quot;. (Fixing the watch dir didn&apos;t fix this) Next, I looked at the console, and saw a bunch of timbre and sente errors: Uncaught SyntaxError: unexpected token: identifier timbre.js:2:8 Uncaught TypeError: can&apos;t access property &quot;call&quot;, taoensso.timbre.swap_config_BANG_ is undefined taoensso$sente$set_min_log_level_BANG_ sente.cljc:105 &lt;anonymous&gt; sente.cljc:109 sente.cljc:105:2 Uncaught TypeError: can&apos;t access property &quot;call&quot;, taoensso.sente.make_channel_socket_client_BANG_ is undefined &lt;anonymous&gt; web.cljs:18 web.cljs:18:7 Your readme says you tested this on Azul. I have no idea if that makes a difference, but it may be safer to run this on a more common JDK, just in case. (FWIW, the cljs community seems to have moved on to shadow-cljs. If you try it, I&apos;d be very curious to know if you see the same problem.) If you get your minimal example working, I&apos;ll take another look"><y>#</y><d>2023-03-02</d><h>06:39</h><r>Matthew Davidson (kingmob)</r>Hmm. What&apos;s weird is that Aleph literally does nothing with resources. It&apos;s possible it&apos;s a netty issue, but a quick search didn&apos;t turn up anything immediately relevant.

Tom, I took a look at your minimal example, but it doesn&apos;t seem to be working, even in insecure mode.

For starters, it would be helpful to strip out anything unnecessary to demonstrate the problem, like Sente, Timbre, and maybe the CSRF stuff.

Next, I got some figwheel warnings about the classpath that I&apos;ve never seen before (probably because your watch dir <code>src/minimal_example/cljs</code> instead of <code>src</code>):
<pre>‚ùØ lein fig:dev
[Figwheel:WARNING] The watch directory &quot;src/minimal_example/cljs&quot; is not on the classpath! A watch directory must be on the classpath and point to the root directory of your namespace source tree. A general all encompassing watch directory will not work.
[Figwheel:WARNING] Attempting to dynamically add &quot;src/minimal_example/cljs&quot; to classpath!
[Figwheel:WARNING] Source directory &quot;src/minimal_example/cljs&quot; is not on the classpath
[Figwheel:WARNING] Please fix this by adding &quot;src/minimal_example/cljs&quot; to your classpath
 I.E.
 For Clojure CLI Tools in your deps.edn file:
    ensure &quot;src/minimal_example/cljs&quot; is in your :paths key

 For Leiningen in your project.clj:
   add it to the :source-paths key</pre>
After that, I ran <code>lein repl</code>, and the instructions are wrong. I assume it should be <code>minimal-example.clj.core/start-dev</code>, and not <code>minimal-example.core/start-dev</code> which doesn&apos;t exist.

This runs and opens up the app page, but the reagent code never renders, the web page still says &quot;Please wait - loading&quot;. (Fixing the watch dir didn&apos;t fix this)

Next, I looked at the console, and saw a bunch of timbre and sente errors:
<pre>Uncaught SyntaxError: unexpected token: identifier
timbre.js:2:8
Uncaught TypeError: can&apos;t access property &quot;call&quot;, taoensso.timbre.swap_config_BANG_ is undefined
    taoensso$sente$set_min_log_level_BANG_ sente.cljc:105
    &lt;anonymous&gt; sente.cljc:109
sente.cljc:105:2
Uncaught TypeError: can&apos;t access property &quot;call&quot;, taoensso.sente.make_channel_socket_client_BANG_ is undefined
    &lt;anonymous&gt; web.cljs:18
web.cljs:18:7</pre>
Your readme says you tested this on Azul. I have no idea if that makes a difference, but it may be safer to run this on a more common JDK, just in case.

(FWIW, the cljs community seems to have moved on to shadow-cljs. If you try it, I&apos;d be very curious to know if you see the same problem.)

If you get your minimal example working, I&apos;ll take another look</z><z id="t1678134879" t="Tom Fenton Hi [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] , As requested: 1. Removed Sente which clears up the code, but doesn&apos;t affect the observed behaviour 2. Changed :watch-dirs to prevent the figwheel-main classpath error 3. Corrected the readme 4. Corrected the Timbre/Sente errors which prevented the page from loading (serves me right for using an alpha version of Sente üôÇ ) but of course moot due to point 1 5. Tested in Oracle Java 1.8.0_361 I&apos;ll see if I can reproduce in Netty directly, maybe Jetty for good measure. I might also try shadow-cljs, though I&apos;m sure this would exhibit the same behaviour since even Windows reports the files are locked - see attached. This only happens when serving https, and only after the page is served for the first time. For personal use I&apos;ll stick with figwheel-main - it works and it makes sense to me, and as non-Node.js user, the cost/benefit of migrating doesn&apos;t add up."><y>#</y><d>2023-03-06</d><h>20:34</h><r>Tom Fenton</r>Hi <a>@U10EC98F5</a>,

As requested:
1. Removed Sente which clears up the code, but doesn&apos;t affect the observed behaviour
2. Changed :watch-dirs to prevent the figwheel-main classpath error
3. Corrected the readme
4. Corrected the Timbre/Sente errors which prevented the page from loading (serves me right for using an alpha version of Sente <b>üôÇ</b>) but of course moot due to point 1
5. Tested in Oracle Java 1.8.0_361
I&apos;ll see if I can reproduce in Netty directly, maybe Jetty for good measure. I might also try shadow-cljs, though I&apos;m sure this would exhibit the same behaviour since even Windows reports the files are locked - see attached. This only happens when serving https, and only after the page is served for the first time.

For personal use I&apos;ll stick with figwheel-main - it works and it makes sense to me, and as non-Node.js user, the cost/benefit of migrating doesn&apos;t add up.</z><z id="t1678169089" t="Matthew Davidson (kingmob) OK, I&apos;ll take a look when I can. Also, FWIW, shadow-cljs isn&apos;t specifically for node users. Plenty of cljs users use it for their front-end builds. Most, probably. It&apos;s big initial selling point was better npm compatibility, but not for backend node, iiuc."><y>#</y><d>2023-03-07</d><h>06:04</h><r>Matthew Davidson (kingmob)</r>OK, I&apos;ll take a look when I can.

Also, FWIW, shadow-cljs isn&apos;t specifically for node users. Plenty of cljs users use it for their front-end builds. Most, probably. It&apos;s big initial selling point was better npm compatibility, but not for backend node, iiuc.</z><z id="t1678775429" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAH1JFQV9&quot;}] Can you move this to a GH Issue? I don&apos;t want to forget about it"><y>#</y><d>2023-03-14</d><h>06:30</h><r>Matthew Davidson (kingmob)</r><a>@UAH1JFQV9</a> Can you move this to a GH Issue? I don&apos;t want to forget about it</z><z id="t1679381179" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAH1JFQV9&quot;}] Did you make a GH issue?"><y>#</y><d>2023-03-21</d><h>06:46</h><r>Matthew Davidson (kingmob)</r><a>@UAH1JFQV9</a> Did you make a GH issue?</z><z id="t1679307553" t="p-himik I&apos;m using Integrant and just noticed that something must&apos;ve happened between 0.5.0 and 0.6.0. The Integrant component that creates an instance of the server calls .close on the instance in ig/halt-key! . In 0.5.0 that was enough. In 0.6.0, it causes all new requests (despite the docstring mentioning only in-flight requests) that come in within 15 seconds after halting the component to still go through, only to fail down the line because the rest of the system the handler is using is already halted. Even if a new instance of the server is started within those 15 seconds, all new requests are still going to the old instance. Probably because it still listens to the port? (Not sure why the new instance doesn&apos;t fail then since the port is busy.) I assume it was caused by this item in the changelog: &quot;Add options to configure graceful shutdown timeout&quot;. But what then is the right workflow here? Perhaps there&apos;s a bug, given that a comment in the relevant changes says 1. Stop listening to incoming requests but I clearly observe that incoming requests are still being listened to."><y>#</y><d>2023-03-20</d><h>10:19</h><w>p-himik</w>I&apos;m using Integrant and just noticed that something must&apos;ve happened between 0.5.0 and 0.6.0.
The Integrant component that creates an instance of the server calls <code>.close</code> on the instance in <code>ig/halt-key!</code>.
In 0.5.0 that was enough.
In 0.6.0, it causes all new requests (despite the docstring mentioning only in-flight requests) that come in within 15 seconds after halting the component to still go through, only to fail down the line because the rest of the system the handler is using is already halted. Even if a new instance of the server is started within those 15 seconds, all new requests are still going to the old instance. Probably because it still listens to the port? (Not sure why the new instance doesn&apos;t fail then since the port is busy.)

I assume it was caused by this item in the changelog: &quot;Add options to configure graceful shutdown timeout&quot;.
But what then is the right workflow here? Perhaps there&apos;s a bug, given that a comment in the relevant changes says <code>1. Stop listening to incoming requests</code> but I clearly observe that incoming requests are still being listened to.</z><z id="t1679308053" t="p-himik Added a call to aleph.netty/wait-for-close to ig/halt-key! . Now halting the system takes 15 seconds, with all new incoming requests being handled, and with a subsequent timeout."><y>#</y><d>2023-03-20</d><h>10:27</h><r>p-himik</r>Added a call to <code>aleph.netty/wait-for-close</code> to <code>ig/halt-key!</code>. Now halting the system takes 15 seconds, with all new incoming requests being handled, and with a subsequent timeout.</z><z id="t1679309245" t="Arnaud Geiser Hello! It means you still have etablished connections. As soon as &apos;.close&apos; is called, the socket should not accept new connections. If you don&apos;t want to wait for those connections to be closed, you can pass &apos;shutdown-timeout: 0&apos;. That way, Aleph will be stopped right away."><y>#</y><d>2023-03-20</d><h>10:47</h><r>Arnaud Geiser</r>Hello!
It means you still have etablished connections. As soon as &apos;.close&apos; is called, the socket should not accept new connections.
If you don&apos;t want to wait for those connections to be closed, you can pass &apos;shutdown-timeout: 0&apos;. That way, Aleph will be stopped right away.</z><z id="t1679311661" t="p-himik I thought so too, but I got rid of my WS setup specifically to test that. So all I have is Sente trying to re-establish its connection by issuing new requests every second. This screenshot was obtained after I started halting the system and then refreshed the web page. As you can see, there are no pending requests. No other web page issues any requests to the server. The only thing that&apos;s going on is Sente issuing those requests."><y>#</y><d>2023-03-20</d><h>11:27</h><r>p-himik</r>I thought so too, but I got rid of my WS setup specifically to test that. So all I have is Sente trying to re-establish its connection by issuing new requests every second.

This screenshot was obtained after I started halting the system and then refreshed the web page.
As you can see, there are no pending requests. No other web page issues any requests to the server. The only thing that&apos;s going on is Sente issuing those requests.</z><z id="t1679311683" t="p-himik So it feels like Sente keeps the server alive by just poking at it, but don&apos;t know for sure."><y>#</y><d>2023-03-20</d><h>11:28</h><r>p-himik</r>So it feels like Sente keeps the server alive by just poking at it, but don&apos;t know for sure.</z><z id="t1679313165" t="p-himik Alright, it&apos;s not Sente - disabled it on the frontend and nothing has changed. However, pretty much all other requests have Connection: keep-alive . Could this be the culprit?"><y>#</y><d>2023-03-20</d><h>11:52</h><r>p-himik</r>Alright, it&apos;s not Sente - disabled it on the frontend and nothing has changed.
However, pretty much all other requests have <code>Connection: keep-alive</code>. Could this be the culprit?</z><z id="t1679328670" t="dergutemoritz Reading the above, I was gonna suggest keep-alive to be the culprit, too,"><y>#</y><d>2023-03-20</d><h>16:11</h><r>dergutemoritz</r>Reading the above, I was gonna suggest keep-alive to be the culprit, too,</z><z id="t1679328830" t="p-himik If that&apos;s indeed the case then I&apos;d argue it should be somehow handled on the Aleph side, simply because it seems that nowadays browsers use that header by default."><y>#</y><d>2023-03-20</d><h>16:13</h><r>p-himik</r>If that&apos;s indeed the case then I&apos;d argue it should be somehow handled on the Aleph side, simply because it seems that nowadays browsers use that header by default.</z><z id="t1679381046" t="Matthew Davidson (kingmob) That header is the default, yes, but it only has meaning for the old HTTP/1.0. From HTTP/1.1 on, it&apos;s just assumed to be always true, and browsers have to explicitly say to close the conn. Keep-alive code might be related, but that behavior&apos;s been there a long time, so we&apos;d have to see what, if anything, changed there between 0.5 and 0.6. Personally, I suspect the shutdown changes. [:attrs {:href &quot;/_/_/users/U2FRKM4TW&quot;}] Can you file an issue with a minimal example, and we&apos;ll take a closer look?"><y>#</y><d>2023-03-21</d><h>06:44</h><r>Matthew Davidson (kingmob)</r>That header is the default, yes, but it only has meaning for the old HTTP/1.0. From HTTP/1.1 on, it&apos;s just assumed to be always true, and browsers have to explicitly say to close the conn. Keep-alive code might be related, but that behavior&apos;s been there a long time, so we&apos;d have to see what, if anything, changed there between 0.5 and 0.6. Personally, I suspect the shutdown changes.

<a>@U2FRKM4TW</a> Can you file an issue with a minimal example, and we&apos;ll take a closer look?</z><z id="t1679384619" t="p-himik Ah, hmm, interesting. Yeah, will try to come up with a minimal example."><y>#</y><d>2023-03-21</d><h>07:43</h><r>p-himik</r>Ah, hmm, interesting.
Yeah, will try to come up with a minimal example.</z><z id="t1679464648" t="Arnaud Geiser The way we handle graceful shutdown definitely has an impact on the time it might take to shutdown a server (I would say that&apos;s on purpose but you might disagree) We wait for all active connections to be closed within 15 seconds through a Netty ChannelGroup (Ithose MIGHT include &apos;keep-alive&apos; connections, I would say yes but I&apos;m unsure, it can be tested easily thougj). If your (HTTP) clients are gentle enough, those connections will be closed as soon as not in use. If not, you will have to wait for those 15 (configurable) seconds. Now.. maybe we can do better. Any obvious way to do it? I don&apos;t know. We are pretty happy with the current solution. It can even speed up the integration tests by using a 0 shutdown-timeout."><y>#</y><d>2023-03-22</d><h>05:57</h><r>Arnaud Geiser</r>The way we handle graceful shutdown definitely has an impact on the time it might take to shutdown a server (I would say that&apos;s on purpose but you might disagree)
We wait for all active connections to be closed within 15 seconds through a Netty ChannelGroup (Ithose MIGHT include &apos;keep-alive&apos; connections, I would say yes but I&apos;m unsure, it can be tested easily thougj). If your (HTTP) clients are gentle enough, those connections will be closed as soon as not in use. If not, you will have to wait for those 15 (configurable) seconds.
Now.. maybe we can do better. Any obvious way to do it? I don&apos;t know. We are pretty happy with the current solution.
It can even speed up the integration tests by using a 0 shutdown-timeout.</z><z id="t1679464817" t="Arnaud Geiser A bit of reading to get the context : https://github.com/netty/netty/pull/3706#issuecomment-1303066857"><y>#</y><d>2023-03-22</d><h>06:00</h><r>Arnaud Geiser</r>A bit of reading to get the context : <a href="https://github.com/netty/netty/pull/3706#issuecomment-1303066857" target="_blank">https://github.com/netty/netty/pull/3706#issuecomment-1303066857</a></z><z id="t1679477626" t="p-himik To me it seems counter-intuitive that a connection that doesn&apos;t transmit any data and is only alive because of keep-alive is something that prevents server shutdown. At a higher level, a client still needs to initiate a new request - keep-alive is a low level thing, so from the perspective of the client it doesn&apos;t even care about it. But the server does care for some reason and then &quot;stop listening to new requests&quot; becomes &quot;keep on serving requests for 15 more seconds on top of the system that&apos;s been already shutdown&quot;. I have no idea whether detecting things like &quot;a connection was kept alive but is inactive&quot; is possible at all. But if it is, wouldn&apos;t it be a better approach, to close such inactive connections upon shutdown?"><y>#</y><d>2023-03-22</d><h>09:33</h><r>p-himik</r>To me it seems counter-intuitive that a connection that doesn&apos;t transmit any data and is only alive because of <code>keep-alive</code> is something that prevents server shutdown.
At a higher level, a client still needs to initiate a new request - <code>keep-alive</code> is a low level thing, so from the perspective of the client it doesn&apos;t even care about it.
But the server does care for some reason and then &quot;stop listening to new requests&quot; becomes &quot;keep on serving requests for 15 more seconds on top of the system that&apos;s been already shutdown&quot;.

I have no idea whether detecting things like &quot;a connection was kept alive but is inactive&quot; is possible at all. But if it is, wouldn&apos;t it be a better approach, to close such inactive connections upon shutdown?</z><z id="t1679480089" t="Arnaud Geiser I totally agree with your last statement. I don&apos;t know what is doable or not currently. The thing is... the previous Aleph behaviour was not waiting for ongoing requests, that&apos;s the case now, and probably what most of us would expect. I would definitely prefer not waiting for idle connections, but I don&apos;t know what it involves (yet?). I would say the &quot;workaround&quot; today is to configure an idle-timeout to close those connections and thus have a quick shutdown."><y>#</y><d>2023-03-22</d><h>10:14</h><r>Arnaud Geiser</r>I totally agree with your last statement. I don&apos;t know what is doable or not currently. The thing is... the previous Aleph behaviour was not waiting for ongoing requests, that&apos;s the case now, and probably what most of us would expect.
I would definitely prefer not waiting for idle connections, but I don&apos;t know what it involves (yet?).
I would say the &quot;workaround&quot; today is to configure an idle-timeout to close those connections and thus have a quick shutdown.</z><z id="t1679480326" t="p-himik Yeah, that&apos;s what I did. :)"><y>#</y><d>2023-03-22</d><h>10:18</h><r>p-himik</r>Yeah, that&apos;s what I did. :)</z><z id="t1680155257" t="Matthew Davidson (kingmob) What would #C0G922PCH like to see from HTTP/2? Improved performance? Want to prioritize different requests/streams/assets? Want flow control? Something else? I&apos;d like to hear any and all expectations and desires!"><y>#</y><d>2023-03-30</d><h>05:47</h><w>Matthew Davidson (kingmob)</w>What would #C0G922PCH like to see from HTTP/2? Improved performance? Want to prioritize different requests/streams/assets? Want flow control? Something else? I&apos;d like to hear any and all expectations and desires!</z><z id="t1680510505" t="Arnaud Geiser (From my point of view as an Aleph user) What I would expect from Aleph is the improved performance provided by HTTP/2 out-of-the-box while still being ring-compliant. I don&apos;t have any use cases where I would like to do streams prioritization. While we are stuck with HTTP/1.1 for compliance, an important feature Aleph provides is the raw-stream? parameter to perform asynchronous pipelines and avoid copying objects on the heap (DirectByteBuf). I would expect to sill have access to this when HTTP/2 will be supported. Either as stream of ByteBuf or Http2Frame ."><y>#</y><d>2023-04-03</d><h>08:28</h><r>Arnaud Geiser</r>(From my point of view as an Aleph user)
What I would expect from Aleph is the improved performance provided by HTTP/2 out-of-the-box while still being ring-compliant. I don&apos;t have any use cases where I would like to do streams prioritization.

While we are stuck with HTTP/1.1 for compliance, an important feature Aleph provides is the <code>raw-stream?</code> parameter to perform asynchronous pipelines and avoid copying objects on the heap (DirectByteBuf).
I would expect to sill have access to this when HTTP/2 will be supported. Either as stream of <code>ByteBuf</code> or <code>Http2Frame</code>.</z><z id="t1680674776" t="Matthew Davidson (kingmob)"><y>#</y><d>2023-04-05</d><h>06:06</h><w>Matthew Davidson (kingmob)</w></z><z id="t1680680998" t="Matthew Davidson (kingmob)"><y>#</y><d>2023-04-05</d><h>07:49</h><w>Matthew Davidson (kingmob)</w></z><z id="t1680998882" t="oskarkv Is there a way to set TCP_NODELAY with Aleph? I have not found it."><y>#</y><d>2023-04-09</d><h>00:08</h><w>oskarkv</w>Is there a way to set TCP_NODELAY with Aleph? I have not found it.</z><z id="t1681094999" t="Matthew Davidson (kingmob) It&apos;s not directly exposed, but for setting options like that, you&apos;ll want to pass a bootstrap-transform fn. It&apos;s called last on the Netty Bootstrap object, so it can adjust the Bootstrap to whatever you want. E.g., you&apos;d pass in: :bootstrap-transform (fn [^Bootstrap b] (.option b ChannelOption/TCP_NODELAY true)) That being said, it looks like TCP_NODELAY is true by default in Netty code, for everything except Android."><y>#</y><d>2023-04-10</d><h>02:49</h><w>Matthew Davidson (kingmob)</w>It&apos;s not directly exposed, but for setting options like that, you&apos;ll want to pass a <code>bootstrap-transform</code> fn. It&apos;s called last on the Netty Bootstrap object, so it can adjust the Bootstrap to whatever you want.

E.g., you&apos;d pass in:
<pre>:bootstrap-transform (fn [^Bootstrap b] (.option b ChannelOption/TCP_NODELAY true))</pre>
That being said, it looks like TCP_NODELAY is true by default in Netty code, for everything except Android.</z><z id="t1681095092" t="oskarkv Thanks!"><y>#</y><d>2023-04-10</d><h>02:51</h><r>oskarkv</r>Thanks!</z><z id="t1681095005" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U4DNSU5NE&quot;}] ^^^"><y>#</y><d>2023-04-10</d><h>02:50</h><w>Matthew Davidson (kingmob)</w><a>@oskarkv</a> ^^^</z><z id="t1681385939" t="valerauko Question: on an older version of aleph, when using the ring multipart-params middleware, if the user POSTs an empty file the request body becomes nil and that causes an exception in multipart-params (or to be precise the apache commons-io library it uses). Does this still repro with latest aleph? If so maybe using a nullInputStream for body if it&apos;s empty might be a good idea?"><y>#</y><d>2023-04-13</d><h>11:38</h><w>valerauko</w>Question: on an older version of aleph, when using the ring multipart-params middleware, if the user POSTs an empty file the request body becomes nil and that causes an exception in multipart-params (or to be precise the apache commons-io library it uses).

Does this still repro with latest aleph? If so maybe using a nullInputStream for body if it&apos;s empty might be a good idea?</z><z id="t1681398132" t="Matthew Davidson (kingmob) Haven&apos;t checked lately, but I haven&apos;t personally done anything with related code that I can recall. Arnaud or Moritz would know; they&apos;ve both done some multipart work in the last year. Ironically, we have the opposite problem on the client. The client is meant to mimic clj-http&apos;s behavior, and there, clj-http returns nil while we return an empty InputStream."><y>#</y><d>2023-04-13</d><h>15:02</h><r>Matthew Davidson (kingmob)</r>Haven&apos;t checked lately, but I haven&apos;t personally done anything with related code that I can recall. Arnaud or Moritz would know; they&apos;ve both done some multipart work in the last year.

Ironically, we have the opposite problem on the client. The client is meant to mimic clj-http&apos;s behavior, and there, clj-http returns nil while we return an empty InputStream.</z><z id="t1681672313" t="Arnaud Geiser Sorry for the delay. &gt; Does this still repro with latest aleph? Yes, we have done nothing regarding this behavior. So I don&apos;t expect any changes there. But we improved the way multipart are handled inside Aleph, so maybe &quot;decode-request&quot; can be used for your needs now [1]. You should be able to support files through &quot;Manual cleanup&quot;. &gt; If so maybe using a nullInputStream for body if it&apos;s empty might be a good idea? Can you provide us some code so I can have a look? [1] : https://cljdoc.org/d/aleph/aleph/0.6.1/doc/http/handling-multipart-requests"><y>#</y><d>2023-04-16</d><h>19:11</h><r>Arnaud Geiser</r>Sorry for the delay.

&gt; Does this still repro with latest aleph?
Yes, we have done nothing regarding this behavior. So I don&apos;t expect any changes there.
But we improved the way multipart are handled inside Aleph, so maybe &quot;decode-request&quot; can be used for your needs now [1].
You should be able to support files through &quot;Manual cleanup&quot;.

&gt;  If so maybe using a nullInputStream for body if it&apos;s empty might be a good idea?
Can you provide us some code so I can have a look?

[1] : <a href="https://cljdoc.org/d/aleph/aleph/0.6.1/doc/http/handling-multipart-requests" target="_blank">https://cljdoc.org/d/aleph/aleph/0.6.1/doc/http/handling-multipart-requests</a></z><z id="t1682659416" t="Matthew Davidson (kingmob) Quick question for everyone: Are you directly using anything from undocumented namespaces? I.e., aleph.http.* (but not aleph.http proper). &gt; üí• We are using undocumented namespace code. &gt; ‚úÖ We are not using undocumented namespaces. React with the relevant emoji."><y>#</y><d>2023-04-28</d><h>05:23</h><w>Matthew Davidson (kingmob)</w>Quick question for everyone:

Are you directly using anything from undocumented namespaces? I.e., <code>aleph.http.*</code> (but not <code>aleph.http</code> proper).
&gt; <b>üí•</b> We are using undocumented namespace code.
&gt; <b>‚úÖ</b> We are not using undocumented namespaces.
React with the relevant emoji.</z><z id="t1682661902" t="mccraigmccraig minimal üí• - just one use of aleph.http.client-middleware/success?"><y>#</y><d>2023-04-28</d><h>06:05</h><r>mccraigmccraig</r>minimal <b>üí•</b> - just one use of <code>aleph.http.client-middleware/success?</code></z><z id="t1682666337" t="Matthew Davidson (kingmob) Ahh, ok. Thx for letting us know"><y>#</y><d>2023-04-28</d><h>07:18</h><r>Matthew Davidson (kingmob)</r>Ahh, ok. Thx for letting us know</z><z id="t1683124481" t="Loic Hi everybody, I am using Aleph for my app and I am currently trying to add a middleware verify my ssl certificates. As for now, I handle the SSL in an ALB in front of the EC2 so the ALB handles the redirect from http to https. However, since I only have one EC2 instance, the ALB is quite overkill and I want my app to handle the ssl directly. I am often very confused when it comes to SSL. I see in the Aleph doc, we can provide a :ssl-context . There seem to be a wrapper also aleph.ssl/wrap-aleph-ssl. How can I add my certificates to the config so Netty can create the context used by Aleph? Also, do I need both server context and client context?"><y>#</y><d>2023-05-03</d><h>14:34</h><w>Loic</w>Hi everybody,

I am using Aleph for my app and I am currently trying to add a middleware verify my ssl certificates.
As for now, I handle the SSL in an ALB in front of the EC2 so the ALB handles the redirect from http to https.
However, since I only have one EC2 instance, the ALB is quite overkill and I want my app to handle the ssl directly.

I am often very confused when it comes to SSL. I see in the Aleph doc, we can provide a <code>:ssl-context</code>.
There seem to be a wrapper also <code>aleph.ssl/wrap-aleph-ssl.</code>

How can I add my certificates to the config so Netty can create the context used by Aleph?
Also, do I need both server context and client context?</z><z id="t1683126089" t="Arnaud Geiser Hello Loic! I never used aleph.ssl/wrap-aleph-ssl so I cannot really say. But here you will find an example about how both a server and a client can be created. [1] For the server, you just need to pass a ssl-context when starting it as an option. For the client, you need to create and configure a connection-pool that need to be passed as a pool parameter when calling your http/request (get, post ...) functions. [1] : https://github.com/clj-commons/aleph/blob/8efad423c4df7b1a7b82a245045d1a21b4b0fc3d/test/aleph/http_test.clj#L271-L285"><y>#</y><d>2023-05-03</d><h>15:01</h><r>Arnaud Geiser</r>Hello Loic!

I never used <code>aleph.ssl/wrap-aleph-ssl</code> so I cannot really say.
But here you will find an example about how both a server and a client can be created. [1]

For the server, you just need to pass a <code>ssl-context</code>
when starting it as an option.
For the client, you need to create and configure a <code>connection-pool</code> that need to be passed as a <code>pool</code> parameter when calling your <code>http/request</code>  (get, post ...) functions.

[1] : <a href="https://github.com/clj-commons/aleph/blob/8efad423c4df7b1a7b82a245045d1a21b4b0fc3d/test/aleph/http_test.clj#L271-L285" target="_blank">https://github.com/clj-commons/aleph/blob/8efad423c4df7b1a7b82a245045d1a21b4b0fc3d/test/aleph/http_test.clj#L271-L285</a></z><z id="t1683126334" t="Arnaud Geiser Here you can find some examples about how to create the various SSL contexts : https://github.com/clj-commons/aleph/blob/8efad423c4df7b1a7b82a245045d1a21b4b0fc3d/test/aleph/ssl.clj#L46-L63"><y>#</y><d>2023-05-03</d><h>15:05</h><r>Arnaud Geiser</r>Here you can find some examples about how to create the various SSL contexts : <a href="https://github.com/clj-commons/aleph/blob/8efad423c4df7b1a7b82a245045d1a21b4b0fc3d/test/aleph/ssl.clj#L46-L63" target="_blank">https://github.com/clj-commons/aleph/blob/8efad423c4df7b1a7b82a245045d1a21b4b0fc3d/test/aleph/ssl.clj#L46-L63</a></z><z id="t1683171472" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U03J66D1GG6&quot;}] Where did you find wrap-aleph-ssl ? That&apos;s not in the Aleph code base. The only aleph.ssl namespace is for testing, and I don&apos;t see it there, either"><y>#</y><d>2023-05-04</d><h>03:37</h><r>Matthew Davidson (kingmob)</r><a>@U03J66D1GG6</a> Where did you find <code>wrap-aleph-ssl</code>? That&apos;s not in the Aleph code base. The only <code>aleph.ssl</code> namespace is for testing, and I don&apos;t see it there, either</z><z id="t1683171565" t="Loic [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Was some code suggested by chatGPT, no idea where it got that info"><y>#</y><d>2023-05-04</d><h>03:39</h><r>Loic</r><a>@U10EC98F5</a> Was some code suggested by chatGPT, no idea where it got that info</z><z id="t1683171586" t="Loic [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] Thank you! I will try that"><y>#</y><d>2023-05-04</d><h>03:39</h><r>Loic</r><a>@UFKCFTVB8</a> Thank you! I will try that</z><z id="t1683172468" t="Matthew Davidson (kingmob) Heh. Please watch out for GPT hallucinations. "><y>#</y><d>2023-05-04</d><h>03:54</h><r>Matthew Davidson (kingmob)</r>Heh. Please watch out for GPT hallucinations. </z><z id="t1683271400" t="Matthew Davidson (kingmob) Another quick question: Are you using multipart bodies on either the client or server side (e.g., using :parts to upload multiple files at once)? &gt; ‚úÖ We ARE using multipart &gt; ‚ùå We ARE NOT using multipart React with the relevant emoji"><y>#</y><d>2023-05-05</d><h>07:23</h><w>Matthew Davidson (kingmob)</w>Another quick question:

Are you using multipart bodies on either the client or server side (e.g., using <code>:parts</code> to upload multiple files at once)?
&gt; <b>‚úÖ</b>  We ARE using multipart
&gt; <b>‚ùå</b>  We ARE NOT using multipart
React with the relevant emoji</z><z id="t1683271586" t="Matthew Davidson (kingmob) (If you&apos;re unsure, the answer is probably no)"><y>#</y><d>2023-05-05</d><h>07:26</h><r>Matthew Davidson (kingmob)</r>(If you&apos;re unsure, the answer is probably no)</z><z id="t1683457251" t="valerauko heavy use of multipart upload handling on the server side (image processing, csv batch processing). using the ring middleware though, not the multipart features of aleph"><y>#</y><d>2023-05-07</d><h>11:00</h><r>valerauko</r>heavy use of multipart upload handling on the server side (image processing, csv batch processing). using the ring middleware though, not the multipart features of aleph</z><z id="t1683457477" t="valerauko it&apos;d be great if we could handle with &quot;just&quot; aleph since having to pull in the entire ring-core package with all its massive dependencies is making me a sad panda üêº"><y>#</y><d>2023-05-07</d><h>11:04</h><r>valerauko</r>it&apos;d be great if we could handle with &quot;just&quot; aleph since having to pull in the entire ring-core package with all its massive dependencies is making me a sad panda <b>üêº</b></z><z id="t1683540087" t="Matthew Davidson (kingmob) Hmmm. Unfortunately, Netty (which Aleph is built on), doesn&apos;t have any support for multipart in their HTTP2 code. It&apos;s not forbidden in HTTP2, but it also makes less sense, since you can just open up as many HTTP2 streams as you need to upload each file separately. We&apos;ve directly supported multipart, but if we need to persist to disk, it was always a little awkward trying to craft a default retention policy and get the user to remember to handle it. Given all of this, middleware might be preferable, even if not Ring&apos;s. The alternatives are: 1. Throw an exception if using HTTP2 and multipart (nobody wants this, and it&apos;s not feasible on server side because you&apos;ve already negotiated the protocol before you&apos;ve seen the body) 2. Automatically downgrade to HTTP1 on client when multipart detected in Ring request (probably surprising and unwanted) 3. Insert the conversion codec to use HTTP1 objects in the Netty pipeline so existing multipart code works (slower, more garbage generated) 4. Same as above, but only insert the codec dynamically when multipart is detected (won&apos;t pay the price all the time, but requires detection code, buffering buffers, and the ability to lie about/switch the protocol used to manipulate which fns are being called) 5. Use Ring multipart middleware (would have to see how the Ring middleware will interact) 6. Import some non-Netty multipart lib for our own middleware/code, since netty really doesn&apos;t make it easy to use independently of the http1 code (another dep) 7. ...?"><y>#</y><d>2023-05-08</d><h>10:01</h><r>Matthew Davidson (kingmob)</r>Hmmm. Unfortunately, Netty (which Aleph is built on), doesn&apos;t have any support for multipart in their HTTP2 code. It&apos;s not forbidden in HTTP2, but it also makes less sense, since you can just open up as many HTTP2 streams as you need to upload each file separately.

We&apos;ve directly supported multipart, but if we need to persist to disk, it was always a little awkward trying to craft a default retention policy and get the user to remember to handle it. Given all of this, middleware might be preferable, even if not Ring&apos;s.

The alternatives are:
1. Throw an exception if using HTTP2 and multipart (nobody wants this, and it&apos;s not feasible on server side because you&apos;ve already negotiated the protocol before you&apos;ve seen the body)
2. Automatically downgrade to HTTP1 on client when multipart detected in Ring request (probably surprising and unwanted)
3. Insert the conversion codec to use HTTP1 objects in the Netty pipeline so existing multipart code works (slower, more garbage generated)
4. Same as above, but only insert the codec dynamically when multipart is detected (won&apos;t pay the price all the time, but requires detection code, buffering buffers, and the ability to lie about/switch the protocol used to manipulate which fns are being called)
5. Use Ring multipart middleware (would have to see how the Ring middleware will interact)
6. Import some non-Netty multipart lib for our own middleware/code, since netty really doesn&apos;t make it easy to use independently of the http1 code (another dep)
7. ...?</z><z id="t1683551052" t="valerauko oh is this limited to http2?"><y>#</y><d>2023-05-08</d><h>13:04</h><r>valerauko</r>oh is this limited to http2?</z><z id="t1683618559" t="Matthew Davidson (kingmob) Well, my question was about multipart in general, but we&apos;re trying to decide what to do with it for the new HTTP/2 code."><y>#</y><d>2023-05-09</d><h>07:49</h><r>Matthew Davidson (kingmob)</r>Well, my question was about multipart in general, but we&apos;re trying to decide what to do with it for the new HTTP/2 code.</z><z id="t1683683128" t="valerauko from the server developer&apos;s perspective how would it look like if aleph received a http/2 request equivalent to a multipart = multiple streams?"><y>#</y><d>2023-05-10</d><h>01:45</h><r>valerauko</r>from the server developer&apos;s perspective how would it look like if aleph received a http/2 request equivalent to a multipart = multiple streams?</z><z id="t1683697019" t="Matthew Davidson (kingmob) You mean, could we create multiple streams on the server, one per part, and call the user&apos;s handler for each one? Hmmm. That will be more work than supporting multipart in a single handler, I think. If the files are always processed independently, it wouldn&apos;t be so bad. But if you&apos;re relying on them all existing at once, or need to know some are ready before processing others, concurrent handlers will make coordination harder. Plus, we&apos;d need to pick a response format (single response, streaming array of individual responses, etc) and an error-handling policy, and whatever we choose might not work for all situations. Some of the headers would be incorrect and require adjustment for each part (content types, lengths, etc). We could give a new &quot;multipart-handler&quot; just the files, no headers, but sometimes people will still need headers. At best, I think we&apos;d support the same interface as the current decode-reqeust ; a stream of the files in order as they&apos;re decoded. If users can process them in parallel, they can do that manually."><y>#</y><d>2023-05-10</d><h>05:36</h><r>Matthew Davidson (kingmob)</r>You mean, could we create multiple streams on the server, one per part, and call the user&apos;s handler for each one?

Hmmm. That will be more work than supporting multipart in a single handler, I think. If the files are always processed independently, it wouldn&apos;t be so bad. But if you&apos;re relying on them all existing at once, or need to know some are ready before processing others, concurrent handlers will make coordination harder. Plus, we&apos;d need to pick a response format (single response, streaming array of individual responses, etc) and an error-handling policy, and whatever we choose might not work for all situations.

Some of the headers would be incorrect and require adjustment for each part (content types, lengths, etc). We could give a new &quot;multipart-handler&quot; just the files, no headers, but sometimes people will still need headers.

At best, I think we&apos;d support the same interface as the current <code>decode-reqeust</code>; a stream of the files in order as they&apos;re decoded. If users can process them in parallel, they can do that manually.</z><z id="t1684503633" t="Matthew Davidson (kingmob) Essentially went with #3 above. We fall back to using the old HTTP1 code for multipart "><y>#</y><d>2023-05-19</d><h>13:40</h><r>Matthew Davidson (kingmob)</r>Essentially went with #3 above. We fall back to using the old HTTP1 code for multipart </z><z id="t1683473930" t="p-himik Trying to migrate from Yada+Bidi to Ring+naked Aleph+Reitit. Hitting an issue with form parameters. The Aleph&apos;s README states: &gt; Aleph follows the Ring spec fully, and can be a drop-in replacement for any existing Ring-compliant server. And maybe I&apos;m doing something wrong but so far it doesn&apos;t seem to be the case when ring.middleware.params/wrap_params is used. üßµ"><y>#</y><d>2023-05-07</d><h>15:38</h><w>p-himik</w>Trying to migrate from Yada+Bidi to Ring+naked Aleph+Reitit.
Hitting an issue with form parameters.
The Aleph&apos;s README states:
&gt;  Aleph follows the Ring spec fully, and can be a drop-in replacement for any existing Ring-compliant server.
And maybe I&apos;m doing something wrong but so far it doesn&apos;t seem to be the case when <code>ring.middleware.params/wrap_params</code> is used. <b>üßµ</b></z><z id="t1683473933" t="p-himik Getting this exception: java.lang.IllegalArgumentException: Cannot open &lt;&lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 87, :permanent? false, :type &quot;netty&quot;, :sink? true, :closed? true, :pending-takes 0, :buffer-capacity 16384, :connection {:local-address &quot;/127.0.0.1:8000&quot;, :remote-address &quot;/127.0.0.1:44438&quot;, :writable? true, :readable? true, :closed? false, :direction :inbound}, :source? true} &gt;&gt;&gt; as an InputStream. at $fn__11595.invokeStatic(io.clj:167) at $fn__11595.invoke(io.clj:167) at $fn__11569$G__11523__11576.invoke(io.clj:69) at $fn__11591.invokeStatic(io.clj:165) at $fn__11591.invoke(io.clj:165) at $fn__11530$G__11519__11537.invoke(io.clj:69) at $reader.invokeStatic(io.clj:102) at $reader.doInvoke(io.clj:86) at clojure.lang.RestFn.applyTo(RestFn.java:139) at clojure.core$apply.invokeStatic(core.clj:669) at clojure.core$slurp.invokeStatic(core.clj:7009) at clojure.core$slurp.doInvoke(core.clj:7009) at clojure.lang.RestFn.invoke(RestFn.java:439) at ring.middleware.params$assoc_form_params.invokeStatic(params.clj:33) at ring.middleware.params$assoc_form_params.invoke(params.clj:27) at ring.middleware.params$params_request.invokeStatic(params.clj:51) at ring.middleware.params$params_request.invoke(params.clj:39) at ring.middleware.params$wrap_params$fn__37411.invoke(params.clj:75) at reitit.ring$ring_handler$fn__63815.invoke(ring.cljc:328) at clojure.lang.AFn.applyToHelper(AFn.java:154) at clojure.lang.AFn.applyTo(AFn.java:144) at clojure.lang.AFunction$1.doInvoke(AFunction.java:31) at clojure.lang.RestFn.invoke(RestFn.java:408) at aleph.http.server$handle_request$fn__44146$f__29594__auto____44147.invoke(server.clj:177) at clojure.lang.AFn.run(AFn.java:22) at io.aleph.dirigiste.Executor$Worker$1.run(Executor.java:62) at manifold.executor$thread_factory$reify__29472$f__29473.invoke(executor.clj:70) at clojure.lang.AFn.run(AFn.java:22) at java.base/java.lang.Thread.run(Thread.java:833) "><y>#</y><d>2023-05-07</d><h>15:38</h><r>p-himik</r>Getting this exception:
<pre>java.lang.IllegalArgumentException: Cannot open &lt;&lt;&lt; stream: {:pending-puts 0, :drained? false, :buffer-size 87, :permanent? false, :type &quot;netty&quot;, :sink? true, :closed? true, :pending-takes 0, :buffer-capacity 16384, :connection {:local-address &quot;/127.0.0.1:8000&quot;, :remote-address &quot;/127.0.0.1:44438&quot;, :writable? true, :readable? true, :closed? false, :direction :inbound}, :source? true} &gt;&gt;&gt; as an InputStream.
	at $fn__11595.invokeStatic(io.clj:167)
	at $fn__11595.invoke(io.clj:167)
	at $fn__11569$G__11523__11576.invoke(io.clj:69)
	at $fn__11591.invokeStatic(io.clj:165)
	at $fn__11591.invoke(io.clj:165)
	at $fn__11530$G__11519__11537.invoke(io.clj:69)
	at $reader.invokeStatic(io.clj:102)
	at $reader.doInvoke(io.clj:86)
	at clojure.lang.RestFn.applyTo(RestFn.java:139)
	at clojure.core$apply.invokeStatic(core.clj:669)
	at clojure.core$slurp.invokeStatic(core.clj:7009)
	at clojure.core$slurp.doInvoke(core.clj:7009)
	at clojure.lang.RestFn.invoke(RestFn.java:439)
	at ring.middleware.params$assoc_form_params.invokeStatic(params.clj:33)
	at ring.middleware.params$assoc_form_params.invoke(params.clj:27)
	at ring.middleware.params$params_request.invokeStatic(params.clj:51)
	at ring.middleware.params$params_request.invoke(params.clj:39)
	at ring.middleware.params$wrap_params$fn__37411.invoke(params.clj:75)
	at reitit.ring$ring_handler$fn__63815.invoke(ring.cljc:328)
	at clojure.lang.AFn.applyToHelper(AFn.java:154)
	at clojure.lang.AFn.applyTo(AFn.java:144)
	at clojure.lang.AFunction$1.doInvoke(AFunction.java:31)
	at clojure.lang.RestFn.invoke(RestFn.java:408)
	at aleph.http.server$handle_request$fn__44146$f__29594__auto____44147.invoke(server.clj:177)
	at clojure.lang.AFn.run(AFn.java:22)
	at io.aleph.dirigiste.Executor$Worker$1.run(Executor.java:62)
	at manifold.executor$thread_factory$reify__29472$f__29473.invoke(executor.clj:70)
	at clojure.lang.AFn.run(AFn.java:22)
	at java.base/java.lang.Thread.run(Thread.java:833)</pre>
</z><z id="t1683473952" t="p-himik The relevant part of the middleware: (defn assoc-form-params &quot;Parse and assoc parameters from the request body with the request.&quot; {:added &quot;1.2&quot;} [request encoding] (let [params (if-let [body (and (req/urlencoded-form? request) (:body request))] (parse-params (slurp body :encoding encoding) encoding) {})] (-&gt; request (assoc-param-map :form-params params) (assoc-param-map :params params))))"><y>#</y><d>2023-05-07</d><h>15:39</h><r>p-himik</r>The relevant part of the middleware:
<pre>(defn assoc-form-params
  &quot;Parse and assoc parameters from the request body with the request.&quot;
  {:added &quot;1.2&quot;}
  [request encoding]
  (let [params (if-let [body (and (req/urlencoded-form? request)
                                  (:body request))]
                 (parse-params (slurp body :encoding encoding) encoding)
                 {})]
    (-&gt; request
        (assoc-param-map :form-params params)
        (assoc-param-map :params params))))</pre></z><z id="t1683473980" t="p-himik As you can see, it tries to slurp the body to parse the params. But the body is (I think) a Manifold stream and slurp doesn&apos;t know how to read it."><y>#</y><d>2023-05-07</d><h>15:39</h><r>p-himik</r>As you can see, it tries to slurp the body to parse the params. But the body is (I think) a Manifold stream and <code>slurp</code> doesn&apos;t know how to read it.</z><z id="t1683484624" t="p-himik So far, worked around it by adding this middleware: (defn convert-x-www-form-urlencoded-body-to-input-stream [handler] (letfn [(convert [req] (cond-&gt; req (= &quot;application/x-www-form-urlencoded&quot; (req/content-type req)) (update :body (fn [body] (if (stream/stream? body) (bs/to-input-stream (stream/map bs/to-byte-array (bs/to-byte-buffers body))) body)))))] (fn ([request] (handler (convert request))) ([request respond raise] (handler (convert request) respond raise)))))"><y>#</y><d>2023-05-07</d><h>18:37</h><r>p-himik</r>So far, worked around it by adding this middleware:
<pre>(defn convert-x-www-form-urlencoded-body-to-input-stream [handler]
  (letfn [(convert [req]
            (cond-&gt; req
              (= &quot;application/x-www-form-urlencoded&quot; (req/content-type req))
              (update :body (fn [body]
                              (if (stream/stream? body)
                                (bs/to-input-stream
                                  (stream/map bs/to-byte-array (bs/to-byte-buffers body)))
                                body)))))]
    (fn
      ([request]
       (handler (convert request)))
      ([request respond raise]
       (handler (convert request) respond raise)))))</pre></z><z id="t1683488295" t="jeroenvandijk Not sure but maybe this is related to the :raw-stream? setting? https://github.com/juxt/yada/blob/master/README.md#troubleshooting-faq to be set to true and maybe this is causing a stream instead of an inputstream"><y>#</y><d>2023-05-07</d><h>19:38</h><r>jeroenvandijk</r>Not sure but maybe this is related to the <code>:raw-stream?</code> setting? <a href="https://github.com/juxt/yada/blob/master/README.md#troubleshooting-faq" target="_blank">https://github.com/juxt/yada/blob/master/README.md#troubleshooting-faq</a> to be set to <code>true</code> and maybe this is causing a stream instead of an inputstream</z><z id="t1683488389" t="p-himik Oh, good catch. Let me check..."><y>#</y><d>2023-05-07</d><h>19:39</h><r>p-himik</r>Oh, good catch. Let me check...</z><z id="t1683489098" t="p-himik That seems to be it! Thanks!"><y>#</y><d>2023-05-07</d><h>19:51</h><r>p-himik</r>That seems to be it! Thanks!</z><z id="t1683537637" t="Matthew Davidson (kingmob) The one major place where Aleph differs from Ring is in supporting Manifold streams for the body. If you get a Manifold stream and want something else, check out the clj-commons.byte-streams functions. They&apos;re used by Aleph, and designed to transform Manifold streams into things like strings, byte arrays, InputStreams, etc"><y>#</y><d>2023-05-08</d><h>09:20</h><r>Matthew Davidson (kingmob)</r>The one major place where Aleph differs from Ring is in supporting Manifold streams for the body.

If you get a Manifold stream and want something else, check out the <code>clj-commons.byte-streams</code> functions. They&apos;re used by Aleph, and designed to transform Manifold streams into things like strings, byte arrays, InputStreams, etc</z><z id="t1683538282" t="p-himik Thanks! Yeah, that&apos;s what I did in that middleware above. No clue whether it was the best way to do it since I just coped the Yada code almost directly. But doesn&apos;t matter as now I have simply removed the :raw-stream? parameter."><y>#</y><d>2023-05-08</d><h>09:31</h><r>p-himik</r>Thanks! Yeah, that&apos;s what I did in that middleware above. No clue whether it was the best way to do it since I just coped the Yada code almost directly. But doesn&apos;t matter as now I have simply removed the <code>:raw-stream?</code> parameter.</z><z id="t1683540731" t="Matthew Davidson (kingmob) For future reference, byte-streams maintains a conversion graph, and can work out intermediate transformations, so it should suffice to just specify the desired end result, i.e., to-input-stream . In this case, there&apos;s no intermediate transformations needed. See line 354 of the main byte-streams file: def-conversion ^{:cost 0} [(stream-of ByteBuffer) InputStream]"><y>#</y><d>2023-05-08</d><h>10:12</h><r>Matthew Davidson (kingmob)</r>For future reference, byte-streams maintains a conversion graph, and can work out intermediate transformations, so it should suffice to just specify the desired end result, i.e., <code>to-input-stream</code> . In this case, there&apos;s no intermediate transformations needed. See line 354 of the main byte-streams file: <code>def-conversion ^{:cost 0} [(stream-of ByteBuffer) InputStream]</code></z><z id="t1684828360" t="Matthew Davidson (kingmob) Minor release 0.6.2 is available. Deps have been bumped up, some internal stuff has been cleaned up. Only notable addition is the wrap-validation middleware. It&apos;s not too stringent yet, because we don&apos;t want to break existing code. https://clojars.org/aleph/versions/0.6.2"><y>#</y><d>2023-05-23</d><h>07:52</h><w>Matthew Davidson (kingmob)</w>Minor release 0.6.2 is available. Deps have been bumped up, some internal stuff has been cleaned up. Only notable addition is the <code>wrap-validation</code> middleware. It&apos;s not too stringent yet, because we don&apos;t want to break existing code.

<a href="https://clojars.org/aleph/versions/0.6.2" target="_blank">https://clojars.org/aleph/versions/0.6.2</a></z><z id="t1684908601" t="Matthew Davidson (kingmob) Another survey question: Are you using Aleph&apos;s proxying and/or the CONNECT method to establish tunnels to servers? &gt; ‚úÖ We ARE using proxying and/or CONNECT &gt; ‚ùå We ARE NOT using proxying and/or CONNECT React with the relevant emoji"><y>#</y><d>2023-05-24</d><h>06:10</h><w>Matthew Davidson (kingmob)</w>Another survey question:

Are you using Aleph&apos;s proxying and/or the CONNECT method to establish tunnels to servers?
&gt; <b>‚úÖ</b>  We ARE using proxying and/or CONNECT
&gt; <b>‚ùå</b> We ARE NOT using proxying and/or CONNECT
React with the relevant emoji</z><z id="t1685278471" t="p-himik What would be the right way to configure request logging?"><y>#</y><d>2023-05-28</d><h>12:54</h><w>p-himik</w>What would be the right way to configure request logging?</z><z id="t1685280479" t="p-himik Tried adding a LoggingHandler with .addLast to the pipeline with :pipeline-transform . That results in very verbose logging for websocket packets, but for regular HTTP all I get is READ COMPLETE ."><y>#</y><d>2023-05-28</d><h>13:27</h><r>p-himik</r>Tried adding a <code>LoggingHandler</code> with <code>.addLast</code> to the pipeline with <code>:pipeline-transform</code>.
That results in very verbose logging for websocket packets, but for regular HTTP all I get is <code>READ COMPLETE</code>.</z><z id="t1685282231" t="p-himik Hmm, I&apos;m probably better off using something like https://github.com/nberger/ring-logger ."><y>#</y><d>2023-05-28</d><h>13:57</h><r>p-himik</r>Hmm, I&apos;m probably better off using something like <a href="https://github.com/nberger/ring-logger" target="_blank">https://github.com/nberger/ring-logger</a>.</z><z id="t1685344257" t="Matthew Davidson (kingmob) So, there&apos;s a little-known option called log-activity that takes care of that for you, fwiw. If you give it a log level keyword (like :debug or :error ), it will make a LoggingHandler for you, but you can also set it to a LoggingHandler if you like. I&apos;m a little surprised you only see &quot;READ COMPLETE&quot; with it, though; I tried it, and it&apos;s also printing out hex dumps of the data for me. It should look like something like this: 36206 DEBUG aleph-client - [id: 0x6be1c991, L:/192.168.56.196:63538 - R:] READ: 30B +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f | +--------+-------------------------------------------------+----------------+ |00000000| 17 03 03 00 19 00 00 00 00 00 00 00 02 25 f1 db |.............%..| |00000010| fd aa ea 7a 58 91 85 b4 8b 34 33 f9 7b c5 |...zX....43.{. | +--------+-------------------------------------------------+----------------+ 36209 DEBUG aleph-client - [id: 0x6be1c991, L:/192.168.56.196:63538 - R:] READ COMPLETE "><y>#</y><d>2023-05-29</d><h>07:10</h><r>Matthew Davidson (kingmob)</r>So, there&apos;s a little-known option called <code>log-activity</code> that takes care of that for you, fwiw. If you give it a log level keyword (like <code>:debug</code> or <code>:error</code>), it will make a LoggingHandler for you, but you can also set it to a LoggingHandler if you like.

I&apos;m a little surprised you only see &quot;READ COMPLETE&quot; with it, though; I tried it, and it&apos;s also printing out hex dumps of the data for me. It should look like something like this:

<pre>36206 DEBUG aleph-client - [id: 0x6be1c991, L:/192.168.56.196:63538 - R:] READ: 30B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 17 03 03 00 19 00 00 00 00 00 00 00 02 25 f1 db |.............%..|
|00000010| fd aa ea 7a 58 91 85 b4 8b 34 33 f9 7b c5       |...zX....43.{.  |
+--------+-------------------------------------------------+----------------+
36209 DEBUG aleph-client - [id: 0x6be1c991, L:/192.168.56.196:63538 - R:] READ COMPLETE</pre>
</z><z id="t1685345354" t="p-himik I couldn&apos;t find how to use :log-activity on the server side - I see its usages only on the client side of Aleph. The difference in logging data is probably due to where that logging happens. Mine logger was the very last one in the pipeline - perhaps, for HTTP something else short-circuits earlier, if that&apos;s even possible."><y>#</y><d>2023-05-29</d><h>07:29</h><r>p-himik</r>I couldn&apos;t find how to use <code>:log-activity</code> on the server side - I see its usages only on the client side of Aleph.
The difference in logging data is probably due to where that logging happens. Mine logger was the very last one in the pipeline - perhaps, for HTTP something else short-circuits earlier, if that&apos;s even possible.</z><z id="t1685345558" t="Matthew Davidson (kingmob) Ahh, server side? You&apos;ll probably want to log it yourself at the start of your handler. There&apos;s not going be a good way to get a ring map passing anywhere in the netty pipeline"><y>#</y><d>2023-05-29</d><h>07:32</h><r>Matthew Davidson (kingmob)</r>Ahh, server side? You&apos;ll probably want to log it yourself at the start of your handler. There&apos;s not going be a good way to get a ring map passing anywhere in the netty pipeline</z><z id="t1685345734" t="Matthew Davidson (kingmob) No reason it couldn&apos;t happen theoretically, with conversion handlers before/after the user&apos;s handler, but Aleph wasn&apos;t set up that way. The Ring request effectively isn&apos;t made until right before passing it to the user&apos;s handler"><y>#</y><d>2023-05-29</d><h>07:35</h><r>Matthew Davidson (kingmob)</r>No reason it couldn&apos;t happen theoretically, with conversion handlers before/after the user&apos;s handler, but Aleph wasn&apos;t set up that way. The Ring request effectively isn&apos;t made until right before passing it to the user&apos;s handler</z><z id="t1685345840" t="Matthew Davidson (kingmob) If it was client-side, I was also going to mention the default wrap-request-debug middleware. (though it doesn&apos;t seem to be working for me atm)"><y>#</y><d>2023-05-29</d><h>07:37</h><r>Matthew Davidson (kingmob)</r>If it was client-side, I was also going to mention the default <code>wrap-request-debug</code> middleware. (though it doesn&apos;t seem to be working for me atm)</z><z id="t1685346134" t="Matthew Davidson (kingmob) Basically, user handlers are wrapped a bunch, not deposited &quot;raw&quot; into the netty pipeline."><y>#</y><d>2023-05-29</d><h>07:42</h><r>Matthew Davidson (kingmob)</r>Basically, user handlers are wrapped a bunch, not deposited &quot;raw&quot; into the netty pipeline.</z><z id="t1685347022" t="p-himik Yeah, makes sense. Thanks!"><y>#</y><d>2023-05-29</d><h>07:57</h><r>p-himik</r>Yeah, makes sense. Thanks!</z><z id="t1685413766" t="valerauko I usually have a logging middleware like this (ns app.wrappers.logging (:require [clojure.tools.logging :as log])) (defn wrap-logging [handler] (fn logging-wrapper [{:keys [request-method uri remote-addr] {fwd-for &quot;x-forwarded-for&quot;} :headers :as request}] (let [start (System/nanoTime) response (handler request)] (log/info (format &quot;Completed %d %s %s in %.3fms for %s&quot; (get response :status 200) (-&gt; request-method (name) (.toUpperCase)) uri (/ (- (System/nanoTime) start) 1000000.0) (or fwd-for remote-addr))) response))) https://github.com/valerauko/kitsune/blob/main/api/src/kitsune/wrappers/logging.clj"><y>#</y><d>2023-05-30</d><h>02:29</h><r>valerauko</r>I usually have a logging middleware like this
<pre>(ns app.wrappers.logging
  (:require [clojure.tools.logging :as log]))

(defn wrap-logging
  [handler]
  (fn logging-wrapper
    [{:keys [request-method uri remote-addr]
      {fwd-for &quot;x-forwarded-for&quot;} :headers
      :as request}]
    (let [start (System/nanoTime)
          response (handler request)]
      (log/info (format &quot;Completed %d %s %s in %.3fms for %s&quot;
                        (get response :status 200)
                        (-&gt; request-method (name) (.toUpperCase))
                        uri
                        (/ (- (System/nanoTime) start) 1000000.0)
                        (or fwd-for remote-addr)))
      response)))</pre>
<a href="https://github.com/valerauko/kitsune/blob/main/api/src/kitsune/wrappers/logging.clj" target="_blank">https://github.com/valerauko/kitsune/blob/main/api/src/kitsune/wrappers/logging.clj</a></z><z id="t1685416110" t="p-himik I used ring-logger , fits my needs perfectly, at least so far."><y>#</y><d>2023-05-30</d><h>03:08</h><r>p-himik</r>I used <code>ring-logger</code>, fits my needs perfectly, at least so far.</z><z id="t1685446715" t="Matthew Davidson (kingmob) +1 for mulog"><y>#</y><d>2023-05-30</d><h>11:38</h><r>Matthew Davidson (kingmob)</r>+1 for mulog</z><z id="t1685706615" t="iku000888 Just surfacing this here as well. Sorry for the attention. https://clojurians.slack.com/archives/C0G922PCH/p1685705600897399?thread_ts=1671653633.113409&amp;amp;cid=C0G922PCH"><y>#</y><d>2023-06-02</d><h>11:50</h><w>iku000888</w>Just surfacing this here as well. Sorry for the attention.
<a href="https://clojurians.slack.com/archives/C0G922PCH/p1685705600897399?thread_ts=1671653633.113409&amp;amp;cid=C0G922PCH" target="_blank">https://clojurians.slack.com/archives/C0G922PCH/p1685705600897399?thread_ts=1671653633.113409&amp;amp;cid=C0G922PCH</a></z><z id="t1685706665" t="Arnaud Geiser Hello, which version of byte-streams are you using? The clj-commons one or not?"><y>#</y><d>2023-06-02</d><h>11:51</h><r>Arnaud Geiser</r>Hello, which version of byte-streams are you using?
The clj-commons one or not?</z><z id="t1685706735" t="Arnaud Geiser (I got the answer from the logs, sorry) You basically need to use clj-commons.byte_streams instead of byte_streams directly. This has been fixed on the latest version of byte-streams if I remember correctly though."><y>#</y><d>2023-06-02</d><h>11:52</h><r>Arnaud Geiser</r>(I got the answer from the logs, sorry)
You basically need to use clj-commons.byte_streams instead of  byte_streams directly.
This has been fixed on the latest version of byte-streams if I remember correctly though.</z><z id="t1685706739" t="iku000888 I specified this being advised from the comments in the thread [org.clj-commons/byte-streams &quot;0.3.2&quot;]"><y>#</y><d>2023-06-02</d><h>11:52</h><r>iku000888</r>I specified this being advised from the comments in the thread
<pre>[org.clj-commons/byte-streams &quot;0.3.2&quot;]</pre></z><z id="t1685706783" t="Arnaud Geiser That&apos;s correct, but do you have require on your project that requires &quot;byte-streams&quot; instead of &quot;clj-commons.byte-streams&quot; ?"><y>#</y><d>2023-06-02</d><h>11:53</h><r>Arnaud Geiser</r>That&apos;s correct, but do you have require on your project that requires &quot;byte-streams&quot; instead of &quot;clj-commons.byte-streams&quot; ?</z><z id="t1685706841" t="iku000888 let me double check... :face_with_monocle:"><y>#</y><d>2023-06-02</d><h>11:54</h><r>iku000888</r>let me double check... <b>:face_with_monocle:</b></z><z id="t1685706904" t="iku000888 ah ok facepalm [org.clj-commons/byte-streams &quot;0.3.2&quot;] [byte-streams &quot;0.2.4-alpha4&quot; :exclusions [[org.clojure/clojure]]]"><y>#</y><d>2023-06-02</d><h>11:55</h><r>iku000888</r>ah ok <b>facepalm</b>
<pre>[org.clj-commons/byte-streams &quot;0.3.2&quot;]
     [byte-streams &quot;0.2.4-alpha4&quot; :exclusions [[org.clojure/clojure]]]</pre></z><z id="t1685706925" t="iku000888 So I think I can specify exclusion on the by-streams one"><y>#</y><d>2023-06-02</d><h>11:55</h><r>iku000888</r>So I think I can specify exclusion on the by-streams one</z><z id="t1685706962" t="iku000888 which was directly specified by yada"><y>#</y><d>2023-06-02</d><h>11:56</h><r>iku000888</r>which was directly specified by yada</z><z id="t1685707005" t="Arnaud Geiser Mmmmhh.. which version of Aleph are you using?"><y>#</y><d>2023-06-02</d><h>11:56</h><r>Arnaud Geiser</r>Mmmmhh.. which version of Aleph are you using?</z><z id="t1685707049" t="iku000888 [yada &quot;1.2.15&quot;] ;; [aleph &quot;0.6.2&quot;] [manifold &quot;0.4.1&quot;] These were the relavant deps I think"><y>#</y><d>2023-06-02</d><h>11:57</h><r>iku000888</r><pre>[yada &quot;1.2.15&quot;]

                 ;; 
                 [aleph &quot;0.6.2&quot;]
               
                 [manifold &quot;0.4.1&quot;]</pre>
These were the relavant deps I think</z><z id="t1685707101" t="iku000888 Did get it working with this üéâ [yada &quot;1.2.15&quot; :exclusions [[byte-streams]]] "><y>#</y><d>2023-06-02</d><h>11:58</h><r>iku000888</r>Did get it working with this <b>üéâ</b>
<pre>[yada &quot;1.2.15&quot; :exclusions [[byte-streams]]] </pre></z><z id="t1685707114" t="iku000888 Thank you for the guidance!"><y>#</y><d>2023-06-02</d><h>11:58</h><r>iku000888</r>Thank you for the guidance!</z><z id="t1685707115" t="Arnaud Geiser Ouf üòÑ"><y>#</y><d>2023-06-02</d><h>11:58</h><r>Arnaud Geiser</r>Ouf <b>üòÑ</b></z><z id="t1685707127" t="Arnaud Geiser Your welcome, have a nice week-end"><y>#</y><d>2023-06-02</d><h>11:58</h><r>Arnaud Geiser</r>Your welcome, have a nice week-end</z><z id="t1685707166" t="iku000888 You too!"><y>#</y><d>2023-06-02</d><h>11:59</h><r>iku000888</r>You too!</z><z id="t1686139503" t="Alex Sky ~Hi, is there aleph ready to implement metrics monitoring? jmx, prometheus etc~ ~I don‚Äôt see them in the quick view, but maybe I missed something.~ ok I‚Äôve got it."><y>#</y><d>2023-06-07</d><h>12:05</h><w>Alex Sky</w>~Hi, is there aleph ready to implement metrics monitoring? jmx, prometheus  etc~
~I don‚Äôt see them in the quick view, but maybe I missed something.~
ok I‚Äôve got it.</z><z id="t1686205781" t="Matthew Davidson (kingmob) The Dirigiste conn pools and executors have some metrics available to look at, if you haven&apos;t already found them."><y>#</y><d>2023-06-08</d><h>06:29</h><r>Matthew Davidson (kingmob)</r>The Dirigiste conn pools and executors have some metrics available to look at, if you haven&apos;t already found them.</z><z id="t1686206768" t="Alex Sky yes, thank you In my case, it was faster to look at the source code than to find the documentation:grin:"><y>#</y><d>2023-06-08</d><h>06:46</h><r>Alex Sky</r>yes, thank you
In my case, it was faster to look at the source code than to find the documentation:grin:</z><z id="t1686215812" t="Matthew Davidson (kingmob) Heh. Yeah, Dirigiste isn&apos;t really documented. Personally, I wouldn&apos;t mind replacing it, but it&apos;s not high-priority enough"><y>#</y><d>2023-06-08</d><h>09:16</h><r>Matthew Davidson (kingmob)</r>Heh. Yeah, Dirigiste isn&apos;t really documented. Personally, I wouldn&apos;t mind replacing it, but it&apos;s not high-priority enough</z><z id="t1686322495" t="Alex Sky well-written code is sometimes even more pleasant to read than documentation üòâ üòä"><y>#</y><d>2023-06-09</d><h>14:54</h><r>Alex Sky</r>well-written code is sometimes even more pleasant to read than documentation <b>üòâ</b> <b>üòä</b></z><z id="t1687251569" t="Matthew Davidson (kingmob) Wrote up some random tidbits on the upcoming HTTP/2 client development process: https://modulolotus.net/posts/2023-06-20-aleph-http2-changes/ . It&apos;s under PR review now, we&apos;ll cut an alpha release soon for people to play with. Server-side HTTP/2&apos;s up next."><y>#</y><d>2023-06-20</d><h>08:59</h><w>Matthew Davidson (kingmob)</w>Wrote up some random tidbits on the upcoming HTTP/2 client development process: <a href="https://modulolotus.net/posts/2023-06-20-aleph-http2-changes/" target="_blank">https://modulolotus.net/posts/2023-06-20-aleph-http2-changes/</a>.

It&apos;s under PR review now, we&apos;ll cut an alpha release soon for people to play with. Server-side HTTP/2&apos;s up next.</z><z id="t1688122627" t="Matthew Davidson (kingmob) Announcing Aleph 0.7.0-alpha1! This is a preview of the HTTP/2 code we&apos;ve been adding. For 0.7.0-alpha1, it&apos;s client-only, not server. Please give it a try. For the most part, the changes will be invisible (as long you weren&apos;t using undocumented functions). Two new options are available for connection-pool : 1. http-versions - a vector of preferred versions you&apos;ll support, defaults to [:http2 :http1] . If you want to force HTTP/1-only, you&apos;d create a custom pool like: (connection-pool {:connection-options {:http-versions [:http1]}}) . NB: servers may ignore your preferred protocol order and choose any allowed version. 2. force-h2c? - by default, you can&apos;t do insecure HTTP/2, but the spec allows it if you know in advance a server supports it. And by server, that means your server that you control, probably in a private intranet. Setting this to true will use non-TLS, cleartext HTTP/2. https://clojars.org/aleph/versions/0.7.0-alpha1"><y>#</y><d>2023-06-30</d><h>10:57</h><w>Matthew Davidson (kingmob)</w>Announcing Aleph 0.7.0-alpha1! This is a preview of the HTTP/2 code we&apos;ve been adding. For 0.7.0-alpha1, it&apos;s client-only, not server. Please give it a try.

For the most part, the changes will be invisible (as long you weren&apos;t using undocumented functions). Two new options are available for <code>connection-pool</code>:
1. <code>http-versions</code> - a vector of preferred versions you&apos;ll support, defaults to <code>[:http2 :http1]</code>. If you want to force HTTP/1-only, you&apos;d create a custom pool like: <code>(connection-pool {:connection-options {:http-versions [:http1]}})</code> . NB: servers may ignore your preferred protocol order and choose any allowed version. 
2. <code>force-h2c?</code> - by default, you can&apos;t do insecure HTTP/2, but the spec allows it if you know in advance a server supports it. And by server, that means your server that you control, probably in a private intranet. Setting this to <code>true</code> will use non-TLS, cleartext HTTP/2.
<a href="https://clojars.org/aleph/versions/0.7.0-alpha1" target="_blank">https://clojars.org/aleph/versions/0.7.0-alpha1</a></z><z id="t1688122673" t="Arnaud Geiser Great achievement! Nice job!"><y>#</y><d>2023-06-30</d><h>10:57</h><r>Arnaud Geiser</r>Great achievement! Nice job!</z><z id="t1688122693" t="Matthew Davidson (kingmob) Incoming bug reports in 3...2....1"><y>#</y><d>2023-06-30</d><h>10:58</h><r>Matthew Davidson (kingmob)</r>Incoming bug reports in 3...2....1</z><z id="t1688122676" t="Matthew Davidson (kingmob) Many thanks to Arnaud for his review help!"><y>#</y><d>2023-06-30</d><h>10:57</h><w>Matthew Davidson (kingmob)</w>Many thanks to Arnaud for his review help!</z><z id="t1688130592" t="valerauko Hey, is there a way in an aleph (clojure-side) handler to extract something from the Netty context? I have to deal with a library that sets an attribute on the ctx channel and I&apos;d like to access this attribute from my clojure-side handler. Is there a way to achieve this?"><y>#</y><d>2023-06-30</d><h>13:09</h><w>valerauko</w>Hey, is there a way in an aleph (clojure-side) handler to extract something from the Netty context? I have to deal with a library that sets an attribute on the ctx channel and I&apos;d like to access this attribute from my clojure-side handler. Is there a way to achieve this?</z><z id="t1688130972" t="Arnaud Geiser On top of my head, Aleph is not giving you a way to access the ChannelHandlerContext to get an attribute. Maybe Matthew has a workaround though."><y>#</y><d>2023-06-30</d><h>13:16</h><w>Arnaud Geiser</w>On top of my head, Aleph is not giving you a way to access the ChannelHandlerContext to get an attribute. Maybe Matthew has a workaround though.</z><z id="t1688149577" t="Arnaud Geiser My workaround would be to monkey-patch the following function that would give you access to the channel on your handler, and thus the attributes. https://github.com/clj-commons/aleph/blob/master/src/aleph/http/core.clj#L242"><y>#</y><d>2023-06-30</d><h>18:26</h><w>Arnaud Geiser</w>My workaround would be to monkey-patch the following function that would give you access to the channel on your handler, and thus the attributes. <a href="https://github.com/clj-commons/aleph/blob/master/src/aleph/http/core.clj#L242" target="_blank">https://github.com/clj-commons/aleph/blob/master/src/aleph/http/core.clj#L242</a></z><z id="t1688149666" t="Arnaud Geiser But maybe there is something I overcome that is a little bit less hacky..."><y>#</y><d>2023-06-30</d><h>18:27</h><w>Arnaud Geiser</w>But maybe there is something I overcome that is a little bit less hacky...</z><z id="t1688149693" t="Matthew Davidson (kingmob) I have a solution, but it&apos;s equally hacky... üòõ"><y>#</y><d>2023-06-30</d><h>18:28</h><w>Matthew Davidson (kingmob)</w>I have a solution, but it&apos;s equally hacky... <b>üòõ</b></z><z id="t1688149713" t="Arnaud Geiser Ah! Awesome!"><y>#</y><d>2023-06-30</d><h>18:28</h><w>Arnaud Geiser</w>Ah! Awesome!</z><z id="t1688150284" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Aleph&apos;s not really designed for this, but I can think of a hack if you really need it. It will only work with requests, not responses, though, so it won&apos;t work on the client-side. So, the incoming Ring request your handler gets isn&apos;t a plain Clojure map. It&apos;s actually a type defined by potemkin&apos;s def-derived-map, which eventually bottoms out in deftype. (It has a few cool features, like being able to define key lookups on mutable data, like a blend of deftype and defrecord, and making map values effectively lazy. But for the most part, I&apos;m not sure it still makes sense over a plain defrecord) def-derived-maps present to the user as a regular map with a set of keys, but under the hood, the values are computed on the deftype fields, one of which is...you guessed it, ch , a Channel. So in your handler, you could use the field access syntax to read the ch field, like: (fn my-hander [req] (do-something (.-ch req)))"><y>#</y><d>2023-06-30</d><h>18:38</h><w>Matthew Davidson (kingmob)</w><a>@vale</a> Aleph&apos;s not really designed for this, but I can think of a hack if you really need it. It will only work with requests, not responses, though, so it won&apos;t work on the client-side.

So, the incoming Ring request your handler gets isn&apos;t a plain Clojure map. It&apos;s actually a type defined by potemkin&apos;s def-derived-map, which eventually bottoms out in deftype. (It has a few cool features, like being able to define key lookups on mutable data, like a blend of deftype and defrecord, and making map values effectively lazy. But for the most part, I&apos;m not sure it still makes sense over a plain defrecord)

def-derived-maps present to the user as a regular map with a set of keys, but under the hood, the values are computed on the deftype fields, one of which is...you guessed it, <code>ch</code>, a Channel. So in your handler, you could use the field access syntax to read the <code>ch</code> field, like:

<pre>(fn my-hander [req]
  (do-something (.-ch req)))</pre></z><z id="t1688171757" t="valerauko Very interesting! I was aware of the def-derived-map sorcery (iirc the main point of it is that it&apos;s close to zero-copy so it doesn&apos;t allocate all the request&apos;s values again), but I had no idea you could access &quot;hidden&quot; fields like that... I&apos;ll have to look at the implementation again. I&apos;ll give this a try!"><y>#</y><d>2023-07-01</d><h>00:35</h><r>valerauko</r>Very interesting! I was aware of the def-derived-map sorcery (iirc the main point of it is that it&apos;s close to zero-copy so it doesn&apos;t allocate all the request&apos;s values again), but I had no idea you could access &quot;hidden&quot; fields like that... I&apos;ll have to look at the implementation again.

I&apos;ll give this a try!</z><z id="t1688195965" t="valerauko It works like a charm, thanks!"><y>#</y><d>2023-07-01</d><h>07:19</h><r>valerauko</r>It works like a charm, thanks!</z><z id="t1688196525" t="Matthew Davidson (kingmob) Glad to hear it! Yeah, zero-copy is the biggest benefit. However, the potemkin code was written at the dawn of Clojure; comparing it with modern map/defrecord performance has been on my to-do list for a while. It might not still be worth it, especially for smaller types like NettyResponse, which only has 6 keys."><y>#</y><d>2023-07-01</d><h>07:28</h><r>Matthew Davidson (kingmob)</r>Glad to hear it!

Yeah, zero-copy is the biggest benefit. However, the potemkin code was written at the dawn of Clojure; comparing it with modern map/defrecord performance has been on my to-do list for a while. It might not still be worth it, especially for smaller types like NettyResponse, which only has 6 keys.</z><z id="t1688197149" t="valerauko I&apos;m afraid it really doesn&apos;t... It&apos;s especially apparent when you frequently pass it through functions that desructure arguments. I think the reason is that its get first looks at the extra keys, then does a set contains? and only then the case-based (theoretically super-fast) lookup. I suspect it could be improved hugely if it first used case then checked the less-common added## etc patterns (untested of course)"><y>#</y><d>2023-07-01</d><h>07:39</h><r>valerauko</r>I&apos;m afraid it really doesn&apos;t... It&apos;s especially apparent when you frequently pass it through functions that desructure arguments.

I think the reason is that its <code>get</code> first looks at the extra keys, then does a set contains? and only then the case-based (theoretically super-fast) lookup. I suspect it could be improved hugely if it first used <code>case</code> then checked the less-common added## etc patterns (untested of course)</z><z id="t1688197567" t="valerauko When I was using derived maps in a project, I monkey-patched its get to (~&apos;get [this## key# default-value#] (case key# ~@(interleave (keys m) (map (fn [m] `(~(symbol (str &quot;.&quot; m)) this##)) methods)) (get added## key# default-value#))) Not sure how equivalent or not"><y>#</y><d>2023-07-01</d><h>07:46</h><r>valerauko</r>When I was using derived maps in a project, I monkey-patched its get to
<pre>(~&apos;get [this## key# default-value#]
             (case key#
               ~@(interleave
                   (keys m)
                   (map (fn [m] `(~(symbol (str &quot;.&quot; m)) this##)) methods))
               (get added## key# default-value#)))</pre>
Not sure how equivalent or not</z><z id="t1688198322" t="Matthew Davidson (kingmob) Yeah, the only problem with that is it breaks the map illusion, because then you can&apos;t override existing keys."><y>#</y><d>2023-07-01</d><h>07:58</h><r>Matthew Davidson (kingmob)</r>Yeah, the only problem with that is it breaks the map illusion, because then you can&apos;t override existing keys.</z><z id="t1688198753" t="valerauko Doesn&apos;t assoc create a whole new instance though with the key replaced?"><y>#</y><d>2023-07-01</d><h>08:05</h><r>valerauko</r>Doesn&apos;t assoc create a whole new instance though with the key replaced?</z><z id="t1688198825" t="Matthew Davidson (kingmob) That&apos;s true for Clojure maps, but there&apos;s no way to &quot;replace&quot; the value when it&apos;s a function lookup defined in an interface"><y>#</y><d>2023-07-01</d><h>08:07</h><r>Matthew Davidson (kingmob)</r>That&apos;s true for Clojure maps, but there&apos;s no way to &quot;replace&quot; the value when it&apos;s a function lookup defined in an interface</z><z id="t1688198859" t="Matthew Davidson (kingmob) Unless we create a new derived map interface on the fly"><y>#</y><d>2023-07-01</d><h>08:07</h><r>Matthew Davidson (kingmob)</r>Unless we create a new derived map interface on the fly</z><z id="t1688198911" t="Matthew Davidson (kingmob) It&apos;s kinda hacky, but we could make a separate derived-map version that&apos;s returned only on assoc/dissocing"><y>#</y><d>2023-07-01</d><h>08:08</h><r>Matthew Davidson (kingmob)</r>It&apos;s kinda hacky, but we could make a separate derived-map version that&apos;s returned only on assoc/dissocing</z><z id="t1688198938" t="Matthew Davidson (kingmob) That way, if you never change keys, you get the fast path, but if you do, you have to get the slow path"><y>#</y><d>2023-07-01</d><h>08:08</h><r>Matthew Davidson (kingmob)</r>That way, if you never change keys, you get the fast path, but if you do, you have to get the slow path</z><z id="t1688199261" t="valerauko Ugh... In a ring context associng into the request map is super common so it gets quite complicated"><y>#</y><d>2023-07-01</d><h>08:14</h><r>valerauko</r>Ugh... In a ring context associng into the request map is super common so it gets quite complicated</z><z id="t1688199393" t="Matthew Davidson (kingmob) Yeah. Middleware would quickly thrash it all. It&apos;s a shame all the fundamental map things are interfaces, not protocols, or there&apos;d be a lot more innovative map usage"><y>#</y><d>2023-07-01</d><h>08:16</h><r>Matthew Davidson (kingmob)</r>Yeah. Middleware would quickly thrash it all. It&apos;s a shame all the fundamental map things are interfaces, not protocols, or there&apos;d be a lot more innovative map usage</z><z id="t1688199556" t="Matthew Davidson (kingmob) Anyway, I&apos;ll get around to comparing it one day. Of course, I also need to check and make sure nothing will break if we switch from laziness to eagerness..."><y>#</y><d>2023-07-01</d><h>08:19</h><r>Matthew Davidson (kingmob)</r>Anyway, I&apos;ll get around to comparing it one day. Of course, I also need to check and make sure nothing will break if we switch from laziness to eagerness...</z><z id="t1688150492" t="Matthew Davidson (kingmob) I&apos;ve been thinking about exposing more of the Netty machinery for users, as well as for debugging. The catch, of course, is relying on something that used to be just an implementation detail. Can I ask what library you&apos;re using that&apos;s attaching data to the context and/or channel?"><y>#</y><d>2023-06-30</d><h>18:41</h><w>Matthew Davidson (kingmob)</w>I&apos;ve been thinking about exposing more of the Netty machinery for users, as well as for debugging. The catch, of course, is relying on something that used to be just an implementation detail.

Can I ask what library you&apos;re using that&apos;s attaching data to the context and/or channel?</z><z id="t1688172871" t="valerauko It&apos;s the Datadog tracer. Since it has to trace across threads in Netty the only way for it to pass along its own &quot;span&quot; is by putting it in the ChannelHandlerContext. I then need this span in the Clojure-side code to associate the Netty trace with the Clojure-side execution"><y>#</y><d>2023-07-01</d><h>00:54</h><r>valerauko</r>It&apos;s the Datadog tracer. Since it has to trace across threads in Netty the only way for it to pass along its own &quot;span&quot; is by putting it in the ChannelHandlerContext. I then need this span in the Clojure-side code to associate the Netty trace with the Clojure-side execution</z><z id="t1688196890" t="Matthew Davidson (kingmob) That makes sense. My initial thought is to stick them in keys like :aleph/ch or :aleph/ctx , but I&apos;d have to consider the ramifications. E.g., in http2, multiplexed channels only live as long as the request/response pair, so if you save a channel for later, it probably won&apos;t exist. Other alternatives are to expose a few fns in aleph.netty that handlers can call, or consider multi-arity handlers that get the ch/ctx as extra params."><y>#</y><d>2023-07-01</d><h>07:34</h><r>Matthew Davidson (kingmob)</r>That makes sense. My initial thought is to stick them in keys like <code>:aleph/ch</code> or <code>:aleph/ctx</code>, but I&apos;d have to consider the ramifications. E.g., in http2, multiplexed channels only live as long as the request/response pair, so if you save a channel for later, it probably won&apos;t exist.

Other alternatives are to expose a few fns in <code>aleph.netty</code> that handlers can call, or consider multi-arity handlers that get the ch/ctx as extra params.</z><z id="t1688197127" t="Matthew Davidson (kingmob) If your company needs something less hacky, I have availability üòâ"><y>#</y><d>2023-07-01</d><h>07:38</h><r>Matthew Davidson (kingmob)</r>If your company needs something less hacky, I have availability <b>üòâ</b></z><z id="t1688367965" t="Matthew Davidson (kingmob) Hmmm, I must have been tired when I wrote this. Chans would still exist, but I&apos;m not sure about holding a reference to them. Maybe the only consequence is holding onto memory. I was originally thinking of something like weak references, but perhaps it&apos;d be okay to keep them around. It&apos;s more an issue for the client side, where HTTP2 chans may be closed by the time the resp map is returned. On the server-side, the chan will exist until your response is finished, so that&apos;s a non-issue."><y>#</y><d>2023-07-03</d><h>07:06</h><r>Matthew Davidson (kingmob)</r>Hmmm, I must have been tired when I wrote this. Chans would still exist, but I&apos;m not sure about holding a reference to them. Maybe the only consequence is holding onto memory. I was originally thinking of something like weak references, but perhaps it&apos;d be okay to keep them around.

It&apos;s more an issue for the client side, where HTTP2 chans may be closed by the time the resp map is returned. On the server-side, the chan will exist until your response is finished, so that&apos;s a non-issue.</z><z id="t1688888857" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] To follow up on this, I assume you&apos;re placing DD spans in the Netty Channels using .attr() ? Regardless, I suspect the new HTTP/2 multiplex channels may cause problems with this. The child Channels won&apos;t be long-lived, they&apos;ll get created/destroyed for each new incoming request. And afaict, they don&apos;t inherit attr data from the parent Channel"><y>#</y><d>2023-07-09</d><h>07:47</h><r>Matthew Davidson (kingmob)</r><a>@vale</a> To follow up on this, I assume you&apos;re placing DD spans in the Netty Channels using <code>.attr()</code>?

Regardless, I suspect the new HTTP/2 multiplex channels may cause problems with this. The child Channels won&apos;t be long-lived, they&apos;ll get created/destroyed for each new incoming request. And afaict, they don&apos;t inherit attr data from the parent Channel</z><z id="t1688889778" t="valerauko It&apos;s not me -- that&apos;s how the DD agent automatically instruments Netty. When I inspected the pipeline to figure out what the DD agent does to it, I found one of these https://github.com/DataDog/dd-trace-java/blob/ad43b975bb23041d4cc66cd3e608b2060d8a6345/dd-java-agent/instrumentation/netty-4.1/src/main/java/datadog/trace/instrumentation/netty41/server/HttpServerTracingHandler.java s there. To link my application-thread workload together with the Netty request trace I then extract the DDSpan from the ChannelContext and activate it in my application thread (the rest is agent magic I think). It&apos;s pretty hacky and uses undocumented stuff, but I&apos;m in touch with their tech support to figure out how it&apos;s supposed to be done."><y>#</y><d>2023-07-09</d><h>08:02</h><r>valerauko</r>It&apos;s not me -- that&apos;s how the DD agent automatically instruments Netty. When I inspected the pipeline to figure out what the DD agent does to it, I found one of these <a href="https://github.com/DataDog/dd-trace-java/blob/ad43b975bb23041d4cc66cd3e608b2060d8a6345/dd-java-agent/instrumentation/netty-4.1/src/main/java/datadog/trace/instrumentation/netty41/server/HttpServerTracingHandler.java" target="_blank">https://github.com/DataDog/dd-trace-java/blob/ad43b975bb23041d4cc66cd3e608b2060d8a6345/dd-java-agent/instrumentation/netty-4.1/src/main/java/datadog/trace/instrumentation/netty41/server/HttpServerTracingHandler.java</a>s there.

To link my application-thread workload together with the Netty request trace I then extract the DDSpan from the ChannelContext and activate it in my application thread (the rest is agent magic I think).

It&apos;s pretty hacky and uses undocumented stuff, but I&apos;m in touch with their tech support to figure out how it&apos;s supposed to be done.</z><z id="t1688889947" t="valerauko If they tell me &quot;just don&apos;t&quot;, then I&apos;ll disable automatic Netty server instrumentation and manually produce the trace from the ring request/response, or mimic what they do and build my own tracing handler. The latter has the advantage that I can put it at the head of the pipeline so it can include stuff like the time it takes for Netty (aleph?) to handle an incoming upload for example before it&apos;s passed to the ring handler."><y>#</y><d>2023-07-09</d><h>08:05</h><r>valerauko</r>If they tell me &quot;just don&apos;t&quot;, then I&apos;ll disable automatic Netty server instrumentation and manually produce the trace from the ring request/response, or mimic what they do and build my own tracing handler. The latter has the advantage that I can put it at the head of the pipeline so it can include stuff like the time it takes for Netty (aleph?) to handle an incoming upload for example before it&apos;s passed to the ring handler.</z><z id="t1688349553" t="valerauko [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] where protocols takes the alias p should i change it all to proto (eg match the aliases to byte_streams.clj)?"><y>#</y><d>2023-07-03</d><h>01:59</h><w>valerauko</w><a>@kingmob</a> where protocols takes the alias p should i change it all to proto (eg match the aliases to byte_streams.clj)?</z><z id="t1688355724" t="Matthew Davidson (kingmob) Sure that works"><y>#</y><d>2023-07-03</d><h>03:42</h><w>Matthew Davidson (kingmob)</w>Sure that works</z><z id="t1688355877" t="valerauko aight i&apos;ll do that later today"><y>#</y><d>2023-07-03</d><h>03:44</h><w>valerauko</w>aight i&apos;ll do that later today</z><z id="t1688715374" t="Matthew Davidson (kingmob) https://github.com/clj-commons/byte-streams 0.3.3 is now available. It incorporates the work of [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] and [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] . Many thanks! Fixes include eliminating a lot of boxed math, the temp removal of a couple type hints that AOT has weird issues with, and better kondo support. https://clojars.org/org.clj-commons/byte-streams/versions/0.3.3"><y>#</y><d>2023-07-07</d><h>07:36</h><w>Matthew Davidson (kingmob)</w><a href="https://github.com/clj-commons/byte-streams" target="_blank">https://github.com/clj-commons/byte-streams</a> 0.3.3 is now available. It incorporates the work of <a>@vale</a> and <a>@dergutemoritz</a>. Many thanks!

Fixes include eliminating a lot of boxed math, the temp removal of a couple type hints that AOT has weird issues with, and better kondo support.

<a href="https://clojars.org/org.clj-commons/byte-streams/versions/0.3.3" target="_blank">https://clojars.org/org.clj-commons/byte-streams/versions/0.3.3</a></z><z id="t1688824268" t="Jan Hi guys, I am trying out Aleph with Reitit and Ring and I am running into a problem where my code would just hang up - don&apos;t know if this is the correct channel to ask for help, but maybe one of you guys has an idea. I have (ns app.core (:require [aleph.http :as http] [reitit.ring :as ring] [ring.middleware.params :as params] [ring.middleware.json :refer [wrap-json-response]] [ring.util.response :refer [response]])) (defn return-path-params-handler [req] (wrap-json-response (response (:path-params req)))) (def handler (params/wrap-params (ring/ring-handler (ring/router [[&quot;/print/:something&quot; return-path-params-handler]]) (ring/create-default-handler)))) (comment (def http-server (http/start-server #&apos;handler {:port 8080})) ,) When I do a request to I would expect the response to be { &quot;something&quot;: &quot;some&quot; } But I don&apos;t get a response, it just hangs up and also will not timeout. What am I missing here?"><y>#</y><d>2023-07-08</d><h>13:51</h><w>Jan</w>Hi guys, I am trying out Aleph with Reitit and Ring and I am running into a problem where my code would just hang up - don&apos;t know if this is the correct channel to ask for help, but maybe one of you guys has an idea. I have
<pre>(ns app.core
  (:require [aleph.http :as http]
            [reitit.ring :as ring]
            [ring.middleware.params :as params]
            [ring.middleware.json :refer [wrap-json-response]]
            [ring.util.response :refer [response]]))

(defn return-path-params-handler [req]
  (wrap-json-response (response (:path-params req))))

(def handler
  (params/wrap-params
   (ring/ring-handler
    (ring/router
     [[&quot;/print/:something&quot; return-path-params-handler]])
    (ring/create-default-handler))))

(comment
  (def http-server (http/start-server #&apos;handler {:port 8080}))
  ,)</pre>
When I do a request to <code></code> I would expect the response to be
<pre>{
  &quot;something&quot;: &quot;some&quot;
}</pre>
But I don&apos;t get a response, it just hangs up and also will not timeout. What am I missing here?</z><z id="t1688825348" t="valerauko does it work if you use something trivial for the handler? does (constantly {:status 200 :body &quot;hello world&quot;}) work?"><y>#</y><d>2023-07-08</d><h>14:09</h><r>valerauko</r>does it work if you use something trivial for the handler? does <code>(constantly {:status 200 :body &quot;hello world&quot;})</code> work?</z><z id="t1688825863" t="Jan Yes, that works"><y>#</y><d>2023-07-08</d><h>14:17</h><r>Jan</r>Yes, that works</z><z id="t1688826182" t="Jan This also works (defn return-path-params-handler [req] (-&gt; (response (:something (:path-params req))) (assoc :headers {&quot;content-type&quot; &quot;text/plain&quot;}))) Seems to be related to wrap-json-response"><y>#</y><d>2023-07-08</d><h>14:23</h><r>Jan</r>This also works
<pre>(defn return-path-params-handler [req]
  (-&gt; (response (:something (:path-params req)))
      (assoc :headers {&quot;content-type&quot; &quot;text/plain&quot;})))</pre>
Seems to be related to wrap-json-response</z><z id="t1688826622" t="Jan Doing this also works (defn return-path-params-handler [req] (-&gt; (response (json/write-str {:something &quot;some&quot;})) (assoc :header {&quot;content-type&quot; &quot;application/json&quot;}))) I will leave it with that for now. Thank you for looking at it"><y>#</y><d>2023-07-08</d><h>14:30</h><r>Jan</r>Doing this also works
<pre>(defn return-path-params-handler [req]
  (-&gt; (response (json/write-str {:something &quot;some&quot;}))
      (assoc :header {&quot;content-type&quot; &quot;application/json&quot;})))</pre>
I will leave it with that for now. Thank you for looking at it</z><z id="t1688830755" t="valerauko hmm i don&apos;t know how any of those ring utils work, but i&apos;ve only seen an aleph server &quot;hang&quot; when the handler returns nil"><y>#</y><d>2023-07-08</d><h>15:39</h><r>valerauko</r>hmm i don&apos;t know how any of those ring utils work, but i&apos;ve only seen an aleph server &quot;hang&quot; when the handler returns nil</z><z id="t1688831123" t="Jan Problem was that I called wrap-json-response on the response and not the handle itself"><y>#</y><d>2023-07-08</d><h>15:45</h><r>Jan</r>Problem was that I called wrap-json-response on the response and not the handle itself</z><z id="t1688831188" t="Jan That is wrap-json-response returns a handler and not a response"><y>#</y><d>2023-07-08</d><h>15:46</h><r>Jan</r>That is wrap-json-response returns a handler and not a response</z><z id="t1688831397" t="valerauko glad it&apos;s figured out! üöÄ"><y>#</y><d>2023-07-08</d><h>15:49</h><r>valerauko</r>glad it&apos;s figured out! <b>üöÄ</b></z><z id="t1688831513" t="Jan üôè"><y>#</y><d>2023-07-08</d><h>15:51</h><r>Jan</r><b>üôè</b></z><z id="t1688880907" t="valerauko This is so weird... Why does removing the ^Type hint solve the problem when just a line later Type. is actually instantiated? Shouldn&apos;t that break AOT too? https://github.com/clj-commons/byte-streams/issues/68"><y>#</y><d>2023-07-09</d><h>05:35</h><w>valerauko</w>This is so weird... Why does removing the ^Type hint solve the problem when just a line later Type. is actually instantiated? Shouldn&apos;t that break AOT too? <a href="https://github.com/clj-commons/byte-streams/issues/68" target="_blank">https://github.com/clj-commons/byte-streams/issues/68</a></z><z id="t1688881833" t="Matthew Davidson (kingmob) I don&apos;t know, but historically, AOT is the source of exotic bugs. The most common is building/deploying/depending on uberjars, but there&apos;s also been weird compiler bugs involving incorrect compilation order, lein/maven classpath bugs for multiple deps with different versions, etc. It&apos;s happened enough that I generally shy away from AOT unless I have a good reason to use it. I&apos;d like to support Graal better, but since it&apos;s effectively AOT, I rarely use it. Would love some help sorting all those issues out because Graal support is commonly requested."><y>#</y><d>2023-07-09</d><h>05:50</h><w>Matthew Davidson (kingmob)</w>I don&apos;t know, but historically, AOT is the source of exotic bugs. The most common is building/deploying/depending on uberjars, but there&apos;s also been weird compiler bugs involving incorrect compilation order, lein/maven classpath bugs for multiple deps with different versions, etc.

It&apos;s happened enough that I generally shy away from AOT unless I have a good reason to use it. I&apos;d like to support Graal better, but since it&apos;s effectively AOT, I rarely use it. Would love some help sorting all those issues out because Graal support is commonly requested.</z><z id="t1688883088" t="valerauko I was thinking of resolving the boxed math / reflection warnings in manifold too."><y>#</y><d>2023-07-09</d><h>06:11</h><w>valerauko</w>I was thinking of resolving the boxed math / reflection warnings in manifold too.</z><z id="t1688883118" t="valerauko manifold doesn&apos;t (yet) depend on primitive-math though, so I wasn&apos;t sure if I should add that new dep and use it like in byte-streams"><y>#</y><d>2023-07-09</d><h>06:11</h><r>valerauko</r>manifold doesn&apos;t (yet) depend on primitive-math though, so I wasn&apos;t sure if I should add that new dep and use it like in byte-streams</z><z id="t1688883198" t="Matthew Davidson (kingmob) I&apos;m fine with a primitive-math dep in manifold. Most people use manifold via aleph, which already requires it"><y>#</y><d>2023-07-09</d><h>06:13</h><r>Matthew Davidson (kingmob)</r>I&apos;m fine with a primitive-math dep in manifold. Most people use manifold via aleph, which already requires it</z><z id="t1688883221" t="Matthew Davidson (kingmob) I was about to cut primtiive-math 1.0.1 today"><y>#</y><d>2023-07-09</d><h>06:13</h><r>Matthew Davidson (kingmob)</r>I was about to cut primtiive-math 1.0.1 today</z><z id="t1688883234" t="Matthew Davidson (kingmob) rc1 has been out for a couple months, and nobody&apos;s complained, so it&apos;s time"><y>#</y><d>2023-07-09</d><h>06:13</h><r>Matthew Davidson (kingmob)</r>rc1 has been out for a couple months, and nobody&apos;s complained, so it&apos;s time</z><z id="t1688883239" t="valerauko I&apos;ll wait for that then ~"><y>#</y><d>2023-07-09</d><h>06:13</h><r>valerauko</r>I&apos;ll wait for that then ~</z><z id="t1688883294" t="Matthew Davidson (kingmob) It won&apos;t affect anything you&apos;d do in Manifold, with the exception of the addition of p/rem in 1.0.1"><y>#</y><d>2023-07-09</d><h>06:14</h><r>Matthew Davidson (kingmob)</r>It won&apos;t affect anything you&apos;d do in Manifold, with the exception of the addition of <code>p/rem</code> in 1.0.1</z><z id="t1688884238" t="Matthew Davidson (kingmob) Yeah, definitely don&apos;t wait for me, I&apos;m trying to straighten out a deployment perm bug for primitive-math with slipset. But DO let me know if you encounter math fns in Manifold that aren&apos;t part of primtive-math, but should be. I know it&apos;s missing fns like quot and (surprisingly) neg? and pos?"><y>#</y><d>2023-07-09</d><h>06:30</h><r>Matthew Davidson (kingmob)</r>Yeah, definitely don&apos;t wait for me, I&apos;m trying to straighten out a deployment perm bug for primitive-math with slipset.

But DO let me know if you encounter math fns in Manifold that aren&apos;t part of primtive-math, but should be. I know it&apos;s missing fns like <code>quot</code> and (surprisingly) <code>neg?</code> and <code>pos?</code></z><z id="t1688884368" t="valerauko Yeah pos? is the only one that&apos;d be used in manifold (I&apos;ll just replace it with gt 0 for now)"><y>#</y><d>2023-07-09</d><h>06:32</h><r>valerauko</r>Yeah pos? is the only one that&apos;d be used in manifold (I&apos;ll just replace it with gt 0 for now)</z><z id="t1688884394" t="Matthew Davidson (kingmob) I saw rem is used in a few places"><y>#</y><d>2023-07-09</d><h>06:33</h><r>Matthew Davidson (kingmob)</r>I saw <code>rem</code> is used in a few places</z><z id="t1688883112" t="Matthew Davidson (kingmob) Go for it"><y>#</y><d>2023-07-09</d><h>06:11</h><w>Matthew Davidson (kingmob)</w>Go for it</z><z id="t1691087417" t="Francesco Pischedda Hi there! I have posted a small blog post covering Aleph and I&apos;d like to have your feedback üôè https://clojurians.slack.com/archives/C8NUSGWG6/p1691087302126619"><y>#</y><d>2023-08-03</d><h>18:30</h><w>Francesco Pischedda</w>Hi there!
I have posted a small blog post covering Aleph and I&apos;d like to have your feedback <b>üôè</b> <a href="https://clojurians.slack.com/archives/C8NUSGWG6/p1691087302126619" target="_blank">https://clojurians.slack.com/archives/C8NUSGWG6/p1691087302126619</a></z><z id="t1691229106" t="Matthew Davidson (kingmob) Hey, looks good! A few minor comments about Aleph/Manifold: &gt; Manifold pre dates clojure.core.async Afaik core.async is older than Manifold, not the other way around. The first commit of core.async is 10 months older than the first commit of Manifold. &gt; these data structure can be used as the body of a response and Aleph will return their contents as soon as they are available and will close the connect ion as soon as these sources will be closed True, Aleph will delay cleaning up necessary resources until the underlying deferred/stream for the body is done, but to be precise, the network connection isn&apos;t one of them (except in the rare case when keep-alive is false). For the most part, given the high overhead of creating connections, we try to keep them around and reuse them for multiple requests/responses. &gt; ... see how it is used in Aleph&apos;s examples here. http://Aleph.io is a cool way to present docs, but it&apos;s getting out-of-date, and unfortunately, we no longer have access to it. The most up-to-date docs are at http://cljdoc.org , and the current examples are in the examples/ subdirectory in the repo. &gt; (def _server (atom nil)) Slight stylistic note: I usually see underscores prefixing things that are meant to be ignored, like a param you don&apos;t need."><y>#</y><d>2023-08-05</d><h>09:51</h><r>Matthew Davidson (kingmob)</r>Hey, looks good! A few minor comments about Aleph/Manifold:

&gt; Manifold pre dates clojure.core.async 
Afaik core.async is older than Manifold, not the other way around. The first commit of core.async is 10 months older than the first commit of Manifold.

&gt; these data structure can be used as the body of a response and Aleph will return their contents as soon as they are available and will close the connect ion as soon as these sources will be closed
True, Aleph will delay cleaning up necessary resources until the underlying deferred/stream for the body is done, but to be precise, the network connection isn&apos;t one of them (except in the rare case when <code>keep-alive</code> is false). For the most part, given the high overhead of creating connections, we try to keep them around and reuse them for multiple requests/responses.

&gt; ... see how it is used in Aleph&apos;s examples here.
<a href="http://Aleph.io" target="_blank">http://Aleph.io</a> is a cool way to present docs, but it&apos;s getting out-of-date, and unfortunately, we no longer have access to it. The most up-to-date docs are at <a href="http://cljdoc.org" target="_blank">http://cljdoc.org</a>, and the current examples are in the <code>examples/</code> subdirectory in the repo.

&gt; <code>(def _server (atom nil))</code>
Slight stylistic note: I usually see underscores prefixing things that are meant to be ignored, like a param you don&apos;t need.</z><z id="t1691230505" t="Francesco Pischedda Hi [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] üôÇ Thanks for your feedback! &gt; Afaik core.async is older than Manifold I&apos;ve based my assumption on the copyright statement of both projects ‚Ä¢ https://github.com/clj-commons/manifold#license : Copyright ¬© 2014-2022 Zach Tellman ‚Ä¢ https://github.com/clojure/core.async#license : Copyright ¬© 2017-2023 Rich Hickey and contributors Could it be possible that the repo in clj-commons project has more recent initial commits than the original project? &gt; the network connection isn&apos;t one of them Probably I have to make it clear that I am referring to the deferred or stream and not to the network to avoid confusion, thanks for pointing this out! &gt; The most up-to-date docs are at http://cljdoc.org , Thanks again! I will adjust the link to point to cljdoc &gt; Slight stylistic note: I usually see underscores prefixing things that are meant to be ignored, like a param you don&apos;t need. You are right! I always confuse the ignore case from the derefferable case, is it it common to use an underscore in a postfix position or something else?"><y>#</y><d>2023-08-05</d><h>10:15</h><r>Francesco Pischedda</r>Hi <a>@U10EC98F5</a> <b>üôÇ</b>
Thanks for your feedback!
&gt; Afaik core.async is older than Manifold
I&apos;ve based my assumption on the copyright statement of both projects
‚Ä¢ <a href="https://github.com/clj-commons/manifold#license" target="_blank">https://github.com/clj-commons/manifold#license</a>: Copyright ¬© 2014-2022 Zach Tellman
‚Ä¢ <a href="https://github.com/clojure/core.async#license" target="_blank">https://github.com/clojure/core.async#license</a>: Copyright ¬© 2017-2023 Rich Hickey and contributors
Could it be possible that the repo in clj-commons project has more recent initial commits than the original project?

&gt; the network connection isn&apos;t one of them
Probably I have to make it clear that I am referring to the deferred or stream and not to the network to avoid confusion, thanks for pointing this out!

&gt; The most up-to-date docs are at <a href="http://cljdoc.org" target="_blank">http://cljdoc.org</a>,
Thanks again! I will adjust the link to point to cljdoc

&gt; Slight stylistic note: I usually see underscores prefixing things that are meant to be ignored, like a param you don&apos;t need.
You are right! I always confuse the <code>ignore</code> case from the <code>derefferable</code> case, is it it common to use an underscore in a postfix position or something else?</z><z id="t1691230701" t="Matthew Davidson (kingmob) I don&apos;t know where the 2017 core.async copyright year comes from; I based that on the initial git commit timestamp. But even assuming Hickey sat on it before announcing it, he gave a talk on core.async in 2013, as did Tim Baldridge."><y>#</y><d>2023-08-05</d><h>10:18</h><r>Matthew Davidson (kingmob)</r>I don&apos;t know where the 2017 core.async copyright year comes from; I based that on the initial git commit timestamp. But even assuming Hickey sat on it before announcing it, he gave a talk on core.async in 2013, as did Tim Baldridge.</z><z id="t1691230860" t="Matthew Davidson (kingmob) &gt; I always confuse the ignore case from the derefferable case Deref-able? I&apos;m not familiar with any notation to indicate deref-ability. Have you checked the https://guide.clojure.style/#naming ?"><y>#</y><d>2023-08-05</d><h>10:21</h><r>Matthew Davidson (kingmob)</r>&gt; I always confuse the <code>ignore</code> case from the <code>derefferable</code> case
Deref-able? I&apos;m not familiar with any notation to indicate deref-ability.

Have you checked the <a href="https://guide.clojure.style/#naming" target="_blank">https://guide.clojure.style/#naming</a>?</z><z id="t1691231027" t="Matthew Davidson (kingmob) &gt; Thanks again! I will adjust the link to point to cljdoc Unfortunately, the stuff in examples/ is NOT yet in http://cljdoc.org ... üòî"><y>#</y><d>2023-08-05</d><h>10:23</h><r>Matthew Davidson (kingmob)</r>&gt; Thanks again! I will adjust the link to point to cljdoc
Unfortunately, the stuff in <code>examples/</code> is NOT yet in <a href="http://cljdoc.org" target="_blank">http://cljdoc.org</a>... <b>üòî</b></z><z id="t1691231439" t="Francesco Pischedda &gt; he gave a talk on core.async in 2013, as did Tim Baldridge. mmm at this point I am inclined to remove that sentence, maybe pointing out that both came out almost at the same time &gt; Have you checked the https://guide.clojure.style/#naming ? I didn&apos;t find anything specific there, maybe it is my memory of the coding style of a previous job, I&apos;ll adjust it so that at least id does not conflict with the idiom of something to be ignored &gt; Unfortunately, the stuff in examples/ is NOT yet in http://cljdoc.org ... üòî I will add the examples in this case ü§ù"><y>#</y><d>2023-08-05</d><h>10:30</h><r>Francesco Pischedda</r>&gt; he gave a talk on core.async in 2013, as did Tim Baldridge.
mmm at this point I am inclined to remove that sentence, maybe pointing out that both came out almost at the same time

&gt; Have you checked the <a href="https://guide.clojure.style/#naming" target="_blank">https://guide.clojure.style/#naming</a>?
I didn&apos;t find anything specific there, maybe it is my memory of the coding style of a previous job, I&apos;ll adjust it so that at least id does not conflict with the idiom of something to be ignored

&gt; Unfortunately, the stuff in <code>examples/</code> is NOT yet in <a href="http://cljdoc.org" target="_blank">http://cljdoc.org</a>... <b>üòî</b>
I will add the examples in this case <b>ü§ù</b></z><z id="t1691234680" t="Matthew Davidson (kingmob) &gt; Could it be possible that the repo in clj-commons project has more recent initial commits than the original project? No, because the clj-commons repos are forks, not new repos, so the history is the same."><y>#</y><d>2023-08-05</d><h>11:24</h><r>Matthew Davidson (kingmob)</r>&gt; Could it be possible that the repo in clj-commons project has more recent initial commits than the original project?
No, because the clj-commons repos are forks, not new repos, so the history is the same.</z><z id="t1691406237" t="pithyless Based on the previous thread, I thought it would be interesting to do some git archaeology on aleph/manifold. üßµ"><y>#</y><d>2023-08-07</d><h>11:03</h><w>pithyless</w>Based on the previous thread, I thought it would be interesting to do some git archaeology on aleph/manifold. <b>üßµ</b></z><z id="t1691406316" t="pithyless &gt; Aleph - &quot;initial commit&quot; - July 7, 2010 &gt; Aleph is an asynchronous web server, built on top of &quot;Netty&quot;. It conforms to the interface described by &quot;Ring&quot;, with one small difference: the request and response are decoupled. https://github.com/clj-commons/aleph/commit/30f04aa94e279c1eb4672fc1cb55b2767f975353 &gt; core.async - &quot;initial commit&quot; - May 15, 2013 &gt; A Clojure library designed to provide facilities for async programming and communication https://github.com/clojure/core.async/commit/3ed968b132a2dacd76dcb0f2744eff48fcce58e4 &gt; core.async - &quot;Rename core.async. -&gt; clojure.core.async.&quot; - May 29, 2013 https://github.com/clojure/core.async/commit/9b93d1f5e3cab00d58bfa8e0c04c1bbeeea49c2d &gt; core.async announced - June 28,2013 https://clojure.org/news/2013/06/28/clojure-clore-async-channels &gt; Manifold &quot;first commit&quot; (actually called &quot;Eventual&quot; at the time) - March 4, 2014 &gt; This library provides basic building blocks for asynchronous programming, and can be used as a translation layer between libraries which use similar but incompatible abstractions. https://github.com/clj-commons/manifold/commit/e26bb678669784b90da62ebced592e6fcfd3cda7 &gt; Manifold &quot;base stream implementation, rename to &apos;manifold&apos;&quot; - April 1, 2014 &gt; Introduces: org.clojure/core.async &quot;0.1.267.0-0d7780-alpha&quot; https://github.com/clj-commons/manifold/commit/e4b8939137c069605599409e739cbe6f6a722087 &gt; Aleph &quot;tear it all down&quot; commit - July 27, 2014 &gt; Introduces: manifold &quot;0.1.0-SNAPSHOT&quot; https://github.com/clj-commons/aleph/commit/b4759eb63975e8f85d266e3dbb512d62c3ae5451 &gt; Aleph &quot;initial http server implementation&quot; - July 31, 2014 &gt; Introduces: byte-streams &quot;0.2.0-SNAPSHOT&quot; https://github.com/clj-commons/aleph/commit/7209a16d02649174eefdd26b4c7fe63ca48ff9a1 &gt; Aleph &quot;update readme&quot; - September 22, 2014 &gt; This is a ground-up rewrite of Aleph. https://github.com/clj-commons/aleph/commit/5d877e9738e3cd59165cb7308cdbef3e667d344f"><y>#</y><d>2023-08-07</d><h>11:05</h><r>pithyless</r>&gt;  Aleph - &quot;initial commit&quot; - July 7, 2010
&gt;  Aleph is an asynchronous web server, built on top of &quot;Netty&quot;. It conforms to the interface described by &quot;Ring&quot;, with one small difference: the request and response are decoupled.
<a href="https://github.com/clj-commons/aleph/commit/30f04aa94e279c1eb4672fc1cb55b2767f975353" target="_blank">https://github.com/clj-commons/aleph/commit/30f04aa94e279c1eb4672fc1cb55b2767f975353</a>

&gt; core.async - &quot;initial commit&quot; - May 15, 2013
&gt; A Clojure library designed to provide facilities for async programming and communication
<a href="https://github.com/clojure/core.async/commit/3ed968b132a2dacd76dcb0f2744eff48fcce58e4" target="_blank">https://github.com/clojure/core.async/commit/3ed968b132a2dacd76dcb0f2744eff48fcce58e4</a>

&gt; core.async - &quot;Rename core.async. -&gt; clojure.core.async.&quot; - May 29, 2013
<a href="https://github.com/clojure/core.async/commit/9b93d1f5e3cab00d58bfa8e0c04c1bbeeea49c2d" target="_blank">https://github.com/clojure/core.async/commit/9b93d1f5e3cab00d58bfa8e0c04c1bbeeea49c2d</a>

&gt; core.async announced - June 28,2013
<a href="https://clojure.org/news/2013/06/28/clojure-clore-async-channels" target="_blank">https://clojure.org/news/2013/06/28/clojure-clore-async-channels</a>

&gt; Manifold &quot;first commit&quot; (actually called &quot;Eventual&quot; at the time) - March 4, 2014
&gt; This library provides basic building blocks for asynchronous programming, and can be used as a translation layer between libraries which use similar but incompatible abstractions.
<a href="https://github.com/clj-commons/manifold/commit/e26bb678669784b90da62ebced592e6fcfd3cda7" target="_blank">https://github.com/clj-commons/manifold/commit/e26bb678669784b90da62ebced592e6fcfd3cda7</a>

&gt; Manifold &quot;base stream implementation, rename to &apos;manifold&apos;&quot; - April 1, 2014
&gt; Introduces: org.clojure/core.async &quot;0.1.267.0-0d7780-alpha&quot;
<a href="https://github.com/clj-commons/manifold/commit/e4b8939137c069605599409e739cbe6f6a722087" target="_blank">https://github.com/clj-commons/manifold/commit/e4b8939137c069605599409e739cbe6f6a722087</a>

&gt; Aleph &quot;tear it all down&quot; commit - July 27, 2014
&gt; Introduces: manifold &quot;0.1.0-SNAPSHOT&quot;
<a href="https://github.com/clj-commons/aleph/commit/b4759eb63975e8f85d266e3dbb512d62c3ae5451" target="_blank">https://github.com/clj-commons/aleph/commit/b4759eb63975e8f85d266e3dbb512d62c3ae5451</a>

&gt; Aleph &quot;initial http server implementation&quot; - July 31, 2014
&gt; Introduces: byte-streams &quot;0.2.0-SNAPSHOT&quot;
<a href="https://github.com/clj-commons/aleph/commit/7209a16d02649174eefdd26b4c7fe63ca48ff9a1" target="_blank">https://github.com/clj-commons/aleph/commit/7209a16d02649174eefdd26b4c7fe63ca48ff9a1</a>

&gt; Aleph &quot;update readme&quot; - September 22, 2014
&gt; This is a ground-up rewrite of Aleph.
<a href="https://github.com/clj-commons/aleph/commit/5d877e9738e3cd59165cb7308cdbef3e667d344f" target="_blank">https://github.com/clj-commons/aleph/commit/5d877e9738e3cd59165cb7308cdbef3e667d344f</a></z><z id="t1691406788" t="pithyless So, to answer your question [:attrs {:href &quot;/_/_/users/U0165ADKUDU&quot;}] and [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] - both Rich Hickey and Zach Tellman were obviously thinking about and working on these problems before 2013. But I would hazard a guess that Manifold was a direct descendant of ripping out and reimagining the existing aleph codebase after core.async came out (which as I recall had made a lot of noise at the time it was announced and was prominent in the Clojure zeitgeist)."><y>#</y><d>2023-08-07</d><h>11:13</h><r>pithyless</r>So, to answer your question <a>@U0165ADKUDU</a> and <a>@U10EC98F5</a> - both Rich Hickey and Zach Tellman were obviously thinking about and working on these problems before 2013.

But I would hazard a guess that Manifold was a direct descendant of ripping out and reimagining the existing aleph codebase after core.async came out (which as I recall had made a lot of noise at the time it was announced and was prominent in the Clojure zeitgeist).</z><z id="t1691407487" t="Francesco Pischedda Hi [:attrs {:href &quot;/_/_/users/U05476190&quot;}] ! üëã Thank you for the additional background üôè"><y>#</y><d>2023-08-07</d><h>11:24</h><r>Francesco Pischedda</r>Hi <a>@U05476190</a> ! <b>üëã</b>
Thank you for the additional background <b>üôè</b></z><z id="t1691411377" t="Matthew Davidson (kingmob) Nice detective work! I think if we want to go back to the pre-code ideation phase, though, it&apos;s important to note that both of them were heavily inspired by Go&apos;s use of Communicating Sequential Processes and channels as communication primitives. I&apos;d bet that&apos;s probably a bigger influence than either were on each other. Remember, Go had been out for a few years then, and had garnered a reputation for fast network programming and concurrency. "><y>#</y><d>2023-08-07</d><h>12:29</h><r>Matthew Davidson (kingmob)</r>Nice detective work! 

I think if we want to go back to the pre-code ideation phase, though, it&apos;s important to note that both of them were heavily inspired by Go&apos;s use of Communicating Sequential Processes and channels as communication primitives. 

I&apos;d bet that&apos;s probably a bigger influence than either were on each other. Remember, Go had been out for a few years then, and had garnered a reputation for fast network programming and concurrency. </z><z id="t1691411991" t="pithyless I wasn&apos;t suggesting either of them independently invented CSP. ;) Was there something specific that you&apos;re aware of that linked them specifically to Go&apos;s CSP? Those two individuals are well known for their extensive paper research - I&apos;m sure they were well aware of CSP, irrespective of Go. But maybe their implementation was heavily inspired. I wasn&apos;t there, I wouldn&apos;t know. ü§∑"><y>#</y><d>2023-08-07</d><h>12:39</h><r>pithyless</r>I wasn&apos;t suggesting either of them independently invented CSP. ;)

Was there something specific that you&apos;re aware of that linked them specifically to Go&apos;s CSP? Those two individuals are well known for their extensive paper research - I&apos;m sure they were well aware of CSP, irrespective of Go. But maybe their implementation was heavily inspired. I wasn&apos;t there, I wouldn&apos;t know. <b>ü§∑</b></z><z id="t1691412993" t="Matthew Davidson (kingmob) I can&apos;t think of any talks about the inspiration for manifold off the top of my head. But in particular, academic CSP views channels as an implementation detail, while Go showed they were a useful, maybe necessary, primitive for actually using CSP in production. And AFAIK, there&apos;s no popular CSP-based language before Go. Also, there&apos;s no way they wouldn&apos;t have heard of Go at the time. The creators were famous, it was backed by Google, and it had been out for a few years before either clj lib existed. It got a lot of attention from the outset. If anything, core.async might owe the bigger debt to Go, since a lot of Manifold&apos;s terminology and interop is closer to the Java streaming libs that arose around then. "><y>#</y><d>2023-08-07</d><h>12:56</h><r>Matthew Davidson (kingmob)</r>I can&apos;t think of any talks about the inspiration for manifold off the top of my head. 

But in particular, academic CSP views channels as an implementation detail, while Go showed they were a useful, maybe necessary, primitive for actually using CSP in production. And AFAIK, there&apos;s no popular CSP-based language before Go. 

Also, there&apos;s no way they wouldn&apos;t have heard of Go at the time. The creators were famous, it was backed by Google, and it had been out for a few years before either clj lib existed. It got a lot of attention from the outset. 

If anything, core.async might owe the bigger debt to Go, since a lot of Manifold&apos;s terminology and interop is closer to the Java streaming libs that arose around then. </z><z id="t1691944608" t="Matthew Davidson (kingmob) I&apos;m a bit surprised at how patchy HTTP/2 support is outside the browsers. E.g., popular tools like Postman, HTTPie, and RapidAPI don&apos;t support it."><y>#</y><d>2023-08-13</d><h>16:36</h><w>Matthew Davidson (kingmob)</w>I&apos;m a bit surprised at how patchy HTTP/2 support is outside the browsers. E.g., popular tools like Postman, HTTPie, and RapidAPI don&apos;t support it.</z><z id="t1693474199" t="Stefan Hi all, today we got a new CVE from dependency-check in netty: https://ossindex.sonatype.org/vulnerability/CVE-2023-4586?component-type=maven&amp;amp;component-name=io.netty%2Fnetty-handler&amp;amp;utm_source=dependency-check&amp;amp;utm_medium=integration&amp;amp;utm_content=8.4.0 . Can somebody help me understand if this affects us Aleph users?"><y>#</y><d>2023-08-31</d><h>09:29</h><w>Stefan</w>Hi all, today we got a new CVE from dependency-check in netty: <a href="https://ossindex.sonatype.org/vulnerability/CVE-2023-4586?component-type=maven&amp;amp;component-name=io.netty%2Fnetty-handler&amp;amp;utm_source=dependency-check&amp;amp;utm_medium=integration&amp;amp;utm_content=8.4.0" target="_blank">https://ossindex.sonatype.org/vulnerability/CVE-2023-4586?component-type=maven&amp;amp;component-name=io.netty%2Fnetty-handler&amp;amp;utm_source=dependency-check&amp;amp;utm_medium=integration&amp;amp;utm_content=8.4.0</a>. Can somebody help me understand if this affects us Aleph users?</z><z id="t1693474276" t="Stefan I see remarks like: &gt; This is not a vulnerability. It‚Äôs just about properly using the Netty and JSSE APIs. Should be flagged as a false positive in your vuln scan tool. ( https://github.com/netty/netty/issues/8537#issuecomment-1527896917 ) I&apos;m hoping somebody who knows the details of Aleph better than myself can judge whether this is applicable."><y>#</y><d>2023-08-31</d><h>09:31</h><r>Stefan</r>I see remarks like:

&gt;  This is not a vulnerability. It‚Äôs just about properly using the Netty and JSSE APIs. Should be flagged as a false positive in your vuln scan tool.
(<a href="https://github.com/netty/netty/issues/8537#issuecomment-1527896917" target="_blank">https://github.com/netty/netty/issues/8537#issuecomment-1527896917</a>)

I&apos;m hoping somebody who knows the details of Aleph better than myself can judge whether this is applicable.</z><z id="t1693488354" t="Matthew Davidson (kingmob) Aleph doesn&apos;t do anything different as far as security goes. It hands all of that off to Netty. If it&apos;s a config issue with Netty, the same is probably true for Aleph. If it&apos;s a real vuln in Netty, it&apos;s probably a real vuln in Aleph. FWIW, there&apos;s the the manual-ssl? param, but I&apos;ve never personally used it."><y>#</y><d>2023-08-31</d><h>13:25</h><r>Matthew Davidson (kingmob)</r>Aleph doesn&apos;t do anything different as far as security goes. It hands all of that off to Netty. If it&apos;s a config issue with Netty, the same is probably true for Aleph. If it&apos;s a real vuln in Netty, it&apos;s probably a real vuln in Aleph.

FWIW, there&apos;s the the <code>manual-ssl?</code> param, but I&apos;ve never personally used it.</z><z id="t1693564724" t="dergutemoritz I also looked into this a bit yesterday. The issue you linked to is about enabling hostname verification by default in Netty itself which would indeed be the reasonable (and safe) thing to do. I don&apos;t quite get the comment you linked to in that context. It&apos;s akin to accepting self-signed certificates by default and requiring users to enable CA checks. I would consider this a vulnerability, too. During research I also found that https://github.com/julianladisch/vert.x/commit/8b2eef4f47301cfca8238ca4f4456691cb142ced . I think we could/should do the same in Aleph and provide an option for reverting back to the old (unsafe) behavior. I have a workaround in our codebase to enable it via :pipeline-transform which should be pretty easy to port to Aleph itself. If you agree, I will prepare a PR!"><y>#</y><d>2023-09-01</d><h>10:38</h><r>dergutemoritz</r>I also looked into this a bit yesterday. The issue you linked to is about enabling hostname verification by default in Netty itself which would indeed be the reasonable (and safe) thing to do. I don&apos;t quite get the comment you linked to in that context. It&apos;s akin to accepting self-signed certificates by default and requiring users to enable CA checks. I would consider this a vulnerability, too. During research I also found that <a href="https://github.com/julianladisch/vert.x/commit/8b2eef4f47301cfca8238ca4f4456691cb142ced" target="_blank">https://github.com/julianladisch/vert.x/commit/8b2eef4f47301cfca8238ca4f4456691cb142ced</a>. I think we could/should do the same in Aleph and provide an option for reverting back to the old (unsafe) behavior. I have a workaround in our codebase to enable it via <code>:pipeline-transform</code> which should be pretty easy to port to Aleph itself. If you agree, I will prepare a PR!</z><z id="t1693564864" t="Stefan Thanks [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] for looking into this! It sounds to me like a good idea to make a PR, and I would also be very grateful if you could share some of the setup code that you are using, so that we can do the same!"><y>#</y><d>2023-09-01</d><h>10:41</h><r>Stefan</r>Thanks <a>@U06GVE6NR</a> for looking into this! It sounds to me like a good idea to make a PR, and I would also be very grateful if you could share some of the setup code that you are using, so that we can do the same!</z><z id="t1693564890" t="Stefan (But the PR thing is not my call to make üòâ )"><y>#</y><d>2023-09-01</d><h>10:41</h><r>Stefan</r>(But the PR thing is not my call to make <b>üòâ</b> )</z><z id="t1693564895" t="Matthew Davidson (kingmob) (Just a heads-up, pipeline-transform can&apos;t work the same way in http2 (since there&apos;s now 1+N pipelines), so we need to come up with new params. See the HTTP/2 PR)"><y>#</y><d>2023-09-01</d><h>10:41</h><r>Matthew Davidson (kingmob)</r>(Just a heads-up, <code>pipeline-transform</code> can&apos;t work the same way in http2 (since there&apos;s now 1+N pipelines), so we need to come up with new params. See the HTTP/2 PR)</z><z id="t1693564944" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Ah is this also the case for the client?"><y>#</y><d>2023-09-01</d><h>10:42</h><r>dergutemoritz</r><a>@U10EC98F5</a> Ah is this also the case for the client?</z><z id="t1693565002" t="Matthew Davidson (kingmob) Yes. It&apos;s the nature of http2 multiplexing. I think pipeline-transform is going to be one of the few truly breaking changes, and I haven&apos;t figured out a good way around it."><y>#</y><d>2023-09-01</d><h>10:43</h><r>Matthew Davidson (kingmob)</r>Yes. It&apos;s the nature of http2 multiplexing. I think pipeline-transform is going to be one of the few truly breaking changes, and I haven&apos;t figured out a good way around it.</z><z id="t1693565030" t="dergutemoritz Right, makes sense that it would affect both ends, of course"><y>#</y><d>2023-09-01</d><h>10:43</h><r>dergutemoritz</r>Right, makes sense that it would affect both ends, of course</z><z id="t1693565044" t="dergutemoritz Anyway, when making it part of Aleph proper, we won&apos;t have to go through :pipeline-transform , of course"><y>#</y><d>2023-09-01</d><h>10:44</h><r>dergutemoritz</r>Anyway, when making it part of Aleph proper, we won&apos;t have to go through <code>:pipeline-transform</code>, of course</z><z id="t1693565057" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] snippet coming up!"><y>#</y><d>2023-09-01</d><h>10:44</h><r>dergutemoritz</r><a>@UGNFXV1FA</a>  snippet coming up!</z><z id="t1693565149" t="Matthew Davidson (kingmob) Netty handles http2 multiplexing by creating 1 connection-level channel, and then multiple stream-level channels for each HTTP2 stream. Sometimes you&apos;d wat pipeline-transform to alter the conn pipeline, other times you&apos;d want it to alter the stream pipelines, and sometimes both! There&apos;s no way to know which without knowing what the transform fn wants to do"><y>#</y><d>2023-09-01</d><h>10:45</h><r>Matthew Davidson (kingmob)</r>Netty handles http2 multiplexing by creating 1 connection-level channel, and then multiple stream-level channels for each HTTP2 stream. Sometimes you&apos;d wat pipeline-transform to alter the conn pipeline, other times you&apos;d want it to alter the stream pipelines, and sometimes both! There&apos;s no way to know which without knowing what the transform fn wants to do</z><z id="t1693565200" t="dergutemoritz Right, and the SslHandler is of course a connection-level thing. Will try to think about this, too and get back to it on the new PR!"><y>#</y><d>2023-09-01</d><h>10:46</h><r>dergutemoritz</r>Right, and the SslHandler is of course a connection-level thing. Will try to think about this, too and get back to it on the new PR!</z><z id="t1693565215" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] WDYT about enabling hostname verification by default in Aleph?"><y>#</y><d>2023-09-01</d><h>10:46</h><r>dergutemoritz</r><a>@U10EC98F5</a> WDYT about enabling hostname verification by default in Aleph?</z><z id="t1693565267" t="Matthew Davidson (kingmob) The good news is pipeline-transform usage is rare, and anyone doing it should already be prepared to muck around with netty"><y>#</y><d>2023-09-01</d><h>10:47</h><r>Matthew Davidson (kingmob)</r>The good news is pipeline-transform usage is rare, and anyone doing it should already be prepared to muck around with netty</z><z id="t1693565295" t="Matthew Davidson (kingmob) &gt; WDYT about enabling hostname verification by default in Aleph? Seems reasonable, but we should look into it first"><y>#</y><d>2023-09-01</d><h>10:48</h><r>Matthew Davidson (kingmob)</r>&gt; WDYT about enabling hostname verification by default in Aleph?
Seems reasonable, but we should look into it first</z><z id="t1693565463" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] https://gist.github.com/DerGuteMoritz/da01ff0bcb0611fad2a3562a81dc1750"><y>#</y><d>2023-09-01</d><h>10:51</h><r>dergutemoritz</r><a>@UGNFXV1FA</a> <a href="https://gist.github.com/DerGuteMoritz/da01ff0bcb0611fad2a3562a81dc1750" target="_blank">https://gist.github.com/DerGuteMoritz/da01ff0bcb0611fad2a3562a81dc1750</a></z><z id="t1693565581" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Anything in particular you&apos;d like me to look into beyond what I already did? Or do you want to familiarize yourself with the issue a bit more first?"><y>#</y><d>2023-09-01</d><h>10:53</h><r>dergutemoritz</r><a>@U10EC98F5</a> Anything in particular you&apos;d like me to look into beyond what I already did? Or do you want to familiarize yourself with the issue a bit more first?</z><z id="t1693565692" t="Matthew Davidson (kingmob) If it&apos;s as simple as the gist, we don&apos;t have to worry about maintenance impact or prioritization. Only real question is whether it will break legitimate stuff. Of course, we&apos;ll need a flag to disable it. (I already know I may want to turn it off so I can MITM myself when debugging with Wireshark)"><y>#</y><d>2023-09-01</d><h>10:54</h><r>Matthew Davidson (kingmob)</r>If it&apos;s as simple as the gist, we don&apos;t have to worry about maintenance impact or prioritization.

Only real question is whether it will break legitimate stuff. Of course, we&apos;ll need a flag to disable it. (I already know I may want to turn it off so I can MITM myself when debugging with Wireshark)</z><z id="t1693565747" t="Matthew Davidson (kingmob) Maybe create a GH issue? It&apos;s not a priority at the moment, but we don&apos;t want to forget"><y>#</y><d>2023-09-01</d><h>10:55</h><r>Matthew Davidson (kingmob)</r>Maybe create a GH issue? It&apos;s not a priority at the moment, but we don&apos;t want to forget</z><z id="t1693565753" t="dergutemoritz Yup, it is a breaking change for sure"><y>#</y><d>2023-09-01</d><h>10:55</h><r>dergutemoritz</r>Yup, it is a breaking change for sure</z><z id="t1693565770" t="dergutemoritz Aye, will file one"><y>#</y><d>2023-09-01</d><h>10:56</h><r>dergutemoritz</r>Aye, will file one</z><z id="t1693565814" t="Matthew Davidson (kingmob) Question is, how much breaking?"><y>#</y><d>2023-09-01</d><h>10:56</h><r>Matthew Davidson (kingmob)</r>Question is, how much breaking?</z><z id="t1693565851" t="dergutemoritz Assuming that people have usually set up their TLS certificates properly, I would think not too much"><y>#</y><d>2023-09-01</d><h>10:57</h><r>dergutemoritz</r>Assuming that people have usually set up their TLS certificates properly, I would think not too much</z><z id="t1693565856" t="Stefan Thanks [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] I really appreciate that!"><y>#</y><d>2023-09-01</d><h>10:57</h><r>Stefan</r>Thanks <a>@U06GVE6NR</a> I really appreciate that!</z><z id="t1693565860" t="dergutemoritz YW!"><y>#</y><d>2023-09-01</d><h>10:57</h><r>dergutemoritz</r>YW!</z><z id="t1693565907" t="Matthew Davidson (kingmob) My suspicion is there&apos;ll be some internal use with out-of-date certs with old names, and deploying this change will break that"><y>#</y><d>2023-09-01</d><h>10:58</h><r>Matthew Davidson (kingmob)</r>My suspicion is there&apos;ll be some internal use with out-of-date certs with old names, and deploying this change will break that</z><z id="t1693565919" t="dergutemoritz Yep, agreed"><y>#</y><d>2023-09-01</d><h>10:58</h><r>dergutemoritz</r>Yep, agreed</z><z id="t1693565936" t="dergutemoritz (gotta run, brb)"><y>#</y><d>2023-09-01</d><h>10:58</h><r>dergutemoritz</r>(gotta run, brb)</z><z id="t1693578883" t="dergutemoritz OK finally got around to it: https://github.com/clj-commons/aleph/issues/688"><y>#</y><d>2023-09-01</d><h>14:34</h><r>dergutemoritz</r>OK finally got around to it: <a href="https://github.com/clj-commons/aleph/issues/688" target="_blank">https://github.com/clj-commons/aleph/issues/688</a></z><z id="t1693579688" t="Stefan [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] This should also work server-side then, right? Like this: (reset! server (http/start-server (handler env) {:port port :pipeline-transform (fn [^ChannelPipeline pipeline] (when-let [ssl-engine (-&gt; pipeline ^SslHandler (.get SslHandler) .engine)] (let [ssl-params (.getSSLParameters ssl-engine)] (.setEndpointIdentificationAlgorithm ssl-params &quot;HTTPS&quot;) (.setSSLParameters ssl-engine ssl-params))))}))"><y>#</y><d>2023-09-01</d><h>14:48</h><r>Stefan</r><a>@U06GVE6NR</a> This should also work server-side then, right? Like this:

<pre>(reset! server (http/start-server (handler env)
                                  {:port port
                                   :pipeline-transform
                                   (fn [^ChannelPipeline pipeline]
                                       (when-let [ssl-engine (-&gt; pipeline ^SslHandler (.get SslHandler) .engine)]
                                                 (let [ssl-params (.getSSLParameters ssl-engine)]
                                                      (.setEndpointIdentificationAlgorithm ssl-params &quot;HTTPS&quot;)
                                                      (.setSSLParameters ssl-engine ssl-params))))}))</pre></z><z id="t1693589266" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] That&apos;s not necessary, this only affects the client&apos;s behavior. If you&apos;re using client certificates, there is no standard way of verifying their CN on the server-side, that would be part of your application logic."><y>#</y><d>2023-09-01</d><h>17:27</h><r>dergutemoritz</r><a>@UGNFXV1FA</a> That&apos;s not necessary, this only affects the client&apos;s behavior. If you&apos;re using client certificates, there is no standard way of verifying their CN on the server-side, that would be part of your application logic.</z><z id="t1693589336" t="dergutemoritz (at least in the context of HTTPS; there might be other standards which I&apos;m not aware of)"><y>#</y><d>2023-09-01</d><h>17:28</h><r>dergutemoritz</r>(at least in the context of HTTPS; there might be other standards which I&apos;m not aware of)</z><z id="t1693589391" t="Stefan Clear, thank you üôè "><y>#</y><d>2023-09-01</d><h>17:29</h><r>Stefan</r>Clear, thank you <b>üôè</b>  </z><z id="t1693905994" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] Headsup - I just updated the snippet, there was a small bug in there which made it unfit for use with non-HTTPS requests"><y>#</y><d>2023-09-05</d><h>09:26</h><r>dergutemoritz</r><a>@UGNFXV1FA</a> Headsup - I just updated the snippet, there was a small bug in there which made it unfit for use with non-HTTPS requests</z><z id="t1693915021" t="Stefan [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] Thank you so much for letting me now! I updated my notes üôÇ"><y>#</y><d>2023-09-05</d><h>11:57</h><r>Stefan</r><a>@U06GVE6NR</a> Thank you so much for letting me now! I updated my notes <b>üôÇ</b></z><z id="t1693544357" t="Matthew Davidson (kingmob) What have I been up to? Let&apos;s ask GPT! git log --oneline --pretty=format:&quot;%s&quot; 0.7.0-alpha1.. | sgpt --model gpt-4 &quot;Summarize my Aleph changes into no more than 5 items.&quot; 1. Implemented HTTP2 testing and server code, including ALPN support, pipeline setup, and header handling. 2. Refactored and cleaned up server code, including moving certain functionalities to common namespaces, updating deprecated usages, and improving clarity of names. 3. Fixed various bugs, such as executor rejection handling, NPE when ALPN is not used, and issues with byte-streams.graph.Type loaded by different ClassLoaders. 4. Enhanced logging and documentation, including adding a lot of logging, updating comments and docstrings, and improving instructions for using TLS. 5. Switched to BoringSSL for local development and ignored .pem files for security."><y>#</y><d>2023-09-01</d><h>04:59</h><w>Matthew Davidson (kingmob)</w>What have I been up to? Let&apos;s ask GPT!

<pre>git log --oneline --pretty=format:&quot;%s&quot; 0.7.0-alpha1.. | sgpt --model gpt-4 &quot;Summarize my Aleph changes into no more than 5 items.&quot;

1. Implemented HTTP2 testing and server code, including ALPN support, pipeline setup, and header handling.
2. Refactored and cleaned up server code, including moving certain functionalities to common namespaces, updating deprecated usages, and improving clarity of names.
3. Fixed various bugs, such as executor rejection handling, NPE when ALPN is not used, and issues with byte-streams.graph.Type loaded by different ClassLoaders.
4. Enhanced logging and documentation, including adding a lot of logging, updating comments and docstrings, and improving instructions for using TLS.
5. Switched to BoringSSL for local development and ignored .pem files for security.</pre></z><z id="t1693544622" t="Matthew Davidson (kingmob) Also, there&apos;s no way in hell I remembered that git log command. I asked GPT for that too. ‚ùØ sgpt --chat git &apos;how do i display the all git logs up to tag 0.7.0-alpha1?&apos; To display all git logs up to tag 0.7.0-alpha1, you can use the following command: git log --until=0.7.0-alpha1 This command will show all the commit logs leading up to the specified tag. ‚ùØ sgpt --chat git &apos;sorry, i mean git logs AFTER tag 0.7.0-alpha1. Also, how do I show only the commit messages?&apos; To display all git logs after tag 0.7.0-alpha1, you can use the following command: git log 0.7.0-alpha1.. This command will show all the commit logs after the specified tag. To show only the commit messages, you can use the `--oneline` option with the `git log` command: git log --oneline 0.7.0-alpha1.. This command will display only the commit messages in a condensed format. Each commit message will be shown on a single line. ‚ùØ sgpt --chat git &apos;is there a way to suppress the sha too?&apos; Yes, you can suppress the SHA (commit hash) from being displayed in the git log output by using the `--pretty=format` option with the `git log` command. Here&apos;s an example: git log --oneline --pretty=format:&quot;%s&quot; 0.7.0-alpha1.. In this command, `%s` is the format specifier for the commit subject (commit message). By specifying `%s` as the format, only the commit messages will be displayed, and the commit hashes will be suppressed. "><y>#</y><d>2023-09-01</d><h>05:03</h><r>Matthew Davidson (kingmob)</r>Also, there&apos;s no way in hell I remembered that git log command. I asked GPT for that too.

<pre>‚ùØ sgpt --chat git &apos;how do i display the all git logs up to tag 0.7.0-alpha1?&apos;

To display all git logs up to tag 0.7.0-alpha1, you can use the following command:

</pre>
git log --until=0.7.0-alpha1
<pre>This command will show all the commit logs leading up to the specified tag.

‚ùØ sgpt --chat git &apos;sorry, i mean git logs AFTER tag 0.7.0-alpha1. Also, how do I show only the commit messages?&apos;

To display all git logs after tag 0.7.0-alpha1, you can use the following command:

</pre>
git log 0.7.0-alpha1..
<pre>This command will show all the commit logs after the specified tag.

To show only the commit messages, you can use the `--oneline` option with the `git log` command:

</pre>
git log --oneline 0.7.0-alpha1..
<pre>This command will display only the commit messages in a condensed format. Each commit message will be shown on a single line.

‚ùØ sgpt --chat git &apos;is there a way to suppress the sha too?&apos;

Yes, you can suppress the SHA (commit hash) from being displayed in the git log output by using the `--pretty=format` option with the `git log` command. Here&apos;s an example:

</pre>
git log --oneline --pretty=format:&quot;%s&quot; 0.7.0-alpha1..
<pre>In this command, `%s` is the format specifier for the commit subject (commit message). By specifying `%s` as the format, only the commit messages will be displayed, and the commit hashes will be suppressed.</pre>
</z><z id="t1694889924" t="Giorgos Makris Hello! Is this the right place to ask for some help with aleph?"><y>#</y><d>2023-09-16</d><h>18:45</h><w>Giorgos Makris</w>Hello! Is this the right place to ask for some help with aleph?</z><z id="t1694890016" t="oyakushev Yes"><y>#</y><d>2023-09-16</d><h>18:46</h><r>oyakushev</r>Yes</z><z id="t1694890133" t="Giorgos Makris I&apos;m trying to build something with websockets and my code right now looks like this: (ns project.server (:require [reitit.ring :refer [router ring-handler]] [aleph.http :as http] [manifold.stream :as s] [manifold.deferred :as d] [clojure.tools.logging :as log])) (defn join-session [request] (with-path-params [session-id] request (let [session-uuid (parse-uuid session-id)] (if-let [session (@sessions session-uuid)] (do (log/infof &quot;Connected in session &apos;%s&apos;&quot; session-id) (-&gt; request http/websocket-connection (d/chain #(join-session! % session-uuid session)))) (do (log/warnf &quot;Rejected for session &apos;%s&apos;: Session not found!&quot; session-id) (-&gt; request http/websocket-connection (http/websocket-close! 3404 &quot;No session found!&quot;)) {:status 404 :body &quot;Session not found&quot;}))))) (def routes [[&quot;/ping&quot; {:get (fn [_] {:status 200 :body &quot;pong&quot;})}] [&quot;/session&quot; {:get start-session}] [&quot;/session/:session-id&quot; {:get join-session}]]) (def app (-&gt; routes router ring-handler)) (defn start-server [] (when-not @server (let [port 8080] (reset! server (http/start-server #&apos;app {:port port})) (log/infof &quot;Started server at port %d&quot; port)))) "><y>#</y><d>2023-09-16</d><h>18:48</h><r>Giorgos Makris</r>I&apos;m trying to build something with websockets and my code right now looks like this:
<pre>(ns project.server
  (:require
   [reitit.ring :refer [router ring-handler]]
   [aleph.http :as http]
   [manifold.stream :as s]
   [manifold.deferred :as d]
   [clojure.tools.logging :as log]))

(defn join-session
  [request]
  (with-path-params [session-id] request
    (let [session-uuid (parse-uuid session-id)]
      (if-let [session (@sessions session-uuid)]
        (do
          (log/infof &quot;Connected in session &apos;%s&apos;&quot; session-id)
          (-&gt; request
              http/websocket-connection
              (d/chain #(join-session! % session-uuid session))))
        (do
          (log/warnf &quot;Rejected for session &apos;%s&apos;: Session not found!&quot; session-id)
          (-&gt; request
              http/websocket-connection
              (http/websocket-close! 3404 &quot;No session found!&quot;))
          {:status 404 :body &quot;Session not found&quot;})))))

(def routes
  [[&quot;/ping&quot; {:get (fn [_]
                    {:status 200 :body &quot;pong&quot;})}]
   [&quot;/session&quot; {:get start-session}]
   [&quot;/session/:session-id&quot; {:get join-session}]])

(def app (-&gt; routes
             router
             ring-handler))

(defn start-server
  []
  (when-not @server
    (let [port 8080]
      (reset! server
              (http/start-server #&apos;app
                                 {:port port}))
      (log/infof &quot;Started server at port %d&quot; port))))</pre>
</z><z id="t1694890272" t="Giorgos Makris My issue seems to be trying to initiate the websocket connection: java.lang.ClassCastException: class manifold.deferred.Deferred cannot be cast to class manifold.stream.core.IEventSink (manifold.deferred.Deferred is in unnamed module of loader clojure.lang.DynamicClassLoader @3e9b3b3c; manifold.stream.core.IEventSink is in unnamed module of loader clojure.lang.DynamicClassLoader @73db7df0) at aleph.http.websocket.common$websocket_close_BANG_.invokeStatic(common.clj:114) ~[?:?] at aleph.http.websocket.common$websocket_close_BANG_.invoke(common.clj:106) ~[?:?] at aleph.http$websocket_close_BANG_.invokeStatic(http.clj:293) ~[?:?] at aleph.http$websocket_close_BANG_.invoke(http.clj:278) ~[?:?] at aleph.http$websocket_close_BANG_.invokeStatic(http.clj:290) ~[?:?] at aleph.http$websocket_close_BANG_.invoke(http.clj:278) ~[?:?] at project.server$join_session.invokeStatic(form-init2560565438093657059.clj:77) ~[?:?] at project.server$join_session.invoke(form-init2560565438093657059.clj:63) ~[?:?] at project.server$wrap_deferred$fn__22637.invoke(server.clj:34) ~[?:?] at reitit.ring$ring_handler$fn__2363.invoke(ring.cljc:351) ~[?:?] at clojure.lang.AFn.applyToHelper(AFn.java:154) ~[clojure-1.11.1.jar:?] at clojure.lang.AFn.applyTo(AFn.java:144) ~[clojure-1.11.1.jar:?] at clojure.lang.AFunction$1.doInvoke(AFunction.java:31) ~[clojure-1.11.1.jar:?] at clojure.lang.RestFn.invoke(RestFn.java:408) ~[clojure-1.11.1.jar:?] at clojure.lang.Var.invoke(Var.java:384) ~[clojure-1.11.1.jar:?] at aleph.http.server$handle_request$fn__13744$f__3077__auto____13745.invoke(server.clj:166) ~[?:?] at clojure.lang.AFn.run(AFn.java:22) ~[clojure-1.11.1.jar:?] at io.aleph.dirigiste.Executor$Worker$1.run(Executor.java:62) ~[dirigiste-1.0.3.jar:?] at manifold.executor$thread_factory$reify__2955$f__2956.invoke(executor.clj:70) ~[?:?] at clojure.lang.AFn.run(AFn.java:22) ~[clojure-1.11.1.jar:?] at java.lang.Thread.run(Thread.java:1623) [?:?] "><y>#</y><d>2023-09-16</d><h>18:51</h><r>Giorgos Makris</r>My issue seems to be trying to initiate the websocket connection:
<pre>java.lang.ClassCastException: class manifold.deferred.Deferred cannot be cast to class manifold.stream.core.IEventSink (manifold.deferred.Deferred is in unnamed module of loader clojure.lang.DynamicClassLoader @3e9b3b3c; manifold.stream.core.IEventSink is in unnamed module of loader clojure.lang.DynamicClassLoader @73db7df0)
	at aleph.http.websocket.common$websocket_close_BANG_.invokeStatic(common.clj:114) ~[?:?]
	at aleph.http.websocket.common$websocket_close_BANG_.invoke(common.clj:106) ~[?:?]
	at aleph.http$websocket_close_BANG_.invokeStatic(http.clj:293) ~[?:?]
	at aleph.http$websocket_close_BANG_.invoke(http.clj:278) ~[?:?]
	at aleph.http$websocket_close_BANG_.invokeStatic(http.clj:290) ~[?:?]
	at aleph.http$websocket_close_BANG_.invoke(http.clj:278) ~[?:?]
	at project.server$join_session.invokeStatic(form-init2560565438093657059.clj:77) ~[?:?]
	at project.server$join_session.invoke(form-init2560565438093657059.clj:63) ~[?:?]
	at project.server$wrap_deferred$fn__22637.invoke(server.clj:34) ~[?:?]
	at reitit.ring$ring_handler$fn__2363.invoke(ring.cljc:351) ~[?:?]
	at clojure.lang.AFn.applyToHelper(AFn.java:154) ~[clojure-1.11.1.jar:?]
	at clojure.lang.AFn.applyTo(AFn.java:144) ~[clojure-1.11.1.jar:?]
	at clojure.lang.AFunction$1.doInvoke(AFunction.java:31) ~[clojure-1.11.1.jar:?]
	at clojure.lang.RestFn.invoke(RestFn.java:408) ~[clojure-1.11.1.jar:?]
	at clojure.lang.Var.invoke(Var.java:384) ~[clojure-1.11.1.jar:?]
	at aleph.http.server$handle_request$fn__13744$f__3077__auto____13745.invoke(server.clj:166) ~[?:?]
	at clojure.lang.AFn.run(AFn.java:22) ~[clojure-1.11.1.jar:?]
	at io.aleph.dirigiste.Executor$Worker$1.run(Executor.java:62) ~[dirigiste-1.0.3.jar:?]
	at manifold.executor$thread_factory$reify__2955$f__2956.invoke(executor.clj:70) ~[?:?]
	at clojure.lang.AFn.run(AFn.java:22) ~[clojure-1.11.1.jar:?]
	at java.lang.Thread.run(Thread.java:1623) [?:?]</pre>
</z><z id="t1694890298" t="Giorgos Makris I looked through the examples for websockets but I must be missing something really obvious"><y>#</y><d>2023-09-16</d><h>18:51</h><r>Giorgos Makris</r>I looked through the examples for websockets but I must be missing something really obvious</z><z id="t1694890910" t="oyakushev I havent&apos; worked with websockets in Aleph, but it seems like http/websocket-connection returns a deferred, so when you close it, you have to chain it, not just use a threading macro"><y>#</y><d>2023-09-16</d><h>19:01</h><r>oyakushev</r>I havent&apos; worked with websockets in Aleph, but it seems like <code>http/websocket-connection</code> returns a deferred, so when you close it, you have to chain it, not just use a threading macro</z><z id="t1694890925" t="oyakushev (-&gt; request http/websocket-connection (d/chain #(http/websocket-close! % 3404 &quot;No session found!&quot;)))"><y>#</y><d>2023-09-16</d><h>19:02</h><r>oyakushev</r><pre>(-&gt; request
              http/websocket-connection
              (d/chain #(http/websocket-close! % 3404 &quot;No session found!&quot;)))</pre></z></g><g id="s10"><z id="t1694891246" t="Giorgos Makris ah, that is reasonable, i&apos;ll give it a try. thanks üòÑ"><y>#</y><d>2023-09-16</d><h>19:07</h><r>Giorgos Makris</r>ah, that is reasonable, i&apos;ll give it a try. thanks <b>üòÑ</b></z><z id="t1694893066" t="Giorgos Makris that and forgetting to add (d/chain #(s/connect % %)) solved my issue, thanks again"><y>#</y><d>2023-09-16</d><h>19:37</h><r>Giorgos Makris</r>that and forgetting to add <code>(d/chain #(s/connect % %))</code>solved my issue, thanks again</z><z id="t1695627171" t="Matthew Davidson (kingmob) Fast and furious standards-debating action! üòÑ https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0183.html I&apos;m trialling h2spec to validate Aleph&apos;s H2 server behavior, and on one of h2spec&apos;s issues, I responded with a disagreement about an interpretation of https://www.rfc-editor.org/rfc/rfc9113.html . After a little back and forth, I asked one of the RFC authors for clarification, he put it to the HTTP working group, and...there doesn&apos;t seem to be agreement among the experts, unfortunately. Since Aleph&apos;s not wedded to an implementation yet, do users have a preference for HTTP errors? Specifically, if it&apos;s possible, would you prefer HTTP 4xx/5xx responses (when possible) or &quot;reset stream&quot;/&quot;go away&quot; errors? The HTTP 4xx/5xx responses have the advantage of being able to provide a specific error message in the body. The &quot;reset stream&quot;/&quot;go away&quot; frames are handled via exception mechanisms (since the client will probably never get an HTTP response after getting RST_STREAM/GOAWAY), so you will get instant feedback that something went wrong. Their disadvantage is the available https://www.rfc-editor.org/rfc/rfc9113.html#name-error-codes are pretty generic, more so than even HTTP status codes."><y>#</y><d>2023-09-25</d><h>07:32</h><w>Matthew Davidson (kingmob)</w>Fast and furious standards-debating action! <b>üòÑ</b> <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0183.html" target="_blank">https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0183.html</a>

I&apos;m trialling h2spec to validate Aleph&apos;s H2 server behavior, and on one of h2spec&apos;s issues, I responded with a disagreement about an interpretation of <a href="https://www.rfc-editor.org/rfc/rfc9113.html" target="_blank">https://www.rfc-editor.org/rfc/rfc9113.html</a>. After a little back and forth, I asked one of the RFC authors for clarification, he put it to the HTTP working group, and...there doesn&apos;t seem to be agreement among the experts, unfortunately.

Since Aleph&apos;s not wedded to an implementation yet, do users have a preference for HTTP errors? Specifically, if it&apos;s possible, would you prefer HTTP 4xx/5xx responses (when possible) or &quot;reset stream&quot;/&quot;go away&quot; errors? The HTTP 4xx/5xx responses have the advantage of being able to provide a specific error message in the body. The &quot;reset stream&quot;/&quot;go away&quot; frames are handled via exception mechanisms (since the client will probably never get an HTTP response after getting RST_STREAM/GOAWAY), so you will get instant feedback that something went wrong. Their disadvantage is the available <a href="https://www.rfc-editor.org/rfc/rfc9113.html#name-error-codes" target="_blank">https://www.rfc-editor.org/rfc/rfc9113.html#name-error-codes</a> are pretty generic, more so than even HTTP status codes.</z><z id="t1695630128" t="Stef Coetzee By no means an authority on the subject, but +1 for HTTP responses when possible."><y>#</y><d>2023-09-25</d><h>08:22</h><r>Stef Coetzee</r>By no means an authority on the subject, but +1 for HTTP responses when possible.</z><z id="t1695635495" t="dergutemoritz Ho boy üôà Glad to see that even the Big Boys ‚Ñ¢Ô∏è have these kinds of issues. Hits quite close to home with regards to similar issues we&apos;re debating on our custom protocol üòÑ FWIW, I find https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0188.html and https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0197.html to be very reasonable interpretations"><y>#</y><d>2023-09-25</d><h>09:51</h><r>dergutemoritz</r>Ho boy <b>üôà</b>  Glad to see that even the Big Boys <b>‚Ñ¢Ô∏è</b>  have these kinds of issues. Hits quite close to home with regards to similar issues we&apos;re debating on our custom protocol <b>üòÑ</b>  FWIW, I find <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0188.html" target="_blank">https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0188.html</a> and <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0197.html" target="_blank">https://lists.w3.org/Archives/Public/ietf-http-wg/2023JulSep/0197.html</a> to be very reasonable interpretations</z><z id="t1695682312" t="valerauko reading that paragraph i get the impression that you must give the reset stream/go away errors, but you may also send a http response. if so i&apos;d do both where possible (the more info the better)"><y>#</y><d>2023-09-25</d><h>22:51</h><r>valerauko</r>reading that paragraph i get the impression that you must give the reset stream/go away errors, but you may also send a http response. if so i&apos;d do both where possible (the more info the better)</z><z id="t1695697571" t="Matthew Davidson (kingmob) The more I think about it, the more I&apos;m leaning towards both. Response, then RST_STREAM. This assumes that can be done safely, but for us, it originally arose in the context of missing pseudo-headers, where it should be fine."><y>#</y><d>2023-09-26</d><h>03:06</h><r>Matthew Davidson (kingmob)</r>The more I think about it, the more I&apos;m leaning  towards both. Response, then RST_STREAM. 

This assumes that can be done safely, but for us, it originally arose in the context of missing pseudo-headers, where it should be fine.</z><z id="t1695697824" t="Matthew Davidson (kingmob) Where it gets tricky is if a stream error arises after the user handler has been called, in which case, we can&apos;t send an HTTP response, because the user handler may have already started writing. "><y>#</y><d>2023-09-26</d><h>03:10</h><r>Matthew Davidson (kingmob)</r>Where it gets tricky is if a stream error arises after the user handler has been called, in which case, we can&apos;t send an HTTP response, because the user handler may have already started writing. </z><z id="t1695697981" t="Matthew Davidson (kingmob) That&apos;s probably rare for simple request / response streams, but more likely for long-lived streams that are, errr, streaming."><y>#</y><d>2023-09-26</d><h>03:13</h><r>Matthew Davidson (kingmob)</r>That&apos;s probably rare for simple request / response streams, but more likely for long-lived streams that are, errr, streaming.</z><z id="t1695719190" t="dergutemoritz Right, in the latter case, I think the only option is RST_STREAM"><y>#</y><d>2023-09-26</d><h>09:06</h><r>dergutemoritz</r>Right, in the latter case, I think the only option is RST_STREAM</z><z id="t1695719207" t="dergutemoritz I agree: Where possible, do both"><y>#</y><d>2023-09-26</d><h>09:06</h><r>dergutemoritz</r>I agree: Where possible, do both</z><z id="t1695719226" t="dergutemoritz (which is also what the posts I linked to reason for)"><y>#</y><d>2023-09-26</d><h>09:07</h><r>dergutemoritz</r>(which is also what the posts I linked to reason for)</z><z id="t1695719400" t="dergutemoritz Question: Does Aleph apply backpressure on outbound traffic anywhere? I know that it does so for inbound traffic (by toggling autoread) but so far I haven&apos;t seen anything for outbound traffic. Looks like writes are just queued without bounds :thinking_face:"><y>#</y><d>2023-09-26</d><h>09:10</h><w>dergutemoritz</w>Question: Does Aleph apply backpressure on outbound traffic anywhere? I know that it does so for inbound traffic (by toggling autoread) but so far I haven&apos;t seen anything for outbound traffic. Looks like writes are just queued without bounds <b>:thinking_face:</b></z><z id="t1695824847" t="dergutemoritz This can of course be implemented in user code but it seems like a dangerous default..! Then again, Netty also punts this (see e.g. https://github.com/netty/netty/pull/6662 )."><y>#</y><d>2023-09-27</d><h>14:27</h><r>dergutemoritz</r>This can of course be implemented in user code but it seems like a dangerous default..! Then again, Netty also punts this (see e.g. <a href="https://github.com/netty/netty/pull/6662" target="_blank">https://github.com/netty/netty/pull/6662</a>).</z><z id="t1696229421" t="Matthew Davidson (kingmob) Fundamentally, users also have to respect backpressure signals and deal with some of it in their own handlers if they want the best possible response. There&apos;s only so much aleph/manifold/netty can do for you, especially if there are inputs coming from outside that aleph/netty aren&apos;t aware of."><y>#</y><d>2023-10-02</d><h>06:50</h><r>Matthew Davidson (kingmob)</r>Fundamentally, users also have to respect backpressure signals and deal with some of it in their own handlers if they want the best possible response. There&apos;s only so much aleph/manifold/netty can do for you, especially if there are inputs coming from outside that aleph/netty aren&apos;t aware of.</z><z id="t1696586292" t="Matthew Davidson (kingmob) I&apos;d like to get a sense of how people are using the pipeline-transform option. If you&apos;re using it for anything, mind telling us a bit about what you use it for? It&apos;s shaping up to be one of the truly non-backwards-compatible parts of the HTTP/2 code, since thanks to multiplexing, there will now be one shared connection-level pipeline, and one stream-level pipeline for each stream."><y>#</y><d>2023-10-06</d><h>09:58</h><w>Matthew Davidson (kingmob)</w>I&apos;d like to get a sense of how people are using the <code>pipeline-transform</code> option. If you&apos;re using it for anything, mind telling us a bit about what you use it for?

It&apos;s shaping up to be one of the truly non-backwards-compatible parts of the HTTP/2 code, since thanks to multiplexing, there will now be one shared connection-level pipeline, and one stream-level pipeline for each stream.</z><z id="t1696596220" t="oyakushev My standard usecase for it is adding HttpObjectAggregator to the pipeline, both for server and client connections."><y>#</y><d>2023-10-06</d><h>12:43</h><r>oyakushev</r>My standard usecase for it is adding HttpObjectAggregator to the pipeline, both for server and client connections.</z><z id="t1696596938" t="Matthew Davidson (kingmob) Oh, interesting. Why do you add it? Is it to avoid dealing with InputStreams that are still being written to? Or something else? When people set max-request-body-size , Aleph adds it by default, if that&apos;s your use case."><y>#</y><d>2023-10-06</d><h>12:55</h><r>Matthew Davidson (kingmob)</r>Oh, interesting. Why do you add it? Is it to avoid dealing with InputStreams that are still being written to? Or something else?

When people set <code>max-request-body-size</code>, Aleph adds it by default, if that&apos;s your use case.</z><z id="t1696599537" t="oyakushev Yes, it&apos;s both for being able to safely slurp the :body inputstream without worrying about blocking, and for limiting the max body size. I&apos;ve put these middlewares to pipeline-transform back when the max-request-body-size was not done/merged, and the code kinda stuck around."><y>#</y><d>2023-10-06</d><h>13:38</h><r>oyakushev</r>Yes, it&apos;s both for being able to safely slurp the :body inputstream without worrying about blocking, and for limiting the max body size. I&apos;ve put these middlewares to pipeline-transform back when the <code>max-request-body-size</code> was not done/merged, and the code kinda stuck around.</z><z id="t1696601886" t="Arnaud Geiser To copy the &quot;Expect&quot; header before it got removed by the continue-handler https://github.com/clj-commons/aleph/pull/686#issuecomment-1673837252"><y>#</y><d>2023-10-06</d><h>14:18</h><r>Arnaud Geiser</r>To copy the &quot;Expect&quot; header before it got removed by the continue-handler <a href="https://github.com/clj-commons/aleph/pull/686#issuecomment-1673837252" target="_blank">https://github.com/clj-commons/aleph/pull/686#issuecomment-1673837252</a></z><z id="t1696601941" t="Arnaud Geiser (Edge case of the S3 API which supports only HTTP1.1 AFAIK)"><y>#</y><d>2023-10-06</d><h>14:19</h><r>Arnaud Geiser</r>(Edge case of the S3 API which supports only HTTP1.1 AFAIK)</z><z id="t1696677234" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] We could make aggregation a more general option, so people don&apos;t have to fiddle with pipeline-transform. I thought most people were using bs/to-string or similar fns to avoid dealing with InputStreams, but maybe that&apos;s not true?"><y>#</y><d>2023-10-07</d><h>11:13</h><r>Matthew Davidson (kingmob)</r><a>@U06PNK4HG</a> We could make aggregation a more general option, so people don&apos;t have to fiddle with pipeline-transform.

I thought most people were using <code>bs/to-string</code> or similar fns to avoid dealing with InputStreams, but maybe that&apos;s not true?</z><z id="t1696678125" t="oyakushev bs/to-string would allocate an extra string which I don&apos;t really need since I&apos;m going to parse the JSON body into maps anyway."><y>#</y><d>2023-10-07</d><h>11:28</h><r>oyakushev</r><code>bs/to-string</code> would allocate an extra string which I don&apos;t really need since I&apos;m going to parse the JSON body into maps anyway.</z><z id="t1696678236" t="oyakushev The changes won&apos;t affect me directly since we stay on our fork of Aleph. I&apos;m just voicing out the usecase, I certainly don&apos;t know if the way we do it right now is the best one:)"><y>#</y><d>2023-10-07</d><h>11:30</h><r>oyakushev</r>The changes won&apos;t affect me directly since we stay on our fork of Aleph. I&apos;m just voicing out the usecase, I certainly don&apos;t know if the way we do it right now is the best one:)</z><z id="t1696835462" t="Matthew Davidson (kingmob) Well, one thing&apos;s for certain: for anyone using HTTP1 objects/handlers in their pipeline-transform , which is probably everyone, none of that will work unaltered. The impls are a just a little too different, Netty doesn&apos;t share 99% of the code between h1 and h2, not even interfaces. One solution for many people will be to insert the Http2StreamFrameToHttpObjectCodec at the top of the stream channel. However, I don&apos;t think I can do that automatically in case users want to do something with the H2 objects. Other issues are deciding between connection-level vs stream-level pipelines and sharing a stateful h1 handler across multiple stream-level pipelines. I think it&apos;s fair that anyone mucking around with Netty pipelines shouldn&apos;t be isolated from the upcoming changes. To that end, I&apos;m thinking of making three options: 1. http1-pipeline-transform - the current pipeline-transform will be made an alias for this 2. http2-conn-pipeline-transform - will alter the shared connection pipeline 3. http2-stream-pipeline-transform - will alter each h2 stream pipeline I think as a safety check, if you enable h2 and set pipeline-transform , we should throw an error if you haven&apos;t set either http2-conn-pipeline-transform or http2-stream-pipeline-transform . I also think an aggregation flag might be handy, maybe aggregate-data , wait-for-body-to-finish or something, combined with some timeout and/or min amount of data before proceeding, lest it hang on a large/infinite body. Thoughts?"><y>#</y><d>2023-10-09</d><h>07:11</h><r>Matthew Davidson (kingmob)</r>Well, one thing&apos;s for certain: for anyone using HTTP1 objects/handlers in their <code>pipeline-transform</code>, which is probably everyone, none of that will work unaltered. The impls are a just a little too different, Netty doesn&apos;t share 99% of the code between h1 and h2, not even interfaces.

One solution for many people will be to insert the <code>Http2StreamFrameToHttpObjectCodec</code> at the top of the stream channel. However, I don&apos;t think I can do that automatically in case users want to do something with the H2 objects.

Other issues are deciding between connection-level vs stream-level pipelines and  sharing a stateful h1 handler across multiple stream-level pipelines.

I think it&apos;s fair that anyone mucking around with Netty pipelines shouldn&apos;t be isolated from the upcoming changes. To that end, I&apos;m thinking of making three options:

1. http1-pipeline-transform - the current pipeline-transform will be made an alias for this
2. http2-conn-pipeline-transform - will alter the shared connection pipeline
3. http2-stream-pipeline-transform - will alter each h2 stream pipeline
I think as a safety check, if you enable h2 and set <code>pipeline-transform</code>, we should throw an error if you haven&apos;t set either <code>http2-conn-pipeline-transform</code> or <code>http2-stream-pipeline-transform</code> .

I also think an aggregation flag might be handy, maybe <code>aggregate-data</code>, <code>wait-for-body-to-finish</code> or something, combined with some timeout and/or min amount of data before proceeding, lest it hang on a large/infinite body.

Thoughts?</z><z id="t1696850562" t="Matthew Davidson (kingmob) Wrote up an issue at https://github.com/clj-commons/aleph/issues/692 , pelase add comments there"><y>#</y><d>2023-10-09</d><h>11:22</h><r>Matthew Davidson (kingmob)</r>Wrote up an issue at <a href="https://github.com/clj-commons/aleph/issues/692" target="_blank">https://github.com/clj-commons/aleph/issues/692</a>, pelase add comments there</z><z id="t1696851660" t="dergutemoritz re safety check: that error would not be thrown when only setting http1-pipeline-transform instead? Would make sense IMHO if you intentionally want to modify the pipeline only for HTTP 1 for some reason."><y>#</y><d>2023-10-09</d><h>11:41</h><r>dergutemoritz</r>re safety check: that error would not be thrown when only setting <code>http1-pipeline-transform</code> instead? Would make sense IMHO if you intentionally want to modify the pipeline only for HTTP 1 for some reason.</z><z id="t1696851828" t="dergutemoritz as for pipeline-transform uses: We use it for adding a read timeout handler. ~This turns out to be trickier than expected due to HTTP keep-alive. I&apos;ll elaborate on the ticket.~ (never mind, that&apos;s due to an implementation detail on our end)"><y>#</y><d>2023-10-09</d><h>11:43</h><r>dergutemoritz</r>as for <code>pipeline-transform</code> uses: We use it for adding a read timeout handler. ~This turns out to be trickier than expected due to HTTP keep-alive. I&apos;ll elaborate on the ticket.~ (never mind, that&apos;s due to an implementation detail on our end)</z><z id="t1696857409" t="Matthew Davidson (kingmob) Do the idle handlers not meet your needs for some reason?"><y>#</y><d>2023-10-09</d><h>13:16</h><r>Matthew Davidson (kingmob)</r>Do the idle handlers not meet your needs for some reason?</z><z id="t1696859086" t="dergutemoritz Right, that&apos;s what I was hinting at: With connection keep-alive (especially so when sitting behind a proxy), setting the timeout low enough to serve as a read timeout, the connection would often get closed in between two requests for no good reason. In our particular case, we&apos;re doing long polling where we keep a requests open for up to 5 seconds. Thus, we have to set idle timeout to something higher than 5 seconds. But that is way too high to serve as a read timeout at the same time."><y>#</y><d>2023-10-09</d><h>13:44</h><r>dergutemoritz</r>Right, that&apos;s what I was hinting at: With connection keep-alive (especially so when sitting behind a proxy), setting the timeout low enough to serve as a read timeout, the connection would often get closed in between two requests for no good reason. In our particular case, we&apos;re doing long polling where we keep a requests open for up to 5 seconds. Thus, we have to set idle timeout to something higher than 5 seconds. But that is way too high to serve as a read timeout at the same time.</z><z id="t1696835462" t="Matthew Davidson (kingmob) Well, one thing&apos;s for certain: for anyone using HTTP1 objects/handlers in their pipeline-transform , which is probably everyone, none of that will work unaltered. The impls are a just a little too different, Netty doesn&apos;t share 99% of the code between h1 and h2, not even interfaces. One solution for many people will be to insert the Http2StreamFrameToHttpObjectCodec at the top of the stream channel. However, I don&apos;t think I can do that automatically in case users want to do something with the H2 objects. Other issues are deciding between connection-level vs stream-level pipelines and sharing a stateful h1 handler across multiple stream-level pipelines. I think it&apos;s fair that anyone mucking around with Netty pipelines shouldn&apos;t be isolated from the upcoming changes. To that end, I&apos;m thinking of making three options: 1. http1-pipeline-transform - the current pipeline-transform will be made an alias for this 2. http2-conn-pipeline-transform - will alter the shared connection pipeline 3. http2-stream-pipeline-transform - will alter each h2 stream pipeline I think as a safety check, if you enable h2 and set pipeline-transform , we should throw an error if you haven&apos;t set either http2-conn-pipeline-transform or http2-stream-pipeline-transform . I also think an aggregation flag might be handy, maybe aggregate-data , wait-for-body-to-finish or something, combined with some timeout and/or min amount of data before proceeding, lest it hang on a large/infinite body. Thoughts?"><y>#</y><d>2023-10-09</d><h>07:11</h><w>Matthew Davidson (kingmob)</w>Well, one thing&apos;s for certain: for anyone using HTTP1 objects/handlers in their <code>pipeline-transform</code>, which is probably everyone, none of that will work unaltered. The impls are a just a little too different, Netty doesn&apos;t share 99% of the code between h1 and h2, not even interfaces.

One solution for many people will be to insert the <code>Http2StreamFrameToHttpObjectCodec</code> at the top of the stream channel. However, I don&apos;t think I can do that automatically in case users want to do something with the H2 objects.

Other issues are deciding between connection-level vs stream-level pipelines and  sharing a stateful h1 handler across multiple stream-level pipelines.

I think it&apos;s fair that anyone mucking around with Netty pipelines shouldn&apos;t be isolated from the upcoming changes. To that end, I&apos;m thinking of making three options:

1. http1-pipeline-transform - the current pipeline-transform will be made an alias for this
2. http2-conn-pipeline-transform - will alter the shared connection pipeline
3. http2-stream-pipeline-transform - will alter each h2 stream pipeline
I think as a safety check, if you enable h2 and set <code>pipeline-transform</code>, we should throw an error if you haven&apos;t set either <code>http2-conn-pipeline-transform</code> or <code>http2-stream-pipeline-transform</code> .

I also think an aggregation flag might be handy, maybe <code>aggregate-data</code>, <code>wait-for-body-to-finish</code> or something, combined with some timeout and/or min amount of data before proceeding, lest it hang on a large/infinite body.

Thoughts?</z><z id="t1697092684" t="Stefan Hi! Today a new CVE in netty popped up that affects the version Aleph is currently using. Bumping netty to 4.1.100.Final should fix this. (Do you want me to create a ticket/PR?) This however raises the question: for production, should I be using the 0.7.0 alpha versions, or should I stick to 0.6.x ?"><y>#</y><d>2023-10-12</d><h>06:38</h><w>Stefan</w>Hi! Today a new CVE in netty popped up that affects the version Aleph is currently using. Bumping netty to <code>4.1.100.Final</code> should fix this. (Do you want me to create a ticket/PR?) This however raises the question: for production, should I be using the <code>0.7.0</code> alpha versions, or should I stick to <code>0.6.x</code>?</z><z id="t1697121637" t="dergutemoritz Note that the CVE only affects the HTTP/2 server implementation of Netty which is not yet exposed by Aleph"><y>#</y><d>2023-10-12</d><h>14:40</h><r>dergutemoritz</r>Note that the CVE only affects the HTTP/2 server implementation of Netty which is not yet exposed by Aleph</z><z id="t1697121688" t="dergutemoritz However, bumping the Netty version would still make sense, if only to silence automated vulnerability checkers üôÇ"><y>#</y><d>2023-10-12</d><h>14:41</h><r>dergutemoritz</r>However, bumping the Netty version would still make sense, if only to silence automated vulnerability checkers <b>üôÇ</b></z><z id="t1697121696" t="dergutemoritz PR welcome!"><y>#</y><d>2023-10-12</d><h>14:41</h><r>dergutemoritz</r>PR welcome!</z><z id="t1697121716" t="dergutemoritz Note that you can also override the Netty version on your end"><y>#</y><d>2023-10-12</d><h>14:41</h><r>dergutemoritz</r>Note that you can also override the Netty version on your end</z><z id="t1697121736" t="dergutemoritz so you could stick on 0.6.x for prod and update it to the latest Netty on your end"><y>#</y><d>2023-10-12</d><h>14:42</h><r>dergutemoritz</r>so you could stick on 0.6.x for prod and update it to the latest Netty on your end</z><z id="t1697121742" t="dergutemoritz which is what I would recommend"><y>#</y><d>2023-10-12</d><h>14:42</h><r>dergutemoritz</r>which is what I would recommend</z><z id="t1697178731" t="Matthew Davidson (kingmob) Hi [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] , can you share a link to the CVE you&apos;re concerned about? We&apos;ve tried to be very responsive when people bring them up in the past, and usually it&apos;s pretty easy to just upgrade Netty. But, as I&apos;ve learned a little more about the CVE landscape, the picture looks a slightly less rosy: mischaracterized/overhyped severities, ignoring relevant authorities, etc. Because of that, I&apos;d now like to review CVEs before making decisions. Even a simple Netty upgrade still requires checking the changelog (and Netty is a large project) to ensure nothing will break."><y>#</y><d>2023-10-13</d><h>06:32</h><r>Matthew Davidson (kingmob)</r>Hi <a>@UGNFXV1FA</a>, can you share a link to the CVE you&apos;re concerned about?

We&apos;ve tried to be very responsive when people bring them up in the past, and usually it&apos;s pretty easy to just upgrade Netty.

But, as I&apos;ve learned a little more about the CVE landscape, the picture looks a slightly less rosy: mischaracterized/overhyped severities, ignoring relevant authorities, etc.

Because of that, I&apos;d now like to review CVEs before making decisions. Even a simple Netty upgrade still requires checking the changelog (and Netty is a large project) to ensure nothing will break.</z><z id="t1697178859" t="Stefan Sure, should have done that right away, sorry about that. I&apos;m looking it up..."><y>#</y><d>2023-10-13</d><h>06:34</h><r>Stefan</r>Sure, should have done that right away, sorry about that. I&apos;m looking it up...</z><z id="t1697179111" t="Stefan https://nvd.nist.gov/vuln/search/results?form_type=Advanced&amp;amp;results_type=overview&amp;amp;search_type=all&amp;amp;cpe_vendor=cpe%3A%2F%3Anetty&amp;amp;cpe_product=cpe%3A%2F%3Anetty%3Anetty&amp;amp;cpe_version=cpe%3A%2F%3Anetty%3Anetty%3A4.1.94"><y>#</y><d>2023-10-13</d><h>06:38</h><r>Stefan</r><a href="https://nvd.nist.gov/vuln/search/results?form_type=Advanced&amp;amp;results_type=overview&amp;amp;search_type=all&amp;amp;cpe_vendor=cpe%3A%2F%3Anetty&amp;amp;cpe_product=cpe%3A%2F%3Anetty%3Anetty&amp;amp;cpe_version=cpe%3A%2F%3Anetty%3Anetty%3A4.1.94" target="_blank">https://nvd.nist.gov/vuln/search/results?form_type=Advanced&amp;amp;results_type=overview&amp;amp;search_type=all&amp;amp;cpe_vendor=cpe%3A%2F%3Anetty&amp;amp;cpe_product=cpe%3A%2F%3Anetty%3Anetty&amp;amp;cpe_version=cpe%3A%2F%3Anetty%3Anetty%3A4.1.94</a></z><z id="t1697179118" t="Stefan It appears to be that CVE-2023-4586 again. Maybe they did something in Netty to resolve it or something?"><y>#</y><d>2023-10-13</d><h>06:38</h><r>Stefan</r>It appears to be that CVE-2023-4586 again. Maybe they did something in Netty to resolve it or something?</z><z id="t1697179392" t="Stefan https://github.com/netty/netty/issues/8537"><y>#</y><d>2023-10-13</d><h>06:43</h><r>Stefan</r><a href="https://github.com/netty/netty/issues/8537" target="_blank">https://github.com/netty/netty/issues/8537</a></z><z id="t1697179773" t="Matthew Davidson (kingmob) Hmmm, so a couple things. First, that link is talking about Hot Rod, not Netty. It doesn&apos;t even look like Hot Rod uses Netty afaict. It just seems to link to Netty at the bottom as an example of other software with the same problem. Though weirdly, if I look at https://ossindex.sonatype.org/vulnerability/CVE-2023-4586?component-type=maven&amp;amp;component-name=io.netty%2Fnetty-handler it refers to Netty. I...don&apos;t know why NIST and Sonatype aren&apos;t on the same page. Anyway, I think [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] thought you were referring to a different CVE (this is why we need links), because your issue applies to the client, not the server, it applies to HTTP1 as well as HTTP2, and it was fixed in the latest 0.7.0-alpha2 a few weeks ago."><y>#</y><d>2023-10-13</d><h>06:49</h><r>Matthew Davidson (kingmob)</r>Hmmm, so a couple things.

First, that link is talking about Hot Rod, not Netty. It doesn&apos;t even look like Hot Rod uses Netty afaict. It just seems to link to Netty at the bottom as an example of other software with the same problem. Though weirdly, if I look at <a href="https://ossindex.sonatype.org/vulnerability/CVE-2023-4586?component-type=maven&amp;amp;component-name=io.netty%2Fnetty-handler" target="_blank">https://ossindex.sonatype.org/vulnerability/CVE-2023-4586?component-type=maven&amp;amp;component-name=io.netty%2Fnetty-handler</a> it refers to Netty. I...don&apos;t know why NIST and Sonatype aren&apos;t on the same page.

Anyway, I think <a>@U06GVE6NR</a> thought you were referring to a different CVE (this is why we need links), because your issue applies to the client, not the server, it applies to HTTP1 as well as HTTP2, and it was fixed in the latest 0.7.0-alpha2 a few weeks ago.</z><z id="t1697179954" t="Matthew Davidson (kingmob) Netty itself is taking it&apos;s time, and if you look at the issue page, you can kind of follow why. As a lower-level library, it&apos;s a more defensible stance to say users need to configure their TLS setup properly. They say they&apos;ll make it the default in Netty 5, but they don&apos;t want to break backwards-compatibility in 4.x"><y>#</y><d>2023-10-13</d><h>06:52</h><r>Matthew Davidson (kingmob)</r>Netty itself is taking it&apos;s time, and if you look at the issue page, you can kind of follow why. As a lower-level library, it&apos;s a more defensible stance to say users need to configure their TLS setup properly.

They say they&apos;ll make it the default in Netty 5, but they don&apos;t want to break backwards-compatibility in 4.x</z><z id="t1697179971" t="Matthew Davidson (kingmob) I personally think they should do it, but I understand why they aren&apos;t"><y>#</y><d>2023-10-13</d><h>06:52</h><r>Matthew Davidson (kingmob)</r>I personally think they should do it, but I understand why they aren&apos;t</z><z id="t1697180057" t="Stefan I guess I was confused because I suppressed the earlier issue, and now this popped up from dependency-check, but initially without the CVE number. I just noticed that now it does include it."><y>#</y><d>2023-10-13</d><h>06:54</h><r>Stefan</r>I guess I was confused because I suppressed the earlier issue, and now this popped up from dependency-check, but initially without the CVE number. I just noticed that now it does include it.</z><z id="t1697180080" t="Stefan Yeah I also understand the breakage is not something to lightly do."><y>#</y><d>2023-10-13</d><h>06:54</h><r>Stefan</r>Yeah I also understand the breakage is not something to lightly do.</z><z id="t1697180174" t="Matthew Davidson (kingmob) On one hand, it only breaks for people with misconfigured server certs. OTOH, Netty has a lot of users, so it&apos;ll definitely break for someone when deployed, and that&apos;s not great if their network is secure in other ways."><y>#</y><d>2023-10-13</d><h>06:56</h><r>Matthew Davidson (kingmob)</r>On one hand, it only breaks for people with misconfigured server certs. OTOH, Netty has a lot of users, so it&apos;ll definitely break for someone when deployed, and that&apos;s not great if their network is secure in other ways.</z><z id="t1697180182" t="Stefan I think earlier it was only tagged for one of the netty dependencies, and now for pretty much all of them."><y>#</y><d>2023-10-13</d><h>06:56</h><r>Stefan</r>I think earlier it was only tagged for one of the netty dependencies, and now for pretty much all of them.</z><z id="t1697180243" t="Matthew Davidson (kingmob) It&apos;s stuff like this that leads to people considering CVEs on a case-by-case basis."><y>#</y><d>2023-10-13</d><h>06:57</h><r>Matthew Davidson (kingmob)</r>It&apos;s stuff like this that leads to people considering CVEs on a case-by-case basis.</z><z id="t1697180316" t="Matthew Davidson (kingmob) Anyway, give 0.7.0-alpha2 a try. It has HTTP/2 in the client (but not server yet, that&apos;s still under review), and it&apos;s not enabled by default, so it should be a drop-in replacement"><y>#</y><d>2023-10-13</d><h>06:58</h><r>Matthew Davidson (kingmob)</r>Anyway, give 0.7.0-alpha2 a try. It has HTTP/2 in the client (but not server yet, that&apos;s still under review), and it&apos;s not enabled by default, so it should be a drop-in replacement</z><z id="t1697180357" t="Stefan Yeah I find it sometimes very difficult to judge what to do about some of them. Can you update the transitive dependencies without breaking the direct dependencies? If everybody is precise with version numbers, it should be possible, but in practice... And if you suppress things, what is the best way to suppress them?"><y>#</y><d>2023-10-13</d><h>06:59</h><r>Stefan</r>Yeah I find it sometimes very difficult to judge what to do about some of them. Can you update the transitive dependencies without breaking the direct dependencies? If everybody is precise with version numbers, it should be possible, but in practice... And if you suppress things, what is the best way to suppress them?</z><z id="t1697180402" t="Stefan I can give it a go later on, but like [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] advised I&apos;ll stay on 0.6.x for production for now."><y>#</y><d>2023-10-13</d><h>07:00</h><r>Stefan</r>I can give it a go later on, but like <a>@U06GVE6NR</a> advised I&apos;ll stay on 0.6.x for production for now.</z><z id="t1697180461" t="Matthew Davidson (kingmob) OK, you should be able to look at the 0.7.0-alpha2 code to see how we configure cert name validation, and apply it to your own setup"><y>#</y><d>2023-10-13</d><h>07:01</h><r>Matthew Davidson (kingmob)</r>OK, you should be able to look at the 0.7.0-alpha2 code to see how we configure cert name validation, and apply it to your own setup</z><z id="t1697180523" t="Stefan Right. My take-away from the earlier discussion is that I&apos;m not affected because we&apos;re only using the server part of aleph."><y>#</y><d>2023-10-13</d><h>07:02</h><r>Stefan</r>Right. My take-away from the earlier discussion is that I&apos;m not affected because we&apos;re only using the server part of aleph.</z><z id="t1697180655" t="Matthew Davidson (kingmob) &gt; Can you update the transitive dependencies without breaking the direct dependencies? If everybody is precise with version numbers, it should be possible, but in practice... The major issue is Java&apos;s classpath is based on namespaces alone, without nesting/versioning. This results in things like Hickey arguing for namespace changes with breaking changes, but that&apos;s just a bandaid for Java, and is a very heavy &quot;fix&quot;. It doesn&apos;t really solve the problem. Long-term, langs need to move to versioned/nested deps, so multiple versions of the same dep can coexist. This is how node_modules and Nix work. (Kind of weird, but this is one thing Js does right.)"><y>#</y><d>2023-10-13</d><h>07:04</h><r>Matthew Davidson (kingmob)</r>&gt; Can you update the transitive dependencies without breaking the direct dependencies? If everybody is precise with version numbers, it should be possible, but in practice...
The major issue is Java&apos;s classpath is based on namespaces alone, without nesting/versioning.

This results in things like Hickey arguing for namespace changes with breaking changes, but that&apos;s just a bandaid for Java, and is a very heavy &quot;fix&quot;. It doesn&apos;t really solve the problem.

Long-term, langs need to move to versioned/nested deps, so multiple versions of the same dep can coexist. This is how node_modules and Nix work. (Kind of weird, but this is one thing Js does right.)</z><z id="t1697180701" t="Matthew Davidson (kingmob) If you&apos;re server-only, it should be fine. But if your server makes any network calls, remember that&apos;s the client, too"><y>#</y><d>2023-10-13</d><h>07:05</h><r>Matthew Davidson (kingmob)</r>If you&apos;re server-only, it should be fine. But if your server makes any network calls, remember that&apos;s the client, too</z><z id="t1697180821" t="Stefan Yeah indeed that model in JS is better, but I wonder to what extent it causes people to be sloppy about versions and breaking things, because they feel it matters less?"><y>#</y><d>2023-10-13</d><h>07:07</h><r>Stefan</r>Yeah indeed that model in JS is better, but I wonder to what extent it causes people to be sloppy about versions and breaking things, because they feel it matters less?</z><z id="t1697181057" t="Matthew Davidson (kingmob) Sloppy, sure, but shouldn&apos;t versioned deps break things less? (Assuming the versions are properly isolated and independent). This is where Nix is even better than node_modules (well, some node tools can dedupe the nesting), because it stores everything based on the hash of it and all its deps."><y>#</y><d>2023-10-13</d><h>07:10</h><r>Matthew Davidson (kingmob)</r>Sloppy, sure, but shouldn&apos;t versioned deps break things less? (Assuming the versions are properly isolated and independent).

This is where Nix is even better than node_modules (well, some node tools can dedupe the nesting), because it stores everything based on the hash of it and all its deps.</z><z id="t1697181098" t="Stefan They should yes, sure üôÇ"><y>#</y><d>2023-10-13</d><h>07:11</h><r>Stefan</r>They should yes, sure <b>üôÇ</b></z><z id="t1697181105" t="Matthew Davidson (kingmob) It guarantees that there is zero chance anything will use a version it wasn&apos;t built to"><y>#</y><d>2023-10-13</d><h>07:11</h><r>Matthew Davidson (kingmob)</r>It guarantees that there is zero chance anything will use a version it wasn&apos;t built to</z><z id="t1697181215" t="Matthew Davidson (kingmob) Nix is super-cumbersome to use right now, but I&apos;m pretty sure all packaging/deps systems will use something like it in the future. The only downside is using extra disk space, but that hasn&apos;t been a real concern for years now."><y>#</y><d>2023-10-13</d><h>07:13</h><r>Matthew Davidson (kingmob)</r>Nix is super-cumbersome to use right now, but I&apos;m pretty sure all packaging/deps systems will use something like it in the future. The only downside is using extra disk space, but that hasn&apos;t been a real concern for years now.</z><z id="t1697181305" t="Stefan I&apos;m not familiar with Nix myself, but I&apos;m hearing good things about it. And re disk space I completely agree. Apple has been bundling all libraries within application bundles for years now. Yes, there&apos;s duplication, but how nice is it to be able to just drag and drop an application to another computer and it just works?"><y>#</y><d>2023-10-13</d><h>07:15</h><r>Stefan</r>I&apos;m not familiar with Nix myself, but I&apos;m hearing good things about it. And re disk space I completely agree. Apple has been bundling all libraries within application bundles for years now. Yes, there&apos;s duplication, but how nice is it to be able to just drag and drop an application to another computer and it just works?</z><z id="t1697181527" t="Matthew Davidson (kingmob) Agreed. There&apos;s still the issue of communicating that you might have to do some work when breaking changes occur, but I don&apos;t think either semver or artifact name changes solve that problem (insufficient consistency in interpretation, and too heavyweight, respectively). We&apos;ll be reading changelogs for a long time, I think. üòõ"><y>#</y><d>2023-10-13</d><h>07:18</h><r>Matthew Davidson (kingmob)</r>Agreed.

There&apos;s still the issue of communicating that you might have to do some work when breaking changes occur, but I don&apos;t think either semver or artifact name changes solve that problem (insufficient consistency in interpretation, and too heavyweight, respectively). We&apos;ll be reading changelogs for a long time, I think. <b>üòõ</b></z><z id="t1697181899" t="Stefan Yup üôÇ"><y>#</y><d>2023-10-13</d><h>07:24</h><r>Stefan</r>Yup <b>üôÇ</b></z><z id="t1697186302" t="dergutemoritz Ah, yeah, I went by looking at the changelog for Netty 4.1.100.Final and it does indeed contain a fix for a different one, namely CVE-2023-44487."><y>#</y><d>2023-10-13</d><h>08:38</h><r>dergutemoritz</r>Ah, yeah, I went by looking at the changelog for Netty 4.1.100.Final and it does indeed contain a fix for a different one, namely CVE-2023-44487.</z><z id="t1697186353" t="dergutemoritz See https://github.com/netty/netty/security/advisories/GHSA-xpw8-rcwv-8f8p"><y>#</y><d>2023-10-13</d><h>08:39</h><r>dergutemoritz</r>See <a href="https://github.com/netty/netty/security/advisories/GHSA-xpw8-rcwv-8f8p" target="_blank">https://github.com/netty/netty/security/advisories/GHSA-xpw8-rcwv-8f8p</a></z><z id="t1697186397" t="Stefan Hmm that&apos;s slightly concerning, that I&apos;m not seeing that one now. Apparently the suppressions are less selective than I expected, having a tag &lt;cve&gt;...&lt;/cve&gt; in them."><y>#</y><d>2023-10-13</d><h>08:39</h><r>Stefan</r>Hmm that&apos;s slightly concerning, that I&apos;m not seeing that one now. Apparently the suppressions are less selective than I expected, having a tag <code>&lt;cve&gt;...&lt;/cve&gt;</code> in them.</z><z id="t1697186462" t="dergutemoritz Other than that, I cannot recommend Nix enough, though as pointed out by [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] it does have some rough edges which make it a bit annoying to use. But it&apos;s slowly getting better and the more people help out, the faster it will :)"><y>#</y><d>2023-10-13</d><h>08:41</h><r>dergutemoritz</r>Other than that, I cannot recommend Nix enough, though as pointed out by  <a>@U10EC98F5</a>  it does have some rough edges which make it a bit annoying to use. But it&apos;s slowly getting better and the more people help out, the faster it will :)</z><z id="t1697186493" t="Stefan Also on Mac, or specifically for Linux?"><y>#</y><d>2023-10-13</d><h>08:41</h><r>Stefan</r>Also on Mac, or specifically for Linux?</z><z id="t1697186509" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] Looks like https://nvd.nist.gov/vuln/detail/CVE-2023-44487 doesn&apos;t yet have any relevant selectors"><y>#</y><d>2023-10-13</d><h>08:41</h><r>dergutemoritz</r><a>@UGNFXV1FA</a> Looks like <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-44487" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2023-44487</a> doesn&apos;t yet have any relevant selectors</z><z id="t1697186517" t="dergutemoritz &gt; This vulnerability is currently awaiting analysis. "><y>#</y><d>2023-10-13</d><h>08:41</h><r>dergutemoritz</r>&gt; This vulnerability is currently awaiting analysis.
</z><z id="t1697186525" t="dergutemoritz so probably a matter of time till it shows up"><y>#</y><d>2023-10-13</d><h>08:42</h><r>dergutemoritz</r>so probably a matter of time till it shows up</z><z id="t1697186529" t="Stefan ah ok"><y>#</y><d>2023-10-13</d><h>08:42</h><r>Stefan</r>ah ok</z><z id="t1697186544" t="Stefan Looking forward to it ü§™"><y>#</y><d>2023-10-13</d><h>08:42</h><r>Stefan</r>Looking forward to it <b>ü§™</b></z><z id="t1697186671" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] You can also use it on Mac (Nix only then). That way you can get a taste. Then there&apos;s NixOS which is a whole Linux distro of its own which unlocks even more super powers. I&apos;ve been using NixOS as my daily driver for about 10 years now and for a few years we also use it exclusively on all our servers at work. We even made https://github.com/bevuta/clojure-nix-locker to be able to fully nixify our Clojure application build üôÇ"><y>#</y><d>2023-10-13</d><h>08:44</h><r>dergutemoritz</r><a>@UGNFXV1FA</a> You can also use it on Mac (Nix only then). That way you can get a taste. Then there&apos;s NixOS which is a whole Linux distro of its own which unlocks even more super powers. I&apos;ve been using NixOS as my daily driver for about 10 years now and for a few years we also use it exclusively on all our servers at work.  We even made <a href="https://github.com/bevuta/clojure-nix-locker" target="_blank">https://github.com/bevuta/clojure-nix-locker</a> to be able to fully nixify our Clojure application build  <b>üôÇ</b></z><z id="t1697186743" t="Stefan Oh that&apos;s interesting, that you&apos;re using it for your servers. Specifically for servers, what does it add over something like Debian in your opinion?"><y>#</y><d>2023-10-13</d><h>08:45</h><r>Stefan</r>Oh that&apos;s interesting, that you&apos;re using it for your servers. Specifically for servers, what does it add over something like Debian in your opinion?</z><z id="t1697186776" t="dergutemoritz Oh that&apos;s a broad and deep topic üôÇ Let&apos;s hop over to #C02S1GEKU4C for that"><y>#</y><d>2023-10-13</d><h>08:46</h><r>dergutemoritz</r>Oh that&apos;s a broad and deep topic <b>üôÇ</b> Let&apos;s hop over to #C02S1GEKU4C for that</z><z id="t1697186801" t="dergutemoritz Then other folks can chime in with their perspectives, too"><y>#</y><d>2023-10-13</d><h>08:46</h><r>dergutemoritz</r>Then other folks can chime in with their perspectives, too</z><z id="t1697187293" t="valerauko From what I&apos;ve seen this CVE only concerns Swift implementations though. Does it concern aleph?"><y>#</y><d>2023-10-13</d><h>08:54</h><r>valerauko</r>From what I&apos;ve seen this CVE  only concerns Swift implementations though. Does it concern aleph?</z><z id="t1697189450" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] It affects Netty&apos;s HTTP/2 server implementation, too (see https://github.com/netty/netty/security/advisories/GHSA-xpw8-rcwv-8f8p ) but since Aleph doesn&apos;t expose that, yet, it isn&apos;t affected."><y>#</y><d>2023-10-13</d><h>09:30</h><r>dergutemoritz</r><a>@UAEH11THP</a> It affects Netty&apos;s HTTP/2 server implementation, too (see <a href="https://github.com/netty/netty/security/advisories/GHSA-xpw8-rcwv-8f8p" target="_blank">https://github.com/netty/netty/security/advisories/GHSA-xpw8-rcwv-8f8p</a>) but since Aleph doesn&apos;t expose that, yet, it isn&apos;t affected.</z><z id="t1697189893" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] The rapid rst_stream CVE applies to all HTTP/2 servers. It&apos;s just in the nature of how HTTP/2 works. In a certain sense, there&apos;s nothing really new or exciting here. It&apos;s another twist on getting the server to waste CPU cycles, where there&apos;s an asymmetry in cost between the client and the server. Anyway, Aleph isn&apos;t currently affected, and I&apos;ll make sure the new H2 code uses the fixed Netty version"><y>#</y><d>2023-10-13</d><h>09:38</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> The rapid rst_stream CVE applies to all HTTP/2 servers. It&apos;s just in the nature of how HTTP/2 works.

In a certain sense, there&apos;s nothing really new or exciting here. It&apos;s another twist on getting the server to waste CPU cycles, where there&apos;s an asymmetry in cost between the client and the server.

Anyway, Aleph isn&apos;t currently affected, and I&apos;ll make sure the new H2 code uses the fixed Netty version</z><z id="t1697190160" t="dergutemoritz [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] Not all of them - haproxy was immune already üòÑ"><y>#</y><d>2023-10-13</d><h>09:42</h><r>dergutemoritz</r><a>@U10EC98F5</a> Not all of them - haproxy was immune already <b>üòÑ</b></z><z id="t1697190223" t="Matthew Davidson (kingmob) heh"><y>#</y><d>2023-10-13</d><h>09:43</h><r>Matthew Davidson (kingmob)</r>heh</z><z id="t1697190234" t="dergutemoritz stops picking the nits"><y>#</y><d>2023-10-13</d><h>09:43</h><r>dergutemoritz</r>stops picking the nits</z><z id="t1697203660" t="dergutemoritz [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] I just got a notification about this comment: https://github.com/jeremylong/DependencyCheck/issues/5912#issuecomment-1761508540"><y>#</y><d>2023-10-13</d><h>13:27</h><r>dergutemoritz</r><a>@UGNFXV1FA</a> I just got a notification about this comment: <a href="https://github.com/jeremylong/DependencyCheck/issues/5912#issuecomment-1761508540" target="_blank">https://github.com/jeremylong/DependencyCheck/issues/5912#issuecomment-1761508540</a></z><z id="t1697203735" t="dergutemoritz IIUIC NVD accidentally considers 4.1.100 a fix version for that CVE, too? Maybe that&apos;s what threw you off"><y>#</y><d>2023-10-13</d><h>13:28</h><r>dergutemoritz</r>IIUIC NVD accidentally considers 4.1.100 a fix version for that CVE, too? Maybe that&apos;s what threw you off</z><z id="t1697204465" t="Stefan Hmm that might very well be, weird."><y>#</y><d>2023-10-13</d><h>13:41</h><r>Stefan</r>Hmm that might very well be, weird.</z><z id="t1697698146" t="Stefan By the way: I&apos;m trying to make that pull request, but the tests are failing on master for me, even without changes: Testing aleph.http-timeout-test FAIL in (test-shutdown-timeout-2) (http_timeout_test.clj:70) shutdown with a timeout of 0 second and no grace for in-flight requests expected: (thrown-with-msg? Exception #&quot;connection was closed after 0\.&quot; (clojure.core/deref resp)) actual: #&lt;clojure.lang.ExceptionInfo@60ea912b clojure.lang.ExceptionInfo: connection was closed after 0,054 seconds {:request {:path &quot;/&quot;, :user-info nil, :pool #object[io.aleph.dirigiste.Pool 0x33945d80 &quot;io.aleph.dirigiste.Pool@33945d80&quot;], :throw-exceptions? false, :request-url &quot;&quot;, :server-port 8082, :uri &quot;/&quot;, :server-name &quot;localhost&quot;, :query-string nil, :scheme :http, :request-method :get}}&gt; FAIL in (test-shutdown-timeout-4) (http_timeout_test.clj:94) shutdown with a timeout of 1 seconds while waiting for body expected: (thrown-with-msg? Exception #&quot;connection was closed after 1\.&quot; (clojure.core/deref resp)) actual: #&lt;clojure.lang.ExceptionInfo@6657d966 clojure.lang.ExceptionInfo: connection was closed after 1,056 seconds {:request {:path &quot;/&quot;, :user-info nil, :pool #object[io.aleph.dirigiste.Pool 0x33945d80 &quot;io.aleph.dirigiste.Pool@33945d80&quot;], :throw-exceptions? false, :request-url &quot;&quot;, :server-port 8082, :uri &quot;/&quot;, :server-name &quot;localhost&quot;, :query-string nil, :s And after bumping netty, also: Testing aleph.http.multipart-test FAIL in (test-multipart-request-decode-with-ring-handler) (multipart_test.clj:216) automatic cleanup with zero memory-limit expected: (not (.exists file)) actual: (not (not true)) FAIL in (test-multipart-request-decode-with-ring-handler) (multipart_test.clj:216) automatic cleanup with zero memory-limit expected: (not (.exists file)) actual: (not (not true)) FAIL in (test-multipart-request-decode-with-ring-handler) (multipart_test.clj:216) automatic cleanup with zero memory-limit expected: (not (.exists file)) actual: (not (not true)) Not sure how to proceed with this...?"><y>#</y><d>2023-10-19</d><h>06:49</h><r>Stefan</r>By the way: I&apos;m trying to make that pull request, but the tests are failing on master for me, even without changes:

<pre>Testing aleph.http-timeout-test

FAIL in (test-shutdown-timeout-2) (http_timeout_test.clj:70)
shutdown with a timeout of 0 second and no grace for in-flight requests

expected: (thrown-with-msg?
           Exception
           #&quot;connection was closed after 0\.&quot;
           (clojure.core/deref resp))
  actual: #&lt;clojure.lang.ExceptionInfo@60ea912b clojure.lang.ExceptionInfo: connection was closed after 0,054 seconds {:request {:path &quot;/&quot;, :user-info nil, :pool #object[io.aleph.dirigiste.Pool 0x33945d80 &quot;io.aleph.dirigiste.Pool@33945d80&quot;], :throw-exceptions? false, :request-url &quot;&quot;, :server-port 8082, :uri &quot;/&quot;, :server-name &quot;localhost&quot;, :query-string nil, :scheme :http, :request-method :get}}&gt;

FAIL in (test-shutdown-timeout-4) (http_timeout_test.clj:94)
shutdown with a timeout of 1 seconds while waiting for body

expected: (thrown-with-msg?
           Exception
           #&quot;connection was closed after 1\.&quot;
           (clojure.core/deref resp))
  actual: #&lt;clojure.lang.ExceptionInfo@6657d966 clojure.lang.ExceptionInfo: connection was closed after 1,056 seconds {:request {:path &quot;/&quot;, :user-info nil, :pool #object[io.aleph.dirigiste.Pool 0x33945d80 &quot;io.aleph.dirigiste.Pool@33945d80&quot;], :throw-exceptions? false, :request-url &quot;&quot;, :server-port 8082, :uri &quot;/&quot;, :server-name &quot;localhost&quot;, :query-string nil, :s</pre>
And after bumping netty, also:

<pre>Testing aleph.http.multipart-test

FAIL in (test-multipart-request-decode-with-ring-handler) (multipart_test.clj:216)
automatic cleanup with zero memory-limit

expected: (not (.exists file))
  actual: (not (not true))

FAIL in (test-multipart-request-decode-with-ring-handler) (multipart_test.clj:216)
automatic cleanup with zero memory-limit

expected: (not (.exists file))
  actual: (not (not true))

FAIL in (test-multipart-request-decode-with-ring-handler) (multipart_test.clj:216)
automatic cleanup with zero memory-limit

expected: (not (.exists file))
  actual: (not (not true))</pre>
Not sure how to proceed with this...?</z><z id="t1697788603" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UGNFXV1FA&quot;}] I assume this is local? Because I don&apos;t see any PR builds from you on CircleCI. Generally, timeout tests are flakier than we would like. But the multipart tests shouldn&apos;t be, iiuc. That being said... I can&apos;t replicate your results. All those tests work for me locally. I tried bumping Netty up to 4.1.100.Final, and they still passed. If you think the branch is ready to merge, make a PR, and let&apos;s see what Circle says."><y>#</y><d>2023-10-20</d><h>07:56</h><r>Matthew Davidson (kingmob)</r><a>@UGNFXV1FA</a> I assume this is local? Because I don&apos;t see any PR builds from you on CircleCI.

Generally, timeout tests are flakier than we would like. But the multipart tests shouldn&apos;t be, iiuc.

That being said... I can&apos;t replicate your results. All those tests work for me locally. I tried bumping Netty up to 4.1.100.Final, and they still passed.

If you think the branch is ready to merge, make a PR, and let&apos;s see what Circle says.</z><z id="t1697789571" t="Stefan Ok will do!"><y>#</y><d>2023-10-20</d><h>08:12</h><r>Stefan</r>Ok will do!</z><z id="t1697441914" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U09M90GKX&quot;}] expressed some interest in the https://github.com/clj-commons/aleph/issues/690 . First, this issue is meant to be exploratory. We need a short report first, before any code. My biggest concern is that it won&apos;t be that useful. Every server has had their own ad hoc API for Websockets for years now. Standardization could help people switch servers, but enough servers will have to support the spec before that&apos;s useful. My next concern is that Websockets are an older technology. They&apos;re simple, but H2 streams should supplant them for many uses. H2 gives you multiplexing for free, without consuming multiple TCP sockets. For a greenfield project, I wouldn&apos;t start with websockets when I can open an H2 stream, and make the bodies an infinite/indefinite stream of bytes. Of course, that depends on the client, because the one major blocker is Websockets have better support in browsers for the moment. There&apos;s ongoing, experimental, and standards work to support infinite streaming bodies (see Web Transports), but it&apos;s not here yet. tl;dr I&apos;m just not sure it&apos;s worth it, compared to the many other things we could do. (Like, I think https://github.com/clj-commons/aleph/issues/683 `wrap-decompression` https://github.com/clj-commons/aleph/issues/683 for HTTP1 is probably more useful.) I&apos;m not saying no, though!"><y>#</y><d>2023-10-16</d><h>07:38</h><w>Matthew Davidson (kingmob)</w><a>@jwhitlark</a> expressed some interest in the <a href="https://github.com/clj-commons/aleph/issues/690" target="_blank">https://github.com/clj-commons/aleph/issues/690</a>.

First, this issue is meant to be exploratory. We need a short report first, before any code. My biggest concern is that it won&apos;t be that useful. Every server has had their own ad hoc API for Websockets for years now. Standardization could help people switch servers, but enough servers will have to support the spec before that&apos;s useful.

My next concern is that Websockets are an older technology. They&apos;re simple, but H2 streams should supplant them for many uses. H2 gives you multiplexing for free, without consuming multiple TCP sockets. For a greenfield project, I wouldn&apos;t start with websockets when I can open an H2 stream, and make the bodies an infinite/indefinite stream of bytes.

Of course, that depends on the client, because the one major blocker is Websockets have better support in browsers for the moment. There&apos;s ongoing, experimental, and standards work to support infinite streaming bodies (see Web Transports), but it&apos;s not here yet.

tl;dr I&apos;m just not sure it&apos;s worth it, compared to the many other things we could do. (Like, I think <a href="https://github.com/clj-commons/aleph/issues/683" target="_blank">https://github.com/clj-commons/aleph/issues/683</a>`wrap-decompression`<a href="https://github.com/clj-commons/aleph/issues/683" target="_blank">https://github.com/clj-commons/aleph/issues/683</a> for HTTP1 is probably more useful.) I&apos;m not saying no, though!</z><z id="t1697441950" t="Matthew Davidson (kingmob) What other issues would be good for newcomers?"><y>#</y><d>2023-10-16</d><h>07:39</h><r>Matthew Davidson (kingmob)</r>What other issues would be good for newcomers?</z><z id="t1697443174" t="hiredman https://www.rfc-editor.org/rfc/rfc8441.html there is an rfc for websocket over http2, and I believe even one for ws over http3"><y>#</y><d>2023-10-16</d><h>07:59</h><r>hiredman</r><a href="https://www.rfc-editor.org/rfc/rfc8441.html" target="_blank">https://www.rfc-editor.org/rfc/rfc8441.html</a> there is an rfc for websocket over http2, and I believe even one for ws over http3</z><z id="t1697443320" t="hiredman I find the idea that http2 streams would supplant websockets kind of shocking. They are just different things."><y>#</y><d>2023-10-16</d><h>08:02</h><r>hiredman</r>I find the idea that http2 streams would supplant websockets kind of shocking. They are just different things.</z><z id="t1697443360" t="Matthew Davidson (kingmob) The RFC for WS over http2 hasn&apos;t really proved popular."><y>#</y><d>2023-10-16</d><h>08:02</h><r>Matthew Davidson (kingmob)</r>The RFC for WS over http2 hasn&apos;t really proved popular.</z><z id="t1697443370" t="Matthew Davidson (kingmob) ~Last I checked, nobody implemented it.~ Checked again, looks like there&apos;s partial support in browsers, but not much from servers and reverse proxies."><y>#</y><d>2023-10-16</d><h>08:02</h><r>Matthew Davidson (kingmob)</r>~Last I checked, nobody implemented it.~  Checked again, looks like there&apos;s partial support in browsers, but not much from servers and reverse proxies.</z><z id="t1697443412" t="Matthew Davidson (kingmob) Also, I need to update my comment a bit. I had to doubble-check, and realized that browsers don&apos;t support streaming over fetch() yet (though there is standardization and experimental work)"><y>#</y><d>2023-10-16</d><h>08:03</h><r>Matthew Davidson (kingmob)</r>Also, I need to update my comment a bit. I had to doubble-check, and realized that browsers don&apos;t support streaming over fetch() yet (though there is standardization and experimental work)</z><z id="t1697443445" t="Matthew Davidson (kingmob) But conceptually, WS and H2 steams are really similar, actually."><y>#</y><d>2023-10-16</d><h>08:04</h><r>Matthew Davidson (kingmob)</r>But conceptually, WS and H2 steams are really similar, actually.</z><z id="t1697443530" t="hiredman Websockets in general are not that great (who knew, stateful connections are annoying on mobile devices) but http streams have the same problem there"><y>#</y><d>2023-10-16</d><h>08:05</h><r>hiredman</r>Websockets in general are not that great (who knew, stateful connections are  annoying on mobile devices) but http streams have the same problem there</z><z id="t1697443535" t="Matthew Davidson (kingmob) The request/response nature of HTTP is a bit of a red herring. For infinite streams, thnk of it like the WS handshakes. Once each sides exchange HEADER frames, they can send inifinte DATA frames and do with it what they want"><y>#</y><d>2023-10-16</d><h>08:05</h><r>Matthew Davidson (kingmob)</r>The request/response nature of HTTP is a bit of a red herring. For infinite streams, thnk of it like the WS handshakes. Once each sides exchange HEADER frames, they can send inifinte DATA frames and do with it what they want</z><z id="t1697443551" t="hiredman I am aware"><y>#</y><d>2023-10-16</d><h>08:05</h><r>hiredman</r>I am aware</z><z id="t1697443757" t="Matthew Davidson (kingmob) For mobile, HTTP/3&apos;s QUIC session identifiers would be a big advantage"><y>#</y><d>2023-10-16</d><h>08:09</h><r>Matthew Davidson (kingmob)</r>For mobile, HTTP/3&apos;s QUIC session identifiers would be a big advantage</z><z id="t1697443801" t="Matthew Davidson (kingmob) AFAICT, they allow seamless resumption when you switch networks, like going from wifi to cell"><y>#</y><d>2023-10-16</d><h>08:10</h><r>Matthew Davidson (kingmob)</r>AFAICT, they allow seamless resumption when you switch networks, like going from wifi to cell</z><z id="t1697445320" t="Matthew Davidson (kingmob) I think if browsers supported a way to use H2/H3 streaming in Js, there wouldn&apos;t be any good WS use cases left (other than for legacy purposes). Websockets have slightly less packet overhead, but the lack of multiplexing is a big minus."><y>#</y><d>2023-10-16</d><h>08:35</h><r>Matthew Davidson (kingmob)</r>I think if browsers supported a way to use H2/H3 streaming in Js, there wouldn&apos;t be any good WS use cases left (other than for legacy purposes). Websockets have slightly less packet overhead, but the lack of multiplexing is a big minus.</z><z id="t1697697404" t="raspasov re: multiplexing; I am sure it can have significant benefit when loading a complex webpage with dozens (or likely 100s) of elements however, if I am simply serving API-style endpoints, I am not convinced there‚Äôs any significant real-world benefit (welcome to be proven wrong with examples - I tried looking but could not find anything)"><y>#</y><d>2023-10-19</d><h>06:36</h><r>raspasov</r>re: multiplexing; I am sure it can have significant benefit when loading a complex webpage with dozens (or likely 100s) of elements however, if I am simply serving API-style endpoints, I am not convinced there‚Äôs any significant real-world benefit

(welcome to be proven wrong with examples - I tried looking but could not find anything)</z><z id="t1697697510" t="raspasov HTTP/3 with QUIC is quite exciting though; the possibility of having all the benefits of WebSocket-style communication without worrying about stateful connections is potentially awesome (but I have not first-hand experience with it, so my excitement is purely theoretical at the moment üôÇ )"><y>#</y><d>2023-10-19</d><h>06:38</h><r>raspasov</r>HTTP/3 with QUIC is quite exciting though; the possibility of having all the benefits of WebSocket-style communication without worrying about stateful connections is potentially awesome (but I have not first-hand experience with it, so my excitement is purely theoretical at the moment <b>üôÇ</b> )</z><z id="t1697697596" t="raspasov (and that can potentially benefit all kinds of servers: serving complex pages, simple pages, API servers, etc)"><y>#</y><d>2023-10-19</d><h>06:39</h><r>raspasov</r>(and that can potentially benefit all kinds of servers: serving complex pages, simple pages, API servers, etc)</z><z id="t1697699574" t="Matthew Davidson (kingmob) Yes, not all usage patterns benefit from multiplexing, but many will. For APIs, consider making a few requests near-simultaneously. If they overlap, you benefit from multiplexing. Browsers are definitely the poster child for benefitting from H2 multiplexing tho. "><y>#</y><d>2023-10-19</d><h>07:12</h><r>Matthew Davidson (kingmob)</r>Yes, not all usage patterns benefit from multiplexing, but many will. For APIs, consider making a few requests near-simultaneously. If they overlap, you benefit from multiplexing. Browsers are definitely the poster child for benefitting from H2 multiplexing tho. </z><z id="t1697700054" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U050KSS8M&quot;}] What in H3/QUIC are you most interested in? The QUIC connection ids, per-packet encryption, something else? The WebTransport protocol is the part most like WebSockets"><y>#</y><d>2023-10-19</d><h>07:20</h><r>Matthew Davidson (kingmob)</r><a>@U050KSS8M</a> What in H3/QUIC are you most interested in? The QUIC connection ids, per-packet encryption, something else? The WebTransport protocol is the part most like WebSockets</z><z id="t1697700062" t="raspasov For sure‚Ä¶ I just imagine the WebSocket use case‚Ä¶ (which I have experience with first hand); it‚Äôs effectively a light wrapper on top of TCP; TCP is the ultimate limiter here; Since WebSockets are full-duplex, there‚Äôs no blocking/waiting per-se."><y>#</y><d>2023-10-19</d><h>07:21</h><r>raspasov</r>For sure‚Ä¶ I just imagine the WebSocket use case‚Ä¶ (which I have experience with first hand); it‚Äôs effectively a light wrapper on top of TCP; TCP is the ultimate limiter here; Since WebSockets are full-duplex, there‚Äôs no blocking/waiting per-se.</z><z id="t1697700215" t="raspasov In terms of QUIC, I am curious about whether it can truly do &gt; allow seamless resumption when you switch networks like you said; I wonder if that‚Äôs a potential benefit in servers as well? Aka, can one completely forget about stateful re-connections? (again my knowledge here is limited to a few conference talks I‚Äôve watched on the subject, so not first-hand‚Ä¶)"><y>#</y><d>2023-10-19</d><h>07:23</h><r>raspasov</r>In terms of QUIC, I am curious about whether it can truly do
&gt; allow seamless resumption when you switch networks
like you said; I wonder if that‚Äôs a potential benefit in servers as well? Aka, can one completely forget about stateful re-connections? (again my knowledge here is limited to a few conference talks I‚Äôve watched on the subject, so not first-hand‚Ä¶)</z><z id="t1697700304" t="raspasov With WebSockets that‚Äôs definitely the pain point (statefulness, heartbeats, [:attrs nil] etc) (but ultimately TCP is the limiting factor there I think)"><y>#</y><d>2023-10-19</d><h>07:25</h><r>raspasov</r>With WebSockets that‚Äôs definitely the pain point (statefulness, heartbeats, <b>is my connection alive?</b> etc)  (but ultimately TCP is the limiting factor there I think)</z><z id="t1697700366" t="raspasov WebTransport looks cool, yeah"><y>#</y><d>2023-10-19</d><h>07:26</h><r>raspasov</r>WebTransport looks cool, yeah</z><z id="t1697700400" t="raspasov I guess the question is, can WebTransport offer all those supposed benefits of seamless resumption, etc"><y>#</y><d>2023-10-19</d><h>07:26</h><r>raspasov</r>I guess the question is, can WebTransport offer all those supposed benefits of seamless resumption, etc</z><z id="t1697700507" t="raspasov (browsing through https://developer.mozilla.org/en-US/docs/Web/API/WebTransport ‚Ä¶)"><y>#</y><d>2023-10-19</d><h>07:28</h><r>raspasov</r>(browsing through <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebTransport" target="_blank">https://developer.mozilla.org/en-US/docs/Web/API/WebTransport</a> ‚Ä¶)</z><z id="t1697700592" t="Matthew Davidson (kingmob) &gt; Since WebSockets are full-duplex, there‚Äôs no blocking/waiting per-se &gt; that‚Äôs definitely the pain point (statefulness, heartbeats, [:attrs nil] etc) I mean, H2 streams are full-duplex, too, and a lot of its state mgmt is already handled for you. I think the request/response nature of HTTP really misleads people about what H2/3 can do. At the protocol level, treating the body like an infinite stream of bytes just like Websockets is easy. The only catch is browsers don&apos;t support HTTP responses like that very well (though there are still things like Server-Sent Events, which fit many simple use cases). But if you&apos;re a server, or using a non-browser client, H2/3 is fine for a lot of WS uses"><y>#</y><d>2023-10-19</d><h>07:29</h><r>Matthew Davidson (kingmob)</r>&gt; Since WebSockets are full-duplex, there‚Äôs no blocking/waiting per-se
&gt; that‚Äôs definitely the pain point (statefulness, heartbeats, <b>is my connection alive?</b> etc)
I mean, H2 streams are full-duplex, too, and a lot of its state mgmt is already handled for you. I think the request/response nature of HTTP really misleads people about what H2/3 can do. At the protocol level, treating the body like an infinite stream of bytes just like Websockets is easy.

The only catch is browsers don&apos;t support HTTP responses like that very well (though there are still things like Server-Sent Events, which fit many simple use cases). But if you&apos;re a server, or using a non-browser client, H2/3 is fine for a lot of WS uses</z><z id="t1697700664" t="Matthew Davidson (kingmob) That&apos;s where WebTransports seem to come in, though I haven&apos;t done much reading up on them yet. Still wrapping up H2 in Aleph."><y>#</y><d>2023-10-19</d><h>07:31</h><r>Matthew Davidson (kingmob)</r>That&apos;s where WebTransports seem to come in, though I haven&apos;t done much reading up on them yet. Still wrapping up H2 in Aleph.</z><z id="t1697700741" t="raspasov I guess I am generally non-excited about HTTP/2 variants since they are all TCP based. Until we can go to UDP (with seamless reconnections), I am not sold on the benefits, at least for the use cases I‚Äôm involved in (which admittedly, does not involve serving facebook or CNN-sizes pages‚Ä¶)"><y>#</y><d>2023-10-19</d><h>07:32</h><r>raspasov</r>I guess I am generally non-excited about HTTP/2 variants since they are all TCP based. Until we can go to UDP (with seamless reconnections), I am not sold on the benefits, at least for the use cases I‚Äôm involved in (which admittedly, does not involve serving facebook or CNN-sizes pages‚Ä¶)</z><z id="t1697700778" t="raspasov (and I am guessing that‚Äôs where the majority of benefit lies)"><y>#</y><d>2023-10-19</d><h>07:32</h><r>raspasov</r>(and I am guessing that‚Äôs where the majority of benefit lies)</z><z id="t1697700782" t="Matthew Davidson (kingmob) &gt; Aka, can one completely forget about stateful re-connections? It should definitely minimize reconns, especially across network switches. But eventually you&apos;ll get an error, or if the conn lives long enough, run out H2 stream identifiers."><y>#</y><d>2023-10-19</d><h>07:33</h><r>Matthew Davidson (kingmob)</r>&gt; Aka, can one completely forget about stateful re-connections?
It should definitely minimize reconns, especially across network switches. But eventually you&apos;ll get an error, or if the conn lives long enough, run out H2 stream identifiers.</z><z id="t1697700821" t="Matthew Davidson (kingmob) &gt; can WebTransport offer all those supposed benefits of seamless resumption I think resumption is built into the QUIC layer, so tentatively I&apos;d expect the asnwer to be yes"><y>#</y><d>2023-10-19</d><h>07:33</h><r>Matthew Davidson (kingmob)</r>&gt; can WebTransport offer all those supposed benefits of seamless resumption
I think resumption is built into the QUIC layer, so tentatively I&apos;d expect the asnwer to be yes</z><z id="t1697700824" t="raspasov Hmm yeah‚Ä¶ I‚Äôve experienced for example how flaky gRPC (HTTP/2) based connections/patterns can be (on at least 2 occasions over the years); Non-aleph based."><y>#</y><d>2023-10-19</d><h>07:33</h><r>raspasov</r>Hmm yeah‚Ä¶ I‚Äôve experienced for example how flaky gRPC (HTTP/2) based connections/patterns can be (on at least 2 occasions over the years); Non-aleph based.</z><z id="t1697700890" t="raspasov Yeah that would be the holy grail of connecting üôÇ Just connect and forget!"><y>#</y><d>2023-10-19</d><h>07:34</h><r>raspasov</r>Yeah that would be the holy grail of connecting <b>üôÇ</b> Just connect and forget!</z><z id="t1697700917" t="Matthew Davidson (kingmob) Would be nice."><y>#</y><d>2023-10-19</d><h>07:35</h><r>Matthew Davidson (kingmob)</r>Would be nice.</z><z id="t1697700920" t="raspasov (aka it‚Äôs all handled seamlessly at the protocol layer under the hood‚Ä¶)"><y>#</y><d>2023-10-19</d><h>07:35</h><r>raspasov</r>(aka it‚Äôs all handled seamlessly at the protocol layer under the hood‚Ä¶)</z><z id="t1697700973" t="Matthew Davidson (kingmob) Don&apos;t quote me on HTTP/3 resumption, there might still be required support at the application layer. I need to take a closer look"><y>#</y><d>2023-10-19</d><h>07:36</h><r>Matthew Davidson (kingmob)</r>Don&apos;t quote me on HTTP/3 resumption, there might still be required support at the application layer. I need to take a closer look</z><z id="t1697700981" t="raspasov For sure."><y>#</y><d>2023-10-19</d><h>07:36</h><r>raspasov</r>For sure.</z><z id="t1697701008" t="Matthew Davidson (kingmob) What&apos;s your API use pattern?"><y>#</y><d>2023-10-19</d><h>07:36</h><r>Matthew Davidson (kingmob)</r>What&apos;s your API use pattern?</z><z id="t1697701021" t="raspasov FWIW, currently using Aleph with old-school HTTT/1.1 üôÇ"><y>#</y><d>2023-10-19</d><h>07:37</h><r>raspasov</r>FWIW, currently using Aleph with old-school HTTT/1.1 <b>üôÇ</b></z><z id="t1697701027" t="raspasov (serving JSON api)"><y>#</y><d>2023-10-19</d><h>07:37</h><r>raspasov</r>(serving JSON api)</z><z id="t1697701029" t="raspasov Works great."><y>#</y><d>2023-10-19</d><h>07:37</h><r>raspasov</r>Works great.</z><z id="t1697701075" t="raspasov I‚Äôve used Aleph with websockets and raw TCP over the years (also great, minus the re-connection hassle - but that‚Äôs not really Aleph‚Äôs fault/problem in general)"><y>#</y><d>2023-10-19</d><h>07:37</h><r>raspasov</r>I‚Äôve used Aleph with websockets and raw TCP over the years (also great, minus the re-connection hassle - but that‚Äôs not really Aleph‚Äôs fault/problem in general)</z><z id="t1697701160" t="Matthew Davidson (kingmob) Because I&apos;d think any time the same client makes multiple (near-)simultaneous requests, you&apos;d benefit from H2&apos;s multiplexing. Pipelining never took off, so otherwise, you&apos;re forced to wait for responses to come in, and with Websockets, you have to write your own multiplexing, when otherwise you could cheaply fire up a new stream"><y>#</y><d>2023-10-19</d><h>07:39</h><r>Matthew Davidson (kingmob)</r>Because I&apos;d think any time the same client makes multiple (near-)simultaneous requests, you&apos;d benefit from H2&apos;s multiplexing. Pipelining never took off, so otherwise, you&apos;re forced to wait for responses to come in, and with Websockets, you have to write your own multiplexing, when otherwise you could cheaply fire up a new stream</z><z id="t1697701209" t="Matthew Davidson (kingmob) If reconns are your thing, yeah, you need nothing short of QUIC."><y>#</y><d>2023-10-19</d><h>07:40</h><r>Matthew Davidson (kingmob)</r>If reconns are your thing, yeah, you need nothing short of QUIC.</z><z id="t1697701213" t="raspasov ( https://github.com/raspasov/neversleep/blob/master/src/neversleep_db/aleph_netty.clj )"><y>#</y><d>2023-10-19</d><h>07:40</h><r>raspasov</r>(<a href="https://github.com/raspasov/neversleep/blob/master/src/neversleep_db/aleph_netty.clj" target="_blank">https://github.com/raspasov/neversleep/blob/master/src/neversleep_db/aleph_netty.clj</a>)</z><z id="t1697701257" t="Matthew Davidson (kingmob) Oh wow, gloss. I wrote a bunch of that a couple years ago for a speech-to-text project"><y>#</y><d>2023-10-19</d><h>07:40</h><r>Matthew Davidson (kingmob)</r>Oh wow, gloss. I wrote a bunch of that a couple years ago for a speech-to-text project</z><z id="t1697701382" t="raspasov ‚Äúany time the same client makes multiple (near-)simultaneous requests‚Äù yeah the question is how many requests really does it get to see the benefits though it would have to be 10+ at the same time‚Ä¶ even with HTTP/1.1 (and most of our current patterns are one request at the time, more or less, so truly not much benefit)"><y>#</y><d>2023-10-19</d><h>07:43</h><r>raspasov</r>‚Äúany time the same client makes multiple (near-)simultaneous requests‚Äù yeah the question is how many requests really does it get to see the benefits though it would have to be 10+ at the same time‚Ä¶ even with HTTP/1.1
(and most of our current patterns are one request at the time, more or less, so truly not much benefit)</z><z id="t1697701473" t="Matthew Davidson (kingmob) Yeah, with a light usage pattern, it won&apos;t help much. Obviously, the more simultaneous requests, the better H2 will be over H1"><y>#</y><d>2023-10-19</d><h>07:44</h><r>Matthew Davidson (kingmob)</r>Yeah, with a light usage pattern, it won&apos;t help much. Obviously, the more simultaneous requests, the better H2 will be over H1</z><z id="t1697701577" t="Matthew Davidson (kingmob) Need not be 10+ tho, even 2-3 should be faster. Nobody likes waiting üòÑ"><y>#</y><d>2023-10-19</d><h>07:46</h><r>Matthew Davidson (kingmob)</r>Need not be 10+ tho, even 2-3 should be faster. Nobody likes waiting <b>üòÑ</b></z><z id="t1697701599" t="raspasov Yeah, it‚Äôs more efficient, I understand;"><y>#</y><d>2023-10-19</d><h>07:46</h><r>raspasov</r>Yeah, it‚Äôs more efficient, I understand;</z><z id="t1697701611" t="raspasov Opening 1 socket vs many, etc;"><y>#</y><d>2023-10-19</d><h>07:46</h><r>raspasov</r>Opening 1 socket vs many, etc;</z><z id="t1697701684" t="Matthew Davidson (kingmob) Btw, I&apos;d like to hear about your experience with gRPC issues; I&apos;ve never used it"><y>#</y><d>2023-10-19</d><h>07:48</h><r>Matthew Davidson (kingmob)</r>Btw, I&apos;d like to hear about your experience with gRPC issues; I&apos;ve never used it</z><z id="t1697701736" t="raspasov I hate to be a conspiracy theorist üòÇ but I‚Äôve encountered the opinion that RFC/et al HTTP standards have been sorta taken over by big companies where this kind of efficiency does make sense ‚Ä¶ but at a smaller scale it‚Äôs hard to quantify those benefits and the cost is often much more complexity in protocol, implementation, etc; I am not a ‚Äúbig companies = bad‚Äù type of person ‚Äì I don‚Äôt have an ax to grind in this debase but I kinda soft agree with the above‚Ä¶ it all depends on the use-case, and often the ‚Äúbest practices/newest thing‚Äù is not what one truly needs;"><y>#</y><d>2023-10-19</d><h>07:48</h><r>raspasov</r>I hate to be a conspiracy theorist <b>üòÇ</b>  but I‚Äôve encountered the opinion that RFC/et al HTTP standards have been sorta taken over by big companies where this kind of efficiency does make sense ‚Ä¶ but at a smaller scale it‚Äôs hard to quantify those benefits and the cost is often much more complexity in protocol, implementation, etc;

I am not a ‚Äúbig companies = bad‚Äù type of person ‚Äì I don‚Äôt have an ax to grind in this debase but I kinda soft agree with the above‚Ä¶ it all depends on the use-case, and often the ‚Äúbest practices/newest thing‚Äù is not what one truly needs;</z><z id="t1697701813" t="Matthew Davidson (kingmob) True, there&apos;s definitely a bunch of cargo-culting of what unicorns do. I guess for me, I view protocols as needing to support the widest range of use cases, since they&apos;re shared by everyone"><y>#</y><d>2023-10-19</d><h>07:50</h><r>Matthew Davidson (kingmob)</r>True, there&apos;s definitely a bunch of cargo-culting of what unicorns do. I guess for me, I view protocols as needing to support the widest range of use cases, since they&apos;re shared by everyone</z><z id="t1697701820" t="raspasov re: gRPC basically re-connection troubles, and protobuf is its own weird thing (non-human readable; schema-out-of-band)"><y>#</y><d>2023-10-19</d><h>07:50</h><r>raspasov</r>re: gRPC basically re-connection troubles, and protobuf is its own weird thing (non-human readable; schema-out-of-band)</z><z id="t1697701843" t="raspasov &gt; a bunch of cargo-culting of what unicorns do üíØ"><y>#</y><d>2023-10-19</d><h>07:50</h><r>raspasov</r>&gt; a bunch of cargo-culting of what unicorns do
<b>üíØ</b></z><z id="t1697701855" t="Matthew Davidson (kingmob) Protobuf is goog&apos;s widely-used binary framing lib, right?"><y>#</y><d>2023-10-19</d><h>07:50</h><r>Matthew Davidson (kingmob)</r>Protobuf is goog&apos;s widely-used binary framing lib, right?</z><z id="t1697701856" t="raspasov (not even unicorns, but like Facebook &amp; Google)"><y>#</y><d>2023-10-19</d><h>07:50</h><r>raspasov</r>(not even unicorns, but like Facebook &amp; Google)</z><z id="t1697701861" t="raspasov Yeah‚Ä¶"><y>#</y><d>2023-10-19</d><h>07:51</h><r>raspasov</r>Yeah‚Ä¶</z><z id="t1697701883" t="Matthew Davidson (kingmob) what issues with reconnecting did you run into?"><y>#</y><d>2023-10-19</d><h>07:51</h><r>Matthew Davidson (kingmob)</r>what issues with reconnecting did you run into?</z><z id="t1697701939" t="raspasov Well, at some point your stream or connection dies üôÇ (basically, all the issues you‚Äôd have with WebSockets)"><y>#</y><d>2023-10-19</d><h>07:52</h><r>raspasov</r>Well, at some point your stream or connection dies <b>üôÇ</b> (basically, all the issues you‚Äôd have with WebSockets)</z><z id="t1697701964" t="raspasov re: protocol buffers and formats, old but great Rich Hickey talk (at timestamp) https://youtu.be/ROor6_NGIWU?t=736"><y>#</y><d>2023-10-19</d><h>07:52</h><r>raspasov</r>re: protocol buffers and formats, old but great Rich Hickey talk (at timestamp) <a href="https://youtu.be/ROor6_NGIWU?t=736" target="_blank">https://youtu.be/ROor6_NGIWU?t=736</a></z><z id="t1697702043" t="raspasov widest range of use cases, since they‚Äôre shared by everyoneTotally understand your point, as a maintainer üëç"><y>#</y><d>2023-10-19</d><h>07:54</h><r>raspasov</r>widest range of use cases, since they‚Äôre shared by everyoneTotally understand your point, as a maintainer <b>üëç</b></z><z id="t1697702080" t="Matthew Davidson (kingmob) &gt; Well, at some point your stream or connection dies :thinking_face: Was it around 1 billion calls? That&apos;s when I&apos;d expect to run out of H2/3 stream ids, and need to make a new conn"><y>#</y><d>2023-10-19</d><h>07:54</h><r>Matthew Davidson (kingmob)</r>&gt;  Well, at some point your stream or connection dies
<b>:thinking_face:</b> Was it around 1 billion calls? That&apos;s when I&apos;d expect to run out of H2/3 stream ids, and need to make a new conn</z><z id="t1697702110" t="Matthew Davidson (kingmob) If not, well, network errors are inevitable"><y>#</y><d>2023-10-19</d><h>07:55</h><r>Matthew Davidson (kingmob)</r>If not, well, network errors are inevitable</z><z id="t1697702180" t="raspasov Was it around 1 billion calls?I am not exactly sure‚Ä¶ I doubt it‚Ä¶ But that‚Äôs good food for thought‚Ä¶"><y>#</y><d>2023-10-19</d><h>07:56</h><r>raspasov</r>Was it around 1 billion calls?I am not exactly sure‚Ä¶ I doubt it‚Ä¶ But that‚Äôs good food for thought‚Ä¶</z><z id="t1697702246" t="Matthew Davidson (kingmob) Good thing RAM/CPU isn&apos;t as flaky as network üòÇ"><y>#</y><d>2023-10-19</d><h>07:57</h><r>Matthew Davidson (kingmob)</r>Good thing RAM/CPU isn&apos;t as flaky as network <b>üòÇ</b></z><z id="t1697702262" t="raspasov &gt; If not, well, network errors are inevitable Right.. that‚Äôs why I have so much hope about QUIC and WebTransport if that can be automagically abstracted away üòÅ"><y>#</y><d>2023-10-19</d><h>07:57</h><r>raspasov</r>&gt; If not, well, network errors are inevitable
Right.. that‚Äôs why I have so much hope about QUIC and WebTransport if that can be automagically abstracted away <b>üòÅ</b></z><z id="t1697702293" t="Matthew Davidson (kingmob) ü§û"><y>#</y><d>2023-10-19</d><h>07:58</h><r>Matthew Davidson (kingmob)</r><b>ü§û</b></z><z id="t1697702293" t="raspasov &gt; Good thing RAM/CPU isn‚Äôt as flaky as network Haha, oh yeah‚Ä¶"><y>#</y><d>2023-10-19</d><h>07:58</h><r>raspasov</r>&gt; Good thing RAM/CPU isn‚Äôt as flaky as network
Haha, oh yeah‚Ä¶</z><z id="t1697744694" t="jwhitlark I&apos;m going to have to bow out of this one. It is clearly a much more complicated issue that I first assumed. üò≤"><y>#</y><d>2023-10-19</d><h>19:44</h><r>jwhitlark</r>I&apos;m going to have to bow out of this one.  It is clearly a much more complicated issue that I first assumed.  <b>üò≤</b></z><z id="t1697787584" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U09M90GKX&quot;}] Thanks for taking a look, though. Think I should remove the &quot;good first issue&quot; tag? In my head, I thought it wouldn&apos;t require much code-writing, but I guess it involves a TON of code-reading."><y>#</y><d>2023-10-20</d><h>07:39</h><r>Matthew Davidson (kingmob)</r><a>@jwhitlark</a> Thanks for taking a look, though. Think I should remove the &quot;good first issue&quot; tag? In my head, I thought it wouldn&apos;t require much code-writing, but I guess it involves a TON of code-reading.</z><z id="t1697446799" t="Matthew Davidson (kingmob) I took a closer look at [:attrs {:href &quot;/_/_/users/U0NCTKEV8&quot;}] ‚Äôs suggestion to add support RFC 8441, using Websockets over H2. There&apos;s https://wpt.fyi/results/websockets/opening-handshake/002.html%3Fwpt_flags%3Dh2?label=experimental&amp;amp;label=master&amp;amp;aligned (all but Safari), so if anyone wants it, we could add an issue for it."><y>#</y><d>2023-10-16</d><h>08:59</h><w>Matthew Davidson (kingmob)</w>I took a closer look at <a>@hiredman</a>‚Äôs suggestion to add support RFC 8441, using Websockets over H2. There&apos;s <a href="https://wpt.fyi/results/websockets/opening-handshake/002.html%3Fwpt_flags%3Dh2?label=experimental&amp;amp;label=master&amp;amp;aligned" target="_blank">https://wpt.fyi/results/websockets/opening-handshake/002.html%3Fwpt_flags%3Dh2?label=experimental&amp;amp;label=master&amp;amp;aligned</a> (all but Safari), so if anyone wants it, we could add an issue for it.</z><z id="t1700055966" t="valerauko i&apos;m thinking of open sourcing a library for datadog instrumentation of manifold-based code, just wondering how many people have a similar setup?"><y>#</y><d>2023-11-15</d><h>13:46</h><w>valerauko</w>i&apos;m thinking of open sourcing a library for datadog instrumentation of manifold-based code, just wondering how many people have a similar setup?</z><z id="t1700056220" t="Matthew Davidson (kingmob) May also want to ask in #C02H9GF74CF "><y>#</y><d>2023-11-15</d><h>13:50</h><r>Matthew Davidson (kingmob)</r>May also want to ask in #C02H9GF74CF </z><z id="t1702364300" t="Matthew Davidson (kingmob) Announcing https://clojars.org/aleph/versions/0.7.0-rc1 ! The big change from alpha2 is HTTP/2 support on the server-side, and more codec support. Many thanks to [:attrs {:href &quot;/_/_/users/U06GVE6NR&quot;}] and [:attrs {:href &quot;/_/_/users/UFKCFTVB8&quot;}] for their hard work! Note that HTTP/2 is not enabled by default. To enable it, use the new :http-versions key and add :http2 to the vector. If nobody reports any issues, we&apos;ll probably release this as 0.7.0."><y>#</y><d>2023-12-12</d><h>06:58</h><w>Matthew Davidson (kingmob)</w>Announcing <a href="https://clojars.org/aleph/versions/0.7.0-rc1" target="_blank">https://clojars.org/aleph/versions/0.7.0-rc1</a>! The big change from alpha2 is HTTP/2 support on the server-side, and more codec support. Many thanks to <a>@dergutemoritz</a> and <a>@arnaudgeiser</a> for their hard work!

Note that HTTP/2 is not enabled by default. To enable it, use the new <code>:http-versions</code> key and add <code>:http2</code> to the vector.

If nobody reports any issues, we&apos;ll probably release this as 0.7.0.</z><z id="t1702391583" t="Arnaud Geiser Thanks to you Matthew! What an amazing work and a great achievement for Aleph!"><y>#</y><d>2023-12-12</d><h>14:33</h><r>Arnaud Geiser</r>Thanks to you Matthew! What an amazing work and a great achievement for Aleph!</z><z id="t1702413426" t="Nick McAvoy Moving from 0.7.0-alpha1 to rc1, I&apos;m getting a ClassNotFoundException for com.aayushatharva.brotli4j.encoder.Encoder$Parameters ."><y>#</y><d>2023-12-12</d><h>20:37</h><r>Nick McAvoy</r>Moving from 0.7.0-alpha1 to rc1, I&apos;m getting a ClassNotFoundException for <code>com.aayushatharva.brotli4j.encoder.Encoder$Parameters</code>.</z><z id="t1702414423" t="Nick McAvoy I added the dev dependencies for brotli and zstd, and now it starts. I do have :extra-paths [&quot;test&quot;] for this alias in deps.edn, in case that&apos;s relevant."><y>#</y><d>2023-12-12</d><h>20:53</h><r>Nick McAvoy</r>I added the dev dependencies for brotli and zstd, and now it starts. I do have <code>:extra-paths [&quot;test&quot;]</code> for this alias in deps.edn, in case that&apos;s relevant.</z><z id="t1702438928" t="Matthew Davidson (kingmob) Hmmm. Thought we prevented that problem. Are you doing any AOT or Graal? [:attrs {:href &quot;/_/_/users/U01BA210C7K&quot;}] Can you make an issue on GitHub? Please include your deps.edn and a description of how you‚Äôre triggering the error. Thanks üôè "><y>#</y><d>2023-12-13</d><h>03:42</h><r>Matthew Davidson (kingmob)</r>Hmmm. Thought we prevented that problem. Are you doing any AOT or Graal?

<a>@U01BA210C7K</a> Can you make an issue on GitHub? Please include your deps.edn and a description of how you‚Äôre triggering the error. Thanks <b>üôè</b>  </z><z id="t1702592349" t="Nick McAvoy https://github.com/alephdata/aleph/issues/3530 is the issue."><y>#</y><d>2023-12-14</d><h>22:19</h><r>Nick McAvoy</r><a href="https://github.com/alephdata/aleph/issues/3530" target="_blank">https://github.com/alephdata/aleph/issues/3530</a> is the issue.</z><z id="t1702622880" t="Matthew Davidson (kingmob) Great!...but Alephdata/aleph is a different project with the same name. üòõ"><y>#</y><d>2023-12-15</d><h>06:48</h><r>Matthew Davidson (kingmob)</r>Great!...but Alephdata/aleph is a different project with the same name. <b>üòõ</b></z><z id="t1702654870" t="Nick McAvoy Ha, wow"><y>#</y><d>2023-12-15</d><h>15:41</h><r>Nick McAvoy</r>Ha, wow</z><z id="t1702655068" t="Nick McAvoy That&apos;s haste for you. https://github.com/clj-commons/aleph/issues/703 it is in the right place."><y>#</y><d>2023-12-15</d><h>15:44</h><r>Nick McAvoy</r>That&apos;s haste for you. <a href="https://github.com/clj-commons/aleph/issues/703" target="_blank">https://github.com/clj-commons/aleph/issues/703</a> it is in the right place.</z><z id="t1702724094" t="Matthew Davidson (kingmob) I think when I fixed this bug elsewhere, I didn&apos;t realize it was suppressing the same bug later. I&apos;m reasonably sure I can fix it, but given the growing hassle, I&apos;m wondering if we shouldn&apos;t just build the extra codec support into Aleph."><y>#</y><d>2023-12-16</d><h>10:54</h><r>Matthew Davidson (kingmob)</r>I think when I fixed this bug elsewhere, I didn&apos;t realize it was suppressing the same bug later. I&apos;m reasonably sure I can fix it, but given the growing hassle, I&apos;m wondering if we shouldn&apos;t just build the extra codec support into Aleph.</z><z id="t1702723929" t="Matthew Davidson (kingmob) To Aleph users: Would you prefer the new compression codecs (Brotli, Zstd, etc) get included by default in Aleph, or would you prefer to add them as deps manually? &gt; ‚úÖ Include them by default &gt; ‚ùå Leave them up to us to add React with the relevant emoji"><y>#</y><d>2023-12-16</d><h>10:52</h><w>Matthew Davidson (kingmob)</w>To Aleph users:

Would you prefer the new compression codecs (Brotli, Zstd, etc) get included by default in Aleph, or would you prefer to add them as deps manually?

&gt; <b>‚úÖ</b>  Include them by default
&gt; <b>‚ùå</b>  Leave them up to us to add
React with the relevant emoji</z><z id="t1703592320" t="oyakushev I might be a minority in these questions, but I overall don&apos;t like the dependency bloat, especially if it&apos;s avoidable. For example, I find the inclusion of Malli just to validate a few HTTP client options icky. But the ship has sailed on that one."><y>#</y><d>2023-12-26</d><h>12:05</h><r>oyakushev</r>I might be a minority in these questions, but I overall don&apos;t like the dependency bloat, especially if it&apos;s avoidable. For example, I find the inclusion of Malli just to validate a few HTTP client options icky. But the ship has sailed on that one.</z><z id="t1703592409" t="oyakushev Up to now, Aleph has been pretty conservative with dependencies. Yes, it shipped plenty of Zach&apos;s other homegrown stuff, but each dep was used extensively enough to justify the inclusion."><y>#</y><d>2023-12-26</d><h>12:06</h><r>oyakushev</r>Up to now, Aleph has been pretty conservative with dependencies. Yes, it shipped plenty of Zach&apos;s other homegrown stuff, but each dep was used extensively enough to justify the inclusion.</z><z id="t1703652819" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U06PNK4HG&quot;}] I understand. Unfortunately, we have limited resources, and supporting modern codecs without requiring the deps started consuming more effort than I&apos;d like, and I&apos;m concerned about future maintenance burden. I originally designed it all to keep the codec deps optional, but that&apos;s trickier than it looks, it turns out. At its root, the issue is the Clojure language uses the same syntax for static member access and static function calls, and the compiler requires reflection to distinguish between the two. Twice this led to tricky ClassNotFoundExceptions compiling codec interop code (that Java itself has no problem with). I ended up writing a whole Java class just to provide a Clojure-safe facade for the problem. Despite that, the problem cropped up again in a new form. While I think I can still make the codecs optional, both choices started to seem equal overall, so I thought it worth asking the users if they had a preference. Other consequences: for Brotli, it&apos;s effectively https://caniuse.com/brotli , and I have no problem making it a default, and if optional, fewer people would enable it. Zstd&apos;s future is less clear, but including the Brotli deps and not the Zstd one would just be the worst of both worlds. Dependency conflicts are always a possibility, but that seems unlikely in this case. People with pre-existing Br/zstd deps are probably trying to modernize Aleph, if I had to guess."><y>#</y><d>2023-12-27</d><h>04:53</h><r>Matthew Davidson (kingmob)</r><a>@U06PNK4HG</a> I understand. Unfortunately, we have limited resources, and supporting modern codecs without requiring the deps started consuming more effort than I&apos;d like, and I&apos;m concerned about future maintenance burden. I originally designed it all to keep the codec deps optional, but that&apos;s trickier than it looks, it turns out.

At its root, the issue is the Clojure language uses the same syntax for static member access and static function calls, and the compiler requires reflection to distinguish between the two. Twice this led to tricky ClassNotFoundExceptions compiling codec interop code (that Java itself has no problem with). I ended up writing a whole Java class just to provide a Clojure-safe facade for the problem. Despite that, the problem cropped up again in a new form. While I think I can still make the codecs optional, both choices started to seem equal overall, so I thought it worth asking the users if they had a preference.

Other consequences: for Brotli, it&apos;s effectively <a href="https://caniuse.com/brotli" target="_blank">https://caniuse.com/brotli</a>, and I have no problem making it a default, and if optional, fewer people would enable it. Zstd&apos;s future is less clear, but including the Brotli deps and not the Zstd one would just be the worst of both worlds.

Dependency conflicts are always a possibility, but that seems unlikely in this case. People with pre-existing Br/zstd deps are probably trying to modernize Aleph, if I had to guess.</z><z id="t1703652828" t="Matthew Davidson (kingmob) (Side note: I actually wish we could strip out some of Zach&apos;s deps, like Potemkin, and replace the object pool half of Dirigiste. Not sure if primitive-math still makes sense, either.)"><y>#</y><d>2023-12-27</d><h>04:53</h><r>Matthew Davidson (kingmob)</r>(Side note: I actually wish we could strip out some of Zach&apos;s deps, like Potemkin, and replace the object pool half of Dirigiste. Not sure if primitive-math still makes sense, either.)</z><z id="t1703653027" t="Matthew Davidson (kingmob) We discussed the same thing with Malli, and I wanted it included, because I (still) hope we&apos;ll use it to validate more than it currently does. It&apos;s a vote for the future, though I admit we don&apos;t use it enough yet. I&apos;m curious, would you feel the same way if we&apos;d used core.spec.alpha instead?"><y>#</y><d>2023-12-27</d><h>04:57</h><r>Matthew Davidson (kingmob)</r>We discussed the same thing with Malli, and I wanted it included, because I (still) hope we&apos;ll use it to validate more than it currently does. It&apos;s a vote for the future, though I admit we don&apos;t use it enough yet.

I&apos;m curious, would you feel the same way if we&apos;d used core.spec.alpha instead?</z><z id="t1703680744" t="oyakushev I wouldn&apos;t feel the same since spec is an always-present facility, even though I don&apos;t like spec much. Malli feels like an app-level choice to me, not a library-level choice. But, in the end, reducing the dependency surface is an uphill battle that few people want to be involved in, so I don&apos;t try to overpush it."><y>#</y><d>2023-12-27</d><h>12:39</h><r>oyakushev</r>I wouldn&apos;t feel the same since spec is an always-present facility, even though I don&apos;t like spec much. Malli feels like an app-level choice to me, not a library-level choice. But, in the end, reducing the dependency surface is an uphill battle that few people want to be involved in, so I don&apos;t try to overpush it.</z><z id="t1711192090" t="Matthew Davidson (kingmob) &gt; Not sure if primitive-math still makes sense, either.) (edited) Follow-up: primitive-math still makes sense, because the default Clojure math fns still don&apos;t warn about reflection. I ran some numbers in https://gist.github.com/KingMob/7ae74e2ba0b4700d1549a1b913a4e496 , and accidentally using reflection was 35x slower."><y>#</y><d>2024-03-23</d><h>11:08</h><r>Matthew Davidson (kingmob)</r>&gt; Not sure if primitive-math still makes sense, either.) (edited)
Follow-up: primitive-math still makes sense, because the default Clojure math fns still don&apos;t warn about reflection. I ran some numbers in <a href="https://gist.github.com/KingMob/7ae74e2ba0b4700d1549a1b913a4e496" target="_blank">https://gist.github.com/KingMob/7ae74e2ba0b4700d1549a1b913a4e496</a>, and accidentally using reflection was 35x slower.</z><z id="t1703841168" t="Matthew Davidson (kingmob) A new Ring spec was just officially released for Websockets. I added a Github discussion for it https://github.com/clj-commons/aleph/discussions/706 ."><y>#</y><d>2023-12-29</d><h>09:12</h><w>Matthew Davidson (kingmob)</w>A new Ring spec was just officially released for Websockets. I added a Github discussion for it <a href="https://github.com/clj-commons/aleph/discussions/706" target="_blank">https://github.com/clj-commons/aleph/discussions/706</a>.</z><z id="t1704279725" t="Matthew Davidson (kingmob) Aleph 0.7.0-rc2 is available now. The only change is the Brotli and zstd codecs are built-in now. https://clojars.org/aleph/versions/0.7.0-rc2"><y>#</y><d>2024-01-03</d><h>11:02</h><w>Matthew Davidson (kingmob)</w>Aleph 0.7.0-rc2 is available now. The only change is the Brotli and zstd codecs are built-in now.

<a href="https://clojars.org/aleph/versions/0.7.0-rc2" target="_blank">https://clojars.org/aleph/versions/0.7.0-rc2</a></z><z id="t1704280176" t="Arnaud Geiser Thank you Matthew!"><y>#</y><d>2024-01-03</d><h>11:09</h><r>Arnaud Geiser</r>Thank you Matthew!</z><z id="t1705316251" t="Matthew Davidson (kingmob) Announcing Aleph 0.7.0, featuring HTTP/2 support on both the server and client. It also supports modern compression codecs like Brotli and Zstd, as well as a ton of bug fixes and improvements under the hood. Manifold has been upgraded to 0.4.1, which means all Manifold/Aleph deferreds implement CompletionStage for better Java interop. Many thanks to everyone who contributed, and thank to Clojurists Together for sponsoring this work! https://clojars.org/aleph/versions/0.7.0"><y>#</y><d>2024-01-15</d><h>10:57</h><w>Matthew Davidson (kingmob)</w>Announcing Aleph 0.7.0, featuring HTTP/2 support on both the server and client. It also supports modern compression codecs like Brotli and Zstd, as well as a ton of bug fixes and improvements under the hood. Manifold has been upgraded to 0.4.1, which means all Manifold/Aleph deferreds implement CompletionStage for better Java interop.

Many thanks to everyone who contributed, and thank to Clojurists Together for sponsoring this work!

<a href="https://clojars.org/aleph/versions/0.7.0" target="_blank">https://clojars.org/aleph/versions/0.7.0</a></z><z id="t1705467811" t="Matthew Davidson (kingmob) So, Aleph 0.7.0 is out, and if anyone or their company needs help, please ask. We can help out in channel, or if you have bigger needs (e.g., training, consulting) feel free to DM me and we can work something out."><y>#</y><d>2024-01-17</d><h>05:03</h><w>Matthew Davidson (kingmob)</w>So, Aleph 0.7.0 is out, and if anyone or their company needs help, please ask. We can help out in channel, or if you have bigger needs (e.g., training, consulting) feel free to DM me and we can work something out.</z><z id="t1705507984" t="Eric Dvorsak Is there any breaking change in 0.7.0 on the client side? I just updated without looking into it and I see these DEBUG logs after my client queries: aleph.http.client client request: {:aleph/close true, :path &quot;/&quot;, :user-info nil, :request-url &quot;&quot;, :server-port nil, :uri &quot;/&quot;, :server-name &quot;closing.aleph.invalid&quot;, :query-string nil, :scheme :http, :request-method :get} seems like requests that were previously working in 0.6 are now turning into that"><y>#</y><d>2024-01-17</d><h>16:13</h><w>Eric Dvorsak</w>Is there any breaking change in 0.7.0 on the client side? I just updated without looking into it and I see these DEBUG logs after my client queries:
<pre>aleph.http.client client request: {:aleph/close true, :path &quot;/&quot;, :user-info nil, :request-url &quot;&quot;, :server-port nil, :uri &quot;/&quot;, :server-name &quot;closing.aleph.invalid&quot;, :query-string nil, :scheme :http, :request-method :get}</pre>
seems like requests that were previously working in 0.6 are now turning into that</z><z id="t1705527729" t="Arnaud Geiser Hello Eric! Did you bump straight from Aleph 0.6.0 to 0.7.0 or were you using version 0.6.3 ? Can you share with us the code? Version 0.6.2 made the client more restrictive in terms of what it accepts [1], that might be it. But I don&apos;t think so regarding your error message. [1] : https://github.com/clj-commons/aleph/pull/685"><y>#</y><d>2024-01-17</d><h>21:42</h><r>Arnaud Geiser</r>Hello Eric!

Did you bump straight from Aleph <code>0.6.0</code> to <code>0.7.0</code> or were you using version <code>0.6.3</code>? Can you share with us the code?

Version <code>0.6.2</code> made the client more restrictive in terms of what it accepts [1], that might be it. But I don&apos;t think so regarding your error message.

[1] : <a href="https://github.com/clj-commons/aleph/pull/685" target="_blank">https://github.com/clj-commons/aleph/pull/685</a></z><z id="t1705566013" t="Eric Dvorsak I am on 0.6.4"><y>#</y><d>2024-01-18</d><h>08:20</h><r>Eric Dvorsak</r>I am on 0.6.4</z><z id="t1705566118" t="Eric Dvorsak I can try to make a repro, [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] might already have a part of the code base that contain the code."><y>#</y><d>2024-01-18</d><h>08:21</h><r>Eric Dvorsak</r>I can try to make a repro, <a>@U10EC98F5</a> might already have a part of the code base that contain the code.</z><z id="t1705566219" t="Eric Dvorsak It‚Äôs a POST request that is quite normal except for the part that it gets SSE in return (OpenAI API)"><y>#</y><d>2024-01-18</d><h>08:23</h><r>Eric Dvorsak</r>It‚Äôs a POST request that is quite normal except for the part that it gets SSE in return (OpenAI API)</z><z id="t1705566397" t="Eric Dvorsak So I think it might have something to do with SSE handling"><y>#</y><d>2024-01-18</d><h>08:26</h><r>Eric Dvorsak</r>So I think it might have something to do with SSE handling</z><z id="t1705566411" t="Matthew Davidson (kingmob) That&apos;s the pseudo-request Aleph uses to close a connection. Since a connection is really just request-&gt;response fn, Zach decided to close them by sending a sentinel request. When you call close-connection , it sends that request, and certain code looks for :aleph/close true . The &quot;invalid&quot; part is just because the RFCs promise it will never be a valid TLD"><y>#</y><d>2024-01-18</d><h>08:26</h><r>Matthew Davidson (kingmob)</r>That&apos;s the pseudo-request Aleph uses to close a connection.

Since a connection is really just request-&gt;response fn, Zach decided to close them by sending a sentinel request. When you call <code>close-connection</code>, it sends that request, and certain code looks for <code>:aleph/close true</code> . The &quot;invalid&quot; part is just because the RFCs promise it will never be a valid TLD</z><z id="t1705566504" t="Eric Dvorsak But it closes prematurely, before receiving any SSE"><y>#</y><d>2024-01-18</d><h>08:28</h><r>Eric Dvorsak</r>But it closes prematurely, before receiving any SSE</z><z id="t1705566530" t="Eric Dvorsak The only difference between working and non working calls is updating to 0.7"><y>#</y><d>2024-01-18</d><h>08:28</h><r>Eric Dvorsak</r>The only difference between working and non working calls is updating to 0.7</z><z id="t1705566615" t="Matthew Davidson (kingmob) Hmmm. Are you still on HTTP/1 or did you add ALPN and HTTP/2 to the mix?"><y>#</y><d>2024-01-18</d><h>08:30</h><r>Matthew Davidson (kingmob)</r>Hmmm. Are you still on HTTP/1 or did you add ALPN and HTTP/2 to the mix?</z><z id="t1705566656" t="Eric Dvorsak I changed nothing but the aleph version, I assume it‚Äôs on http1 then?"><y>#</y><d>2024-01-18</d><h>08:30</h><r>Eric Dvorsak</r>I changed nothing but the aleph version, I assume it‚Äôs on http1 then?</z><z id="t1705566752" t="Matthew Davidson (kingmob) Should still be on HTTP/1 then, but some of that code was refactored. I&apos;m not sure how much changed on the client-side between 0.6.3/0.6.4 and 0.7.0. It&apos;s been mostly server stuff in recent months."><y>#</y><d>2024-01-18</d><h>08:32</h><r>Matthew Davidson (kingmob)</r>Should still be on HTTP/1 then, but some of that code was refactored. I&apos;m not sure how much changed on the client-side between 0.6.3/0.6.4 and 0.7.0. It&apos;s been mostly server stuff in recent months.</z><z id="t1705566787" t="Matthew Davidson (kingmob) Quick check: do you have an http-versions key somewhere? If not, you&apos;re on HTTP/1 still"><y>#</y><d>2024-01-18</d><h>08:33</h><r>Matthew Davidson (kingmob)</r>Quick check: do you have an <code>http-versions</code> key somewhere? If not, you&apos;re on HTTP/1 still</z><z id="t1705566871" t="Eric Dvorsak 2024-01-17 17:04:29.191 [staging_02] [DEBUG] aleph.http.client Using HTTP protocol: http/1.1 {:authority http://brian-gpt4-france.openai.azure.com , :ssl? true, :force-h2c? false}"><y>#</y><d>2024-01-18</d><h>08:34</h><r>Eric Dvorsak</r>2024-01-17 17:04:29.191 [staging_02] [DEBUG] aleph.http.client Using HTTP protocol: http/1.1 {:authority <a href="http://brian-gpt4-france.openai.azure.com" target="_blank">http://brian-gpt4-france.openai.azure.com</a>, :ssl? true, :force-h2c? false}</z><z id="t1705566937" t="Matthew Davidson (kingmob) I assume you&apos;re not using a custom pool-builder-fn"><y>#</y><d>2024-01-18</d><h>08:35</h><r>Matthew Davidson (kingmob)</r>I assume you&apos;re not using a custom pool-builder-fn</z><z id="t1705566978" t="Eric Dvorsak yeah I&apos;m not"><y>#</y><d>2024-01-18</d><h>08:36</h><r>Eric Dvorsak</r>yeah I&apos;m not</z><z id="t1705567036" t="Eric Dvorsak here&apos;s the logs for a request 0.7: 2024-01-17 17:04:29.192 [staging_02] [DEBUG] aleph.http.client http1 client pipeline DefaultChannelPipeline Handlers: activity-logger: LoggingHandler (#624743621) ssl-handler: SslHandler (#607389596) pause-handler: netty$pause_handler$reify__38645 (#1503766034) http-client: HttpClientCodec (#1894974881) streamer: ChunkedWriteHandler (#1366243763) handler: client$http1_client_handler$reify__39781 (#178696404) debug: common$add_non_http_handlers$reify__38868 (#1233115065) 2024-01-17 17:04:29.193 [staging_02] [DEBUG] aleph.http.client Unpausing pipeline 2024-01-17 17:04:29.195 [staging_02] [DEBUG] aleph.http.client client request: {:path &quot;//openai/deployments/brian-gpt4-turbo/chat/completions&quot;, :user-info nil, :request-url &quot;&quot;, :headers {&quot;api-key&quot; &quot;redacted&quot;, &quot;content-type&quot; &quot;application/json&quot;}, :server-port nil, :content-type &quot;application/json&quot;, :uri &quot;//openai/deployments/brian-gpt4-turbo/chat/completions&quot;, :server-name &quot;&quot;, :query-string &quot;api-version=2023-05-15&quot;, :body &quot;redacted&quot;, :scheme :https, :request-method :post} 2024-01-17 17:04:29.197 [staging_02] [DEBUG] aleph.netty pause-handler - firing buffered msgs 2024-01-17 17:04:29.197 [staging_02] [DEBUG] aleph.http.core send-contiguous-body headers: #object[io.netty.handler.codec.http.DefaultHttpHeaders 0x314a922f DefaultHttpHeaders[Api-Key: redacted, Content-Type: application/json, host: ]] 2024-01-17 17:04:29.199 [staging_02] [DEBUG] aleph.http.client client request: {:aleph/close true, :path &quot;/&quot;, :user-info nil, :request-url &quot;&quot;, :server-port nil, :uri &quot;/&quot;, :server-name &quot;closing.aleph.invalid&quot;, :query-string nil, :scheme :http, :request-method :get} 2024-01-17 17:04:29.200 [staging_02] [DEBUG] aleph.http.client responses stream closed."><y>#</y><d>2024-01-18</d><h>08:37</h><r>Eric Dvorsak</r>here&apos;s the logs for a request 0.7:

<pre>2024-01-17 17:04:29.192 [staging_02] [DEBUG] aleph.http.client http1 client pipeline DefaultChannelPipeline
	Handlers:
		activity-logger: LoggingHandler (#624743621)
		ssl-handler: SslHandler (#607389596)
		pause-handler: netty$pause_handler$reify__38645 (#1503766034)
		http-client: HttpClientCodec (#1894974881)
		streamer: ChunkedWriteHandler (#1366243763)
		handler: client$http1_client_handler$reify__39781 (#178696404)
		debug: common$add_non_http_handlers$reify__38868 (#1233115065)


2024-01-17 17:04:29.193 [staging_02] [DEBUG] aleph.http.client Unpausing pipeline
2024-01-17 17:04:29.195 [staging_02] [DEBUG] aleph.http.client client request: {:path &quot;//openai/deployments/brian-gpt4-turbo/chat/completions&quot;, :user-info nil, :request-url &quot;&quot;, :headers {&quot;api-key&quot; &quot;redacted&quot;, &quot;content-type&quot; &quot;application/json&quot;}, :server-port nil, :content-type &quot;application/json&quot;, :uri &quot;//openai/deployments/brian-gpt4-turbo/chat/completions&quot;, :server-name &quot;&quot;, :query-string &quot;api-version=2023-05-15&quot;, :body &quot;redacted&quot;, :scheme :https, :request-method :post}
2024-01-17 17:04:29.197 [staging_02] [DEBUG] aleph.netty pause-handler - firing buffered msgs
2024-01-17 17:04:29.197 [staging_02] [DEBUG] aleph.http.core send-contiguous-body headers: #object[io.netty.handler.codec.http.DefaultHttpHeaders 0x314a922f DefaultHttpHeaders[Api-Key: redacted, Content-Type: application/json, host: ]]
2024-01-17 17:04:29.199 [staging_02] [DEBUG] aleph.http.client client request: {:aleph/close true, :path &quot;/&quot;, :user-info nil, :request-url &quot;&quot;, :server-port nil, :uri &quot;/&quot;, :server-name &quot;closing.aleph.invalid&quot;, :query-string nil, :scheme :http, :request-method :get}
2024-01-17 17:04:29.200 [staging_02] [DEBUG] aleph.http.client responses stream closed.</pre></z><z id="t1705567245" t="Eric Dvorsak I don&apos;t have the equivalent for 0.6.4 because it isn&apos;t logging anything it just works silently üòÖ"><y>#</y><d>2024-01-18</d><h>08:40</h><r>Eric Dvorsak</r>I don&apos;t have the equivalent for 0.6.4 because it isn&apos;t logging anything it just works silently <b>üòÖ</b></z><z id="t1705567267" t="Matthew Davidson (kingmob) close-connection is called by the Dirigiste object pool when it destroys the connection. Sometimes this indicates an error, but there are none in the logs, and there are normal circumstances that would cause a connection to be closed"><y>#</y><d>2024-01-18</d><h>08:41</h><r>Matthew Davidson (kingmob)</r><code>close-connection</code> is called by the Dirigiste object pool when it destroys the connection. Sometimes this indicates an error, but there are none in the logs, and there are normal circumstances that would cause a connection to be closed</z><z id="t1705567591" t="Matthew Davidson (kingmob) I&apos;m looking..."><y>#</y><d>2024-01-18</d><h>08:46</h><r>Matthew Davidson (kingmob)</r>I&apos;m looking...</z><z id="t1705568145" t="Matthew Davidson (kingmob) The code was renamed and commented a bit for clarity, but the normal closing code seems the same as in 0.6.4. Basically, if you get responses out of order, or the server fails to close the chunked stream it&apos;s sending, Aleph will detect this (a violation in HTTP/1) and signal the connection for closing"><y>#</y><d>2024-01-18</d><h>08:55</h><r>Matthew Davidson (kingmob)</r>The code was renamed and commented a bit for clarity, but the normal closing code seems the same as in 0.6.4.  Basically, if you get responses out of order, or the server fails to close the chunked stream it&apos;s sending, Aleph will detect this (a violation in HTTP/1) and signal the connection for closing</z><z id="t1705568179" t="Eric Dvorsak but it works everytime with 0.6.4 and it fails everytime with 0.7"><y>#</y><d>2024-01-18</d><h>08:56</h><r>Eric Dvorsak</r>but it works everytime with 0.6.4 and it fails everytime with 0.7</z><z id="t1705568211" t="Matthew Davidson (kingmob) I believe you, I&apos;m just verbalizing the possibilities as part of my thought process"><y>#</y><d>2024-01-18</d><h>08:56</h><r>Matthew Davidson (kingmob)</r>I believe you, I&apos;m just verbalizing the possibilities as part of my thought process</z><z id="t1705568284" t="Matthew Davidson (kingmob) Do you see http1-req-handler - response: in your logs anywhere nearby?"><y>#</y><d>2024-01-18</d><h>08:58</h><r>Matthew Davidson (kingmob)</r>Do you see <code>http1-req-handler - response:</code> in your logs anywhere nearby?</z><z id="t1705568535" t="Matthew Davidson (kingmob) Dumb question, but you&apos;re not changing keep-alive? to false anywhere, are you?"><y>#</y><d>2024-01-18</d><h>09:02</h><r>Matthew Davidson (kingmob)</r>Dumb question, but you&apos;re not changing <code>keep-alive?</code> to false anywhere, are you?</z><z id="t1705568579" t="Matthew Davidson (kingmob) Also, do you see connection was closed after anywhere nearby in the logs?"><y>#</y><d>2024-01-18</d><h>09:02</h><r>Matthew Davidson (kingmob)</r>Also, do you see <code>connection was closed after</code> anywhere nearby in the logs?</z><z id="t1705568644" t="Matthew Davidson (kingmob) And you&apos;re not seeing any timeouts?"><y>#</y><d>2024-01-18</d><h>09:04</h><r>Matthew Davidson (kingmob)</r>And you&apos;re not seeing any timeouts?</z><z id="t1705568765" t="Matthew Davidson (kingmob) One thing to try would be to turn on TRACE-level logging for Aleph. Most of the exit points will indicate why the connection is being closed at trace-level"><y>#</y><d>2024-01-18</d><h>09:06</h><r>Matthew Davidson (kingmob)</r>One thing to try would be to turn on TRACE-level logging for Aleph. Most of the exit points will indicate why the connection is being closed at trace-level</z><z id="t1705569350" t="Matthew Davidson (kingmob) See any received msg of class ?"><y>#</y><d>2024-01-18</d><h>09:15</h><r>Matthew Davidson (kingmob)</r>See any <code>received msg of class</code>?</z><z id="t1705570843" t="Eric Dvorsak Ok so I tried to repro in the codebase you worked on and it doesn&apos;t fail there, but running the same test in the broader codebase does fail"><y>#</y><d>2024-01-18</d><h>09:40</h><r>Eric Dvorsak</r>Ok so I tried to repro in the codebase you worked on and it doesn&apos;t fail there, but running the same test in the broader codebase does fail</z><z id="t1705570884" t="Matthew Davidson (kingmob) Yeah, I was testing it on the brain-ai repo and... &quot;It Works On My Machine. ‚Ñ¢Ô∏è &quot;"><y>#</y><d>2024-01-18</d><h>09:41</h><r>Matthew Davidson (kingmob)</r>Yeah, I was testing it on the brain-ai repo and... &quot;It Works On My Machine.<b>‚Ñ¢Ô∏è</b>&quot;</z><z id="t1705570926" t="Matthew Davidson (kingmob) I&apos;m actually kind of surprised, I would have expected to see more log statements if debugging was turned on"><y>#</y><d>2024-01-18</d><h>09:42</h><r>Matthew Davidson (kingmob)</r>I&apos;m actually kind of surprised, I would have expected to see more log statements if debugging was turned on</z><z id="t1705570950" t="Matthew Davidson (kingmob) Maybe try (log/set-min-level! :trace) from the REPL?"><y>#</y><d>2024-01-18</d><h>09:42</h><r>Matthew Davidson (kingmob)</r>Maybe try <code>(log/set-min-level! :trace)</code> from the REPL?</z><z id="t1705570993" t="Matthew Davidson (kingmob) Like, there&apos;s nothing about response bodies, in the log snippet you sent, which seems sus"><y>#</y><d>2024-01-18</d><h>09:43</h><r>Matthew Davidson (kingmob)</r>Like, there&apos;s nothing about response bodies, in the log snippet you sent, which seems sus</z><z id="t1705571247" t="Matthew Davidson (kingmob) It sends the request out and 2ms later, the connection is being closed with nothing in-between, where I&apos;d expect a bunch of stuff."><y>#</y><d>2024-01-18</d><h>09:47</h><r>Matthew Davidson (kingmob)</r>It sends the request out and 2ms later, the connection is being closed with nothing in-between, where I&apos;d expect a bunch of stuff.</z><z id="t1705571416" t="Eric Dvorsak 2024-01-18T09:49:27.803Z project2501 TRACE [aleph.http.client:?] - http1-req-handler fired 2024-01-18T09:49:27.803Z project2501 DEBUG [aleph.http.core:?] - send-contiguous-body headers: #object[io.netty.handler.codec.http.DefaultHttpHeaders 0x57eab7a0 DefaultHttpHeaders[Api-Key: , Content-Type: application/json, host: ]] 2024-01-18T09:49:27.805Z project2501 TRACE [aleph.http:?] - Request failed. Disposing of connection... 2024-01-18T09:49:27.806Z project2501 TRACE [aleph.http.client:?] - http-req-fn fired"><y>#</y><d>2024-01-18</d><h>09:50</h><r>Eric Dvorsak</r><pre>2024-01-18T09:49:27.803Z project2501 TRACE [aleph.http.client:?] - http1-req-handler fired
2024-01-18T09:49:27.803Z project2501 DEBUG [aleph.http.core:?] - send-contiguous-body headers: #object[io.netty.handler.codec.http.DefaultHttpHeaders 0x57eab7a0 DefaultHttpHeaders[Api-Key: , Content-Type: application/json, host: ]]
2024-01-18T09:49:27.805Z project2501 TRACE [aleph.http:?] - Request failed. Disposing of connection...
2024-01-18T09:49:27.806Z project2501 TRACE [aleph.http.client:?] - http-req-fn fired</pre></z><z id="t1705571665" t="Matthew Davidson (kingmob) Hmm, that means an Exception was placed in the deferred instead of a valid Ring response. It should return the exception in an error-deferred"><y>#</y><d>2024-01-18</d><h>09:54</h><r>Matthew Davidson (kingmob)</r>Hmm, that means an Exception was placed in the deferred instead of a valid Ring response. It should return the exception in an error-deferred</z><z id="t1705572705" t="Eric Dvorsak one thing that is complicating the debugging is that the logging is failing because: &quot;Execution error (IllegalArgumentException) at aleph.http.client/http1-req-handler$fn (client.clj:556). Multiple methods in multimethod &apos;print-method&apos; match dispatch value: class manifold.deferred.Deferred -&gt; interface java.util.concurrent.CompletionStage and interface manifold.deferred.IDeferred, and neither is preferred&quot;"><y>#</y><d>2024-01-18</d><h>10:11</h><r>Eric Dvorsak</r>one thing that is complicating the debugging is that the logging is failing because:
&quot;Execution error (IllegalArgumentException) at aleph.http.client/http1-req-handler$fn (client.clj:556).
Multiple methods in multimethod &apos;print-method&apos; match dispatch value: class manifold.deferred.Deferred -&gt; interface java.util.concurrent.CompletionStage and interface manifold.deferred.IDeferred, and neither is preferred&quot;</z><z id="t1705572747" t="Matthew Davidson (kingmob) Huh, that&apos;s new"><y>#</y><d>2024-01-18</d><h>10:12</h><r>Matthew Davidson (kingmob)</r>Huh, that&apos;s new</z><z id="t1705572759" t="Eric Dvorsak its from (log/debug &quot;http1-req-handler - response: &quot; resp)"><y>#</y><d>2024-01-18</d><h>10:12</h><r>Eric Dvorsak</r>its from (log/debug &quot;http1-req-handler - response: &quot; resp)</z><z id="t1705573091" t="Matthew Davidson (kingmob) Is promesa in your deps?"><y>#</y><d>2024-01-18</d><h>10:18</h><r>Matthew Davidson (kingmob)</r>Is promesa in your deps?</z><z id="t1705573173" t="Matthew Davidson (kingmob) Manifold deferreds implement CompletionStage as of 0.4.x, but CompletionStage isn&apos;t a type used for print-method . Promesa adds that, though"><y>#</y><d>2024-01-18</d><h>10:19</h><r>Matthew Davidson (kingmob)</r>Manifold deferreds implement CompletionStage as of 0.4.x, but CompletionStage isn&apos;t a type used for <code>print-method</code>. Promesa adds that, though</z><z id="t1705573201" t="Matthew Davidson (kingmob) Try (prefer-method print-method IDeferred CompletionStage)"><y>#</y><d>2024-01-18</d><h>10:20</h><r>Matthew Davidson (kingmob)</r>Try <code>(prefer-method print-method IDeferred CompletionStage)</code></z><z id="t1705573202" t="Eric Dvorsak yes looks like promesa is in the deps tree"><y>#</y><d>2024-01-18</d><h>10:20</h><r>Eric Dvorsak</r>yes looks like promesa is in the deps tree</z><z id="t1705573232" t="Eric Dvorsak coming from transit and http-kit as transitive deps"><y>#</y><d>2024-01-18</d><h>10:20</h><r>Eric Dvorsak</r>coming from transit and http-kit as transitive deps</z><z id="t1705573273" t="Matthew Davidson (kingmob) Does the prefer-method call fix that?"><y>#</y><d>2024-01-18</d><h>10:21</h><r>Matthew Davidson (kingmob)</r>Does the <code>prefer-method</code> call fix that?</z><z id="t1705573376" t="Eric Dvorsak I have to figure how to call it it says unable to resolve symbol IDeferred"><y>#</y><d>2024-01-18</d><h>10:22</h><r>Eric Dvorsak</r>I have to figure how to call it it says unable to resolve symbol IDeferred</z><z id="t1705573419" t="Matthew Davidson (kingmob) Try it from the manifold.deferred ns?"><y>#</y><d>2024-01-18</d><h>10:23</h><r>Matthew Davidson (kingmob)</r>Try it from the <code>manifold.deferred</code> ns?</z><z id="t1705573429" t="Matthew Davidson (kingmob) That&apos;s where IDeferred is defined anyway"><y>#</y><d>2024-01-18</d><h>10:23</h><r>Matthew Davidson (kingmob)</r>That&apos;s where IDeferred is defined anyway</z><z id="t1705573607" t="Eric Dvorsak yeah it fixed everything"><y>#</y><d>2024-01-18</d><h>10:26</h><r>Eric Dvorsak</r>yeah it fixed everything</z><z id="t1705573631" t="Eric Dvorsak looks like that was the whole issue, this added debug statement was triggering the exception"><y>#</y><d>2024-01-18</d><h>10:27</h><r>Eric Dvorsak</r>looks like that was the whole issue, this added debug statement was triggering the exception</z><z id="t1705573671" t="Matthew Davidson (kingmob) Wait, it fixed everything? Or it just fixed your ability to see the errors you&apos;re interested in? üòÑ"><y>#</y><d>2024-01-18</d><h>10:27</h><r>Matthew Davidson (kingmob)</r>Wait, it fixed everything? Or it just fixed your ability to see the errors you&apos;re interested in? <b>üòÑ</b></z><z id="t1705573704" t="Eric Dvorsak looks like the error was what was interrupting the connection so yes everything"><y>#</y><d>2024-01-18</d><h>10:28</h><r>Eric Dvorsak</r>looks like the error was what was interrupting the connection so yes everything</z><z id="t1705573787" t="Matthew Davidson (kingmob) Heh. OK, we&apos;ll cut a release updating Manifold and Aleph."><y>#</y><d>2024-01-18</d><h>10:29</h><r>Matthew Davidson (kingmob)</r>Heh. OK, we&apos;ll cut a release updating Manifold and Aleph.</z><z id="t1705573803" t="Eric Dvorsak thanks for the help!"><y>#</y><d>2024-01-18</d><h>10:30</h><r>Eric Dvorsak</r>thanks for the help!</z><z id="t1705573812" t="Matthew Davidson (kingmob) No prob"><y>#</y><d>2024-01-18</d><h>10:30</h><r>Matthew Davidson (kingmob)</r>No prob</z><z id="t1706089928" t="Eric Dvorsak I see a lot of these logs with aleph 0.7 that I didn&apos;t see before with 0.6: 2024-01-24 09:52:39.713 [prod_02] [WARN] aleph.http.client exception-handler #error { :cause Connection reset :via [{:type java.net.SocketException :message Connection reset :at [sun.nio.ch.SocketChannelImpl throwConnectionReset nil -1]}] :trace [[sun.nio.ch.SocketChannelImpl throwConnectionReset nil -1] [sun.nio.ch.SocketChannelImpl read nil -1] [io.netty.buffer.PooledByteBuf setBytes PooledByteBuf.java 254] [io.netty.buffer.AbstractByteBuf writeBytes AbstractByteBuf.java 1132] [io.netty.channel.socket.nio.NioSocketChannel doReadBytes NioSocketChannel.java 357] [io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe read AbstractNioByteChannel.java 151] [io.netty.channel.nio.NioEventLoop processSelectedKey NioEventLoop.java 788] [io.netty.channel.nio.NioEventLoop processSelectedKeysOptimized NioEventLoop.java 724] [io.netty.channel.nio.NioEventLoop processSelectedKeys NioEventLoop.java 650] [io.netty.channel.nio.NioEventLoop run NioEventLoop.java 562] [io.netty.util.concurrent.SingleThreadEventExecutor$4 run SingleThreadEventExecutor.java 997] [io.netty.util.internal.ThreadExecutorMap$2 run ThreadExecutorMap.java 74] [manifold.executor$thread_factory$reify__33943$f__33944 invoke executor.clj 71] [clojure.lang.AFn run AFn.java 22] [io.netty.util.concurrent.FastThreadLocalRunnable run FastThreadLocalRunnable.java 30] [java.lang.Thread run nil -1]]} 2024-01-24 09:53:34.276 [prod_02] [INFO] aleph.netty SSL handshake completed 2024-01-24 09:53:34.308 [prod_02] [INFO] aleph.netty SSL handshake completed 2024-01-24 09:55:39.592 [prod_02] [WARN] aleph.http.client exception-handler #error { The INFO ones might just be DEBUG level? Are the WARN ones a big deal? Nothing seem to have failed in the app otherwise, there is no other logs so its hard to tell"><y>#</y><d>2024-01-24</d><h>09:52</h><w>Eric Dvorsak</w>I see a lot of these logs with aleph 0.7 that I didn&apos;t see before with 0.6:

<pre>2024-01-24 09:52:39.713 [prod_02] [WARN] aleph.http.client exception-handler #error {
 :cause Connection reset
 :via
 [{:type java.net.SocketException
   :message Connection reset
   :at [sun.nio.ch.SocketChannelImpl throwConnectionReset nil -1]}]
 :trace
 [[sun.nio.ch.SocketChannelImpl throwConnectionReset nil -1]
  [sun.nio.ch.SocketChannelImpl read nil -1]
  [io.netty.buffer.PooledByteBuf setBytes PooledByteBuf.java 254]
  [io.netty.buffer.AbstractByteBuf writeBytes AbstractByteBuf.java 1132]
  [io.netty.channel.socket.nio.NioSocketChannel doReadBytes NioSocketChannel.java 357]
  [io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe read AbstractNioByteChannel.java 151]
  [io.netty.channel.nio.NioEventLoop processSelectedKey NioEventLoop.java 788]
  [io.netty.channel.nio.NioEventLoop processSelectedKeysOptimized NioEventLoop.java 724]
  [io.netty.channel.nio.NioEventLoop processSelectedKeys NioEventLoop.java 650]
  [io.netty.channel.nio.NioEventLoop run NioEventLoop.java 562]
  [io.netty.util.concurrent.SingleThreadEventExecutor$4 run SingleThreadEventExecutor.java 997]
  [io.netty.util.internal.ThreadExecutorMap$2 run ThreadExecutorMap.java 74]
  [manifold.executor$thread_factory$reify__33943$f__33944 invoke executor.clj 71]
  [clojure.lang.AFn run AFn.java 22]
  [io.netty.util.concurrent.FastThreadLocalRunnable run FastThreadLocalRunnable.java 30]
  [java.lang.Thread run nil -1]]}


2024-01-24 09:53:34.276 [prod_02] [INFO] aleph.netty SSL handshake completed
2024-01-24 09:53:34.308 [prod_02] [INFO] aleph.netty SSL handshake completed
2024-01-24 09:55:39.592 [prod_02] [WARN] aleph.http.client exception-handler #error {</pre>
The INFO ones might just be DEBUG level?
Are the WARN ones a big deal? Nothing seem to have failed in the app otherwise, there is no other logs so its hard to tell</z><z id="t1706095270" t="Matthew Davidson (kingmob) Yeah, we could change the SSL handshake to debug level. It&apos;s not that interesting. The &quot;Connection reset&quot; SocketException could be from a normal peer-initiated reset, it could be a timeout, etc. Whether it&apos;s of concern depends on the application and the network behavior, which is why it&apos;s only a warning. In general, older Aleph lacked a lot of logging, so people should expect to see more information with 0.7.0+."><y>#</y><d>2024-01-24</d><h>11:21</h><w>Matthew Davidson (kingmob)</w>Yeah, we could change the SSL handshake to debug level. It&apos;s not that interesting.

The &quot;Connection reset&quot; SocketException could be from a normal peer-initiated reset, it could be a timeout, etc. Whether it&apos;s of concern depends on the application and the network behavior, which is why it&apos;s only a warning.

In general, older Aleph lacked a lot of logging, so people should expect to see more information with 0.7.0+.</z><z id="t1706257083" t="Eric Dvorsak But wouldn‚Äôt setting the log level for that namespace suppress other maybe more important warnings?"><y>#</y><d>2024-01-26</d><h>08:18</h><r>Eric Dvorsak</r>But wouldn‚Äôt setting the log level for that namespace suppress other maybe more important warnings?</z><z id="t1706259198" t="Matthew Davidson (kingmob) Yes, which is why I downgraded the log level for the handshake in 0.7.1"><y>#</y><d>2024-01-26</d><h>08:53</h><r>Matthew Davidson (kingmob)</r>Yes, which is why I downgraded the log level for the handshake in 0.7.1</z><z id="t1706259248" t="Eric Dvorsak Ye thanks for that. I was talking about the connection reset here"><y>#</y><d>2024-01-26</d><h>08:54</h><r>Eric Dvorsak</r>Ye thanks for that. I was talking about the connection reset here</z><z id="t1706266862" t="Matthew Davidson (kingmob) Ahh. I think that should be left as a warning for now. It&apos;s really hard to know how a user wants to interpret it. It&apos;s true connection resets are just a fact of life, though, so if people find it&apos;s just useless noise, I can downgrade it to info. But generally, that should be left up to them. If you&apos;re using log4j, RegexFilters in the config can remove those particular lines. I assume other logging platforms have similar capabilities."><y>#</y><d>2024-01-26</d><h>11:01</h><r>Matthew Davidson (kingmob)</r>Ahh. I think that should be left as a warning for now. It&apos;s really hard to know how a user wants to interpret it. It&apos;s true connection resets are just a fact of life, though, so if people find it&apos;s just useless noise, I can downgrade it to info. But generally, that should be left up to them.

If you&apos;re using log4j, RegexFilters in the config can remove those particular lines. I assume other logging platforms have similar capabilities.</z><z id="t1706678441" t="valerauko Could the aleph-client logger be unified into aleph.http.client? Currently it has to be specified separately in logback.xml and is not caught by logger name=&quot;aleph&quot;"><y>#</y><d>2024-01-31</d><h>05:20</h><r>valerauko</r>Could the aleph-client logger be unified into aleph.http.client?

Currently it has to be specified separately in logback.xml and is not caught by logger name=&quot;aleph&quot;</z><z id="t1706840118" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] can you give me some more details? I‚Äôm not sure what you mean here. "><y>#</y><d>2024-02-02</d><h>02:15</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> can you give me some more details? I‚Äôm not sure what you mean here. </z><z id="t1706848066" t="valerauko Making a http request using aleph, a bunch of debug log lines are emitted. The &quot;logger&quot; is identified as aleph.http.common, aleph.http.core, aleph.http.client, and some are aleph-client. The dot-separated ones, I can filter as one in logback.xml with logger=&quot;aleph&quot;, but aleph-client slips through"><y>#</y><d>2024-02-02</d><h>04:27</h><r>valerauko</r>Making a http request using aleph, a bunch of debug log lines are emitted.

The &quot;logger&quot; is identified as aleph.http.common, aleph.http.core, aleph.http.client, and some are aleph-client.

The dot-separated ones, I can filter as one in logback.xml with logger=&quot;aleph&quot;, but aleph-client slips through</z><z id="t1706858049" t="Matthew Davidson (kingmob) Ahh, those are logs emitted by Netty&apos;s LoggingHandler on Aleph&apos;s behalf. Depending on what you&apos;re trying to do, you could bump up the logging level by setting :log-activity :warning or :log-activity :info , etc. You can try applying filters on the Netty namespaces, either io.netty.handler.logging or whatever class the InternalLogger is. Can also pass :log-activity nil to disable it."><y>#</y><d>2024-02-02</d><h>07:14</h><r>Matthew Davidson (kingmob)</r>Ahh, those are logs emitted by Netty&apos;s LoggingHandler on Aleph&apos;s behalf. Depending on what you&apos;re trying to do, you could bump up the logging level by setting <code>:log-activity :warning</code> or <code>:log-activity :info</code>, etc. You can try applying filters on the Netty namespaces, either io.netty.handler.logging or whatever class the InternalLogger is. Can also pass <code>:log-activity nil</code> to disable it.</z><z id="t1707057253" t="valerauko Well that&apos;s the thing, I&apos;ve already set all the netty and aleph namespaced loggers to warn, but aleph-client still goes through"><y>#</y><d>2024-02-04</d><h>14:34</h><r>valerauko</r>Well that&apos;s the thing, I&apos;ve already set all the netty and aleph namespaced loggers to warn, but aleph-client still goes through</z><z id="t1707119114" t="Matthew Davidson (kingmob) Including setting :log-activity :warning ?"><y>#</y><d>2024-02-05</d><h>07:45</h><r>Matthew Davidson (kingmob)</r>Including setting <code>:log-activity :warning</code>?</z><z id="t1707120112" t="valerauko I was not aware of that setting, let me try"><y>#</y><d>2024-02-05</d><h>08:01</h><r>valerauko</r>I was not aware of that setting, let me try</z><z id="t1706181461" t="Matthew Davidson (kingmob)"><y>#</y><d>2024-01-25</d><h>11:17</h><w>Matthew Davidson (kingmob)</w></z><z id="t1706675177" t="valerauko What&apos;s the right way currently to set timeouts on aleph client requests?"><y>#</y><d>2024-01-31</d><h>04:26</h><w>valerauko</w>What&apos;s the right way currently to set timeouts on aleph client requests?</z><z id="t1706714149" t="Matthew Davidson (kingmob) Probably via manifold.deferred/timeout! . E.g.: (-&gt; (http/get &quot;&quot;) (d/timeout! 10000) (d/catch TimeoutException (log/error &quot;took too long&quot;))) "><y>#</y><d>2024-01-31</d><h>15:15</h><w>Matthew Davidson (kingmob)</w>Probably via <code>manifold.deferred/timeout!</code>. E.g.:

<pre>(-&gt; (http/get &quot;&quot;)
    (d/timeout! 10000)
    (d/catch TimeoutException
      (log/error &quot;took too long&quot;)))</pre>
</z><z id="t1706719385" t="hiredman Does that terminate the http request though?"><y>#</y><d>2024-01-31</d><h>16:43</h><r>hiredman</r>Does that terminate the http request though?</z><z id="t1706726865" t="Arnaud Geiser No, it&apos;s not going to cancel the HTTP request. You might have to use request-timeout instead. Something along those lines : (http/get &quot;&quot; {:request-timeout 2000}) "><y>#</y><d>2024-01-31</d><h>18:47</h><r>Arnaud Geiser</r>No, it&apos;s not going to cancel the HTTP request.
You might have to use <code>request-timeout</code> instead.
Something along those lines :

<pre>(http/get &quot;&quot; {:request-timeout 2000})</pre>
</z><z id="t1706726882" t="Arnaud Geiser &gt; https://github.com/exoscale/aleph/blob/master/src/aleph/http.clj#L295"><y>#</y><d>2024-01-31</d><h>18:48</h><r>Arnaud Geiser</r>&gt; <a href="https://github.com/exoscale/aleph/blob/master/src/aleph/http.clj#L295" target="_blank">https://github.com/exoscale/aleph/blob/master/src/aleph/http.clj#L295</a></z><z id="t1706746399" t="valerauko Thanks for the reference!"><y>#</y><d>2024-02-01</d><h>00:13</h><r>valerauko</r>Thanks for the reference!</z><z id="t1706794833" t="dergutemoritz Ah but note that that timeout doesn&apos;t include the connection establishment which would be controlled via connection-timeout and defaults to 60s"><y>#</y><d>2024-02-01</d><h>13:40</h><r>dergutemoritz</r>Ah but note that that timeout doesn&apos;t include the connection establishment which would be controlled via <code>connection-timeout</code> and defaults to 60s</z><z id="t1706794869" t="dergutemoritz Which might be surprising depending on whether you consider connection establishment part of the request or not"><y>#</y><d>2024-02-01</d><h>13:41</h><r>dergutemoritz</r>Which might be surprising depending on whether you consider connection establishment part of the request or not</z><z id="t1706794988" t="dergutemoritz Hmm does the HTTP client even offer an API for cancelling a request?"><y>#</y><d>2024-02-01</d><h>13:43</h><r>dergutemoritz</r>Hmm does the HTTP client even offer an API for cancelling a request?</z><z id="t1706795449" t="dergutemoritz Marking the response deferred as failed (via d/error! ) doesn&apos;t seem to do so"><y>#</y><d>2024-02-01</d><h>13:50</h><r>dergutemoritz</r>Marking the response deferred as failed (via <code>d/error!</code>) doesn&apos;t seem to do so</z><z id="t1706795516" t="dergutemoritz So we can&apos;t have a timeout which spans the whole deal with e.g. (-&gt; (http/get &quot;...&quot;) (d/timeout! 1000))"><y>#</y><d>2024-02-01</d><h>13:51</h><r>dergutemoritz</r>So we can&apos;t have a timeout which spans the whole deal with e.g. <code>(-&gt; (http/get &quot;...&quot;) (d/timeout! 1000))</code></z><z id="t1706795529" t="dergutemoritz it leaves the HTTP request (and connection) hanging"><y>#</y><d>2024-02-01</d><h>13:52</h><r>dergutemoritz</r>it leaves the HTTP request (and connection) hanging</z><z id="t1706796021" t="dergutemoritz (assuming the connection was successfully established, no request-timeout was given and the other end just doesn&apos;t respond any further)"><y>#</y><d>2024-02-01</d><h>14:00</h><r>dergutemoritz</r>(assuming the connection was successfully established, no <code>request-timeout</code> was given and the other end just doesn&apos;t respond any further)</z><z id="t1706809786" t="Matthew Davidson (kingmob) Cancellation is soemthing Zach and Oleksii talked about, but never got around to, sadly"><y>#</y><d>2024-02-01</d><h>17:49</h><r>Matthew Davidson (kingmob)</r>Cancellation is soemthing Zach and Oleksii talked about, but never got around to, sadly</z><z id="t1706810153" t="Matthew Davidson (kingmob) You can see it here: https://github.com/clj-commons/manifold/issues/167"><y>#</y><d>2024-02-01</d><h>17:55</h><r>Matthew Davidson (kingmob)</r>You can see it here: <a href="https://github.com/clj-commons/manifold/issues/167" target="_blank">https://github.com/clj-commons/manifold/issues/167</a></z><z id="t1706811690" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/UAEH11THP&quot;}] Best bet is one of the :*-timeout params. Arnaud mentioned connection-timeout which measures how long to get a connection. ‚Ä¢ connection-timeout ‚Ä¢ pool-timeout ‚Ä¢ request-timeout ‚Ä¢ read-timeout request-timeout measures time til the initial Ring map is ready, not necessarily including the body. read-timeout measures how long for the overall response to be finished (successfully or not). pool-timeout is almost the same thing as connection-timeout , I&apos;d ignore it for now All of those timeouts will result in the overall conn being closed early"><y>#</y><d>2024-02-01</d><h>18:21</h><r>Matthew Davidson (kingmob)</r><a>@UAEH11THP</a> Best bet is one of the <code>:*-timeout</code> params. Arnaud mentioned <code>connection-timeout</code> which measures how long to get a connection.

‚Ä¢ connection-timeout
‚Ä¢ pool-timeout
‚Ä¢ request-timeout
‚Ä¢ read-timeout
<code>request-timeout</code> measures time til the initial Ring map is ready, not necessarily including the body. <code>read-timeout</code> measures how long for the overall response to be finished (successfully or not). <code>pool-timeout</code>is almost the same thing as <code>connection-timeout</code>, I&apos;d ignore it for now

All of those timeouts will result in the overall conn being closed early</z><z id="t1706811741" t="Matthew Davidson (kingmob) (Sorry I misunderstood. A top-level timeout! is still fine if you don&apos;t care about killing the connection early.)"><y>#</y><d>2024-02-01</d><h>18:22</h><r>Matthew Davidson (kingmob)</r>(Sorry I misunderstood. A top-level <code>timeout!</code> is still fine if you don&apos;t care about killing the connection early.)</z><z id="t1706815313" t="hiredman the reason I asked about if the timeout on the deferred actually killed the http request is because if you squint at it hard enough it is the same issue as https://github.com/clj-commons/manifold/issues/159 ; deferreds that are realized after a timeout can be seen as making a request to a timeout server, and that request doesn&apos;t complete until the timeout expires, and when the timeout expires it realizes the deferred, but you don&apos;t want to leave outstanding requests to the &quot;timeout server&quot; hanging around if the deferreds are canceled"><y>#</y><d>2024-02-01</d><h>19:21</h><r>hiredman</r>the reason I asked about if the timeout on the deferred actually killed the http request is because if you squint at it hard enough it is the same issue as <a href="https://github.com/clj-commons/manifold/issues/159" target="_blank">https://github.com/clj-commons/manifold/issues/159</a>; deferreds that are realized after a timeout can be seen as making a request to a timeout server, and that request doesn&apos;t complete until the timeout expires, and when the timeout expires it realizes the deferred, but you don&apos;t want to leave outstanding requests to the &quot;timeout server&quot; hanging around if the deferreds are canceled</z><z id="t1706840628" t="Matthew Davidson (kingmob) I know the various *-timeout params will result in Netty closing the connection channel, which should free up all associated resources. As for a top-level timeout! I‚Äôd have to check. That issue, and its fix, predate me, and I‚Äôm not super-familiar with that code off the top of my head. Gonna be a while before I can take a look though. Is it an active concern or are you just curious?"><y>#</y><d>2024-02-02</d><h>02:23</h><r>Matthew Davidson (kingmob)</r>I know the various <code>*-timeout</code> params will result in Netty closing the connection channel, which should free up all associated resources. 

As for a top-level timeout! I‚Äôd have to check. That issue, and its fix, predate me, and I‚Äôm not super-familiar with that code off the top of my head. 

Gonna be a while before I can take a look though. Is it an active concern or are you just curious?</z><z id="t1706841711" t="hiredman Not an active concern at all. The issue I linked is closed. I am not really a manifold user, but I have spent a lot of time poking at the timeout code in core.async where it still has a resource &quot;leak&quot; that roughly corresponds to the one fixed in that ticket, and thinking about how to solve that kind of thing using a generic mechanism instead of separately solving it for each kind of thing"><y>#</y><d>2024-02-02</d><h>02:41</h><r>hiredman</r>Not an active concern at all. The issue I linked is closed. I am not really a manifold user, but I have spent a lot of time poking at the timeout code in core.async where it still has a resource &quot;leak&quot; that roughly corresponds to the one fixed in that ticket, and thinking about how to solve that kind of thing using a generic mechanism instead of separately solving it for each kind of thing</z><z id="t1707333620" t="dergutemoritz Yep, will do!"><y>#</y><d>2024-02-07</d><h>19:20</h><r>dergutemoritz</r>Yep, will do!</z><z id="t1707734254" t="dergutemoritz Here we go: https://github.com/clj-commons/aleph/issues/712"><y>#</y><d>2024-02-12</d><h>10:37</h><r>dergutemoritz</r>Here we go: <a href="https://github.com/clj-commons/aleph/issues/712" target="_blank">https://github.com/clj-commons/aleph/issues/712</a></z><z id="t1707734281" t="dergutemoritz FWIW, I almost have a patch ready for the second suggested solution"><y>#</y><d>2024-02-12</d><h>10:38</h><r>dergutemoritz</r>FWIW, I almost have a patch ready for the second suggested solution</z><z id="t1707751664" t="dergutemoritz OK somewhat ready: https://github.com/clj-commons/aleph/pull/714 üòâ"><y>#</y><d>2024-02-12</d><h>15:27</h><r>dergutemoritz</r>OK somewhat ready: <a href="https://github.com/clj-commons/aleph/pull/714" target="_blank">https://github.com/clj-commons/aleph/pull/714</a> <b>üòâ</b></z><z id="t1706828451" t="Nim Sadeh I wonder if I missed something in the documentation, because this was a real headscratcher: (defn handler [_] {:status 200 :body true }) Hangs up the request indefinitely, whereas (defn handler [_] {:status 200 :body &quot;true&quot; }) does not"><y>#</y><d>2024-02-01</d><h>23:00</h><w>Nim Sadeh</w>I wonder if I missed something in the documentation, because this was a real headscratcher:

<pre>(defn handler [_]
  {:status 200
   :body true
  })</pre>
Hangs up the request indefinitely, whereas

<pre>(defn handler [_]
  {:status 200
   :body &quot;true&quot;
  })</pre>
does not</z><z id="t1706830991" t="hiredman the first handler is likely throwing an exception somewhere, the ring spec says body has to implement StreamableResponseBody ( https://github.com/ring-clojure/ring/blob/master/ring-core/src/ring/core/protocols.clj )"><y>#</y><d>2024-02-01</d><h>23:43</h><r>hiredman</r>the first handler is likely throwing an exception somewhere, the ring spec says body has to implement StreamableResponseBody (<a href="https://github.com/ring-clojure/ring/blob/master/ring-core/src/ring/core/protocols.clj" target="_blank">https://github.com/ring-clojure/ring/blob/master/ring-core/src/ring/core/protocols.clj</a>)</z><z id="t1706831015" t="hiredman and StreamableResponseBody is not extended to Booleans there"><y>#</y><d>2024-02-01</d><h>23:43</h><r>hiredman</r>and StreamableResponseBody is not extended to Booleans there</z><z id="t1706831034" t="hiredman I don&apos;t know how closely aleph hews to the ring spec"><y>#</y><d>2024-02-01</d><h>23:43</h><r>hiredman</r>I don&apos;t know how closely aleph hews to the ring spec</z><z id="t1706831227" t="hiredman looks like aleph doesn&apos;t do the ring protocol thing at all, but also doesn&apos;t have built in handling for Boolean"><y>#</y><d>2024-02-01</d><h>23:47</h><r>hiredman</r>looks like aleph doesn&apos;t do the ring protocol thing at all, but also doesn&apos;t have built in handling for Boolean</z><z id="t1706857241" t="Matthew Davidson (kingmob) Aleph hews to the Ring spec for the most part, but with added support for Manifold streams where it makes sense (like for bodies in raw mode). We should probably extend that protocol too, but nobody&apos;s ever complained, so I don&apos;t know if it&apos;s actually a concern. Anyway, [:attrs {:href &quot;/_/_/users/U05D3EAA6FM&quot;}] , hiredman has the right idea. Raw true is not allowed, and probably causing an exception somewhere. If you&apos;re using an older Aleph, it might not be logged, but if you&apos;re using the new Aleph 0.7.x, I&apos;d expect that be logged, and will treat the lack of logging as a bug."><y>#</y><d>2024-02-02</d><h>07:00</h><r>Matthew Davidson (kingmob)</r>Aleph hews to the Ring spec for the most part, but with added support for Manifold streams where it makes sense (like for bodies in raw mode). We should probably extend that protocol too, but nobody&apos;s ever complained, so I don&apos;t know if it&apos;s actually a concern.

Anyway, <a>@U05D3EAA6FM</a>, hiredman has the right idea. Raw <code>true</code> is not allowed, and probably causing an exception somewhere. If you&apos;re using an older Aleph, it might not be logged, but if you&apos;re using the new Aleph 0.7.x, I&apos;d expect that be logged, and will treat the lack of logging as a bug.</z><z id="t1707205490" t="valerauko How do I return a Buffered (or ByteArray) OutputStream as a response body in aleph?"><y>#</y><d>2024-02-06</d><h>07:44</h><w>valerauko</w>How do I return a Buffered (or ByteArray) OutputStream as a response body in aleph?</z><z id="t1707205525" t="valerauko I generate a zip archive in the handler and I&apos;d need to return the results, but aleph can&apos;t seem to handle either BufferedOutputStream or ByteArrayOutputStream"><y>#</y><d>2024-02-06</d><h>07:45</h><r>valerauko</r>I generate a zip archive in the handler and I&apos;d need to return the results, but aleph can&apos;t seem to handle either BufferedOutputStream or ByteArrayOutputStream</z><z id="t1707205684" t="valerauko I was kinda expecting aleph to handle this automagically, considering the existence of byte-streams and all"><y>#</y><d>2024-02-06</d><h>07:48</h><r>valerauko</r>I was kinda expecting aleph to handle this automagically, considering the existence of byte-streams and all</z><z id="t1707206773" t="oyakushev Doesn&apos;t seem weird to me, tbh, it&apos;s an output stream after all."><y>#</y><d>2024-02-06</d><h>08:06</h><r>oyakushev</r>Doesn&apos;t seem weird to me, tbh, it&apos;s an output stream after all.</z><z id="t1707206894" t="valerauko I&apos;m supposed to write a response body, not read it"><y>#</y><d>2024-02-06</d><h>08:08</h><r>valerauko</r>I&apos;m supposed to write a response body, not read it</z><z id="t1707207210" t="oyakushev Yeah, I suppose you can frame it that way, but Aleph reads bytes from :body to transfer them over the network."><y>#</y><d>2024-02-06</d><h>08:13</h><r>oyakushev</r>Yeah, I suppose you can frame it that way, but Aleph reads bytes from :body to transfer them over the network.</z><z id="t1707207335" t="oyakushev The problem with BufferedOutputStream interface is that it doesn&apos;t guarantee that the bytes can be read back"><y>#</y><d>2024-02-06</d><h>08:15</h><r>oyakushev</r>The problem with BufferedOutputStream interface is that it doesn&apos;t guarantee that the bytes can be read back</z><z id="t1707207382" t="oyakushev BAOS is another story, it can be converted back into something readable, but it&apos;s reasonable to expect user to do it manually."><y>#</y><d>2024-02-06</d><h>08:16</h><r>oyakushev</r>BAOS is another story, it can be converted back into something readable, but it&apos;s reasonable to expect user to do it manually.</z><z id="t1707207464" t="valerauko Which is what I ended up doing (calling toByteArray), but it feels like a weird extra step when aleph can handle even async streams as response body"><y>#</y><d>2024-02-06</d><h>08:17</h><r>valerauko</r>Which is what I ended up doing (calling toByteArray), but it feels like a weird extra step when aleph can handle even async streams as response body</z><z id="t1707207649" t="oyakushev But those are async input streams, still üôÇ"><y>#</y><d>2024-02-06</d><h>08:20</h><r>oyakushev</r>But those are async input streams, still <b>üôÇ</b></z></g><g id="s11"><z id="t1707207682" t="oyakushev I&apos;ve just tried, byte-streams doesn&apos;t define a path from BAOS to input-stream"><y>#</y><d>2024-02-06</d><h>08:21</h><r>oyakushev</r>I&apos;ve just tried, byte-streams doesn&apos;t define a path from BAOS to input-stream</z><z id="t1707207757" t="oyakushev And neither to byte array which is a bit weird, I have to agree"><y>#</y><d>2024-02-06</d><h>08:22</h><r>oyakushev</r>And neither to byte array which is a bit weird, I have to agree</z><z id="t1707213705" t="Matthew Davidson (kingmob) Yeah, the Input/Output distinction is a bit weird, but as Alex points out, what happens is, whoever gets the response map needs to read the body, not write it, so it has to be an *Input*Stream. Also see the bottom of https://github.com/ring-clojure/ring/blob/2.0/SPEC-1 &gt; byte-streams doesn&apos;t define a path from BAOS to input-stream byte-streams predates me, but my guess is Zach wasn&apos;t thinking about having byte-streams convert between input, output, and non-stream formats, but only convert within them."><y>#</y><d>2024-02-06</d><h>10:01</h><r>Matthew Davidson (kingmob)</r>Yeah, the Input/Output distinction is a bit weird, but as Alex points out, what happens is, whoever gets the response map needs to read the body, not write it, so it has to be an *Input*Stream.

Also see the bottom of <a href="https://github.com/ring-clojure/ring/blob/2.0/SPEC-1" target="_blank">https://github.com/ring-clojure/ring/blob/2.0/SPEC-1</a>

&gt; byte-streams doesn&apos;t define a path from BAOS to input-stream
<code>byte-streams</code> predates me, but my guess is Zach wasn&apos;t thinking about having byte-streams convert between input, output, and non-stream formats, but only convert within them.</z><z id="t1707221257" t="valerauko &gt; whoever gets the response map needs to read the body, not write it Is it just me or that doesn&apos;t make sense? The one who gets (passes on) the response is aleph (netty). The recipient is on the other end of the network connection (and request maps do have InputStream :body&apos;s). Saying that it should be an InputStream because aleph receives it is like saying every OutputStream should be an InputStream because the JVM &quot;receives&quot; (passes on) the data. From the user-facing API&apos;s point of view it should be an OutputStream"><y>#</y><d>2024-02-06</d><h>12:07</h><r>valerauko</r>&gt; whoever gets the response map needs to read the body, not write it
Is it just me or that doesn&apos;t make sense? The one who gets (passes on) the response is aleph (netty). The recipient is on the other end of the network connection (and request maps do have InputStream :body&apos;s). Saying that it should be an InputStream because aleph receives it is like saying every OutputStream should be an InputStream because the JVM &quot;receives&quot; (passes on) the data. From the user-facing API&apos;s point of view it should be an OutputStream</z><z id="t1707221299" t="Matthew Davidson (kingmob) Not if you&apos;re getting response maps from the Aleph client"><y>#</y><d>2024-02-06</d><h>12:08</h><r>Matthew Davidson (kingmob)</r>Not if you&apos;re getting response maps from the Aleph client</z><z id="t1707221371" t="valerauko Yes obviously on the client side it should be the other way around, because that&apos;s the user facing direction"><y>#</y><d>2024-02-06</d><h>12:09</h><r>valerauko</r>Yes obviously on the client side it should be the other way around, because that&apos;s the user facing direction</z><z id="t1707221420" t="Matthew Davidson (kingmob) Think of it more like producer/consumer"><y>#</y><d>2024-02-06</d><h>12:10</h><r>Matthew Davidson (kingmob)</r>Think of it more like producer/consumer</z><z id="t1707221458" t="Matthew Davidson (kingmob) The producer preps the body as an InputStream for the next link in the chain (Aleph on the server side, the user on the client-side) to read from"><y>#</y><d>2024-02-06</d><h>12:10</h><r>Matthew Davidson (kingmob)</r>The producer preps the body as an InputStream for the next link in the chain (Aleph on the server side, the user on the client-side) to read from</z><z id="t1707221539" t="Matthew Davidson (kingmob) I get that there&apos;s multiple ways of looking at it, since the server is outputting a body to be sent over the wire, I&apos;m just trying to describe a way that helps me keep it straight"><y>#</y><d>2024-02-06</d><h>12:12</h><r>Matthew Davidson (kingmob)</r>I get that there&apos;s multiple ways of looking at it, since the server is outputting a body to be sent over the wire, I&apos;m just trying to describe a way that helps me keep it straight</z><z id="t1707221611" t="valerauko Okay I get that point but it still feels extremely weird that I have to think in reverse when I create a server-side response"><y>#</y><d>2024-02-06</d><h>12:13</h><r>valerauko</r>Okay I get that point but it still feels extremely weird that I have to think in reverse when I create a server-side response</z><z id="t1707221635" t="oyakushev You could design the API in a way that :body is always an output stream that is given to the user, and the user is supposed to write their data into it."><y>#</y><d>2024-02-06</d><h>12:13</h><r>oyakushev</r>You could design the API in a way that <code>:body</code> is always an output stream that is given to the user, and the user is supposed to write their data into it.</z><z id="t1707221645" t="oyakushev But that&apos;s not how Ring spec is designed"><y>#</y><d>2024-02-06</d><h>12:14</h><r>oyakushev</r>But that&apos;s not how Ring spec is designed</z><z id="t1707221707" t="Matthew Davidson (kingmob) In the end, every output is the next thing&apos;s input..."><y>#</y><d>2024-02-06</d><h>12:15</h><r>Matthew Davidson (kingmob)</r>In the end, every output is the next thing&apos;s input...</z><z id="t1707221735" t="valerauko Exactly that&apos;s why it feels weird that I have to think about the next thing instead of what I&apos;m trying to do"><y>#</y><d>2024-02-06</d><h>12:15</h><r>valerauko</r>Exactly that&apos;s why it feels weird that I have to think about the next thing instead of what I&apos;m trying to do</z><z id="t1707221906" t="valerauko I understand it&apos;s ring and it&apos;s been like that for idk 20 years but it still feels wrong as API design"><y>#</y><d>2024-02-06</d><h>12:18</h><r>valerauko</r>I understand it&apos;s ring and it&apos;s been like that for idk 20 years but it still feels wrong as API design</z><z id="t1707221923" t="valerauko Guess it&apos;s all about the ancient limitations on java iostreams"><y>#</y><d>2024-02-06</d><h>12:18</h><r>valerauko</r>Guess it&apos;s all about the ancient limitations on java iostreams</z><z id="t1707221961" t="oyakushev It&apos;s not wrong"><y>#</y><d>2024-02-06</d><h>12:19</h><r>oyakushev</r>It&apos;s not wrong</z><z id="t1707221970" t="oyakushev You can&apos;t treat every output stream as an input stream, on an abstraction level. So you have to choose."><y>#</y><d>2024-02-06</d><h>12:19</h><r>oyakushev</r>You can&apos;t treat every output stream as an input stream, on an abstraction level. So you have to choose.</z><z id="t1707222030" t="Matthew Davidson (kingmob) Yeah, they kinda suck. But there weren&apos;t any good alternatives at the time, if you needed something potentially unbounded, or being generated on the fly."><y>#</y><d>2024-02-06</d><h>12:20</h><r>Matthew Davidson (kingmob)</r>Yeah, they kinda suck. But there weren&apos;t any good alternatives at the time, if you needed something potentially unbounded, or being generated on the fly.</z><z id="t1707222078" t="oyakushev If Ring had the same design as, say, Java&apos;s default HttpServer (where the API is exactly what you want, it gives you an outputstream to write into), you wouldn&apos;t be able to &quot;return&quot; anything as body anymore. Any string or byte array or a map would have to be statefully written into body manually."><y>#</y><d>2024-02-06</d><h>12:21</h><r>oyakushev</r>If Ring had the same design as, say, Java&apos;s default HttpServer (where the API is exactly what you want, it gives you an outputstream to write into), you wouldn&apos;t be able to &quot;return&quot; anything as body anymore. Any string or byte array or a map would have to be statefully written into body manually.</z><z id="t1707222366" t="valerauko I don&apos;t see how stitching output stream bodies into a streamablebody implementation would make the already streamablebody implementations suddenly not work, but this isn&apos;t a hill I&apos;m going to climb any higher on tonight ü§∑"><y>#</y><d>2024-02-06</d><h>12:26</h><r>valerauko</r>I don&apos;t see how stitching output stream bodies into a streamablebody implementation would make the already streamablebody implementations suddenly not work, but this isn&apos;t a hill I&apos;m going to climb any higher on tonight <b>ü§∑</b></z><z id="t1707222419" t="valerauko Times like this I wish java had some streaming API like Dart&apos;s generic streams"><y>#</y><d>2024-02-06</d><h>12:26</h><r>valerauko</r>Times like this I wish java had some streaming API like Dart&apos;s generic streams</z><z id="t1707244894" t="Arnaud Geiser Could we consider extend-protocol on ByteArrayOutputStream for StreamableResponseBody? Basically to make this transparent?"><y>#</y><d>2024-02-06</d><h>18:41</h><r>Arnaud Geiser</r>Could we consider <code>extend-protocol</code> on ByteArrayOutputStream for StreamableResponseBody? Basically to make this transparent?</z><z id="t1707301168" t="Matthew Davidson (kingmob) Maybe. But we own neither the protocol nor the impl, and that&apos;s liable to cause issues eventually ( https://github.com/funcool/promesa/issues/151 ). We could add a fallback condition to handle StreamableResponseBody if we can&apos;t identify the :body type, and leave it up to users to add types for their convenience. (We don&apos;t generally want to use StreamableResponseBody internally, since most of the time it&apos;ll just be overhead. It&apos;s not a very useful protocol IMO. We have better data types than java.io.*Stream for the server, and clients want to read, not write.)"><y>#</y><d>2024-02-07</d><h>10:19</h><r>Matthew Davidson (kingmob)</r>Maybe. But we own neither the protocol nor the impl, and that&apos;s liable to cause issues eventually (<a href="https://github.com/funcool/promesa/issues/151" target="_blank">https://github.com/funcool/promesa/issues/151</a>).

We could add a fallback condition to handle StreamableResponseBody if we can&apos;t identify the <code>:body</code> type, and leave it up to users to add types for their convenience.

(We don&apos;t generally want to use StreamableResponseBody internally, since most of the time it&apos;ll just be overhead. It&apos;s not a very useful protocol IMO. We have better data types than java.io.*Stream for the server, and clients want to read, not write.)</z><z id="t1707222716" t="valerauko Is there some way to financially support aleph (and related library) development? Since all our jvm clojure services use aleph it feels appropriate, but I can&apos;t seem to find a sponsorship link anywhere"><y>#</y><d>2024-02-06</d><h>12:31</h><w>valerauko</w>Is there some way to financially support aleph (and related library) development? Since all our jvm clojure services use aleph it feels appropriate, but I can&apos;t seem to find a sponsorship link anywhere</z><z id="t1707223376" t="jeroenvandijk [:attrs {:href &quot;/_/_/users/U10EC98F5&quot;}] can be sponsored here https://github.com/sponsors/KingMob"><y>#</y><d>2024-02-06</d><h>12:42</h><r>jeroenvandijk</r><a>@U10EC98F5</a> can be sponsored here <a href="https://github.com/sponsors/KingMob" target="_blank">https://github.com/sponsors/KingMob</a></z><z id="t1707223511" t="Matthew Davidson (kingmob) üôè"><y>#</y><d>2024-02-06</d><h>12:45</h><r>Matthew Davidson (kingmob)</r><b>üôè</b></z><z id="t1707223547" t="Matthew Davidson (kingmob) Arnaud and Moritz do a lot, too, but I don&apos;t know if they&apos;re set up for sponsorships"><y>#</y><d>2024-02-06</d><h>12:45</h><r>Matthew Davidson (kingmob)</r>Arnaud and Moritz do a lot, too, but I don&apos;t know if they&apos;re set up for sponsorships</z><z id="t1707223670" t="valerauko I&apos;ll try to get it on this year&apos;s budget üí™"><y>#</y><d>2024-02-06</d><h>12:47</h><r>valerauko</r>I&apos;ll try to get it on this year&apos;s budget <b>üí™</b></z><z id="t1707223690" t="Matthew Davidson (kingmob) That&apos;s very kind of you."><y>#</y><d>2024-02-06</d><h>12:48</h><r>Matthew Davidson (kingmob)</r>That&apos;s very kind of you.</z><z id="t1707244581" t="Arnaud Geiser On my side, my contribution to Aleph doesn&apos;t depend on financial support at all. I would say the limiting factor is time. The best investment is Matthew today since he both brings support and fixes within 24 hours. He also has some ideas to push Zach&apos;s ecosystem further as well. üôÇ"><y>#</y><d>2024-02-06</d><h>18:36</h><r>Arnaud Geiser</r>On my side, my contribution to Aleph doesn&apos;t depend on financial support at all. I would say the limiting factor is time. The best investment is Matthew today since he both brings support and fixes within 24 hours. He also has some ideas to push Zach&apos;s ecosystem further as well. <b>üôÇ</b></z><z id="t1707318202" t="Matthew Davidson (kingmob) My time has gotten crunched, I&apos;m afraid. I started working a new job this week, so I&apos;m a bit busier."><y>#</y><d>2024-02-07</d><h>15:03</h><r>Matthew Davidson (kingmob)</r>My time has gotten crunched, I&apos;m afraid. I started working a new job this week, so I&apos;m a bit busier.</z><z id="t1707731477" t="dergutemoritz I&apos;m contributing on company time since we&apos;re also using Aleph a lot, so I don&apos;t currently need sponsorship üôÇ"><y>#</y><d>2024-02-12</d><h>09:51</h><r>dergutemoritz</r>I&apos;m contributing on company time since we&apos;re also using Aleph a lot, so I don&apos;t currently need sponsorship <b>üôÇ</b></z><z id="t1707283688" t="valerauko Is there documentation on how to use io_uring with aleph?"><y>#</y><d>2024-02-07</d><h>05:28</h><w>valerauko</w>Is there documentation on how to use io_uring with aleph?</z><z id="t1707283724" t="valerauko Attempting to set :transport :io-uring results in a &quot;failed to create io_uring ring fd: Operation not permitted&quot; in a containerized environment."><y>#</y><d>2024-02-07</d><h>05:28</h><r>valerauko</r>Attempting to set <code>:transport :io-uring</code> results in a &quot;failed to create io_uring ring fd: Operation not permitted&quot; in a containerized environment.</z><z id="t1707283966" t="valerauko It&apos;s not a priority considering https://github.com/containerd/containerd/pull/9320"><y>#</y><d>2024-02-07</d><h>05:32</h><r>valerauko</r>It&apos;s not a priority considering <a href="https://github.com/containerd/containerd/pull/9320" target="_blank">https://github.com/containerd/containerd/pull/9320</a></z><z id="t1707292923" t="Arnaud Geiser In theory, it&apos;s just a matter of setting the &apos;:io-uring&apos; keyword as transport (exactly what you have done ). Everything else is transparent and should continue to behave the same inside your application (even inside the Aleph code-base). I&apos;m no IO Uring expert but there might be good explanation about why IO Uring cannot be used inside some containers environment. Probably documented and explained on some Netty issues."><y>#</y><d>2024-02-07</d><h>08:02</h><r>Arnaud Geiser</r>In theory, it&apos;s just a matter of setting the &apos;:io-uring&apos; keyword as transport (exactly what you have done ). Everything else is transparent and should continue to behave the same inside your application (even inside the Aleph code-base). I&apos;m no IO Uring expert but there might be good explanation about why IO Uring cannot be used inside some containers environment. Probably documented and explained on some Netty issues.</z><z id="t1707369470" t="valerauko I&apos;m trying to do the following: 1. upon receiving a http request (server side) 2. send a request to an upstream service with aleph client 3. there will be one or more cookies set in the response 4. I want to pass on these cookies (without using their values at all on the server side) and add a few more Does aleph provide some utilities to handle this?"><y>#</y><d>2024-02-08</d><h>05:17</h><w>valerauko</w>I&apos;m trying to do the following:

1. upon receiving a http request (server side)
2. send a request to an upstream service with aleph client
3. there will be one or more cookies set in the response
4. I want to pass on these cookies (without using their values at all on the server side) and add a few more 
Does aleph provide some utilities to handle this?</z><z id="t1707369580" t="valerauko My idea was something like (let [response @(fetch upstream) additional-cookies [&quot;foo=bar&quot; &quot;a=b&quot;]] {:status 200 :headers (update (:headers response) &quot;set-cookie&quot; concat additional-cookies}) but this method did not work."><y>#</y><d>2024-02-08</d><h>05:19</h><r>valerauko</r>My idea was something like
<pre>(let [response @(fetch upstream)
      additional-cookies [&quot;foo=bar&quot; &quot;a=b&quot;]]
  {:status 200
   :headers (update (:headers response) &quot;set-cookie&quot; concat additional-cookies})</pre>
but this method did not work.</z><z id="t1707388308" t="Matthew Davidson (kingmob) Not sure why that didn&apos;t work off the top of my head, but 99% of the cookie code is in a.h.client-middleware , so I&apos;d look there. They&apos;re tagged :no-doc , but are public. In particular, look at aleph.http.client-middleware/add-cookie-header , aleph.http.client-middleware/merge-cookies and aleph.http.client-middleware/decode-set-cookie-header . One of those might be what you&apos;re looking for?"><y>#</y><d>2024-02-08</d><h>10:31</h><r>Matthew Davidson (kingmob)</r>Not sure why that didn&apos;t work off the top of my head, but 99% of the cookie code is in <code>a.h.client-middleware</code> , so I&apos;d look there. They&apos;re tagged <code>:no-doc</code>, but are public.

In particular, look at <code>aleph.http.client-middleware/add-cookie-header</code>,  <code>aleph.http.client-middleware/merge-cookies</code> and <code>aleph.http.client-middleware/decode-set-cookie-header</code> . One of those might be what you&apos;re looking for?</z><z id="t1707390279" t="valerauko It didn&apos;t work because the (:set-cookie headers) is a string (the cookies concatenated with comma) not a vector"><y>#</y><d>2024-02-08</d><h>11:04</h><r>valerauko</r>It didn&apos;t work because the (:set-cookie headers) is a string (the cookies concatenated with comma) not a vector</z><z id="t1707393349" t="Matthew Davidson (kingmob) Yeah, that fits with the spec. Cookie headers are unusual in having a substructure."><y>#</y><d>2024-02-08</d><h>11:55</h><r>Matthew Davidson (kingmob)</r>Yeah, that fits with the spec. Cookie headers are unusual in having a substructure.</z><z id="t1707393407" t="Matthew Davidson (kingmob) (Well, not THAT unusual, but still)"><y>#</y><d>2024-02-08</d><h>11:56</h><r>Matthew Davidson (kingmob)</r>(Well, not THAT unusual, but still)</z><z id="t1707393644" t="valerauko Yet if I concat-join my new cookies onto that set-cookie string it sends only one weird big set-cookie header instead of each separately"><y>#</y><d>2024-02-08</d><h>12:00</h><r>valerauko</r>Yet if I concat-join my new cookies onto that set-cookie string it sends only one weird big set-cookie header instead of each separately</z><z id="t1708634702" t="Nim Sadeh what&apos;s the right way to do CORS in Aleph? I can&apos;t find an example online. All I&apos;m trying to do is to get my localhost webapp to talk to my locahost web server."><y>#</y><d>2024-02-22</d><h>20:45</h><w>Nim Sadeh</w>what&apos;s the right way to do CORS in Aleph? I can&apos;t find an example online. All I&apos;m trying to do is to get my localhost webapp to talk to my locahost web server.</z><z id="t1708653120" t="valerauko What&apos;s the problem you&apos;re running into? I&apos;ve never had issues connecting to localhost"><y>#</y><d>2024-02-23</d><h>01:52</h><r>valerauko</r>What&apos;s the problem you&apos;re running into? I&apos;ve never had issues connecting to localhost</z><z id="t1708653143" t="valerauko If it&apos;s really CORS you need then you&apos;ll probably want a ring middleware for that, there should be some out there"><y>#</y><d>2024-02-23</d><h>01:52</h><r>valerauko</r>If it&apos;s really CORS you need then you&apos;ll probably want a ring middleware for that, there should be some out there</z><z id="t1708656993" t="Nim Sadeh Yea I ended up using a Ring middleware to resolve the CORS issue"><y>#</y><d>2024-02-23</d><h>02:56</h><r>Nim Sadeh</r>Yea I ended up using a Ring middleware to resolve the CORS issue</z><z id="t1708685427" t="Matthew Davidson (kingmob) Aleph has equivalents of most of the default Ring middleware, and is compatible with the rest (tho async Ring middleware requires wrapping in a fn) If you want to add this to the examples/ directory, PRs are welcome!"><y>#</y><d>2024-02-23</d><h>10:50</h><r>Matthew Davidson (kingmob)</r>Aleph has equivalents of most of the default Ring middleware, and is compatible with the rest (tho async Ring middleware requires wrapping in a fn)

If you want to add this to the examples/ directory, PRs are welcome!</z><z id="t1709513410" t="valerauko Hey, I just saw this CVE in a JS package and I wondered if this was an issue in aleph https://github.com/nodejs/undici/security/advisories/GHSA-3787-6prv-h9w3"><y>#</y><d>2024-03-04</d><h>00:50</h><w>valerauko</w>Hey, I just saw this CVE in a JS package and I wondered if this was an issue in aleph
<a href="https://github.com/nodejs/undici/security/advisories/GHSA-3787-6prv-h9w3" target="_blank">https://github.com/nodejs/undici/security/advisories/GHSA-3787-6prv-h9w3</a></z><z id="t1709547375" t="Matthew Davidson (kingmob) Hmmm, maybe. We strip out the query-params on a redirect, but it doesn&apos;t look like we alter the headers."><y>#</y><d>2024-03-04</d><h>10:16</h><r>Matthew Davidson (kingmob)</r>Hmmm, maybe. We strip out the query-params on a redirect, but it doesn&apos;t look like we alter the headers.</z><z id="t1710096266" t="Matthew Davidson (kingmob) Cool, if a little depressing, article on the motivations of various browser vendors: https://infrequently.org/2024/03/why-browsers-get-built/"><y>#</y><d>2024-03-10</d><h>18:44</h><w>Matthew Davidson (kingmob)</w>Cool, if a little depressing, article on the motivations of various browser vendors: <a href="https://infrequently.org/2024/03/why-browsers-get-built/" target="_blank">https://infrequently.org/2024/03/why-browsers-get-built/</a></z><z id="t1710387076" t="valerauko Is there any way to inspect the executor (?) used by aleph after the server is started? I&apos;d want to log the number of threads used to handle requests"><y>#</y><d>2024-03-14</d><h>03:31</h><w>valerauko</w>Is there any way to inspect the executor (?) used by aleph after the server is started?

I&apos;d want to log the number of threads used to handle requests</z><z id="t1710393755" t="Matthew Davidson (kingmob) Yes. I&apos;m away at the moment, but poke around the code, you should be able to find what you need. "><y>#</y><d>2024-03-14</d><h>05:22</h><r>Matthew Davidson (kingmob)</r>Yes. I&apos;m away at the moment, but poke around the code, you should be able to find what you need. </z><z id="t1710389945" t="valerauko And on a related note: is there (plans for) a loom virtual thread based executor in (addition to) Dirigiste?"><y>#</y><d>2024-03-14</d><h>04:19</h><w>valerauko</w>And on a related note: is there (plans for) a loom virtual thread based executor in (addition to) Dirigiste?</z><z id="t1710393637" t="Matthew Davidson (kingmob) I looked into loom a while back, and it&apos;s doable, but no further investigation has been done. The Netty side wouldn&apos;t change probably, since it already uses cores pretty efficiently. On the manifold side, a vthread executor could be swapped in, and it may or may not be beneficial. It&apos;s not an obvious win, which is why I hadn&apos;t gotten around to it"><y>#</y><d>2024-03-14</d><h>05:20</h><w>Matthew Davidson (kingmob)</w>I looked into loom a while back, and it&apos;s doable, but no further investigation has been done. The Netty side wouldn&apos;t change probably, since it already uses cores pretty efficiently. On the manifold side, a vthread executor could be swapped in, and it may or may not be beneficial. It&apos;s not an obvious win, which is why I hadn&apos;t gotten around to it</z><z id="t1710689236" t="p-himik Not sure where to ask, maybe someone here can help. Very rarely, like once every few months, I see this exception: heroku[web.1]: State changed from starting to up app[web.1]: INFO aleph.http.server [aleph-server-pool-4] - Setting up insecure HTTP/1 server pipeline. app[web.1]: INFO ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :starting} app[web.1]: INFO ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :params, :params {&quot;client-id&quot; &quot;...&quot;}} app[web.1]: INFO ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :finish, :status nil, :ring.logger/ms 61} app[web.1]: INFO aleph.http.server [aleph-server-pool-1] - Setting up insecure HTTP/1 server pipeline. app[web.1]: INFO ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :starting} app[web.1]: INFO ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :params, :params {&quot;client-id&quot; &quot;...&quot;}} heroku[router]: at=info method=GET path=&quot;/ws/chet?client-id=...&quot; host=... request_id=... fwd=&quot;...&quot; dyno=web.1 connect=0ms service=15ms status=101 bytes=129 protocol=https app[web.1]: WARN io.netty.util.concurrent.DefaultPromise [aleph-server-pool-1] - An exception was thrown by io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete() java.util.NoSuchElementException: http-server at io.netty.channel.DefaultChannelPipeline.getContextOrDie(DefaultChannelPipeline.java:1073) at io.netty.channel.DefaultChannelPipeline.remove(DefaultChannelPipeline.java:423) at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:235) at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:230) at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590) at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:557) at io.netty.util.concurrent.DefaultPromise.access$200(DefaultPromise.java:35) at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:503) at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:173) at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:166) at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470) at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:413) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at manifold.executor$thread_factory$reify__1884$f__1885.invoke(executor.clj:71) at clojure.lang.AFn.run(AFn.java:22) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Thread.java:1623) And no complaints from any users, so no clue whether any requests are actually affected. Does anyone have any clue what&apos;s going on?"><y>#</y><d>2024-03-17</d><h>15:27</h><w>p-himik</w>Not sure where to ask, maybe someone here can help.
Very rarely, like once every few months, I see this exception:
<pre>heroku[web.1]: State changed from starting to up
app[web.1]: INFO  aleph.http.server [aleph-server-pool-4] - Setting up insecure HTTP/1 server pipeline.
app[web.1]: INFO  ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :starting}
app[web.1]: INFO  ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :params, :params {&quot;client-id&quot; &quot;...&quot;}}
app[web.1]: INFO  ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :finish, :status nil, :ring.logger/ms 61}
app[web.1]: INFO  aleph.http.server [aleph-server-pool-1] - Setting up insecure HTTP/1 server pipeline.
app[web.1]: INFO  ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :starting}
app[web.1]: INFO  ring.logger [manifold-pool-2-1] - {:request-method :get, :uri &quot;/ws/chet&quot;, :server-name &quot;...&quot;, :ring.logger/type :params, :params {&quot;client-id&quot; &quot;...&quot;}}
heroku[router]: at=info method=GET path=&quot;/ws/chet?client-id=...&quot; host=... request_id=... fwd=&quot;...&quot; dyno=web.1 connect=0ms service=15ms status=101 bytes=129 protocol=https
app[web.1]: WARN  io.netty.util.concurrent.DefaultPromise [aleph-server-pool-1] - An exception was thrown by io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete()
java.util.NoSuchElementException: http-server
at io.netty.channel.DefaultChannelPipeline.getContextOrDie(DefaultChannelPipeline.java:1073)
at io.netty.channel.DefaultChannelPipeline.remove(DefaultChannelPipeline.java:423)
at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:235)
at io.netty.handler.codec.http.websocketx.WebSocketServerHandshaker$1.operationComplete(WebSocketServerHandshaker.java:230)
at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)
at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:557)
at io.netty.util.concurrent.DefaultPromise.access$200(DefaultPromise.java:35)
at io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:503)
at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:173)
at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:166)
at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)
at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:413)
at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
at manifold.executor$thread_factory$reify__1884$f__1885.invoke(executor.clj:71)
at clojure.lang.AFn.run(AFn.java:22)
at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.base/java.lang.Thread.run(Thread.java:1623)</pre>
And no complaints from any users, so no clue whether any requests are actually affected.
Does anyone have any clue what&apos;s going on?</z><z id="t1710690773" t="valerauko Is this (or could this be) during server shutdown?"><y>#</y><d>2024-03-17</d><h>15:52</h><r>valerauko</r>Is this (or could this be) during server shutdown?</z><z id="t1710690802" t="p-himik That&apos;s why I included the first line. :) It&apos;s right after startup."><y>#</y><d>2024-03-17</d><h>15:53</h><r>p-himik</r>That&apos;s why I included the first line. :) It&apos;s right after startup.</z><z id="t1710690817" t="p-himik Not sure about any of the previous errors - didn&apos;t keep the logs."><y>#</y><d>2024-03-17</d><h>15:53</h><r>p-himik</r>Not sure about any of the previous errors - didn&apos;t keep the logs.</z><z id="t1710691347" t="valerauko There are no timestamps, this could as well be hours in a slacking env"><y>#</y><d>2024-03-17</d><h>16:02</h><r>valerauko</r>There are no timestamps, this could as well be hours in a slacking env</z><z id="t1710691357" t="valerauko Anyway it comes from https://netty.io/4.1/xref/io/netty/handler/codec/http/websocketx/WebSocketServerHandshaker.html#L235"><y>#</y><d>2024-03-17</d><h>16:02</h><r>valerauko</r>Anyway it comes from <a href="https://netty.io/4.1/xref/io/netty/handler/codec/http/websocketx/WebSocketServerHandshaker.html#L235" target="_blank">https://netty.io/4.1/xref/io/netty/handler/codec/http/websocketx/WebSocketServerHandshaker.html#L235</a></z><z id="t1710691530" t="valerauko It comes from the operationComplete callback, so the user-facing write has completed, and netty tried to remove the old http encoder from the pipeline, but it was apparently already gone. I can&apos;t really imagine how this exception looks from the client&apos;s perspective (if visible at all)"><y>#</y><d>2024-03-17</d><h>16:05</h><r>valerauko</r>It comes from the operationComplete callback, so the user-facing write has completed, and netty tried to remove the old http encoder from the pipeline, but it was apparently already gone. I can&apos;t really imagine how this exception looks from the client&apos;s perspective (if visible at all)</z><z id="t1710691711" t="p-himik I removed the timestamps since they&apos;re way too wide. It all happened within 3 seconds from the first line. What you describe sounds like a potential race condition."><y>#</y><d>2024-03-17</d><h>16:08</h><r>p-himik</r>I removed the timestamps since they&apos;re way too wide.
It all happened within 3 seconds from the first line.

What you describe sounds like a potential race condition.</z><z id="t1710691732" t="p-himik &gt; I can&apos;t really imagine how this exception looks from the client&apos;s perspective (if visible at all) The fact that it&apos;s marked as a warning by Netty suggests that maybe users don&apos;t see it at all."><y>#</y><d>2024-03-17</d><h>16:08</h><r>p-himik</r>&gt; I can&apos;t really imagine how this exception looks from the client&apos;s perspective (if visible at all)
The fact that it&apos;s marked as a warning by Netty suggests that maybe users don&apos;t see it at all.</z><z id="t1711590154" t="danielcompton I‚Äôm a latecomer to this conversation by 3 months, but I would have voted to not include Brotli and zstd by default. We have an nginx proxy in front of our services that can handle compression/decompression if required, and the extra filesize is a real bummer. We‚Äôre going to be looking at using GraalVM soon, I‚Äôm hopeful that the Brotli and zstd JARs don‚Äôt end up compiled into the native-image binary https://clojurians.slack.com/archives/C0G922PCH/p1702723929287379"><y>#</y><d>2024-03-28</d><h>01:42</h><w>danielcompton</w>I‚Äôm a latecomer to this conversation by 3 months, but I would have voted to not include Brotli and zstd by default. We have an nginx proxy in front of our services that can handle compression/decompression if required, and the extra filesize is a real bummer. We‚Äôre going to be looking at using GraalVM soon, I‚Äôm hopeful that the Brotli and zstd JARs don‚Äôt end up compiled into the native-image binary

<a href="https://clojurians.slack.com/archives/C0G922PCH/p1702723929287379" target="_blank">https://clojurians.slack.com/archives/C0G922PCH/p1702723929287379</a></z><z id="t1711619853" t="dergutemoritz You are not the only one with that pain point, see the discussion from https://github.com/clj-commons/aleph/pull/705#issuecomment-1985055876 onward"><y>#</y><d>2024-03-28</d><h>09:57</h><r>dergutemoritz</r>You are not the only one with that pain point, see the discussion from <a href="https://github.com/clj-commons/aleph/pull/705#issuecomment-1985055876" target="_blank">https://github.com/clj-commons/aleph/pull/705#issuecomment-1985055876</a> onward</z><z id="t1711619877" t="dergutemoritz Also has some context on why not including them by default is apparently not so easy üòï"><y>#</y><d>2024-03-28</d><h>09:57</h><r>dergutemoritz</r>Also has some context on why not including them by default is apparently not so easy <b>üòï</b></z><z id="t1712134760" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U051KLSJF&quot;}] Fair warning, there have been attempts to package aleph for graal over the years, but iirc, there were obstacles in aleph and manifold that made that difficult. Not sure where things stand currently. Also, it&apos;s not ideal for your case, but you should be able to strip out the compression libs for the architectures you don&apos;t care about, to save some space."><y>#</y><d>2024-04-03</d><h>08:59</h><r>Matthew Davidson (kingmob)</r><a>@U051KLSJF</a> Fair warning, there have been attempts to package aleph for graal over the years, but iirc, there were obstacles in aleph and manifold that made that difficult. Not sure where things stand currently.

Also, it&apos;s not ideal for your case, but you should be able to strip out the compression libs for the architectures you don&apos;t care about, to save some space.</z><z id="t1712397905" t="dergutemoritz Took another stab at making zstd and brotli optional again: https://github.com/clj-commons/aleph/pull/723"><y>#</y><d>2024-04-06</d><h>10:05</h><r>dergutemoritz</r>Took another stab at making zstd and brotli optional again: <a href="https://github.com/clj-commons/aleph/pull/723" target="_blank">https://github.com/clj-commons/aleph/pull/723</a></z><z id="t1711631163" t="pmooser Does anyone have any experience with sending/receiving binary data over an aleph websocket when :compression? is enabled? I&apos;m seeing something that is almost certainly either a bug in the browser or in aleph, and I suspect it&apos;s aleph, but it&apos;s not very easy to just jump into the guts of the netty websocket compression code."><y>#</y><d>2024-03-28</d><h>13:06</h><w>pmooser</w>Does anyone have any experience with sending/receiving binary data over an aleph websocket when <code>:compression?</code> is enabled? I&apos;m seeing something that is almost certainly either a bug in the browser or in aleph, and I suspect it&apos;s aleph, but it&apos;s not very easy to just jump into the guts of the netty websocket compression code.</z><z id="t1712134903" t="Matthew Davidson (kingmob) The config and/or a minimal test case would help."><y>#</y><d>2024-04-03</d><h>09:01</h><r>Matthew Davidson (kingmob)</r>The config and/or a minimal test case would help.</z><z id="t1714166766" t="az Hi, trying to consume server sent events using aleph. Any guidance? Details are in the thread."><y>#</y><d>2024-04-26</d><h>21:26</h><w>az</w>Hi, trying to consume server sent events using aleph. Any guidance? Details are in the thread.</z><z id="t1714166870" t="az I seem to get back and InputStream but I really don&apos;t understand how to consume it async. I need to take action with each new event, but I can only consume the entire thing right now once the connection closes. I can&apos;t seem to find any examples of doing this. Any snippets would be much appreciated."><y>#</y><d>2024-04-26</d><h>21:27</h><r>az</r>I seem to get back and <code>InputStream</code> but I really don&apos;t understand how to consume it async. I need to take action with each new event, but I can only consume the entire thing right now once the connection closes. I can&apos;t seem to find any examples of doing this.

Any snippets would be much appreciated.</z><z id="t1714204422" t="Aaron B Did you look at the aleph examples? They are quite good and go over multiple approaches, if I remember correctly. https://github.com/clj-commons/aleph/blob/master/examples/src/aleph/examples/http.clj"><y>#</y><d>2024-04-27</d><h>07:53</h><r>Aaron B</r>Did you look at the aleph examples? They are quite good and go over multiple approaches, if I remember correctly.

<a href="https://github.com/clj-commons/aleph/blob/master/examples/src/aleph/examples/http.clj" target="_blank">https://github.com/clj-commons/aleph/blob/master/examples/src/aleph/examples/http.clj</a></z><z id="t1714398451" t="Matthew Davidson (kingmob) [:attrs {:href &quot;/_/_/users/U0AJQJCQ1&quot;}] You don&apos;t really want to consume a potentially-infinite, open-ended stream like SSE with an InputStream, despite the name. A better idea is to use the byte-streams lib that aleph uses to get a manifold stream from the InputStream. (You could use raw mode, but then you&apos;re responsible for releasing netty memory yourself.) None of the examples are for SSE, I&apos;m afraid. You&apos;ll need to write some manifold code using the fns in manifold.stream to split the text stream into events (split on double newlines iiuc) and then some parsing to get the data out from each event."><y>#</y><d>2024-04-29</d><h>13:47</h><r>Matthew Davidson (kingmob)</r><a>@U0AJQJCQ1</a> You don&apos;t really want to consume a potentially-infinite, open-ended stream like SSE with an InputStream, despite the name. A better idea is to use the byte-streams lib that aleph uses to get a manifold stream from the InputStream. (You could use raw mode, but then you&apos;re responsible for releasing netty memory yourself.)

None of the examples are for SSE, I&apos;m afraid. You&apos;ll need to write some manifold code using the fns in <code>manifold.stream</code> to split the text stream into events (split on double newlines iiuc) and then some parsing to get the data out from each event.</z><z id="t1714412766" t="Matthew Davidson (kingmob) Could also try something like as long as you&apos;re careful not to hold on to the head of the seq. Or to-reader ."><y>#</y><d>2024-04-29</d><h>17:46</h><r>Matthew Davidson (kingmob)</r>Could also try something like <code></code> as long as you&apos;re careful not to hold on to the head of the seq. Or <code>to-reader</code>.</z><z id="t1714412819" t="az Thank you!"><y>#</y><d>2024-04-29</d><h>17:46</h><r>az</r>Thank you!</z><z id="t1714774471" t="rgm Hi all, I found a tantalizing discussion around using the :pipeline-transform opt on aleph.http/start-server to strip a Server: header and I&apos;m hoping someone might point out what I&apos;m doing wrong in implementing it: https://github.com/clj-commons/aleph/issues/512#issuecomment-695972882 Background: I&apos;m cleaning up from a pentest and the consultant would prefer no Server: header at all. I&apos;ve added a custom header in a middleware to just suppress the phrase &quot;Aleph&quot; for now and that&apos;s also fine. But I&apos;ve tried working out how to do a :pipeline-transform and I&apos;m just not getting it. My attempt w/ failing unit test is here: https://github.com/rgm/experiments/blob/master/2024/202405-aleph/user.clj (It&apos;s still Aleph/0.4.7; I know this is gonna be an issue where the pipeline keys have changed if we try to come up to 0.7)."><y>#</y><d>2024-05-03</d><h>22:14</h><w>rgm</w>Hi all, I found a tantalizing discussion around using the <code>:pipeline-transform</code> opt on <code>aleph.http/start-server</code> to strip a <code>Server:</code> header and I&apos;m hoping someone might point out what I&apos;m doing wrong in implementing it:

<a href="https://github.com/clj-commons/aleph/issues/512#issuecomment-695972882" target="_blank">https://github.com/clj-commons/aleph/issues/512#issuecomment-695972882</a>

Background: I&apos;m cleaning up from a pentest and the consultant would prefer no <code>Server:</code> header at all. I&apos;ve added a custom header in a middleware to just suppress the phrase &quot;Aleph&quot; for now and that&apos;s also fine. But I&apos;ve tried working out how to do a <code>:pipeline-transform</code> and I&apos;m just not getting it.

My attempt w/ failing unit test is here: <a href="https://github.com/rgm/experiments/blob/master/2024/202405-aleph/user.clj" target="_blank">https://github.com/rgm/experiments/blob/master/2024/202405-aleph/user.clj</a>

(It&apos;s still Aleph/0.4.7; I know this is gonna be an issue where the pipeline keys have changed if we try to come up to 0.7).</z><z id="t1714774632" t="rgm I&apos;m vaguely understanding I should proxy io.netty.Channel/ChannelOutboundHandlerAdapter because it has default methods, but I&apos;m not at all convinced its .write method is the right one to override."><y>#</y><d>2024-05-03</d><h>22:17</h><r>rgm</r>I&apos;m vaguely understanding I should proxy <code>io.netty.Channel/ChannelOutboundHandlerAdapter</code> because it has default methods, but I&apos;m not at all convinced its <code>.write</code> method is the right one to override.</z><z id="t1714775319" t="oyakushev Try printlning the pipeline after you&apos;ve added the scrubber. What does that show? Also, do your debug printlns get invoked?"><y>#</y><d>2024-05-03</d><h>22:28</h><r>oyakushev</r>Try printlning the pipeline after you&apos;ve added the scrubber. What does that show? Also, do your debug printlns get invoked?</z><z id="t1714775475" t="oyakushev Actually, not just printling the object, but (println (.names pipeline))"><y>#</y><d>2024-05-03</d><h>22:31</h><r>oyakushev</r>Actually, not just printling the object, but  <code>(println (.names pipeline))</code></z><z id="t1714775610" t="rgm hm, no ... nothing prints. I ran the 2 forms in the comment, output on the right. Looking at the start-server docstring for 0.4.7 I seem to be lining up the :pipeline-transform keyword OK. Wonder if I&apos;m not matching a method arity someplace."><y>#</y><d>2024-05-03</d><h>22:33</h><r>rgm</r>hm, no ... nothing prints. I ran the 2 forms in the comment, output on the right. Looking at the <code>start-server</code> docstring for 0.4.7 I seem to be lining up the <code>:pipeline-transform</code> keyword OK. Wonder if I&apos;m not matching a method arity someplace.</z><z id="t1714775743" t="rgm oh, wait :face_palm: ... output is going out to the REPL but my editor&apos;s not picking up output on some other thread"><y>#</y><d>2024-05-03</d><h>22:35</h><r>rgm</r>oh, wait <b>:face_palm:</b>  ... output is going out to the REPL but my editor&apos;s not picking up output on some other thread</z><z id="t1714775755" t="oyakushev Yeah, just wanted to say that"><y>#</y><d>2024-05-03</d><h>22:35</h><r>oyakushev</r>Yeah, just wanted to say that</z><z id="t1714775763" t="oyakushev Happens to the best of us üôÉ"><y>#</y><d>2024-05-03</d><h>22:36</h><r>oyakushev</r>Happens to the best of us <b>üôÉ</b></z><z id="t1714775814" t="rgm ok, so this is the pre- and post- (.names pipeline)"><y>#</y><d>2024-05-03</d><h>22:36</h><r>rgm</r>ok, so this is the pre- and post- <code>(.names pipeline)</code></z><z id="t1714775836" t="rgm so the transform is running"><y>#</y><d>2024-05-03</d><h>22:37</h><r>rgm</r>so the transform is running</z><z id="t1714775873" t="oyakushev Try putting the scrubber before http-server"><y>#</y><d>2024-05-03</d><h>22:37</h><r>oyakushev</r>Try putting the scrubber before http-server</z><z id="t1714775899" t="oyakushev (.addBefore pipeline &quot;http-server&quot; &quot;scrubber&quot; SCRUBBER)"><y>#</y><d>2024-05-03</d><h>22:38</h><r>oyakushev</r>(.addBefore pipeline &quot;http-server&quot; &quot;scrubber&quot; SCRUBBER)</z><z id="t1714775932" t="rgm huh, just after I pasted the last one, I got all this warning logging having done nothing else in the meantime"><y>#</y><d>2024-05-03</d><h>22:38</h><r>rgm</r>huh, just after I pasted the last one, I got all this warning logging having done nothing else in the meantime</z><z id="t1714775994" t="oyakushev Yes, you got to instantiate that handler anew on each pipeline-transform"><y>#</y><d>2024-05-03</d><h>22:39</h><r>oyakushev</r>Yes, you got to instantiate that handler anew on each pipeline-transform</z><z id="t1714775999" t="oyakushev make it a defn instead of def"><y>#</y><d>2024-05-03</d><h>22:39</h><r>oyakushev</r>make it a defn instead of def</z><z id="t1714776018" t="rgm ohhhh, ok"><y>#</y><d>2024-05-03</d><h>22:40</h><r>rgm</r>ohhhh, ok</z><z id="t1714776185" t="rgm getting closer ... the write method is actually running now"><y>#</y><d>2024-05-03</d><h>22:43</h><r>rgm</r>getting closer ... the write method is actually running now</z><z id="t1714776221" t="rgm oh ... bad call to proxy-super"><y>#</y><d>2024-05-03</d><h>22:43</h><r>rgm</r>oh ... bad call to <code>proxy-super</code></z><z id="t1714776320" t="rgm pretty close, the issue now is that the (when (instance? HttpResponse ,,,)) isn&apos;t the right thing to do"><y>#</y><d>2024-05-03</d><h>22:45</h><r>rgm</r>pretty close, the issue now is that the <code>(when (instance? HttpResponse ,,,))</code> isn&apos;t the right thing to do</z><z id="t1714776336" t="rgm but now I can inspect, this is great"><y>#</y><d>2024-05-03</d><h>22:45</h><r>rgm</r>but now I can inspect, this is great</z><z id="t1714776341" t="oyakushev Println what&apos;s coming to you"><y>#</y><d>2024-05-03</d><h>22:45</h><r>oyakushev</r>Println what&apos;s coming to you</z><z id="t1714776566" t="rgm cool ... I&apos;ll poke around a bit more with the netty class hierarchy but this is great progress, thank you"><y>#</y><d>2024-05-03</d><h>22:49</h><r>rgm</r>cool ... I&apos;ll poke around a bit more with the netty class hierarchy but this is great progress, thank you</z><z id="t1714776636" t="oyakushev BTW, instead of proxy you can use this: (aleph.netty/channel-outbound-handler :write ([_ ctx msg promise] (prn &quot;running write method&quot;) (when (instance? HttpResponse msg) (prn &quot;removing header&quot;) (.remove (.headers msg) &quot;Server&quot;)) (.write ctx msg promise)))"><y>#</y><d>2024-05-03</d><h>22:50</h><r>oyakushev</r>BTW, instead of proxy you can use this:
<pre>(aleph.netty/channel-outbound-handler
 :write ([_ ctx msg promise]
         (prn &quot;running write method&quot;)
         (when (instance? HttpResponse msg)
           (prn &quot;removing header&quot;)
           (.remove (.headers msg) &quot;Server&quot;))
         (.write ctx msg promise)))</pre></z><z id="t1714776669" t="oyakushev Is this .addBefore now or .addLast ?"><y>#</y><d>2024-05-03</d><h>22:51</h><r>oyakushev</r>Is this <code>.addBefore</code> now or <code>.addLast</code>?</z><z id="t1714776675" t="rgm before"><y>#</y><d>2024-05-03</d><h>22:51</h><r>rgm</r>before</z><z id="t1714776692" t="oyakushev Then it probably should be .addLast still"><y>#</y><d>2024-05-03</d><h>22:51</h><r>oyakushev</r>Then it probably should be .addLast still</z><z id="t1714776727" t="oyakushev Because since you receive a byte buffer as a msg , it means your handler got invoked too late in the chain"><y>#</y><d>2024-05-03</d><h>22:52</h><r>oyakushev</r>Because since you receive a byte buffer as a <code>msg</code>, it means your handler got invoked too late in the chain</z><z id="t1714776754" t="rgm hm, as .addLast it doesn&apos;t get invoked at all"><y>#</y><d>2024-05-03</d><h>22:52</h><r>rgm</r>hm, as .addLast it doesn&apos;t get invoked at all</z><z id="t1714776763" t="rgm (the scrubber proxy)"><y>#</y><d>2024-05-03</d><h>22:52</h><r>rgm</r>(the scrubber proxy)</z><z id="t1714776793" t="oyakushev Between middleware, interceptors, and Netty handlers, I completely give up trying to understand the order of invocation in these chain of responsibility atrocities."><y>#</y><d>2024-05-03</d><h>22:53</h><r>oyakushev</r>Between middleware, interceptors, and Netty handlers, I completely give up trying to understand the order of invocation in these chain of responsibility atrocities.</z><z id="t1714776845" t="rgm yeah, I usually just have to set up mw1 and mw2 and watch the logs"><y>#</y><d>2024-05-03</d><h>22:54</h><r>rgm</r>yeah, I usually just have to set up mw1 and mw2 and watch the logs</z><z id="t1714776856" t="rgm no hope of remembering"><y>#</y><d>2024-05-03</d><h>22:54</h><r>rgm</r>no hope of remembering</z><z id="t1714776916" t="oyakushev Hm, stupid idea: maybe try .addFirst?"><y>#</y><d>2024-05-03</d><h>22:55</h><r>oyakushev</r>Hm, stupid idea: maybe try .addFirst?</z><z id="t1714777002" t="rgm yep, runs as .addFirst too"><y>#</y><d>2024-05-03</d><h>22:56</h><r>rgm</r>yep, runs as <code>.addFirst</code> too</z><z id="t1714777016" t="rgm"><y>#</y><d>2024-05-03</d><h>22:56</h><r>rgm</r></z><z id="t1714777102" t="rgm I&apos;ll mess with (.addBefore ,,,) and see what happens"><y>#</y><d>2024-05-03</d><h>22:58</h><r>rgm</r>I&apos;ll mess with <code>(.addBefore ,,,)</code> and see what happens</z><z id="t1714777115" t="rgm presumably there&apos;s somewhere in the chain that makes sense"><y>#</y><d>2024-05-03</d><h>22:58</h><r>rgm</r>presumably there&apos;s somewhere in the chain that makes sense</z><z id="t1714777182" t="rgm gotta step away from the keyboard for a while but thanks so much ... this is big progress"><y>#</y><d>2024-05-03</d><h>22:59</h><r>rgm</r>gotta step away from the keyboard for a while but thanks so much ... this is big progress</z><z id="t1714777194" t="oyakushev No problem"><y>#</y><d>2024-05-03</d><h>22:59</h><r>oyakushev</r>No problem</z><z id="t1714777214" t="oyakushev Try dancing around &quot;request-handler&quot;, not &quot;http-server&quot;, my initial suggestion was wrong"><y>#</y><d>2024-05-03</d><h>23:00</h><r>oyakushev</r>Try dancing around &quot;request-handler&quot;, not &quot;http-server&quot;, my initial suggestion was wrong</z><z id="t1714777352" t="rgm suppose I could just doseq on (.names pipeline) and stick it between all of them üôÉ"><y>#</y><d>2024-05-03</d><h>23:02</h><r>rgm</r>suppose I could just doseq on <code>(.names pipeline)</code> and stick it between all of them <b>üôÉ</b></z><z id="t1714777663" t="rgm ok now I&apos;m late for my thing but TOTALLY WORTH IT ... (.addBefore pipeline &quot;request-handler&quot; &quot;scrubber&quot; (make-scrubber-2)) worked and makes the unit test pass üéâ"><y>#</y><d>2024-05-03</d><h>23:07</h><r>rgm</r>ok now I&apos;m late for my thing but TOTALLY WORTH IT ... <code>(.addBefore pipeline &quot;request-handler&quot; &quot;scrubber&quot; (make-scrubber-2))</code> worked and makes the unit test pass <b>üéâ</b></z><z id="t1714777789" t="oyakushev Yeah, this makes sense now... I confused http-server and request-handler. But think of the fascinating discoveries we made!"><y>#</y><d>2024-05-03</d><h>23:09</h><r>oyakushev</r>Yeah, this makes sense now... I confused http-server and request-handler. But think of the fascinating discoveries we made!</z><z id="t1714777869" t="rgm I somehow went 8+ years of clojure without even knowing proxy existed and now this is twice in two months"><y>#</y><d>2024-05-03</d><h>23:11</h><r>rgm</r>I somehow went 8+ years of clojure without even knowing proxy existed and now this is twice in two months</z><z id="t1714777939" t="oyakushev It really isn&apos;t needed that often, so no wonder. And it&apos;s quite clunky and buggy too, with its proxy-super stuff."><y>#</y><d>2024-05-03</d><h>23:12</h><r>oyakushev</r>It really isn&apos;t needed that often, so no wonder. And it&apos;s quite clunky and buggy too, with its proxy-super stuff.</z><z id="t1714778078" t="rgm &lt;/me files proxy in the same mental drawer that already has cljs this-as &gt;"><y>#</y><d>2024-05-03</d><h>23:14</h><r>rgm</r>&lt;/me files <code>proxy</code> in the same mental drawer that already has cljs <code>this-as</code>&gt;</z><z id="t1714778095" t="rgm have a great weekend and thanks again üëã"><y>#</y><d>2024-05-03</d><h>23:14</h><r>rgm</r>have a great weekend and thanks again <b>üëã</b></z><z id="t1714778113" t="oyakushev Cheers, likewise!"><y>#</y><d>2024-05-03</d><h>23:15</h><r>oyakushev</r>Cheers, likewise!</z><z id="t1714876879" t="valerauko If it&apos;s a pentest I&apos;d personally add something like Server: Django/5.7 (Python/3.2) (look up the actual django string) and enjoy the onslaught"><y>#</y><d>2024-05-05</d><h>02:41</h><r>valerauko</r>If it&apos;s a pentest I&apos;d personally add something like <code>Server: Django/5.7 (Python/3.2)</code> (look up the actual django string) and enjoy the onslaught</z><z id="t1715008047" t="rgm Ha. I did consider Server: DIAF/v1.0.0"><y>#</y><d>2024-05-06</d><h>15:07</h><r>rgm</r>Ha. I did consider <code>Server: DIAF/v1.0.0</code></z><z id="t1715008732" t="valerauko We regularly observe super hacker bros scanning our servers from some German VPS for vulnerabilities. It&apos;s hilarious because our people have given plenty of talks about our stack and we even have a tech blog about it, but no they are brute forcing PHP and ASP known weak points and common misconfigurations..."><y>#</y><d>2024-05-06</d><h>15:18</h><r>valerauko</r>We regularly observe super hacker bros scanning our servers from some German VPS for vulnerabilities. It&apos;s hilarious because our people have given plenty of talks about our stack and we even have a tech blog about it, but no they are brute forcing PHP and ASP known weak points and common misconfigurations...</z><z id="t1715011838" t="rgm ha, same ... I asked our pen tester about that since I was seeing a lot of Rails/Express/Django/ASP probing in our error logs, and he said it&apos;s just in the big automatic checklist their tools run through. In the debrief he was really enthusiastic about learning new stuff since he&apos;d never seen transit on the wire before."><y>#</y><d>2024-05-06</d><h>16:10</h><r>rgm</r>ha, same ... I asked our pen tester about that since I was seeing a lot of Rails/Express/Django/ASP probing in our error logs, and he said it&apos;s just in the big automatic checklist their tools run through.

In the debrief he was really enthusiastic about learning new stuff since he&apos;d never seen transit on the wire before.</z><z id="t1715012101" t="rgm But now that I think about it it does seem inconsistent to both advise us to turn off the Server: header and to also completely ignore it in practice, because tooling makes ignoring it the path of least resistance."><y>#</y><d>2024-05-06</d><h>16:15</h><r>rgm</r>But now that I think about it it does seem inconsistent to both advise us to turn off the <code>Server:</code> header and to also completely ignore it in practice, because tooling makes ignoring it the path of least resistance.</z><z id="t1715012250" t="rgm having it off almost feels like it&apos;ll get us fingerprinted as being possibly worth extra attention (which I doubt we are, but still. Bit like the Do Not Track header being used to help fingerprint my browser)."><y>#</y><d>2024-05-06</d><h>16:17</h><r>rgm</r>having it off almost feels like it&apos;ll get us fingerprinted as being possibly worth extra attention (which I doubt we are, but still. Bit like the Do Not Track header being used to help fingerprint my browser).</z><z id="t1715012339" t="rgm Anyway, whatevs. Unlikely to be the most troubling not-entirely-thought-through thing I encounter today."><y>#</y><d>2024-05-06</d><h>16:18</h><r>rgm</r>Anyway, whatevs. Unlikely to be the most troubling not-entirely-thought-through thing I encounter today.</z><z id="t1715106174" t="rgm Looks like I get &quot;Server:\n&quot; from curl"><y>#</y><d>2024-05-07</d><h>18:22</h><r>rgm</r>Looks like I get <code>&quot;Server:\n&quot;</code> from curl</z><z id="t1715163791" t="Matthew Davidson (kingmob) Bit late to the party, but if you&apos;re trying to understand how Netty handlers work, it helps to know that, at any time, you can write from the inbound handler chain to the outbound chain. This short-circuits invocations on all later handlers in the chain, and is usually a good idea for efficiency. Aleph wraps the user handler with its own netty-compatible handler, which takes your Ring response, adds the Server header (among others), and in 0.4.x, starts writing Http* objects. This calls the previous handler&apos;s .write method and works it way back in reverse. This is why .addBefore is what you want. My suggestion is to insert a netty/channel-outbound-handler and set the :write so that if it gets an HttpMessage , it alters the .headers , and passes it along. If it doesn&apos;t get an HttpMessage, it should just pass the object along (the general Netty strategy)."><y>#</y><d>2024-05-08</d><h>10:23</h><r>Matthew Davidson (kingmob)</r>Bit late to the party, but if you&apos;re trying to understand how Netty handlers work, it helps to know that, at any time, you can write from the inbound handler chain to the outbound chain. This short-circuits invocations on all later handlers in the chain, and is usually a good idea for efficiency.

Aleph wraps the user handler with its own netty-compatible handler, which takes your Ring response, adds the Server header (among others), and in 0.4.x, starts writing Http* objects. This calls the previous handler&apos;s <code>.write</code> method and works it way back in reverse.

This is why <code>.addBefore</code> is what you want. My suggestion is to insert a <code>netty/channel-outbound-handler</code> and set the <code>:write</code> so that if it gets an <code>HttpMessage</code>, it alters the <code>.headers</code>, and passes it along. If it doesn&apos;t get an HttpMessage, it should just pass the object along (the general Netty strategy).</z><z id="t1715164263" t="Matthew Davidson (kingmob) Modern Aleph will only set the server name if the header is missing, but that still doesn&apos;t help if you want to remove it entirely. Because of how the underlying Netty Channel multiplexes HTTP/2 connections (one shared connection-level channel, and then one channel for each HTTP/2 stream ID), the pipeline-transform keys are different, as you noticed. You&apos;d want to .addBefore the handler again, but you want to use the http2-stream-pipeline-transform key this time"><y>#</y><d>2024-05-08</d><h>10:31</h><r>Matthew Davidson (kingmob)</r>Modern Aleph will only set the server name if the header is missing, but that still doesn&apos;t help if you want to remove it entirely.

Because of how the underlying Netty Channel multiplexes HTTP/2 connections (one shared connection-level channel, and then one channel for each HTTP/2 stream ID), the pipeline-transform keys are different, as you noticed. You&apos;d want to <code>.addBefore</code> the handler again, but you want to use the <code>http2-stream-pipeline-transform</code> key this time</z><z id="t1715164339" t="Matthew Davidson (kingmob) (NB: that&apos;s for HTTP/2 servers. If you have an HTTP/1 server, it&apos;s still pipeline-transform )"><y>#</y><d>2024-05-08</d><h>10:32</h><r>Matthew Davidson (kingmob)</r>(NB: that&apos;s for HTTP/2 servers. If you have an HTTP/1 server, it&apos;s still <code>pipeline-transform</code>)</z><z id="t1715182701" t="rgm Oh, this is fantastic. Thank you. It all looked a bit interceptor-y."><y>#</y><d>2024-05-08</d><h>15:38</h><r>rgm</r>Oh, this is fantastic. Thank you. It all looked a bit interceptor-y.</z><z id="t1715183840" t="Matthew Davidson (kingmob) Yeah, there&apos;s a lot of similarities, but fyi, that pattern for pipelines is older than the use of the term interceptor or the InterceptingFilter. Netty in particular predates Pedestal&apos;s popularization of the word. I dug a bit into the history of it all at one point. See my comment here: https://clojurians.slack.com/archives/CDG3YQV6Z/p1685076301109489"><y>#</y><d>2024-05-08</d><h>15:57</h><r>Matthew Davidson (kingmob)</r>Yeah, there&apos;s a lot of similarities, but fyi, that pattern for pipelines is older than the use of the term interceptor or the InterceptingFilter. Netty in particular predates Pedestal&apos;s popularization of the word.

I dug a bit into the history of it all at one point. See my comment here: <a href="https://clojurians.slack.com/archives/CDG3YQV6Z/p1685076301109489" target="_blank">https://clojurians.slack.com/archives/CDG3YQV6Z/p1685076301109489</a></z><z id="t1715184282" t="rgm ok I&apos;m so glad I pressed on past the 2-minute solution of (assoc-in request [:headers &quot;Server&quot;] &quot;*REDACTED*&quot;)"><y>#</y><d>2024-05-08</d><h>16:04</h><r>rgm</r>ok I&apos;m so glad I pressed on past the 2-minute solution of <code>(assoc-in request [:headers &quot;Server&quot;] &quot;*REDACTED*&quot;)</code></z><z id="t1717582170" t="dergutemoritz"><y>#</y><d>2024-06-05</d><h>10:09</h><w>dergutemoritz</w></z><z id="t1717597751" t="Nim Sadeh X-posting a bit from my #C053AK3F9 post, but is there content anywhere about integrating an Aleph server with OpenAPI?"><y>#</y><d>2024-06-05</d><h>14:29</h><w>Nim Sadeh</w>X-posting a bit from my #C053AK3F9 post, but is there content anywhere about integrating an Aleph server with OpenAPI?</z><z id="t1717598807" t="dergutemoritz Hi! Not that I&apos;m aware of but note that Aleph is compatible with ring , so perhaps looking for content under that keyword helps."><y>#</y><d>2024-06-05</d><h>14:46</h><r>dergutemoritz</r>Hi! Not that I&apos;m aware of but note that Aleph is compatible with <code>ring</code>, so perhaps looking for content under that keyword helps.</z><z id="t1717666649" t="Matthew Davidson (kingmob) OpenAPI/Swagger operate at a different level than Aleph. For the most part, each Aleph server gets a single handler, that knows nothing about routing. You need to add a router. I personally suggest https://github.com/metosin/reitit"><y>#</y><d>2024-06-06</d><h>09:37</h><r>Matthew Davidson (kingmob)</r>OpenAPI/Swagger operate at a different level than Aleph. For the most part, each Aleph server gets a single handler, that knows nothing about routing.

You need to add a router. I personally suggest <a href="https://github.com/metosin/reitit" target="_blank">https://github.com/metosin/reitit</a></z></g></div></body>